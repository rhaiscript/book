<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Rhai - Embedded Scripting for Rust</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-12WKJTDTEE"></script>
        <script>
            var localAddrs = ["localhost", "127.0.0.1", ""];
        
            // Make sure we don't activate Google Analytics if the developer is inspecting the book locally...
            if (localAddrs.indexOf(document.location.hostname) === -1) {
                window.dataLayer = window.dataLayer || [];
                function gtag() { dataLayer.push(arguments); }
                gtag('js', new Date());
        
                gtag('config', 'G-12WKJTDTEE');
            }
        </script>
        <meta name="description" content="Tutorial and reference on the Rhai scripting engine and language.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="theme/rhai.min.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <div class="sidebar-scrollbox"></div>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <script async src="toc.js"></script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rhai - Embedded Scripting for Rust</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rhaiscript/rhai" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="the-rhai-book"><a class="header" href="#the-rhai-book">The Rhai Book</a></h1>
<p><img src="/book/images/logo/rhai-banner-transparent-colour.svg" alt="Rhai Logo" /></p>
<p>Rhai is an embedded scripting language and evaluation engine for Rust that gives a safe and easy way
to add scripting to any application.</p>
<h2 id="versions"><a class="header" href="#versions">Versions</a></h2>
<p>This Book is for version <strong>1.22.0</strong> of Rhai.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-to-rhai"><a class="header" href="#introduction-to-rhai">Introduction to Rhai</a></h1>
<h2 id="trivia"><a class="header" href="#trivia">Trivia</a></h2>
<div id="admonition-etymology-of-the-name-rhai" class="admonition admonish-question" role="note" aria-labelledby="admonition-etymology-of-the-name-rhai-title">
<div class="admonition-title">
<div id="admonition-etymology-of-the-name-rhai-title">
<p>Etymology of the name “Rhai”</p>
</div>
<a class="admonition-anchor-link" href="about/index.html#admonition-etymology-of-the-name-rhai"></a>
</div>
<div>
<p>In the beginning there was <a href="http://chaiscript.com">ChaiScript</a>,
which is an embedded scripting language for C++.
Originally it was intended to be a scripting language similar to <strong>JavaScript</strong>.</p>
<p>With java being a kind of hot beverage, the new language was named after
another hot beverage – <a href="https://en.wikipedia.org/wiki/Chai"><strong>Chai</strong></a>,
which is the word for “tea” in many world languages and, in particular,
a popular kind of <a href="https://en.wikipedia.org/wiki/Masala_chai">spicy milk tea consumed in India</a>.</p>
<p>Later, when the novel implementation technique behind ChaiScript was ported from C++ to Rust,
logically the <code>C</code> was changed to an <code>R</code> to make it “RhaiScript”, or just “Rhai”.</p>
<p>– Rhai author <a href="https://github.com/jntrnr">Johnathan Turner</a></p>
</div>
</div>
<div id="admonition-origin-of-the-rhai-logo" class="admonition admonish-question" role="note" aria-labelledby="admonition-origin-of-the-rhai-logo-title">
<div class="admonition-title">
<div id="admonition-origin-of-the-rhai-logo-title">
<p>Origin of the Rhai logo</p>
</div>
<a class="admonition-anchor-link" href="about/index.html#admonition-origin-of-the-rhai-logo"></a>
</div>
<div>
<div style="float:right;text-align:center;width:20%">
    <img src="about//book/images/logo/rhai_logo_old.png" title="Prototype Rhai logo">
    <div style="font-size:60%">Original prototype</div>
</div>
<p>One of Rhai’s maintainers, <a href="https://github.com/schungx"><code>@schungx</code></a>, was thinking about a logo
when he accidentally came across a copy of <em>Catcher in the Rye</em> in a restaurant, and drew the
first prototype version of the logo.</p>
<p>Then <a href="https://github.com/semirix"><code>@semirix</code></a> refined it to the current version.</p>
</div>
</div>
<div id="admonition-the-rhairs-domain" class="admonition admonish-question" role="note" aria-labelledby="admonition-the-rhairs-domain-title">
<div class="admonition-title">
<div id="admonition-the-rhairs-domain-title">
<p>The <code>rhai.rs</code> domain</p>
</div>
<a class="admonition-anchor-link" href="about/index.html#admonition-the-rhairs-domain"></a>
</div>
<div>
<p><a href="https://github.com/yrashk"><code>@yrashk</code></a> sponsored the domain <a href="https://rhai.rs"><code>rhai.rs</code></a>.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="features-of-rhai"><a class="header" href="#features-of-rhai">Features of Rhai</a></h1>
<div id="admonition-easy" class="admonition admonish-success" role="note" aria-labelledby="admonition-easy-title">
<div class="admonition-title">
<div id="admonition-easy-title">
<p>Easy</p>
</div>
<a class="admonition-anchor-link" href="about/features.html#admonition-easy"></a>
</div>
<div>
<ul>
<li>
<p>Simple language similar to JavaScript+Rust with dynamic typing.</p>
</li>
<li>
<p>Tight integration with native Rust <a href="about//book/language/functions.html">functions</a> and <a href="about//book/rust/custom-types.html">types</a> including
<a href="about//book/rust/getters-setters.html">getters/setters</a>, <a href="about//book/rust/methods.html">methods</a> and <a href="about//book/rust/indexers.html">indexers</a>.</p>
</li>
<li>
<p>Freely pass Rust values into a script as <a href="about//book/language/variables.html">variables</a>/<a href="about//book/language/constants.html">constants</a> via an external <a href="about//book/engine/scope.html"><code>Scope</code></a> –
all clonable Rust types are supported seamlessly without the need to implement any special trait.</p>
</li>
<li>
<p>Easily <a href="about//book/engine/call-fn.html">call a script-defined function</a> from Rust.</p>
</li>
<li>
<p>Very few additional dependencies – right now only <a href="https://crates.io/crates/smallvec"><code>smallvec</code></a>,
<a href="https://crates.io/crates/thin-vec"><code>thin-vec</code></a>, <a href="https://crates.io/crates/num-traits"><code>num-traits</code></a>,
<a href="https://crates.io/crates/ahash"><code>ahash</code></a>, <a href="https://crates.io/crates/bitflags"><code>bitflags</code></a> and <a href="https://crates.io/crates/smartstring"><code>smartstring</code></a>;
for <a href="about//book/start/builds/no-std.html"><code>no-std</code></a> and <a href="about//book/start/builds/wasm.html">WASM</a> builds, a number of additional dependencies are pulled in to provide for missing functionalities.</p>
</li>
<li>
<p><a href="about//book/plugins/index.html">Plugins</a> system powered by procedural macros simplifies custom API development.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-fast" class="admonition admonish-danger" role="note" aria-labelledby="admonition-fast-title">
<div class="admonition-title">
<div id="admonition-fast-title">
<p>Fast</p>
</div>
<a class="admonition-anchor-link" href="about/features.html#admonition-fast"></a>
</div>
<div>
<ul>
<li>
<p>Fairly efficient evaluation – 1 million iterations in 0.14 sec on a single-core, 2.6 GHz Linux VM
running <a href="https://github.com/rhaiscript/rhai/blob/main/scripts/speed_test.rhai">this script</a>
(also see <a href="about/benchmarks.html">benchmarks</a>).</p>
</li>
<li>
<p>Compile once to <a href="about//book/engine/compile.html">AST</a> for repeated evaluations.</p>
</li>
<li>
<p>Scripts are <a href="about//book/engine/optimize/index.html">optimized</a> – useful for template-based machine-generated scripts.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-dynamic" class="admonition admonish-tip" role="note" aria-labelledby="admonition-dynamic-title">
<div class="admonition-title">
<div id="admonition-dynamic-title">
<p>Dynamic</p>
</div>
<a class="admonition-anchor-link" href="about/features.html#admonition-dynamic"></a>
</div>
<div>
<ul>
<li>
<p><a href="about//book/language/overload.html">Function overloading</a>.</p>
</li>
<li>
<p><a href="about//book/rust/operators.html">Operator overloading</a>.</p>
</li>
<li>
<p>Organize code base with dynamically-loadable <a href="about//book/rust/modules/index.html">modules</a>, optionally overriding the
<a href="about//book/rust/modules/resolvers/index.html">resolution</a> process.</p>
</li>
<li>
<p>Dynamic dispatch via <a href="about//book/language/fn-ptr.html">function pointers</a> with additional support for <a href="about//book/language/fn-curry.html">currying</a>.</p>
</li>
<li>
<p><a href="about//book/language/fn-closure.html">Closures</a> that can capture shared variables.</p>
</li>
<li>
<p>Some support for <a href="about//book/patterns/oop.html">object-oriented programming (OOP)</a>.</p>
</li>
<li>
<p>Hook into variables access via a <a href="about//book/engine/var.html">variable resolver</a>, or control definition of variables via a
<a href="about//book/engine/def-var.html">variable definition filter</a>.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-safe" class="admonition admonish-warning" role="note" aria-labelledby="admonition-safe-title">
<div class="admonition-title">
<div id="admonition-safe-title">
<p>Safe</p>
</div>
<a class="admonition-anchor-link" href="about/features.html#admonition-safe"></a>
</div>
<div>
<ul>
<li>
<p>Relatively little <code>unsafe</code> code – yes there are some for performance reasons.</p>
</li>
<li>
<p>Sand-boxed – the scripting <a href="about//book/engine/hello-world.html"><code>Engine</code></a>, if declared immutable, cannot mutate the containing
environment unless <a href="about//book/patterns/control.html">explicitly permitted</a>.</p>
</li>
<li>
<p>Passes Miri.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-rugged" class="admonition admonish-bug" role="note" aria-labelledby="admonition-rugged-title">
<div class="admonition-title">
<div id="admonition-rugged-title">
<p>Rugged</p>
</div>
<a class="admonition-anchor-link" href="about/features.html#admonition-rugged"></a>
</div>
<div>
<ul>
<li>
<p><a href="about//book/safety/index.html"><em>Don’t Panic</em></a> guarantee – Any panic is a bug. It never panics the host system.</p>
</li>
<li>
<p>Protected against malicious attacks – such as <a href="about//book/safety/max-call-stack.html">stack-overflow</a>,
<a href="about//book/safety/max-string-size.html">over-sized data</a>, and <a href="about//book/safety/max-operations.html">runaway scripts</a>
etc. – that may come from untrusted third-party user-land scripts.</p>
</li>
<li>
<p>Track script evaluation <a href="about//book/safety/progress.html">progress</a> and manually terminate a script run.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-flexible" class="admonition admonish-example" role="note" aria-labelledby="admonition-flexible-title">
<div class="admonition-title">
<div id="admonition-flexible-title">
<p>Flexible</p>
</div>
<a class="admonition-anchor-link" href="about/features.html#admonition-flexible"></a>
</div>
<div>
<ul>
<li>
<p>Re-entrant scripting <a href="about//book/engine/hello-world.html"><code>Engine</code></a> can be made <code>Send + Sync</code> (via the <a href="about//book/start/features.html"><code>sync</code></a> feature).</p>
</li>
<li>
<p>Support for <a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a> numbers.</p>
</li>
<li>
<p>Serialization/deserialization support via <a href="https://crates.io/crates/serde"><code>serde</code></a>.</p>
</li>
<li>
<p>Support for <a href="about//book/start/builds/minimal.html">minimal builds</a> by excluding unneeded language <a href="about//book/start/features.html">features</a>.</p>
</li>
<li>
<p>Supports <a href="about/targets.html">most build targets</a> including <code>no-std</code> and <a href="about//book/start/builds/wasm.html">WASM</a>.</p>
</li>
<li>
<p>Surgically <a href="about//book/engine/disable-keywords.html">disable keywords and operators</a> to restrict the language.</p>
</li>
<li>
<p>Use as a <a href="about//book/engine/dsl.html">DSL</a> by defining <a href="about//book/engine/custom-op.html">custom operators</a> and/or extending the language with <a href="about//book/engine/custom-syntax.html">custom syntax</a>.</p>
</li>
<li>
<p>A <a href="about//book/engine/debugging/debugger.html">debugging</a> interface provides powerful debugging support.</p>
</li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="what-rhai-isnt"><a class="header" href="#what-rhai-isnt">What Rhai Isn’t</a></h1>
<p>Rhai’s purpose is to provide a dynamic layer over Rust code, in the same spirit of <em>zero cost abstractions</em>.</p>
<p>It doesn’t attempt to be a new language. For example:</p>
<ul>
<li>
<p><strong>No classes</strong>.  Well, Rust doesn’t either. On the other hand…</p>
</li>
<li>
<p><strong>No traits</strong>…  so it is also not Rust. Do your Rusty stuff in Rust.</p>
</li>
<li>
<p><strong>No structures/records/tuples</strong> – define your types in Rust instead; Rhai can seamlessly
work with <a href="about//book/rust/custom-types.html"><em>any Rust type</em></a> that implements <code>Clone</code>.</p>
</li>
</ul>
<div id="admonition-object-maps" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-object-maps-title">
<div class="admonition-title">
<div id="admonition-object-maps-title">
<p>Object maps</p>
</div>
<a class="admonition-anchor-link" href="about/non-design.html#admonition-object-maps"></a>
</div>
<div>
<p>There is a built-in <a href="about//book/language/object-maps.html">object map</a> type which is adequate for most uses.</p>
<p>It is also possible to simulate <a href="about//book/patterns/oop.html">object-oriented programming (OOP)</a> by storing <a href="about//book/language/fn-ptr.html">function pointers</a>
or <a href="about//book/language/fn-closure.html">closures</a> in <a href="about//book/language/object-maps.html">object map</a> properties, turning them into <em><a href="about//book/rust/methods.html">methods</a></em>.</p>
</div>
</div>
<ul>
<li><strong>No first-class functions</strong> – Code your functions in Rust instead, and register them with Rhai.</li>
</ul>
<div id="admonition-function-pointers" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-function-pointers-title">
<div class="admonition-title">
<div id="admonition-function-pointers-title">
<p>Function pointers</p>
</div>
<a class="admonition-anchor-link" href="about/non-design.html#admonition-function-pointers"></a>
</div>
<div>
<p>There is support for simple <a href="about//book/language/fn-ptr.html">function pointers</a> to allow runtime dispatch by function name.</p>
</div>
</div>
<ul>
<li>
<p><strong>No garbage collection</strong> – this should be expected, so…</p>
</li>
<li>
<p><strong>No first-class closures</strong> – do your closure magic in Rust instead:
<a href="about//book/engine/call-fn.html">turn a Rhai scripted function into a Rust closure</a>.</p>
</li>
</ul>
<div id="admonition-simulated-closures" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-simulated-closures-title">
<div class="admonition-title">
<div id="admonition-simulated-closures-title">
<p>Simulated closures</p>
</div>
<a class="admonition-anchor-link" href="about/non-design.html#admonition-simulated-closures"></a>
</div>
<div>
<p>There is support for simulated <a href="about//book/language/fn-closure.html">closures</a> via <a href="about//book/language/fn-curry.html">currying</a> a <a href="about//book/language/fn-ptr.html">function pointer</a> with
<a href="about//book/language/fn-closure.html">captured</a> shared <a href="about//book/language/variables.html">variables</a>.</p>
</div>
</div>
<ul>
<li><strong>No formal language grammar</strong> – Rhai uses a hand-coded lexer, a hand-coded top-down
recursive-descent parser for statements, and a hand-coded Pratt parser for expressions.</li>
</ul>
<div id="admonition-highly-customizable" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-highly-customizable-title">
<div class="admonition-title">
<div id="admonition-highly-customizable-title">
<p>Highly customizable</p>
</div>
<a class="admonition-anchor-link" href="about/non-design.html#admonition-highly-customizable"></a>
</div>
<div>
<p>This lack of formalism allows the <em>tokenizer</em> and <em>parser</em> themselves to be exposed as services in
order to support a wide range of user customizations, such as:</p>
<ul>
<li><a href="about//book/engine/disable-keywords.html">disabling keywords and operators</a>,</li>
<li>dynamically <a href="about//book/engine/token-mapper.html">changing tokens</a> during parsing,</li>
<li>adding <a href="about//book/engine/custom-op.html">custom operators</a>,</li>
<li>defining <a href="about//book/engine/custom-syntax.html">custom syntax</a>,</li>
<li><a href="about//book/engine/def-var.html">filtering variables definition</a>.</li>
</ul>
</div>
</div>
<ul>
<li><strong>No bytecodes/JIT</strong> – Rhai uses a heavily-optimized AST-walking interpreter which is fast
enough for most real-life scenarios.</li>
</ul>
<div id="admonition-how-it-compares" class="admonition admonish-info small" role="note" aria-labelledby="admonition-how-it-compares-title">
<div class="admonition-title">
<div id="admonition-how-it-compares-title">
<p>How it compares?</p>
</div>
<a class="admonition-anchor-link" href="about/non-design.html#admonition-how-it-compares"></a>
</div>
<div>
<p>See Rhai performance <a href="about//book/about/benchmarks.html">benchmarks</a>.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="benchmarking-rhai"><a class="header" href="#benchmarking-rhai">Benchmarking Rhai</a></h1>
<div id="admonition-tip-nothing-beats-a-jit" class="admonition admonish-tip side wide" role="note" aria-labelledby="admonition-tip-nothing-beats-a-jit-title">
<div class="admonition-title">
<div id="admonition-tip-nothing-beats-a-jit-title">
<p>Tip: Nothing beats a JIT</p>
</div>
<a class="admonition-anchor-link" href="about/benchmarks.html#admonition-tip-nothing-beats-a-jit"></a>
</div>
<div>
<p>Needless to say <a href="https://v8.dev">V8</a> (JavaScript), which is a <a href="https://en.wikipedia.org/wiki/Just-in-time_compilation">JIT</a> compiler with type specialization, blows any interpreter
(AST or <a href="https://en.wikipedia.org/wiki/Bytecode">bytecodes</a> based) out of the water, as also should <a href="https://luajit.org">LuaJIT</a>.</p>
<p>So if you <em>absolutely must</em> have top performance…</p>
</div>
</div>
<p>The purpose of Rhai is not to be <em>blazing fast</em>, but to make it as easy and versatile as possible to
integrate with native Rust applications.</p>
<p>What you lose from running an <a href="about//book/engine/compile.html">AST</a> walker, you gain back from increased flexibility.</p>
<p>The following benchmarks were run on a 2.6GHz Linux VM comparing
<a href="about/../start/builds/performance.html">performance-optimized</a> and full builds of Rhai with <a href="https://www.python.org">Python 3</a> and
<a href="https://v8.dev">V8</a> (<a href="https://nodejs.org">Node.js</a>).</p>
<div class="table-wrapper"><table><thead><tr><th>Benchmark</th><th style="text-align: center">Rhai<br/>(Perf)</th><th style="text-align: center">Rhai</br>(Full)</th><th style="text-align: center"><a href="https://www.python.org">Python 3</a><br/>(<a href="https://en.wikipedia.org/wiki/Bytecode">bytecodes</a>)</th><th style="text-align: center"><a href="https://v8.dev">V8</a><br/>(<a href="https://en.wikipedia.org/wiki/Just-in-time_compilation">JIT</a>)</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/fibonacci.rhai">Fibonacci</a></td><td style="text-align: center">2.25s</td><td style="text-align: center">3.2s</td><td style="text-align: center">0.6s</td><td style="text-align: center">0.07s</td><td>stresses recursive <a href="about//book/language/functions.html">function</a> calls</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/speed_test.rhai">1M loop</a></td><td style="text-align: center">0.13s</td><td style="text-align: center">0.2s</td><td style="text-align: center">0.08s</td><td style="text-align: center">0.05s</td><td>a simple counting loop (1 million iterations) that must run as fast as possible</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/primes.rhai">Prime numbers</a></td><td style="text-align: center">0.85s</td><td style="text-align: center">1.2s</td><td style="text-align: center">0.4s</td><td style="text-align: center">0.09s</td><td>a closer-to-real-life calculation workload</td></tr>
</tbody></table>
</div>
<p>In general, Rhai is roughly 2x slower than <a href="https://www.python.org">Python 3</a>, which is a <a href="https://en.wikipedia.org/wiki/Bytecode">bytecodes</a> interpreter, for
typical real-life workloads.</p>
<div id="admonition-tldr--rhai-is-usually-fast-enough" class="admonition admonish-question" role="note" aria-labelledby="admonition-tldr--rhai-is-usually-fast-enough-title">
<div class="admonition-title">
<div id="admonition-tldr--rhai-is-usually-fast-enough-title">
<p>TL;DR – Rhai is usually fast enough</p>
</div>
<a class="admonition-anchor-link" href="about/benchmarks.html#admonition-tldr--rhai-is-usually-fast-enough"></a>
</div>
<div>
<h4 id="small-data-structures"><a class="header" href="#small-data-structures">Small data structures</a></h4>
<p>Essential <a href="about//book/engine/compile.html">AST</a> and runtime data structures are packed small and kept together
to maximize cache friendliness.</p>
<h4 id="pre-calculations"><a class="header" href="#pre-calculations">Pre-calculations</a></h4>
<p><a href="about//book/language/functions.html">Functions</a> are dispatched based on pre-calculated hashes.
<a href="about//book/language/variables.html">Variables</a> are mostly accessed through pre-calculated offsets to the <a href="about//book/language/variables.html">variables</a> file (a <a href="about//book/engine/scope.html"><code>Scope</code></a>).
It is seldom necessary to look something up by name.</p>
<h4 id="caching"><a class="header" href="#caching">Caching</a></h4>
<p><a href="about//book/language/functions.html">Function</a> resolutions are cached so they do not incur lookup costs after a couple of calls.</p>
<h4 id="no-scope-chain"><a class="header" href="#no-scope-chain">No scope-chain</a></h4>
<p>Maintaining a <em>scope chain</em> is deliberately avoided by design so <a href="about//book/language/functions.html">function</a> scopes do
not pay any speed penalty.
This allows <a href="about//book/language/variables.html">variables</a> data to be kept together in a contiguous block, avoiding allocations
and fragmentation while being cache-friendly.</p>
<h4 id="immutable-strings"><a class="header" href="#immutable-strings">Immutable strings</a></h4>
<p>Rhai uses <a href="about//book/rust/immutable-string.html">immutable strings</a> to bypass cloning issues.</p>
<h4 id="no-sharing"><a class="header" href="#no-sharing">No sharing</a></h4>
<p>In a typical script evaluation run, no data is shared and nothing is locked (other than
<a href="about//book/language/variables.html">variables</a> captured by <a href="about//book/language/fn-closure.html">closures</a>).</p>
</div>
</div>
<div id="admonition-do-not-write-the-next-4d-vr-game-entirely-in-rhai" class="admonition admonish-danger" role="note" aria-labelledby="admonition-do-not-write-the-next-4d-vr-game-entirely-in-rhai-title">
<div class="admonition-title">
<div id="admonition-do-not-write-the-next-4d-vr-game-entirely-in-rhai-title">
<p>DO NOT: Write the next 4D VR game entirely in Rhai</p>
</div>
<a class="admonition-anchor-link" href="about/benchmarks.html#admonition-do-not-write-the-next-4d-vr-game-entirely-in-rhai"></a>
</div>
<div>
<p>Rhai deliberately keeps the language small and lean by omitting advanced language features
such as classes, inheritance, interfaces, generics, first-class functions/closures, pattern matching,
monads (whatever), concurrency, async etc.</p>
<p>Focus is on <em>flexibility</em> and <em>ease of use</em> instead of a powerful, expressive language.</p>
<p>Avoid the temptation to write full-fledge application logic entirely in Rhai – that use case
is best fulfilled by more complete scripting languages such as JavaScript or <a href="https://www.lua.org/">Lua</a>.</p>
</div>
</div>
<div id="admonition-do-this-use-rhai-as-a-thin-dynamic-wrapper-layer-over-rust-code" class="admonition admonish-tip" role="note" aria-labelledby="admonition-do-this-use-rhai-as-a-thin-dynamic-wrapper-layer-over-rust-code-title">
<div class="admonition-title">
<div id="admonition-do-this-use-rhai-as-a-thin-dynamic-wrapper-layer-over-rust-code-title">
<p>DO THIS: Use Rhai as a thin dynamic wrapper layer over Rust code</p>
</div>
<a class="admonition-anchor-link" href="about/benchmarks.html#admonition-do-this-use-rhai-as-a-thin-dynamic-wrapper-layer-over-rust-code"></a>
</div>
<div>
<p>In actual practice, it is usually best to expose a Rust API into Rhai for scripts to call.</p>
<p>All the core functionalities should be written in Rust, with Rhai being the dynamic <em>control</em> layer.</p>
<p>This is similar to some dynamic languages where most of the core functionalities reside in a C/C++
standard library (e.g. <a href="https://www.python.org">Python 3</a>).</p>
<p>Another similar scenario is a web front-end driving back-end services written in a systems language.
In this case, JavaScript takes the role of Rhai while the back-end language, well… it can actually
also be Rust. Except that Rhai integrates with Rust <em>much</em> more tightly, removing the need for
interfaces such as XHR calls and payload encoding such as JSON.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="supported-targets-and-builds"><a class="header" href="#supported-targets-and-builds">Supported Targets and Builds</a></h1>
<p>Rhai supports all CPU and O/S targets supported by Rust, including:</p>
<ul>
<li>
<p>WebAssembly (<a href="about//book/start/builds/wasm.html">WASM</a>)</p>
</li>
<li>
<p><a href="about//book/start/builds/no-std.html"><code>no-std</code></a></p>
</li>
</ul>
<h2 id="minimum-rust-version"><a class="header" href="#minimum-rust-version">Minimum Rust Version</a></h2>
<p>The minimum version of Rust required to compile Rhai is <code>1.66.0</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h1>
<p>Rhai takes care to pull in as few dependencies as possible in order to avoid bloat when using the library.</p>
<h2 id="main-dependencies"><a class="header" href="#main-dependencies">Main Dependencies</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Crate</th><th>Description</th><th>Why use it?</th></tr></thead><tbody>
<tr><td><a href="https://crates.io/crates/smallvec"><code>smallvec</code></a></td><td><code>Vec</code> variant that stores a number of items inline</td><td>most functions have very few parameters, and avoiding allocations result in significant performance improvement</td></tr>
<tr><td><a href="https://crates.io/crates/thin-vec"><code>thin-vec</code></a></td><td><code>Vec</code> variant that takes up only the size of a single pointer</td><td>make key <code>enum</code> types with variants that contain <code>Vec</code>’s smaller</td></tr>
<tr><td><a href="https://crates.io/crates/num-traits"><code>num-traits</code></a></td><td>numeric traits</td><td>for use with macros defining arithmetic functions and operators</td></tr>
<tr><td><a href="https://crates.io/crates/ahash"><code>ahash</code></a></td><td>fast hashing for data</td><td>not cryptographically secure, thus faster than standard Rust hashing; Rhai does a <em>lot</em> of hashing so this matters</td></tr>
<tr><td><a href="https://crates.io/crates/once_cell"><code>once_cell</code></a></td><td>global static data</td><td>fixed hashing keys for <a href="about//book/patterns/static-hash.html">static hashing</a></td></tr>
<tr><td><a href="https://crates.io/crates/bitflags"><code>bitflags</code></a></td><td>bit fields</td><td>store flags in <a href="about//book/engine/compile.html"><code>AST</code></a> nodes to minimize memory usage</td></tr>
<tr><td><a href="https://crates.io/crates/smartstring"><code>smartstring</code></a></td><td><code>String</code> variant that stores short <a href="about//book/language/strings-chars.html">strings</a> inline</td><td>most <a href="about//book/language/strings-chars.html">strings</a> in scripts (e.g. keywords, properties, symbols, variables, function names etc.) are short, and avoiding allocations result in significant performance improvement</td></tr>
</tbody></table>
</div>
<h2 id="no-std-dependencies"><a class="header" href="#no-std-dependencies"><code>no-std</code> Dependencies</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Crate</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="https://gitlab.com/jD91mZM2/no-std-compat"><code>no-std-compat</code></a></td><td>create <code>std</code> imports under <code>no-std</code></td></tr>
<tr><td><a href="https://crates.io/crates/libm"><code>libm</code></a></td><td><code>no-std</code> math library</td></tr>
<tr><td><a href="https://crates.io/crates/core-error"><code>core-error</code></a></td><td><code>Error</code> trait for <code>no-std</code></td></tr>
<tr><td><a href="https://crates.io/crates/hashbrown"><code>hashbrown</code></a></td><td><code>HashMap</code> and <code>HashSet</code>for <code>no-std</code></td></tr>
</tbody></table>
</div>
<h2 id="feature-dependencies"><a class="header" href="#feature-dependencies">Feature Dependencies</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Crate</th><th style="text-align: center">Pulled in by feature</th></tr></thead><tbody>
<tr><td><a href="https://crates.io/crates/rust_decimal"><code>rust_decimal</code></a></td><td style="text-align: center"><a href="about//book/start/features.html"><code>decimal</code></a></td></tr>
<tr><td><a href="https://crates.io/crates/unicode-xid"><code>unicode-xid</code></a></td><td style="text-align: center"><a href="about//book/start/features.html"><code>unicode-xid-ident</code></a></td></tr>
<tr><td><a href="https://crates.io/crates/serde"><code>serde</code></a></td><td style="text-align: center"><a href="about//book/rust/serde.html"><code>serde</code></a>, <a href="about//book/start/features.html"><code>metadata</code></a></td></tr>
<tr><td><a href="https://crates.io/crates/serde_json"><code>serde_json</code></a></td><td style="text-align: center"><a href="about//book/start/features.html"><code>metadata</code></a></td></tr>
<tr><td><a href="https://crates.io/crates/rustyline"><code>rustyline</code></a></td><td style="text-align: center"><code>bin-features</code></td></tr>
</tbody></table>
</div>
<h2 id="wasm-dependencies"><a class="header" href="#wasm-dependencies">WASM Dependencies</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Crate</th><th style="text-align: center">Pulled in by feature</th></tr></thead><tbody>
<tr><td><a href="https://crates.io/crates/wasm-bindgen"><code>wasm-bindgen</code></a></td><td style="text-align: center"><a href="about//book/start/features.html"><code>wasm-bindgen</code></a></td></tr>
<tr><td><a href="https://crates.io/crates/stdweb"><code>stdweb</code></a></td><td style="text-align: center"><a href="about//book/start/features.html"><code>stdweb</code></a></td></tr>
<tr><td><a href="https://crates.io/crates/instant"><code>instant</code></a></td><td style="text-align: center"><a href="about//book/start/features.html"><code>wasm-bindgen</code></a>, <a href="about//book/start/features.html"><code>stdweb</code></a></td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="licensing"><a class="header" href="#licensing">Licensing</a></h1>
<p>Rhai is licensed under either of the following, at your choice:</p>
<ul>
<li>
<p><a href="https://github.com/rhaiscript/rhai/blob/main/LICENSE-APACHE.txt">Apache License, Version 2.0</a>, or</p>
</li>
<li>
<p><a href="https://github.com/rhaiscript/rhai/blob/main/LICENSE-MIT.txt">MIT license</a>.</p>
</li>
</ul>
<div id="admonition-notice" class="admonition admonish-abstract" role="note" aria-labelledby="admonition-notice-title">
<div class="admonition-title">
<div id="admonition-notice-title">
<p>Notice</p>
</div>
<a class="admonition-anchor-link" href="about/license.html#admonition-notice"></a>
</div>
<div>
<p>Unless explicitly stated otherwise, any contribution intentionally submitted for inclusion in this
crate, as defined in the Apache-2.0 license, shall be dual-licensed as above, without any additional
terms or conditions.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="related-resources"><a class="header" href="#related-resources">Related Resources</a></h1>
<div id="admonition-online-resources" class="admonition admonish-danger" role="note" aria-labelledby="admonition-online-resources-title">
<div class="admonition-title">
<div id="admonition-online-resources-title">
<p>Online resources</p>
</div>
<a class="admonition-anchor-link" href="about/related.html#admonition-online-resources"></a>
</div>
<div>
<ul>
<li>
<p><a href="https://github.com/rhaiscript">GitHub</a> – Rhai organization</p>
</li>
<li>
<p><a href="https://rhai.rs"><code>rhai.rs</code></a> – Home website</p>
</li>
<li>
<p><a href="https://crates.io/crates/rhai"><code>crates.io</code></a> – Rhai crate</p>
</li>
<li>
<p><a href="https://docs.rs/rhai"><code>DOCS.RS</code></a> – Rhai API documentation</p>
</li>
<li>
<p><a href="https://lib.rs/crates/rhai"><code>LIB.RS</code></a> – Rhai library info</p>
</li>
<li>
<p><a href="https://discord.gg/HquqbYFcZ9">Discord Chat</a> – Rhai channel</p>
</li>
<li>
<p><a href="https://rhaiscript.zulipchat.com">Zulip Chat</a> – Rhai organization</p>
</li>
<li>
<p><a href="https://www.reddit.com/r/Rhai">Reddit</a> – Rhai community</p>
</li>
</ul>
</div>
</div>
<div id="admonition-external-tools" class="admonition admonish-tip" role="note" aria-labelledby="admonition-external-tools-title">
<div class="admonition-title">
<div id="admonition-external-tools-title">
<p>External tools</p>
</div>
<a class="admonition-anchor-link" href="about/related.html#admonition-external-tools"></a>
</div>
<div>
<ul>
<li>
<p><a href="https://rhai.rs/playground">Online Playground</a> – Run Rhai scripts directly from an editor in the browser</p>
</li>
<li>
<p><a href="https://github.com/rhaiscript/lsp">Language Server</a> – Language Server Protocol (LSP) server for Rhai</p>
</li>
<li>
<p><a href="https://github.com/rhaiscript/rhai-doc"><code>rhai-doc</code></a> – Rhai script documentation tool</p>
</li>
</ul>
</div>
</div>
<div id="admonition-syntax-highlighting" class="admonition admonish-note" role="note" aria-labelledby="admonition-syntax-highlighting-title">
<div class="admonition-title">
<div id="admonition-syntax-highlighting-title">
<p>Syntax highlighting</p>
</div>
<a class="admonition-anchor-link" href="about/related.html#admonition-syntax-highlighting"></a>
</div>
<div>
<ul>
<li>
<p><a href="https://marketplace.visualstudio.com/items?itemName=rhaiscript.vscode-rhai">VS Code Extension</a>
– Support <code>.rhai</code> script files syntax highlighting for Visual Studio Code</p>
</li>
<li>
<p><a href="https://packagecontrol.io/packages/Rhai">Sublime Text 3 Plugin</a> – Support <code>.rhai</code> script
files syntax highlighting for Sublime Text 3</p>
</li>
<li>
<p>For other syntax highlighting purposes, e.g. <code>vim</code>, <code>highlight.js</code>, both Rust or JavaScript can be
used successfully.</p>
<p>Use <code>rust</code> when there is no <a href="about//book/language/strings-chars.html">string interpolation</a>. This way, <a href="about//book/language/fn-closure.html">closures</a> and <a href="about//book/language/functions.html">functions</a>
(via the <code>fn</code> keyword) are styled properly. Elements not highlighted include:</p>
<ul>
<li><a href="about//book/language/strings-chars.html">strings interpolation</a></li>
<li>the <a href="about//book/language/switch.html"><code>switch</code></a>, <a href="about//book/language/modules/import.html"><code>import</code></a> and <a href="about//book/language/modules/export.html"><code>export</code></a> statements</li>
<li>the <code>this</code> and <a href="about//book/language/modules/export.html"><code>private</code></a> keywords</li>
<li>built-in functions such as <code>Fn</code>, <code>call</code>, <a href="about//book/language/type-of.html"><code>type_of</code></a>, <code>is_shared</code>, <code>is_def_var</code>, <code>is_def_fn</code></li>
</ul>
<p>Use <code>js</code> (JavaScript) when there is <a href="about//book/language/strings-chars.html">strings interpolation</a>.  Elements not highlighted include:</p>
<ul>
<li><a href="about//book/language/functions.html">functions</a> definition (via the <code>fn</code> keyword)</li>
<li><a href="about//book/language/fn-closure.html">closures</a> (via the Rust-like <code>|...| { ... }</code> syntax)</li>
<li>built-in functions such as <code>Fn</code>, <code>call</code>, <a href="about//book/language/type-of.html"><code>type_of</code></a>, <code>is_shared</code>, <code>is_def_var</code>, <code>is_def_fn</code></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="admonition-other-cool-projects" class="admonition admonish-abstract" role="note" aria-labelledby="admonition-other-cool-projects-title">
<div class="admonition-title">
<div id="admonition-other-cool-projects-title">
<p>Other cool projects</p>
</div>
<a class="admonition-anchor-link" href="about/related.html#admonition-other-cool-projects"></a>
</div>
<div>
<ul>
<li>
<p><a href="http://chaiscript.com">ChaiScript</a> – A strong inspiration for Rhai.
An embedded scripting language for C++.</p>
</li>
<li>
<p>Check out the list of <a href="https://github.com/rust-unofficial/awesome-rust#scripting">scripting languages for Rust</a>
on <a href="https://github.com/rust-unofficial/awesome-rust">awesome-rust</a></p>
</li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h1>
<p>This section shows how to install the Rhai crate into a Rust application.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="online-playground"><a class="header" href="#online-playground">Online Playground</a></h1>
<div id="admonition-see-also" class="admonition admonish-info side" role="note" aria-labelledby="admonition-see-also-title">
<div class="admonition-title">
<div id="admonition-see-also-title">
<p>See also</p>
</div>
<a class="admonition-anchor-link" href="start/playground.html#admonition-see-also"></a>
</div>
<div>
<p>For more details, see the section <a href="start//book/tools/playground.html">here</a>.</p>
</div>
</div>
<p>Rhai provides an <a href="https://rhai.rs/playground">online playground</a> to try out its language and engine features without
having to install anything.</p>
<p>The playground provides a syntax-highlighting script editor with example snippets.</p>
<p>Scripts can be evaluated directly from the editor.</p>
<p><a href="https://rhai.rs/playground"><img src="start//book/images/playground.png" alt="Online Playground" /></a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="install-the-rhai-crate"><a class="header" href="#install-the-rhai-crate">Install the Rhai Crate</a></h1>
<p>In order to use Rhai in a project, the Rhai crate must first be made a dependency.</p>
<div id="admonition-use-specific-version" class="admonition admonish-info" role="note" aria-labelledby="admonition-use-specific-version-title">
<div class="admonition-title">
<div id="admonition-use-specific-version-title">
<p>Use specific version</p>
</div>
<a class="admonition-anchor-link" href="start/install.html#admonition-use-specific-version"></a>
</div>
<div>
<p>The easiest way is to install the Rhai crate from <a href="https://crates.io/crates/rhai/"><code>crates.io</code></a>,
starting by looking up the latest version and adding this line under <code>dependencies</code> in the project’s <code>Cargo.toml</code>:</p>
<pre><code class="language-toml">[dependencies]
rhai = "1.22.0"    # assuming 1.22.0 is the latest version
</code></pre>
</div>
</div>
<div id="admonition-use-latest-release-version" class="admonition admonish-note" role="note" aria-labelledby="admonition-use-latest-release-version-title">
<div class="admonition-title">
<div id="admonition-use-latest-release-version-title">
<p>Use latest release version</p>
</div>
<a class="admonition-anchor-link" href="start/install.html#admonition-use-latest-release-version"></a>
</div>
<div>
<p>Automatically use the latest released crate version on <a href="https://crates.io/crates/rhai/"><code>crates.io</code></a>:</p>
<pre><code class="language-toml">[dependencies]
rhai = "*"
</code></pre>
</div>
</div>
<div id="admonition-use-latest-development-version" class="admonition admonish-tip" role="note" aria-labelledby="admonition-use-latest-development-version-title">
<div class="admonition-title">
<div id="admonition-use-latest-development-version-title">
<p>Use latest development version</p>
</div>
<a class="admonition-anchor-link" href="start/install.html#admonition-use-latest-development-version"></a>
</div>
<div>
<p>Crate versions are released on <a href="https://crates.io/crates/rhai/"><code>crates.io</code></a> infrequently,
so to track the latest features, enhancements and bug fixes, pull directly from
<a href="https://github.com/rhaiscript/rhai">GitHub</a>:</p>
<pre><code class="language-toml">[dependencies]
rhai = { git = "https://github.com/rhaiscript/rhai" }
</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="optional-features"><a class="header" href="#optional-features">Optional Features</a></h1>
<p>By default, Rhai includes all the standard functionalities in a small, tight package.</p>
<div id="admonition-features-are-not-additive" class="admonition admonish-warning" role="note" aria-labelledby="admonition-features-are-not-additive-title">
<div class="admonition-title">
<div id="admonition-features-are-not-additive-title">
<p>Features are not additive</p>
</div>
<a class="admonition-anchor-link" href="start/features.html#admonition-features-are-not-additive"></a>
</div>
<div>
<p>Most Rhai features are not strictly <em>additive</em>, i.e. they do not only add optional functionalities.</p>
<p>In fact, most features are <em>subtractive</em>, i.e. they opt-<strong>out</strong> of unneeded functionalities.
Notice that this deviates from Rust norm where features are <em>additive</em>.</p>
<p>Excluding functionalities result in smaller, faster builds as well as more control over
what scripts can (or cannot) do.</p>
<p>There is a reason for this design, because the <em>lack</em> of a language feature by itself is a feature (that’s deep…).</p>
<p>See <a href="start//book/patterns/multiple.html">here</a> for more details.</p>
</div>
</div>
<h2 id="features-that-enable-special-functionalities"><a class="header" href="#features-that-enable-special-functionalities">Features that Enable Special Functionalities</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Feature</th><th style="text-align: center">Additive?</th><th>Description</th></tr></thead><tbody>
<tr><td><code>std</code></td><td style="text-align: center"><strong>no</strong></td><td>standard features</td></tr>
<tr><td><code>sync</code></td><td style="text-align: center"><strong>no</strong></td><td>restricts all values types to those that are <code>Send + Sync</code>; under this feature, all Rhai types, including <a href="start//book/engine/hello-world.html"><code>Engine</code></a>, <a href="start//book/engine/scope.html"><code>Scope</code></a> and <a href="start//book/engine/compile.html"><code>AST</code></a>, are all <code>Send + Sync</code></td></tr>
<tr><td><code>decimal</code></td><td style="text-align: center"><strong>no</strong></td><td>enables the <a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a> number type (pulls in the <a href="https://crates.io/crates/rust_decimal"><code>rust_decimal</code></a> crate)</td></tr>
<tr><td><code>unicode-xid-ident</code></td><td style="text-align: center"><strong>no</strong></td><td>allows <a href="http://www.unicode.org/reports/tr31/">Unicode Standard Annex #31</a> as identifiers (pulls in the <a href="https://crates.io/crates/unicode-xid"><code>unicode-xid</code></a> crate)</td></tr>
<tr><td><code>serde</code></td><td style="text-align: center">yes</td><td>enables serialization/deserialization via <code>serde</code> (pulls in the <a href="https://crates.io/crates/serde"><code>serde</code></a> crate)</td></tr>
<tr><td><code>metadata</code></td><td style="text-align: center">yes</td><td>enables exporting <a href="start//book/engine/metadata/index.html">functions metadata</a>; implies <code>serde</code> and additionally pulls in <a href="https://crates.io/crates/serde_json"><code>serde_json</code></a></td></tr>
<tr><td><code>internals</code></td><td style="text-align: center">yes</td><td>exposes internal data structures (e.g. <a href="start//book/engine/compile.html"><code>AST</code></a> nodes);<br/><br/><strong>Safety Warnings</strong><ul><li>allowing access to internal types may enable external attack vectors</li><li>internal types and functions are volatile and may change from version to version</li></ul></td></tr>
<tr><td><code>debugging</code></td><td style="text-align: center">yes</td><td>enables the <a href="start//book/engine/debugging/debugger.html">debugging</a> interface; implies <code>internals</code></td></tr>
</tbody></table>
</div>
<h2 id="features-that-disable-certain-language-features"><a class="header" href="#features-that-disable-certain-language-features">Features that Disable Certain Language Features</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Feature</th><th style="text-align: center">Additive?</th><th>Description</th></tr></thead><tbody>
<tr><td><code>no_float</code></td><td style="text-align: center"><strong>no</strong></td><td>disables floating-point numbers and math</td></tr>
<tr><td><code>no_index</code></td><td style="text-align: center"><strong>no</strong></td><td>disables <a href="start//book/language/arrays.html">arrays</a> and indexing features</td></tr>
<tr><td><code>no_object</code></td><td style="text-align: center"><strong>no</strong></td><td>disables support for <a href="start//book/rust/custom-types.html">custom types</a> and <a href="start//book/language/object-maps.html">object maps</a></td></tr>
<tr><td><code>no_time</code></td><td style="text-align: center"><strong>no</strong></td><td>disables <a href="start//book/language/timestamps.html">timestamps</a></td></tr>
<tr><td><code>no_function</code></td><td style="text-align: center"><strong>no</strong></td><td>disables script-defined <a href="start//book/language/functions.html">functions</a>; implies <code>no_closure</code></td></tr>
<tr><td><code>no_module</code></td><td style="text-align: center"><strong>no</strong></td><td>disables loading external <a href="start//book/rust/modules/index.html">modules</a></td></tr>
<tr><td><code>no_closure</code></td><td style="text-align: center"><strong>no</strong></td><td>disables capturing external variables in <a href="start//book/language/fn-closure.html">closures</a></td></tr>
<tr><td><code>no_custom_syntax</code></td><td style="text-align: center"><strong>no</strong></td><td>disables <a href="start//book/engine/custom-syntax.html">custom syntax</a> and <a href="start//book/engine/custom-op.html">custom operators</a></td></tr>
</tbody></table>
</div>
<h2 id="features-that-disable-certain-engine-features"><a class="header" href="#features-that-disable-certain-engine-features">Features that Disable Certain Engine Features</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Feature</th><th style="text-align: center">Additive?</th><th>Description</th></tr></thead><tbody>
<tr><td><code>unchecked</code></td><td style="text-align: center"><strong>no</strong></td><td>disables <a href="start//book/safety/checked.html">arithmetic checking</a> (such as over-flows and division by zero), <a href="start//book/safety/max-call-stack.html">call stack depth limit</a>, <a href="start//book/safety/max-operations.html">operations count limit</a>, <a href="start//book/safety/max-modules.html">modules loading limit</a> and <a href="start//book/safety/max-string-size.html">data size limit</a>.<br/>Beware that a bad script may panic the entire system!</td></tr>
<tr><td><code>no_optimize</code></td><td style="text-align: center"><strong>no</strong></td><td>disables <a href="start//book/engine/optimize/index.html">script optimization</a></td></tr>
<tr><td><code>no_position</code></td><td style="text-align: center"><strong>no</strong></td><td>disables position tracking during parsing</td></tr>
</tbody></table>
</div>
<h2 id="features-that-configure-the-engine"><a class="header" href="#features-that-configure-the-engine">Features that Configure the Engine</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Feature</th><th style="text-align: center">Additive?</th><th>Description</th></tr></thead><tbody>
<tr><td><code>f32_float</code></td><td style="text-align: center"><strong>no</strong></td><td>sets the system floating-point type (<code>FLOAT</code>) to <code>f32</code> instead of <code>f64</code>; no effect under <code>no_float</code></td></tr>
<tr><td><code>only_i32</code></td><td style="text-align: center"><strong>no</strong></td><td>sets the system integer type (<code>INT</code>) to <code>i32</code> and disable all other integer types</td></tr>
<tr><td><code>only_i64</code></td><td style="text-align: center"><strong>no</strong></td><td>sets the system integer type (<code>INT</code>) to <code>i64</code> and disable all other integer types</td></tr>
</tbody></table>
</div>
<h2 id="features-for-no-std-builds"><a class="header" href="#features-for-no-std-builds">Features for <code>no-std</code> Builds</a></h2>
<p>The following features are provided exclusively for <a href="start//book/start/builds/no-std.html"><code>no-std</code></a> targets.
Do not use them when not compiling for <a href="start//book/start/builds/no-std.html"><code>no-std</code></a>.</p>
<p>Specify <code>default-features = false</code> when compiling for <a href="start//book/start/builds/no-std.html"><code>no-std</code></a>, which will remove the default
<code>std</code> feature.</p>
<div class="table-wrapper"><table><thead><tr><th>Feature</th><th style="text-align: center">Additive?</th><th>Description</th></tr></thead><tbody>
<tr><td><code>no_std</code></td><td style="text-align: center"><strong>no</strong></td><td>builds for <a href="start//book/start/builds/no-std.html"><code>no-std</code></a>; notice that additional dependencies will be pulled in to replace missing <code>std</code> features</td></tr>
</tbody></table>
</div>
<h2 id="features-for-webassembly-wasm-builds"><a class="header" href="#features-for-webassembly-wasm-builds">Features for WebAssembly (WASM) Builds</a></h2>
<p>The following features are provided exclusively for <a href="start//book/start/builds/wasm.html">WASM</a> targets.
Do not use them for non-<a href="start//book/start/builds/wasm.html">WASM</a> targets.</p>
<div class="table-wrapper"><table><thead><tr><th>Feature</th><th style="text-align: center">Additive?</th><th>Description</th></tr></thead><tbody>
<tr><td><code>wasm-bindgen</code></td><td style="text-align: center"><strong>no</strong></td><td>uses <a href="https://crates.io/crates/wasm-bindgen"><code>wasm-bindgen</code></a> to compile for <a href="start//book/start/builds/wasm.html">WASM</a></td></tr>
<tr><td><code>stdweb</code></td><td style="text-align: center"><strong>no</strong></td><td>uses <a href="https://crates.io/crates/stdweb"><code>stdweb</code></a> to compile for <a href="start//book/start/builds/wasm.html">WASM</a></td></tr>
</tbody></table>
</div>
<h2 id="features-for-building-bin-tools"><a class="header" href="#features-for-building-bin-tools">Features for Building Bin Tools</a></h2>
<p>The feature <code>bin-features</code> include all the features necessary for building the <a href="start/bin.html">bin tools</a>.</p>
<p>By default, it includes: <code>decimal</code>, <code>metadata</code>, <code>serde</code>, <code>debugging</code> and <code>rustyline</code>.</p>
<h2 id="example"><a class="header" href="#example">Example</a></h2>
<p>The <code>Cargo.toml</code> configuration below:</p>
<pre><code class="language-toml">[dependencies]
rhai = { version = "1.22.0", features = [ "sync", "unchecked", "only_i32", "no_float", "no_module", "no_function" ] }
</code></pre>
<p>turns on these six features:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Feature</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>sync</code></td><td>everything is <code>Send + Sync</code></td></tr>
<tr><td style="text-align: center"><code>unchecked</code></td><td>disable all <a href="start//book/safety/index.html">safety checks</a> (should not be used with untrusted user scripts)</td></tr>
<tr><td style="text-align: center"><code>only_i32</code></td><td>use only 32-bit signed integers and no others</td></tr>
<tr><td style="text-align: center"><code>no_float</code></td><td>no floating point numbers</td></tr>
<tr><td style="text-align: center"><code>no_module</code></td><td>no loading external <a href="start//book/rust/modules/index.html">modules</a></td></tr>
<tr><td style="text-align: center"><code>no_function</code></td><td>no defining <a href="start//book/language/functions.html">functions</a></td></tr>
</tbody></table>
</div>
<p>The resulting scripting engine supports only the <code>i32</code> integer numeral type (and no others like
<code>u32</code>, <code>i16</code> or <code>i64</code>), no floating-point, is <code>Send + Sync</code> (so it can be safely used across
threads), and does not support defining <a href="start//book/language/functions.html">functions</a> nor loading external <a href="start//book/rust/modules/index.html">modules</a>.</p>
<p>This configuration is perfect for an expression parser in a 32-bit embedded system without
floating-point hardware.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="packaged-utilities"><a class="header" href="#packaged-utilities">Packaged Utilities</a></h1>
<p>A number of Rhai-driven tools can be found in the <code>src/bin</code> directory:</p>
<div id="admonition-tip-domain-specific-tools" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-domain-specific-tools-title">
<div class="admonition-title">
<div id="admonition-tip-domain-specific-tools-title">
<p>Tip: Domain-specific tools</p>
</div>
<a class="admonition-anchor-link" href="start/bin.html#admonition-tip-domain-specific-tools"></a>
</div>
<div>
<p>It is possible to turn these tools into <a href="start/../patterns/domain-tools.html"><em>Domain-Specific Tools</em></a>.</p>
</div>
</div>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Tool</th><th style="text-align: center">Required feature(s)</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: center"><a href="https://github.com/rhaiscript/rhai/blob/main/src/bin/rhai-run.rs"><code>rhai-run</code></a></td><td style="text-align: center"></td><td>runs Rhai script files</td></tr>
<tr><td style="text-align: center"><a href="https://github.com/rhaiscript/rhai/blob/main/src/bin/rhai-repl.rs"><code>rhai-repl</code></a></td><td style="text-align: center"><code>rustyline</code></td><td>a simple REPL tool</td></tr>
<tr><td style="text-align: center"><a href="https://github.com/rhaiscript/rhai/blob/main/src/bin/rhai-dbg.rs"><code>rhai-dbg</code></a></td><td style="text-align: center"><a href="start//book/start/features.html"><code>debugging</code></a></td><td>the <em>Rhai Debugger</em></td></tr>
</tbody></table>
</div><div id="admonition-tip-bin-features" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-bin-features-title">
<div class="admonition-title">
<div id="admonition-tip-bin-features-title">
<p>Tip: <code>bin-features</code></p>
</div>
<a class="admonition-anchor-link" href="start/bin.html#admonition-tip-bin-features"></a>
</div>
<div>
<p>Some bin tools require certain <a href="start//book/start/features.html">features</a> and will not be built by default without those <a href="start//book/start/features.html">features</a> set.</p>
<p>For convenience, a feature named <a href="start//book/start/features.html"><code>bin-features</code></a> is available which is a combination of
the following:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Feature</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: center"><a href="start//book/start/features.html"><code>decimal</code></a></td><td>support for <a href="https://crates.io/crates/rust_decimal">decimal</a> numbers</td></tr>
<tr><td style="text-align: center"><a href="start//book/start/features.html"><code>metadata</code></a></td><td>access <a href="start//book/engine/metadata/index.html">functions metadata</a></td></tr>
<tr><td style="text-align: center"><a href="start//book/rust/serde.html"><code>serde</code></a></td><td>export <a href="start//book/engine/metadata/index.html">functions metadata</a> to JSON</td></tr>
<tr><td style="text-align: center"><a href="start//book/start/features.html"><code>debugging</code></a></td><td>required by <code>rhai-dbg</code></td></tr>
<tr><td style="text-align: center"><code>rustyline</code></td><td>required by <code>rhai-repl</code></td></tr>
</tbody></table>
</div></div>
</div>
<h2 id="install-tools"><a class="header" href="#install-tools">Install Tools</a></h2>
<p>To install all these tools (with full features), use the following command:</p>
<pre><code class="language-sh">cargo install --path . --bins  --features bin-features
</code></pre>
<p>or specifically:</p>
<pre><code class="language-sh">cargo install --path . --bin sample_app_to_run  --features bin-features
</code></pre>
<h2 id="run-a-tool-from-cargo"><a class="header" href="#run-a-tool-from-cargo">Run a Tool from Cargo</a></h2>
<p>Tools can also be run with the following <code>cargo</code> command:</p>
<pre><code class="language-sh">cargo run --features bin-features --bin sample_app_to_run
</code></pre>
<h2 id="tools-list"><a class="header" href="#tools-list">Tools List</a></h2>
<div id="admonition-rhai-repl--the-rhai-repl-tool" class="admonition admonish-example" role="note" aria-labelledby="admonition-rhai-repl--the-rhai-repl-tool-title">
<div class="admonition-title">
<div id="admonition-rhai-repl--the-rhai-repl-tool-title">
<p><code>rhai-repl</code> – The Rhai REPL Tool</p>
</div>
<a class="admonition-anchor-link" href="start/bin.html#admonition-rhai-repl--the-rhai-repl-tool"></a>
</div>
<div>
<p><code>rhai-repl</code> is a particularly useful tool – it allows one to interactively try out
Rhai’s language features in a standard REPL (<strong>R</strong>ead-<strong>E</strong>val-<strong>P</strong>rint <strong>L</strong>oop).</p>
<p>Filenames passed to it as command line arguments are run and loaded as Rhai scripts before the REPL starts.</p>
<h3 id="test-functions"><a class="header" href="#test-functions">Test functions</a></h3>
<p>The following test functions are pre-registered, via <code>Engine::register_fn</code>, into <code>rhai-repl</code>.
They are intended for testing purposes.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Description</th></tr></thead><tbody>
<tr><td><code>test(x: i64, y: i64)</code></td><td>returns a string with both numbers</td></tr>
<tr><td><code>test(x: &amp;mut i64, y: i64, z: &amp;str)</code></td><td>displays the parameters and add <code>y</code> to <code>x</code></td></tr>
</tbody></table>
</div>
<h3 id="example-1"><a class="header" href="#example-1">Example</a></h3>
<p>The following command first runs three scripts – <code>init1.rhai</code>, <code>init2.rhai</code> and <code>init3.rhai</code> –
loading the functions defined in each script into the <em>global</em> namespace.</p>
<p>Then it enters an REPL, which can call the above functions freely.</p>
<pre><code class="language-sh">rhai-repl init1.rhai init2.rhai init3.rhai
</code></pre>
</div>
</div>
<div id="admonition-rhai-run--the-rhai-runner" class="admonition admonish-danger" role="note" aria-labelledby="admonition-rhai-run--the-rhai-runner-title">
<div class="admonition-title">
<div id="admonition-rhai-run--the-rhai-runner-title">
<p><code>rhai-run</code> – The Rhai Runner</p>
</div>
<a class="admonition-anchor-link" href="start/bin.html#admonition-rhai-run--the-rhai-runner"></a>
</div>
<div>
<p>Use <code>rhai-run</code> to run Rhai scripts.</p>
<p>Filenames passed to it as command line arguments are run in sequence as Rhai scripts.</p>
<h3 id="example-2"><a class="header" href="#example-2">Example</a></h3>
<p>The following command runs the scripts <code>script1.rhai</code>, <code>script2.rhai</code> and <code>script3.rhai</code> in order.</p>
<pre><code class="language-sh">rhai-run script1.rhai script2.rhai script3.rhai
</code></pre>
</div>
</div>
<div id="admonition-rhai-dbg--the-rhai-debugger" class="admonition admonish-bug" role="note" aria-labelledby="admonition-rhai-dbg--the-rhai-debugger-title">
<div class="admonition-title">
<div id="admonition-rhai-dbg--the-rhai-debugger-title">
<p><code>rhai-dbg</code> – The Rhai Debugger</p>
</div>
<a class="admonition-anchor-link" href="start/bin.html#admonition-rhai-dbg--the-rhai-debugger"></a>
</div>
<div>
<p>Use <code>rhai-dbg</code> to debug a Rhai script.</p>
<p>Filename passed to it will be loaded as a Rhai script for debugging.</p>
<h3 id="example-3"><a class="header" href="#example-3">Example</a></h3>
<p>The following command debugs the script <code>my_script.rhai</code>.</p>
<pre><code class="language-sh">rhai-dbg my_script.rhai
</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="using-the-engine"><a class="header" href="#using-the-engine">Using the Engine</a></h1>
<p>Rhai’s interpreter resides in the <a href="engine//book/engine/hello-world.html"><code>Engine</code></a> type under the master <code>rhai</code> namespace.</p>
<p>This section shows how to set up, configure and use this scripting engine.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="your-first-script-in-rhai"><a class="header" href="#your-first-script-in-rhai">Your First Script in Rhai</a></h1>
<h2 id="run-a-script"><a class="header" href="#run-a-script">Run a Script</a></h2>
<p>To get going with Rhai is as simple as creating an instance of the scripting engine <code>rhai::Engine</code>
via <code>Engine::new</code>, then calling <code>Engine::run</code>.</p>
<pre><code class="language-rust">use rhai::{Engine, EvalAltResult};

pub fn main() -&gt; Result&lt;(), Box&lt;EvalAltResult&gt;&gt;
//                          ^^^^^^^^^^^^^^^^^^
//                          Rhai API error type
{
    // Create an 'Engine'
    let engine = Engine::new();

    // Your first Rhai Script
    let script = "print(40 + 2);";

    // Run the script - prints "42"
    engine.run(script)?;

    // Done!
    Ok(())
}</code></pre>
<h2 id="get-a-return-value"><a class="header" href="#get-a-return-value">Get a Return Value</a></h2>
<p>To return a value from the script, use <code>Engine::eval</code> instead.</p>
<pre><code class="language-rust">use rhai::{Engine, EvalAltResult};

pub fn main() -&gt; Result&lt;(), Box&lt;EvalAltResult&gt;&gt;
{
    let engine = Engine::new();

    let result = engine.eval::&lt;i64&gt;("40 + 2")?;
    //                      ^^^^^^^ required: cast the result to a type

    println!("Answer: {result}");             // prints 42

    Ok(())
}</code></pre>
<h2 id="use-script-files"><a class="header" href="#use-script-files">Use Script Files</a></h2>
<div id="admonition-script-file-extension" class="admonition admonish-info side" role="note" aria-labelledby="admonition-script-file-extension-title">
<div class="admonition-title">
<div id="admonition-script-file-extension-title">
<p>Script file extension</p>
</div>
<a class="admonition-anchor-link" href="engine/hello-world.html#admonition-script-file-extension"></a>
</div>
<div>
<p>Rhai script files are customarily named with extension <code>.rhai</code>.</p>
</div>
</div>
<p>Or evaluate a script file directly with <code>Engine::run_file</code> or <code>Engine::eval_file</code>.</p>
<p>Loading and running script files is not available for <a href="engine//book/start/features.html"><code>no_std</code></a> or <a href="engine//book/start/builds/wasm.html">WASM</a> builds.</p>
<pre><code class="language-rust">let result = engine.eval_file::&lt;i64&gt;("hello_world.rhai".into())?;
//                                   ^^^^^^^^^^^^^^^^^^^^^^^^^
//                                   a 'PathBuf' is needed

// Running a script file also works in a similar manner
engine.run_file("hello_world.rhai".into())?;</code></pre>
<div id="admonition-tip-unix-shebangs" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-unix-shebangs-title">
<div class="admonition-title">
<div id="admonition-tip-unix-shebangs-title">
<p>Tip: Unix shebangs</p>
</div>
<a class="admonition-anchor-link" href="engine/hello-world.html#admonition-tip-unix-shebangs"></a>
</div>
<div>
<p>On Unix-like systems, the <em>shebang</em> (<code>#!</code>) is used at the very beginning of a script file to mark a
script with an interpreter (for Rhai this would be <a href="engine//book/start/bin.html"><code>rhai-run</code></a>).</p>
<p>If a script file starts with <code>#!</code>, the entire first line is skipped by <code>Engine::compile_file</code> and
<code>Engine::eval_file</code>. Because of this, Rhai scripts with shebangs at the beginning need no special processing.</p>
<p>This behavior is also present for non-Unix (e.g. Windows) environments so scripts are portable.</p>
<pre><code class="language-js">#!/home/to/me/bin/rhai-run

// This is a Rhai script

let answer = 42;
print(`The answer is: ${answer}`);
</code></pre>
</div>
</div>
<h2 id="specify-the-return-type"><a class="header" href="#specify-the-return-type">Specify the Return Type</a></h2>
<div id="admonition-tip-dynamic" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-dynamic-title">
<div class="admonition-title">
<div id="admonition-tip-dynamic-title">
<p>Tip: <code>Dynamic</code></p>
</div>
<a class="admonition-anchor-link" href="engine/hello-world.html#admonition-tip-dynamic"></a>
</div>
<div>
<p>Use <a href="engine//book/language/dynamic.html"><code>Dynamic</code></a> if you’re uncertain of the return type.</p>
</div>
</div>
<p>The type parameter for <code>Engine::eval</code> is used to specify the type of the return value, which <em>must</em>
match the actual type or an error is returned. Rhai is very strict here.</p>
<p>There are two ways to specify the return type: <em>turbofish</em> notation, or type inference.</p>
<h3 id="turbofish"><a class="header" href="#turbofish">Turbofish</a></h3>
<pre><code class="language-rust">let result = engine.eval::&lt;i64&gt;("40 + 2")?;     // return type is i64

result.is::&lt;i64&gt;() == true;

let result = engine.eval::&lt;Dynamic&gt;("boo()")?;  // use 'Dynamic' if you're not sure what type it'll be!

let result = engine.eval::&lt;String&gt;("40 + 2")?;  // returns an error because the actual return type is i64, not String</code></pre>
<h3 id="type-inference"><a class="header" href="#type-inference">Type inference</a></h3>
<pre><code class="language-rust">let result: i64 = engine.eval("40 + 2")?;       // return type is inferred to be i64

result.is::&lt;i64&gt;() == true;

let result: Dynamic = engine.eval("boo()")?;    // use 'Dynamic' if you're not sure what type it'll be!

let result: String = engine.eval("40 + 2")?;    // returns an error because the actual return type is i64, not String</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="compile-a-script-to-ast"><a class="header" href="#compile-a-script-to-ast">Compile a Script (to AST)</a></h1>
<p>To repeatedly evaluate a script, <em>compile</em> it first with <code>Engine::compile</code> into an <code>AST</code>
(<strong>A</strong>bstract <strong>S</strong>yntax <strong>T</strong>ree) form.</p>
<p><code>Engine::eval_ast_XXX</code> and <code>Engine::run_ast_XXX</code> evaluate a pre-compiled <code>AST</code>.</p>
<pre><code class="language-rust">// Compile to an AST and store it for later evaluations
let ast = engine.compile("40 + 2")?;

for _ in 0..42 {
    let result: i64 = engine.eval_ast(&amp;ast)?;

    println!("Answer #{i}: {result}");      // prints 42
}</code></pre>
<div id="admonition-tip-compile-script-file" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-compile-script-file-title">
<div class="admonition-title">
<div id="admonition-tip-compile-script-file-title">
<p>Tip: Compile script file</p>
</div>
<a class="admonition-anchor-link" href="engine/compile.html#admonition-tip-compile-script-file"></a>
</div>
<div>
<p>Compiling script files is also supported via <code>Engine::compile_file</code>
(not available for <a href="engine//book/start/features.html"><code>no_std</code></a> or <a href="engine//book/start/builds/wasm.html">WASM</a> builds).</p>
<pre><code class="language-rust">let ast = engine.compile_file("hello_world.rhai".into())?;</code></pre>
</div>
</div>
<div id="admonition-see-also-ast-manipulation-api" class="admonition admonish-info small" role="note" aria-labelledby="admonition-see-also-ast-manipulation-api-title">
<div class="admonition-title">
<div id="admonition-see-also-ast-manipulation-api-title">
<p>See also: <code>AST</code> manipulation API</p>
</div>
<a class="admonition-anchor-link" href="engine/compile.html#admonition-see-also-ast-manipulation-api"></a>
</div>
<div>
<p>Advanced users who may want to manipulate an <code>AST</code>, especially the functions contained within,
should see the section on <a href="engine/ast.html"><em>Manage AST’s</em></a> for more details.</p>
</div>
</div>
<h2 id="practical-use--header-template-scripts"><a class="header" href="#practical-use--header-template-scripts">Practical Use – Header Template Scripts</a></h2>
<p>Sometimes it is desirable to include a standardized <em>header template</em> in a script that contains
pre-defined <a href="engine//book/language/functions.html">functions</a>, <a href="engine//book/language/constants.html">constants</a> and <a href="engine//book/language/modules/import.html">imported</a> <a href="engine//book/rust/modules/index.html">modules</a>.</p>
<pre><code class="language-rust">// START OF THE HEADER TEMPLATE
// The following should run before every script...

import "hello" as h;
import "world" as w;

// Standard constants

const GLOBAL_CONSTANT = 42;
const SCALE_FACTOR = 1.2;

// Standard functions

fn foo(x, y) { ... }

fn bar() { ... }

fn baz() { ... }

// END OF THE HEADER TEMPLATE

// Everything below changes from run to run

foo(bar() + GLOBAL_CONSTANT, baz() * SCALE_FACTOR)</code></pre>
<h3 id="option-1--the-easy-way"><a class="header" href="#option-1--the-easy-way">Option 1 – The easy way</a></h3>
<p>Prepend the script header template onto independent scripts and run them as a whole.</p>
<blockquote>
<p><strong>Pros:</strong> Easy!</p>
<p><strong>Cons:</strong> If the header template is long, work is duplicated every time to parse it.</p>
</blockquote>
<pre><code class="language-rust">let header_template = "..... // scripts... .....";

for index in 0..10000 {
    let user_script = db.get_script(index);

    // Just merge the two scripts...
    let combined_script = format!("{header_template}\n{user_script}\n");

    // Run away!
    let result = engine.eval::&lt;i64&gt;(combined_script)?;
    
    println!("{result}");
}</code></pre>
<h3 id="option-2--the-hard-way"><a class="header" href="#option-2--the-hard-way">Option 2 – The hard way</a></h3>
<p>Option 1 requires the script header template to be recompiled every time.  This can be expensive if
the header is very long.</p>
<p>This option compiles both the script header template and independent scripts as separate <code>AST</code>’s
which are then joined together to form a combined <code>AST</code>.</p>
<blockquote>
<p><strong>Pros:</strong> No need to recompile the header template!</p>
<p><strong>Cons:</strong> More work…</p>
</blockquote>
<pre><code class="language-rust">let header_template = "..... // scripts... .....";

let mut template_ast = engine.compile(header_template)?;

// If you don't want to run the template, only keep the functions
// defined inside (e.g. closures), clear out the statements.
template_ast.clear_statements();

for index in 0..10000 {
    let user_script = db.get_script(index);

    let user_ast = engine.compile(user_script)?;

    // Merge the two AST's
    let combined_ast = template_ast + user_ast;

    // Run away!
    let result = engine.eval_ast::&lt;i64&gt;(combined_ast)?;
    
    println!("{result}");</code></pre>
<h3 id="option-3--the-not-so-hard-way"><a class="header" href="#option-3--the-not-so-hard-way">Option 3 – The not-so-hard way</a></h3>
<p>Option 1 does repeated work, option 2 requires manipulating <code>AST</code>’s…</p>
<p>This option makes the scripted <a href="engine//book/language/functions.html">functions</a> (not <a href="engine//book/language/modules/import.html">imported</a> <a href="engine//book/rust/modules/index.html">modules</a> nor <a href="engine//book/language/constants.html">constants</a>
however) available globally by first making it a <a href="engine//book/rust/modules/index.html">module</a> (via <a href="engine/modules/ast.html"><code>Module::eval_ast_as_new</code></a>)
and then loading it into the <a href="engine//book/engine/hello-world.html"><code>Engine</code></a> via <code>Engine::register_global_module</code>.</p>
<blockquote>
<p><strong>Pros:</strong> No need to recompile the header template!</p>
<p><strong>Cons:</strong> No <a href="engine//book/language/modules/import.html">imported</a> <a href="engine//book/rust/modules/index.html">modules</a> nor <a href="engine//book/language/constants.html">constants</a>; if the header template is changed, a new <a href="engine//book/engine/hello-world.html"><code>Engine</code></a> must be created.</p>
</blockquote>
<pre><code class="language-rust">let header_template = "..... // scripts... .....";

let template_ast = engine.compile(header_template)?;

let template_module = Module::eval_ast_as_new(Scope::new(), &amp;template_ast, &amp;engine)?;

engine.register_global_module(template_module.into());

for index in 0..10000 {
    let user_script = db.get_script(index);

    // Run away!
    let result = engine.eval::&lt;i64&gt;(user_script)?;
    
    println!("{result}");
}</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="raw-engine"><a class="header" href="#raw-engine">Raw <code>Engine</code></a></h1>
<p><code>Engine::new</code> creates a scripting <a href="engine//book/engine/hello-world.html"><code>Engine</code></a> with common functionalities (e.g. printing to <code>stdout</code>
via <a href="engine//book/language/print-debug.html"><code>print</code></a> or <a href="engine//book/language/print-debug.html"><code>debug</code></a>).</p>
<p>In many controlled embedded environments, however, these may not be needed and unnecessarily occupy
application code storage space.</p>
<div id="admonition-built-in-operators" class="admonition admonish-info side wide" role="note" aria-labelledby="admonition-built-in-operators-title">
<div class="admonition-title">
<div id="admonition-built-in-operators-title">
<p>Built-in operators</p>
</div>
<a class="admonition-anchor-link" href="engine/raw.html#admonition-built-in-operators"></a>
</div>
<div>
<p>Even with a raw <a href="engine//book/engine/hello-world.html"><code>Engine</code></a>, some operators are built-in and always available.</p>
<p>See <a href="engine//book/engine/builtin.html"><em>Built-in Operators</em></a> for a full list.</p>
</div>
</div>
<p>Use <code>Engine::new_raw</code> to create a <em>raw</em> <a href="engine//book/engine/hello-world.html"><code>Engine</code></a>, in which only a minimal set of
<a href="engine//book/engine/builtin.html">built-in</a> basic arithmetic and logical operators are supported.</p>
<p>To add more functionalities to a <em>raw</em> <a href="engine//book/engine/hello-world.html"><code>Engine</code></a>, load <a href="engine//book/rust/packages/index.html">packages</a> into it.</p>
<p>Since <a href="engine//book/rust/packages/index.html">packages</a> can be <em>shared</em>, this is an extremely efficient way to create multiple instances of
the same <a href="engine//book/engine/hello-world.html"><code>Engine</code></a> with the same set of functions.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th style="text-align: center"><code>Engine::new</code></th><th style="text-align: center"><code>Engine::new_raw</code></th></tr></thead><tbody>
<tr><td><a href="engine//book/engine/builtin.html">Built-in operators</a></td><td style="text-align: center">yes</td><td style="text-align: center">yes</td></tr>
<tr><td><a href="engine//book/rust/packages/index.html">Package</a> loaded</td><td style="text-align: center"><code>StandardPackage</code></td><td style="text-align: center"><em>none</em></td></tr>
<tr><td><a href="engine//book/rust/modules/resolvers/index.html">Module resolver</a></td><td style="text-align: center"><code>FileModuleResolver</code></td><td style="text-align: center"><em>none</em></td></tr>
<tr><td><a href="engine//book/rust/strings-interner.html">Strings interner</a></td><td style="text-align: center">yes</td><td style="text-align: center"><em>no</em></td></tr>
<tr><td><a href="engine//book/language/print-debug.html"><code>on_print</code></a></td><td style="text-align: center">yes</td><td style="text-align: center"><em>none</em></td></tr>
<tr><td><a href="engine//book/language/print-debug.html"><code>on_debug</code></a></td><td style="text-align: center">yes</td><td style="text-align: center"><em>none</em></td></tr>
</tbody></table>
</div><div id="admonition-warning-no-strings-interner" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-warning-no-strings-interner-title">
<div class="admonition-title">
<div id="admonition-warning-no-strings-interner-title">
<p>Warning: No strings interner</p>
</div>
<a class="admonition-anchor-link" href="engine/raw.html#admonition-warning-no-strings-interner"></a>
</div>
<div>
<p>A <em>raw</em> <a href="engine//book/engine/hello-world.html"><code>Engine</code></a> disables the <em><a href="engine//book/rust/strings-interner.html">strings interner</a></em> by default.</p>
<p>This may lead to a significant increase in memory usage if many strings are created in scripts.</p>
<p>Turn the <em><a href="engine//book/rust/strings-interner.html">strings interner</a></em> back on via <a href="engine//book/engine/options.html"><code>Engine::set_max_strings_interned</code></a>.</p>
</div>
</div>
<div id="admonition-enginenew-is-equivalent-to" class="admonition admonish-example" role="note" aria-labelledby="admonition-enginenew-is-equivalent-to-title">
<div class="admonition-title">
<div id="admonition-enginenew-is-equivalent-to-title">
<p><code>Engine::new</code> is equivalent to…</p>
</div>
<a class="admonition-anchor-link" href="engine/raw.html#admonition-enginenew-is-equivalent-to"></a>
</div>
<div>
<pre><code class="language-rust">use rhai::module_resolvers::FileModuleResolver;
use rhai::packages::StandardPackage;

// Create a raw scripting Engine
let mut engine = Engine::new_raw();

// Use the file-based module resolver
engine.set_module_resolver(FileModuleResolver::new());

// Enable the strings interner
engine.set_max_strings_interned(1024);

// Default print/debug implementations
engine.on_print(|text| println!("{text}"));

engine.on_debug(|text, source, pos| match (source, pos) {
    (Some(source), Position::NONE) =&gt; println!("{source} | {text}"),
    (Some(source), pos) =&gt; println!("{source} @ {pos:?} | {text}"),
    (None, Position::NONE) =&gt; println!("{text}"),
    (None, pos) =&gt; println!("{pos:?} | {text}"),
});

// Register the Standard Package
let package = StandardPackage::new();

// Load the package into the [`Engine`]
package.register_into_engine(&amp;mut engine);</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="built-in-operators"><a class="header" href="#built-in-operators">Built-in Operators</a></h1>
<p>The following operators are built-in, meaning that they are always available, even when using a <a href="engine//book/engine/raw.html">raw <code>Engine</code></a>.</p>
<p>All built-in operators are binary, and are supported for both operands of the same type.</p>
<div class="table-wrapper"><table><thead><tr><th>Operators</th><th>Assignment operators</th><th>Supported types<br/>(see <a href="engine//book/language/values-and-types.html">standard types</a>)</th></tr></thead><tbody>
<tr><td><code>+</code>,</td><td><code>+=</code></td><td><ul><li><code>INT</code></li><li><code>FLOAT</code> (if not <a href="engine//book/start/features.html"><code>no_float</code></a>)</li><li><a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a> (requires <a href="engine//book/start/features.html"><code>decimal</code></a>)</li><li><code>char</code></li><li><a href="engine//book/language/strings-chars.html">string</a></li></ul></td></tr>
<tr><td><code>-</code>, <code>*</code>, <code>/</code>, <code>%</code>, <code>**</code>,</td><td><code>-=</code>, <code>*=</code>, <code>/=</code>, <code>%=</code>, <code>**=</code></td><td><ul><li><code>INT</code></li><li><code>FLOAT</code> (if not <a href="engine//book/start/features.html"><code>no_float</code></a>)</li><li><a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a> (requires <a href="engine//book/start/features.html"><code>decimal</code></a>)</li></ul></td></tr>
<tr><td><code>&lt;&lt;</code>, <code>&gt;&gt;</code></td><td><code>&lt;&lt;=</code>, <code>&gt;&gt;=</code></td><td><ul><li><code>INT</code></li></ul></td></tr>
<tr><td><code>&amp;</code>, <code>|</code>, <code>^</code></td><td><code>&amp;=</code>, <code>|=</code>, <code>^=</code></td><td><ul><li><code>INT</code> (bit-wise)</li><li><code>bool</code> (non-short-circuiting)</li></ul></td></tr>
<tr><td><code>&amp;&amp;</code>, <code>||</code></td><td></td><td><ul><li><code>bool</code> (short-circuits)</li></ul></td></tr>
<tr><td><code>==</code>, <code>!=</code></td><td></td><td><ul><li><code>INT</code></li><li><code>FLOAT</code> (if not <a href="engine//book/start/features.html"><code>no_float</code></a>)</li><li><a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a> (requires <a href="engine//book/start/features.html"><code>decimal</code></a>)</li><li><code>bool</code></li><li><code>char</code></li><li><a href="engine//book/language/strings-chars.html">string</a></li><li><a href="engine//book/language/blobs.html">BLOB</a></li><li>numeric <a href="engine//book/language/ranges.html">range</a></li><li><code>()</code></li></ul></td></tr>
<tr><td><code>&gt;</code>, <code>&gt;=</code>, <code>&lt;</code>, <code>&lt;=</code></td><td></td><td><ul><li><code>INT</code></li><li><code>FLOAT</code> (if not <a href="engine//book/start/features.html"><code>no_float</code></a>)</li><li><a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a> (requires <a href="engine//book/start/features.html"><code>decimal</code></a>)</li><li><code>char</code></li><li><a href="engine//book/language/strings-chars.html">string</a></li><li><code>()</code></li></ul></td></tr>
</tbody></table>
</div><div id="admonition-tip" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="engine/builtin.html#admonition-tip"></a>
</div>
<div>
<p><code>FLOAT</code> and <a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a> also inter-operate with <code>INT</code>, while <a href="engine//book/language/strings-chars.html">strings</a> inter-operate
with <a href="engine//book/language/strings-chars.html">characters</a> for certain operators (e.g. <code>+</code>).</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="scope--maintaining-state"><a class="header" href="#scope--maintaining-state"><code>Scope</code> – Maintaining State</a></h1>
<p>By default, Rhai treats each <a href="engine//book/engine/hello-world.html"><code>Engine</code></a> invocation as a fresh one, persisting only the functions
that have been registered but no global state.</p>
<p>This gives each evaluation a clean starting slate.</p>
<p>In order to continue using the same global state from one invocation to the next, such a state
(a <code>Scope</code>) must be manually created and passed in.</p>
<p>All <code>Scope</code> <a href="engine//book/language/variables.html">variables</a> and <a href="engine//book/language/constants.html">constants</a> have values that are <a href="engine//book/language/dynamic.html"><code>Dynamic</code></a>, meaning they can store
values of any type.</p>
<p>Under <a href="engine//book/start/features.html"><code>sync</code></a>, however, only types that are <code>Send + Sync</code> are supported, and the entire <code>Scope</code>
itself will also be <code>Send + Sync</code>. This is extremely useful in multi-threaded applications.</p>
<div id="admonition-shadowing" class="admonition admonish-info small" role="note" aria-labelledby="admonition-shadowing-title">
<div class="admonition-title">
<div id="admonition-shadowing-title">
<p>Shadowing</p>
</div>
<a class="admonition-anchor-link" href="engine/scope.html#admonition-shadowing"></a>
</div>
<div>
<p>A newly-added <a href="engine//book/language/variables.html">variable</a> or <a href="engine//book/language/constants.html">constant</a> <em><a href="engine//book/language/shadow.html">shadows</a></em> previous ones of the same name.</p>
<p>In other words, all versions are kept for <a href="engine//book/language/variables.html">variables</a> and <a href="engine//book/language/constants.html">constants</a>, but only the latest ones can
be accessed via <code>get_value&lt;T&gt;</code>, <code>get_mut&lt;T&gt;</code> and <code>set_value&lt;T&gt;</code>.</p>
<p>Essentially, a <code>Scope</code> is always searched in <em>reverse order</em>.</p>
</div>
</div>
<div id="admonition-tip-the-lifetime-parameter" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-the-lifetime-parameter-title">
<div class="admonition-title">
<div id="admonition-tip-the-lifetime-parameter-title">
<p>Tip: The lifetime parameter</p>
</div>
<a class="admonition-anchor-link" href="engine/scope.html#admonition-tip-the-lifetime-parameter"></a>
</div>
<div>
<p><code>Scope</code> has a <em>lifetime</em> parameter, in the vast majority of cases it can be omitted and
automatically inferred to be <code>'static</code>.</p>
<p>Currently, that lifetime parameter is not used.  It is there to maintain backwards compatibility
as well as for possible future expansion when references can also be put into the <code>Scope</code>.</p>
<p>The lifetime parameter is not guaranteed to remain unused for future versions.</p>
<p>In order to put a <code>Scope</code> into a <code>struct</code>, use <code>Scope&lt;'static&gt;</code>.</p>
</div>
</div>
<div id="admonition-tip-the-const-generic-parameter" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-the-const-generic-parameter-title">
<div class="admonition-title">
<div id="admonition-tip-the-const-generic-parameter-title">
<p>Tip: The <code>const</code> generic parameter</p>
</div>
<a class="admonition-anchor-link" href="engine/scope.html#admonition-tip-the-const-generic-parameter"></a>
</div>
<div>
<p><code>Scope</code> also has a <em><code>const</code> generic</em> parameter, which is a number that defaults to 8.
It indicates the number of entries that the <code>Scope</code> can keep <em>inline</em> without allocations.</p>
<p>The larger this number, the larger the <code>Scope</code> type gets, but allocations will happen far
less frequently.</p>
<p>A smaller number makes <code>Scope</code> smaller, but allocation costs will be incurred when the
number of entries exceed the <em>inline</em> capacity.</p>
</div>
</div>
<h2 id="scope-api"><a class="header" href="#scope-api"><code>Scope</code> API</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody>
<tr><td><code>new</code> <em>instance method</em></td><td>create a new empty <code>Scope</code></td></tr>
<tr><td><code>with_capacity</code> <em>instance method</em></td><td>create a new empty <code>Scope</code> with a specified initial capacity</td></tr>
<tr><td><code>len</code></td><td>number of <a href="engine//book/language/variables.html">variables</a>/<a href="engine//book/language/constants.html">constants</a> currently within the <code>Scope</code></td></tr>
<tr><td><code>rewind</code></td><td><em>rewind</em> (i.e. reset) the <code>Scope</code> to a particular number of <a href="engine//book/language/variables.html">variables</a>/<a href="engine//book/language/constants.html">constants</a></td></tr>
<tr><td><code>clear</code></td><td>remove all <a href="engine//book/language/variables.html">variables</a>/<a href="engine//book/language/constants.html">constants</a> from the <code>Scope</code>, making it empty</td></tr>
<tr><td><code>is_empty</code></td><td>is the <code>Scope</code> empty?</td></tr>
<tr><td><code>is_constant</code></td><td>is the particular <a href="engine//book/language/variables.html">variable</a>/<a href="engine//book/language/constants.html">constant</a>  in the <code>Scope</code> a <a href="engine//book/language/constants.html">constant</a>?</td></tr>
<tr><td><code>push</code>, <code>push_constant</code></td><td>add a new <a href="engine//book/language/variables.html">variable</a>/<a href="engine//book/language/constants.html">constant</a> into the <code>Scope</code> with a specified value</td></tr>
<tr><td><code>push_dynamic</code>, <code>push_constant_dynamic</code></td><td>add a new <a href="engine//book/language/variables.html">variable</a>/<a href="engine//book/language/constants.html">constant</a> into the <code>Scope</code> with a <a href="engine//book/language/dynamic.html"><code>Dynamic</code></a> value</td></tr>
<tr><td><code>set_or_push&lt;T&gt;</code></td><td>set the value of the last <a href="engine//book/language/variables.html">variable</a> within the <code>Scope</code> by name if it exists and is not <a href="engine//book/language/constants.html">constant</a>; add a new <a href="engine//book/language/variables.html">variable</a> into the <code>Scope</code> otherwise</td></tr>
<tr><td><code>contains</code></td><td>does the particular <a href="engine//book/language/variables.html">variable</a> or <a href="engine//book/language/constants.html">constant</a> exist in the <code>Scope</code>?</td></tr>
<tr><td><code>get_value&lt;T&gt;</code></td><td>get the value of the last <a href="engine//book/language/variables.html">variable</a>/<a href="engine//book/language/constants.html">constant</a> within the <code>Scope</code> by name</td></tr>
<tr><td><code>set_value&lt;T&gt;</code></td><td>set the value of the last <a href="engine//book/language/variables.html">variable</a> within the <code>Scope</code> by name, panics if it is <a href="engine//book/language/constants.html">constant</a></td></tr>
<tr><td><code>remove&lt;T&gt;</code></td><td>remove the last <a href="engine//book/language/variables.html">variable</a>/<a href="engine//book/language/constants.html">constant</a> from the <code>Scope</code> by name, returning its value</td></tr>
<tr><td><code>get</code></td><td>get a reference to the value of the last <a href="engine//book/language/variables.html">variable</a>/<a href="engine//book/language/constants.html">constant</a> within the <code>Scope</code> by name</td></tr>
<tr><td><code>get_mut</code></td><td>get a reference to the value of the last <a href="engine//book/language/variables.html">variable</a> within the <code>Scope</code> by name, <code>None</code> if it is <a href="engine//book/language/constants.html">constant</a></td></tr>
<tr><td><code>set_alias</code></td><td><a href="engine//book/language/modules/export.html">exported</a> the last <a href="engine//book/language/variables.html">variable</a>/<a href="engine//book/language/constants.html">constant</a> within the <code>Scope</code> by name</td></tr>
<tr><td><code>iter</code>, <code>iter_raw</code>, <code>IntoIterator::into_iter</code></td><td>get an iterator to the <a href="engine//book/language/variables.html">variables</a>/<a href="engine//book/language/constants.html">constants</a> within the <code>Scope</code></td></tr>
<tr><td><code>Extend::extend</code></td><td>add <a href="engine//book/language/variables.html">variables</a>/<a href="engine//book/language/constants.html">constants</a> to the <code>Scope</code></td></tr>
</tbody></table>
</div><div id="admonition-scope-public-api" class="admonition admonish-info small" role="note" aria-labelledby="admonition-scope-public-api-title">
<div class="admonition-title">
<div id="admonition-scope-public-api-title">
<p><code>Scope</code> public API</p>
</div>
<a class="admonition-anchor-link" href="engine/scope.html#admonition-scope-public-api"></a>
</div>
<div>
<p>For details on the <code>Scope</code> API, refer to the
<a href="https://docs.rs/rhai/1.22.0/rhai/struct.Scope.html">documentation</a> online.</p>
</div>
</div>
<h2 id="serializingdeserializing"><a class="header" href="#serializingdeserializing">Serializing/Deserializing</a></h2>
<p>With the <a href="engine//book/rust/serde.html"><code>serde</code></a> feature, <code>Scope</code> is serializable and deserializable via
<a href="https://crates.io/crates/serde"><code>serde</code></a>.</p>
<p><a href="engine//book/rust/custom-types.html">Custom types</a> stored in the <code>Scope</code>, however, are serialized as full type-name strings.
Data in <a href="engine//book/rust/custom-types.html">custom types</a> are not serialized.</p>
<h2 id="example-4"><a class="header" href="#example-4">Example</a></h2>
<p>In the following example, a <code>Scope</code> is created with a few initialized variables, then it is threaded
through multiple evaluations.</p>
<pre><code class="language-rust">use rhai::{Engine, Scope, EvalAltResult};

let engine = Engine::new();

// First create the state
let mut scope = Scope::new();

// Then push (i.e. add) some initialized variables into the state.
// Remember the system number types in Rhai are i64 (i32 if 'only_i32')
// and f64 (f32 if 'f32_float').
// Better stick to them or it gets hard working with the script.
scope.push("y", 42_i64)
     .push("z", 999_i64)
     .push_constant("MY_NUMBER", 123_i64)       // constants can also be added
     .set_value("s", "hello, world!");          // 'set_value' adds a new variable when one doesn't exist

// First invocation
engine.run_with_scope(&amp;mut scope, 
"
    let x = 4 + 5 - y + z + MY_NUMBER + s.len;
    y = 1;
")?;

// Second invocation using the same state.
// Notice that the new variable 'x', defined previously, is still here.
let result = engine.eval_with_scope::&lt;i64&gt;(&amp;mut scope, "x + y")?;

println!("result: {result}");                   // prints 1103

// Variable y is changed in the script - read it with 'get_value'
assert_eq!(scope.get_value::&lt;i64&gt;("y").expect("variable y should exist"), 1);

// We can modify scope variables directly with 'set_value'
scope.set_value("y", 42_i64);
assert_eq!(scope.get_value::&lt;i64&gt;("y").expect("variable y should exist"), 42);</code></pre>
<h2 id="engine-api-using-scope"><a class="header" href="#engine-api-using-scope"><code>Engine</code> API Using <code>Scope</code></a></h2>
<p><a href="engine//book/engine/hello-world.html"><code>Engine</code></a> API methods that accept a <code>Scope</code> parameter all end in <code>_with_scope</code>, making that
<code>Scope</code> (and everything inside it) available to the script:</p>
<div class="table-wrapper"><table><thead><tr><th><code>Engine</code> API</th><th style="text-align: center">Not available under</th></tr></thead><tbody>
<tr><td><code>Engine::eval_with_scope</code></td><td style="text-align: center"></td></tr>
<tr><td><code>Engine::eval_ast_with_scope</code></td><td style="text-align: center"></td></tr>
<tr><td><code>Engine::eval_file_with_scope</code></td><td style="text-align: center"><a href="engine//book/start/features.html"><code>no_std</code></a></td></tr>
<tr><td><code>Engine::eval_expression_with_scope</code></td><td style="text-align: center"></td></tr>
<tr><td><code>Engine::run_with_scope</code></td><td style="text-align: center"></td></tr>
<tr><td><code>Engine::run_ast_with_scope</code></td><td style="text-align: center"></td></tr>
<tr><td><code>Engine::run_file_with_scope</code></td><td style="text-align: center"><a href="engine//book/start/features.html"><code>no_std</code></a></td></tr>
<tr><td><code>Engine::compile_file_with_scope</code></td><td style="text-align: center"><a href="engine//book/start/features.html"><code>no_std</code></a></td></tr>
<tr><td><code>Engine::compile_expression_with_scope</code></td><td style="text-align: center"></td></tr>
</tbody></table>
</div><div id="admonition-dont-forget-to-rewind" class="admonition admonish-danger" role="note" aria-labelledby="admonition-dont-forget-to-rewind-title">
<div class="admonition-title">
<div id="admonition-dont-forget-to-rewind-title">
<p>Don’t forget to <code>rewind</code></p>
</div>
<a class="admonition-anchor-link" href="engine/scope.html#admonition-dont-forget-to-rewind"></a>
</div>
<div>
<p><a href="engine//book/language/variables.html">Variables</a> or <a href="engine//book/language/constants.html">constants</a> defined at the global level of a script persist inside the custom <code>Scope</code>
even after the script ends.</p>
<pre><code class="language-rust">let mut scope = Scope::new();

engine.run_with_scope(&amp;mut scope, "let x = 42;")?;

// Variable 'x' stays inside the custom scope!
engine.run_with_scope(&amp;mut scope, "print(x);")?;    //  prints 42</code></pre>
<p>Due to <a href="engine//book/language/shadow.html">variable shadowing</a>, new <a href="engine//book/language/variables.html">variables</a>/<a href="engine//book/language/constants.html">constants</a> are simply added on top of
existing ones (even when they already exist), so care must be taken that new <a href="engine//book/language/variables.html">variables</a>/<a href="engine//book/language/constants.html">constants</a>
inside the custom <code>Scope</code> do not grow without bounds.</p>
<pre><code class="language-rust">let mut scope = Scope::new();

// Don't do this - this creates 1 million variables named 'x'
//                 inside 'scope'!!!
for _ in 0..1_000_000 {
    engine.run_with_scope(&amp;mut scope, "let x = 42;")?;
}

// The 'scope' contains a LOT of variables...
assert_eq!(scope.len(), 1_000_000);

// Variable 'x' stays inside the custom scope!
engine.run_with_scope(&amp;mut scope, "print(x);")?;    //  prints 42</code></pre>
<p>In order to remove <a href="engine//book/language/variables.html">variables</a> or <a href="engine//book/language/constants.html">constants</a> introduced by a script, use the <code>rewind</code> method.</p>
<pre><code class="language-rust">// Run a million times
for _ in 0..1_000_000 {
    // Save the current size of the 'scope'
    let orig_scope_size = scope.len();

    engine.run_with_scope(&amp;mut scope, "let x = 42;")?;

    // Rewind the 'scope' to the original size
    scope.rewind(orig_scope_size);
}

// The 'scope' is empty
assert_eq!(scope.len(), 0);

// Variable 'x' is no longer inside 'scope'!
engine.run_with_scope(&amp;mut scope, "print(x);")?;    //  error: variable 'x' not found</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="evaluate-expressions-only"><a class="header" href="#evaluate-expressions-only">Evaluate Expressions Only</a></h1>
<div id="admonition-tip-dynamic" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-dynamic-title">
<div class="admonition-title">
<div id="admonition-tip-dynamic-title">
<p>Tip: <code>Dynamic</code></p>
</div>
<a class="admonition-anchor-link" href="engine/expressions.html#admonition-tip-dynamic"></a>
</div>
<div>
<p>Use <a href="engine//book/language/dynamic.html"><code>Dynamic</code></a> if you’re uncertain of the return type.</p>
</div>
</div>
<p>Very often, a use case does not require a full-blown scripting <em>language</em>, but only needs to
evaluate <em>expressions</em>.</p>
<p>In these cases, use the <code>Engine::compile_expression</code> and <code>Engine::eval_expression</code> methods or their
<code>_with_scope</code> variants.</p>
<pre><code class="language-rust">let result: i64 = engine.eval_expression("2 + (10 + 10) * 2")?;

let result: Dynamic = engine.eval_expression("get_value(42)")?;

// Usually this is done together with a custom scope with variables...

let mut scope = Scope::new();

scope.push("x", 42_i64);
scope.push_constant("SCALE", 10_i64);

let result: i64 = engine.eval_expression_with_scope(&amp;mut scope,
                        "(x + 1) * SCALE"
                  )?;</code></pre>
<div id="admonition-no-statements-allowed" class="admonition admonish-bug" role="note" aria-labelledby="admonition-no-statements-allowed-title">
<div class="admonition-title">
<div id="admonition-no-statements-allowed-title">
<p>No statements allowed</p>
</div>
<a class="admonition-anchor-link" href="engine/expressions.html#admonition-no-statements-allowed"></a>
</div>
<div>
<p>When evaluating <em>expressions</em>, no full-blown statement (e.g. <a href="engine//book/language/while.html"><code>while</code></a>, <a href="engine//book/language/for.html"><code>for</code></a>, <code>fn</code>) –
not even <a href="engine//book/language/variables.html">variable</a> assignment – is supported and will be considered syntax errors.</p>
<p>This is true also for <a href="engine//book/language/statement-expression.html">statement expressions</a>
and <a href="engine//book/language/fn-closure.html">closures</a>.</p>
<pre><code class="language-rust">// The following are all syntax errors because the script
// is not a strict expression.

engine.eval_expression::&lt;()&gt;("x = 42")?;

let ast = engine.compile_expression("let x = 42")?;

let result = engine.eval_expression_with_scope::&lt;i64&gt;(&amp;mut scope,
                    "{ let y = calc(x); x + y }"
             )?;

let fp: FnPtr = engine.eval_expression("|x| x + 1")?;</code></pre>
</div>
</div>
<div id="admonition-tip-if-expressions-and-switch-expressions" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-if-expressions-and-switch-expressions-title">
<div class="admonition-title">
<div id="admonition-tip-if-expressions-and-switch-expressions-title">
<p>Tip: <code>if</code>-expressions and <code>switch</code>-expressions</p>
</div>
<a class="admonition-anchor-link" href="engine/expressions.html#admonition-tip-if-expressions-and-switch-expressions"></a>
</div>
<div>
<p><a href="engine//book/language/if.html#if-expression"><code>if</code> expressions</a> are allowed if both statement blocks
contain only a single expression each.</p>
<p><a href="engine//book/language/switch-expression.html"><code>switch</code> expressions</a> are allowed if all match
actions are expressions and not statements.</p>
<p>loop expressions are not allowed.</p>
<pre><code class="language-rust">// The following are allowed.

let result = engine.eval_expression_with_scope::&lt;i64&gt;(&amp;mut scope,
                    "if x { 42 } else { 123 }"
             )?;

let result = engine.eval_expression_with_scope::&lt;i64&gt;(&amp;mut scope, "
                    switch x {
                        0 =&gt; x * 42,
                        1..=9 =&gt; foo(123) + bar(1),
                        10 =&gt; 0,
                    }
             ")?;</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="engine-configuration-options"><a class="header" href="#engine-configuration-options">Engine Configuration Options</a></h1>
<p>A number of other configuration options are available from the <a href="engine//book/engine/hello-world.html"><code>Engine</code></a> to fine-tune behavior and safeguards.</p>
<h2 id="compile-time-language-features"><a class="header" href="#compile-time-language-features">Compile-Time Language Features</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th>Description</th><th style="text-align: center">Default</th></tr></thead><tbody>
<tr><td><code>set_optimization_level</code><br/>(not available under <a href="engine//book/start/features.html"><code>no_optimize</code></a>)</td><td>sets the amount of script <em>optimizations</em> performed (see <a href="engine//book/engine/optimize/index.html">script optimization</a>)</td><td style="text-align: center"><a href="engine//book/engine/optimize/index.html"><code>Simple</code></a></td></tr>
<tr><td><code>set_allow_if_expression</code></td><td>allows/disallows <a href="engine//book/language/if.html#if-expression"><code>if</code>-expressions</a></td><td style="text-align: center">allow</td></tr>
<tr><td><code>set_allow_switch_expression</code></td><td>allows/disallows <a href="engine//book/language/switch-expression.html"><code>switch</code> expressions</a></td><td style="text-align: center">allow</td></tr>
<tr><td><code>set_allow_loop_expressions</code></td><td>allows/disallows loop expressions</td><td style="text-align: center">allow</td></tr>
<tr><td><code>set_allow_statement_expression</code></td><td>allows/disallows <a href="engine//book/language/statement-expression.html">statement expressions</a></td><td style="text-align: center">allow</td></tr>
<tr><td><code>set_allow_anonymous_fn</code><br/>(not available under <a href="engine//book/start/features.html"><code>no_function</code></a>)</td><td>allows/disallows <a href="engine//book/language/fn-anon.html">anonymous functions</a></td><td style="text-align: center">allow</td></tr>
<tr><td><code>set_allow_looping</code></td><td>allows/disallows looping (i.e. <a href="engine//book/language/while.html"><code>while</code></a>, <a href="engine//book/language/loop.html"><code>loop</code></a>, <a href="engine//book/language/do.html"><code>do</code></a> and <a href="engine//book/language/for.html"><code>for</code></a> statements)</td><td style="text-align: center">allow</td></tr>
<tr><td><code>set_allow_shadowing</code></td><td>allows/disallows <em><a href="engine//book/language/shadow.html">shadowing</a></em> of <a href="engine//book/language/variables.html">variables</a></td><td style="text-align: center">allow</td></tr>
<tr><td><code>set_strict_variables</code></td><td>enables/disables <a href="engine//book/engine/strict-var.html"><em>Strict Variables</em> mode</a></td><td style="text-align: center">disabled</td></tr>
<tr><td><code>set_fast_operators</code></td><td>enables/disables <a href="engine//book/start/builds/performance.html#fast-operators-mode"><em>Fast Operators</em> mode</a></td><td style="text-align: center">enabled</td></tr>
<tr><td><code>disable_symbol</code></td><td>disables a certain <a href="engine//book/appendix/keywords.html">keyword</a> or <a href="engine//book/appendix/operators.html#operators">operator</a> (see <a href="engine//book/engine/disable-keywords.html">disable keywords and operators</a>)</td><td style="text-align: center"></td></tr>
</tbody></table>
</div>
<p>Beware that these options activate during <em>compile-time</em> only.  If an <a href="engine//book/engine/compile.html"><code>AST</code></a> is compiled on an
<a href="engine//book/engine/hello-world.html"><code>Engine</code></a> but then evaluated on a different <a href="engine//book/engine/hello-world.html"><code>Engine</code></a> with different configuration, disallowed
features contained inside the <a href="engine//book/engine/compile.html"><code>AST</code></a> will still run as normal.</p>
<h2 id="runtime-behavior"><a class="header" href="#runtime-behavior">Runtime Behavior</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody>
<tr><td><code>set_fail_on_invalid_map_property</code><br/>(not available under <a href="engine//book/start/features.html"><code>no_object</code></a>)</td><td>sets whether to raise errors (instead of returning <a href="engine//book/language/values-and-types.html"><code>()</code></a>) when invalid properties are accessed on <a href="engine//book/language/object-maps.html">object maps</a></td></tr>
<tr><td><code>set_default_tag</code></td><td>sets the default value of the <em>custom state</em> (which can be obtained via <a href="engine//book/rust/context.html"><code>NativeCallContext::tag</code></a>) for each evaluation run</td></tr>
</tbody></table>
</div>
<h2 id="safety-limits"><a class="header" href="#safety-limits">Safety Limits</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th style="text-align: center">Not available under</th><th>Description</th></tr></thead><tbody>
<tr><td><code>set_max_expr_depths</code></td><td style="text-align: center"><a href="engine//book/start/features.html"><code>unchecked</code></a></td><td>sets the maximum nesting levels of an expression/statement (see <a href="engine//book/safety/max-stmt-depth.html">maximum statement depth</a>)</td></tr>
<tr><td><code>set_max_call_levels</code></td><td style="text-align: center"><a href="engine//book/start/features.html"><code>unchecked</code></a>, <a href="engine//book/start/features.html"><code>no_function</code></a></td><td>sets the maximum number of function call levels (default 50) to avoid infinite recursion (see <a href="engine//book/safety/max-call-stack.html">maximum call stack depth</a>)</td></tr>
<tr><td><code>set_max_operations</code></td><td style="text-align: center"><a href="engine//book/start/features.html"><code>unchecked</code></a></td><td>sets the maximum number of <em>operations</em> that a script is allowed to consume (see <a href="engine//book/safety/max-operations.html">maximum number of operations</a>)</td></tr>
<tr><td><code>set_max_variables</code></td><td style="text-align: center"><a href="engine//book/start/features.html"><code>unchecked</code></a></td><td>sets the maximum number of <a href="engine//book/language/variables.html">variables</a> that a script is allowed to define within a single <a href="engine//book/engine/scope.html"><code>Scope</code></a> (see <a href="engine//book/safety/max-variables.html">maximum number of variables</a>)</td></tr>
<tr><td><code>set_max_functions</code></td><td style="text-align: center"><a href="engine//book/start/features.html"><code>unchecked</code></a>, <a href="engine//book/start/features.html"><code>no_function</code></a></td><td>sets the maximum number of <a href="engine//book/language/functions.html">functions</a> that a script is allowed to define (see <a href="engine//book/safety/max-functions.html">maximum number of functions</a>)</td></tr>
<tr><td><code>set_max_modules</code></td><td style="text-align: center"><a href="engine//book/start/features.html"><code>unchecked</code></a>, [<code>no_modules</code>]</td><td>sets the maximum number of <a href="engine//book/rust/modules/index.html">modules</a> that a script is allowed to load (see <a href="engine//book/safety/max-modules.html">maximum number of modules</a>)</td></tr>
<tr><td><code>set_max_string_size</code></td><td style="text-align: center"><a href="engine//book/start/features.html"><code>unchecked</code></a></td><td>sets the maximum length (in UTF-8 bytes) for <a href="engine//book/language/strings-chars.html">strings</a> (see <a href="engine//book/safety/max-string-size.html">maximum length of strings</a>)</td></tr>
<tr><td><code>set_max_array_size</code></td><td style="text-align: center"><a href="engine//book/start/features.html"><code>unchecked</code></a>, <a href="engine//book/start/features.html"><code>no_index</code></a></td><td>sets the maximum size for <a href="engine//book/language/arrays.html">arrays</a> (see <a href="engine//book/safety/max-array-size.html">maximum size of arrays</a>)</td></tr>
<tr><td><code>set_max_map_size</code></td><td style="text-align: center"><a href="engine//book/start/features.html"><code>unchecked</code></a>, <a href="engine//book/start/features.html"><code>no_object</code></a></td><td>sets the maximum number of properties for <a href="engine//book/language/object-maps.html">object maps</a> (see <a href="engine//book/safety/max-map-size.html">maximum size of object maps</a>)</td></tr>
<tr><td><code>set_max_strings_interned</code></td><td style="text-align: center"></td><td>sets the maximum number of <a href="engine//book/language/strings-chars.html">strings</a> to be interned (if zero, the <a href="engine//book/rust/strings-interner.html">strings interner</a> is disabled)</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="examples"><a class="header" href="#examples">Examples</a></h1>
<p>Rhai comes with a number of examples showing how to integrate the scripting <a href="start/examples//book/engine/hello-world.html"><code>Engine</code></a> within a Rust
application, as well as a number of sample scripts that showcase different Rhai language features.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rust-examples"><a class="header" href="#rust-examples">Rust Examples</a></h1>
<h2 id="standard-examples"><a class="header" href="#standard-examples">Standard Examples</a></h2>
<p>A number of examples can be found under <code>examples</code>.</p>
<div class="table-wrapper"><table><thead><tr><th>Example</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/examples/arrays_and_structs.rs"><code>arrays_and_structs</code></a></td><td>shows how to register a <a href="start/examples//book/rust/custom-types.html">Rust type</a> and using it with <a href="start/examples//book/language/arrays.html">arrays</a></td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/examples/callback.rs"><code>callback</code></a></td><td>shows how to store a Rhai <a href="start/examples//book/language/fn-closure.html">closure</a> and call it later within Rust</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/examples/custom_types_and_methods.rs"><code>custom_types_and_methods</code></a></td><td>shows how to register a <a href="start/examples//book/rust/custom-types.html">Rust type</a> and <a href="start/examples//book/rust/methods.html">methods</a>/<a href="start/examples//book/rust/getters-setters.html">getters/setters</a> for it</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/examples/custom_types.rs"><code>custom_types</code></a></td><td>shows how to register a <a href="start/examples//book/rust/custom-types.html">Rust type</a> and <a href="start/examples//book/rust/methods.html">methods</a>/<a href="start/examples//book/rust/getters-setters.html">getters/setters</a> using the <a href="start/examples//book/rust/build-type.html"><code>CustomType</code></a> trait.</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/examples/definitions"><code>definitions</code></a></td><td>shows how to generate definition files for use with the <a href="https://github.com/rhaiscript/lsp">Rhai Language Server</a> (requires the <a href="start/examples//book/start/features.html"><code>metadata</code></a> feature)</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/examples/hello.rs"><code>hello</code></a></td><td>simple example that evaluates an expression and prints the result</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/pause_and_resume.rs"><code>pause_and_resume</code></a></td><td>shows how to pause/resume/stop an <code>Engine</code> running in a separate thread via an MPSC channel</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/examples/reuse_scope.rs"><code>reuse_scope</code></a></td><td>evaluates two pieces of code in separate runs, but using a common <a href="start/examples//book/engine/scope.html"><code>Scope</code></a></td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/examples/serde.rs"><code>serde</code></a></td><td>example to serialize and deserialize Rust types with <a href="https://crates.io/crates/serde"><code>serde</code></a> (requires the <a href="start/examples//book/rust/serde.html"><code>serde</code></a> feature)</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/examples/simple_fn.rs"><code>simple_fn</code></a></td><td>shows how to register a simple Rust function</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/examples/strings.rs"><code>strings</code></a></td><td>shows different ways to register Rust functions taking <a href="start/examples//book/language/strings-chars.html">string</a> arguments</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/examples/threading.rs"><code>threading</code></a></td><td>shows how to communicate in duplex with an <a href="start/examples//book/engine/hello-world.html"><code>Engine</code></a> running in a separate thread via a pair of MPSC channels</td></tr>
</tbody></table>
</div>
<h2 id="scriptable-event-handler-with-state-examples"><a class="header" href="#scriptable-event-handler-with-state-examples">Scriptable Event Handler With State Examples</a></h2>
<p>Because of its popularity, the pattern <a href="start/examples//book/patterns/events.html"><em>Scriptable Event Handler With State</em></a>
has sample implementations for different styles.</p>
<div class="table-wrapper"><table><thead><tr><th>Example</th><th>Handler Script</th><th style="text-align: center">Description</th></tr></thead><tbody>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/examples/event_handler_main"><code>event_handler_main</code></a></td><td><a href="https://github.com/rhaiscript/rhai/blob/main/examples/event_handler_main/script.rhai"><code>event_handler_main/script.rhai</code></a></td><td style="text-align: center"><a href="start/examples//book/patterns/events-1.html"><em>Main Style</em></a></td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/examples/event_handler_js"><code>event_handler_js</code></a></td><td><a href="https://github.com/rhaiscript/rhai/blob/main/examples/event_handler_js/script.rhai"><code>event_handler_js/script.rhai</code></a></td><td style="text-align: center"><a href="start/examples//book/patterns/events-2.html"><em>JS Style</em></a></td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/examples/event_handler_map"><code>event_handler_map</code></a></td><td><a href="https://github.com/rhaiscript/rhai/blob/main/examples/event_handler_map/script.rhai"><code>event_handler_map/script.rhai</code></a></td><td style="text-align: center"><a href="start/examples//book/patterns/events-3.html"><em>Map Style</em></a></td></tr>
</tbody></table>
</div>
<h2 id="running-examples"><a class="header" href="#running-examples">Running Examples</a></h2>
<p>Examples can be run with the following command:</p>
<pre><code class="language-sh">cargo run --example {example_name}
</code></pre>
<h2 id="no-std-examples"><a class="header" href="#no-std-examples"><code>no-std</code> Examples</a></h2>
<p>To illustrate <code>no-std</code> builds, a number of example applications are available under the <code>no_std</code> directory:</p>
<div class="table-wrapper"><table><thead><tr><th>Example</th><th>Description</th><th style="text-align: center">Optimization</th><th style="text-align: center">Allocator</th><th style="text-align: center">Panics</th></tr></thead><tbody>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/no_std/no_std_test"><code>no_std_test</code></a></td><td>bare-bones test application that evaluates a Rhai expression and sets the result as the return value</td><td style="text-align: center">size</td><td style="text-align: center"><a href="https://crates.io/crates/wee_alloc"><code>wee_alloc</code></a></td><td style="text-align: center">abort</td></tr>
</tbody></table>
</div>
<h3 id="building-the-no-std-examples"><a class="header" href="#building-the-no-std-examples">Building the <code>no-std</code> examples</a></h3>
<div id="admonition-nightly-required" class="admonition admonish-warning" role="note" aria-labelledby="admonition-nightly-required-title">
<div class="admonition-title">
<div id="admonition-nightly-required-title">
<p>Nightly required</p>
</div>
<a class="admonition-anchor-link" href="start/examples/rust.html#admonition-nightly-required"></a>
</div>
<div>
<p>Currently, the nightly compiler must be used to build for <code>no-std</code>.</p>
</div>
</div>
<pre><code class="language-sh">cd no_std/no_std_test

cargo +nightly build --release

./target/release/no_std_test
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="example-scripts"><a class="header" href="#example-scripts">Example Scripts</a></h1>
<h2 id="language-feature-scripts"><a class="header" href="#language-feature-scripts">Language Feature Scripts</a></h2>
<p>There are also a number of examples scripts that showcase Rhai’s features, all in the <code>scripts</code> directory:</p>
<div class="table-wrapper"><table><thead><tr><th>Script</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/array.rhai"><code>array.rhai</code></a></td><td><a href="start/examples//book/language/arrays.html">arrays</a> example</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/assignment.rhai"><code>assignment.rhai</code></a></td><td><a href="start/examples//book/language/variables.html">variable</a> declarations</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/comments.rhai"><code>comments.rhai</code></a></td><td>just regular <a href="start/examples//book/language/comments.html">comments</a></td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/doc-comments.rhai"><code>doc-comments.rhai</code></a></td><td><a href="start/examples//book/language/doc-comments.html">doc-comments</a> example</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/for1.rhai"><code>for1.rhai</code></a></td><td><a href="start/examples//book/language/for.html"><code>for</code></a> loops</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/for2.rhai"><code>for2.rhai</code></a></td><td><a href="start/examples//book/language/for.html"><code>for</code></a> loops with <a href="start/examples//book/language/arrays.html">array</a> iterations</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/for3.rhai"><code>for3.rhai</code></a></td><td><a href="start/examples//book/language/for.html"><code>for</code></a> loops with <a href="start/examples//book/language/fn-closure.html">closures</a></td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/function_decl1.rhai"><code>function_decl1.rhai</code></a></td><td>a <a href="start/examples//book/language/functions.html">function</a> without parameters</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/function_decl2.rhai"><code>function_decl2.rhai</code></a></td><td>a <a href="start/examples//book/language/functions.html">function</a> with two parameters</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/function_decl3.rhai"><code>function_decl3.rhai</code></a></td><td>a <a href="start/examples//book/language/functions.html">function</a> with many parameters</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/function_decl4.rhai"><code>function_decl4.rhai</code></a></td><td>a <a href="start/examples//book/language/functions.html">function</a> acting as a <a href="start/examples//book/language/fn-method.html">method</a></td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/function_decl5.rhai"><code>function_decl5.rhai</code></a></td><td>multiple <a href="start/examples//book/language/functions.html">functions</a> as <a href="start/examples//book/language/fn-method.html">methods</a> for different data types</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/if1.rhai"><code>if1.rhai</code></a></td><td><a href="start/examples//book/language/if.html"><code>if</code></a> example</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/if2.rhai"><code>if2.rhai</code></a></td><td><a href="start/examples//book/language/if.html"><code>if</code></a>-expression example</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/loop.rhai"><code>loop.rhai</code></a></td><td>count-down <a href="start/examples//book/language/loop.html"><code>loop</code></a> in Rhai, emulating a <a href="start/examples//book/language/do.html"><code>do</code></a> … <code>while</code> loop</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/module.rhai"><code>module.rhai</code></a></td><td>import a script file as a module</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/oop.rhai"><code>oop.rhai</code></a></td><td>simulate <a href="start/examples//book/patterns/oop.html">object-oriented programming (OOP)</a> with <a href="start/examples//book/language/fn-closure.html">closures</a></td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/op1.rhai"><code>op1.rhai</code></a></td><td>just simple addition</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/op2.rhai"><code>op2.rhai</code></a></td><td>simple addition and multiplication</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/op3.rhai"><code>op3.rhai</code></a></td><td>change evaluation order with parenthesis</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/string.rhai"><code>string.rhai</code></a></td><td><a href="start/examples//book/language/strings-chars.html">string</a> operations, including <em>interpolation</em></td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/strings_map.rhai"><code>strings_map.rhai</code></a></td><td><a href="start/examples//book/language/strings-chars.html">string</a> and <a href="start/examples//book/language/object-maps.html">object map</a> operations</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/switch.rhai"><code>switch.rhai</code></a></td><td><a href="start/examples//book/language/switch.html"><code>switch</code></a> example</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/while.rhai"><code>while.rhai</code></a></td><td><a href="start/examples//book/language/while.html"><code>while</code></a> loop</td></tr>
</tbody></table>
</div>
<h2 id="benchmark-scripts"><a class="header" href="#benchmark-scripts">Benchmark Scripts</a></h2>
<p>The following scripts are for benchmarking the speed of Rhai:</p>
<div class="table-wrapper"><table><thead><tr><th>Scripts</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/speed_test.rhai"><code>speed_test.rhai</code></a></td><td>a simple application to measure the speed of Rhai’s interpreter (1 million iterations)</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/primes.rhai"><code>primes.rhai</code></a></td><td>use Sieve of Eratosthenes to find all primes smaller than a limit</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/fibonacci.rhai"><code>fibonacci.rhai</code></a></td><td>calculate the n-th Fibonacci number using a really dumb algorithm</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/scripts/mat_mul.rhai"><code>mat_mul.rhai</code></a></td><td>matrix multiplication test to measure the speed of multi-dimensional array access</td></tr>
</tbody></table>
</div>
<h2 id="run-example-scripts"><a class="header" href="#run-example-scripts">Run Example Scripts</a></h2>
<p>The <a href="start/examples//book/bin.html"><code>rhai-run</code></a> utility can be used to run Rhai scripts:</p>
<pre><code class="language-sh">cargo run --bin rhai-run scripts/any_script.rhai
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="special-builds"><a class="header" href="#special-builds">Special Builds</a></h1>
<p>It is possible to mix-and-match various <a href="start/builds//book/start/features.html">features</a> of the Rhai crate to make specialized builds with
specific characteristics and behaviors.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="performance-build"><a class="header" href="#performance-build">Performance Build</a></h1>
<p>Some features are for performance.  In order to squeeze out the maximum performance from Rhai, the
following features should be considered:</p>
<div class="table-wrapper"><table><thead><tr><th>Feature</th><th>Description</th><th>Rationale</th></tr></thead><tbody>
<tr><td><a href="start/builds//book/start/features.html"><code>only_i32</code></a></td><td>support only a single <code>i32</code> integer type</td><td>reduce data size</td></tr>
<tr><td><a href="start/builds//book/start/features.html"><code>no_float</code></a></td><td>remove support for floating-point numbers</td><td>reduce code size</td></tr>
<tr><td><a href="start/builds//book/start/features.html"><code>f32_float</code></a></td><td>set floating-point numbers (if not disabled) to 32-bit</td><td>reduce data size</td></tr>
<tr><td><a href="start/builds//book/start/features.html"><code>no_closure</code></a></td><td>remove support for <a href="start/builds//book/language/variables.html">variables</a> sharing</td><td>no need for data locking</td></tr>
<tr><td><a href="start/builds//book/start/features.html"><code>unchecked</code></a></td><td>disable all safety <a href="start/builds//book/safety/checked.html">checks</a></td><td>remove checking code</td></tr>
<tr><td><a href="start/builds//book/start/features.html"><code>no_module</code></a></td><td>disable loading external <a href="start/builds//book/rust/modules/index.html">modules</a></td><td>reduce code size</td></tr>
<tr><td><a href="start/builds//book/start/features.html"><code>no_position</code></a></td><td>disable position tracking during parsing</td><td>reduce data size</td></tr>
<tr><td><a href="start/builds//book/start/features.html"><code>no_custom_syntax</code></a></td><td>disable <a href="start/builds//book/engine/custom-syntax.html">custom syntax</a></td><td>reduce code size</td></tr>
</tbody></table>
</div>
<p>When the above feature flags are used, performance may increase by around 15-20%.</p>
<div id="admonition-see-also-benchmarks" class="admonition admonish-info small" role="note" aria-labelledby="admonition-see-also-benchmarks-title">
<div class="admonition-title">
<div id="admonition-see-also-benchmarks-title">
<p>See also: Benchmarks</p>
</div>
<a class="admonition-anchor-link" href="start/builds/performance.html#admonition-see-also-benchmarks"></a>
</div>
<div>
<p>See Rhai performance <a href="start/builds//book/about/benchmarks.html">benchmarks</a>.</p>
</div>
</div>
<h2 id="unchecked-build"><a class="header" href="#unchecked-build">Unchecked Build</a></h2>
<p>By default, Rhai provides a <a href="https://en.wikipedia.org/wiki/Phrases_from_The_Hitchhiker%27s_Guide_to_the_Galaxy#Don&#x27;t_Panic"><em>Don’t Panic</em></a>
guarantee and prevents malicious scripts from bringing down the host. Any panic can be considered a bug.</p>
<p>For maximum performance, however, these <a href="start/builds//book/safety/index.html">safety</a> checks can be turned off via the <a href="start/builds//book/start/features.html"><code>unchecked</code></a> feature.</p>
<h2 id="fast-operators-mode"><a class="header" href="#fast-operators-mode">Fast Operators Mode</a></h2>
<p>Make sure that <a href="start/builds//book/engine/options.html"><em>Fast Operators</em> Mode</a>, which is enabled by default, is on.  It ignores any
user <a href="start/builds//book/rust/operators.html">overloading</a> of <a href="start/builds//book/engine/builtin.html">built-in operators</a>.</p>
<p>For operator-heavy scripts, this may provide a substantial speed-up.</p>
<h2 id="use-only-one-integer-type"><a class="header" href="#use-only-one-integer-type">Use Only One Integer Type</a></h2>
<p>If only a single integer type is needed in scripts – most of the time this is the case –
it is best to avoid registering lots of functions related to other integer types that will never be used.
As a result, <a href="start/builds//book/engine/hello-world.html"><code>Engine</code></a> creation will be faster because fewer functions need to be loaded.</p>
<p>The <a href="start/builds//book/start/features.html"><code>only_i32</code></a> and <a href="start/builds//book/start/features.html"><code>only_i64</code></a> features disable all integer types except <code>i32</code> or <code>i64</code> respectively.</p>
<h2 id="use-only-32-bit-numbers"><a class="header" href="#use-only-32-bit-numbers">Use Only 32-Bit Numbers</a></h2>
<p>If only 32-bit integers are needed – again, most of the time this is the case – turn on <a href="start/builds//book/start/features.html"><code>only_i32</code></a>.
Under this feature, only <code>i32</code> is supported as a built-in integer type and no others.</p>
<p>On 64-bit targets this may not gain much, but on certain 32-bit targets this improves performance
due to 64-bit arithmetic requiring more CPU cycles to complete.</p>
<h2 id="minimize-size-of-dynamic"><a class="header" href="#minimize-size-of-dynamic">Minimize Size of <code>Dynamic</code></a></h2>
<p>Turning on <a href="start/builds//book/start/features.html"><code>f32_float</code></a> (or <a href="start/builds//book/start/features.html"><code>no_float</code></a>) and <a href="start/builds//book/start/features.html"><code>only_i32</code></a> on 32-bit targets makes the critical
<a href="start/builds//book/language/dynamic.html"><code>Dynamic</code></a> data type only 8 bytes long for 32-bit targets.</p>
<p>Normally <a href="start/builds//book/language/dynamic.html"><code>Dynamic</code></a> needs to be up 12-16 bytes long in order to hold an <code>i64</code> or <code>f64</code>.</p>
<p>A smaller <a href="start/builds//book/language/dynamic.html"><code>Dynamic</code></a> helps performance due to better cache efficiency.</p>
<h2 id="use-immutablestring"><a class="header" href="#use-immutablestring">Use <code>ImmutableString</code></a></h2>
<p>Internally, Rhai uses <em>immutable</em> <a href="start/builds//book/language/strings-chars.html">strings</a> instead of the Rust <code>String</code> type.
This is mainly to avoid excessive cloning when passing function arguments.</p>
<p>Rhai’s internal string type is <a href="start/builds//book/rust/immutable-string.html"><code>ImmutableString</code></a> (basically <code>Rc&lt;SmartString&gt;</code> or
<code>Arc&lt;SmartString&gt;</code> depending on the <a href="start/builds//book/start/features.html"><code>sync</code></a> feature). It is cheap to clone, but expensive to modify
(a new copy of the string must be made in order to change it).</p>
<p>Therefore, functions taking <code>String</code> parameters should use <a href="start/builds//book/rust/immutable-string.html"><code>ImmutableString</code></a> or <code>&amp;str</code>
(maps to <a href="start/builds//book/rust/immutable-string.html"><code>ImmutableString</code></a>) for the best performance with Rhai.</p>
<h2 id="disable-capturing-in-closures"><a class="header" href="#disable-capturing-in-closures">Disable Capturing in Closures</a></h2>
<div id="admonition-anonymous-functions-still-work" class="admonition admonish-info side" role="note" aria-labelledby="admonition-anonymous-functions-still-work-title">
<div class="admonition-title">
<div id="admonition-anonymous-functions-still-work-title">
<p>Anonymous functions still work</p>
</div>
<a class="admonition-anchor-link" href="start/builds/performance.html#admonition-anonymous-functions-still-work"></a>
</div>
<div>
<p><a href="start/builds//book/language/fn-anon.html">Anonymous functions</a> continue to work even under <a href="start/builds//book/start/features.html"><code>no_closure</code></a>.</p>
<p>Only capturing of external shared <a href="start/builds//book/language/variables.html">variables</a> is disabled.</p>
</div>
</div>
<p>Support for <a href="start/builds//book/language/fn-closure.html">closures</a> that capture <em>shared</em> <a href="start/builds//book/language/variables.html">variables</a> adds material overhead to script evaluation.</p>
<p>This is because every data access must be checked whether it is a shared value and, if so,
take a read lock before reading it.</p>
<p>As the vast majority of <a href="start/builds//book/language/variables.html">variables</a> are <em>not</em> shared, needless to say this is a non-trivial
performance overhead.</p>
<p>Use <a href="start/builds//book/start/features.html"><code>no_closure</code></a> to disable support for <a href="start/builds//book/language/fn-closure.html">closures</a> to optimize the hot path because it no longer
needs to take locks for shared data.</p>
<h2 id="disable-position"><a class="header" href="#disable-position">Disable Position</a></h2>
<p>For embedded scripts that are not expected to cause errors, the <a href="start/builds//book/start/features.html"><code>no_position</code></a> feature can be used
to disable position tracking during parsing.</p>
<p>No line number/character position information is kept for error reporting purposes.</p>
<p>This may result in a slightly fast build due to elimination of code related to position tracking.</p>
<h2 id="avoid-cloning"><a class="header" href="#avoid-cloning">Avoid Cloning</a></h2>
<h3 id="use-mut-functions"><a class="header" href="#use-mut-functions">Use <code>&amp;mut</code> functions</a></h3>
<p>Rhai values are typically <em>cloned</em> when passed around, especially into <a href="start/builds//book/language/functions.html">function</a> calls.
Large data structures may incur material cloning overhead.</p>
<p>Some functions accept the first parameter as a mutable reference (i.e. <code>&amp;mut</code>), for example
<em>methods</em> for <a href="start/builds//book/rust/custom-types.html">custom types</a>, and may avoid potentially-costly cloning.</p>
<h3 id="compound-assignment"><a class="header" href="#compound-assignment">Compound assignment</a></h3>
<p>For example, the <code>+=</code> (append) compound assignment takes a mutable reference to the <a href="start/builds//book/language/variables.html">variable</a> while
the corresponding <code>+</code> (add) assignment usually doesn’t.  The difference in performance can be huge:</p>
<pre><code class="language-rust">let x = create_some_very_big_and_expensive_type();

x = x + 1;
//  ^ 'x' is cloned here

// The above is equivalent to:
let temp_value = x.clone() + 1;
x = temp_value;

x += 1;             // &lt;- 'x' is NOT cloned</code></pre>
<h3 id="use-take"><a class="header" href="#use-take">Use <code>take</code></a></h3>
<p>Another example: use the <code>take</code> function to extract a value out of a variable (replacing it with
<a href="start/builds//book/language/values-and-types.html"><code>()</code></a>) without cloning.</p>
<pre><code class="language-rust">let x = create_some_very_big_and_expensive_type();

let y = x;          // &lt;- 'x' is cloned here

let y = x.take();   // &lt;- 'x' is NOT cloned</code></pre>
<div id="admonition-tip-simple-variable-references-are-already-optimized" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-simple-variable-references-are-already-optimized-title">
<div class="admonition-title">
<div id="admonition-tip-simple-variable-references-are-already-optimized-title">
<p>Tip: Simple variable references are already optimized</p>
</div>
<a class="admonition-anchor-link" href="start/builds/performance.html#admonition-tip-simple-variable-references-are-already-optimized"></a>
</div>
<div>
<p>Rhai’s script <a href="start/builds//book/engine/optimize/index.html">optimizer</a> is usually smart enough to <em>rewrite</em> function calls
into <a href="start/builds//book/rust/methods.html"><em>method-call</em></a> style or <a href="start/builds//book/language/assignment-op.html"><em>compound assignment</em></a>
style to take advantage of this.</p>
<p>However, there are limits to its intelligence, and only <strong>simple variable references</strong> are optimized.</p>
<pre><code class="language-rust">x = x + 1;          // &lt;- this statement...

x += 1;             // ... is rewritten as this

x[y] = x[y] + 1;    // &lt;- but this is not, so this is MUCH slower...

x[y] += 1;          // ... than this

some_func(x, 1);    // &lt;- this statement...

x.some_func(1);     // ... is rewritten as this

some_func(x[y], 1); // &lt;- but this is not, so 'x[y]` is cloned</code></pre>
</div>
</div>
<h2 id="short-variable-names-for-32-bit-systems"><a class="header" href="#short-variable-names-for-32-bit-systems">Short Variable Names for 32-Bit Systems</a></h2>
<p>On 32-bit systems, <a href="start/builds//book/language/variables.html">variable</a> and <a href="start/builds//book/language/constants.html">constant</a> names longer than 11 ASCII characters incur additional
allocation overhead.</p>
<p>This is particularly true for local variables inside a hot loop, where they are created and destroyed
in rapid succession.</p>
<p>Therefore, avoid long <a href="start/builds//book/language/variables.html">variable</a> and <a href="start/builds//book/language/constants.html">constant</a> names that are over this limit.</p>
<p>On 64-bit systems, this limit is raised to 23 ASCII characters, which is almost always adequate.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="minimal-build"><a class="header" href="#minimal-build">Minimal Build</a></h1>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<p>In order to compile a <em>minimal</em> build – i.e. a build optimized for size – perhaps for
<code>no-std</code> embedded targets or for compiling to <a href="start/builds//book/start/builds/wasm.html">WASM</a>, it is essential that the correct linker flags
are used in <code>Cargo.toml</code>:</p>
<pre><code class="language-toml">[profile.release]
lto = "fat"         # turn on Link-Time Optimizations
codegen-units = 1   # trade compile time with maximum optimization
opt-level = "z"     # optimize for size
</code></pre>
<h2 id="use-i32-only"><a class="header" href="#use-i32-only">Use <code>i32</code> Only</a></h2>
<p>For embedded systems that must optimize for code size, the architecture is commonly 32-bit.
Use <a href="start/builds//book/start/features.html"><code>only_i32</code></a> to prune away large sections of code implementing functions for other numeric types
(including <code>i64</code>).</p>
<p>If, for some reason, 64-bit long integers must be supported, use <a href="start/builds//book/start/features.html"><code>only_i64</code></a> instead of <a href="start/builds//book/start/features.html"><code>only_i32</code></a>.</p>
<h2 id="opt-out-of-features"><a class="header" href="#opt-out-of-features">Opt-Out of Features</a></h2>
<p>Opt out of as many features as possible, if they are not needed, to reduce code size because,
remember, by default all code is compiled into the final binary since what a script requires cannot
be predicted. If a language feature will never be needed, omitting it is a prudent strategy to
optimize the build for size.</p>
<p>Removing the script <a href="start/builds//book/engine/optimize/index.html">optimizer</a> (<a href="start/builds//book/start/features.html"><code>no_optimize</code></a>) yields a sizable code saving,
at the expense of a less efficient script.</p>
<p>Omitting <a href="start/builds//book/language/arrays.html">arrays</a> (<a href="start/builds//book/start/features.html"><code>no_index</code></a>) yields the most code-size savings, followed by floating-point support
(<a href="start/builds//book/start/features.html"><code>no_float</code></a>), safety checks (<a href="start/builds//book/start/features.html"><code>unchecked</code></a>) and finally <a href="start/builds//book/language/object-maps.html">object maps</a> and <a href="start/builds//book/rust/custom-types.html">custom types</a> (<a href="start/builds//book/start/features.html"><code>no_object</code></a>).</p>
<p>Where the usage scenario does not call for loading externally-defined modules, use <a href="start/builds//book/start/features.html"><code>no_module</code></a> to
save some bytes. Disable script-defined functions (<a href="start/builds//book/start/features.html"><code>no_function</code></a>) and possibly closures
(<a href="start/builds//book/start/features.html"><code>no_closure</code></a>) when the features are not needed. Both of these have some code size savings but not much.</p>
<p>For embedded scripts that are not expected to cause errors, the <a href="start/builds//book/start/features.html"><code>no_position</code></a> feature can be used
to disable position tracking during parsing. No line number/character position information is kept
for error reporting purposes. This may result in a slightly smaller build due to elimination of code
related to position tracking.</p>
<h2 id="use-a-raw-engine"><a class="header" href="#use-a-raw-engine">Use a Raw <a href="start/builds//book/engine/hello-world.html"><code>Engine</code></a></a></h2>
<p><a href="start/builds//book/engine/raw.html"><code>Engine::new_raw</code></a> creates a <em>raw</em> engine. A <em>raw</em> engine supports, out of the box,
only a very <a href="start/builds//book/engine/builtin.html">restricted set</a> of basic arithmetic and logical operators.</p>
<p>Selectively include other necessary functionalities by picking specific <a href="start/builds//book/rust/packages/index.html">packages</a> to minimize the footprint.</p>
<p>Packages are shared (even across threads via the <a href="start/builds//book/start/features.html"><code>sync</code></a> feature), so they only have to be created once.</p>
<p>In addition, a <a href="start/builds//book/engine/raw.html"><code>Engine::new_raw</code></a> disables the <em><a href="start/builds//book/rust/strings-interner.html">strings interner</a></em>, which might
actually increase memory usage if many strings are created in scripts. Therefore, selectively turn
on the <a href="start/builds//book/rust/strings-interner.html">strings interner</a> via <a href="start/builds//book/engine/options.html"><code>Engine::set_max_strings_interned</code></a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="no-std-build"><a class="header" href="#no-std-build"><code>no-std</code> Build</a></h1>
<p>The feature <a href="start/builds//book/start/features.html"><code>no_std</code></a> automatically converts the scripting engine into a <code>no-std</code> build.</p>
<p>Usually, a <code>no-std</code> build goes hand-in-hand with <a href="start/builds//book/start/builds/minimal.html">minimal builds</a> because typical embedded
hardware (the primary target for <code>no-std</code>) has limited storage.</p>
<div id="admonition-nightly-required" class="admonition admonish-warning" role="note" aria-labelledby="admonition-nightly-required-title">
<div class="admonition-title">
<div id="admonition-nightly-required-title">
<p>Nightly required</p>
</div>
<a class="admonition-anchor-link" href="start/builds/no-std.html#admonition-nightly-required"></a>
</div>
<div>
<p>Currently, <a href="start/builds//book/start/features.html"><code>no_std</code></a> requires the nightly compiler due to the crates that it uses.</p>
</div>
</div>
<h2 id="implementation"><a class="header" href="#implementation">Implementation</a></h2>
<p>Rhai allocates, so the first thing that must be included in any <code>no-std</code> project is
an allocator crate, such as <a href="https://crates.io/crates/wee_alloc"><code>wee_alloc</code></a>.</p>
<p>Then there is the need to set up proper error/panic handlers.
The following example uses <code>panic = "abort"</code> and <code>wee_alloc</code> as the allocator.</p>
<pre><code class="language-rust">// Set up for no-std.
#![no_std]

// The following no-std features are usually needed.
#![feature(alloc_error_handler, start, core_intrinsics, lang_items, link_cfg)]

// Set up the global allocator.
extern crate alloc;
extern crate wee_alloc;

#[global_allocator]
static ALLOC: wee_alloc::WeeAlloc = wee_alloc::WeeAlloc::INIT;

// Rust needs a CRT runtime on Windows when compiled with MSVC.
#[cfg(all(windows, target_env = "msvc"))]
#[link(name = "msvcrt")]
#[link(name = "libcmt")]
extern "C" {}

// Set up panic and error handlers
#[alloc_error_handler]
fn err_handler(_: core::alloc::Layout) -&gt; ! {
    core::intrinsics::abort();
}

#[panic_handler]
#[lang = "panic_impl"]
extern "C" fn rust_begin_panic(_: &amp;core::panic::PanicInfo) -&gt; ! {
    core::intrinsics::abort();
}

#[lang = "eh_personality"]
extern "C" fn eh_personality() {}

#[no_mangle]
extern "C" fn rust_eh_register_frames() {}

#[no_mangle]
extern "C" fn rust_eh_unregister_frames() {}

#[no_mangle]
extern "C" fn _Unwind_Resume() {}

#[start]
fn main(_argc: isize, _argv: *const *const u8) -&gt; isize {
    // ... main program ...
}</code></pre>
<div id="admonition-samples" class="admonition admonish-example small" role="note" aria-labelledby="admonition-samples-title">
<div class="admonition-title">
<div id="admonition-samples-title">
<p>Samples</p>
</div>
<a class="admonition-anchor-link" href="start/builds/no-std.html#admonition-samples"></a>
</div>
<div>
<p>Check out the <a href="start/builds//book/start/examples/rust.html#no-std-examples"><code>no-std</code> sample applications</a>
for different operating environments.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="webassembly-wasm-build"><a class="header" href="#webassembly-wasm-build">WebAssembly (WASM) Build</a></h1>
<div id="admonition-but-why" class="admonition admonish-question side wide" role="note" aria-labelledby="admonition-but-why-title">
<div class="admonition-title">
<div id="admonition-but-why-title">
<p>But why?</p>
</div>
<a class="admonition-anchor-link" href="start/builds/wasm.html#admonition-but-why"></a>
</div>
<div>
<p>There is already a fast and powerful scripting language that integrates nicely with WASM – <strong>JavaScript</strong>.</p>
<p>Anyhow, do it because you <em>can</em>!</p>
</div>
</div>
<p>It is possible to use Rhai when compiling to WebAssembly (WASM).</p>
<p>This yields a scripting engine (and language) that can be run in a standard web browser,
among other places.</p>
<div id="admonition-unavailable-features" class="admonition admonish-warning" role="note" aria-labelledby="admonition-unavailable-features-title">
<div class="admonition-title">
<div id="admonition-unavailable-features-title">
<p>Unavailable features</p>
</div>
<a class="admonition-anchor-link" href="start/builds/wasm.html#admonition-unavailable-features"></a>
</div>
<div>
<p>When building for WASM, certain features will not be available,
such as the script file APIs and loading <a href="start/builds//book/rust/modules/index.html">modules</a> from external script files.</p>
</div>
</div>
<div id="admonition-sample" class="admonition admonish-example" role="note" aria-labelledby="admonition-sample-title">
<div class="admonition-title">
<div id="admonition-sample-title">
<p>Sample</p>
</div>
<a class="admonition-anchor-link" href="start/builds/wasm.html#admonition-sample"></a>
</div>
<div>
<p>Check out the <a href="start/builds//book/tools/playground.html"><em>Online Playground</em></a> project which is driven
by a Rhai <a href="start/builds//book/engine/hello-world.html"><code>Engine</code></a> compiled into WASM.</p>
</div>
</div>
<h2 id="javascript-interop"><a class="header" href="#javascript-interop">JavaScript Interop</a></h2>
<p>Specify either of the <a href="start/builds//book/start/features.html"><code>wasm-bindgen</code></a> or <a href="start/builds//book/start/features.html"><code>stdweb</code></a> features when building for WASM that requires
interop with JavaScript. This selects the appropriate JavaScript interop layer to use.</p>
<p>It is still possible to compile for WASM without either <a href="start/builds//book/start/features.html"><code>wasm-bindgen</code></a> or <a href="start/builds//book/start/features.html"><code>stdweb</code></a>,
but then the interop code must then be explicitly provided.</p>
<h2 id="target-environments"><a class="header" href="#target-environments">Target Environments</a></h2>
<div id="admonition-wasi-wasm32-wasi" class="admonition admonish-abstract" role="note" aria-labelledby="admonition-wasi-wasm32-wasi-title">
<div class="admonition-title">
<div id="admonition-wasi-wasm32-wasi-title">
<p>WASI: <code>wasm32-wasi</code></p>
</div>
<a class="admonition-anchor-link" href="start/builds/wasm.html#admonition-wasi-wasm32-wasi"></a>
</div>
<div>
<p>There is no particular setting to tweak when building for WASI.</p>
</div>
</div>
<div id="admonition-javascript-wasm32-unknown-unknown--wasm-bindgenstdweb" class="admonition admonish-abstract" role="note" aria-labelledby="admonition-javascript-wasm32-unknown-unknown--wasm-bindgenstdweb-title">
<div class="admonition-title">
<div id="admonition-javascript-wasm32-unknown-unknown--wasm-bindgenstdweb-title">
<p>JavaScript: <code>wasm32-unknown-unknown</code> + <code>wasm-bindgen</code>/<code>stdweb</code></p>
</div>
<a class="admonition-anchor-link" href="start/builds/wasm.html#admonition-javascript-wasm32-unknown-unknown--wasm-bindgenstdweb"></a>
</div>
<div>
<p>Rhai requires a system-provided source of random numbers (for hashing).</p>
<p>Such random number source is available from JavaScript (implied by <code>wasm-bindgen</code> or <code>stdweb</code>).</p>
<p>The <code>js</code> feature on the <a href="https://crates.io/crates/getrandom"><code>getrandom</code></a> crate is
enabled automatically to provide the random  number source.
See also: <a href="https://docs.rs/getrandom/latest/getrandom/#webassembly-support">https://docs.rs/getrandom/latest/getrandom/#webassembly-support</a> for details.</p>
</div>
</div>
<div id="admonition-raw-wasm32-unknown-unknown" class="admonition admonish-warning" role="note" aria-labelledby="admonition-raw-wasm32-unknown-unknown-title">
<div class="admonition-title">
<div id="admonition-raw-wasm32-unknown-unknown-title">
<p>Raw: <code>wasm32-unknown-unknown</code></p>
</div>
<a class="admonition-anchor-link" href="start/builds/wasm.html#admonition-raw-wasm32-unknown-unknown"></a>
</div>
<div>
<p>Rhai requires a system-provided source of random numbers (for hashing).</p>
<p>Non-JavaScript/non-browser environments may not have random numbers available, so it is necessary to
opt out of <code>default-features</code> in order to enable <a href="start/builds//book/patterns/static-hash.html">static hashing</a> which uses fixed (non-random) keys.</p>
<pre><code class="language-toml">[dependencies]
rhai = { version = "1.22.0", default-features = false, features = [ "std" ] }
</code></pre>
</div>
</div>
<h2 id="size"><a class="header" href="#size">Size</a></h2>
<p>Also look into <a href="start/builds//book/start/builds/minimal.html">minimal builds</a> to reduce generated WASM size.</p>
<p>A typical, full-featured Rhai scripting engine compiles to a single WASM32 file that is less than
400KB (non-gzipped).</p>
<p>When excluding features that are marginal in WASM environment, the gzipped payload can be shrunk further.</p>
<p>Standard <a href="start/builds//book/rust/packages/builtin.html">packages</a> can also be excluded to yield additional size savings.</p>
<h2 id="speed"><a class="header" href="#speed">Speed</a></h2>
<p>In benchmark tests, a WASM build runs scripts roughly 30% slower than a native optimized release build.</p>
<h2 id="common-features"><a class="header" href="#common-features">Common Features</a></h2>
<p>Some Rhai functionalities are not necessary in a WASM environment, so the following features
are typically used for a WASM build:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Feature</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: center"><a href="start/builds//book/start/features.html"><code>wasm-bindgen</code></a> or <a href="start/builds//book/start/features.html"><code>stdweb</code></a></td><td>use <a href="https://crates.io/crates/wasm-bindgen"><code>wasm-bindgen</code></a> or <a href="https://crates.io/crates/stdweb"><code>stdweb</code></a> as the JavaScript interop layer, omit if using custom interop code</td></tr>
<tr><td style="text-align: center"><a href="start/builds//book/start/features.html"><code>unchecked</code></a></td><td>when a WASM module panics, it doesn’t crash the entire web app; however this also disables <a href="start/builds//book/safety/max-operations.html">maximum number of operations</a> and <a href="start/builds//book/safety/progress.html">progress</a> tracking so a script can still run indefinitely – the web app must terminate it itself</td></tr>
<tr><td style="text-align: center"><a href="start/builds//book/start/features.html"><code>only_i32</code></a></td><td>WASM supports 32-bit and 64-bit integers, but most scripts will only need 32-bit</td></tr>
<tr><td style="text-align: center"><a href="start/builds//book/start/features.html"><code>f32_float</code></a></td><td>WASM supports 32-bit single-precision and 64-bit double-precision floating-point numbers, but single-precision is usually fine for most uses</td></tr>
<tr><td style="text-align: center"><a href="start/builds//book/start/features.html"><code>no_module</code></a></td><td>a WASM module cannot load modules from the file system, so usually this is not needed, but the savings are minimal; alternatively, a custom <a href="start/builds//book/rust/modules/resolvers/index.html">module resolver</a> can be provided that loads other Rhai scripts</td></tr>
<tr><td style="text-align: center"><a href="start/builds//book/start/features.html"><code>no_custom_syntax</code></a></td><td>if <a href="start/builds//book/engine/custom-syntax.html">custom syntax</a> is not used, this results in a small size saving</td></tr>
</tbody></table>
</div>
<p>The following features are typically <em>not</em> used because they don’t make sense in a WASM build:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Feature</th><th>Why unnecessary</th></tr></thead><tbody>
<tr><td style="text-align: center"><a href="start/builds//book/start/features.html"><code>sync</code></a></td><td>WASM is single-threaded</td></tr>
<tr><td style="text-align: center"><a href="start/builds//book/start/features.html"><code>no_std</code></a></td><td><code>std</code> lib works fine with WASM</td></tr>
<tr><td style="text-align: center"><a href="start/builds//book/start/features.html"><code>metadata</code></a></td><td>WASM usually doesn’t need access to Rhai functions metadata</td></tr>
<tr><td style="text-align: center"><a href="start/builds//book/start/features.html"><code>internals</code></a></td><td>WASM usually doesn’t need to access Rhai internal data structures, unless you are walking the <a href="start/builds//book/engine/compile.html"><code>AST</code></a></td></tr>
<tr><td style="text-align: center"><a href="start/builds//book/start/features.html"><code>debugging</code></a></td><td>unless debugging is needed</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="extend-rhai-with-rust"><a class="header" href="#extend-rhai-with-rust">Extend Rhai with Rust</a></h1>
<p>Most features and functionalities required by a Rhai script should actually be coded in Rust,
which leverages the superior native run-time speed.</p>
<p>This section discusses how to extend Rhai with functionalities written in Rust.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="traits"><a class="header" href="#traits">Traits</a></h1>
<p>A number of traits, under the <code>rhai::</code> module namespace, provide additional functionalities.</p>
<div class="table-wrapper"><table><thead><tr><th>Trait</th><th>Description</th><th>Methods</th></tr></thead><tbody>
<tr><td><code>CustomType</code></td><td>trait to build a <a href="rust//book/rust/custom-types.html">custom type</a> for use with an <a href="rust//book/engine/hello-world.html"><code>Engine</code></a></td><td><code>build</code></td></tr>
<tr><td><code>Func</code></td><td>trait for creating Rust closures from script</td><td><code>create_from_ast</code>, <code>create_from_script</code></td></tr>
<tr><td><code>FuncArgs</code></td><td>trait for parsing function call arguments</td><td><code>parse</code></td></tr>
<tr><td><code>ModuleResolver</code></td><td>trait implemented by <a href="rust//book/rust/modules/resolvers/index.html">module resolution</a> services</td><td><code>resolve</code>, <code>resolve_ast</code>, <code>resolve_raw</code></td></tr>
<tr><td><code>packages::Package</code></td><td>trait implemented by <a href="rust//book/rust/packages/index.html">packages</a></td><td><code>init</code>, <code>init_engine</code>, <code>register_into_engine</code>, <code>register_into_engine_as</code>, <code>as_shared_module</code></td></tr>
<tr><td><code>plugin::PluginFunction</code></td><td>trait implemented by <a href="rust//book/plugins/index.html">plugin</a> functions</td><td><code>call</code>, <code>is_method_call</code>, <code>has_context</code>, <code>is_pure</code></td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="register-a-rust-function-for-use-in-rhai-scripts"><a class="header" href="#register-a-rust-function-for-use-in-rhai-scripts">Register a Rust Function for Use in Rhai Scripts</a></h1>
<p>Rhai’s scripting engine is very lightweight.  It gets most of its abilities from functions.</p>
<p>To call these functions, they need to be <em>registered</em> via <code>Engine::register_fn</code>.</p>
<pre><code class="language-rust">use rhai::{Dynamic, Engine, ImmutableString};

// Normal function that returns a standard type
// Remember to use 'ImmutableString' and not 'String'
fn add_len(x: i64, s: ImmutableString) -&gt; i64 {
    x + s.len()
}
// Alternatively, '&amp;str' maps directly to 'ImmutableString'
fn add_len_count(x: i64, s: &amp;str, c: i64) -&gt; i64 {
    x + s.len() * c
}
// Function that returns a 'Dynamic' value
fn get_any_value() -&gt; Dynamic {
    42_i64.into()                       // standard types can use '.into()'
}

let mut engine = Engine::new();

// Notice that all three functions are overloaded into the same name with
// different number of parameters and/or parameter types.
engine.register_fn("add", add_len)
      .register_fn("add", add_len_count)
      .register_fn("add", get_any_value)
      .register_fn("inc", |x: i64| {    // closure is also OK!
          x + 1
      })
      .register_fn("log", |label: &amp;str, x: i64| {
          println!("{label} = {x}");
      });

let result = engine.eval::&lt;i64&gt;(r#"add(40, "xx")"#)?;

println!("Answer: {result}");           // prints 42

let result = engine.eval::&lt;i64&gt;(r#"add(40, "x", 2)"#)?;

println!("Answer: {result}");           // prints 42

let result = engine.eval::&lt;i64&gt;("add()")?;

println!("Answer: {result}");           // prints 42

let result = engine.eval::&lt;i64&gt;("inc(41)")?;

println!("Answer: {result}");           // prints 42

engine.run(r#"log("value", 42)"#)?;     // prints "value = 42"</code></pre>
<div id="admonition-tip-use-closures" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-use-closures-title">
<div class="admonition-title">
<div id="admonition-tip-use-closures-title">
<p>Tip: Use closures</p>
</div>
<a class="admonition-anchor-link" href="rust/functions.html#admonition-tip-use-closures"></a>
</div>
<div>
<p>It is common for short functions to be registered via a <em>closure</em>.</p>
<pre><code class="language-rust">┌──────┐
│ Rust │
└──────┘

engine.register_fn("foo", |x: i64, y: i64| x * 2 + y * 3);
//                            ^^^     ^^^
// Usually parameter types need to be specified

engine.register_fn("bar", |x: i64| -&gt; Result&lt;_, Box&lt;EvalAltResult&gt;&gt; { x * 2 });
//                                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
// For fallible closures, the return ERROR type may need to be specified

┌─────────────┐
│ Rhai script │
└─────────────┘

foo(42, 100);       // &lt;- 42 * 2 + 100 * 3</code></pre>
<h4 id="interact-with-external-environment"><a class="header" href="#interact-with-external-environment">Interact with external environment</a></h4>
<p>An additional benefit to using closures is that they can capture external variables.</p>
<p>For example, capturing a type wrapped in shared mutability (e.g. <code>Rc&lt;RefCell&lt;T&gt;&gt;</code>)
allows a script to interact with the external environment through that shared type.</p>
<p>See also: <a href="rust//book/patterns/control.html">Control Layer</a>.</p>
<pre><code class="language-rust">┌──────┐
│ Rust │
└──────┘

/// A type that encapsulates some behavior.
#[derive(Clone)]
struct TestStruct { ... }

impl TestStruct {
    /// Some action defined on that type.
    pub fn do_foo(&amp;self, x: i64, y: bool) {
        // ... do something drastic with x and y
    }
}

/// Wrapped in shared mutability: Rc&lt;RefCell&lt;TestStruct&gt;&gt;.
let shared_obj = Rc::new(RefCell::new(TestStruct::new()));

/// Clone the shared reference and move it into the closure.
let embedded_obj = shared.clone();

engine.register_fn("foo", move |x: i64, y: bool| {
//                        ^^^^ 'embedded_obj' is captured into the closure

    embedded_obj.borrow().do_foo(x, y);
});

┌─────────────┐
│ Rhai script │
└─────────────┘

foo(42, true);      // &lt;- equivalent to: shared_obj.borrow().do_foo(42, true);</code></pre>
</div>
</div>
<div id="admonition-warning-dont-touch-those-generic-parameters" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-dont-touch-those-generic-parameters-title">
<div class="admonition-title">
<div id="admonition-warning-dont-touch-those-generic-parameters-title">
<p>Warning: Don’t touch those generic parameters</p>
</div>
<a class="admonition-anchor-link" href="rust/functions.html#admonition-warning-dont-touch-those-generic-parameters"></a>
</div>
<div>
<p>Rhai uses an intricate system of traits (in particular <code>RhaiNativeFunc</code>) with many generic parameters to ensure
an intuitive and smooth developer experience that <em>just works</em>.</p>
<p>Because of this, it is not recommended to touch those generic parameters directly.  These generic parameters may change
liberally in future versions of Rhai. In most situations they are automatically inferred by the compiler.</p>
<p>In the cases where the compiler fail to infer types when registering a <em>closure</em>, (usually with the <em>error</em> type
of a <a href="rust//book/rust/fallible.html">fallible function</a>), manually declare the parameter and/or return types.</p>
<pre><code class="language-rust">// The following fails to compile because the compiler does not know
// the return _error_ type of the closure.
// It knows the return type, which is 'Result&lt;i64, E&gt;', but 'E' is not known.
engine.register_fn("foo", |x: i64| Ok(x));

// Don't do this...
engine.register_fn::&lt;_, 1, false, i64, Box&lt;EvalAltResult&gt;&gt;("foo", |x: i64| Ok(x));

// Do this...
engine.register_fn("foo", |x: i64| -&gt; Result&lt;i64, Box&lt;EvalAltResult&gt;&gt; { Ok(x) });</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="function-overloading"><a class="header" href="#function-overloading">Function Overloading</a></h1>
<p>Functions registered with the <a href="rust//book/engine/hello-world.html"><code>Engine</code></a> can be <em>overloaded</em> as long as the <em>signature</em> is unique,
i.e. different functions can have the same name as long as their parameters are of different numbers
(i.e. <em>arity</em>) or  different types.</p>
<p>New definitions <em>overwrite</em> previous definitions of the same name, same arity and same parameter types.</p>
<div id="admonition-tip-overloading-as-a-form-of-default-parameter-values" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-overloading-as-a-form-of-default-parameter-values-title">
<div class="admonition-title">
<div id="admonition-tip-overloading-as-a-form-of-default-parameter-values-title">
<p>Tip: Overloading as a form of default parameter values</p>
</div>
<a class="admonition-anchor-link" href="rust/overloading.html#admonition-tip-overloading-as-a-form-of-default-parameter-values"></a>
</div>
<div>
<p>Rhai does not support default values for function parameters.</p>
<p>However it is extremely easy to <em>simulate</em> default parameter values via multiple overloaded
registrations of the same function name.</p>
<pre><code class="language-rust">// The following definition of 'foo' is equivalent to the pseudo-code:
//   fn foo(x = 42_i64, y = "hello", z = true) -&gt; i64 { ... }

fn foo3(x: i64, y: &amp;str, z: bool) -&gt; i64 { ... }
fn foo2(x: i64, y: &amp;str) -&gt; i64 { foo3(x, y, true) }
fn foo1(x: i64) -&gt; i64 { foo2(x, "hello") }
fn foo0() -&gt; i64 { foo1(42) }

engine.register_fn("foo", foo0)     // no parameters
      .register_fn("foo", foo1)     // 1 parameter
      .register_fn("foo", foo2)     // 2 parameters
      .register_fn("foo", foo3);    // 3 parameters</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="register-a-generic-rust-function"><a class="header" href="#register-a-generic-rust-function">Register a Generic Rust Function</a></h1>
<div id="admonition-no-monomorphization" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-no-monomorphization-title">
<div class="admonition-title">
<div id="admonition-no-monomorphization-title">
<p>No monomorphization</p>
</div>
<a class="admonition-anchor-link" href="rust/generic.html#admonition-no-monomorphization"></a>
</div>
<div>
<p>Due to its dynamic nature, Rhai cannot monomorphize generic functions automatically.</p>
<p>Monomorphization of generic functions must be performed manually.</p>
</div>
</div>
<p>Rust generic functions can be used in Rhai, but separate instances for each concrete type must be
registered separately.</p>
<p>This essentially <em>overloads</em> the function with different parameter types as Rhai does not natively
support generics but Rhai does support <em><a href="rust//book/rust/overloading.html">function overloading</a></em>.</p>
<p>The example below shows how to register multiple functions (or, in this case, multiple overloaded
versions of the same function) under the same name.</p>
<pre><code class="language-rust">use std::fmt::Display;

use rhai::Engine;

fn show_it&lt;T: Display&gt;(x: &amp;mut T) {
    println!("put up a good show: {x}!");
}

let mut engine = Engine::new();

engine.register_fn("print", show_it::&lt;i64&gt;)
      .register_fn("print", show_it::&lt;bool&gt;)
      .register_fn("print", show_it::&lt;ImmutableString&gt;);</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="string-parameters-in-rust-functions"><a class="header" href="#string-parameters-in-rust-functions"><code>String</code> Parameters in Rust Functions</a></h1>
<div id="admonition-warning-avoid-string-parameters" class="admonition admonish-danger" role="note" aria-labelledby="admonition-warning-avoid-string-parameters-title">
<div class="admonition-title">
<div id="admonition-warning-avoid-string-parameters-title">
<p>Warning: Avoid <code>String</code> parameters</p>
</div>
<a class="admonition-anchor-link" href="rust/strings.html#admonition-warning-avoid-string-parameters"></a>
</div>
<div>
<p>As much as possible, avoid using <code>String</code> parameters in functions.</p>
<p>Each <code>String</code> argument is cloned during <em>every</em> single call to that function –
and the copy immediately thrown away right after the call.</p>
<p>Needless to say, it is <em>extremely</em> inefficient to use <code>String</code> parameters.</p>
</div>
</div>
<h2 id="str-maps-to-immutablestring"><a class="header" href="#str-maps-to-immutablestring"><code>&amp;str</code> Maps to <code>ImmutableString</code></a></h2>
<div id="admonition-common-mistake" class="admonition admonish-warning side" role="note" aria-labelledby="admonition-common-mistake-title">
<div class="admonition-title">
<div id="admonition-common-mistake-title">
<p>Common mistake</p>
</div>
<a class="admonition-anchor-link" href="rust/strings.html#admonition-common-mistake"></a>
</div>
<div>
<p>A common mistake made by novice Rhai users is to register functions with <code>String</code> parameters.</p>
</div>
</div>
<p>Rust functions accepting parameters of <code>String</code> should use <code>&amp;str</code> instead because it maps directly
to <a href="rust//book/rust/immutable-string.html"><code>ImmutableString</code></a> which is the type that Rhai uses to represent <a href="rust//book/language/strings-chars.html">strings</a> internally.</p>
<p>The parameter type <code>String</code> involves always converting an <a href="rust//book/rust/immutable-string.html"><code>ImmutableString</code></a> into a <code>String</code>
which mandates cloning it.</p>
<p>Using <a href="rust//book/rust/immutable-string.html"><code>ImmutableString</code></a> or <code>&amp;str</code> is much more efficient.</p>
<pre><code class="language-rust">fn get_len1(s: String) -&gt; i64 {             // BAD!!! Very inefficient!!!
    s.len() as i64
}
fn get_len2(s: &amp;str) -&gt; i64 {               // this is better
    s.len() as i64
}
fn get_len3(s: ImmutableString) -&gt; i64 {    // the above is equivalent to this
    s.len() as i64
}

engine.register_fn("len1", get_len1)
      .register_fn("len2", get_len2)
      .register_fn("len3", get_len3);

let len = engine.eval::&lt;i64&gt;("len1(x)")?;   // 'x' cloned, very inefficient!!!
let len = engine.eval::&lt;i64&gt;("len2(x)")?;   // 'x' is shared
let len = engine.eval::&lt;i64&gt;("len3(x)")?;   // 'x' is shared</code></pre>
<div id="admonition-mut-string-does-not-work--use-mut-immutablestring-instead" class="admonition admonish-danger" role="note" aria-labelledby="admonition-mut-string-does-not-work--use-mut-immutablestring-instead-title">
<div class="admonition-title">
<div id="admonition-mut-string-does-not-work--use-mut-immutablestring-instead-title">
<p><code>&amp;mut String</code> does not work – use <code>&amp;mut ImmutableString</code> instead</p>
</div>
<a class="admonition-anchor-link" href="rust/strings.html#admonition-mut-string-does-not-work--use-mut-immutablestring-instead"></a>
</div>
<div>
<p>A function with the first parameter being <code>&amp;mut String</code> does not match a string argument passed to it,
which has type <code>ImmutableString</code>.</p>
<p>In fact, <code>&amp;mut String</code> is treated as an opaque <a href="rust//book/rust/custom-types.html">custom type</a>.</p>
<pre><code class="language-rust">fn bad(s: &amp;mut String) { ... }              // '&amp;mut String' will not match string values

fn good(s: &amp;mut ImmutableString) { ... }

engine.register_fn("bad", bad)
      .register_fn("good", good);

engine.eval(r#"bad("hello")"#)?;            // &lt;- error: function 'bad (string)' not found

engine.eval(r#"good("hello")"#)?;           // &lt;- this one works</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dynamic-parameters-in-rust-functions"><a class="header" href="#dynamic-parameters-in-rust-functions"><code>Dynamic</code> Parameters in Rust Functions</a></h1>
<p>It is possible for Rust functions to contain parameters of type <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a>.</p>
<p>A <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> value can hold any clonable type.</p>
<div id="admonition-trivia" class="admonition admonish-question small" role="note" aria-labelledby="admonition-trivia-title">
<div class="admonition-title">
<div id="admonition-trivia-title">
<p>Trivia</p>
</div>
<a class="admonition-anchor-link" href="rust/dynamic-args.html#admonition-trivia"></a>
</div>
<div>
<p>The <code>push</code> method of an <a href="rust//book/language/arrays.html">array</a> is implemented as follows (minus code for <a href="rust//book/safety/index.html">safety</a> protection
against <a href="rust//book/safety/max-array-size.html">over-sized arrays</a>), allowing the function to be called with
all item types.</p>
<pre><code class="language-rust">// 'item: Dynamic' matches all data types
fn push(array: &amp;mut Array, item: Dynamic) {
    array.push(item);
}</code></pre>
</div>
</div>
<h2 id="precedence"><a class="header" href="#precedence">Precedence</a></h2>
<p>Any parameter in a registered Rust function with a specific type has higher precedence over
<a href="rust//book/language/dynamic.html"><code>Dynamic</code></a>, so it is important to understand which <em>version</em> of a function will be used.</p>
<p>Parameter matching starts from the left to the right.
Candidate functions will be matched in order of parameter types.</p>
<p>Therefore, always leave <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> parameters (up to 16, see below) as far to the right as possible.</p>
<pre><code class="language-rust">use rhai::{Engine, Dynamic};

// Different versions of the same function 'foo'
// will be matched in the following order.

fn foo1(x: i64, y: &amp;str, z: bool) { }

fn foo2(x: i64, y: &amp;str, z: Dynamic) { }

fn foo3(x: i64, y: Dynamic, z: bool) { }

fn foo4(x: i64, y: Dynamic, z: Dynamic) { }

fn foo5(x: Dynamic, y: &amp;str, z: bool) { }

fn foo6(x: Dynamic, y: &amp;str, z: Dynamic) { }

fn foo7(x: Dynamic, y: Dynamic, z: bool) { }

fn foo8(x: Dynamic, y: Dynamic, z: Dynamic) { }

let mut engine = Engine::new();

// Register all functions under the same name (order does not matter)

engine.register_fn("foo", foo5)
      .register_fn("foo", foo7)
      .register_fn("foo", foo2)
      .register_fn("foo", foo8)
      .register_fn("foo", foo1)
      .register_fn("foo", foo3)
      .register_fn("foo", foo6)
      .register_fn("foo", foo4);</code></pre>
<div id="admonition-only-the-right-most-16-parameters-can-be-dynamic" class="admonition admonish-warning" role="note" aria-labelledby="admonition-only-the-right-most-16-parameters-can-be-dynamic-title">
<div class="admonition-title">
<div id="admonition-only-the-right-most-16-parameters-can-be-dynamic-title">
<p>Only the right-most 16 parameters can be <code>Dynamic</code></p>
</div>
<a class="admonition-anchor-link" href="rust/dynamic-args.html#admonition-only-the-right-most-16-parameters-can-be-dynamic"></a>
</div>
<div>
<p>The number of parameter permutations goes up exponentially, and therefore there is a realistic limit
of 16 parameters allowed to be <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a>, counting from the <em>right-most side</em>.</p>
<p>For example, Rhai will not find the following function – Oh! and those 16 parameters to the right
certainly have nothing to do with it!</p>
<pre><code class="language-rust">// The 'd' parameter counts 17th from the right!
fn weird(a: i64, d: Dynamic, x1: i64, x2: i64, x3: i64, x4: i64,
                             x5: i64, x6: i64, x7: i64, x8: i64,
                             x9: i64, x10: i64, x11: i64, x12: i64,
                             x13: i64, x14: i64, x15: i64, x16: i64) {

    // ... do something unspeakably evil with all those parameters ...
}</code></pre>
</div>
</div>
<h2 id="tldr"><a class="header" href="#tldr">TL;DR</a></h2>
<div id="admonition-how-is-this-implemented" class="admonition admonish-question" role="note" aria-labelledby="admonition-how-is-this-implemented-title">
<div class="admonition-title">
<div id="admonition-how-is-this-implemented-title">
<p>How is this implemented?</p>
</div>
<a class="admonition-anchor-link" href="rust/dynamic-args.html#admonition-how-is-this-implemented"></a>
</div>
<div>
<h4 id="hash-lookup"><a class="header" href="#hash-lookup">Hash lookup</a></h4>
<p>Since functions in Rhai can be <a href="rust//book/rust/overloading.html">overloaded</a>, Rhai uses a single <em>hash</em> number
to quickly lookup the actual function, based on argument types.</p>
<p>For each function call, a hash is calculated from:</p>
<ol>
<li>the function’s <a href="rust//book/language/fn-namespaces.html">namespace</a>, if any,</li>
<li>the function’s name,</li>
<li>number of arguments (its <em>arity</em>),</li>
<li>unique ID of the type of each argument, if any.</li>
</ol>
<p>The correct function is then obtained via a simple hash lookup.</p>
<h4 id="limitations"><a class="header" href="#limitations">Limitations</a></h4>
<p>This method is <em>fast</em>, but at the expense of flexibility (such as multiple argument types that must
map to a single version).  That is because each type has a different ID, and thus they calculate to
different hash numbers.</p>
<p>This is the reason why <a href="rust/generic.html">generic functions</a> must be expanded into concrete types.</p>
<p>The type ID of <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> is different from any other type, but it must match all types seamlessly.
Needless to say, this creates a slight problem.</p>
<h4 id="trying-combinations"><a class="header" href="#trying-combinations">Trying combinations</a></h4>
<p>If the combined hash calculated from the actual argument type ID’s is not found, then the <a href="rust//book/engine/hello-world.html"><code>Engine</code></a>
calculates hashes for different <em>combinations</em> of argument types and <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a>, systematically
replacing different arguments with <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> <em>starting from the right-most parameter</em>.</p>
<p>Thus, assuming a three-argument function call:</p>
<pre><code class="language-rust">foo(42, "hello", true);</code></pre>
<p>The following hashes will be calculated, in order.
They will be <em>all different</em>.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Order</th><th>Hash calculation method</th></tr></thead><tbody>
<tr><td style="text-align: center">1</td><td><code>foo</code> + 3 + <code>i64</code> + <code>string</code> + <code>bool</code></td></tr>
<tr><td style="text-align: center">2</td><td><code>foo</code> + 3 + <code>i64</code> + <code>string</code> + <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a></td></tr>
<tr><td style="text-align: center">3</td><td><code>foo</code> + 3 + <code>i64</code> + <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> + <code>bool</code></td></tr>
<tr><td style="text-align: center">4</td><td><code>foo</code> + 3 + <code>i64</code> + <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> + <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a></td></tr>
<tr><td style="text-align: center">5</td><td><code>foo</code> + 3 + <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> + <code>string</code> + <code>bool</code></td></tr>
<tr><td style="text-align: center">6</td><td><code>foo</code> + 3 + <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> + <code>string</code> + <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a></td></tr>
<tr><td style="text-align: center">7</td><td><code>foo</code> + 3 + <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> + <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> + <code>bool</code></td></tr>
<tr><td style="text-align: center">8</td><td><code>foo</code> + 3 + <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> + <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> + <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a></td></tr>
</tbody></table>
</div>
<p>Therefore, the version with all the correct parameter types will always be found first if it exists.</p>
<p>At soon as a hash is found, the process stops.</p>
<p>Otherwise, it goes on for up to 16 arguments, or at most 65,536 tries.
That’s where the 16 parameters limit comes from.</p>
</div>
</div>
<div id="admonition-what-it-calculates-65536-hashes-for-each-function-call" class="admonition admonish-question" role="note" aria-labelledby="admonition-what-it-calculates-65536-hashes-for-each-function-call-title">
<div class="admonition-title">
<div id="admonition-what-it-calculates-65536-hashes-for-each-function-call-title">
<p>What?! It calculates 65,536 hashes for each function call???!!!</p>
</div>
<a class="admonition-anchor-link" href="rust/dynamic-args.html#admonition-what-it-calculates-65536-hashes-for-each-function-call"></a>
</div>
<div>
<p>Of course not. Don’t be silly.</p>
<h4 id="not-every-function-has-16-parameters"><a class="header" href="#not-every-function-has-16-parameters">Not every function has 16 parameters</a></h4>
<p>Studies have repeatedly shown that most functions accept few parameters, with the mean between
2-3 parameters per function.  Functions with more than 5 parameters are rare in normal code bases.
If at all, they are usually <a href="rust//book/language/fn-closure.html">closures</a> that <em>capture</em> lots of external variables, bumping up the
parameter count; but <a href="rust//book/language/fn-closure.html">closures</a> are always script-defined and thus all parameters are already
<a href="rust//book/language/dynamic.html"><code>Dynamic</code></a>.</p>
<p>In fact, you have a bigger problem if you write such a function that you need to call regularly.
It would be far more efficient to group those parameters into <a href="rust//book/language/object-maps.html">object maps</a>.</p>
<h4 id="caching-to-the-rescue"><a class="header" href="#caching-to-the-rescue">Caching to the rescue</a></h4>
<p>Function hashes are <em>cached</em>, so this process only happens <em>once</em>, and only up to the number of
rounds for the correct function to be found.</p>
<p>If not, then yes, it will calculate up to 2<sup><em>n</em></sup> hashes where <em>n</em> is the number of
arguments (up to 16). But again, this will only be done <em>once</em> for that particular
combination of argument types.</p>
</div>
</div>
<div id="admonition-but-then-beware-module-functions" class="admonition admonish-danger" role="note" aria-labelledby="admonition-but-then-beware-module-functions-title">
<div class="admonition-title">
<div id="admonition-but-then-beware-module-functions-title">
<p>But then… beware module functions</p>
</div>
<a class="admonition-anchor-link" href="rust/dynamic-args.html#admonition-but-then-beware-module-functions"></a>
</div>
<div>
<p>The functions resolution <em>cache</em> resides only in the <a href="rust//book/language/fn-namespaces.html">global namespace</a>.
This is a limitation.</p>
<p>Therefore, calls to functions in an <a href="rust//book/language/modules/import.html"><code>import</code></a>ed <a href="rust//book/rust/modules/index.html">module</a> (i.e. <em>qualified</em> with
a <a href="rust//book/language/fn-namespaces.html">namespace</a> path) do not have the benefit of a cache.</p>
<p>Thus, up to 2<sup><em>n</em></sup> hashes are calculated during <em>every</em> function call.
This is unlikely to cause a performance issue since most functions accept only a few parameters.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dynamic-return-value"><a class="header" href="#dynamic-return-value"><code>Dynamic</code> Return Value</a></h1>
<p>Rhai supports registering functions that return <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a>.</p>
<p>A <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> value can hold any clonable type.</p>
<pre><code class="language-rust">use rhai::{Engine, Dynamic};

// The 'Dynamic' return type allows this function to
// return values of any supported type!
fn get_info(bag: &amp;mut PropertyBag, key: &amp;str) -&gt; Dynamic {
    if let Some(prop_type) = bag.get_type(key) {
        match prop_type {
            // Use '.into()' for standard types
            "string" =&gt; bag.get::&lt;&amp;str&gt;(key).into(),
            "int" =&gt; bag.get::&lt;i64&gt;(key).into(),
            "bool" =&gt; bag.get::&lt;bool&gt;(key).into(),
                            :
                            :
            // Use 'Dynamic::from' for custom types
            "bag" =&gt; Dynamic::from(bag.get::&lt;PropertyBag&gt;(key))
        }
    } else {
        // Return () upon error
        Dynamic::UNIT
    }
}

let mut engine = Engine::new();

engine.register_fn("get_info", get_info);</code></pre>
<div id="admonition-tip-create-a-dynamic" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-create-a-dynamic-title">
<div class="admonition-title">
<div id="admonition-tip-create-a-dynamic-title">
<p>Tip: Create a <code>Dynamic</code></p>
</div>
<a class="admonition-anchor-link" href="rust/dynamic-return.html#admonition-tip-create-a-dynamic"></a>
</div>
<div>
<p>To create a <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> value, use <code>Dynamic::from</code>.</p>
<p><a href="rust//book/language/values-and-types.html">Standard types</a> in Rhai can also use <code>.into()</code>.</p>
<pre><code class="language-rust">use rhai::Dynamic;

let obj = TestStruct::new();

let x = Dynamic::from(obj);

// '.into()' works for standard types

let x = 42_i64.into();

let y = "hello!".into();</code></pre>
</div>
</div>
<div id="admonition-tip-alternative-to-fallible-functions" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-alternative-to-fallible-functions-title">
<div class="admonition-title">
<div id="admonition-tip-alternative-to-fallible-functions-title">
<p>Tip: Alternative to fallible functions</p>
</div>
<a class="admonition-anchor-link" href="rust/dynamic-return.html#admonition-tip-alternative-to-fallible-functions"></a>
</div>
<div>
<p>Instead of registering a <a href="rust//book/rust/fallible.html">fallible function</a>, it is usually more idiomatic to leverage the <em>dynamic</em>
nature of Rhai and simply return <a href="rust//book/language/values-and-types.html"><code>()</code></a> upon error.</p>
<pre><code class="language-rust">use rhai::{Engine, Dynamic};

// Function that may fail - return () upon failure
fn safe_divide(x: i64, y: i64) -&gt; Dynamic {
    if y == 0 {
        // Return () to indicate an error if y is zero
        Dynamic::UNIT
    } else {
        // Use '.into()' to convert standard types to 'Dynamic'
        (x / y).into()
    }
}

let mut engine = Engine::new();

engine.register_fn("divide", safe_divide);

// The following prints 'error!'
engine.run(r#"
    let result = divide(40, 0);
    
    if result == () {
        print("error!");
    } else {
        print(result);
    }
"#)?;</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="register-a-fallible-rust-function"><a class="header" href="#register-a-fallible-rust-function">Register a Fallible Rust Function</a></h1>
<div id="admonition-tip-consider-dynamic" class="admonition admonish-tip side wide" role="note" aria-labelledby="admonition-tip-consider-dynamic-title">
<div class="admonition-title">
<div id="admonition-tip-consider-dynamic-title">
<p>Tip: Consider <code>Dynamic</code></p>
</div>
<a class="admonition-anchor-link" href="rust/fallible.html#admonition-tip-consider-dynamic"></a>
</div>
<div>
<p>A lot of times it is not necessary to register fallible functions.</p>
<p>Simply have the function returns <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a>.
Upon error, return <a href="rust//book/language/values-and-types.html"><code>()</code></a> which is idiomatic in Rhai.</p>
<p>See <a href="rust/dynamic-return.html">here</a> for more details.</p>
</div>
</div>
<p>If a function is <em>fallible</em> (i.e. it returns a <code>Result&lt;_, _&gt;</code>), it can also be registered with via
<code>Engine::register_fn</code>.</p>
<p>The function must return <code>Result&lt;T, Box&lt;EvalAltResult&gt;&gt;</code> where <code>T</code> is any clonable type.</p>
<p>In other words, the error type <em>must</em> be <code>Box&lt;EvalAltResult&gt;</code>.  It is <code>Box</code>ed in order to reduce
the size of the <code>Result</code> type since the error path is rarely hit.</p>
<pre><code class="language-rust">use rhai::{Engine, EvalAltResult};

// Function that may fail - the error type must be 'Box&lt;EvalAltResult&gt;'
fn safe_divide(x: i64, y: i64) -&gt; Result&lt;i64, Box&lt;EvalAltResult&gt;&gt; {
    if y == 0 {
        // Return an error if y is zero
        Err("Division by zero!".into())         // shortcut to create Box&lt;EvalAltResult::ErrorRuntime&gt;
    } else {
        Ok(x / y)
    }
}

let mut engine = Engine::new();

engine.register_fn("divide", safe_divide);

if let Err(error) = engine.eval::&lt;i64&gt;("divide(40, 0)") {
    println!("Error: {error:?}");               // prints ErrorRuntime("Division by zero detected!", (1, 1)")
}</code></pre>
<div id="admonition-tip-create-a-box" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-create-a-box-title">
<div class="admonition-title">
<div id="admonition-tip-create-a-box-title">
<p>Tip: Create a <code>Box&lt;EvalAltResult&gt;</code></p>
</div>
<a class="admonition-anchor-link" href="rust/fallible.html#admonition-tip-create-a-box"></a>
</div>
<div>
<p><code>Box&lt;EvalAltResult&gt;</code> implements <code>From&lt;&amp;str&gt;</code> and <code>From&lt;String&gt;</code> etc.
and the error text gets converted into <code>Box&lt;EvalAltResult::ErrorRuntime&gt;</code>.</p>
<p>The error values are <code>Box</code>-ed in order to reduce memory footprint of the error path,
which should be hit rarely.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nativecallcontext"><a class="header" href="#nativecallcontext"><code>NativeCallContext</code></a></h1>
<p>If the <em>first</em> parameter of a function is of type <code>rhai::NativeCallContext</code>, then it is treated
specially by the <a href="rust//book/engine/hello-world.html"><code>Engine</code></a>.</p>
<p><code>NativeCallContext</code> is a type that encapsulates the current <em>call context</em> of a Rust function call
and exposes the following.</p>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th style="text-align: center">Return type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>engine()</code></td><td style="text-align: center"><a href="rust//book/engine/hello-world.html"><code>&amp;Engine</code></a></td><td>the current <a href="rust//book/engine/hello-world.html"><code>Engine</code></a>, with all configurations and settings.<br/>This is sometimes useful for calling a script-defined function within the same evaluation context using <a href="rust//book/engine/call-fn.html"><code>Engine::call_fn</code></a>, or calling a <a href="rust//book/language/fn-ptr.html">function pointer</a>.</td></tr>
<tr><td><code>fn_name()</code></td><td style="text-align: center"><code>&amp;str</code></td><td>name of the function called (useful when the same Rust function is mapped to multiple Rhai-callable function names)</td></tr>
<tr><td><code>fn_source()</code></td><td style="text-align: center"><code>Option&lt;&amp;str&gt;</code></td><td>source of the current function, if any</td></tr>
<tr><td><code>call_source()</code></td><td style="text-align: center"><code>Option&lt;&amp;str&gt;</code></td><td>source of the caller, if any</td></tr>
<tr><td><code>call_position()</code></td><td style="text-align: center"><code>Position</code></td><td>position of the function call</td></tr>
<tr><td><code>call_level()</code></td><td style="text-align: center"><code>usize</code></td><td>the current nesting level of function calls</td></tr>
<tr><td><code>tag()</code></td><td style="text-align: center"><a href="rust//book/language/dynamic.html"><code>&amp;Dynamic</code></a></td><td>reference to the <em>custom state</em> that is persistent during the current run</td></tr>
<tr><td><code>iter_imports()</code></td><td style="text-align: center"><code>impl Iterator&lt;Item = (&amp;str,</code><a href="rust//book/rust/modules/index.html"><code>&amp;Module</code></a><code>)&gt;</code></td><td>iterator of the current stack of <a href="rust//book/rust/modules/index.html">modules</a> imported via <code>import</code> statements, in reverse order (i.e. later <a href="rust//book/rust/modules/index.html">modules</a> come first)</td></tr>
<tr><td><code>global_runtime_state()</code></td><td style="text-align: center"><a href="https://docs.rs/rhai/1.22.0/rhai/struct.GlobalRuntimeState.html"><code>&amp;GlobalRuntimeState</code></a></td><td>reference to the current <a href="https://docs.rs/rhai/1.22.0/rhai/struct.GlobalRuntimeState.html">global runtime state</a> (including the stack of <a href="rust//book/rust/modules/index.html">modules</a> imported via <code>import</code> statements); requires the <a href="rust//book/start/features.html"><code>internals</code></a> feature</td></tr>
<tr><td><code>iter_namespaces()</code></td><td style="text-align: center"><code>impl Iterator&lt;Item =</code><a href="rust//book/rust/modules/index.html"><code>&amp;Module</code></a><code>&gt;</code></td><td>iterator of the <a href="rust//book/language/fn-namespaces.html">namespaces</a> (as <a href="rust//book/rust/modules/index.html">modules</a>) containing all script-defined <a href="rust//book/language/functions.html">functions</a>, in reverse order (i.e. later <a href="rust//book/rust/modules/index.html">modules</a> come first)</td></tr>
<tr><td><code>namespaces()</code></td><td style="text-align: center"><a href="rust//book/rust/modules/index.html"><code>&amp;[&amp;Module]</code></a></td><td>reference to the <a href="rust//book/language/fn-namespaces.html">namespaces</a> (as <a href="rust//book/rust/modules/index.html">modules</a>) containing all script-defined <a href="rust//book/language/functions.html">functions</a>; requires the <a href="rust//book/start/features.html"><code>internals</code></a> feature</td></tr>
<tr><td><code>call_fn(...)</code></td><td style="text-align: center"><code>Result&lt;T, Box&lt;EvalAltResult&gt;&gt;</code></td><td>call a function with the supplied arguments, casting the result into the required type</td></tr>
<tr><td><code>call_native_fn(...)</code></td><td style="text-align: center"><code>Result&lt;T, Box&lt;EvalAltResult&gt;&gt;</code></td><td>call a registered native Rust function with the supplied arguments, casting the result into the required type</td></tr>
<tr><td><code>call_fn_raw(...)</code></td><td style="text-align: center"><code>Result&lt;</code><a href="rust//book/language/dynamic.html"><code>Dynamic</code></a><code>, Box&lt;EvalAltResult&gt;&gt;</code></td><td>call a function with the supplied arguments; this is an advanced method</td></tr>
<tr><td><code>call_native_fn_raw(...)</code></td><td style="text-align: center"><code>Result&lt;</code><a href="rust//book/language/dynamic.html"><code>Dynamic</code></a><code>, Box&lt;EvalAltResult&gt;&gt;</code></td><td>call a registered native Rust function with the supplied arguments; this is an advanced method</td></tr>
</tbody></table>
</div>
<h2 id="example-implementations"><a class="header" href="#example-implementations">Example Implementations</a></h2>
<div id="admonition-example--implement-safety-checks" class="admonition admonish-example" role="note" aria-labelledby="admonition-example--implement-safety-checks-title">
<div class="admonition-title">
<div id="admonition-example--implement-safety-checks-title">
<p>Example – Implement Safety Checks</p>
</div>
<a class="admonition-anchor-link" href="rust/context.html#admonition-example--implement-safety-checks"></a>
</div>
<div>
<p>The native call context is useful for protecting a function from malicious scripts.</p>
<pre><code class="language-rust">use rhai::{Array, NativeCallContext, EvalAltResult, Position};

// This function builds an array of arbitrary size, but is protected against attacks
// by first checking with the allowed limit set into the 'Engine'.
pub fn new_array(context: NativeCallContext, size: i64) -&gt; Result&lt;Array, Box&lt;EvalAltResult&gt;&gt;
{
    let array = Array::new();

    if size &lt;= 0 {
        return array;
    }

    let size = size as usize;
    let max_size = context.engine().max_array_size();

    // Make sure the function does not generate a data structure larger than
    // the allowed limit for the Engine!
    if max_size &gt; 0 &amp;&amp; size &gt; max_size {
        return Err(EvalAltResult::ErrorDataTooLarge(
            "Size to grow".to_string(),
            max_size, size,
            context.call_position(),
        ).into());
    }

    for x in 0..size {
        array.push(x.into());
    }

    OK(array)
}</code></pre>
</div>
</div>
<div id="admonition-example--call-a-function-within-a-function" class="admonition admonish-example" role="note" aria-labelledby="admonition-example--call-a-function-within-a-function-title">
<div class="admonition-title">
<div id="admonition-example--call-a-function-within-a-function-title">
<p>Example – Call a Function Within a Function</p>
</div>
<a class="admonition-anchor-link" href="rust/context.html#admonition-example--call-a-function-within-a-function"></a>
</div>
<div>
<p>The <em>native call context</em> can be used to call a <a href="rust//book/language/functions.html">function</a> within the current evaluation
via <code>call_fn</code> (or more commonly <code>call_native_fn</code>).</p>
<pre><code class="language-rust">use rhai::{Engine, NativeCallContext};

let mut engine = Engine::new();

// A function expecting a callback in form of a function pointer.
engine.register_fn("super_call", |context: NativeCallContext, value: i64| {
    // Call a function within the current evaluation!
    // 'call_native_fn' ensures that only registered native Rust functions
    // are called, so a scripted function named 'double' cannot hijack
    // the process.
    // To also include scripted functions, use 'call_fn' instead.
    context.call_native_fn::&lt;i64&gt;("double", (value,))
    //                                      ^^^^^^^^ arguments passed in tuple
});</code></pre>
</div>
</div>
<div id="admonition-example--implement-a-callback" class="admonition admonish-example" role="note" aria-labelledby="admonition-example--implement-a-callback-title">
<div class="admonition-title">
<div id="admonition-example--implement-a-callback-title">
<p>Example – Implement a Callback</p>
</div>
<a class="admonition-anchor-link" href="rust/context.html#admonition-example--implement-a-callback"></a>
</div>
<div>
<p>The <em>native call context</em> can be used to call a <a href="rust//book/language/fn-ptr.html">function pointer</a> or <a href="rust//book/language/fn-closure.html">closure</a> that has been passed
as a parameter to the function (via <code>FnPtr::call_within_context</code>), thereby implementing a <em>callback</em>.</p>
<pre><code class="language-rust">use rhai::{Dynamic, FnPtr, NativeCallContext, EvalAltResult};

pub fn greet(context: NativeCallContext, callback: FnPtr) -&gt; Result&lt;String, Box&lt;EvalAltResult&gt;&gt;
{
    // Call the callback closure with the current evaluation context!
    let name = callback.call_within_context(&amp;context, ())?;
    Ok(format!("hello, {}!", name))
}</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="advanced-usage--restore-nativecallcontext"><a class="header" href="#advanced-usage--restore-nativecallcontext">Advanced Usage – Restore <code>NativeCallContext</code></a></h1>
<p>The <a href="rust//book/rust/context.html"><code>NativeCallContext</code></a> type encapsulates the entire <em>context</em> of a script up to the
particular point of the native Rust function call.</p>
<p>The data inside a <a href="rust//book/rust/context.html"><code>NativeCallContext</code></a> can be stored (as a type <code>NativeCallContextStore</code>) for later
use, when a new <a href="rust//book/rust/context.html"><code>NativeCallContext</code></a> can be constructed based on these stored data.</p>
<p>A reconstructed <a href="rust//book/rust/context.html"><code>NativeCallContext</code></a> acts almost the same as the original instance, so it is possible
to suspend the evaluation of a script, and to continue at a later time with a new
<a href="rust//book/rust/context.html"><code>NativeCallContext</code></a>.</p>
<p>Doing so requires the <a href="rust//book/start/features.html"><code>internals</code></a> feature to access internal APIs.</p>
<h3 id="step-1-store-nativecallcontext-data"><a class="header" href="#step-1-store-nativecallcontext-data">Step 1: Store <code>NativeCallContext</code> data</a></h3>
<pre><code class="language-rust">// Store context for later use
let context_data = context.store_data();

// ... store 'context_data' somewhere ...
secret_database.push(context_data);</code></pre>
<h3 id="step-2-restore-nativecallcontext"><a class="header" href="#step-2-restore-nativecallcontext">Step 2: Restore <code>NativeCallContext</code></a></h3>
<pre><code class="language-rust">// ... do something else ...

// Restore the context
let context_data = secret_database.get();

let new_context = context_data.create_context(&amp;engine);</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="override-a-built-in-function"><a class="header" href="#override-a-built-in-function">Override a Built-in Function</a></h1>
<p>Any similarly-named function defined in a script <em>overrides</em> any built-in or registered
native Rust function of the same name and number of parameters.</p>
<pre><code class="language-js">// Override the built-in function 'to_float' when called as a method
fn to_float() {
    print(`Ha! Gotcha! ${this}`);
    42.0
}

let x = 123.to_float();

print(x);       // what happens?
</code></pre>
<div id="admonition-tip-monkey-patching-rhai" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-monkey-patching-rhai-title">
<div class="admonition-title">
<div id="admonition-tip-monkey-patching-rhai-title">
<p>Tip: Monkey patching Rhai</p>
</div>
<a class="admonition-anchor-link" href="rust/override.html#admonition-tip-monkey-patching-rhai"></a>
</div>
<div>
<p>Most of Rhai’s built-in functionality resides in registered functions.</p>
<p>If you dislike any built-in function, simply provide your own implementation to
<em>override</em> the built-in version.</p>
<p>The ability to modify the operating environment dynamically at runtime is called
“<a href="https://en.wikipedia.org/wiki/Monkey_patch">monkey patching</a>.”
It is rarely recommended, but if you need it, you need it bad.</p>
<p>In other words, do it only when <em>all else fails</em>.  Do not monkey patch Rhai simply
because you <em>can</em>.</p>
</div>
</div>
<div id="admonition-search-order-for-functions" class="admonition admonish-info small" role="note" aria-labelledby="admonition-search-order-for-functions-title">
<div class="admonition-title">
<div id="admonition-search-order-for-functions-title">
<p>Search order for functions</p>
</div>
<a class="admonition-anchor-link" href="rust/override.html#admonition-search-order-for-functions"></a>
</div>
<div>
<p>Rhai searches for the correct implementation of a function in the following order:</p>
<ol>
<li>
<p>Rhai script-defined <a href="rust//book/language/functions.html">functions</a>,</p>
</li>
<li>
<p>Native Rust functions registered directly via the <code>Engine::register_XXX</code> API,</p>
</li>
<li>
<p>Native Rust functions in <a href="rust//book/rust/packages/index.html">packages</a> that have been loaded via <code>Engine::register_global_module</code>,</p>
</li>
<li>
<p>Native Rust or Rhai script-defined functions in <a href="rust//book/language/modules/import.html">imported</a> <a href="rust//book/rust/modules/index.html">modules</a> that are exposed to
the global <a href="rust//book/language/fn-namespaces.html">namespace</a> (e.g. via the <code>#[rhai_fn(global)]</code> attribute in a
<a href="rust//book/plugins/module.html">plugin module</a>),</p>
</li>
<li>
<p>Native Rust or Rhai script-defined functions in <a href="rust//book/rust/modules/index.html">modules</a> loaded via
<code>Engine::register_static_module</code> that are exposed to the global <a href="rust//book/language/fn-namespaces.html">namespace</a>
(e.g. via the <code>#[rhai_fn(global)]</code> attribute in a <a href="rust//book/plugins/module.html">plugin module</a>),</p>
</li>
<li>
<p><a href="rust//book/engine/builtin.html">Built-in</a> functions.</p>
</li>
</ol>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="call-rhai-functions-from-rust"><a class="header" href="#call-rhai-functions-from-rust">Call Rhai Functions from Rust</a></h1>
<p>Rhai also allows working <em>backwards</em> from the other direction – i.e. calling a Rhai-scripted
<a href="engine//book/language/functions.html">function</a> from Rust via <code>Engine::call_fn</code>.</p>
<pre><code class="language-rust">┌─────────────┐
│ Rhai script │
└─────────────┘

import "process" as proc;           // this is evaluated every time

fn hello(x, y) {
    // hopefully 'my_var' is in scope when this is called
    x.len + y + my_var
}

fn hello(x) {
    // hopefully 'my_string' is in scope when this is called
    x * my_string.len()
}

fn hello() {
    // hopefully 'MY_CONST' is in scope when this is called
    if MY_CONST {
        proc::process_data(42);     // can access imported module
    }
}


┌──────┐
│ Rust │
└──────┘

// Compile the script to AST
let ast = engine.compile(script)?;

// Create a custom 'Scope'
let mut scope = Scope::new();

// A custom 'Scope' can also contain any variables/constants available to
// the functions
scope.push("my_var", 42_i64);
scope.push("my_string", "hello, world!");
scope.push_constant("MY_CONST", true);

// Evaluate a function defined in the script, passing arguments into the
// script as a tuple.
//
// Beware, arguments must be of the correct types because Rhai does not
// have built-in type conversions. If arguments of the wrong types are passed,
// the Engine will not find the function.
//
// Variables/constants pushed into the custom 'Scope'
// (i.e. 'my_var', 'my_string', 'MY_CONST') are visible to the function.

let result = engine.call_fn::&lt;i64&gt;(&amp;mut scope, &amp;ast, "hello", ( "abc", 123_i64 ) )?;
//                            ^^^                             ^^^^^^^^^^^^^^^^^^
//              return type must be specified                 put arguments in a tuple

let result = engine.call_fn::&lt;i64&gt;(&amp;mut scope, &amp;ast, "hello", ( 123_i64, ) )?;
//                                                            ^^^^^^^^^^^^ tuple of one

let result = engine.call_fn::&lt;i64&gt;(&amp;mut scope, &amp;ast, "hello", () )?;
//                                                            ^^ unit = tuple of zero</code></pre>
<div id="admonition-warning-functions-with-one-parameter" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-warning-functions-with-one-parameter-title">
<div class="admonition-title">
<div id="admonition-warning-functions-with-one-parameter-title">
<p>Warning: Functions with one parameter</p>
</div>
<a class="admonition-anchor-link" href="engine/call-fn.html#admonition-warning-functions-with-one-parameter"></a>
</div>
<div>
<p>Functions with only one single parameter is easy to get wrong.</p>
<p>The proper Rust syntax is a <em>tuple with one item</em>:</p>
<pre><code class="language-rust">( arg , )</code></pre>
<p>Notice the comma (<code>,</code>) after the argument. Without it, the expression is a single value
<code>(arg)</code> which is the same as <code>arg</code> and not a tuple.</p>
<p>A syntax error with very confusing error message will be generated by the Rust compiler
if the comma is omitted.</p>
</div>
</div>
<div id="admonition-default-behavior" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-default-behavior-title">
<div class="admonition-title">
<div id="admonition-default-behavior-title">
<p>Default behavior</p>
</div>
<a class="admonition-anchor-link" href="engine/call-fn.html#admonition-default-behavior"></a>
</div>
<div>
<p>When using <code>Engine::call_fn</code>, the <a href="engine//book/engine/compile.html"><code>AST</code></a> is always evaluated <em>before</em> the <a href="engine//book/language/functions.html">function</a> is called.</p>
<p>This is usually desirable in order to <a href="engine//book/language/modules/import.html">import</a> the necessary external <a href="engine//book/rust/modules/index.html">modules</a> that are
needed by the <a href="engine//book/language/functions.html">function</a>.</p>
<p>All new <a href="engine//book/language/variables.html">variables</a>/<a href="engine//book/language/constants.html">constants</a> introduced are, by default, <em>not</em> retained inside the <a href="engine//book/engine/scope.html"><code>Scope</code></a>.
In other words, the <a href="engine//book/engine/scope.html"><code>Scope</code></a> is <em>rewound</em> before each call.</p>
<p>If these default behaviors are not desirable, override them with <code>Engine::call_fn_with_options</code>.</p>
</div>
</div>
<h2 id="funcargs-trait"><a class="header" href="#funcargs-trait"><code>FuncArgs</code> Trait</a></h2>
<div id="admonition-note" class="admonition admonish-note side" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="engine/call-fn.html#admonition-note"></a>
</div>
<div>
<p>Rhai implements <a href="engine//book/rust/traits.html"><code>FuncArgs</code></a> for tuples, arrays and <code>Vec&lt;T&gt;</code>.</p>
</div>
</div>
<p><code>Engine::call_fn</code> takes a parameter of any type that implements the <a href="engine//book/rust/traits.html"><code>FuncArgs</code></a> trait,
which is used to parse a data type into individual argument values for the <a href="engine//book/language/functions.html">function</a> call.</p>
<p>Custom types (e.g. structures) can also implement <a href="engine//book/rust/traits.html"><code>FuncArgs</code></a> so they can be used for
calling <code>Engine::call_fn</code>.</p>
<pre><code class="language-rust">use std::iter::once;
use rhai::FuncArgs;

// A struct containing function arguments
struct Options {
    pub foo: bool,
    pub bar: String,
    pub baz: i64
}

impl FuncArgs for Options {
    fn parse&lt;C: Extend&lt;Dynamic&gt;&gt;(self, container: &amp;mut C) {
        container.extend(once(self.foo.into()));
        container.extend(once(self.bar.into()));
        container.extend(once(self.baz.into()));
    }
}

let options = Options { foo: true, bar: "world", baz: 42 };

// The type 'Options' can now be used as argument to 'call_fn'
// to call a function with three parameters: fn hello(foo, bar, baz)
let result = engine.call_fn::&lt;i64&gt;(&amp;mut scope, &amp;ast, "hello", options)?;</code></pre>
<div id="admonition-warning-you-dont-need-this" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-warning-you-dont-need-this-title">
<div class="admonition-title">
<div id="admonition-warning-you-dont-need-this-title">
<p>Warning: You don’t need this</p>
</div>
<a class="admonition-anchor-link" href="engine/call-fn.html#admonition-warning-you-dont-need-this"></a>
</div>
<div>
<p>Implementing <code>FuncArgs</code> is almost never needed because Rhai works directly with
any <a href="engine//book/rust/custom-types.html">custom type</a>.</p>
<p>It is used only in niche cases where a <a href="engine//book/rust/custom-types.html">custom type’s</a> fields need
to be split up to pass to functions.</p>
</div>
</div>
<h2 id="enginecall_fn_with_options"><a class="header" href="#enginecall_fn_with_options"><code>Engine::call_fn_with_options</code></a></h2>
<p>For more control, use <code>Engine::call_fn_with_options</code>, which takes a type <code>CallFnOptions</code>:</p>
<pre><code class="language-rust">use rhai::{Engine, CallFnOptions};

let options = CallFnOptions::new()
                .eval_ast(false)            // do not evaluate the AST
                .rewind_scope(false)        // do not rewind the scope (i.e. keep new variables)
                .bind_this_ptr(&amp;mut state); // 'this' pointer

let result = engine.call_fn_with_options::&lt;i64&gt;(
                options,                    // options
                &amp;mut scope,                 // scope to use
                &amp;ast,                       // AST containing the functions
                "hello",                    // function entry-point
                ( "abc", 123_i64 )          // arguments
             )?;</code></pre>
<p><code>CallFnOptions</code> allows control of the following:</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th style="text-align: center">Type</th><th style="text-align: center">Default</th><th style="text-align: center">Build method</th><th>Description</th></tr></thead><tbody>
<tr><td><code>eval_ast</code></td><td style="text-align: center"><code>bool</code></td><td style="text-align: center"><code>true</code></td><td style="text-align: center"><code>eval_ast</code></td><td>evaluate the <a href="engine//book/engine/compile.html"><code>AST</code></a> before calling the target <a href="engine//book/language/functions.html">function</a> (useful to run <a href="engine//book/language/modules/import.html"><code>import</code></a> statements)</td></tr>
<tr><td><code>rewind_scope</code></td><td style="text-align: center"><code>bool</code></td><td style="text-align: center"><code>true</code></td><td style="text-align: center"><code>rewind_scope</code></td><td>rewind the custom <a href="engine//book/engine/scope.html"><code>Scope</code></a> at the end of the <a href="engine//book/language/functions.html">function</a> call so new local variables are removed</td></tr>
<tr><td><code>this_ptr</code></td><td style="text-align: center"><a href="engine//book/language/dynamic.html"><code>Option&lt;&amp;mut Dynamic&gt;</code></a></td><td style="text-align: center"><code>None</code></td><td style="text-align: center"><code>bind_this_ptr</code></td><td>bind the <code>this</code> pointer to a specific value</td></tr>
<tr><td><code>tag</code></td><td style="text-align: center"><a href="engine//book/language/dynamic.html"><code>Option&lt;Dynamic&gt;</code></a></td><td style="text-align: center"><code>None</code></td><td style="text-align: center"><code>with_tag</code></td><td>set the <em>custom state</em> for this evaluation (accessed via <a href="engine//book/rust/context.html"><code>NativeCallContext::tag</code></a>)</td></tr>
</tbody></table>
</div>
<h3 id="skip-evaluation-of-the-ast"><a class="header" href="#skip-evaluation-of-the-ast">Skip evaluation of the <code>AST</code></a></h3>
<p>By default, the <a href="engine//book/engine/compile.html"><code>AST</code></a> is evaluated before calling the target <a href="engine//book/language/functions.html">function</a>.</p>
<p>This is necessary to make sure that necessary <a href="engine//book/rust/modules/index.html">modules</a> imported via <a href="engine//book/language/modules/import.html"><code>import</code></a> statements are available.</p>
<p>Setting <code>eval_ast</code> to <code>false</code> skips this evaluation.</p>
<h3 id="keep-new-variablesconstants"><a class="header" href="#keep-new-variablesconstants">Keep new variables/constants</a></h3>
<p>By default, the <a href="engine//book/engine/hello-world.html"><code>Engine</code></a> <em>rewinds</em> the custom <a href="engine//book/engine/scope.html"><code>Scope</code></a> after each call to the initial size,
so any new <a href="engine//book/language/variables.html">variable</a>/<a href="engine//book/language/constants.html">constant</a> defined are cleared and will not spill into the custom <a href="engine//book/engine/scope.html"><code>Scope</code></a>.</p>
<p>This prevents the <a href="engine//book/engine/scope.html"><code>Scope</code></a> from being continuously polluted by new <a href="engine//book/language/variables.html">variables</a> and is usually the
intuitively expected behavior.</p>
<p>Setting <code>rewind_scope</code> to <code>false</code> retains new <a href="engine//book/language/variables.html">variables</a>/<a href="engine//book/language/constants.html">constants</a> within the custom <a href="engine//book/engine/scope.html"><code>Scope</code></a>.</p>
<p>This allows the <a href="engine//book/language/functions.html">function</a> to easily pass values back to the caller by leaving them inside the
custom <a href="engine//book/engine/scope.html"><code>Scope</code></a>.</p>
<div id="admonition-warning-new-variables-persist-in-scope" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-warning-new-variables-persist-in-scope-title">
<div class="admonition-title">
<div id="admonition-warning-new-variables-persist-in-scope-title">
<p>Warning: new variables persist in <code>Scope</code></p>
</div>
<a class="admonition-anchor-link" href="engine/call-fn.html#admonition-warning-new-variables-persist-in-scope"></a>
</div>
<div>
<p>If the <a href="engine//book/engine/scope.html"><code>Scope</code></a> is not rewound, beware that all <a href="engine//book/language/variables.html">variables</a>/<a href="engine//book/language/constants.html">constants</a> defined at top level of the
<a href="engine//book/language/functions.html">function</a> or in the script body will <em>persist</em> inside the custom <a href="engine//book/engine/scope.html"><code>Scope</code></a>.</p>
<p>If any of them are temporary and not intended to be retained, define them inside a statements block
(see example below).</p>
</div>
</div>
<pre><code class="language-rust">┌─────────────┐
│ Rhai script │
└─────────────┘

fn initialize() {
    let x = 42;                     // 'x' is retained
    let y = x * 2;                  // 'y' is retained

    // Use a new statements block to define temp variables
    {
        let temp = x + y;           // 'temp' is NOT retained

        foo = temp * temp;          // 'foo' is visible in the scope
    }
}

let foo = 123;                      // 'foo' is retained

// Use a new statements block to define temp variables
{
    let bar = foo / 2;              // 'bar' is NOT retained

    foo = bar * bar;
}


┌──────┐
│ Rust │
└──────┘

let options = CallFnOptions::new().rewind_scope(false);

engine.call_fn_with_options(options, &amp;mut scope, &amp;ast, "initialize", ())?;

// At this point, 'scope' contains these variables: 'foo', 'x', 'y'</code></pre>
<h3 id="bind-the-this-pointer"><a class="header" href="#bind-the-this-pointer">Bind the <code>this</code> pointer</a></h3>
<div id="admonition-note-1" class="admonition admonish-note side" role="note" aria-labelledby="admonition-note-1-title">
<div class="admonition-title">
<div id="admonition-note-1-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="engine/call-fn.html#admonition-note-1"></a>
</div>
<div>
<p><code>Engine::call_fn</code> cannot call functions in <em>method-call</em> style.</p>
</div>
</div>
<p><code>CallFnOptions</code> can also bind a value to the <code>this</code> pointer of a script-defined <a href="engine//book/language/functions.html">function</a>.</p>
<p>It is possible, then, to call a <a href="engine//book/language/functions.html">function</a> that uses <code>this</code>.</p>
<pre><code class="language-rust">let ast = engine.compile("fn action(x) { this += x; }")?;

let mut value: Dynamic = 1_i64.into();

let options = CallFnOptions::new()
                .eval_ast(false)
                .rewind_scope(false)
                .bind_this_ptr(&amp;mut value);

engine.call_fn_with_options(options, &amp;mut scope, &amp;ast, "action", ( 41_i64, ))?;

assert_eq!(value.as_int()?, 42);</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="create-a-rust-closure-from-a-rhai-function"><a class="header" href="#create-a-rust-closure-from-a-rhai-function">Create a Rust Closure from a Rhai Function</a></h1>
<div id="admonition-tip" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="engine/func.html#admonition-tip"></a>
</div>
<div>
<p>Very useful as callback functions!</p>
</div>
</div>
<p>It is possible to further encapsulate a script in Rust such that it becomes a normal Rust closure.</p>
<p>Creating them is accomplished via the <code>Func</code> trait which contains <code>create_from_script</code>
(as well as its companion method <code>create_from_ast</code>).</p>
<pre><code class="language-rust">use rhai::{Engine, Func};       // use 'Func' for 'create_from_script'

let engine = Engine::new();     // create a new 'Engine' just for this

let script = "fn calc(x, y) { x + y.len &lt; 42 }";

// Func takes two type parameters:
//   1) a tuple made up of the types of the script function's parameters
//   2) the return type of the script function
//
// 'func' will have type Box&lt;dyn Fn(i64, &amp;str) -&gt; Result&lt;bool, Box&lt;EvalAltResult&gt;&gt;&gt; and is callable!
let func = Func::&lt;(i64, &amp;str), bool&gt;::create_from_script(
//                ^^^^^^^^^^^ function parameter types in tuple

                engine,         // the 'Engine' is consumed into the closure
                script,         // the script, notice number of parameters must match
                "calc"          // the entry-point function name
)?;

func(123, "hello")? == false;   // call the closure

schedule_callback(func);        // pass it as a callback to another function

// Although there is nothing you can't do by manually writing out the closure yourself...
let engine = Engine::new();
let ast = engine.compile(script)?;
schedule_callback(Box::new(move |x: i64, y: String| {
    engine.call_fn::&lt;bool&gt;(&amp;mut Scope::new(), &amp;ast, "calc", (x, y))
}));</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="operator-overloading"><a class="header" href="#operator-overloading">Operator Overloading</a></h1>
<p>In Rhai, a lot of functionalities are actually implemented as functions, including basic operations
such as arithmetic calculations.</p>
<p>For example, in the expression “<code>a + b</code>”, the <code>+</code> <a href="rust//book/appendix/operators.html#operators">operator</a> actually calls a function named “<code>+</code>”!</p>
<pre><code class="language-rust">let x = a + b;

let x = +(a, b);        // &lt;- the above is equivalent to this function call</code></pre>
<p>Similarly, comparison <a href="rust//book/appendix/operators.html#operators">operators</a> including <code>==</code>, <code>!=</code> etc. are all implemented as functions,
with the stark exception of <code>&amp;&amp;</code>, <code>||</code> and <code>??</code>.</p>
<div id="admonition---and--cannot-be-overloaded" class="admonition admonish-warning small" role="note" aria-labelledby="admonition---and--cannot-be-overloaded-title">
<div class="admonition-title">
<div id="admonition---and--cannot-be-overloaded-title">
<p><code>&amp;&amp;</code>, <code>||</code> and <code>??</code> cannot be overloaded</p>
</div>
<a class="admonition-anchor-link" href="rust/operators.html#admonition---and--cannot-be-overloaded"></a>
</div>
<div>
<p>Because they <a href="rust//book/language/logic.html#boolean-operators"><em>short-circuit</em></a>, <code>&amp;&amp;</code>, <code>||</code> and <code>??</code> are
handled specially and <em>not</em> via a function.</p>
<p>Overriding them has no effect at all.</p>
</div>
</div>
<h2 id="overload-operator-via-rust-function"><a class="header" href="#overload-operator-via-rust-function">Overload Operator via Rust Function</a></h2>
<p><a href="rust//book/appendix/operators.html#operators">Operator</a> functions cannot be defined in script because <a href="rust//book/appendix/operators.html#operators">operators</a> are usually not valid function names.</p>
<p>However, <a href="rust//book/appendix/operators.html#operators">operator</a> functions <em>can</em> be registered via <code>Engine::register_fn</code>.</p>
<p>When a custom <a href="rust//book/appendix/operators.html#operators">operator</a> function is registered with the same name as an <a href="rust//book/appendix/operators.html#operators">operator</a>,
it <em>overrides</em> the built-in version.  However, make sure the <a href="rust//book/start/builds/performance.html#fast-operators-mode"><em>Fast Operators Mode</em></a>
is disabled; otherwise this will not work.</p>
<div id="admonition-must-turn-off-_fast-operators-mode_" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-must-turn-off-_fast-operators-mode_-title">
<div class="admonition-title">
<div id="admonition-must-turn-off-_fast-operators-mode_-title">
<p>Must turn off <em>Fast Operators Mode</em></p>
</div>
<a class="admonition-anchor-link" href="rust/operators.html#admonition-must-turn-off-_fast-operators-mode_"></a>
</div>
<div>
<p>The <a href="rust//book/start/builds/performance.html#fast-operators-mode"><em>Fast Operators Mode</em></a>, which is enabled by default, causes the <a href="rust//book/engine/hello-world.html"><code>Engine</code></a>
to <em>ignore</em> all custom-registered operator functions for <a href="rust//book/engine/builtin.html">built-in operators</a>.  This is for
performance considerations.</p>
<p>Disable <a href="rust//book/start/builds/performance.html#fast-operators-mode"><em>Fast Operators Mode</em></a> via <a href="rust//book/engine/options.html"><code>Engine::set_fast_operators</code></a>
in order for the overloaded operators to be used.</p>
</div>
</div>
<pre><code class="language-rust">use rhai::{Engine, EvalAltResult};

let mut engine = Engine::new();

fn strange_add(a: i64, b: i64) -&gt; i64 {
    (a + b) * 42
}

engine.register_fn("+", strange_add);               // overload '+' operator for two integers!

engine.set_fast_operators(false);                   // &lt;- IMPORTANT! must turn off Fast Operators Mode

let result: i64 = engine.eval("1 + 0");             // the overloading version is used

result == 42;

let result: f64 = engine.eval("1.0 + 0.0");         // '+' operator for two floats not overloaded

result == 1.0;

fn mixed_add(a: i64, b: bool) -&gt; f64 { a + if b { 42 } else { 99 } }

engine.register_fn("+", mixed_add);                 // register '+' operator for an integer and a bool

let result: i64 = engine.eval("1 + true");          // &lt;- normally an error...

result == 43;                                       //    ... but not now</code></pre>
<div id="admonition-considerations" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-considerations-title">
<div class="admonition-title">
<div id="admonition-considerations-title">
<p>Considerations</p>
</div>
<a class="admonition-anchor-link" href="rust/operators.html#admonition-considerations"></a>
</div>
<div>
<p>Use <a href="rust//book/appendix/operators.html#operators">operator</a> overloading for <a href="rust//book/rust/custom-types.html">custom types</a> only.</p>
<p>Be <strong>very careful</strong> when overriding built-in <a href="rust//book/appendix/operators.html#operators">operators</a> because users expect standard <a href="rust//book/appendix/operators.html#operators">operators</a> to
behave in a consistent and predictable manner, and will be annoyed if an expression involving <code>+</code>
turns into a subtraction, for example.  You may think it is amusing, but users who need to get
things done won’t.</p>
<p><a href="rust//book/appendix/operators.html#operators">Operator</a> overloading also impacts <a href="rust//book/engine/optimize/index.html">script optimization</a> when using <a href="rust//book/engine/optimize/index.html"><code>OptimizationLevel::Full</code></a>.
See the section on <a href="rust//book/engine/optimize/index.html">script optimization</a> for more details.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="working-with-any-rust-type"><a class="header" href="#working-with-any-rust-type">Working with Any Rust Type</a></h1>
<div id="admonition-tip-shared-types" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-shared-types-title">
<div class="admonition-title">
<div id="admonition-tip-shared-types-title">
<p>Tip: Shared types</p>
</div>
<a class="admonition-anchor-link" href="rust/custom-types.html#admonition-tip-shared-types"></a>
</div>
<div>
<p>The only requirement of a type to work with Rhai is <code>Clone</code>.</p>
<p>Therefore, it is extremely easy to use Rhai with data types such as
<code>Rc&lt;...&gt;</code>, <code>Arc&lt;...&gt;</code>, <code>Rc&lt;RefCell&lt;...&gt;&gt;</code>, <code>Arc&lt;Mutex&lt;...&gt;&gt;</code> etc.</p>
</div>
</div>
<div id="admonition-under-sync" class="admonition admonish-note side" role="note" aria-labelledby="admonition-under-sync-title">
<div class="admonition-title">
<div id="admonition-under-sync-title">
<p>Under <code>sync</code></p>
</div>
<a class="admonition-anchor-link" href="rust/custom-types.html#admonition-under-sync"></a>
</div>
<div>
<p>If the <a href="rust//book/start/features.html"><code>sync</code></a> feature is used, a custom type must also be <code>Send + Sync</code>.</p>
</div>
</div>
<p>Rhai works seamlessly with any Rust type, as long as it implements <code>Clone</code> as this allows the
<a href="rust//book/engine/hello-world.html"><code>Engine</code></a> to pass by value.</p>
<p>A type that is not one of the <a href="rust//book/language/values-and-types.html">standard types</a> is termed a “custom type”.</p>
<p>Custom types can have the following:</p>
<ul>
<li>
<p>a custom (friendly) display name</p>
</li>
<li>
<p><a href="rust//book/rust/methods.html">methods</a></p>
</li>
<li>
<p><a href="rust/getters/setters">property getters and setters</a></p>
</li>
<li>
<p><a href="rust//book/rust/indexers.html">indexers</a></p>
</li>
</ul>
<h2 id="free-typing"><a class="header" href="#free-typing">Free Typing</a></h2>
<div id="admonition-why-custom" class="admonition admonish-question side" role="note" aria-labelledby="admonition-why-custom-title">
<div class="admonition-title">
<div id="admonition-why-custom-title">
<p>Why “Custom”?</p>
</div>
<a class="admonition-anchor-link" href="rust/custom-types.html#admonition-why-custom"></a>
</div>
<div>
<p>Rhai internally supports a number of standard data types (see <a href="rust//book/language/values-and-types.html">this list</a>).</p>
<p>Any type outside of the list is considered <em>custom</em>.</p>
</div>
</div>
<div id="admonition-custom-types-are-slower" class="admonition admonish-warning side" role="note" aria-labelledby="admonition-custom-types-are-slower-title">
<div class="admonition-title">
<div id="admonition-custom-types-are-slower-title">
<p>Custom types are slower</p>
</div>
<a class="admonition-anchor-link" href="rust/custom-types.html#admonition-custom-types-are-slower"></a>
</div>
<div>
<p>Custom types run <em>slower</em> than <a href="rust//book/language/values-and-types.html">built-in types</a> due to an additional
level of indirection, but for all other purposes there is no difference.</p>
</div>
</div>
<p>Rhai works seamlessly with <em>any</em> Rust type.</p>
<p>A custom type is stored in Rhai as a Rust <em>trait object</em> (specifically, a <code>dyn rhai::Variant</code>),
with no restrictions other than being <code>Clone</code> (plus <code>Send + Sync</code> under the <a href="rust//book/start/features.html"><code>sync</code></a> feature).</p>
<p>The type literally does not have any prerequisite other than being <code>Clone</code>.</p>
<p>It does not need to implement any other trait or use any custom <code>#[derive]</code>.</p>
<p>This allows Rhai to be integrated into an existing Rust code base with as little plumbing as
possible, usually silently and seamlessly.</p>
<p>External types that are not defined within the same crate (and thus cannot implement special Rhai
traits or use special <code>#[derive]</code>) can also be used easily with Rhai.</p>
<p>Support for custom types can be turned off via the <a href="rust//book/start/features.html"><code>no_object</code></a> feature.</p>
<h2 id="register-api"><a class="header" href="#register-api">Register API</a></h2>
<p>For Rhai scripts to interact with the custom type, and API must be registered for it with the <a href="rust//book/engine/hello-world.html"><code>Engine</code></a>.</p>
<p>The API can consist of functions, <a href="rust//book/rust/methods.html">methods</a>, property <a href="rust//book/rust/getters-setters.html">getters/setters</a>, <a href="rust//book/rust/indexers.html">indexers</a>,
<a href="rust//book/language/iterator.html">iterators</a> etc.</p>
<p>There are three ways to register an API for a custom type.</p>
<h3 id="1-auto-generate-api"><a class="header" href="#1-auto-generate-api">1. Auto-Generate API</a></h3>
<p>If you have complete control of the type, then this is the easiest way.</p>
<p>The <a href="rust/derive-custom-type.html"><code>#[derive(CustomType)]</code></a> macro can be used to automatically generate an
API for a custom type via the <a href="rust//book/rust/build-type.html"><code>CustomType</code></a> trait.</p>
<h3 id="2-custom-type-builder"><a class="header" href="#2-custom-type-builder">2. Custom Type Builder</a></h3>
<p>For types in the same crate that you do not control, each function, <a href="rust//book/rust/methods.html">method</a>, property <a href="rust//book/rust/getters-setters.html">getter/setter</a>,
<a href="rust//book/rust/indexers.html">indexer</a> and <a href="rust//book/language/iterator.html">iterator</a> can be registered manually, as a single package, via the <a href="rust//book/rust/build-type.html"><code>CustomType</code></a> trait
using the <em>Custom Type Builder</em>.</p>
<h3 id="3-manual-registration"><a class="header" href="#3-manual-registration">3. Manual Registration</a></h3>
<p>For external types that cannot implement the <a href="rust//book/rust/build-type.html"><code>CustomType</code></a> trait due to Rust’s <a href="https://doc.rust-lang.org/book/ch10-02-traits.html"><em>orphan rule</em></a>,
each function, <a href="rust//book/rust/methods.html">method</a>, property <a href="rust//book/rust/getters-setters.html">getter/setter</a>, <a href="rust//book/rust/indexers.html">indexer</a> and <a href="rust//book/language/iterator.html">iterator</a>
must be registered manually with the <a href="rust//book/engine/hello-world.html"><code>Engine</code></a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="auto-generate-api-for-custom-type"><a class="header" href="#auto-generate-api-for-custom-type">Auto-Generate API for Custom Type</a></h1>
<div id="admonition-warning" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="rust/derive-custom-type.html#admonition-warning"></a>
</div>
<div>
<p>This assumes that you have complete control of the type and can do whatever you want with it
(such as putting attributes on fields).</p>
<p>In particular, the type must be defined within the current crate.</p>
</div>
</div>
<p>To register a type and its API for use with an <a href="rust//book/engine/hello-world.html"><code>Engine</code></a>, the simplest method is via the <a href="rust//book/rust/build-type.html"><code>CustomType</code></a> trait.</p>
<p>A custom derive macro is provided to auto-implement <a href="rust//book/rust/build-type.html"><code>CustomType</code></a> on any <code>struct</code> type,
which exposes all the type’s fields to an <a href="rust//book/engine/hello-world.html"><code>Engine</code></a> all at once.</p>
<p>It is as simple as adding <code>#[derive(CustomType)]</code> to the type definition.</p>
<pre><code class="language-rust">use rhai::{CustomType, TypeBuilder};    // &lt;- necessary imports

#[derive(Clone, CustomType)]            // &lt;- auto-implement 'CustomType'
pub struct Vec3 {                       //    for normal structs
    pub x: i64,
    pub y: i64,
    pub z: i64,
}

#[derive(Clone, CustomType)]            // &lt;- auto-implement 'CustomType'
pub struct ABC(i64, bool, String);      //    for tuple structs

let mut engine = Engine::new();

// Register the custom types!
engine.build_type::&lt;Vec3&gt;()
      .build_type::&lt;ABC&gt;();</code></pre>
<h2 id="custom-attribute-options"><a class="header" href="#custom-attribute-options">Custom Attribute Options</a></h2>
<p>The <code>rhai_type</code> attribute, with options, can be added to the fields of the type to customize the auto-generated API.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Option</th><th style="text-align: center">Applies to</th><th style="text-align: center">Value</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>name</code></td><td style="text-align: center">type, field</td><td style="text-align: center">string expression</td><td>use this name instead of the type/field name.</td></tr>
<tr><td style="text-align: center"><code>skip</code></td><td style="text-align: center">field</td><td style="text-align: center"><em>none</em></td><td>skip this field; cannot be used with any other attribute.</td></tr>
<tr><td style="text-align: center"><code>readonly</code></td><td style="text-align: center">field</td><td style="text-align: center"><em>none</em></td><td>only auto-generate getter, no setter; cannot be used with <code>set</code>.</td></tr>
<tr><td style="text-align: center"><code>get</code></td><td style="text-align: center">field</td><td style="text-align: center">function path</td><td>use this getter function (with <code>&amp;self</code>) instead of the auto-generated getter; if <code>get_mut</code> is also set, this is ignored.</td></tr>
<tr><td style="text-align: center"><code>get_mut</code></td><td style="text-align: center">field</td><td style="text-align: center">function path</td><td>use this getter function (with <code>&amp;mut self</code>) instead of the auto-generated getter.</td></tr>
<tr><td style="text-align: center"><code>set</code></td><td style="text-align: center">field</td><td style="text-align: center">function path</td><td>use this setter function instead of the auto-generated setter; cannot be used with <code>readonly</code>.</td></tr>
<tr><td style="text-align: center"><code>extra</code></td><td style="text-align: center">type</td><td style="text-align: center">function path</td><td>call this function after building the type to add additional APIs</td></tr>
</tbody></table>
</div>
<h3 id="function-signatures"><a class="header" href="#function-signatures">Function signatures</a></h3>
<p>The signature of the function for <code>get</code> is:</p>
<blockquote>
<pre><code class="language-rust">Fn(&amp;T) -&gt; V</code></pre>
</blockquote>
<p>The signature of the function for <code>get_mut</code> is:</p>
<blockquote>
<pre><code class="language-rust">Fn(&amp;mut T) -&gt; V</code></pre>
</blockquote>
<p>The signature of the function for <code>set</code> is:</p>
<blockquote>
<pre><code class="language-rust">Fn(&amp;mut T, V)</code></pre>
</blockquote>
<p>The signature of the function for <code>extra</code> is:</p>
<blockquote>
<pre><code class="language-rust">Fn(&amp;mut TypeBuilder&lt;T&gt;)</code></pre>
</blockquote>
<h3 id="example-5"><a class="header" href="#example-5">Example</a></h3>
<pre><code class="language-rust">use rhai::{CustomType, TypeBuilder};    // &lt;- necessary imports

#[derive(Debug, Clone)]
#[derive(CustomType)]                   // &lt;- auto-implement 'CustomType'
pub struct ABC(
    #[rhai_type(skip)]                  // &lt;- 'field0' not included
    i64,

    #[rhai_type(readonly)]              // &lt;- only auto getter, no setter for 'field1'
    i64,
    
    #[rhai_type(name = "flag")]         // &lt;- override property name for 'field2'
    bool,
    
    String                              // &lt;- auto getter/setter for 'field3'
);

#[derive(Default, Clone)]
#[derive(CustomType)]                   // &lt;- auto-implement 'CustomType'
#[rhai_type(name = "MyFoo", extra = Self::build_extra)] // &lt;- call this type 'MyFoo' and use 'build_extra' to add additional APIs
pub struct Foo {
    #[rhai_type(skip)]                  // &lt;- field not included
    dummy: i64,

    #[rhai_type(readonly)]              // &lt;- only auto getter, no setter for 'bar'
    bar: i64,

    #[rhai_type(name = "flag")]         // &lt;- override property name
    baz: bool,                          // &lt;- auto getter/setter for 'baz'

    #[rhai_type(get = Self::qux)]       // &lt;- call custom getter (with '&amp;self') for 'qux'
    qux: char,                          // &lt;- auto setter for 'qux'

    #[rhai_type(set = Self::set_hello)] // &lt;- call custom setter for 'hello'
    hello: String                       // &lt;- auto getter for 'hello'
}

impl Foo {
    /// Regular field getter function with `&amp;self`
    pub fn qux(&amp;self) -&gt; char {
        self.qux
    }

    /// Special setter implementation for `hello`
    pub fn set_hello(&amp;mut self, value: String) {
        self.hello = if self.baz {
            let mut s = self.hello.clone();
            s.push_str(&amp;value);
            for _ in 0..self.bar { s.push('!'); }
            s
        } else {
            value
        };
    }

    /// Additional APIs
    fn build_extra(builder: &amp;mut TypeBuilder&lt;Self&gt;) {
        // Register constructor function
        builder.with_fn("new_foo", || Self::default());
    }
}

#[derive(Debug, Clone, Eq, PartialEq, CustomType)]
#[rhai_fn(extra = vec3_build_extra)]
pub struct Vec3 {
    #[rhai_type(get = Self::x, set = Self::set_x)]
    x: i64,
    #[rhai_type(get = Self::y, set = Self::set_y)]
    y: i64,
    #[rhai_type(get = Self::z, set = Self::set_z)]
    z: i64,
}

impl Vec3 {
    fn new(x: i64, y: i64, z: i64) -&gt; Self { Self { x, y, z } }
    fn x(&amp;self) -&gt; i64 { self.x }
    fn set_x(&amp;mut self, x: i64) { self.x = x }
    fn y(&amp;self) -&gt; i64 { self.y }
    fn set_y(&amp;mut self, y: i64) { self.y = y }
    fn z(&amp;self) -&gt; i64 { self.z }
    fn set_z(&amp;mut self, z: i64) { self.z = z }
}

fn vec3_build_extra(builder: &amp;mut TypeBuilder&lt;Self&gt;) {
    // Register constructor function
    builder.with_fn("Vec3", Self::new);
}</code></pre>
<div id="admonition-tldr--the-above-is-equivalent-to-this" class="admonition admonish-question" role="note" aria-labelledby="admonition-tldr--the-above-is-equivalent-to-this-title">
<div class="admonition-title">
<div id="admonition-tldr--the-above-is-equivalent-to-this-title">
<p>TL;DR – The above is equivalent to this…</p>
</div>
<a class="admonition-anchor-link" href="rust/derive-custom-type.html#admonition-tldr--the-above-is-equivalent-to-this"></a>
</div>
<div>
<pre><code class="language-rust">impl CustomType for ABC {
    fn build(mut builder: TypeBuilder&lt;Self&gt;)
    {
        builder.with_name("ABC");
        builder.with_get("field1", |obj: &amp;mut Self| obj.1.clone());
        builder.with_get_set("flag",
            |obj: &amp;mut Self| obj.2.clone(),
            |obj: &amp;mut Self, val| obj.2 = val
        );
        builder.with_get_set("field3",
            |obj: &amp;mut Self| obj.3.clone(),
            |obj: &amp;mut Self, val| obj.3 = val
        );
    }
}

impl CustomType for Foo {
    fn build(mut builder: TypeBuilder&lt;Self&gt;)
    {
        builder.with_name("MyFoo");
        builder.with_get("bar", |obj: &amp;mut Self| obj.bar.clone());
        builder.with_get_set("flag",
            |obj: &amp;mut Self| obj.baz.clone(),
            |obj: &amp;mut Self, val| obj.baz = val
        );
        builder.with_get_set("qux",
            |obj: &amp;Self| Self::qux(&amp;*obj)),
            |obj: &amp;mut Self, val| obj.qux = val
        )
        builder.with_get_set("hello",
            |obj: &amp;mut Self| obj.hello.clone(),
            Self::set_hello
        );
        Self::build_extra(&amp;mut builder);
    }
}

impl CustomType for Vec3 {
    fn build(mut builder: TypeBuilder&lt;Self&gt;)
    {
        builder.with_name("Vec3");
        builder.with_get_set("x", |obj: &amp;mut Self| Self::x(&amp;*obj), Self::set_x);
        builder.with_get_set("y", |obj: &amp;mut Self| Self::y(&amp;*obj), Self::set_y);
        builder.with_get_set("z", |obj: &amp;mut Self| Self::z(&amp;*obj), Self::set_z);
        vec3_build_extra(&amp;mut builder);
    }
}</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="register-a-custom-type-via-the-type-builder"><a class="header" href="#register-a-custom-type-via-the-type-builder">Register a Custom Type via the Type Builder</a></h1>
<div id="admonition-warning" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="rust/build-type.html#admonition-warning"></a>
</div>
<div>
<p>This assumes that the type is defined within the current crate and you can implement traits for it.</p>
<p>However, you may not <em>control</em> the type (it may be auto-generated or maintained by another user),
so you cannot put attributes on it.</p>
</div>
</div>
<p>It is usually convenient to package a <a href="rust//book/rust/custom-types.html">custom type</a>’s API (i.e. <a href="rust//book/rust/methods.html">methods</a>,
<a href="rust//book/rust/getters-setters.html">properties</a>, <a href="rust//book/rust/indexers.html">indexers</a> and <a href="rust//book/language/iterator.html">type iterators</a>) together such that they can be more
easily managed.</p>
<p>This can be achieved by manually implementing the <code>CustomType</code> trait, which contains only a single method:</p>
<blockquote>
<pre><code class="language-rust">fn build(builder: TypeBuilder&lt;T&gt;)</code></pre>
</blockquote>
<p>The <code>TypeBuilder</code> parameter provides a range of convenient methods to register <a href="rust//book/rust/methods.html">methods</a>, property
<a href="rust//book/rust/getters-setters.html">getters/setters</a>, <a href="rust//book/rust/indexers.html">indexers</a> and <a href="rust//book/language/iterator.html">type iterators</a> of a <a href="rust//book/rust/custom-types.html">custom type</a>:</p>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody>
<tr><td><code>with_name</code></td><td>set a friendly name</td></tr>
<tr><td><code>on_print</code></td><td>register the <a href="rust//book/rust/print-custom.html"><code>to_string</code></a> function that pretty-prints the <a href="rust//book/rust/custom-types.html">custom type</a></td></tr>
<tr><td><code>on_debug</code></td><td>register the <a href="rust//book/rust/print-custom.html"><code>to_debug</code></a> function that debug-prints the <a href="rust//book/rust/custom-types.html">custom type</a></td></tr>
<tr><td><code>with_fn</code></td><td>register a <a href="rust//book/rust/methods.html">method</a> (or any function really)</td></tr>
<tr><td><code>with_get</code></td><td>register a property <a href="rust//book/rust/getters-setters.html">getter</a></td></tr>
<tr><td><code>with_set</code></td><td>register a property <a href="rust//book/rust/getters-setters.html">getter</a></td></tr>
<tr><td><code>with_get_set</code></td><td>register property <a href="rust//book/rust/getters-setters.html">getters/setters</a></td></tr>
<tr><td><code>with_indexer_get</code></td><td>register an <a href="rust//book/rust/indexers.html">indexer</a> get function</td></tr>
<tr><td><code>with_indexer_set</code></td><td>register an <a href="rust//book/rust/indexers.html">indexer</a> set function</td></tr>
<tr><td><code>with_indexer_get_set</code></td><td>register <a href="rust//book/rust/indexers.html">indexer</a> get/set functions</td></tr>
<tr><td><code>is_iterable</code></td><td>automatically register a <a href="rust//book/language/iterator.html">type iterator</a> if the <a href="rust//book/rust/custom-types.html">custom type</a> is iterable</td></tr>
</tbody></table>
</div><div id="admonition-tip-use-plugin-module-if-starting-from-scratch" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-use-plugin-module-if-starting-from-scratch-title">
<div class="admonition-title">
<div id="admonition-tip-use-plugin-module-if-starting-from-scratch-title">
<p>Tip: Use plugin module if starting from scratch</p>
</div>
<a class="admonition-anchor-link" href="rust/build-type.html#admonition-tip-use-plugin-module-if-starting-from-scratch"></a>
</div>
<div>
<p>The <code>CustomType</code> trait is typically used on external types that are already defined.</p>
<p>To define a <a href="rust//book/rust/custom-types.html">custom type</a> and implement its API from scratch, it is more convenient to use a <a href="rust//book/plugins/module.html">plugin module</a>.</p>
</div>
</div>
<h2 id="example-6"><a class="header" href="#example-6">Example</a></h2>
<pre><code class="language-rust">// Custom type
#[derive(Debug, Clone, Eq, PartialEq)]
struct Vec3 {
    x: i64,
    y: i64,
    z: i64,
}

// Custom type API
impl Vec3 {
    fn new(x: i64, y: i64, z: i64) -&gt; Self {
        Self { x, y, z }
    }
    fn get_x(&amp;mut self) -&gt; i64 {
        self.x
    }
    fn set_x(&amp;mut self, x: i64) {
        self.x = x
    }
    fn get_y(&amp;mut self) -&gt; i64 {
        self.y
    }
    fn set_y(&amp;mut self, y: i64) {
        self.y = y
    }
    fn get_z(&amp;mut self) -&gt; i64 {
        self.z
    }
    fn set_z(&amp;mut self, z: i64) {
        self.z = z
    }
}

// The custom type can even be iterated!
impl IntoIterator for Vec3 {
    type Item = i64;
    type IntoIter = std::vec::IntoIter&lt;Self::Item&gt;;

    fn into_iter(self) -&gt; Self::IntoIter {
        vec![self.x, self.y, self.z].into_iter()
    }
}

// Use 'CustomType' to register the entire API
impl CustomType for Vec3 {
    fn build(mut builder: TypeBuilder&lt;Self&gt;) {
        builder
            .with_name("Vec3")
            .with_fn("vec3", Self::new)
            .is_iterable()
            .with_get_set("x", Self::get_x, Self::set_x)
            .with_get_set("y", Self::get_y, Self::set_y)
            .with_get_set("z", Self::get_z, Self::set_z)
            // Indexer get/set functions that do not panic on invalid indices
            .with_indexer_get_set(
                |vec: &amp;mut Self, idx: i64) -&gt; Result&lt;i64, Box&lt;EvalAltResult&gt;&gt; {
                    match idx {
                        0 =&gt; Ok(vec.x),
                        1 =&gt; Ok(vec.y),
                        2 =&gt; Ok(vec.z),
                        _ =&gt; Err(EvalAltResult::ErrorIndexNotFound(idx.Into(), Position::NONE).into()),
                    }
                },
                |vec: &amp;mut Self, idx: i64, value: i64) -&gt; Result&lt;(), Box&lt;EvalAltResult&gt;&gt; {
                    match idx {
                        0 =&gt; vec.x = value,
                        1 =&gt; vec.y = value,
                        2 =&gt; vec.z = value,
                        _ =&gt; Err(EvalAltResult::ErrorIndexNotFound(idx.Into(), Position::NONE).into()),
                    }
                    Ok(())
                }
            );
    }
}

let mut engine = Engine::new();

// Register the custom type in one go!
engine.build_type::&lt;Vec3&gt;();</code></pre>
<div id="admonition-tldr--why-isnt-there-is_indexable" class="admonition admonish-question" role="note" aria-labelledby="admonition-tldr--why-isnt-there-is_indexable-title">
<div class="admonition-title">
<div id="admonition-tldr--why-isnt-there-is_indexable-title">
<p>TL;DR – Why isn’t there <code>is_indexable</code>?</p>
</div>
<a class="admonition-anchor-link" href="rust/build-type.html#admonition-tldr--why-isnt-there-is_indexable"></a>
</div>
<div>
<p>Technically speaking, <code>TypeBuilder</code> can automatically register an <a href="rust//book/rust/indexers.html">indexer</a> get function if the <a href="rust//book/rust/custom-types.html">custom type</a> implements <code>Index</code>.
Similarly, it can automatically register an <a href="rust//book/rust/indexers.html">indexer</a> set function for <code>IndexMut</code>.</p>
<p>In practice, however, this is usually not desirable because most <code>Index</code>/<code>IndexMut</code> implementations panic on invalid indices.</p>
<p>For Rhai, it is necessary to handle invalid indices properly by returning an error.</p>
<p>Therefore, in the example above, the <code>with_indexer_get_set</code> method properly handles invalid indices by returning errors.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="manually-register-custom-type"><a class="header" href="#manually-register-custom-type">Manually Register Custom Type</a></h1>
<div id="admonition-warning" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="rust/reg-custom-type.html#admonition-warning"></a>
</div>
<div>
<p>This assumes that the type is defined in an external crate and so the <a href="rust//book/rust/build-type.html"><code>CustomType</code></a> trait
cannot be implemented for it due to Rust’s <a href="https://doc.rust-lang.org/book/ch10-02-traits.html"><em>orphan rule</em></a>.</p>
</div>
</div>
<div id="admonition-tip-working-with-enums" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-working-with-enums-title">
<div class="admonition-title">
<div id="admonition-tip-working-with-enums-title">
<p>Tip: Working with enums</p>
</div>
<a class="admonition-anchor-link" href="rust/reg-custom-type.html#admonition-tip-working-with-enums"></a>
</div>
<div>
<p>It is also possible to use Rust enums with Rhai.</p>
<p>See the pattern <a href="rust//book/patterns/enums.html">Working with Enums</a> for more details.</p>
</div>
</div>
<p>The custom type needs to be <em>registered</em> into an <a href="rust//book/engine/hello-world.html"><code>Engine</code></a> via:</p>
<div class="table-wrapper"><table><thead><tr><th><code>Engine</code> API</th><th><code>type_of</code> output</th></tr></thead><tbody>
<tr><td><code>register_type::&lt;T&gt;</code></td><td>full Rust path name</td></tr>
<tr><td><code>register_type_with_name::&lt;T&gt;</code></td><td>friendly name</td></tr>
</tbody></table>
</div>
<pre><code class="language-rust">use rhai::{Engine, EvalAltResult};

#[derive(Debug, Clone)]
struct TestStruct {
    field: i64
}

impl TestStruct {
    fn new() -&gt; Self {
        Self { field: 1 }
    }
}

let mut engine = Engine::new();

// Register custom type with friendly name
engine.register_type_with_name::&lt;TestStruct&gt;("TestStruct")
      .register_fn("new_ts", TestStruct::new);

// Cast result back to custom type.
let result = engine.eval::&lt;TestStruct&gt;(
"
    new_ts()        // calls 'TestStruct::new'
")?;

println!("result: {}", result.field);   // prints 1
</code></pre>
<h2 id="type_of-a-custom-type"><a class="header" href="#type_of-a-custom-type"><code>type_of()</code> a Custom Type</a></h2>
<div id="admonition-giving-types-the-same-name" class="admonition admonish-question side wide" role="note" aria-labelledby="admonition-giving-types-the-same-name-title">
<div class="admonition-title">
<div id="admonition-giving-types-the-same-name-title">
<p>Giving types the same name?</p>
</div>
<a class="admonition-anchor-link" href="rust/reg-custom-type.html#admonition-giving-types-the-same-name"></a>
</div>
<div>
<p>It is OK to register several custom types under the <em>same</em> friendly name
and <code>type_of()</code> will faithfully return it.</p>
<p>How this might possibly be useful is left to the imagination of the user.</p>
</div>
</div>
<p><a href="rust//book/language/type-of.html"><code>type_of()</code></a> works fine with custom types and returns the name of the type.</p>
<p>If <code>Engine::register_type_with_name</code> is used to register the custom type with a special
“pretty-print” friendly name, <a href="rust//book/language/type-of.html"><code>type_of()</code></a> will return that name instead.</p>
<pre><code class="language-rust">engine.register_type::&lt;TestStruct1&gt;()
      .register_fn("new_ts1", TestStruct1::new)
      .register_type_with_name::&lt;TestStruct2&gt;("TestStruct")
      .register_fn("new_ts2", TestStruct2::new);

let ts1_type = engine.eval::&lt;String&gt;("let x = new_ts1(); x.type_of()")?;
let ts2_type = engine.eval::&lt;String&gt;("let x = new_ts2(); x.type_of()")?;

println!("{ts1_type}");                 // prints 'path::to::TestStruct'
println!("{ts2_type}");                 // prints 'TestStruct'</code></pre>
<h2 id="-operator"><a class="header" href="#-operator"><code>==</code> Operator</a></h2>
<p>Many standard functions (e.g. filtering, searching and sorting) expect a custom type to be
<em>comparable</em>, meaning that the <code>==</code> operator must be registered for the custom type.</p>
<p>For example, in order to use the <a href="rust//book/language/in.html"><code>in</code></a> operator with a custom type for an <a href="rust//book/language/arrays.html">array</a>,
the <code>==</code> operator is used to check whether two values are the same.</p>
<pre><code class="language-rust">// Assume 'TestStruct' implements `PartialEq`
engine.register_fn("==",
    |item1: &amp;mut TestStruct, item2: TestStruct| item1 == &amp;item2
);

// Then this works in Rhai:
let item = new_ts();        // construct a new 'TestStruct'
item in array;              // 'in' operator uses '=='</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="methods"><a class="header" href="#methods">Methods</a></h1>
<p>Methods of <a href="rust//book/rust/custom-types.html">custom types</a> are registered via <code>Engine::register_fn</code>.</p>
<pre><code class="language-rust">use rhai::{Engine, EvalAltResult};

#[derive(Debug, Clone)]
struct TestStruct {
    field: i64
}

impl TestStruct {
    fn new() -&gt; Self {
        Self { field: 1 }
    }

    fn update(&amp;mut self, x: i64) {      // methods take &amp;mut as first parameter
        self.field += x;
    }
}

let mut engine = Engine::new();

// Most Engine APIs can be chained up.
engine.register_type_with_name::&lt;TestStruct&gt;("TestStruct")
      .register_fn("new_ts", TestStruct::new)
      .register_fn("update", TestStruct::update);

// Cast result back to custom type.
let result = engine.eval::&lt;TestStruct&gt;(
"
    let x = new_ts();                   // calls 'TestStruct::new'
    x.update(41);                       // calls 'TestStruct::update'
    x                                   // 'x' holds a 'TestStruct'
")?;

println!("result: {}", result.field);   // prints 42</code></pre>
<h2 id="first-parameter-must-be-mut"><a class="header" href="#first-parameter-must-be-mut">First Parameter Must be <code>&amp;mut</code></a></h2>
<p><em>Methods</em> of <a href="rust//book/rust/custom-types.html">custom types</a> take a <code>&amp;mut</code> first parameter to that type, so that invoking methods can
always update it.</p>
<p>All other parameters in Rhai are passed by value (i.e. clones).</p>
<div id="admonition-no-support-for-references" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-no-support-for-references-title">
<div class="admonition-title">
<div id="admonition-no-support-for-references-title">
<p>No support for references</p>
</div>
<a class="admonition-anchor-link" href="rust/methods.html#admonition-no-support-for-references"></a>
</div>
<div>
<p>Rhai does NOT support normal references (i.e. <code>&amp;T</code>) as parameters.
All references must be mutable (i.e. <code>&amp;mut T</code>).</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="call-method-as-function"><a class="header" href="#call-method-as-function">Call Method as Function</a></h1>
<h2 id="method-call-style-vs-function-call-style"><a class="header" href="#method-call-style-vs-function-call-style">Method-Call Style vs. Function-Call Style</a></h2>
<h3 id="method-call-syntax"><a class="header" href="#method-call-syntax">Method-call syntax</a></h3>
<blockquote>
<p><em>object</em> <code>.</code> <em>function</em> <code>(</code> <em>parameter</em><code>,</code> … <code>,</code> <em>parameter</em><code>)</code></p>
</blockquote>
<div id="admonition-_method-call_-style-not-supported-under-no_object" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-_method-call_-style-not-supported-under-no_object-title">
<div class="admonition-title">
<div id="admonition-_method-call_-style-not-supported-under-no_object-title">
<p><em>Method-call</em> style not supported under <a href="rust//book/start/features.html"><code>no_object</code></a></p>
</div>
<a class="admonition-anchor-link" href="rust/methods-fn-call.html#admonition-_method-call_-style-not-supported-under-no_object"></a>
</div>
<div>
<pre><code class="language-rust">// Below is a syntax error under 'no_object'.
engine.run("let x = [42]; x.clear();")?;
                        // ^ cannot call method-style</code></pre>
</div>
</div>
<h3 id="function-call-syntax"><a class="header" href="#function-call-syntax">Function-call syntax</a></h3>
<blockquote>
<p><em>function</em> <code>(</code> <em>object</em><code>,</code> <em>parameter</em><code>,</code> … <code>,</code> <em>parameter</em><code>)</code></p>
</blockquote>
<h3 id="equivalence"><a class="header" href="#equivalence">Equivalence</a></h3>
<div id="admonition-note" class="admonition admonish-note side" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="rust/methods-fn-call.html#admonition-note"></a>
</div>
<div>
<p>This design is similar to Rust.</p>
</div>
</div>
<p>Internally, methods on a <a href="rust//book/rust/custom-types.html">custom type</a> is <em>the same</em> as a function taking a <code>&amp;mut</code> first argument of
the object’s type.</p>
<p>Therefore, methods and functions can be called interchangeably.</p>
<pre><code class="language-rust">impl TestStruct {
    fn foo(&amp;mut self) -&gt; i64 {
        self.field
    }
}

engine.register_fn("foo", TestStruct::foo);

let result = engine.eval::&lt;i64&gt;(
"
    let x = new_ts();
    foo(x);                         // normal call to 'foo'
    x.foo()                         // 'foo' can also be called like a method on 'x'
")?;

println!("result: {result}");       // prints 1</code></pre>
<h2 id="first-mut-parameter"><a class="header" href="#first-mut-parameter">First <code>&amp;mut</code> Parameter</a></h2>
<p>The opposite direction also works — methods in a Rust <a href="rust//book/rust/custom-types.html">custom type</a> registered with the
<a href="rust//book/engine/hello-world.html"><code>Engine</code></a> can be called just like a regular function.  In fact, like Rust, object methods are
registered as regular <a href="rust//book/language/functions.html">functions</a> in Rhai that take a first <code>&amp;mut</code> parameter.</p>
<p>Unlike functions defined in script (for which all arguments are passed by <em>value</em>),
native Rust functions may mutate the first <code>&amp;mut</code> argument.</p>
<p>Sometimes, however, there are more subtle differences. Methods called in normal function-call style
may end up not muting the object afterall — see the example below.</p>
<p>Custom types, <a href="rust//book/rust/getters-setters.html">properties</a>, <a href="rust//book/rust/indexers.html">indexers</a> and methods are disabled under the
<a href="rust//book/start/features.html"><code>no_object</code></a> feature.</p>
<pre><code class="language-rust">let a = new_ts();   // constructor function
a.field = 500;      // property setter
a.update();         // method call, 'a' can be modified

update(a);          // &lt;- this de-sugars to 'a.update()'
                    //    'a' can be modified and is not a copy

let array = [ a ];

update(array[0]);   // &lt;- 'array[0]' is an expression returning a calculated value,
                    //    a transient (i.e. a copy), so this statement has no effect
                    //    except waste time cloning 'a'

array[0].update();  // &lt;- call in method-call style will update 'a'</code></pre>
<div id="admonition-no-support-for-references" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-no-support-for-references-title">
<div class="admonition-title">
<div id="admonition-no-support-for-references-title">
<p>No support for references</p>
</div>
<a class="admonition-anchor-link" href="rust/methods-fn-call.html#admonition-no-support-for-references"></a>
</div>
<div>
<p>Rhai does NOT support normal references (i.e. <code>&amp;T</code>) as parameters.
All references must be mutable (i.e. <code>&amp;mut T</code>).</p>
</div>
</div>
<h2 id="number-of-parameters-in-methods"><a class="header" href="#number-of-parameters-in-methods">Number of Parameters in Methods</a></h2>
<p>Native Rust methods registered with an <a href="rust//book/engine/hello-world.html"><code>Engine</code></a> take <em>one additional parameter</em> more than
an equivalent method coded in script, where the object is accessed via the <code>this</code> pointer instead.</p>
<p>The following table illustrates the differences:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Function type</th><th style="text-align: center">No. of parameters</th><th style="text-align: center">Object reference</th><th style="text-align: center">Function signature</th></tr></thead><tbody>
<tr><td style="text-align: center">Native Rust</td><td style="text-align: center"><em>N</em> + 1</td><td style="text-align: center">first <code>&amp;mut T</code> parameter</td><td style="text-align: center"><code>Fn(obj: &amp;mut T, x: U, y: V)</code></td></tr>
<tr><td style="text-align: center">Rhai script</td><td style="text-align: center"><em>N</em></td><td style="text-align: center"><code>this</code></td><td style="text-align: center"><code>Fn(x: U, y: V)</code></td></tr>
</tbody></table>
</div>
<h2 id="mut-is-efficient-except-for-mut-immutablestring"><a class="header" href="#mut-is-efficient-except-for-mut-immutablestring"><code>&amp;mut</code> is Efficient, Except for <code>&amp;mut ImmutableString</code></a></h2>
<p>Using a <code>&amp;mut</code> first parameter is highly encouraged when using types that are expensive to clone,
even when the intention is not to mutate that argument, because it avoids cloning that argument value.</p>
<p>Even when a function is never intended to be a method – for example an operator,
it is still sometimes beneficial to make it method-like (i.e. with a first <code>&amp;mut</code> parameter)
if the first parameter is not modified.</p>
<p>For types that are expensive to clone (remember, all function calls are passed cloned
copies of argument values), this may result in a significant performance boost.</p>
<p>For primary types that are cheap to clone (e.g. those that implement <code>Copy</code>), including <code>ImmutableString</code>,
this is not necessary.</p>
<pre><code class="language-rust">// This is a type that is very expensive to clone.
#[derive(Debug, Clone)]
struct VeryComplexType { ... }

// Calculate some value by adding 'VeryComplexType' with an integer number.
fn do_add(obj: &amp;VeryComplexType, offset: i64) -&gt; i64 {
    ...
}

engine.register_type::&lt;VeryComplexType&gt;()
      .register_fn("+", add_pure /* or  add_method*/);

// Very expensive to call, as the 'VeryComplexType' is cloned before each call.
fn add_pure(obj: VeryComplexType, offset: i64) -&gt; i64 {
    do_add(obj, offset)
}

// Efficient to call, as only a reference to the 'VeryComplexType' is passed.
fn add_method(obj: &amp;mut VeryComplexType, offset: i64) -&gt; i64 {
    do_add(obj, offset)
}</code></pre>
<h2 id="data-race-considerations"><a class="header" href="#data-race-considerations">Data Race Considerations</a></h2>
<div id="admonition-data-races" class="admonition admonish-note side" role="note" aria-labelledby="admonition-data-races-title">
<div class="admonition-title">
<div id="admonition-data-races-title">
<p>Data races</p>
</div>
<a class="admonition-anchor-link" href="rust/methods-fn-call.html#admonition-data-races"></a>
</div>
<div>
<p>Data races are not possible in Rhai under the <a href="rust//book/start/features.html"><code>no_closure</code></a> feature because no sharing ever occurs.</p>
</div>
</div>
<p>Because methods always take a mutable reference as the first argument, even it the value is never changed,
care must be taken when using <em>shared</em> values with methods.</p>
<p>Usually data races are not possible in Rhai because, for each function call, there is ever only one
value that is mutable – the first argument of a method.  All other arguments are cloned.</p>
<p>It is possible, however, to create a data race with a <em>shared</em> value, when the same value is
<em>captured</em> in a <a href="rust//book/language/fn-closure.html">closure</a> and then used again as the <em>object</em> of calling that <a href="rust//book/language/fn-closure.html">closure</a>!</p>
<pre><code class="language-rust">let x = 20;

x.is_shared() == false;             // 'x' is not shared, so no data race is possible

let f = |a| this += x + a;          // 'x' is captured in this closure

x.is_shared() == true;              // now 'x' is shared

x.call(f, 2);                       // &lt;- error: data race detected on 'x'</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="custom-type-property-getters-and-setters"><a class="header" href="#custom-type-property-getters-and-setters">Custom Type Property Getters and Setters</a></h1>
<div id="admonition-cannot-override-object-maps" class="admonition admonish-warning side wide" role="note" aria-labelledby="admonition-cannot-override-object-maps-title">
<div class="admonition-title">
<div id="admonition-cannot-override-object-maps-title">
<p>Cannot override object maps</p>
</div>
<a class="admonition-anchor-link" href="rust/getters-setters.html#admonition-cannot-override-object-maps"></a>
</div>
<div>
<p>Property getters and setters are intended for <a href="rust//book/rust/custom-types.html">custom types</a>.</p>
<p>Any getter or setter function registered for <a href="rust//book/language/object-maps.html">object maps</a> is simply <em>ignored</em>.</p>
<p>Get/set syntax on <a href="rust//book/language/object-maps.html">object maps</a> is interpreted as access to properties.</p>
</div>
</div>
<p>A <a href="rust//book/rust/custom-types.html">custom type</a> can also expose properties by registering <code>get</code> and/or <code>set</code> functions.</p>
<p>Properties can be accessed in a Rust-like syntax:</p>
<blockquote>
<p><em>object</em> <code>.</code> <em>property</em></p>
<p><em>object</em> <code>.</code> <em>property</em> <code>=</code> <em>value</em> <code>;</code></p>
</blockquote>
<p>The <a href="https://en.wikipedia.org/wiki/Elvis_operator"><em>Elvis operator</em></a> can be used to short-circuit
processing if the object itself is <a href="rust//book/language/values-and-types.html"><code>()</code></a>:</p>
<blockquote>
<p><code>// returns () if object is ()</code><br />
<em>object</em> <code>?.</code> <em>property</em></p>
<p><code>// no action if object is ()</code><br />
<em>object</em> <code>?.</code> <em>property</em> <code>=</code> <em>value</em> <code>;</code></p>
</blockquote>
<p>Property getter and setter functions are called behind the scene.
They each take a <code>&amp;mut</code> reference to the first parameter.</p>
<p>Getters and setters are disabled under the <a href="rust//book/start/features.html"><code>no_object</code></a> feature.</p>
<section></section>
<div class="table-wrapper"><table><thead><tr><th><code>Engine</code> API</th><th>Function signature(s)<br/>(<code>T: Clone</code> = custom type,<br/><code>V: Clone</code> = data type)</th><th style="text-align: center">Can mutate <code>T</code>?</th></tr></thead><tbody>
<tr><td><code>register_get</code></td><td><code>Fn(&amp;mut T) -&gt; V</code></td><td style="text-align: center">yes, but not advised</td></tr>
<tr><td><code>register_set</code></td><td><code>Fn(&amp;mut T, V)</code></td><td style="text-align: center">yes</td></tr>
<tr><td><code>register_get_set</code></td><td>getter: <code>Fn(&amp;mut T) -&gt; V</code></br>setter: <code>Fn(&amp;mut T, V)</code></td><td style="text-align: center">yes, but not advised in getter</td></tr>
</tbody></table>
</div><div id="admonition-no-support-for-references" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-no-support-for-references-title">
<div class="admonition-title">
<div id="admonition-no-support-for-references-title">
<p>No support for references</p>
</div>
<a class="admonition-anchor-link" href="rust/getters-setters.html#admonition-no-support-for-references"></a>
</div>
<div>
<p>Rhai does NOT support normal references (i.e. <code>&amp;T</code>) as parameters.
All references must be mutable (i.e. <code>&amp;mut T</code>).</p>
</div>
</div>
<div id="admonition-getters-must-be-pure" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-getters-must-be-pure-title">
<div class="admonition-title">
<div id="admonition-getters-must-be-pure-title">
<p>Getters must be pure</p>
</div>
<a class="admonition-anchor-link" href="rust/getters-setters.html#admonition-getters-must-be-pure"></a>
</div>
<div>
<p>By convention, property getters are assumed to be <em>pure</em>, meaning that they are not supposed to
mutate the <a href="rust//book/rust/custom-types.html">custom type</a>, although there is nothing that prevents this mutation in Rust.</p>
<p>Even though a property getter function also takes <code>&amp;mut</code> as the first parameter, Rhai assumes that
no data is changed when the function is called.</p>
</div>
</div>
<h2 id="examples-1"><a class="header" href="#examples-1">Examples</a></h2>
<pre><code class="language-rust">#[derive(Debug, Clone)]
struct TestStruct {
    field: String
}

impl TestStruct {
    // Remember &amp;mut must be used even for getters.
    fn get_field(&amp;mut self) -&gt; String {
        // Property getters are assumed to be PURE, meaning they are
        // not supposed to mutate any data.
        self.field.clone()
    }

    fn set_field(&amp;mut self, new_val: String) {
        self.field = new_val;
    }

    fn new() -&gt; Self {
        Self { field: "hello, world!".to_string() }
    }
}

let mut engine = Engine::new();

engine.register_type::&lt;TestStruct&gt;()
      .register_get_set("xyz", TestStruct::get_field, TestStruct::set_field)
      .register_fn("new_ts", TestStruct::new);

let result = engine.eval::&lt;String&gt;(
r#"
    let a = new_ts();
    a.xyz = "42";
    a.xyz
"#)?;

println!("Answer: {result}");                   // prints 42</code></pre>
<h2 id="fallback-to-indexer"><a class="header" href="#fallback-to-indexer">Fallback to Indexer</a></h2>
<div id="admonition-see-also" class="admonition admonish-note side" role="note" aria-labelledby="admonition-see-also-title">
<div class="admonition-title">
<div id="admonition-see-also-title">
<p>See also</p>
</div>
<a class="admonition-anchor-link" href="rust/getters-setters.html#admonition-see-also"></a>
</div>
<div>
<p>See <a href="rust/indexer-prop-fallback.html">this section</a> for details on an <a href="rust//book/rust/indexers.html">indexer</a>
acting as fallback to properties.</p>
</div>
</div>
<p>If the getter/setter of a particular property is not defined, but an <a href="rust//book/rust/indexers.html">indexer</a> is defined on the
<a href="rust//book/rust/custom-types.html">custom type</a> with <a href="rust//book/language/strings-chars.html">string</a> index, then the corresponding <a href="rust//book/rust/indexers.html">indexer</a> will be called with the name of
the property as the index value.</p>
<p>In other words, <a href="rust//book/rust/indexers.html">indexers</a> act as a <em>fallback</em> to property getters/setters.</p>
<pre><code class="language-rust">a.foo           // if property getter for 'foo' doesn't exist...

a["foo"]        // an indexer (if any) is tried</code></pre>
<div id="admonition-tip-implement-a-property-bag" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-implement-a-property-bag-title">
<div class="admonition-title">
<div id="admonition-tip-implement-a-property-bag-title">
<p>Tip: Implement a property bag</p>
</div>
<a class="admonition-anchor-link" href="rust/getters-setters.html#admonition-tip-implement-a-property-bag"></a>
</div>
<div>
<p>This feature makes it very easy for <a href="rust//book/rust/custom-types.html">custom types</a> to act as <em>property bags</em>
(similar to an <a href="rust//book/language/object-maps.html">object map</a>) which can add/remove properties at will.</p>
</div>
</div>
<h2 id="chaining-updates"><a class="header" href="#chaining-updates">Chaining Updates</a></h2>
<p>It is possible to <em>chain</em> property accesses and/or indexing (via <a href="rust//book/rust/indexers.html">indexers</a>) together to modify a
particular property value at the end of the chain.</p>
<p>Rhai detects such modifications and updates the changed values all the way back up the chain.</p>
<p>In the end, the syntax works as expected by intuition, automatically and without special attention.</p>
<pre><code class="language-rust">// Assume a deeply-nested object...
let root = get_new_container_object();

root.prop1.sub["hello"].list[0].value = 42;

// The above is equivalent to:

// First getting all the intermediate values...
let prop1_value = root.prop1;                   // via property getter
let sub_value = prop1_value.sub;                // via property getter
let sub_value_item = sub_value["hello"];        // via index getter
let list_value = sub_value_item.list;           // via property getter
let list_item = list_value[0];                  // via index getter

list_item.value = 42;       // modify property value deep down the chain

// Propagate the changes back up the chain...
list_value[0] = list_item;                      // via index setter
sub_value_item.list = list_value;               // via property setter
sub_value["hello"] = sub_value_item;            // via index setter
prop1_value.sub = sub_value;                    // via property setter
root.prop1 = prop1_value;                       // via property setter

// The below prints 42...
print(root.prop1.sub["hello"].list[0].value);</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="custom-type-indexers"><a class="header" href="#custom-type-indexers">Custom Type Indexers</a></h1>
<p>A <a href="rust//book/rust/custom-types.html">custom type</a> can also expose an <em>indexer</em> by registering an indexer function.</p>
<p>A <a href="rust//book/rust/custom-types.html">custom type</a> with an indexer function defined can use the bracket notation to get/set a property
value at a particular index:</p>
<blockquote>
<p><em>object</em> <code>[</code> <em>index</em> <code>]</code></p>
<p><em>object</em> <code>[</code> <em>index</em> <code>]</code> <code>=</code> <em>value</em> <code>;</code></p>
</blockquote>
<p>The <a href="https://en.wikipedia.org/wiki/Elvis_operator"><em>Elvis notation</em></a> is similar except that it returns <a href="rust//book/language/values-and-types.html"><code>()</code></a> if the object itself is <a href="rust//book/language/values-and-types.html"><code>()</code></a>.</p>
<blockquote>
<p><code>// returns () if object is ()</code><br />
<em>object</em> <code>?[</code> <em>index</em> <code>]</code></p>
<p><code>// no action if object is ()</code><br />
<em>object</em> <code>?[</code> <em>index</em> <code>]</code> <code>=</code> <em>value</em> <code>;</code></p>
</blockquote>
<p>Like property <a href="rust//book/rust/getters-setters.html">getters/setters</a>, indexers take a <code>&amp;mut</code> reference to the first parameter.</p>
<p>They also take an additional parameter of any type that serves as the <em>index</em> within brackets.</p>
<p>Indexers are disabled when the <a href="rust//book/start/features.html"><code>no_index</code></a> and <a href="rust//book/start/features.html"><code>no_object</code></a> features are used together.</p>
<div class="table-wrapper"><table><thead><tr><th><code>Engine</code> API</th><th>Function signature(s)<br/>(<code>T: Clone</code> = custom type,<br/><code>X: Clone</code> = index type,<br/><code>V: Clone</code> = data type)</th><th style="text-align: center">Can mutate <code>T</code>?</th></tr></thead><tbody>
<tr><td><code>register_indexer_get</code></td><td><code>Fn(&amp;mut T, X) -&gt; V</code></td><td style="text-align: center">yes, but not advised</td></tr>
<tr><td><code>register_indexer_set</code></td><td><code>Fn(&amp;mut T, X, V)</code></td><td style="text-align: center">yes</td></tr>
<tr><td><code>register_indexer_get_set</code></td><td>getter: <code>Fn(&amp;mut T, X) -&gt; V</code><br/>setter: <code>Fn(&amp;mut T, X, V)</code></td><td style="text-align: center">yes, but not advised in getter</td></tr>
</tbody></table>
</div><div id="admonition-no-support-for-references" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-no-support-for-references-title">
<div class="admonition-title">
<div id="admonition-no-support-for-references-title">
<p>No support for references</p>
</div>
<a class="admonition-anchor-link" href="rust/indexers.html#admonition-no-support-for-references"></a>
</div>
<div>
<p>Rhai does NOT support normal references (i.e. <code>&amp;T</code>) as parameters.
All references must be mutable (i.e. <code>&amp;mut T</code>).</p>
</div>
</div>
<div id="admonition-getters-must-be-pure" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-getters-must-be-pure-title">
<div class="admonition-title">
<div id="admonition-getters-must-be-pure-title">
<p>Getters must be pure</p>
</div>
<a class="admonition-anchor-link" href="rust/indexers.html#admonition-getters-must-be-pure"></a>
</div>
<div>
<p>By convention, index getters are not supposed to mutate the <a href="rust//book/rust/custom-types.html">custom type</a>,
although there is nothing that prevents this mutation.</p>
</div>
</div>
<div id="admonition-tip-evalaltresulterrorindexnotfound" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-evalaltresulterrorindexnotfound-title">
<div class="admonition-title">
<div id="admonition-tip-evalaltresulterrorindexnotfound-title">
<p>Tip: <code>EvalAltResult::ErrorIndexNotFound</code></p>
</div>
<a class="admonition-anchor-link" href="rust/indexers.html#admonition-tip-evalaltresulterrorindexnotfound"></a>
</div>
<div>
<p>For <a href="rust//book/rust/fallible.html">fallible</a> indexers, it is customary to return
<code>EvalAltResult::ErrorIndexNotFound</code> when called with an invalid index value.</p>
</div>
</div>
<h2 id="cannot-override-arrays-blobs-object-maps-strings-and-integers"><a class="header" href="#cannot-override-arrays-blobs-object-maps-strings-and-integers">Cannot Override Arrays, BLOB’s, Object Maps, Strings and Integers</a></h2>
<div id="admonition-plugins" class="admonition admonish-failure side" role="note" aria-labelledby="admonition-plugins-title">
<div class="admonition-title">
<div id="admonition-plugins-title">
<p>Plugins</p>
</div>
<a class="admonition-anchor-link" href="rust/indexers.html#admonition-plugins"></a>
</div>
<div>
<p>They can be defined in a <a href="rust//book/plugins/module.html">plugin module</a>, but will be ignored.</p>
</div>
</div>
<p>For efficiency reasons, indexers <strong>cannot</strong> be used to overload (i.e. override)
built-in indexing operations for <a href="rust//book/language/arrays.html">arrays</a>, <a href="rust//book/language/object-maps.html">object maps</a>, <a href="rust//book/language/strings-chars.html">strings</a> and integers
(acting as <a href="rust//book/language/bit-fields.html">bit-field</a> operation).</p>
<p>The following types have built-in indexer implementations that are fast and efficient.</p>
<section></section>
<div class="table-wrapper"><table><thead><tr><th>Type</th><th style="text-align: center">Index type</th><th style="text-align: center">Return type</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="rust//book/language/arrays.html"><code>Array</code></a></td><td style="text-align: center"><code>INT</code></td><td style="text-align: center"><a href="rust//book/language/dynamic.html"><code>Dynamic</code></a></td><td>access a particular element inside the <a href="rust//book/language/arrays.html">array</a></td></tr>
<tr><td><a href="rust//book/language/blobs.html"><code>Blob</code></a></td><td style="text-align: center"><code>INT</code></td><td style="text-align: center"><code>INT</code></td><td>access a particular byte value inside the <a href="rust//book/language/blobs.html">BLOB</a></td></tr>
<tr><td><a href="rust//book/language/object-maps.html"><code>Map</code></a></td><td style="text-align: center"><a href="rust//book/rust/immutable-string.html"><code>ImmutableString</code></a>,<br/><code>String</code>, <code>&amp;str</code></td><td style="text-align: center"><a href="rust//book/language/dynamic.html"><code>Dynamic</code></a></td><td>access a particular property inside the <a href="rust//book/language/object-maps.html">object map</a></td></tr>
<tr><td><a href="rust//book/rust/immutable-string.html"><code>ImmutableString</code></a>,<br/><code>String</code>, <code>&amp;str</code></td><td style="text-align: center"><code>INT</code></td><td style="text-align: center"><a href="rust//book/language/strings-chars.html">character</a></td><td>access a particular <a href="rust//book/language/strings-chars.html">character</a> inside the <a href="rust//book/language/strings-chars.html">string</a></td></tr>
<tr><td><code>INT</code></td><td style="text-align: center"><code>INT</code></td><td style="text-align: center">boolean</td><td>access a particular bit inside the integer number as a <a href="rust//book/language/bit-fields.html">bit-field</a></td></tr>
<tr><td><code>INT</code></td><td style="text-align: center"><a href="rust//book/language/ranges.html">range</a></td><td style="text-align: center"><code>INT</code></td><td>access a particular range of bits inside the integer number as a <a href="rust//book/language/bit-fields.html">bit-field</a></td></tr>
</tbody></table>
</div><div id="admonition-do-not-overload-indexers-for-built-in-standard-types" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-do-not-overload-indexers-for-built-in-standard-types-title">
<div class="admonition-title">
<div id="admonition-do-not-overload-indexers-for-built-in-standard-types-title">
<p>Do not overload indexers for built-in standard types</p>
</div>
<a class="admonition-anchor-link" href="rust/indexers.html#admonition-do-not-overload-indexers-for-built-in-standard-types"></a>
</div>
<div>
<p>In general, it is a bad idea to overload indexers for any of the <a href="rust//book/language/values-and-types.html">standard types</a> supported
internally by Rhai, since built-in indexers may be added in future versions.</p>
</div>
</div>
<h2 id="examples-2"><a class="header" href="#examples-2">Examples</a></h2>
<pre><code class="language-rust">#[derive(Debug, Clone)]
struct TestStruct {
    fields: Vec&lt;i64&gt;
}

impl TestStruct {
    // Remember &amp;mut must be used even for getters
    fn get_field(&amp;mut self, index: String) -&gt; i64 {
        self.fields[index.len()]
    }
    fn set_field(&amp;mut self, index: String, value: i64) {
        self.fields[index.len()] = value
    }

    fn new() -&gt; Self {
        Self { fields: vec![1, 2, 3, 4, 5] }
    }
}

let mut engine = Engine::new();

engine.register_type::&lt;TestStruct&gt;()
      .register_fn("new_ts", TestStruct::new)
      // Short-hand: .register_indexer_get_set(TestStruct::get_field, TestStruct::set_field);
      .register_indexer_get(TestStruct::get_field)
      .register_indexer_set(TestStruct::set_field);

let result = engine.eval::&lt;i64&gt;(
r#"
    let a = new_ts();
    a["xyz"] = 42;                  // these indexers use strings
    a["xyz"]                        // as the index type
"#)?;

println!("Answer: {result}");       // prints 42</code></pre>
<h2 id="convention-for-negative-index"><a class="header" href="#convention-for-negative-index">Convention for Negative Index</a></h2>
<p>If the indexer takes a signed integer as an index (e.g. the standard <code>INT</code> type), care should be
taken to handle <em>negative</em> values passed as the index.</p>
<p>It is a standard API <em>convention</em> for Rhai to assume that an index position counts <em>backwards</em> from
the <em>end</em> if it is negative.</p>
<p><code>-1</code> as an index usually refers to the <em>last</em> item, <code>-2</code> the second to last item, and so on.</p>
<p>Therefore, negative index values go from <code>-1</code> (last item) to <code>-length</code> (first item).</p>
<p>A typical implementation for negative index values is:</p>
<pre><code class="language-rust">// The following assumes:
//   'index' is 'INT', 'items: usize' is the number of elements
let actual_index = if index &lt; 0 {
    index.checked_abs().map_or(0, |n| items - (n as usize).min(items))
} else {
    index as usize
};</code></pre>
<p>The <em>end</em> of a data type can be interpreted creatively.  For example, in an integer used as a
<a href="rust//book/language/bit-fields.html">bit-field</a>, the <em>start</em> is the <em>least-significant-bit</em> (LSB) while the <code>end</code> is the
<em>most-significant-bit</em> (MSB).</p>
<h2 id="convention-for-range-index"><a class="header" href="#convention-for-range-index">Convention for Range Index</a></h2>
<div id="admonition-tip-negative-values" class="admonition admonish-tip side wide" role="note" aria-labelledby="admonition-tip-negative-values-title">
<div class="admonition-title">
<div id="admonition-tip-negative-values-title">
<p>Tip: Negative values</p>
</div>
<a class="admonition-anchor-link" href="rust/indexers.html#admonition-tip-negative-values"></a>
</div>
<div>
<p>By convention, negative values are <em>not</em> interpreted specially in indexers for <a href="rust//book/language/ranges.html">ranges</a>.</p>
</div>
</div>
<p>It is very common for <a href="rust//book/language/ranges.html">ranges</a> to be used as indexer parameters via the types
<code>std::ops::Range&lt;INT&gt;</code> (exclusive) and <code>std::ops::RangeInclusive&lt;INT&gt;</code> (inclusive).</p>
<p>One complication is that two versions of the same indexer must be defined to support <em>exclusive</em>
and <em>inclusive</em> <a href="rust//book/language/ranges.html">ranges</a> respectively.</p>
<pre><code class="language-rust">use std::ops::{Range, RangeInclusive};

let mut engine = Engine::new();

engine
    /// Version of indexer that accepts an exclusive range
    .register_indexer_get_set(
        |obj: &amp;mut TestStruct, range: Range&lt;i64&gt;| -&gt; bool { ... },
        |obj: &amp;mut TestStruct, range: Range&lt;i64&gt;, value: bool| { ... },
    )
    /// Version of indexer that accepts an inclusive range
    .register_indexer_get_set(
        |obj: &amp;mut TestStruct, range: RangeInclusive&lt;i64&gt;| -&gt; bool { ... },
        |obj: &amp;mut TestStruct, range: RangeInclusive&lt;i64&gt;, value: bool| { ... },
    );

engine.run(
"
    let obj = new_ts();

    let x = obj[0..12];             // use exclusive range

    obj[0..=11] = !x;               // use inclusive range
")?;</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="indexer-as-property-access-fallback"><a class="header" href="#indexer-as-property-access-fallback">Indexer as Property Access Fallback</a></h1>
<div id="admonition-tip-property-bag" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-property-bag-title">
<div class="admonition-title">
<div id="admonition-tip-property-bag-title">
<p>Tip: Property bag</p>
</div>
<a class="admonition-anchor-link" href="rust/indexer-prop-fallback.html#admonition-tip-property-bag"></a>
</div>
<div>
<p>Such an <a href="rust//book/rust/indexers.html">indexer</a> allows easy creation of <em>property bags</em> (similar to <a href="rust//book/language/object-maps.html">object maps</a>)
which can dynamically add/remove properties.</p>
</div>
</div>
<p>An <a href="rust//book/rust/indexers.html">indexer</a> taking a <a href="rust//book/language/strings-chars.html">string</a> index is a special case – it acts as a <em>fallback</em> to property
<a href="rust//book/rust/getters-setters.html">getters/setters</a>.</p>
<p>During a property access, if the appropriate property <a href="rust//book/rust/getters-setters.html">getter/setter</a> is not
defined, an <a href="rust//book/rust/indexers.html">indexer</a> is called and passed the string name of the property.</p>
<p>This is also extremely useful as a short-hand for <a href="rust//book/rust/indexers.html">indexers</a>, when the <a href="rust//book/language/strings-chars.html">string</a> keys conform to
property name syntax.</p>
<pre><code class="language-rust">// Assume 'obj' has an indexer defined with string parameters...

// Let's create a new key...
obj.hello_world = 42;

// The above is equivalent to this:
obj["hello_world"] = 42;

// You can write this...
let x = obj["hello_world"];

// but it is easier with this...
let x = obj.hello_world;</code></pre>
<div id="admonition-tip-swizzling" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-swizzling-title">
<div class="admonition-title">
<div id="admonition-tip-swizzling-title">
<p>Tip: Swizzling</p>
</div>
<a class="admonition-anchor-link" href="rust/indexer-prop-fallback.html#admonition-tip-swizzling"></a>
</div>
<div>
<p>Since an <a href="rust//book/rust/indexers.html">indexer</a> can serve as a <em>fallback</em> to <a href="rust//book/rust/getters-setters.html">property access</a>,
it is possible to implement <a href="https://en.wikipedia.org/wiki/Swizzling_(computer_graphics)">swizzling</a>
of properties for use with vector-like <a href="rust//book/rust/custom-types.html">custom types</a>.</p>
<p>Such an <a href="rust//book/rust/indexers.html">indexer</a> defined on a <a href="rust//book/rust/custom-types.html">custom type</a> (for instance, <code>Float4</code>) can inspect the property name,
construct a proper return value based on the swizzle pattern, and return it.</p>
<pre><code class="language-rust">// Assume 'v' is a 'Float4'
let r = v.w;        // -&gt; v.w
let r = v.xx;       // -&gt; Float2::new(v.x, v.x)
let r = v.yxz;      // -&gt; Float3::new(v.y, v.x, v.z)
let r = v.xxzw;     // -&gt; Float4::new(v.x, v.x, v.z, v.w)
let r = v.yyzzxx;   // error: property 'yyzzxx' not found</code></pre>
</div>
</div>
<h2 id="caveat--reverse-is-not-true"><a class="header" href="#caveat--reverse-is-not-true">Caveat – Reverse is NOT True</a></h2>
<p>The reverse, however, is not true – when an <a href="rust//book/rust/indexers.html">indexer</a> fails or doesn’t exist, the corresponding
property <a href="rust//book/rust/getters-setters.html">getter/setter</a>, if any, is not called.</p>
<pre><code class="language-rust">type MyType = HashMap&lt;String, i64&gt;;

let mut engine = Engine::new();

// Define custom type, property getter and string indexers
engine.register_type::&lt;MyType&gt;()
      .register_fn("new_ts", || {
          let mut obj = MyType::new();
          obj.insert("foo".to_string(), 1);
          obj.insert("bar".to_string(), 42);
          obj.insert("baz".to_string(), 123);
          obj
      })
      // Property 'hello'
      .register_get("hello", |obj: &amp;mut MyType| obj.len() as i64)
      // Index getter/setter
      .register_indexer_get(|obj: &amp;mut MyType, prop: &amp;str| -&gt; Result&lt;i64, Box&lt;EvalAltResult&gt;&gt;
          obj.get(index).cloned().ok_or_else(|| "not found".into())
      ).register_indexer_set(|obj: &amp;mut MyType, prop: &amp;str, value: i64|
          obj.insert(prop.to_string(), value)
      );

engine.run("let ts = new_ts(); print(ts.foo);");
//                                   ^^^^^^
//                 Calls ts["foo"] - getter for 'foo' does not exist

engine.run("let ts = new_ts(); print(ts.bar);");
//                                   ^^^^^^
//                 Calls ts["bar"] - getter for 'bar' does not exist

engine.run("let ts = new_ts(); ts.baz = 999;");
//                             ^^^^^^^^^^^^
//                 Calls ts["baz"] = 999 - setter for 'baz' does not exist

engine.run(r#"let ts = new_ts(); print(ts["hello"]);"#);
//                                     ^^^^^^^^^^^
//                 Error: Property getter for 'hello' not a fallback for indexer</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="custom-collection-types"><a class="header" href="#custom-collection-types">Custom Collection Types</a></h1>
<div id="admonition-tip" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="rust/collections.html#admonition-tip"></a>
</div>
<div>
<p>Collections can also hold <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> values (e.g. like an <a href="rust//book/language/arrays.html">array</a>).</p>
</div>
</div>
<p>A <em>collection</em> type holds a… well… <em>collection</em> of items.  It can be homogeneous (all items are
the same type) or heterogeneous (items are of different types, use <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> to hold).</p>
<p>Because their only purpose for existence is to hold a number of items, collection types commonly
register the following methods.</p>
<section></section>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody>
<tr><td><code>len</code> method and property</td><td>gets the total number of items in the collection</td></tr>
<tr><td><code>clear</code></td><td>clears the collection</td></tr>
<tr><td><code>contains</code></td><td>checks if a particular item exists in the collection</td></tr>
<tr><td><code>add</code>, <code>+=</code> operator</td><td>adds a particular item to the collection</td></tr>
<tr><td><code>remove</code>, <code>-=</code> operator</td><td>removes a particular item from the collection</td></tr>
<tr><td><code>merge</code> or <code>+</code> operator</td><td>merges two collections, yielding a new collection with all items</td></tr>
</tbody></table>
</div><div id="admonition-tip-define-type-iterator" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-define-type-iterator-title">
<div class="admonition-title">
<div id="admonition-tip-define-type-iterator-title">
<p>Tip: Define type iterator</p>
</div>
<a class="admonition-anchor-link" href="rust/collections.html#admonition-tip-define-type-iterator"></a>
</div>
<div>
<p>Collections are typically iterable.</p>
<p>It is customary to use <code>Engine::register_iterator</code> to allow iterating the collection if
it implements <code>IntoIterator</code>.</p>
<p>Alternative, register a specific <a href="rust//book/language/iterator.html">type iterator</a> for the <a href="rust//book/rust/custom-types.html">custom type</a>.</p>
</div>
</div>
<div id="admonition-tip-use-a-plugin-module" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-use-a-plugin-module-title">
<div class="admonition-title">
<div id="admonition-tip-use-a-plugin-module-title">
<p>Tip: Use a plugin module</p>
</div>
<a class="admonition-anchor-link" href="rust/collections.html#admonition-tip-use-a-plugin-module"></a>
</div>
<div>
<p>A <a href="rust//book/plugins/module.html">plugin module</a> makes defining an entire API for a <a href="rust//book/rust/custom-types.html">custom type</a> a snap.</p>
</div>
</div>
<h2 id="example-7"><a class="header" href="#example-7">Example</a></h2>
<pre><code class="language-rust">type MyBag = HashSet&lt;MyItem&gt;;

engine
    .register_type_with_name::&lt;MyBag&gt;("MyBag")
    .register_iterator::&lt;MyBag&gt;()
    .register_fn("new_bag", || MyBag::new())
    .register_fn("len", |col: &amp;mut MyBag| col.len() as i64)
    .register_get("len", |col: &amp;mut MyBag| col.len() as i64)
    .register_fn("clear", |col: &amp;mut MyBag| col.clear())
    .register_fn("contains", |col: &amp;mut MyBag, item: i64| col.contains(&amp;item))
    .register_fn("add", |col: &amp;mut MyBag, item: MyItem| col.insert(item))
    .register_fn("+=", |col: &amp;mut MyBag, item: MyItem| col.insert(item))
    .register_fn("remove", |col: &amp;mut MyBag, item: MyItem| col.remove(&amp;item))
    .register_fn("-=", |col: &amp;mut MyBag, item: MyItem| col.remove(&amp;item))
    .register_fn("+", |mut col1: MyBag, col2: MyBag| {
        col1.extend(col2.into_iter());
        col1
    });</code></pre>
<h2 id="what-about-indexers"><a class="header" href="#what-about-indexers">What About Indexers?</a></h2>
<p>Many users are tempted to register <a href="rust//book/rust/indexers.html">indexers</a> for custom collections.  This essentially makes the
original Rust type something similar to <code>Vec&lt;MyType&gt;</code>.</p>
<p>Rhai’s standard <a href="rust//book/language/arrays.html"><code>Array</code></a> type is <code>Vec&lt;Dynamic&gt;</code> which already holds an ordered, iterable and
indexable collection of dynamic items.  Since Rhai has built-in support, manipulating <a href="rust//book/language/arrays.html">arrays</a> is fast.</p>
<p>In <em>most</em> circumstances, it is better to use <a href="rust//book/language/arrays.html"><code>Array</code></a> instead of a <a href="rust//book/rust/custom-types.html">custom type</a>.</p>
<div id="admonition-tip-convert-to-array-using-into" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-convert-to-array-using-into-title">
<div class="admonition-title">
<div id="admonition-tip-convert-to-array-using-into-title">
<p>Tip: Convert to <code>Array</code> using <code>.into()</code></p>
</div>
<a class="admonition-anchor-link" href="rust/collections.html#admonition-tip-convert-to-array-using-into"></a>
</div>
<div>
<p><a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> implements <code>FromIterator</code> for all iterable types and an <a href="rust//book/language/arrays.html"><code>Array</code></a> is created in the process.</p>
<p>So, converting a typed array (i.e. <code>Vec&lt;MyType&gt;</code>) into an <a href="rust//book/language/arrays.html">array</a> in Rhai is as simple as calling <code>.into()</code>.</p>
<pre><code class="language-rust">// Say you have a custom typed array...
let my_custom_array: Vec&lt;MyType&gt; = do_lots_of_calc(42);

// Convert it into a 'Dynamic' that holds an array
let value: Dynamic = my_custom_array.into();

// Use is anywhere in Rhai...
scope.push("my_custom_array", value);

engine
    // Raw function that returns a custom type
    .register_fn("do_lots_of_calc_raw", do_lots_of_calc)
    // Wrap function that return a custom typed array
    .register_fn("do_lots_of_calc", |seed: i64| -&gt; Dynamic {
        let result = do_lots_of_calc(seed);     // Vec&lt;MyType&gt;
        result.into()                           // Array in Dynamic
    });</code></pre>
</div>
</div>
<h2 id="tldr-1"><a class="header" href="#tldr-1">TL;DR</a></h2>
<div id="admonition-why-shouldnt-we-register-vec" class="admonition admonish-question" role="note" aria-labelledby="admonition-why-shouldnt-we-register-vec-title">
<div class="admonition-title">
<div id="admonition-why-shouldnt-we-register-vec-title">
<p>Why shouldn’t we register <code>Vec&lt;MyType&gt;</code>?</p>
</div>
<a class="admonition-anchor-link" href="rust/collections.html#admonition-why-shouldnt-we-register-vec"></a>
</div>
<div>
<h3 id="reason-1-performance"><a class="header" href="#reason-1-performance">Reason #1: Performance</a></h3>
<p>A main reason why anybody would want to do this is to avoid the overhead of storing <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> items.</p>
<p>This is why <a href="rust//book/language/blobs.html">BLOB’s</a> is a built-in data type in Rhai, even though it is actually defined as <code>Vec&lt;u8&gt;</code>.
The overhead of using <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> (16 bytes) versus <code>u8</code> (1 byte) is worth the trouble, although the
performance gains may not be as pronounced as expected: benchmarks show a 15% speed improvement inside
a tight loop compared with using an <a href="rust//book/language/arrays.html">array</a>.</p>
<p><code>Vec&lt;MyType&gt;</code>, however, will be treated as an opaque <a href="rust//book/rust/custom-types.html">custom type</a> in Rhai, so performance is not optimized.
What you gain from avoiding <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a>, you pay back in terms of slower access to the <code>Vec</code> as well as <code>MyType</code>
(which is treated as yet another opaque <a href="rust//book/rust/custom-types.html">custom type</a>).</p>
<h3 id="reason-2-api"><a class="header" href="#reason-2-api">Reason #2: API</a></h3>
<p>Another reason why it shouldn’t be done is due to the large number of functions and methods that must be registered
for each type of this sort.  One only has to look at the vast API surface of <a href="rust//book/language/arrays.html#built-in-functions">arrays</a>
to see the common methods that a user would expect to be available.</p>
<p>Since <code>Vec&lt;Type&gt;</code> looks, feels and quacks just like a normal <a href="rust//book/language/arrays.html">array</a>, and the usage syntax is almost equivalent (except
for the fact that the data type is restricted), users would be frustrated if they find that certain functions available for
<a href="rust//book/language/arrays.html">arrays</a> are not provided.</p>
<p>This is similar to JavaScript’s <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Typed_arrays"><em>Typed Arrays</em></a>.
They are quite awkward to work with, and basically each has a full API definition that must be pre-registered.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="disable-custom-types"><a class="header" href="#disable-custom-types">Disable Custom Types</a></h1>
<p>The <a href="rust//book/start/features.html"><code>no_object</code></a> feature disables support for <a href="rust//book/rust/custom-types.html">custom types</a> including:</p>
<ul>
<li>
<p><a href="rust//book/rust/methods.html"><em>method-style</em></a> function calls (e.g. <code>obj.method()</code>),</p>
</li>
<li>
<p><a href="rust//book/language/object-maps.html">object maps</a> and the <a href="rust//book/language/object-maps.html"><code>Map</code></a> type,</p>
</li>
<li>
<p>the <code>register_get</code>, <code>register_set</code> and <code>register_get_set</code> APIs for <a href="rust//book/engine/hello-world.html"><code>Engine</code></a></p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="printing-for-custom-types"><a class="header" href="#printing-for-custom-types">Printing for Custom Types</a></h1>
<h2 id="provide-these-functions"><a class="header" href="#provide-these-functions">Provide These Functions</a></h2>
<p>To use <a href="rust//book/rust/custom-types.html">custom types</a> for <a href="rust//book/language/print-debug.html"><code>print</code></a> and <a href="rust//book/language/print-debug.html"><code>debug</code></a>, or convert a <a href="rust//book/rust/custom-types.html">custom type</a> into a <a href="rust//book/language/strings-chars.html">string</a>,
it is necessary that the following functions, at minimum, be registered (assuming the <a href="rust//book/rust/custom-types.html">custom type</a>
is <code>T: Display + Debug</code>).</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Signature</th><th>Typical implementation</th><th>Usage</th></tr></thead><tbody>
<tr><td><code>to_string</code></td><td><code>|x: &amp;mut T| -&gt; String</code></td><td><code>x.to_string()</code></td><td>converts the <a href="rust//book/rust/custom-types.html">custom type</a> into a <a href="rust//book/language/strings-chars.html">string</a></td></tr>
<tr><td><code>to_debug</code></td><td><code>|x: &amp;mut T| -&gt; String</code></td><td><code>format!("{x:?}")</code></td><td>converts the <a href="rust//book/rust/custom-types.html">custom type</a> into a <a href="rust//book/language/strings-chars.html">string</a> in debug format</td></tr>
</tbody></table>
</div><div id="admonition-tip-rhai_fnglobal" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-rhai_fnglobal-title">
<div class="admonition-title">
<div id="admonition-tip-rhai_fnglobal-title">
<p>Tip: <code>#[rhai_fn(global)]</code></p>
</div>
<a class="admonition-anchor-link" href="rust/print-custom.html#admonition-tip-rhai_fnglobal"></a>
</div>
<div>
<p>If these functions are defined via a <a href="rust//book/plugins/module.html">plugin module</a>, be sure to include the <code>#[rhai_fn(global)]</code> attribute
in order to make them available globally.</p>
<p>See <a href="rust//book/plugins/module.html#use-rhai_fnglobal">this section</a> for more details.</p>
</div>
</div>
<h2 id="also-consider-these"><a class="header" href="#also-consider-these">Also Consider These</a></h2>
<p>The following functions are implemented using <code>to_string</code> or <code>to_debug</code> by default, but can be
overloaded with custom versions.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Signature</th><th>Default</th><th>Usage</th></tr></thead><tbody>
<tr><td><code>print</code></td><td><code>|x: &amp;mut T| -&gt; String</code></td><td><code>to_string</code></td><td>converts the <a href="rust//book/rust/custom-types.html">custom type</a> into a <a href="rust//book/language/strings-chars.html">string</a> for the <a href="rust//book/language/print-debug.html"><code>print</code></a> statement</td></tr>
<tr><td><code>debug</code></td><td><code>|x: &amp;mut T| -&gt; String</code></td><td><code>to_debug</code></td><td>converts the <a href="rust//book/rust/custom-types.html">custom type</a> into a <a href="rust//book/language/strings-chars.html">string</a> for the <a href="rust//book/language/print-debug.html"><code>debug</code></a> statement</td></tr>
<tr><td><code>+</code> operator</td><td><code>|s: &amp;str, x: T| -&gt; String</code></td><td><code>to_string</code></td><td>concatenates the <a href="rust//book/rust/custom-types.html">custom type</a> with another <a href="rust//book/language/strings-chars.html">string</a></td></tr>
<tr><td><code>+</code> operator</td><td><code>|x: &amp;mut T, s: &amp;str| -&gt; String</code></td><td><code>to_string</code></td><td>concatenates another <a href="rust//book/language/strings-chars.html">string</a> with the <a href="rust//book/rust/custom-types.html">custom type</a></td></tr>
<tr><td><code>+=</code> operator</td><td><code>|s: &amp;mut ImmutableString, x: T|</code></td><td><code>to_string</code></td><td>appends the <a href="rust//book/rust/custom-types.html">custom type</a> to an existing <a href="rust//book/language/strings-chars.html">string</a></td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="modules"><a class="header" href="#modules">Modules</a></h1>
<p>Rhai allows organizing functionalities (<a href="rust/modules//book/language/functions.html">functions</a>, both Rust-based and scripted, and
<a href="rust/modules//book/language/variables.html">variables</a>) into independent <em>modules</em>.</p>
<p>A module has the type <code>rhai::Module</code> and holds a collection of <a href="rust/modules//book/language/functions.html">functions</a>, <a href="rust/modules//book/language/variables.html">variables</a>, <a href="rust/modules//book/language/iterator.html">type
iterators</a> and sub-modules.</p>
<p>It may contain entirely Rust functions, or it may encapsulate a Rhai script together with
all the <a href="rust/modules//book/language/functions.html">functions</a> and <a href="rust/modules//book/language/variables.html">variables</a> defined by that script.</p>
<p>Other scripts then load this module and use the <a href="rust/modules//book/language/functions.html">functions</a> and <a href="rust/modules//book/language/variables.html">variables</a> <a href="rust/modules//book/language/modules/export.html">exported</a>.</p>
<p>Alternatively, modules can be registered directly into an <a href="rust/modules//book/engine/hello-world.html"><code>Engine</code></a> and made available to scripts,
either globally or under individual static module <a href="rust/modules//book/language/fn-namespaces.html"><em>namespaces</em></a>.</p>
<p>Modules can be disabled via the <a href="rust/modules//book/start/features.html"><code>no_module</code></a> feature.</p>
<h2 id="usage-patterns"><a class="header" href="#usage-patterns">Usage Patterns</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Usage</th><th style="text-align: center">API</th><th style="text-align: center">Lookup</th><th style="text-align: center">Sub-modules?</th><th style="text-align: center">Variables?</th></tr></thead><tbody>
<tr><td>Global module</td><td style="text-align: center"><code>Engine:: register_global_module</code></td><td style="text-align: center">simple name</td><td style="text-align: center">ignored</td><td style="text-align: center">yes</td></tr>
<tr><td>Static module</td><td style="text-align: center"><code>Engine:: register_static_module</code></td><td style="text-align: center">namespace-qualified name</td><td style="text-align: center">yes</td><td style="text-align: center">yes</td></tr>
<tr><td>Dynamic module</td><td style="text-align: center"><a href="rust/modules//book/language/modules/import.html"><code>import</code></a> statement</td><td style="text-align: center">namespace-qualified name</td><td style="text-align: center">yes</td><td style="text-align: center">yes</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="create-a-module-in-rust"><a class="header" href="#create-a-module-in-rust">Create a Module in Rust</a></h1>
<h2 id="the-easy-way--plugin"><a class="header" href="#the-easy-way--plugin">The Easy Way – Plugin</a></h2>
<p>By far the simplest way to create a <a href="rust/modules//book/rust/modules/index.html">module</a> is via a <a href="rust/modules//book/plugins/module.html">plugin module</a>
which converts a normal Rust module into a Rhai <a href="rust/modules//book/rust/modules/index.html">module</a> via procedural macros.</p>
<h2 id="the-hard-way--module-api"><a class="header" href="#the-hard-way--module-api">The Hard Way – <code>Module</code> API</a></h2>
<p>Manually creating a <a href="rust/modules//book/rust/modules/index.html">module</a> is possible via the <a href="rust/modules//book/rust/modules/index.html"><code>Module</code></a> public API, which is volatile and may
change from time to time.</p>
<div id="admonition-module-public-api" class="admonition admonish-info small" role="note" aria-labelledby="admonition-module-public-api-title">
<div class="admonition-title">
<div id="admonition-module-public-api-title">
<p><code>Module</code> public API</p>
</div>
<a class="admonition-anchor-link" href="rust/modules/create.html#admonition-module-public-api"></a>
</div>
<div>
<p>For the complete <a href="rust/modules//book/rust/modules/index.html"><code>Module</code></a> public API, refer to the
<a href="https://docs.rs/rhai/1.22.0/rhai/struct.Module.html">documentation</a> online.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="create-a-module-from-an-ast"><a class="header" href="#create-a-module-from-an-ast">Create a Module from an AST</a></h1>
<h2 id="moduleeval_ast_as_new"><a class="header" href="#moduleeval_ast_as_new"><code>Module::eval_ast_as_new</code></a></h2>
<div id="admonition-encapsulated-environment" class="admonition admonish-info side wide" role="note" aria-labelledby="admonition-encapsulated-environment-title">
<div class="admonition-title">
<div id="admonition-encapsulated-environment-title">
<p>Encapsulated environment</p>
</div>
<a class="admonition-anchor-link" href="rust/modules/ast.html#admonition-encapsulated-environment"></a>
</div>
<div>
<p><code>Module::eval_ast_as_new</code> encapsulates the entire <a href="rust/modules//book/engine/compile.html"><code>AST</code></a> into each function call, merging the
<a href="rust/modules//book/language/fn-namespaces.html">module namespace</a> with the <a href="rust/modules//book/language/fn-namespaces.html">global namespace</a>.</p>
<p>Therefore, <a href="rust/modules//book/language/functions.html">functions</a> defined within the same <a href="rust/modules//book/rust/modules/index.html">module</a> script can cross-call each other.</p>
</div>
</div>
<div id="admonition-see-also" class="admonition admonish-info side wide" role="note" aria-labelledby="admonition-see-also-title">
<div class="admonition-title">
<div id="admonition-see-also-title">
<p>See also</p>
</div>
<a class="admonition-anchor-link" href="rust/modules/ast.html#admonition-see-also"></a>
</div>
<div>
<p>See <a href="rust/modules//book/language/modules/export.html"><em>Export Variables, Functions and Sub-Modules from Script</em></a> for details on how to prepare
a Rhai script for this purpose as well as to control which <a href="rust/modules//book/language/functions.html">functions</a>/<a href="rust/modules//book/language/variables.html">variables</a> to export.</p>
</div>
</div>
<p>A <a href="rust/modules//book/rust/modules/index.html">module</a> can be created from a single script (or pre-compiled <a href="rust/modules//book/engine/compile.html"><code>AST</code></a>) containing global
<a href="rust/modules//book/language/variables.html">variables</a>, <a href="rust/modules//book/language/functions.html">functions</a> and <a href="rust/modules//book/rust/modules/index.html">sub-modules</a> via <code>Module::eval_ast_as_new</code>.</p>
<p>When given an <a href="rust/modules//book/engine/compile.html"><code>AST</code></a>, it is first evaluated (usually to <a href="rust/modules//book/language/modules/import.html">import</a> <a href="rust/modules//book/rust/modules/index.html">modules</a> and set up global
<a href="rust/modules//book/language/constants.html">constants</a> used by <a href="rust/modules//book/language/functions.html">functions</a>), then the following items are exposed as members of the new <a href="rust/modules//book/rust/modules/index.html">module</a>:</p>
<ul>
<li>
<p>global <a href="rust/modules//book/language/variables.html">variables</a> and <a href="rust/modules//book/language/constants.html">constants</a> – all <a href="rust/modules//book/language/variables.html">variables</a> and <a href="rust/modules//book/language/constants.html">constants</a> exported via the
<a href="rust/modules//book/language/modules/export.html"><code>export</code></a> statement (those not exported remain hidden),</p>
</li>
<li>
<p><a href="rust/modules//book/language/functions.html">functions</a> not specifically marked <a href="rust/modules//book/language/modules/export.html"><code>private</code></a>,</p>
</li>
<li>
<p>imported <a href="rust/modules//book/rust/modules/index.html">modules</a> that remain in the <a href="rust/modules//book/engine/scope.html"><code>Scope</code></a> at the end of a script run become sub-modules.</p>
</li>
</ul>
<h2 id="examples-3"><a class="header" href="#examples-3">Examples</a></h2>
<p>Don’t forget the <a href="rust/modules//book/language/modules/export.html"><code>export</code></a> statement, otherwise there will be no <a href="rust/modules//book/language/variables.html">variables</a> exposed by the
<a href="rust/modules//book/rust/modules/index.html">module</a> other than non-<a href="rust/modules//book/language/modules/export.html"><code>private</code></a> <a href="rust/modules//book/language/functions.html">functions</a> (unless that’s intentional).</p>
<pre><code class="language-rust">use rhai::{Engine, Module};

let engine = Engine::new();

// Compile a script into an 'AST'
let ast = engine.compile(
r#"
    // Functions become module functions
    fn calc(x) {
        x + add_len(x, 1)       // functions within the same module
                                // can always cross-call each other!
    }
    fn add_len(x, y) {
        x + y.len
    }

    // Imported modules become sub-modules
    import "another module" as extra;

    // Variables defined at global level can become module variables
    const x = 123;
    let foo = 41;
    let hello;

    // Variable values become constant module variable values
    foo = calc(foo);
    hello = `hello, ${foo} worlds!`;

    // Finally, export the variables and modules
    export x as abc;            // aliased variable name
    export foo;
    export hello;
"#)?;

// Convert the 'AST' into a module, using the 'Engine' to evaluate it first
// A copy of the entire 'AST' is encapsulated into each function,
// allowing functions in the module script to cross-call each other.
let module = Module::eval_ast_as_new(Scope::new(), &amp;ast, &amp;engine)?;

// 'module' now contains:
//   - sub-module: 'extra'
//   - functions: 'calc', 'add_len'
//   - constants: 'abc' (renamed from 'x'), 'foo', 'hello'</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="make-a-module-available-to-scripts"><a class="header" href="#make-a-module-available-to-scripts">Make a Module Available to Scripts</a></h1>
<h2 id="use-case-1--make-it-globally-available"><a class="header" href="#use-case-1--make-it-globally-available">Use Case 1 – Make It Globally Available</a></h2>
<p><code>Engine::register_global_module</code> registers a shared <a href="rust/modules//book/rust/modules/index.html">module</a> into the
<a href="rust/modules//book/language/fn-namespaces.html"><em>global</em> namespace</a>.</p>
<p>This is by far the easiest way to expose a <a href="rust/modules//book/rust/modules/index.html">module</a>’s functionalities to Rhai.</p>
<div id="admonition-tip-no-qualifiers" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-no-qualifiers-title">
<div class="admonition-title">
<div id="admonition-tip-no-qualifiers-title">
<p>Tip: No qualifiers</p>
</div>
<a class="admonition-anchor-link" href="rust/modules/use.html#admonition-tip-no-qualifiers"></a>
</div>
<div>
<p>All <a href="rust/modules//book/language/functions.html">functions</a>, <a href="rust/modules//book/language/variables.html">variables</a>/<a href="rust/modules//book/language/constants.html">constants</a> and <a href="rust/modules//book/language/iterator.html">type iterators</a> can be accessed without
<em>namespace qualifiers</em>.</p>
</div>
</div>
<div id="admonition-warning" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="rust/modules/use.html#admonition-warning"></a>
</div>
<div>
<p><a href="rust/modules//book/rust/modules/index.html">Sub-modules</a> are <strong>ignored</strong>.</p>
</div>
</div>
<pre><code class="language-rust">use rhai::{Engine, Module, FuncRegistration};

let mut module = Module::new();             // new module

// Add new function.
FuncRegistration::new("inc")
    .with_params_info(&amp;["x: i64", "i64"])
    .set_into_module(&amp;mut module, |x: i64| x + 1);

// Use 'Module::set_var' to add variables.
module.set_var("MYSTIC_NUMBER", 41_i64);

// Register the module into the global namespace of the Engine.
let mut engine = Engine::new();
engine.register_global_module(module.into());

// No need to import module...
engine.eval::&lt;i64&gt;("inc(MYSTIC_NUMBER)")? == 42;</code></pre>
<h3 id="equivalent-to-engineregister_xxx"><a class="header" href="#equivalent-to-engineregister_xxx">Equivalent to <code>Engine::register_XXX</code></a></h3>
<div id="admonition-trivia" class="admonition admonish-question side" role="note" aria-labelledby="admonition-trivia-title">
<div class="admonition-title">
<div id="admonition-trivia-title">
<p>Trivia</p>
</div>
<a class="admonition-anchor-link" href="rust/modules/use.html#admonition-trivia"></a>
</div>
<div>
<p><code>Engine::register_fn</code> etc. are actually implemented by adding functions to an
internal <a href="rust/modules//book/rust/modules/index.html">module</a>!</p>
</div>
</div>
<p>Registering a <a href="rust/modules//book/rust/modules/index.html">module</a> via <code>Engine::register_global_module</code> is essentially the <em>same</em>
as calling <code>Engine::register_fn</code> (or any of the <code>Engine::register_XXX</code> API) individually
on each top-level function within that <a href="rust/modules//book/rust/modules/index.html">module</a>.</p>
<pre><code class="language-rust">// The above is essentially the same as:
let mut engine = Engine::new();

engine.register_fn("inc", |x: i64| x + 1);

engine.eval::&lt;i64&gt;("inc(41)")? == 42;       // no need to import module</code></pre>
<h2 id="use-case-2--make-it-a-static-namespace"><a class="header" href="#use-case-2--make-it-a-static-namespace">Use Case 2 – Make It a Static Namespace</a></h2>
<p><code>Engine::register_static_module</code> registers a <a href="rust/modules//book/rust/modules/index.html">module</a> and under a specific
<a href="rust/modules//book/language/fn-namespaces.html">module namespace</a>.</p>
<pre><code class="language-rust">use rhai::{Engine, Module, FuncRegistration};

let mut module = Module::new();             // new module

// Add new function.
FuncRegistration::new("inc")
    .with_params_info(&amp;["x: i64", "i64"])
    .set_into_module(&amp;mut module, |x: i64| x + 1);

// Use 'Module::set_var' to add variables.
module.set_var("MYSTIC_NUMBER", 41_i64);

// Register the module into the Engine as the static module namespace path
// 'services::calc'
let mut engine = Engine::new();
engine.register_static_module("services::calc", module.into());

// Refer to the 'services::calc' module...
engine.eval::&lt;i64&gt;("services::calc::inc(services::calc::MYSTIC_NUMBER)")? == 42;</code></pre>
<h3 id="expose-functions-to-the-global-namespace"><a class="header" href="#expose-functions-to-the-global-namespace">Expose functions to the global namespace</a></h3>
<div id="admonition-tip-type-iterators" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-type-iterators-title">
<div class="admonition-title">
<div id="admonition-tip-type-iterators-title">
<p>Tip: Type iterators</p>
</div>
<a class="admonition-anchor-link" href="rust/modules/use.html#admonition-tip-type-iterators"></a>
</div>
<div>
<p><a href="rust/modules//book/language/iterator.html">Type iterators</a> are special — they are <em>always</em> exposed to the
<a href="rust/modules//book/language/fn-namespaces.html"><em>global</em> namespace</a>.</p>
</div>
</div>
<p>The <a href="rust/modules//book/rust/modules/index.html"><code>Module</code></a> API can optionally expose functions to the <a href="rust/modules//book/language/fn-namespaces.html"><em>global</em> namespace</a>
by setting the <code>namespace</code> parameter to <code>FnNamespace::Global</code>.</p>
<p>This way, <a href="rust/modules//book/rust/getters-setters.html">getters/setters</a> and <a href="rust/modules//book/rust/indexers.html">indexers</a> for <a href="rust/modules//book/rust/custom-types.html">custom types</a> can work as expected.</p>
<pre><code class="language-rust">use rhai::{Engine, Module, FuncRegistration, FnNamespace};

let mut module = Module::new();             // new module

// Add new function.
FuncRegistration::new("inc")
    .with_params_info(&amp;["x: i64", "i64"])
    .with_namespace(FnNamespace::Global)    // &lt;- global namespace
    .set_into_module(&amp;mut module, |x: i64| x + 1);

// Use 'Module::set_var' to add variables.
module.set_var("MYSTIC_NUMBER", 41_i64);

// Register the module into the Engine as a static module namespace 'calc'
let mut engine = Engine::new();
engine.register_static_module("calc", module.into());

// 'inc' works when qualified by the namespace
engine.eval::&lt;i64&gt;("calc::inc(calc::MYSTIC_NUMBER)")? == 42;

// 'inc' also works without a namespace qualifier
// because it is exposed to the global namespace
engine.eval::&lt;i64&gt;("let x = calc::MYSTIC_NUMBER; x.inc()")? == 42;
engine.eval::&lt;i64&gt;("let x = calc::MYSTIC_NUMBER; inc(x)")? == 42;</code></pre>
<h2 id="use-case-3--make-it-dynamically-loadable"><a class="header" href="#use-case-3--make-it-dynamically-loadable">Use Case 3 – Make It Dynamically Loadable</a></h2>
<p>In order to dynamically load a custom module, there must be a <a href="rust/modules//book/rust/modules/resolvers/index.html">module resolver</a> which serves
the module when loaded via <code>import</code> statements.</p>
<p>The easiest way is to use, for example, the <a href="rust/modules//book/rust/modules/resolvers/index.html"><code>StaticModuleResolver</code></a> to hold such
a custom module.</p>
<pre><code class="language-rust">use rhai::{Engine, Scope, Module, FuncRegistration};
use rhai::module_resolvers::StaticModuleResolver;

let mut module = Module::new();             // new module

module.set_var("answer", 41_i64);           // variable 'answer' under module

FuncRegistration::new("inc")
    .with_params_info(&amp;["x: i64"])
    .set_into_module(&amp;mut module, |x: i64| x + 1);

// Create the module resolver
let mut resolver = StaticModuleResolver::new();

// Add the module into the module resolver under the name 'question'
// They module can then be accessed via: 'import "question" as q;'
resolver.insert("question", module);

// Set the module resolver into the 'Engine'
let mut engine = Engine::new();
engine.set_module_resolver(resolver);

// Use namespace-qualified variables
engine.eval::&lt;i64&gt;(
r#"
    import "question" as q;
    q::answer + 1
"#)? == 42;

// Call namespace-qualified functions
engine.eval::&lt;i64&gt;(
r#"
    import "question" as q;
    q::inc(q::answer)
"#)? == 42;</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="module-resolvers"><a class="header" href="#module-resolvers">Module Resolvers</a></h1>
<div id="admonition-import" class="admonition admonish-info side" role="note" aria-labelledby="admonition-import-title">
<div class="admonition-title">
<div id="admonition-import-title">
<p><code>import</code></p>
</div>
<a class="admonition-anchor-link" href="rust/modules/resolvers/index.html#admonition-import"></a>
</div>
<div>
<p>See the section on <a href="rust/modules/resolvers//book/language/modules/import.html"><em>Importing Modules</em></a> for more details.</p>
</div>
</div>
<p>When encountering an <a href="rust/modules/resolvers//book/language/modules/import.html"><code>import</code></a> statement, Rhai attempts to <em>resolve</em> the <a href="rust/modules/resolvers//book/rust/modules/index.html">module</a> based on the path string.</p>
<p><em>Module Resolvers</em> are service types that implement the <a href="rust/modules/resolvers//book/rust/traits.html"><code>ModuleResolver</code></a> trait.</p>
<h2 id="set-into-engine"><a class="header" href="#set-into-engine">Set into <code>Engine</code></a></h2>
<p>An <a href="rust/modules/resolvers//book/engine/hello-world.html"><code>Engine</code></a>’s module resolver is set via a call to <code>Engine::set_module_resolver</code>:</p>
<pre><code class="language-rust">use rhai::module_resolvers::{DummyModuleResolver, StaticModuleResolver};

// Create a module resolver
let resolver = StaticModuleResolver::new();

// Register functions into 'resolver'...

// Use the module resolver
engine.set_module_resolver(resolver);

// Effectively disable 'import' statements by setting module resolver to
// the 'DummyModuleResolver' which acts as... well... a dummy.
engine.set_module_resolver(DummyModuleResolver::new());</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="built-in-module-resolvers"><a class="header" href="#built-in-module-resolvers">Built-in Module Resolvers</a></h1>
<p>There are a number of standard <a href="rust/modules/resolvers//book/rust/modules/resolvers/index.html">module resolvers</a> built into Rhai, the default being the
<a href="rust/modules/resolvers/file.html"><code>FileModuleResolver</code></a> which simply loads a script file based on the path (with <code>.rhai</code>
extension attached) and execute it to form a <a href="rust/modules/resolvers//book/rust/modules/index.html">module</a>.</p>
<p>Built-in <a href="rust/modules/resolvers//book/rust/modules/resolvers/index.html">module resolvers</a> are grouped under the <code>rhai::module_resolvers</code> module.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dummymoduleresolver"><a class="header" href="#dummymoduleresolver"><code>DummyModuleResolver</code></a></h1>
<div id="admonition-default" class="admonition admonish-abstract small" role="note" aria-labelledby="admonition-default-title">
<div class="admonition-title">
<div id="admonition-default-title">
<p>Default</p>
</div>
<a class="admonition-anchor-link" href="rust/modules/resolvers/dummy.html#admonition-default"></a>
</div>
<div>
<p><code>DummyModuleResolver</code> is the default for <a href="rust/modules/resolvers//book/start/features.html"><code>no_std</code></a> or <a href="rust/modules/resolvers//book/engine/raw.html"><code>Engine::new_raw</code></a>.</p>
</div>
</div>
<p>This <a href="rust/modules/resolvers//book/rust/modules/resolvers/index.html">module resolver</a> acts as a <em>dummy</em> and fails all module resolution calls.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="filemoduleresolver"><a class="header" href="#filemoduleresolver"><code>FileModuleResolver</code></a></h1>
<div id="admonition-default" class="admonition admonish-abstract small" role="note" aria-labelledby="admonition-default-title">
<div class="admonition-title">
<div id="admonition-default-title">
<p>Default</p>
</div>
<a class="admonition-anchor-link" href="rust/modules/resolvers/file.html#admonition-default"></a>
</div>
<div>
<p><code>FileModuleResolver</code> is the default for <a href="rust/modules/resolvers//book/engine/hello-world.html"><code>Engine::new</code></a>.</p>
</div>
</div>
<p>The <em>default</em> <a href="rust/modules/resolvers//book/rust/modules/index.html">module</a> resolution service, not available for <a href="rust/modules/resolvers//book/start/features.html"><code>no_std</code></a> or <a href="rust/modules/resolvers//book/start/builds/wasm.html">WASM</a> builds.
Loads a script file (based off the current directory or a specified one) with <code>.rhai</code> extension.</p>
<h2 id="function-namespace"><a class="header" href="#function-namespace">Function Namespace</a></h2>
<p>All functions in the <a href="rust/modules/resolvers//book/language/fn-namespaces.html"><em>global</em> namespace</a>, plus all those defined in the same
<a href="rust/modules/resolvers//book/rust/modules/index.html">module</a>, are <em>merged</em> into a <em>unified</em> <a href="rust/modules/resolvers//book/language/fn-namespaces.html">namespace</a>.</p>
<p>All <a href="rust/modules/resolvers//book/rust/modules/index.html">modules</a> imported at <em>global</em> level via <a href="rust/modules/resolvers//book/language/modules/import.html"><code>import</code></a> statements become sub-<a href="rust/modules/resolvers//book/rust/modules/index.html">modules</a>,
which are also available to <a href="rust/modules/resolvers//book/language/functions.html">functions</a> defined within the same script file.</p>
<h2 id="base-directory"><a class="header" href="#base-directory">Base Directory</a></h2>
<div id="admonition-tip-default" class="admonition admonish-tip side wide" role="note" aria-labelledby="admonition-tip-default-title">
<div class="admonition-title">
<div id="admonition-tip-default-title">
<p>Tip: Default</p>
</div>
<a class="admonition-anchor-link" href="rust/modules/resolvers/file.html#admonition-tip-default"></a>
</div>
<div>
<p>If the base directory is not set, then relative paths are based off the directory of the loading script.</p>
<p>This allows scripts to simply cross-load each other.</p>
</div>
</div>
<p><em>Relative</em> paths are resolved relative to a <em>root</em> directory, which is usually the base directory.</p>
<p>The base directory can be set via <code>FileModuleResolver::new_with_path</code> or
<code>FileModuleResolver::set_base_path</code>.</p>
<h2 id="custom-scope"><a class="header" href="#custom-scope">Custom <a href="rust/modules/resolvers//book/engine/scope.html"><code>Scope</code></a></a></h2>
<div id="admonition-tip" class="admonition admonish-tip side wide" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="rust/modules/resolvers/file.html#admonition-tip"></a>
</div>
<div>
<p>This <a href="rust/modules/resolvers//book/engine/scope.html"><code>Scope</code></a> can conveniently hold global <a href="rust/modules/resolvers//book/language/constants.html">constants</a> etc.</p>
</div>
</div>
<p>The <code>set_scope</code> method adds an optional <a href="rust/modules/resolvers//book/engine/scope.html"><code>Scope</code></a> which will be used to <a href="rust/modules/resolvers//book/engine/optimize/index.html">optimize</a> <a href="rust/modules/resolvers//book/rust/modules/index.html">module</a> scripts.</p>
<h2 id="caching-1"><a class="header" href="#caching-1">Caching</a></h2>
<div id="admonition-tip-enabledisable-caching" class="admonition admonish-tip side wide" role="note" aria-labelledby="admonition-tip-enabledisable-caching-title">
<div class="admonition-title">
<div id="admonition-tip-enabledisable-caching-title">
<p>Tip: Enable/disable caching</p>
</div>
<a class="admonition-anchor-link" href="rust/modules/resolvers/file.html#admonition-tip-enabledisable-caching"></a>
</div>
<div>
<p>Use <code>enable_cache</code> to enable/disable the cache.</p>
</div>
</div>
<p>By default, <a href="rust/modules/resolvers//book/rust/modules/index.html">modules</a> are also <em>cached</em> so a script file is only evaluated <em>once</em>, even when
repeatedly imported.</p>
<h2 id="unix-shebangs"><a class="header" href="#unix-shebangs">Unix Shebangs</a></h2>
<p>On Unix-like systems, the <em>shebang</em> (<code>#!</code>) is used at the very beginning of a script file to mark a
script with an interpreter (for Rhai this would be <a href="rust/modules/resolvers//book/start/bin.html"><code>rhai-run</code></a>).</p>
<p>If a script file starts with <code>#!</code>, the entire first line is skipped.
Because of this, Rhai scripts with shebangs at the beginning need no special processing.</p>
<pre><code class="language-js">#!/home/to/me/bin/rhai-run

// This is a Rhai script

let answer = 42;
print(`The answer is: ${answer}`);
</code></pre>
<h2 id="example-8"><a class="header" href="#example-8">Example</a></h2>
<pre><code class="language-rust">┌────────────────┐
│ my_module.rhai │
└────────────────┘

// This function overrides any in the main script.
private fn inner_message() { "hello! from module!" }

fn greet() {
    print(inner_message());     // call function in module script
}

fn greet_main() {
    print(main_message());      // call function not in module script
}


┌───────────┐
│ main.rhai │
└───────────┘

// This function is overridden by the module script.
fn inner_message() { "hi! from main!" }

// This function is found by the module script.
fn main_message() { "main here!" }

import "my_module" as m;

m::greet();                     // prints "hello! from module!"

m::greet_main();                // prints "main here!"</code></pre>
<h2 id="simulate-virtual-functions"><a class="header" href="#simulate-virtual-functions">Simulate Virtual Functions</a></h2>
<p>When calling a namespace-qualified <a href="rust/modules/resolvers//book/language/functions.html">function</a> defined within a <a href="rust/modules/resolvers//book/rust/modules/index.html">module</a>, other <a href="rust/modules/resolvers//book/language/functions.html">functions</a> defined
within the same module override any similar-named <a href="rust/modules/resolvers//book/language/functions.html">functions</a> (with the same number of parameters)
defined in the <a href="rust/modules/resolvers//book/language/fn-namespaces.html">global namespace</a>.</p>
<p>This is to ensure that a <a href="rust/modules/resolvers//book/rust/modules/index.html">module</a> acts as a self-contained unit and <a href="rust/modules/resolvers//book/language/functions.html">functions</a> defined in the
calling script do not override <a href="rust/modules/resolvers//book/rust/modules/index.html">module</a> code.</p>
<p>In some situations, however, it is actually beneficial to do it in reverse: have <a href="rust/modules/resolvers//book/rust/modules/index.html">module</a> <a href="rust/modules/resolvers//book/language/functions.html">functions</a> call
<a href="rust/modules/resolvers//book/language/functions.html">functions</a> defined in the calling script (i.e. in the <a href="rust/modules/resolvers//book/language/fn-namespaces.html">global namespace</a>) if
they exist, and only call those defined in the <a href="rust/modules/resolvers//book/rust/modules/index.html">module</a> if none are found.</p>
<p>One such situation is the need to provide a <em>default implementation</em> to a simulated <em>virtual</em> function:</p>
<pre><code class="language-rust">┌────────────────┐
│ my_module.rhai │
└────────────────┘

// Do not do this (it will override the main script):
// fn message() { "hello! from module!" }

// This function acts as the default implementation.
private fn default_message() { "hello! from module!" }

// This function depends on a 'virtual' function 'message'
// which is not defined in the module script.
fn greet() {
    if is_def_fn("message", 0) {    // 'is_def_fn' detects if 'message' is defined.
        print(message());
    } else {
        print(default_message());
    }
}


┌───────────┐
│ main.rhai │
└───────────┘

// The main script defines 'message' which is needed by the module script.
fn message() { "hi! from main!" }

import "my_module" as m;

m::greet();                         // prints "hi! from main!"


┌────────────┐
│ main2.rhai │
└────────────┘

// The main script does not define 'message' which is needed by the module script.

import "my_module" as m;

m::greet();                         // prints "hello! from module!"</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="staticmoduleresolver"><a class="header" href="#staticmoduleresolver"><code>StaticModuleResolver</code></a></h1>
<div id="admonition-useful-for-no-std" class="admonition admonish-abstract small" role="note" aria-labelledby="admonition-useful-for-no-std-title">
<div class="admonition-title">
<div id="admonition-useful-for-no-std-title">
<p>Useful for <code>no-std</code></p>
</div>
<a class="admonition-anchor-link" href="rust/modules/resolvers/static.html#admonition-useful-for-no-std"></a>
</div>
<div>
<p><code>StaticModuleResolver</code> is often used with <a href="rust/modules/resolvers//book/start/features.html"><code>no_std</code></a> in embedded environments
without a file system.</p>
</div>
</div>
<p>Loads <a href="rust/modules/resolvers//book/rust/modules/index.html">modules</a> that are statically added.</p>
<p>Functions are searched in the <a href="rust/modules/resolvers//book/language/fn-namespaces.html"><em>global</em> namespace</a> by default.</p>
<pre><code class="language-rust">use rhai::{Module, module_resolvers::StaticModuleResolver};

let module: Module = create_a_module();

let mut resolver = StaticModuleResolver::new();
resolver.insert("my_module", module);

engine.set_module_resolver(resolver);</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="moduleresolverscollection"><a class="header" href="#moduleresolverscollection"><code>ModuleResolversCollection</code></a></h1>
<p>A collection of <a href="rust/modules/resolvers//book/rust/modules/resolvers/index.html">module resolvers</a>.</p>
<p><a href="rust/modules/resolvers//book/rust/modules/index.html">Modules</a> are resolved from each resolver in sequential order.</p>
<p>This is useful when multiple types of <a href="rust/modules/resolvers//book/rust/modules/index.html">modules</a> are needed simultaneously.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dylibmoduleresolver"><a class="header" href="#dylibmoduleresolver"><code>DylibModuleResolver</code></a></h1>
<div id="admonition-requires-external-crate-rhai-dylib" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-requires-external-crate-rhai-dylib-title">
<div class="admonition-title">
<div id="admonition-requires-external-crate-rhai-dylib-title">
<p>Requires external crate <code>rhai-dylib</code></p>
</div>
<a class="admonition-anchor-link" href="rust/modules/resolvers/dylib.html#admonition-requires-external-crate-rhai-dylib"></a>
</div>
<div>
<p><code>DylibModuleResolver</code> resides in the <a href="rust/modules/resolvers//book/lib/rhai-dylib.html"><code>rhai-dylib</code></a> crate which must be specified
as a dependency:</p>
<pre><code class="language-toml">[dependencies]
rhai-dylib = { version = "0.1" }
</code></pre>
</div>
</div>
<div id="admonition-linux-or-windows-only" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-linux-or-windows-only-title">
<div class="admonition-title">
<div id="admonition-linux-or-windows-only-title">
<p>Linux or Windows only</p>
</div>
<a class="admonition-anchor-link" href="rust/modules/resolvers/dylib.html#admonition-linux-or-windows-only"></a>
</div>
<div>
<p><a href="rust/modules/resolvers//book/lib/rhai-dylib.html"><code>rhai-dylib</code></a> currently supports only Linux and Windows.</p>
</div>
</div>
<p>Parallel to how the <a href="rust/modules/resolvers/file.html"><code>FileModuleResolver</code></a> works, <code>DylibModuleResolver</code> loads external
native Rust <a href="rust/modules/resolvers//book/rust/modules/index.html">modules</a> from compiled <em>dynamic shared libraries</em> (e.g. <code>.so</code> in Linux and <code>.dll</code> in
Windows).</p>
<p>Therefore, <a href="rust/modules/resolvers/file.html"><code>FileModuleResolver</code></a> loads Rhai script files while <code>DylibModuleResolver</code>
loads native Rust shared libraries.  It is very common to have the two work together.</p>
<h2 id="example-9"><a class="header" href="#example-9">Example</a></h2>
<pre><code class="language-rust">use rhai::{Engine, Module};
use rhai::module_resolvers::{FileModuleResolver, ModuleResolversCollection};
use rhai_dylib::module_resolvers::DylibModuleResolver;

let mut engine = Engine::new();

// Use a module resolvers collection
let mut resolvers = ModuleResolversCollection::new();

// First search for script files in the file system
resolvers += FileModuleResolver::new();

// Then search for shared-library plugins in the file system
resolvers += DylibModuleResolver::new();

// Set the module resolver into the engine
engine.set_module_resolver(resolvers);


┌─────────────┐
│ Rhai Script │
└─────────────┘

// If there is 'path/to/my_module.rhai', load it.
// Otherwise, check for 'path/to/my_module.so' on Linux
// ('path/to/my_module.dll' on Windows).
import "path/to/my_module" as m;

m::greet();</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="implement-a-custom-module-resolver"><a class="header" href="#implement-a-custom-module-resolver">Implement a Custom Module Resolver</a></h1>
<p>For many applications in which Rhai is embedded, it is necessary to customize the way that <a href="rust/modules/resolvers//book/rust/modules/index.html">modules</a>
are resolved.  For instance, <a href="rust/modules/resolvers//book/rust/modules/index.html">modules</a> may need to be loaded from script texts stored in a database,
not in the file system.</p>
<p>A module resolver must implement the <a href="rust/modules/resolvers//book/rust/traits.html"><code>ModuleResolver</code></a> trait, which contains only one
required function: <code>resolve</code>.</p>
<p>When Rhai prepares to load a module, <code>ModuleResolver::resolve</code> is called with the name
of the <em>module path</em> (i.e. the path specified in the <a href="rust/modules/resolvers//book/language/modules/import.html"><code>import</code></a> statement).</p>
<div id="admonition-success" class="admonition admonish-success" role="note" aria-labelledby="admonition-success-title">
<div class="admonition-title">
<div id="admonition-success-title">
<p>Success</p>
</div>
<a class="admonition-anchor-link" href="rust/modules/resolvers/custom.html#admonition-success"></a>
</div>
<div>
<p>Upon success, it should return a shared <a href="rust/modules/resolvers//book/rust/modules/index.html">module</a> wrapped by <code>Rc</code> (or <code>Arc</code> under <a href="rust/modules/resolvers//book/start/features.html"><code>sync</code></a>).</p>
<p>The module resolver should call <code>Module::build_index</code> on the target <a href="rust/modules/resolvers//book/rust/modules/index.html">module</a> before returning it.</p>
<ul>
<li>This method flattens the entire module tree and <em>indexes</em> it for fast function name resolution.</li>
<li>If the module is already indexed, calling this method has no effect.</li>
</ul>
</div>
</div>
<div id="admonition-failure" class="admonition admonish-failure" role="note" aria-labelledby="admonition-failure-title">
<div class="admonition-title">
<div id="admonition-failure-title">
<p>Failure</p>
</div>
<a class="admonition-anchor-link" href="rust/modules/resolvers/custom.html#admonition-failure"></a>
</div>
<div>
<ul>
<li>
<p>If the path does not resolve to a valid module, return <code>EvalAltResult::ErrorModuleNotFound</code>.</p>
</li>
<li>
<p>If the module failed to load, return <code>EvalAltResult::ErrorInModule</code>.</p>
</li>
</ul>
</div>
</div>
<h2 id="example-of-a-custom-module-resolver"><a class="header" href="#example-of-a-custom-module-resolver">Example of a Custom Module Resolver</a></h2>
<pre><code class="language-rust">use rhai::{ModuleResolver, Module, Engine, EvalAltResult};

// Define a custom module resolver.
struct MyModuleResolver {}

// Implement the 'ModuleResolver' trait.
impl ModuleResolver for MyModuleResolver {
    // Only required function.
    fn resolve(
        &amp;self,
        engine: &amp;Engine,                        // reference to the current 'Engine'
        source_path: Option&lt;&amp;str&gt;,              // path of the parent module
        path: &amp;str,                             // the module path
        pos: Position,                          // position of the 'import' statement
    ) -&gt; Result&lt;Rc&lt;Module&gt;, Box&lt;EvalAltResult&gt;&gt; {
        // Check module path.
        if is_valid_module_path(path) {
            // Load the custom module
            match load_secret_module(path) {
                Ok(my_module) =&gt; {
                    my_module.build_index();    // index it
                    Rc::new(my_module)          // make it shared
                },
                // Return 'EvalAltResult::ErrorInModule' upon loading error
                Err(err) =&gt; Err(EvalAltResult::ErrorInModule(path.into(), Box::new(err), pos).into())
            }
        } else {
            // Return 'EvalAltResult::ErrorModuleNotFound' if the path is invalid
            Err(EvalAltResult::ErrorModuleNotFound(path.into(), pos).into())
        }
    }
}

let mut engine = Engine::new();

// Set the custom module resolver into the 'Engine'.
engine.set_module_resolver(MyModuleResolver {});

engine.run(
r#"
    import "hello" as foo;  // this 'import' statement will call
                            // 'MyModuleResolver::resolve' with "hello" as 'path'
    foo:bar();
"#)?;</code></pre>
<h2 id="advanced--moduleresolverresolve_ast"><a class="header" href="#advanced--moduleresolverresolve_ast">Advanced – <code>ModuleResolver::resolve_ast</code></a></h2>
<p>There is another function in the <a href="rust/modules/resolvers//book/rust/traits.html"><code>ModuleResolver</code></a> trait, <code>resolve_ast</code>, which is a
low-level API intended for advanced usage scenarios.</p>
<p><code>ModuleResolver::resolve_ast</code> has a default implementation that simply returns <code>None</code>,
which indicates that this API is not supported by the <a href="rust/modules/resolvers//book/rust/modules/resolvers/index.html">module resolver</a>.</p>
<p>Any <a href="rust/modules/resolvers//book/rust/modules/resolvers/index.html">module resolver</a> that serves <a href="rust/modules/resolvers//book/rust/modules/index.html">modules</a> based on Rhai scripts should implement
<code>ModuleResolver::resolve_ast</code>. When called, the compiled <a href="rust/modules/resolvers//book/engine/compile.html"><code>AST</code></a> of the script should be returned.</p>
<p><code>ModuleResolver::resolve_ast</code> should not return an error if <code>ModuleResolver::resolve</code> will not.
On the other hand, the same error should be returned if <code>ModuleResolver::resolve</code> will return one.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="compile-to-a-self-contained-ast"><a class="header" href="#compile-to-a-self-contained-ast">Compile to a Self-Contained <code>AST</code></a></h1>
<div id="admonition-tip" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="rust/modules/self-contained.html#admonition-tip"></a>
</div>
<div>
<p>It does not matter where the <a href="rust/modules//book/language/modules/import.html"><code>import</code></a> statement occurs — e.g. deep within statements blocks
or within <a href="rust/modules//book/language/functions.html">function</a> bodies.</p>
</div>
</div>
<p>When a script <a href="rust/modules//book/language/modules/import.html">imports</a> external <a href="rust/modules//book/rust/modules/index.html">modules</a> that may not be available later on, it is
possible to eagerly <a href="rust/modules//book/rust/modules/resolvers/index.html"><em>pre-resolve</em></a> these imports and embed them directly into a
self-contained <a href="rust/modules//book/engine/compile.html"><code>AST</code></a>.</p>
<p>For instance, a system may periodically connect to a central source (e.g. a database) to load
scripts and compile them to <a href="rust/modules//book/engine/compile.html"><code>AST</code></a> form. Afterwards, in order to conserve bandwidth (or due to
other physical limitations), it is disconnected from the central source for self-contained
operation.</p>
<p>Compile a script into a <em>self-contained</em> <a href="rust/modules//book/engine/compile.html"><code>AST</code></a> via <code>Engine::compile_into_self_contained</code>.</p>
<pre><code class="language-rust">let mut engine = Engine::new();

// Compile script into self-contained AST using the current
// module resolver (default to `FileModuleResolver`) to pre-resolve
// 'import' statements.
let ast = engine.compile_into_self_contained(&amp;mut scope, script)?;

// Make sure we can no longer resolve any module!
engine.set_module_resolver(DummyModuleResolver::new());

// The AST still evaluates fine, even with 'import' statements!
engine.run(&amp;ast)?;</code></pre>
<p>When such an <a href="rust/modules//book/engine/compile.html"><code>AST</code></a> is evaluated, <a href="rust/modules//book/language/modules/import.html"><code>import</code></a> statements within are provided the <em>pre-resolved</em>
<a href="rust/modules//book/rust/modules/index.html">modules</a> without going through the normal <a href="rust/modules//book/rust/modules/resolvers/index.html">module resolution</a> process.</p>
<h2 id="only-static-paths"><a class="header" href="#only-static-paths">Only Static Paths</a></h2>
<p><code>Engine::compile_into_self_contained</code> only pre-resolves <a href="rust/modules//book/language/modules/import.html"><code>import</code></a> statements in the script
that are <em>static</em>, i.e. with a path that is a <a href="rust/modules//book/language/strings-chars.html">string</a> literal.</p>
<pre><code class="language-rust">// The following import is pre-resolved.
import "hello" as h;

if some_event() {
    // The following import is pre-resolved.
    import "hello" as h;
}

fn foo() {
    // The following import is pre-resolved.
    import "hello" as h;
}

// The following import is also pre-resolved because the expression
// is usually optimized into a single string during compilation.
import "he" + "llo" as h;

let module_name = "hello";

// The following import is NOT pre-resolved.
import module_name as h;</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="plugin-modules"><a class="header" href="#plugin-modules">Plugin Modules</a></h1>
<p>Rhai contains a robust <em>plugin</em> system that greatly simplifies registration of custom functionality.</p>
<p>Instead of using the complicated <code>Engine::register_XXX</code> or <a href="plugins//book/rust/modules/index.html"><code>Module</code></a>’s <code>FuncRegistration</code> API to
register Rust functions, a <em>plugin</em> simplifies the work of creating and registering new
functionality to an <a href="plugins//book/engine/hello-world.html"><code>Engine</code></a>.</p>
<p>Plugins are processed via a set of procedural macros under the <code>rhai::plugin</code> module. These allow
registering Rust functions directly into an <a href="plugins//book/engine/hello-world.html"><code>Engine</code></a> instance, or adding Rust modules as <a href="plugins//book/rust/packages/index.html">packages</a>.</p>
<h2 id="import-prelude"><a class="header" href="#import-prelude">Import Prelude</a></h2>
<p>When using the plugins system, the entire <code>rhai::plugin</code> module must be imported as a prelude
because code generated will need these imports.</p>
<pre><code class="language-rust">use rhai::plugin::*;</code></pre>
<h2 id="export_module"><a class="header" href="#export_module"><code>#[export_module]</code></a></h2>
<p>When applied to a Rust module, the <code>#[export_module]</code> attribute generates the necessary code and
metadata to allow Rhai access to its public (i.e. marked <code>pub</code>) functions, constants, <a href="https://doc.rust-lang.org/reference/items/type-aliases.html">type aliases</a>,
and sub-modules.</p>
<p>This code is exactly what would need to be written by hand to achieve the same goal, and is custom
fit to each exported item.</p>
<p>All <code>pub</code> functions become registered functions, constants become <a href="plugins//book/rust/modules/index.html">module</a> <a href="plugins//book/language/constants.html">constants</a>, <a href="https://doc.rust-lang.org/reference/items/type-aliases.html">type aliases</a>
become <a href="plugins//book/rust/custom-types.html">custom types</a>, and sub-modules become Rhai <a href="plugins//book/rust/modules/index.html">sub-modules</a>.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Module element</th><th style="text-align: center">Example</th><th style="text-align: center">Rhai <a href="plugins//book/rust/modules/index.html">module</a> equivalent</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>pub</code> constant</td><td style="text-align: center"><code>pub const FOO: i64 = 42;</code></td><td style="text-align: center"><a href="plugins//book/language/constants.html">constant</a></td></tr>
<tr><td style="text-align: center"><code>pub</code> <a href="https://doc.rust-lang.org/reference/items/type-aliases.html">type alias</a></td><td style="text-align: center"><code>pub type Foo = Bar&lt;i64&gt;</code></td><td style="text-align: center"><a href="plugins//book/rust/custom-types.html">custom type</a></td></tr>
<tr><td style="text-align: center"><code>pub</code> function</td><td style="text-align: center"><code>pub fn foo(...) { ... }</code></td><td style="text-align: center">function</td></tr>
<tr><td style="text-align: center"><code>pub</code> sub-module</td><td style="text-align: center"><code>pub mod foo { ... }</code></td><td style="text-align: center"><a href="plugins//book/rust/modules/index.html">sub-module</a></td></tr>
</tbody></table>
</div>
<pre><code class="language-rust">use rhai::plugin::*;        // a "prelude" import for macros

// My custom type
pub struct TestStruct {
    pub value: i64
}

#[export_module]
mod my_module {
    // This type alias will register the friendly name 'ABC' for the
    // custom type 'TestStruct'.
    pub type ABC = TestStruct;

    // This constant will be registered as the constant variable 'MY_NUMBER'.
    // Ignored when registered as a global module.
    pub const MY_NUMBER: i64 = 42;

    // This function will be registered as 'greet'
    // but is only available with the 'greetings' feature.
    #[cfg(feature = "greetings")]
    pub fn greet(name: &amp;str) -&gt; String {
        format!("hello, {}!", name)
    }
    /// This function will be registered as 'get_num'.
    ///
    /// If this is a Rust doc-comment, then it is included in the metadata.
    pub fn get_num() -&gt; i64 {
        mystic_number()
    }
    /// This function will be registered as 'create_abc'.
    pub fn create_abc(value: i64) -&gt; ABC {
        ABC { value }
    }
    /// This function will be registered as the 'value' property of type 'ABC'.
    #[rhai_fn(get = "value")]
    pub fn get_value(ts: &amp;mut ABC) -&gt; i64 {
        ts.value
    }
    // This function will be registered as 'increment'.
    // It will also be exposed to the global namespace since 'global' is set.
    #[rhai_fn(global)]
    pub fn increment(ts: &amp;mut ABC) {
        ts.value += 1;
    }
    // This function is not 'pub', so NOT registered.
    fn mystic_number() -&gt; i64 {
        42
    }
    // This global function defines a custom operator '@'.
    #[rhai_fn(name = "@", global)]
    pub fn square_add(x: i64, y: i64) -&gt; i64 {
        x * x + y * y
    }

    // Sub-modules are ignored when the module is registered globally.
    pub mod my_sub_module {
        // This function is ignored when registered globally.
        // Otherwise it is a valid registered function under a sub-module.
        pub fn get_info() -&gt; String {
            "hello".to_string()
        }
    }

    // Sub-modules are commonly used to put feature gates on a group of
    // functions because feature gates cannot be put on function definitions.
    // This is currently a limitation of the plugin procedural macros.
    #[cfg(feature = "advanced_functions")]
    pub mod advanced {
        // This function is ignored when registered globally.
        // Otherwise it is a valid registered function under a sub-module
        // which only exists when the 'advanced_functions' feature is used.
        pub fn advanced_calc(input: i64) -&gt; i64 {
            input * 2
        }
    }
}</code></pre>
<div id="admonition-doc-comments" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-doc-comments-title">
<div class="admonition-title">
<div id="admonition-doc-comments-title">
<p>Doc-comments</p>
</div>
<a class="admonition-anchor-link" href="plugins/index.html#admonition-doc-comments"></a>
</div>
<div>
<p>If the <a href="plugins//book/start/features.html"><code>metadata</code></a> feature is active, doc-comments (i.e. comments starting with <code>///</code> or wrapped
with <code>/**</code> … <code>*/</code>) on plugin functions are extracted into <a href="plugins//book/engine/metadata/index.html"><em>metadata</em></a>.</p>
<p>It is always a good idea to put <a href="plugins//book/language/doc-comments.html">doc-comments</a> onto <a href="plugins//book/plugins/module.html">plugin modules</a> and <a href="plugins//book/plugins/function.html">plugin functions</a>,
as they can be used to auto-generate documentation later on.</p>
</div>
</div>
<h3 id="usage"><a class="header" href="#usage">Usage</a></h3>
<p>The <a href="plugins//book/plugins/module.html">plugin module</a> can be registered into an <a href="plugins//book/engine/hello-world.html"><code>Engine</code></a> as a normal <a href="plugins//book/rust/modules/index.html">module</a>.</p>
<p>This is usually done via the <code>exported_module!</code> macro.</p>
<p>The macro <code>combine_with_exported_module!</code> can also be used to <em>combine</em> all the functions and variables
into an existing <a href="plugins//book/rust/modules/index.html">module</a>, <em>flattening</em> the <a href="plugins//book/language/fn-namespaces.html">namespace</a> – i.e. all
sub-modules are eliminated and their contents promoted to the top level.  This is typical for
developing <a href="plugins//book/rust/packages/create.html">custom packages</a>.</p>
<h3 id="register-with-engineregister_global_module"><a class="header" href="#register-with-engineregister_global_module">Register with <code>Engine::register_global_module</code></a></h3>
<p>The simplest way to register the <a href="plugins//book/plugins/module.html">plugin module</a> into an <a href="plugins//book/engine/hello-world.html"><code>Engine</code></a> is:</p>
<ol>
<li>use the <code>exported_module!</code> macro to turn it into a normal Rhai <a href="plugins//book/rust/modules/index.html">module</a>,</li>
<li>call <code>Engine::register_global_module</code> to register it</li>
</ol>
<pre><code class="language-rust">fn main() {
    let mut engine = Engine::new();

    // The macro call creates a Rhai module from the plugin module.
    let module = exported_module!(my_module);

    // A module can simply be registered into the global namespace.
    engine.register_global_module(module.into());

    // Define a custom operator '@' with precedence of 160 (i.e. between +|- and *|/).
    engine.register_custom_operator("@", 160).unwrap();
}</code></pre>
<p>The functions contained within the module definition (i.e. <code>greet</code>, <code>get_num</code>, <code>create_abc</code> and
<code>increment</code>, the <code>value</code> <a href="plugins//book/rust/getters-setters.html">property getter</a>), and the <code>TestStruct</code> <a href="plugins//book/rust/custom-types.html">custom type</a>
(with friendly name <code>ABC</code>) are automatically registered into the <a href="plugins//book/engine/hello-world.html"><code>Engine</code></a> when
<code>Engine::register_global_module</code> is called.</p>
<pre><code class="language-rust">let x = greet("world");
x == "hello, world!";

let x = greet(get_num().to_string());
x == "hello, 42!";

let x = get_num();
x == 42;

x @ x == 3528;      // custom operator

let abc = create_abc(x);

type_of(abc) == "ABC";

abc.value == 42;

abc.increment();

abc.value == 43;</code></pre>
<div id="admonition-only-functions" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-only-functions-title">
<div class="admonition-title">
<div id="admonition-only-functions-title">
<p>Only functions</p>
</div>
<a class="admonition-anchor-link" href="plugins/index.html#admonition-only-functions"></a>
</div>
<div>
<p>When using a <a href="plugins//book/rust/modules/index.html">module</a> as a <a href="plugins//book/rust/packages/index.html">package</a>, only functions registered at the <em>top level</em> can be accessed.</p>
<p>Variables as well as sub-modules are <strong>ignored</strong>.</p>
</div>
</div>
<h3 id="register-with-engineregister_static_module"><a class="header" href="#register-with-engineregister_static_module">Register with <code>Engine::register_static_module</code></a></h3>
<p>Another simple way to register the <a href="plugins//book/plugins/module.html">plugin module</a> into an <a href="plugins//book/engine/hello-world.html"><code>Engine</code></a> is, again:</p>
<ol>
<li>use the <code>exported_module!</code> macro to turn it into a normal Rhai <a href="plugins//book/rust/modules/index.html">module</a>,</li>
<li>call <code>Engine::register_static_module</code> to register it under a particular <a href="plugins//book/language/fn-namespaces.html">module
namespace</a></li>
</ol>
<pre><code class="language-rust">fn main() {
    let mut engine = Engine::new();

    // The macro call creates a Rhai module from the plugin module.
    let module = exported_module!(my_module);

    // A module can simply be registered as a static module namespace.
    engine.register_static_module("service", module.into());

    // Define a custom operator '@' with precedence of 160 (i.e. between +|- and *|/).
    engine.register_custom_operator("@", 160).unwrap();
}</code></pre>
<p>The functions contained within the module definition (i.e. <code>greet</code>, <code>get_num</code> and <code>increment</code>), plus
the constant <code>MY_NUMBER</code>, are automatically registered under the <a href="plugins//book/language/fn-namespaces.html">module namespace</a> <code>service</code>:</p>
<pre><code class="language-rust">let x = service::greet("world");
x == "hello, world!";

service::MY_NUMBER == 42;

let x = service::greet(service::get_num().to_string());
x == "hello, 42!";

let x = service::get_num();
x == 42;

x @ x == 3528;      // custom operator

let abc = service::create_abc(x);

type_of(abc) == "ABC";

abc.value == 42;

service::increment(abc);

abc.value == 43;</code></pre>
<h3 id="use-rhai_fnglobal"><a class="header" href="#use-rhai_fnglobal">Use <code>#[rhai_fn(global)]</code></a></h3>
<div id="admonition-tip-default-global" class="admonition admonish-tip side wide" role="note" aria-labelledby="admonition-tip-default-global-title">
<div class="admonition-title">
<div id="admonition-tip-default-global-title">
<p>Tip: Default global</p>
</div>
<a class="admonition-anchor-link" href="plugins/index.html#admonition-tip-default-global"></a>
</div>
<div>
<p>The default for all <a href="plugins//book/rust/getters-setters.html">getters/setters</a> and <a href="plugins//book/rust/indexers.html">indexers</a> defined in a <a href="plugins//book/plugins/module.html">plugin module</a> is
<code>#[rhai_fn(global)]</code> unless specifically overridden by <code>#[rhai_fn(internal)]</code>.</p>
</div>
</div>
<p>All functions (usually <em><a href="plugins//book/rust/methods.html">methods</a></em>) defined in the module and marked with <code>#[rhai_fn(global)]</code>, all
<a href="plugins//book/language/iterator.html">type iterators</a> and all <a href="plugins//book/rust/custom-types.html">custom types</a> are automatically exposed to the <em>global</em> namespace, so
<a href="plugins//book/language/for.html">iteration</a>, <a href="plugins//book/rust/getters-setters.html">getters/setters</a> and <a href="plugins//book/rust/indexers.html">indexers</a> for <a href="plugins//book/rust/custom-types.html">custom types</a> can work as expected.</p>
<p>Therefore, in the example above, the <code>increment</code> <a href="plugins//book/rust/methods.html">method</a> (defined with <code>#[rhai_fn(global)]</code>)
works fine when called in method-call style:</p>
<pre><code class="language-rust">let x = 42;
x.increment();
x == 43;</code></pre>
<h3 id="load-dynamically"><a class="header" href="#load-dynamically">Load Dynamically</a></h3>
<div id="admonition-see-also" class="admonition admonish-info side" role="note" aria-labelledby="admonition-see-also-title">
<div class="admonition-title">
<div id="admonition-see-also-title">
<p>See also</p>
</div>
<a class="admonition-anchor-link" href="plugins/index.html#admonition-see-also"></a>
</div>
<div>
<p>See the <a href="plugins//book/rust/modules/index.html">module</a> section for more information.</p>
</div>
</div>
<p>Using this directly as a dynamically-loadable Rhai <a href="plugins//book/rust/modules/index.html">module</a> is almost the same, except that a
<a href="plugins//book/rust/modules/resolvers/index.html">module resolver</a> must be used to serve the module, and the module is loaded via <code>import</code> statements.</p>
<h3 id="combine-into-custom-package"><a class="header" href="#combine-into-custom-package">Combine into Custom Package</a></h3>
<p>Finally, the plugin module can also be used to develop a <a href="plugins//book/rust/packages/create.html">custom package</a>, using
<code>combine_with_exported_module!</code> which automatically <em>flattens</em> the module namespace so that all
functions in sub-modules are promoted to the top level <a href="plugins//book/language/fn-namespaces.html">namespace</a>, all
sub-modules are eliminated, and all variables are ignored.</p>
<div id="admonition-tip-feature-gating" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-feature-gating-title">
<div class="admonition-title">
<div id="admonition-tip-feature-gating-title">
<p>Tip: Feature gating</p>
</div>
<a class="admonition-anchor-link" href="plugins/index.html#admonition-tip-feature-gating"></a>
</div>
<div>
<p>Due to <em>flattening</em>, sub-modules are often used conveniently as a <em>grouping</em> mechanism, especially to
put <em>feature gates</em> or <em>compile-time gates</em> (i.e. <code>#[cfg(...)]</code>) on a large collection of functions
without having to duplicate the gates onto each individual function.</p>
</div>
</div>
<pre><code class="language-rust">#[export_module]
mod my_module {
    // Always available
    pub fn func0() {}

    // The following functions are only available under 'foo'.
    // Use a sub-module for convenience, since all functions underneath
    // will be flattened into the namespace.
    #[cfg(feature = "foo")]
    pub mod group_foo {
        pub fn func1() {}
        pub fn func2() {}
        pub fn func3() {}
    }

    // The following functions are only available under 'bar'
    #[cfg(feature = "bar")]
    pub mod group_bar {
        pub fn func4() {}
        pub fn func5() {}
        pub fn func6() {}
    }
}

// The above is equivalent to:
#[export_module]
mod my_module_alternate {
    pub fn func0() {}

    #[cfg(feature = "foo")]
    pub fn func1() {}
    #[cfg(feature = "foo")]
    pub fn func2() {}
    #[cfg(feature = "foo")]
    pub fn func3() {}

    #[cfg(feature = "bar")]
    pub fn func4() {}
    #[cfg(feature = "bar")]
    pub fn func5() {}
    #[cfg(feature = "bar")]
    pub fn func6() {}
}

// Registered functions:
//   func0 - always available
//   func1, func2, func3 - available under 'foo'
//   func4, func5, func6 - available under 'bar'
//   func0, func1, func2, func3, func4, func5, func6 - available under 'foo' and 'bar'
combine_with_exported_module!(module, "my_module_ID", my_module);</code></pre>
<h2 id="functions-overloading-and-operators"><a class="header" href="#functions-overloading-and-operators">Functions Overloading and Operators</a></h2>
<div id="admonition-tip-nativecallcontext" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-nativecallcontext-title">
<div class="admonition-title">
<div id="admonition-tip-nativecallcontext-title">
<p>Tip: <code>NativeCallContext</code></p>
</div>
<a class="admonition-anchor-link" href="plugins/index.html#admonition-tip-nativecallcontext"></a>
</div>
<div>
<p>The <em>first</em> parameter of a function can also be of type <a href="plugins//book/rust/context.html"><code>NativeCallContext</code></a>.</p>
</div>
</div>
<p>Operators and overloaded functions can be specified via applying the <code>#[rhai_fn(name = "...")]</code>
attribute to individual functions.</p>
<p>The text string given as the <code>name</code> parameter to <code>#[rhai_fn]</code> is used to register the function with
the <a href="plugins//book/engine/hello-world.html"><code>Engine</code></a>, disregarding the actual name of the function.</p>
<p>With <code>#[rhai_fn(name = "...")]</code>, multiple functions may be registered under the same name in Rhai,
so long as they have different parameters.</p>
<div id="admonition-tip-operators" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-operators-title">
<div class="admonition-title">
<div id="admonition-tip-operators-title">
<p>Tip: Operators</p>
</div>
<a class="admonition-anchor-link" href="plugins/index.html#admonition-tip-operators"></a>
</div>
<div>
<p>Operators (which require function names that are not valid for Rust) can also be registered this way.</p>
</div>
</div>
<div id="admonition-duplicated-functions" class="admonition admonish-bug small" role="note" aria-labelledby="admonition-duplicated-functions-title">
<div class="admonition-title">
<div id="admonition-duplicated-functions-title">
<p>Duplicated functions</p>
</div>
<a class="admonition-anchor-link" href="plugins/index.html#admonition-duplicated-functions"></a>
</div>
<div>
<p>Registering the same function name with the same parameter types will cause a parse error.</p>
</div>
</div>
<pre><code class="language-rust">use rhai::plugin::*;        // a "prelude" import for macros

#[export_module]
mod my_module {
    // This is the '+' operator for 'TestStruct'.
    #[rhai_fn(name = "+")]
    pub fn add(obj: &amp;mut TestStruct, value: i64) {
        obj.prop += value;
    }
    // This function is 'calc (i64)'.
    pub fn calc(num: i64) -&gt; i64 {
        ...
    }
    // This function is 'calc (i64, bool)'.
    #[rhai_fn(name = "calc")]
    pub fn calc_with_option(num: i64, option: bool) -&gt; i64 {
        ...
    }
}</code></pre>
<h2 id="getters-setters-and-indexers"><a class="header" href="#getters-setters-and-indexers">Getters, Setters and Indexers</a></h2>
<div id="admonition-tip-global-namespace" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-global-namespace-title">
<div class="admonition-title">
<div id="admonition-tip-global-namespace-title">
<p>Tip: Global namespace</p>
</div>
<a class="admonition-anchor-link" href="plugins/index.html#admonition-tip-global-namespace"></a>
</div>
<div>
<p><a href="plugins//book/rust/getters-setters.html">Getters/setters</a> and <a href="plugins//book/rust/indexers.html">indexers</a> default to <code>#[rhai_fn(global)]</code> unless overridden by <code>#[rhai_fn(internal)]</code>.</p>
</div>
</div>
<p>Functions can be marked as <a href="plugins//book/rust/getters-setters.html">getters/setters</a> and <a href="plugins//book/rust/indexers.html">indexers</a> for <a href="plugins//book/rust/custom-types.html">custom types</a> via the
<code>#[rhai_fn]</code> attribute, which is applied on a function level.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Attribute</th><th style="text-align: center">Description</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>#[rhai_fn(get = "</code><em>property</em><code>")]</code></td><td style="text-align: center">property getter</td></tr>
<tr><td style="text-align: center"><code>#[rhai_fn(set = "</code><em>property</em><code>")]</code></td><td style="text-align: center">property setter</td></tr>
<tr><td style="text-align: center"><code>#[rhai_fn(index_get)]</code></td><td style="text-align: center">index getter</td></tr>
<tr><td style="text-align: center"><code>#[rhai_fn(index_set)]</code></td><td style="text-align: center">index setter</td></tr>
</tbody></table>
</div>
<pre><code class="language-rust">use rhai::plugin::*;        // a "prelude" import for macros

#[export_module]
mod my_module {
    // This is a normal function 'greet'.
    pub fn greet(name: &amp;str) -&gt; String {
        format!("hello, {}!", name)
    }
    // This is a getter for 'TestStruct::prop'.
    #[rhai_fn(get = "prop", pure)]
    pub fn get_prop(obj: &amp;mut TestStruct) -&gt; i64 {
        obj.prop
    }
    // This is a setter for 'TestStruct::prop'.
    #[rhai_fn(set = "prop")]
    pub fn set_prop(obj: &amp;mut TestStruct, value: i64) {
        obj.prop = value;
    }
    // This is an index getter for 'TestStruct'.
    #[rhai_fn(index_get)]
    pub fn get_index(obj: &amp;mut TestStruct, index: i64) -&gt; bool {
        obj.list[index]
    }
    // This is an index setter for 'TestStruct'.
    #[rhai_fn(index_set)]
    pub fn set_index(obj: &amp;mut TestStruct, index: i64, state: bool) {
        obj.list[index] = state;
    }
}</code></pre>
<h2 id="multiple-registrations"><a class="header" href="#multiple-registrations">Multiple Registrations</a></h2>
<p>Parameters to the <code>#[rhai_fn(...)]</code> attribute can be applied multiple times, separated by commas.</p>
<div id="admonition-tip-overloaded-names" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-overloaded-names-title">
<div class="admonition-title">
<div id="admonition-tip-overloaded-names-title">
<p>Tip: Overloaded names</p>
</div>
<a class="admonition-anchor-link" href="plugins/index.html#admonition-tip-overloaded-names"></a>
</div>
<div>
<p>Multiple registrations is useful for <code>name = "..."</code>, <code>get = "..."</code> and <code>set = "..."</code> to give
multiple alternative names to the same function.</p>
</div>
</div>
<pre><code class="language-rust">use rhai::plugin::*;        // a "prelude" import for macros

#[export_module]
mod my_module {
    // This function can be called in five ways
    #[rhai_fn(name = "get_prop_value", name = "prop", name = "+", set = "prop", index_get)]
    pub fn prop_function(obj: &amp;mut TestStruct, index: i64) -&gt; i64 {
        obj.prop[index]
    }
}</code></pre>
<p>The above function can be called in five ways:</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter for <code>#[rhai_fn(...)]</code></th><th style="text-align: center">Type</th><th>Call style</th></tr></thead><tbody>
<tr><td><code>name = "get_prop_value"</code></td><td style="text-align: center"><a href="plugins//book/rust/methods.html">method</a></td><td><code>get_prop_value(x, 0)</code>, <code>x.get_prop_value(0)</code></td></tr>
<tr><td><code>name = "prop"</code></td><td style="text-align: center"><a href="plugins//book/rust/methods.html">method</a></td><td><code>prop(x, 0)</code>, <code>x.prop(0)</code></td></tr>
<tr><td><code>name = "+"</code></td><td style="text-align: center"><a href="plugins//book/appendix/operators.html#operators">operator</a></td><td><code>x + 42</code></td></tr>
<tr><td><code>set = "prop"</code></td><td style="text-align: center"><a href="plugins//book/rust/getters-setters.html">setter</a></td><td><code>x.prop = 42</code></td></tr>
<tr><td><code>index_get</code></td><td style="text-align: center"><a href="plugins//book/rust/indexers.html">index getter</a></td><td><code>x[0]</code></td></tr>
</tbody></table>
</div>
<h2 id="pure-functions"><a class="header" href="#pure-functions">Pure Functions</a></h2>
<p>Apply the <code>#[rhai_fn(pure)]</code> attribute on a <a href="plugins//book/rust/methods.html">method</a> function (i.e. one taking a <code>&amp;mut</code> first parameter)
to mark it as  <em>pure</em> – i.e. it does not modify the <code>&amp;mut</code> parameter.</p>
<p>This is often done to avoid expensive cloning for <a href="plugins//book/rust/methods.html">methods</a> or <a href="plugins//book/rust/getters-setters.html">property getters</a>
that return information about a <a href="plugins//book/rust/custom-types.html">custom type</a> and does not modify it.</p>
<div id="admonition-must-not-modify-mut-parameter" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-must-not-modify-mut-parameter-title">
<div class="admonition-title">
<div id="admonition-must-not-modify-mut-parameter-title">
<p>Must not modify <code>&amp;mut</code> parameter</p>
</div>
<a class="admonition-anchor-link" href="plugins/index.html#admonition-must-not-modify-mut-parameter"></a>
</div>
<div>
<p>Pure functions <em>MUST NOT</em> modify the <code>&amp;mut</code> parameter.
There is no checking.</p>
</div>
</div>
<div id="admonition-error-constants-not-ok-for-non-pure" class="admonition admonish-bug small" role="note" aria-labelledby="admonition-error-constants-not-ok-for-non-pure-title">
<div class="admonition-title">
<div id="admonition-error-constants-not-ok-for-non-pure-title">
<p>Error: Constants Not OK for non-pure</p>
</div>
<a class="admonition-anchor-link" href="plugins/index.html#admonition-error-constants-not-ok-for-non-pure"></a>
</div>
<div>
<p>Non-pure functions raise a runtime error when passed a <a href="plugins//book/language/constants.html">constant</a> value as the first <code>&amp;mut</code> parameter.</p>
</div>
</div>
<div id="admonition-tip-constants-ok-for-pure" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-constants-ok-for-pure-title">
<div class="admonition-title">
<div id="admonition-tip-constants-ok-for-pure-title">
<p>Tip: Constants OK for pure</p>
</div>
<a class="admonition-anchor-link" href="plugins/index.html#admonition-tip-constants-ok-for-pure"></a>
</div>
<div>
<p>Pure functions can be passed a <a href="plugins//book/language/constants.html">constant</a> value as the first <code>&amp;mut</code> parameter.</p>
</div>
</div>
<pre><code class="language-rust">use rhai::plugin::*;        // a "prelude" import for macros

#[export_module]
mod my_module {
    // This function can be passed a constant
    #[rhai_fn(name = "add1", pure)]
    pub fn add_scaled(array: &amp;mut rhai::Array, x: i64) -&gt; i64 {
        array.iter().map(|v| v.as_int().unwrap()).fold(0, |(r, v)| r += v * x)
    }
    // This function CANNOT be passed a constant
    #[rhai_fn(name = "add2")]
    pub fn add_scaled2(array: &amp;mut rhai::Array, x: i64) -&gt; i64 {
        array.iter().map(|v| v.as_int().unwrap()).fold(0, |(r, v)| r += v * x)
    }
    // This getter can be applied to a constant
    #[rhai_fn(get = "first1", pure)]
    pub fn get_first(array: &amp;mut rhai::Array) -&gt; i64 {
        array[0]
    }
    // This getter CANNOT be applied to a constant
    #[rhai_fn(get = "first2")]
    pub fn get_first2(array: &amp;mut rhai::Array) -&gt; i64 {
        array[0]
    }
    // The following is a syntax error because a setter is SUPPOSED to
    // mutate the object.  Therefore the 'pure' attribute cannot be used.
    #[rhai_fn(get = "values", pure)]
    pub fn set_values(array: &amp;mut rhai::Array, value: i64) {
        // ...
    }
    // The following is a volatile function which returns different values
    // for each call.
    #[rhai_fn(volatile)]
    pub fn get_current_time() -&gt; String {
        // ...
    }
}</code></pre>
<p>When applied to a Rhai script:</p>
<pre><code class="language-rust">// Constant
const VECTOR = [1, 2, 3, 4, 5, 6, 7];

let r = VECTOR.add1(2);     // ok!

let r = VECTOR.add2(2);     // runtime error: constant modified

let r = VECTOR.first1;      // ok!

let r = VECTOR.first2;      // runtime error: constant modified</code></pre>
<h2 id="volatile-functions"><a class="header" href="#volatile-functions">Volatile Functions</a></h2>
<p>A <em>volatile</em> function is one that does not guarantee the same result for the same input(s).</p>
<p>Most functions are non-volatile, meaning that they always generate the same result when called with
the same arguments.</p>
<p>Common examples of volatile functions are:</p>
<ul>
<li>
<p>a function that returns the current date and/or time</p>
</li>
<li>
<p>a function that looks up the current value of a variable in the environment</p>
</li>
<li>
<p>a function that reads from a file (which depends on the content of the file at the time of read)</p>
</li>
<li>
<p>a function that reads from a database or a cache (which depends on the content at the time of read)</p>
</li>
</ul>
<p>When using <a href="plugins//book/engine/optimize/index.html">Full Optimization</a>, functions with <a href="plugins//book/language/constants.html">constant</a> arguments are
called <em>eagerly</em> at compile time.  However, volatile functions are never called.</p>
<p>Plugin functions are assumed to be <strong>non-volatile</strong> by default, unless marked with
<code>#[rhai_fn(volatile)]</code>.</p>
<h2 id="fallible-functions"><a class="header" href="#fallible-functions">Fallible Functions</a></h2>
<p>To register <a href="plugins//book/rust/fallible.html">fallible functions</a> (i.e. functions that may return errors), apply the
<code>#[rhai_fn(return_raw)]</code> attribute on functions that return <code>Result&lt;T, Box&lt;EvalAltResult&gt;&gt;</code>
where <code>T</code> is any clonable type.</p>
<pre><code class="language-rust">use rhai::plugin::*;        // a "prelude" import for macros

#[export_module]
mod my_module {
    /// This overloads the '/' operator for i64.
    #[rhai_fn(name = "/", return_raw)]
    pub fn double_and_divide(x: i64, y: i64) -&gt; Result&lt;i64, Box&lt;EvalAltResult&gt;&gt; {
        if y == 0 {
            Err("Division by zero!".into())
        } else {
            Ok((x * 2) / y)
        }
    }
}</code></pre>
<div id="admonition-missing-rhai_fnreturn_raw" class="admonition admonish-bug small" role="note" aria-labelledby="admonition-missing-rhai_fnreturn_raw-title">
<div class="admonition-title">
<div id="admonition-missing-rhai_fnreturn_raw-title">
<p>Missing <code>#[rhai_fn(return_raw)]</code></p>
</div>
<a class="admonition-anchor-link" href="plugins/index.html#admonition-missing-rhai_fnreturn_raw"></a>
</div>
<div>
<p>A compilation error — usually something that says <code>Result</code> does not implement
<code>Clone</code> — is generated if a fallible function is missing <code>#[rhai_fn(return_raw)]</code>.</p>
<p>It is another compilation error for the reverse — a function with
<code>#[rhai_fn(return_raw)]</code> does not have the appropriate return type.</p>
</div>
</div>
<h2 id="export_module-parameters"><a class="header" href="#export_module-parameters"><code>#[export_module]</code> Parameters</a></h2>
<p>Parameters can be applied to the <code>#[export_module]</code> attribute to override its default behavior.</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th>Description</th></tr></thead><tbody>
<tr><td><em>none</em></td><td>exports only public (i.e. <code>pub</code>) functions</td></tr>
<tr><td><code>export_all</code></td><td>exports all functions (including private, non-<code>pub</code> functions); use <code>#[rhai_fn(skip)]</code> on individual functions to avoid export</td></tr>
<tr><td><code>export_prefix = "..."</code></td><td>exports functions (including private, non-<code>pub</code> functions) with names starting with a specific prefix</td></tr>
</tbody></table>
</div>
<h2 id="inner-attributes"><a class="header" href="#inner-attributes">Inner Attributes</a></h2>
<div id="admonition-rhai_fn-vs-rhai_mod" class="admonition admonish-info side wide" role="note" aria-labelledby="admonition-rhai_fn-vs-rhai_mod-title">
<div class="admonition-title">
<div id="admonition-rhai_fn-vs-rhai_mod-title">
<p><code>rhai_fn</code> vs <code>rhai_mod</code></p>
</div>
<a class="admonition-anchor-link" href="plugins/index.html#admonition-rhai_fn-vs-rhai_mod"></a>
</div>
<div>
<p><code>#[rhai_fn]</code> is applied to functions, <code>#[rhai_mod]</code> to sub-modules.</p>
</div>
</div>
<p>Inner attributes can be applied to the inner items of a module to tweak the export process.</p>
<p>Parameters should be set on inner attributes to specify the desired behavior.</p>
<div class="table-wrapper"><table><thead><tr><th>Attribute Parameter</th><th>Use with</th><th>Apply to</th><th>Description</th></tr></thead><tbody>
<tr><td><code>skip</code></td><td><code>#[rhai_fn]</code><br/><code>#[rhai_mod]</code></td><td>any function or sub-module</td><td>do not export this function/sub-module</td></tr>
<tr><td><code>global</code></td><td><code>#[rhai_fn]</code></td><td>any function</td><td>expose this function to the global <a href="plugins//book/language/fn-namespaces.html">namespace</a></td></tr>
<tr><td><code>internal</code></td><td><code>#[rhai_fn]</code></td><td>any function</td><td>keep this function within the internal module <a href="plugins//book/language/fn-namespaces.html">namespace</a></td></tr>
<tr><td><code>name = "..."</code></td><td><code>#[rhai_fn]</code><br/><code>#[rhai_mod]</code></td><td>any function or sub-module</td><td>registers function/sub-module under the specified name</td></tr>
<tr><td><code>get = "..."</code></td><td><code>#[rhai_fn]</code></td><td><code>pub fn (&amp;mut T) -&gt; V</code></td><td>registers a property <a href="plugins//book/rust/getters-setters.html">getter</a> for the named property</td></tr>
<tr><td><code>set = "..."</code></td><td><code>#[rhai_fn]</code></td><td><code>pub fn (&amp;mut T, V)</code></td><td>registers a property <a href="plugins//book/rust/getters-setters.html">setter</a> for the named property</td></tr>
<tr><td><code>index_get</code></td><td><code>#[rhai_fn]</code></td><td><code>pub fn (&amp;mut T, X) -&gt; V</code></td><td>registers an <a href="plugins//book/rust/indexers.html">index getter</a></td></tr>
<tr><td><code>index_set</code></td><td><code>#[rhai_fn]</code></td><td><code>pub fn (&amp;mut T, X, V)</code></td><td>registers an <a href="plugins//book/rust/indexers.html">index setter</a></td></tr>
<tr><td><code>return_raw</code></td><td><code>#[rhai_fn]</code></td><td><code>pub fn (...) -&gt; Result&lt;V, Box&lt;EvalAltResult&gt;&gt;</code></td><td>marks this as a <a href="plugins//book/rust/fallible.html">fallible function</a></td></tr>
<tr><td><code>pure</code></td><td><code>#[rhai_fn]</code></td><td><code>pub fn (&amp;mut T, ...) -&gt; ...</code></td><td>marks this as a <em>pure</em> function</td></tr>
<tr><td><code>volatile</code></td><td><code>#[rhai_fn]</code></td><td>any function</td><td>marks this as a <em>volatile</em> function – i.e. it does not guarantee the same result for the same input(s).</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="packages"><a class="header" href="#packages">Packages</a></h1>
<p>The built-in library of Rhai is provided as various <em>packages</em> that can be turned into <em>shared</em>
<a href="rust/packages//book/rust/modules/index.html">modules</a>, which in turn can be registered into the <em>global namespace</em> of an <a href="rust/packages//book/engine/hello-world.html"><code>Engine</code></a> via
<code>Engine::register_global_module</code>.</p>
<p>Packages reside under <code>rhai::packages::*</code> and the trait <code>rhai::packages::Package</code> must be loaded in
order for packages to be used.</p>
<div id="admonition-trivia-packages-_are_-modules" class="admonition admonish-question small" role="note" aria-labelledby="admonition-trivia-packages-_are_-modules-title">
<div class="admonition-title">
<div id="admonition-trivia-packages-_are_-modules-title">
<p>Trivia: Packages <em>are</em> modules!</p>
</div>
<a class="admonition-anchor-link" href="rust/packages/index.html#admonition-trivia-packages-_are_-modules"></a>
</div>
<div>
<p>Internally, a <em>package</em> is a <a href="rust/packages//book/rust/modules/index.html">module</a>, with some conveniences to make it easier to define and use as
a standard <em>library</em> for an <a href="rust/packages//book/engine/hello-world.html"><code>Engine</code></a>.</p>
<p>Packages typically contain Rust functions that are callable within a Rhai script.
All <em>top-level</em> functions in a package are available under the <em>global namespace</em>
(i.e. they’re available without namespace qualifiers).</p>
<p>Sub-<a href="rust/packages//book/rust/modules/index.html">modules</a> and <a href="rust/packages//book/language/variables.html">variables</a> are ignored in packages.</p>
</div>
</div>
<h2 id="share-a-package-among-multiple-engines"><a class="header" href="#share-a-package-among-multiple-engines">Share a Package Among Multiple <code>Engine</code>’s</a></h2>
<p><code>Engine::register_global_module</code> and <code>Engine::register_static_module</code> both require <em>shared</em> <a href="rust/packages//book/rust/modules/index.html">modules</a>.</p>
<p>Once a package is created (e.g. via <code>Package::new</code>), it can be registered into multiple instances of
<a href="rust/packages//book/engine/hello-world.html"><code>Engine</code></a>, even across threads (under the <a href="rust/packages//book/start/features.html"><code>sync</code></a> feature).</p>
<div id="admonition-tip-sharing-package" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-sharing-package-title">
<div class="admonition-title">
<div id="admonition-tip-sharing-package-title">
<p>Tip: Sharing package</p>
</div>
<a class="admonition-anchor-link" href="rust/packages/index.html#admonition-tip-sharing-package"></a>
</div>
<div>
<p>A package only has to be created <em>once</em> and essentially shared among multiple <a href="rust/packages//book/engine/hello-world.html"><code>Engine</code></a> instances.</p>
<p>This is particularly useful when spawning large number of <a href="rust/packages//book/engine/raw.html">raw <code>Engine</code>’s</a>.</p>
</div>
</div>
<pre><code class="language-rust">use rhai::Engine;
use rhai::packages::Package         // load the 'Package' trait to use packages
use rhai::packages::CorePackage;    // the 'core' package contains basic functionalities (e.g. arithmetic)

// Create a package - can be shared among multiple 'Engine' instances
let package = CorePackage::new();

let mut engines_collection: Vec&lt;Engine&gt; = Vec::new();

// Create 100 'raw' Engines
for _ in 0..100 {
    let mut engine = Engine::new_raw();

    // Register the package into the global namespace.
    package.register_into_engine(&amp;mut engine);

    engines_collection.push(engine);
}</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="built-in-packages"><a class="header" href="#built-in-packages">Built-In Packages</a></h1>
<p><code>Engine::new</code> creates an <a href="rust/packages//book/engine/hello-world.html"><code>Engine</code></a> with the <code>StandardPackage</code> loaded.</p>
<p><code>Engine::new_raw</code> creates an <a href="rust/packages//book/engine/hello-world.html"><code>Engine</code></a> with <em>no</em> <a href="rust/packages//book/rust/packages/index.html">package</a> loaded.</p>
<div class="table-wrapper"><table><thead><tr><th>Package</th><th>Description</th><th style="text-align: center">In <code>Core</code></th><th style="text-align: center">In <code>Standard</code></th></tr></thead><tbody>
<tr><td><code>LanguageCorePackage</code></td><td>core functions for the Rhai language</td><td style="text-align: center">yes</td><td style="text-align: center">yes</td></tr>
<tr><td><code>ArithmeticPackage</code></td><td>arithmetic operators (e.g. <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>) for numeric types that are not built in (e.g. <code>u16</code>)</td><td style="text-align: center">yes</td><td style="text-align: center">yes</td></tr>
<tr><td><code>BitFieldPackage</code></td><td>basic <a href="rust/packages//book/language/bit-fields.html">bit-field</a> functions</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center">yes</td></tr>
<tr><td><code>BasicIteratorPackage</code></td><td>numeric ranges (e.g. <code>range(1, 100, 5)</code>), iterators for <a href="rust/packages//book/language/arrays.html">arrays</a>, <a href="rust/packages//book/language/strings-chars.html">strings</a>, <a href="rust/packages//book/language/bit-fields.html">bit-fields</a> and <a href="rust/packages//book/language/object-maps.html">object maps</a></td><td style="text-align: center">yes</td><td style="text-align: center">yes</td></tr>
<tr><td><code>LogicPackage</code></td><td>logical and comparison operators (e.g. <code>==</code>, <code>&gt;</code>) for numeric types that are not built in (e.g. <code>u16</code>)</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center">yes</td></tr>
<tr><td><code>BasicStringPackage</code></td><td>basic string functions (e.g. <code>print</code>, <code>debug</code>, <code>len</code>) that are not built in</td><td style="text-align: center">yes</td><td style="text-align: center">yes</td></tr>
<tr><td><code>BasicTimePackage</code></td><td>basic time functions (e.g. <a href="rust/packages//book/language/timestamps.html">timestamps</a>, not available under <a href="rust/packages//book/start/features.html"><code>no_time</code></a> or <a href="rust/packages//book/start/features.html"><code>no_std</code></a>)</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center">yes</td></tr>
<tr><td><code>MoreStringPackage</code></td><td>additional string functions, including converting common types to string</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center">yes</td></tr>
<tr><td><code>BasicMathPackage</code></td><td>basic math functions (e.g. <code>sin</code>, <code>sqrt</code>)</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center">yes</td></tr>
<tr><td><code>BasicArrayPackage</code></td><td>basic <a href="rust/packages//book/language/arrays.html">array</a> functions (not available under <a href="rust/packages//book/start/features.html"><code>no_index</code></a>)</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center">yes</td></tr>
<tr><td><code>BasicBlobPackage</code></td><td>basic <a href="rust/packages//book/language/blobs.html">BLOB</a> functions (not available under <a href="rust/packages//book/start/features.html"><code>no_index</code></a>)</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center">yes</td></tr>
<tr><td><code>BasicMapPackage</code></td><td>basic <a href="rust/packages//book/language/object-maps.html">object map</a> functions (not available under <a href="rust/packages//book/start/features.html"><code>no_object</code></a>)</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center">yes</td></tr>
<tr><td><code>BasicFnPackage</code></td><td>basic methods for <a href="rust/packages//book/language/fn-ptr.html">function pointers</a></td><td style="text-align: center">yes</td><td style="text-align: center">yes</td></tr>
<tr><td><code>DebuggingPackage</code></td><td>basic functions for <a href="rust/packages//book/engine/debugging/debugger.html">debugging</a> (requires <a href="rust/packages//book/start/features.html"><code>debugging</code></a>)</td><td style="text-align: center">yes</td><td style="text-align: center">yes</td></tr>
<tr><td><code>CorePackage</code></td><td>basic essentials</td><td style="text-align: center">yes</td><td style="text-align: center">yes</td></tr>
<tr><td><code>StandardPackage</code></td><td>standard library (default for <code>Engine::new</code>)</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center">yes</td></tr>
</tbody></table>
</div>
<h2 id="corepackage"><a class="header" href="#corepackage"><code>CorePackage</code></a></h2>
<p>If only minimal functionalities are required, register the <code>CorePackage</code> instead.</p>
<pre><code class="language-rust">use rhai::Engine;
use rhai::packages::{Package, CorePackage};

let mut engine = Engine::new_raw();
let package = CorePackage::new();

// Register the package into the 'Engine'.
package.register_into_engine(&amp;mut engine);</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="create-a-custom-package"><a class="header" href="#create-a-custom-package">Create a Custom Package</a></h1>
<div id="admonition-see-also" class="admonition admonish-info side" role="note" aria-labelledby="admonition-see-also-title">
<div class="admonition-title">
<div id="admonition-see-also-title">
<p>See also</p>
</div>
<a class="admonition-anchor-link" href="rust/packages/create.html#admonition-see-also"></a>
</div>
<div>
<p>See also the <a href="rust/packages//book/patterns/parallel.html"><em>One Engine Instance Per Call</em></a> pattern.</p>
</div>
</div>
<p>The macro <code>def_package!</code> can be used to create a custom <a href="rust/packages//book/rust/packages/index.html">package</a>.</p>
<p>A custom <a href="rust/packages//book/rust/packages/index.html">package</a> can aggregate many other <a href="rust/packages//book/rust/packages/index.html">packages</a> into a single self-contained unit.
More functions can be added on top of others.</p>
<p>Custom <a href="rust/packages//book/rust/packages/index.html">packages</a> are extremely useful when multiple <a href="rust/packages//book/engine/raw.html">raw <code>Engine</code></a> instances must be created such
that they all share the same set of functions.</p>
<h2 id="def_package"><a class="header" href="#def_package"><code>def_package!</code></a></h2>
<blockquote>
<pre><code class="language-rust">def_package! {
    /// Package description doc-comment
    pub name(variable) {
                        :
        // package init code block
                        :
    }

    // Multiple packages can be defined at the same time,
    // possibly with base packages and/or code to setup an Engine.

    /// Package description doc-comment
    pub(crate) name(variable) : base_package_1, base_package_2, ... {
                        :
        // package init code block
                        :
    } |&gt; |engine| {
                        :
        // engine setup code block
                        :
    }

    /// A private package description doc-comment
    name(variable) {
                        :
        // private package init code block
                        :
    }

    :
}</code></pre>
</blockquote>
<p>where:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Element</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: center">description</td><td>doc-comment for the <a href="rust/packages//book/rust/packages/index.html">package</a></td></tr>
<tr><td style="text-align: center"><code>pub</code> etc.</td><td>visibility of the <a href="rust/packages//book/rust/packages/index.html">package</a></td></tr>
<tr><td style="text-align: center">name</td><td>name of the <a href="rust/packages//book/rust/packages/index.html">package</a>, usually ending in …<code>Package</code></td></tr>
<tr><td style="text-align: center">variable</td><td>a variable name holding a reference to the <a href="rust/packages//book/rust/modules/index.html">module</a> forming the <a href="rust/packages//book/rust/packages/index.html">package</a>, usually <code>module</code> or <code>lib</code></td></tr>
<tr><td style="text-align: center">base_package</td><td>an external <a href="rust/packages//book/rust/packages/index.html">package</a> type that is merged into this <a href="rust/packages//book/rust/packages/index.html">package</a> as a dependency</td></tr>
<tr><td style="text-align: center">package init code block</td><td>a code block that initializes the <a href="rust/packages//book/rust/packages/index.html">package</a></td></tr>
<tr><td style="text-align: center">engine</td><td>a variable name holding a mutable reference to an <a href="rust/packages//book/engine/hello-world.html"><code>Engine</code></a></td></tr>
<tr><td style="text-align: center">engine setup code block</td><td>a code block that performs setup tasks on an <a href="rust/packages//book/engine/hello-world.html"><code>Engine</code></a> during registration</td></tr>
</tbody></table>
</div>
<h2 id="examples-4"><a class="header" href="#examples-4">Examples</a></h2>
<pre><code class="language-rust">// Import necessary types and traits.
use rhai::def_package;      // 'def_package!' macro
use rhai::packages::{ArithmeticPackage, BasicArrayPackage, BasicMapPackage, LogicPackage};
use rhai::{FuncRegistration, CustomType, TypeBuilder};

/// This is a custom type.
#[derive(Clone, CustomType)]
struct TestStruct {
    foo: String,
    bar: i64,
    baz: bool
}

def_package! {
    /// My own personal super package
    // Aggregate other base packages (if any) simply by listing them after a colon.
    pub MyPackage(module) : ArithmeticPackage, LogicPackage, BasicArrayPackage, BasicMapPackage
    {
        // Register additional Rust function.
        FuncRegistration::new("get_bar_value")
            .with_params_info(&amp;["s: &amp;mut TestStruct", "i64"])
            .set_into_module(module, |s: &amp;mut TestStruct| s.bar);

        // Register a function for use as a custom operator.
        FuncRegistration::new("@")
            .with_namespace(FnNamespace::Global)    // &lt;- make it available globally.
            .set_into_module(module, |x: i64, y: i64| x * x + y * y);
    } |&gt; |engine| {
        // This optional block performs tasks on an 'Engine' instance,
        // e.g. register custom types and/or custom operators/syntax.

        // Register custom type.
        engine.build_type::&lt;TestStruct&gt;();

        // Define a custom operator '@' with precedence of 160
        // (i.e. between +|- and *|/).
        engine.register_custom_operator("@", 160).unwrap();
    }
}</code></pre>
<div id="admonition-tip-feature-gates-on-base-packages" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-feature-gates-on-base-packages-title">
<div class="admonition-title">
<div id="admonition-tip-feature-gates-on-base-packages-title">
<p>Tip: Feature gates on base packages</p>
</div>
<a class="admonition-anchor-link" href="rust/packages/create.html#admonition-tip-feature-gates-on-base-packages"></a>
</div>
<div>
<p>Base packages in the list after the colon (<code>:</code>) can also have attributes (such as feature gates)!</p>
<pre><code class="language-rust">def_package! {
    // 'BasicArrayPackage' is used only under 'arrays' feature.
    pub MyPackage(module) :
            ArithmeticPackage,
            LogicPackage,
            #[cfg(feature = "arrays")]
            BasicArrayPackage
    {
        ...
    }
}
</code></pre>
</div>
</div>
<div id="admonition-advanced-engine-setup-with-" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-advanced-engine-setup-with--title">
<div class="admonition-title">
<div id="admonition-advanced-engine-setup-with--title">
<p>Advanced: <code>Engine</code> setup with <code>|&gt;</code></p>
</div>
<a class="admonition-anchor-link" href="rust/packages/create.html#admonition-advanced-engine-setup-with-"></a>
</div>
<div>
<p>A second code block (in the syntax of a <a href="rust/packages//book/language/fn-closure.html">closure</a>) following a right-triangle symbol (<code>|&gt;</code>)
is run whenever the <a href="rust/packages//book/rust/packages/index.html">package</a> is being registered.</p>
<p>It allows performing setup tasks directly on that <a href="rust/packages//book/engine/hello-world.html"><code>Engine</code></a>, e.g. registering <a href="rust/packages//book/rust/custom-types.html">custom types</a>,
<a href="rust/packages//book/engine/custom-op.html">custom operators</a> and/or <a href="rust/packages//book/engine/custom-syntax.html">custom syntax</a>.</p>
<pre><code class="language-rust">def_package! {
    pub MyPackage(module) {
            :
            :
    } |&gt; |engine| {
        // Call methods on 'engine'
    }
}</code></pre>
</div>
</div>
<h2 id="create-a-custom-package-from-a-plugin-module"><a class="header" href="#create-a-custom-package-from-a-plugin-module">Create a Custom Package from a Plugin Module</a></h2>
<div id="admonition-trivia" class="admonition admonish-question side" role="note" aria-labelledby="admonition-trivia-title">
<div class="admonition-title">
<div id="admonition-trivia-title">
<p>Trivia</p>
</div>
<a class="admonition-anchor-link" href="rust/packages/create.html#admonition-trivia"></a>
</div>
<div>
<p>This is exactly how Rhai’s built-in <a href="rust/packages//book/rust/packages/index.html">packages</a>, such as <code>BasicMathPackage</code>, are actually implemented.</p>
</div>
</div>
<p>By far the easiest way to create a custom <a href="rust/packages//book/rust/packages/index.html">package</a> is to call <code>plugin::combine_with_exported_module!</code>
from within <code>def_package!</code> which simply merges in all the functions defined within a <a href="rust/packages//book/plugins/module.html">plugin module</a>.</p>
<p>Due to specific requirements of a <a href="rust/packages//book/rust/packages/index.html">package</a>, <code>plugin::combine_with_exported_module!</code>
<em>flattens</em> all sub-modules (i.e. all functions and <a href="rust/packages//book/language/iterator.html">type iterators</a> defined within sub-modules
are pulled up to the top level instead) and so there will not be any sub-modules added to the <a href="rust/packages//book/rust/packages/index.html">package</a>.</p>
<p>Variables in the <a href="rust/packages//book/plugins/module.html">plugin module</a> are ignored.</p>
<pre><code class="language-rust">// Import necessary types and traits.
use rhai::def_package;
use rhai::packages::{ArithmeticPackage, BasicArrayPackage, BasicMapPackage, LogicPackage};
use rhai::plugin::*;

// Define plugin module.
#[export_module]
mod my_plugin_module {
    // Custom type.
    pub type ABC = TestStruct;

    // Public constant.
    pub const MY_NUMBER: i64 = 42;

    // Public function.
    pub fn greet(name: &amp;str) -&gt; String {
        format!("hello, {}!", name)
    }

    // Non-public functions are by default not exported.
    fn get_private_num() -&gt; i64 {
        42
    }

    // Public function.
    pub fn get_num() -&gt; i64 {
        get_private_num()
    }

    // Custom operator.
    #[rhai_fn(name = "@")]
    pub fn square_add(x: i64, y: i64) -&gt; i64 {
        x * x + y * y
    }

    // A sub-module.  If using 'combine_with_exported_module!', however,
    // it will be flattened and all functions registered at the top level.
    //
    // Because of this flattening, sub-modules are very convenient for
    // putting feature gates onto large groups of functions.
    #[cfg(feature = "sub-num-feature")]
    pub mod my_sub_module {
        // Only available under 'sub-num-feature'.
        pub fn get_sub_num() -&gt; i64 {
            0
        }
    }
}

def_package! {
    /// My own personal super package
    // Aggregate other base packages (if any) simply by listing them after a colon.
    pub MyPackage(module) : ArithmeticPackage, LogicPackage, BasicArrayPackage, BasicMapPackage
    {
        // Merge all registered functions and constants from the plugin module
        // into the custom package.
        //
        // The sub-module 'my_sub_module' is flattened and its functions
        // registered at the top level.
        //
        // The text string name in the second parameter can be anything
        // and is reserved for future use; it is recommended to be an
        // ID string that uniquely identifies the plugin module.
        //
        // The constant variable, 'MY_NUMBER', is ignored.
        //
        // This call ends up registering three functions at the top level of
        // the package:
        // 1) 'greet'
        // 2) 'get_num'
        // 3) 'get_sub_num' (flattened from 'my_sub_module')
        //
        combine_with_exported_module!(module, "my-mod", my_plugin_module));
    } |&gt; |engine| {
        // This optional block is used to set up an 'Engine' during registration.

        // Define a custom operator '@' with precedence of 160
        // (i.e. between +|- and *|/).
        engine.register_custom_operator("@", 160).unwrap();
    }
}</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="create-a-custom-package-as-an-independent-crate"><a class="header" href="#create-a-custom-package-as-an-independent-crate">Create a Custom Package as an Independent Crate</a></h1>
<p>Creating a custom <a href="rust/packages//book/rust/packages/index.html">package</a> as an independent crate allows it to be shared by multiple projects.</p>
<div id="admonition-key-concepts" class="admonition admonish-abstract small" role="note" aria-labelledby="admonition-key-concepts-title">
<div class="admonition-title">
<div id="admonition-key-concepts-title">
<p>Key concepts</p>
</div>
<a class="admonition-anchor-link" href="rust/packages/crate.html#admonition-key-concepts"></a>
</div>
<div>
<ul>
<li>
<p>Create a Rust crate that specifies <a href="https://crates.io/crates/rhai"><code>rhai</code></a> as dependency.</p>
</li>
<li>
<p>The main <code>lib.rs</code> module can contain the <a href="rust/packages//book/rust/packages/index.html">package</a> being constructed.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-example" class="admonition admonish-example small" role="note" aria-labelledby="admonition-example-title">
<div class="admonition-title">
<div id="admonition-example-title">
<p>Example</p>
</div>
<a class="admonition-anchor-link" href="rust/packages/crate.html#admonition-example"></a>
</div>
<div>
<p>The projects <a href="rust/packages//book/lib/rhai-rand.html"><code>rhai-rand</code></a> and <a href="rust/packages//book/lib/rhai-sci.html"><code>rhai-sci</code></a> show simple examples of creating a custom <a href="rust/packages//book/rust/packages/index.html">package</a>
as an independent crate.</p>
</div>
</div>
<h2 id="implementation-1"><a class="header" href="#implementation-1">Implementation</a></h2>
<p><code>Cargo.toml</code>:</p>
<pre><code class="language-toml">[package]
name = "my-package"     # 'my-package' crate

[dependencies]
rhai = "1.22.0"    # assuming 1.22.0 is the latest version
</code></pre>
<p><code>lib.rs</code>:</p>
<pre><code class="language-rust">use rhai::def_package;
use rhai::plugin::*;

// This is a plugin module
#[export_module]
mod my_module {
    // Constants are ignored when used as a package
    pub const MY_NUMBER: i64 = 42;

    pub fn greet(name: &amp;str) -&gt; String {
        format!("hello, {}!", name)
    }
    pub fn get_num() -&gt; i64 {
        42
    }

    // This is a sub-module, but if using combine_with_exported_module!, it will
    // be flattened and all functions registered at the top level.
    pub mod my_sub_module {
        pub fn get_sub_num() -&gt; i64 {
            0
        }
    }
}

// Define the package 'MyPackage' which is exported for the crate.
def_package! {
    /// My own personal super package in a new crate!
    pub MyPackage(module) {
        combine_with_exported_module!(module, "my-functions", my_module);
    }
}</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="external-packages"><a class="header" href="#external-packages">External Packages</a></h1>
<p>Following are external <a href="lib//book/rust/packages/index.html">packages</a> that can be used with Rhai for additional functionalities.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Package</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: center"><a href="lib//book/lib/rhai-rand.html"><code>rhai-rand</code></a></td><td>generate random numbers, shuffling and sampling</td></tr>
<tr><td style="text-align: center"><a href="lib//book/lib/rhai-sci.html"><code>rhai-sci</code></a></td><td>functions for scientific computing</td></tr>
<tr><td style="text-align: center"><a href="lib//book/lib/rhai-ml.html"><code>rhai-ml</code></a></td><td>functions for AI and machine learning</td></tr>
<tr><td style="text-align: center"><a href="lib//book/lib/rhai-fs.html"><code>rhai-fs</code></a></td><td>read/write files in an external filesystem</td></tr>
<tr><td style="text-align: center"><a href="lib//book/lib/rhai-url.html"><code>rhai-url</code></a></td><td>working with Urls via the <a href="https://crates.io/crates/url"><code>url</code></a> crate</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="rhai-rand-random-number-generation-shuffling-and-sampling"><a class="header" href="#rhai-rand-random-number-generation-shuffling-and-sampling"><code>rhai-rand</code>: Random Number Generation, Shuffling and Sampling</a></h1>
<p><code>rhai-rand</code> is an independent Rhai <a href="lib//book/rust/packages/index.html">package</a> that provides:</p>
<ul>
<li>random number generation using the <a href="https://crates.io/crates/rand"><code>rand</code></a> crate</li>
<li><a href="lib//book/language/arrays.html">array</a> shuffling and sampling</li>
</ul>
<div id="admonition-documentation" class="admonition admonish-info side" role="note" aria-labelledby="admonition-documentation-title">
<div class="admonition-title">
<div id="admonition-documentation-title">
<p>Documentation</p>
</div>
<a class="admonition-anchor-link" href="lib/rhai-rand.html#admonition-documentation"></a>
</div>
<div>
<p>See <a href="https://docs.rs/rhai-rand#api">https://docs.rs/rhai-rand</a> for the list of functions.</p>
</div>
</div>
<blockquote>
<p>On <code>crates.io</code>: <a href="https://crates.io/crates/rhai-rand"><code>rhai-rand</code></a></p>
<p>On <code>GitHub</code>: <a href="https://github.com/rhaiscript/rhai-rand"><code>rhaiscript/rhai-rand</code></a></p>
<p>Package name: <code>RandomPackage</code></p>
</blockquote>
<h2 id="dependency"><a class="header" href="#dependency">Dependency</a></h2>
<p><code>Cargo.toml</code>:</p>
<pre><code class="language-toml">[dependencies]
rhai = "1.22.0"
rhai-rand = "0.1"       # use rhai-rand crate
</code></pre>
<h2 id="load-package-into-engine"><a class="header" href="#load-package-into-engine">Load Package into <a href="lib//book/engine/hello-world.html"><code>Engine</code></a></a></h2>
<pre><code class="language-rust">use rhai::Engine;
use rhai::packages::Package;    // needed for 'Package' trait
use rhai_rand::RandomPackage;

let mut engine = Engine::new();

// Create new 'RandomPackage' instance
let random = RandomPackage::new();

// Load the package into the `Engine`
random.register_into_engine(&amp;mut engine);</code></pre>
<h2 id="features"><a class="header" href="#features">Features</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Feature</th><th>Description</th><th style="text-align: center">Default?</th><th style="text-align: center">Should not be used with Rhai feature</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>float</code></td><td>enables random floating-point number generation</td><td style="text-align: center">yes</td><td style="text-align: center"><a href="lib//book/start/features.html"><code>no_float</code></a></td></tr>
<tr><td style="text-align: center"><code>array</code></td><td>enables methods for <a href="lib//book/language/arrays.html">arrays</a></td><td style="text-align: center">yes</td><td style="text-align: center"><a href="lib//book/start/features.html"><code>no_index</code></a></td></tr>
<tr><td style="text-align: center"><code>metadata</code></td><td>enables <a href="lib//book/engine/metadata/index.html">functions metadata</a> (turns on <a href="lib//book/start/features.html"><code>metadata</code></a> in Rhai)</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"></td></tr>
</tbody></table>
</div><div id="admonition-example-working-with-no_float-in-rhai" class="admonition admonish-example" role="note" aria-labelledby="admonition-example-working-with-no_float-in-rhai-title">
<div class="admonition-title">
<div id="admonition-example-working-with-no_float-in-rhai-title">
<p>Example: Working with <code>no_float</code> in Rhai</p>
</div>
<a class="admonition-anchor-link" href="lib/rhai-rand.html#admonition-example-working-with-no_float-in-rhai"></a>
</div>
<div>
<p><code>Cargo.toml</code>:</p>
<pre><code class="language-toml">[dependencies]
# Rhai is set for 'no_float', meaning no floating-point support
rhai = { version="1.22.0", features = ["no_float"] }

# Use 'default-features = false' to clear defaults, then only add 'array'
rhai-rand = { version="0.1", default-features = false, features = ["array"] }
</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rhai-sci-functions-for-scientific-computing"><a class="header" href="#rhai-sci-functions-for-scientific-computing"><code>rhai-sci</code>: Functions for Scientific Computing</a></h1>
<p><code>rhai-sci</code> is an independent Rhai <a href="lib//book/rust/packages/index.html">package</a> that provides functions useful for
scientific computing, inspired by languages like MATLAB, Octave, and R.</p>
<div id="admonition-documentation" class="admonition admonish-info side" role="note" aria-labelledby="admonition-documentation-title">
<div class="admonition-title">
<div id="admonition-documentation-title">
<p>Documentation</p>
</div>
<a class="admonition-anchor-link" href="lib/rhai-sci.html#admonition-documentation"></a>
</div>
<div>
<p>See <a href="https://docs.rs/rhai-sci#api">https://docs.rs/rhai-sci</a> for the list of functions.</p>
</div>
</div>
<blockquote>
<p>On <code>crates.io</code>: <a href="https://crates.io/crates/rhai-sci"><code>rhai-sci</code></a></p>
<p>On <code>GitHub</code>: <a href="https://github.com/rhaiscript/rhai-sci"><code>rhaiscript/rhai-sci</code></a></p>
<p>Package name: <code>SciPackage</code></p>
</blockquote>
<h2 id="dependency-1"><a class="header" href="#dependency-1">Dependency</a></h2>
<p><code>Cargo.toml</code>:</p>
<pre><code class="language-toml">[dependencies]
rhai = "1.22.0"
rhai-sci = "0.1"       # use rhai-sci crate
</code></pre>
<h2 id="features-1"><a class="header" href="#features-1">Features</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Feature</th><th>Description</th><th style="text-align: center">Default?</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>metadata</code></td><td>enables <a href="lib//book/engine/metadata/index.html">functions metadata</a> (turns on <a href="lib//book/start/features.html"><code>metadata</code></a> in Rhai); necessary for running doc-tests</td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>io</code></td><td>enables the <code>read_matrix</code> function but pulls in several additional dependencies</td><td style="text-align: center">yes</td></tr>
<tr><td style="text-align: center"><code>nalgebra</code></td><td>enables the functions <code>regress</code>, <code>inv</code>, <code>mtimes</code>, <code>horzcat</code>, <code>vertcat</code>, and <code>repmat</code> but pulls in <a href="https://crates.io/crates/nalgebra"><code>nalgebra</code></a> and <a href="https://crates.io/crates/linregress"><code>linregress</code></a>.</td><td style="text-align: center">yes</td></tr>
<tr><td style="text-align: center"><code>rand</code></td><td>enables the <code>rand</code> function for generating random values and random matrices, but pulls in <a href="https://crates.io/crates/rand"><code>rand</code></a>.</td><td style="text-align: center">yes</td></tr>
</tbody></table>
</div>
<h2 id="load-package-into-engine-1"><a class="header" href="#load-package-into-engine-1">Load Package into <a href="lib//book/engine/hello-world.html"><code>Engine</code></a></a></h2>
<pre><code class="language-rust">use rhai::Engine;
use rhai::packages::Package;    // needed for 'Package' trait
use rhai_sci::SciPackage;

let mut engine = Engine::new();

// Create new 'SciPackage' instance
let sci = SciPackage::new();

// Load the package into the [`Engine`]
sci.register_into_engine(&amp;mut engine);</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rhai-ml-functions-for-ai-and-machine-learning"><a class="header" href="#rhai-ml-functions-for-ai-and-machine-learning"><code>rhai-ml</code>: Functions for AI and Machine Learning</a></h1>
<p><code>rhai-ml</code> is an independent Rhai <a href="lib//book/rust/packages/index.html">package</a> that provides functions useful for
artificial intelligence and machine learning.</p>
<div id="admonition-documentation" class="admonition admonish-info side" role="note" aria-labelledby="admonition-documentation-title">
<div class="admonition-title">
<div id="admonition-documentation-title">
<p>Documentation</p>
</div>
<a class="admonition-anchor-link" href="lib/rhai-ml.html#admonition-documentation"></a>
</div>
<div>
<p>See <a href="https://docs.rs/rhai-ml#api">https://docs.rs/rhai-ml</a> for the list of functions.</p>
</div>
</div>
<blockquote>
<p>On <code>crates.io</code>: <a href="https://crates.io/crates/rhai-ml"><code>rhai-ml</code></a></p>
<p>On <code>GitHub</code>: <a href="https://github.com/rhaiscript/rhai-ml"><code>rhaiscript/rhai-ml</code></a></p>
<p>Package name: <code>MLPackage</code></p>
</blockquote>
<h2 id="dependency-2"><a class="header" href="#dependency-2">Dependency</a></h2>
<p><code>Cargo.toml</code>:</p>
<pre><code class="language-toml">[dependencies]
rhai = "1.22.0"
rhai-ml = "0.1"       # use rhai-ml crate
</code></pre>
<h2 id="features-2"><a class="header" href="#features-2">Features</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Feature</th><th>Description</th><th style="text-align: center">Default?</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>metadata</code></td><td>enables <a href="lib//book/engine/metadata/index.html">functions metadata</a> (turns on <a href="lib//book/start/features.html"><code>metadata</code></a> in Rhai); necessary for running doc-tests</td><td style="text-align: center"><strong>no</strong></td></tr>
</tbody></table>
</div>
<h2 id="load-package-into-engine-2"><a class="header" href="#load-package-into-engine-2">Load Package into <a href="lib//book/engine/hello-world.html"><code>Engine</code></a></a></h2>
<pre><code class="language-rust">use rhai::Engine;
use rhai::packages::Package;    // needed for 'Package' trait
use rhai_ml::MLPackage;

let mut engine = Engine::new();

// Create new 'MLPackage' instance
let ml = MLPackage::new();

// Load the package into the [`Engine`]
ml.register_into_engine(&amp;mut engine);</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rhai-fs-filesystem-access"><a class="header" href="#rhai-fs-filesystem-access"><code>rhai-fs</code>: Filesystem Access</a></h1>
<p><code>rhai-fs</code> is an independent Rhai <a href="lib//book/rust/packages/index.html">package</a> that enables reading from and writing to files in an
external filesystem.</p>
<div id="admonition-documentation" class="admonition admonish-info side" role="note" aria-labelledby="admonition-documentation-title">
<div class="admonition-title">
<div id="admonition-documentation-title">
<p>Documentation</p>
</div>
<a class="admonition-anchor-link" href="lib/rhai-fs.html#admonition-documentation"></a>
</div>
<div>
<p>See <a href="https://docs.rs/rhai-fs">https://docs.rs/rhai-fs</a> for the list of functions.</p>
</div>
</div>
<blockquote>
<p>On <code>crates.io</code>: <a href="https://crates.io/crates/rhai-fs"><code>rhai-fs</code></a></p>
<p>On <code>GitHub</code>: <a href="https://github.com/rhaiscript/rhai-fs"><code>rhaiscript/rhai-fs</code></a></p>
<p>Package name: <code>FilesystemPackage</code></p>
</blockquote>
<h2 id="dependency-3"><a class="header" href="#dependency-3">Dependency</a></h2>
<p><code>Cargo.toml</code>:</p>
<pre><code class="language-toml">[dependencies]
rhai = "1.22.0"
rhai-fs = "0.1"       # use rhai-fs crate
</code></pre>
<h2 id="load-package-into-engine-3"><a class="header" href="#load-package-into-engine-3">Load Package into <a href="lib//book/engine/hello-world.html"><code>Engine</code></a></a></h2>
<pre><code class="language-rust">use rhai::Engine;
use rhai::packages::Package;    // needed for 'Package' trait
use rhai_fs::FilesystemPackage;

let mut engine = Engine::new();

// Create new 'FilesystemPackage' instance
let fs = FilesystemPackage::new();

// Load the package into the `Engine`
fs.register_into_engine(&amp;mut engine);</code></pre>
<h2 id="example-10"><a class="header" href="#example-10">Example</a></h2>
<pre><code class="language-js">// Create a file, or open it if already exists
let file = open_file("example.txt");

// Read the contents of the file (if any) into a BLOB
let blob_buf = file.read_blob();

print(`file contents: ${blob_buf}`);

// Update BLOB data
blob_buf.write_utf8(0..=0x20, "foobar");

print(`new file contents: ${blob_buf}`);

// Seek back to the beginning
file.seek(0);

// Overwrite the original file with new data
blob_buf.write_to_file(file);
</code></pre>
<h2 id="features-3"><a class="header" href="#features-3">Features</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Feature</th><th>Description</th><th style="text-align: center">Default?</th><th style="text-align: center">Should be used with Rhai feature</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>no_array</code></td><td>removes support for <a href="lib//book/language/arrays.html">arrays</a> and <a href="lib//book/language/blobs.html">BLOB’s</a></td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><a href="lib//book/start/features.html"><code>no_index</code></a></td></tr>
<tr><td style="text-align: center"><code>metadata</code></td><td>enables <a href="lib//book/engine/metadata/index.html">functions metadata</a> (turns on <a href="lib//book/start/features.html"><code>metadata</code></a> in Rhai)</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"></td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="rhai-url-working-with-urls"><a class="header" href="#rhai-url-working-with-urls"><code>rhai-url</code>: Working with Urls</a></h1>
<p><code>rhai-url</code> is an independent Rhai <a href="lib//book/rust/packages/index.html">package</a> that enables working with Urls via the
<a href="https://crates.io/crates/url"><code>url</code></a> crate.</p>
<div id="admonition-documentation" class="admonition admonish-info side" role="note" aria-labelledby="admonition-documentation-title">
<div class="admonition-title">
<div id="admonition-documentation-title">
<p>Documentation</p>
</div>
<a class="admonition-anchor-link" href="lib/rhai-url.html#admonition-documentation"></a>
</div>
<div>
<p>See <a href="https://docs.rs/rhai-url">https://docs.rs/rhai-url</a> for the list of functions.</p>
</div>
</div>
<blockquote>
<p>On <code>crates.io</code>: <a href="https://crates.io/crates/rhai-url"><code>rhai-url</code></a></p>
<p>On <code>GitHub</code>: <a href="https://github.com/rhaiscript/rhai-url"><code>rhaiscript/rhai-url</code></a></p>
<p>Package name: <code>FilesystemPackage</code></p>
</blockquote>
<h2 id="dependency-4"><a class="header" href="#dependency-4">Dependency</a></h2>
<p><code>Cargo.toml</code>:</p>
<pre><code class="language-toml">[dependencies]
rhai = "1.22.0"
rhai-url = "0.0.1"       # use rhai-url crate
</code></pre>
<h2 id="load-package-into-engine-4"><a class="header" href="#load-package-into-engine-4">Load Package into <a href="lib//book/engine/hello-world.html"><code>Engine</code></a></a></h2>
<pre><code class="language-rust">use rhai::Engine;
use rhai::packages::Package;    // needed for 'Package' trait
use rhai_url::UrlPackage;

let mut engine = Engine::new();

// Create new 'UrlPackage' instance
let url = UrlPackage::new();

// Load the package into the `Engine`
url.register_into_engine(&amp;mut engine);</code></pre>
<h2 id="example-11"><a class="header" href="#example-11">Example</a></h2>
<pre><code class="language-rust">let url = Url("http://example.com/?q=query");

print(url);                 // prints 'http://example.com/?q=query'
print(url.href);            // prints 'http://example.com/?q=query'

print(url.query);           // prints 'q=query'

// fragment and hash are aliases
print(url.fragment);        // prints ''
print(url.hash);            // prints ''

url.query_clear();

print(url.query);           // prints ''

url.query_remove("q");
url.query_append("q", "name");

print(url);                 // prints 'http://example.com/?q=name'</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="comments"><a class="header" href="#comments">Comments</a></h1>
<p>Comments are C-style, including <code>/*</code> … <code>*/</code> pairs for block comments and <code>//</code> for comments to the
end of the line.</p>
<p>Block comments can be nested.</p>
<pre><code class="language-rust">let /* intruder comment */ name = "Bob";

// This is a very important one-line comment

/* This comment spans
   multiple lines, so it
   only makes sense that
   it is even more important */

/* Fear not, Rhai satisfies all nesting needs with nested comments:
   /*/*/*/*/**/*/*/*/*/
*/</code></pre>
<h2 id="module-documentation"><a class="header" href="#module-documentation">Module Documentation</a></h2>
<p>Comment lines starting with <code>//!</code> make up the <em>module documentation</em>.</p>
<p>They are used to document the containing <a href="language//book/rust/modules/index.html">module</a> – or for a Rhai script file,
to document the file itself.</p>
<div id="admonition-requires-metadata" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-requires-metadata-title">
<div class="admonition-title">
<div id="admonition-requires-metadata-title">
<p>Requires <code>metadata</code></p>
</div>
<a class="admonition-anchor-link" href="language/comments.html#admonition-requires-metadata"></a>
</div>
<div>
<p>Module documentation is only supported under the <a href="language//book/start/features.html"><code>metadata</code></a> feature.</p>
<p>If <a href="language//book/start/features.html"><code>metadata</code></a> is not active, they are treated as normal <a href="language//book/language/comments.html">comments</a>.</p>
</div>
</div>
<pre><code class="language-rust">//! Documentation for this script file.
//! This script is used to calculate something and display the result.

fn calculate(x) {
   ...
}

fn display(msg) {
   //! Module documentation can be placed anywhere within the file.
   ...
}

//! All module documentation lines will be collected into a single block.</code></pre>
<p>For the example above, the module documentation block is:</p>
<pre><code class="language-rust">//! Documentation for this script file.
//! This script is used to calculate something and display the result.
//! Module documentation can be placed anywhere within the file.
//! All module documentation lines will be collected into a single block.</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="doc-comments"><a class="header" href="#doc-comments">Doc-Comments</a></h1>
<p>Similar to Rust, <a href="language//book/language/comments.html">comments</a> starting with <code>///</code> (three slashes) or <code>/**</code> (two asterisks)
are <em>doc-comments</em>.</p>
<p>Doc-comments can only appear in front of <a href="language//book/language/functions.html">function</a> definitions, not any other elements.
Therefore, doc-comments are not available under <a href="language//book/start/features.html"><code>no_function</code></a>.</p>
<div id="admonition-requires-metadata" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-requires-metadata-title">
<div class="admonition-title">
<div id="admonition-requires-metadata-title">
<p>Requires <code>metadata</code></p>
</div>
<a class="admonition-anchor-link" href="language/doc-comments.html#admonition-requires-metadata"></a>
</div>
<div>
<p>Doc-comments are only supported under the <a href="language//book/start/features.html"><code>metadata</code></a> feature.</p>
<p>If <a href="language//book/start/features.html"><code>metadata</code></a> is not active, doc-comments are treated as normal <a href="language//book/language/comments.html">comments</a>.</p>
</div>
</div>
<pre><code class="language-rust">/// This is a valid one-line doc-comment
fn foo() {}

/** This is a
 ** valid block
 ** doc-comment
 **/
fn bar(x) {
   /// Syntax error: this doc-comment is invalid
   x + 1
}

/** Syntax error: this doc-comment is invalid */
let x = 42;

/// Syntax error: this doc-comment is also invalid
{
   let x = 42;
}</code></pre>
<div id="admonition-tip-special-cases" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-special-cases-title">
<div class="admonition-title">
<div id="admonition-tip-special-cases-title">
<p>Tip: Special cases</p>
</div>
<a class="admonition-anchor-link" href="language/doc-comments.html#admonition-tip-special-cases"></a>
</div>
<div>
<p>Long streams of <code>//////</code>… and <code>/*****</code>… do <em>NOT</em> form doc-comments.
This is consistent with popular [comment] block styles for C-like languages.</p>
<pre><code class="language-rust">///////////////////////////////  &lt;- this is not a doc-comment
// This is not a doc-comment //  &lt;- this is not a doc-comment
///////////////////////////////  &lt;- this is not a doc-comment

// However, watch out for comment lines starting with '///'

//////////////////////////////////////////  &lt;- this is not a doc-comment
/// This, however, IS a doc-comment!!! ///  &lt;- doc-comment!
//////////////////////////////////////////  &lt;- this is not a doc-comment

/****************************************
 *                                      *
 * This is also not a doc-comment block *
 * so we don't have to put this in      *
 * front of a function.                 *
 *                                      *
 ****************************************/</code></pre>
</div>
</div>
<h2 id="using-doc-comments"><a class="header" href="#using-doc-comments">Using Doc-Comments</a></h2>
<p>Doc-comments are stored within the script’s <a href="language//book/engine/compile.html"><code>AST</code></a> after compilation.</p>
<p>The <code>AST::iter_functions</code> method provides a <code>ScriptFnMetadata</code> instance for each function defined
within the script, which includes doc-comments.</p>
<p>Doc-comments never affect the evaluation of a script nor do they incur significant performance overhead.
However, third party tools can take advantage of this information to auto-generate documentation for
Rhai script functions.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="values-and-types"><a class="header" href="#values-and-types">Values and Types</a></h1>
<p>The following primitive types are supported natively.</p>
<div class="table-wrapper"><table><thead><tr><th>Category</th><th>Equivalent Rust types</th><th><a href="language/type-of.html"><code>type_of()</code></a></th><th><code>to_string()</code></th></tr></thead><tbody>
<tr><td><strong>System integer</strong></td><td><code>rhai::INT</code> (default <code>i64</code>, <code>i32</code> under <a href="language//book/start/features.html"><code>only_i32</code></a>)</td><td><code>"i32"</code> or <code>"i64"</code></td><td><code>"42"</code>, <code>"123"</code> etc.</td></tr>
<tr><td><strong>Other integer number</strong></td><td><code>u8</code>, <code>i8</code>, <code>u16</code>, <code>i16</code>, <code>u32</code>, <code>i32</code>, <code>u64</code>, <code>i64</code></td><td><code>"i32"</code>, <code>"u64"</code> etc.</td><td><code>"42"</code>, <code>"123"</code> etc.</td></tr>
<tr><td><strong>Integer numeric <a href="language//book/language/ranges.html">range</a></strong></td><td><code>std::ops::Range&lt;rhai::INT&gt;</code>, <code>std::ops::RangeInclusive&lt;rhai::INT&gt;</code></td><td><code>"range"</code>, <code>"range="</code></td><td><code>"2..7"</code>, <code>"0..=15"</code> etc.</td></tr>
<tr><td><strong>Floating-point number</strong> (disabled with <a href="language//book/start/features.html"><code>no_float</code></a>)</td><td><code>rhai::FLOAT</code> (default <code>f64</code>, <code>f32</code> under <a href="language//book/start/features.html"><code>f32_float</code></a>)</td><td><code>"f32"</code> or <code>"f64"</code></td><td><code>"123.4567"</code> etc.</td></tr>
<tr><td><strong>Fixed precision decimal number</strong> (requires <a href="language//book/start/features.html"><code>decimal</code></a>)</td><td><a href="https://crates.io/crates/rust_decimal"><code>rust_decimal::Decimal</code></a></td><td><code>"decimal"</code></td><td><code>"42"</code>, <code>"123.4567"</code> etc.</td></tr>
<tr><td><strong>Boolean value</strong></td><td><code>bool</code></td><td><code>"bool"</code></td><td><code>"true"</code> or <code>"false"</code></td></tr>
<tr><td><strong>Unicode character</strong></td><td><code>char</code></td><td><code>"char"</code></td><td><code>"A"</code>, <code>"x"</code> etc.</td></tr>
<tr><td><strong>Immutable Unicode <a href="language//book/language/strings-chars.html">string</a></strong></td><td><a href="language//book/rust/immutable-string.html"><code>rhai::ImmutableString</code></a> (<code>Rc&lt;SmartString&gt;</code>, <code>Arc&lt;SmartString&gt;</code> under <a href="language//book/start/features.html"><code>sync</code></a>)</td><td><code>"string"</code></td><td><code>"hello"</code> etc.</td></tr>
<tr><td><strong><a href="language//book/language/arrays.html"><code>Array</code></a></strong> (disabled with <a href="language//book/start/features.html"><code>no_index</code></a>)</td><td><a href="language//book/language/arrays.html"><code>rhai::Array</code></a> (<code>Vec&lt;Dynamic&gt;</code>)</td><td><code>"array"</code></td><td><code>"[ 1, 2, 3 ]"</code> etc.</td></tr>
<tr><td><strong>Byte array – <a href="language//book/language/blobs.html"><code>BLOB</code></a></strong> (disabled with <a href="language//book/start/features.html"><code>no_index</code></a>)</td><td><a href="language//book/language/blobs.html"><code>rhai::Blob</code></a> (<code>Vec&lt;u8&gt;</code>)</td><td><code>"blob"</code></td><td><code>"[01020304abcd]"</code> etc.</td></tr>
<tr><td><strong><a href="language//book/language/object-maps.html">Object map</a></strong> (disabled with <a href="language//book/start/features.html"><code>no_object</code></a>)</td><td><a href="language//book/language/object-maps.html"><code>rhai::Map</code></a> (<code>BTreeMap&lt;SmartString, Dynamic&gt;</code>)</td><td><code>"map"</code></td><td><code>"#{ "a": 1, "b": true }"</code> etc.</td></tr>
<tr><td><strong><a href="language//book/language/timestamps.html">Timestamp</a></strong> (disabled with <a href="language//book/start/features.html"><code>no_time</code></a> or <a href="language//book/start/features.html"><code>no_std</code></a>)</td><td><code>std::time::Instant</code> (<a href="https://crates.io/crates/instant"><code>instant::Instant</code></a> if <a href="language//book/start/builds/wasm.html">WASM</a> build)</td><td><code>"timestamp"</code></td><td><code>"&lt;timestamp&gt;"</code></td></tr>
<tr><td><strong><a href="language//book/language/fn-ptr.html">Function pointer</a></strong></td><td><a href="language//book/language/fn-ptr.html"><code>rhai::FnPtr</code></a></td><td><code>"Fn"</code></td><td><code>"Fn(foo)"</code> etc.</td></tr>
<tr><td><strong>Dynamic value</strong> (i.e. can be anything)</td><td><a href="language//book/language/dynamic.html"><code>rhai::Dynamic</code></a></td><td><em>the actual type</em></td><td><em>actual value</em></td></tr>
<tr><td><strong>Shared value</strong> (a reference-counted, shared <a href="language//book/language/dynamic.html"><code>Dynamic</code></a> value, created via <a href="language//book/language/fn-closure.html">closures</a>, disabled with <a href="language//book/start/features.html"><code>no_closure</code></a>)</td><td></td><td><em>the actual type</em></td><td><em>actual value</em></td></tr>
<tr><td><strong>Nothing/void/nil/null/Unit</strong> (or whatever it is called)</td><td><code>()</code></td><td><code>"()"</code></td><td><code>""</code> <em>(empty string)</em></td></tr>
</tbody></table>
</div><div id="admonition-no-automatic-type-conversion-for-integers" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-no-automatic-type-conversion-for-integers-title">
<div class="admonition-title">
<div id="admonition-no-automatic-type-conversion-for-integers-title">
<p>No automatic type conversion for integers</p>
</div>
<a class="admonition-anchor-link" href="language/values-and-types.html#admonition-no-automatic-type-conversion-for-integers"></a>
</div>
<div>
<p>The various integer types are treated strictly <em>distinct</em> by Rhai, meaning that
<code>i32</code> and <code>i64</code> and <code>u32</code> and <code>u8</code> are completely different.</p>
<p>They cannot even be added together or compared with each other.</p>
<p>Nor can a smaller integer type be up-casted to a larger integer type.</p>
<p>This is very similar to Rust.</p>
</div>
</div>
<h2 id="default-types"><a class="header" href="#default-types">Default Types</a></h2>
<p>The default integer type is <code>i64</code>. If other integer types are not needed, it is possible to exclude
them and make a smaller build with the <a href="language//book/start/features.html"><code>only_i64</code></a> feature.</p>
<p>If only 32-bit integers are needed, enabling the <a href="language//book/start/features.html"><code>only_i32</code></a> feature will remove support for all
integer types other than <code>i32</code>, including <code>i64</code>.
This is useful on some 32-bit targets where using 64-bit integers incur a performance penalty.</p>
<div id="admonition-warning-default-integer-is-i64" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-warning-default-integer-is-i64-title">
<div class="admonition-title">
<div id="admonition-warning-default-integer-is-i64-title">
<p>Warning: Default integer is <code>i64</code></p>
</div>
<a class="admonition-anchor-link" href="language/values-and-types.html#admonition-warning-default-integer-is-i64"></a>
</div>
<div>
<p>Rhai’s default integer type is <code>i64</code>, which is <em>DIFFERENT</em> from Rust’s <code>i32</code>.</p>
<p>It is very easy to unsuspectingly set an <code>i32</code> into Rhai, which <em>still works</em> but will incur a significant
runtime performance hit since the <a href="language//book/engine/hello-world.html"><code>Engine</code></a> will treat <code>i32</code> as an opaque <a href="language//book/rust/custom-types.html">custom type</a> (unless using the
<a href="language//book/start/features.html"><code>only_i32</code></a> feature).</p>
<p><code>i64</code> is the default even on 32-bit systems.  To use <code>i32</code> on 32-bit systems requires the <a href="language//book/start/features.html"><code>only_i32</code></a> feature.</p>
</div>
</div>
<div id="admonition-tip-floating-point-numbers" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-floating-point-numbers-title">
<div class="admonition-title">
<div id="admonition-tip-floating-point-numbers-title">
<p>Tip: Floating-point numbers</p>
</div>
<a class="admonition-anchor-link" href="language/values-and-types.html#admonition-tip-floating-point-numbers"></a>
</div>
<div>
<p>If no floating-point is needed or supported, use the <a href="language//book/start/features.html"><code>no_float</code></a> feature to remove it.</p>
<p>Some applications require fixed-precision decimal numbers, which can be enabled via the <a href="language//book/start/features.html"><code>decimal</code></a> feature.</p>
</div>
</div>
<div id="admonition-immutable-strings" class="admonition admonish-info small" role="note" aria-labelledby="admonition-immutable-strings-title">
<div class="admonition-title">
<div id="admonition-immutable-strings-title">
<p>Immutable strings</p>
</div>
<a class="admonition-anchor-link" href="language/values-and-types.html#admonition-immutable-strings"></a>
</div>
<div>
<p><a href="language//book/language/strings-chars.html">Strings</a> in Rhai are <em>immutable</em>, meaning that they can be shared but not modified.</p>
<p>Internally, the <a href="language//book/rust/immutable-string.html"><code>ImmutableString</code></a> type is a wrapper over <code>Rc&lt;String&gt;</code> or <code>Arc&lt;String&gt;</code> (depending on <a href="language//book/start/features.html"><code>sync</code></a>).</p>
<p>Any modification done to a Rhai string causes the <a href="language//book/language/strings-chars.html">string</a> to be cloned and the modifications made to the copy.</p>
</div>
</div>
<div id="admonition-tip-convert-to-string" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-convert-to-string-title">
<div class="admonition-title">
<div id="admonition-tip-convert-to-string-title">
<p>Tip: Convert to string</p>
</div>
<a class="admonition-anchor-link" href="language/values-and-types.html#admonition-tip-convert-to-string"></a>
</div>
<div>
<p>The <a href="language//book/rust/print-custom.html"><code>to_string</code></a> function converts a standard type into a <a href="language//book/language/strings-chars.html">string</a> for display purposes.</p>
<p>The <a href="language//book/rust/print-custom.html"><code>to_debug</code></a> function converts a standard type into a <a href="language//book/language/strings-chars.html">string</a> in debug format.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dynamic-values"><a class="header" href="#dynamic-values">Dynamic Values</a></h1>
<p>A <code>Dynamic</code> value can be <em>any</em> type, as long as it implements <code>Clone</code>.</p>
<div id="admonition-send--sync" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-send--sync-title">
<div class="admonition-title">
<div id="admonition-send--sync-title">
<p><code>Send + Sync</code></p>
</div>
<a class="admonition-anchor-link" href="language/dynamic.html#admonition-send--sync"></a>
</div>
<div>
<p>Under the <a href="language//book/start/features.html"><code>sync</code></a> feature, all types must also be <code>Send + Sync</code>.</p>
</div>
</div>
<pre><code class="language-rust">let x = 42;         // value is an integer

x = 123.456;        // value is now a floating-point number

x = "hello";        // value is now a string

x = x.len &gt; 0;      // value is now a boolean

x = [x];            // value is now an array

x = #{x: x};        // value is now an object map</code></pre>
<h2 id="use-type_of-to-get-value-type"><a class="header" href="#use-type_of-to-get-value-type">Use <code>type_of()</code> to Get Value Type</a></h2>
<p>Because <a href="language//book/language/type-of.html"><code>type_of()</code></a> a <code>Dynamic</code> value returns the type of the actual value,
it is usually used to perform type-specific actions based on the actual value’s type.</p>
<pre><code class="language-js">let mystery = get_some_dynamic_value();

switch type_of(mystery) {
    "()" =&gt; print("Hey, I got the unit () here!"),
    "i64" =&gt; print("Hey, I got an integer here!"),
    "f64" =&gt; print("Hey, I got a float here!"),
    "decimal" =&gt; print("Hey, I got a decimal here!"),
    "range" =&gt; print("Hey, I got an exclusive range here!"),
    "range=" =&gt; print("Hey, I got an inclusive range here!"),
    "string" =&gt; print("Hey, I got a string here!"),
    "bool" =&gt; print("Hey, I got a boolean here!"),
    "array" =&gt; print("Hey, I got an array here!"),
    "blob" =&gt; print("Hey, I got a BLOB here!"),
    "map" =&gt; print("Hey, I got an object map here!"),
    "Fn" =&gt; print("Hey, I got a function pointer here!"),
    "timestamp" =&gt; print("Hey, I got a time-stamp here!"),
    "TestStruct" =&gt; print("Hey, I got the TestStruct custom type here!"),
    _ =&gt; print(`I don't know what this is: ${type_of(mystery)}`)
}
</code></pre>
<h2 id="parse-from-json"><a class="header" href="#parse-from-json">Parse from JSON</a></h2>
<div id="admonition-requires-metadata" class="admonition admonish-warning side" role="note" aria-labelledby="admonition-requires-metadata-title">
<div class="admonition-title">
<div id="admonition-requires-metadata-title">
<p>Requires <code>metadata</code></p>
</div>
<a class="admonition-anchor-link" href="language/dynamic.html#admonition-requires-metadata"></a>
</div>
<div>
<p><code>parse_json</code> is defined in the <a href="language//book/rust/packages/builtin.html"><code>LanguageCorePackage</code></a>, which is excluded when using a <a href="language//book/engine/raw.html">raw <code>Engine</code></a>.</p>
<p>It also requires the <a href="language//book/start/features.html"><code>metadata</code></a> feature; the <a href="language//book/start/features.html"><code>no_index</code></a> and <a href="language//book/start/features.html"><code>no_object</code></a> features must <em>not</em> be set.</p>
</div>
</div>
<p>Use <code>parse_json</code> to parse a JSON string into a <a href="language//book/language/dynamic.html"><code>Dynamic</code></a> value.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">JSON type</th><th style="text-align: center">Rhai type</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>number</code> (no decimal point)</td><td style="text-align: center"><code>INT</code></td></tr>
<tr><td style="text-align: center"><code>number</code> (with decimal point)</td><td style="text-align: center"><code>FLOAT</code></td></tr>
<tr><td style="text-align: center"><code>string</code></td><td style="text-align: center"><a href="language//book/language/strings-chars.html">string</a></td></tr>
<tr><td style="text-align: center"><code>boolean</code></td><td style="text-align: center"><code>bool</code></td></tr>
<tr><td style="text-align: center"><code>Array</code></td><td style="text-align: center"><a href="language//book/language/arrays.html">array</a></td></tr>
<tr><td style="text-align: center"><code>Object</code></td><td style="text-align: center"><a href="language//book/language/object-maps.html">object map</a></td></tr>
<tr><td style="text-align: center"><code>null</code></td><td style="text-align: center"><a href="language//book/language/values-and-types.html"><code>()</code></a></td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="type_of"><a class="header" href="#type_of"><code>type_of()</code></a></h1>
<p>The <code>type_of</code> function detects the actual type of a value.</p>
<p>This is useful because all <a href="language//book/language/variables.html">variables</a> are <a href="language//book/language/dynamic.html"><code>Dynamic</code></a> in nature.</p>
<pre><code class="language-js">// Use 'type_of()' to get the actual types of values
type_of('c') == "char";
type_of(42) == "i64";

let x = 123;
x.type_of() == "i64";       // method-call style is also OK
type_of(x) == "i64";

x = 99.999;
type_of(x) == "f64";

x = "hello";
if type_of(x) == "string" {
    do_something_first_with_string(x);
}

switch type_of(x) {
    "string" =&gt; do_something_with_string(x),
    "char" =&gt; do_something_with_char(x),
    "i64" =&gt; do_something_with_int(x),
    "f64" =&gt; do_something_with_float(x),
    "bool" =&gt; do_something_with_bool(x),
    _ =&gt; throw `I cannot work with ${type_of(x)}!!!`
}
</code></pre>
<div id="admonition-standard-types" class="admonition admonish-info small" role="note" aria-labelledby="admonition-standard-types-title">
<div class="admonition-title">
<div id="admonition-standard-types-title">
<p>Standard types</p>
</div>
<a class="admonition-anchor-link" href="language/type-of.html#admonition-standard-types"></a>
</div>
<div>
<p>See <a href="language//book/language/values-and-types.html">here</a> for the <code>type_of</code> output of standard types.</p>
</div>
</div>
<div id="admonition-custom-types" class="admonition admonish-info small" role="note" aria-labelledby="admonition-custom-types-title">
<div class="admonition-title">
<div id="admonition-custom-types-title">
<p>Custom types</p>
</div>
<a class="admonition-anchor-link" href="language/type-of.html#admonition-custom-types"></a>
</div>
<div>
<p><code>type_of()</code> a <a href="language//book/rust/custom-types.html">custom type</a> returns:</p>
<ul>
<li>
<p>the friendly name, if registered via <code>Engine::register_type_with_name</code></p>
</li>
<li>
<p>the full Rust type path, if registered via <code>Engine::register_type</code></p>
</li>
</ul>
<pre><code class="language-rust">struct TestStruct1;
struct TestStruct2;

engine
    // type_of(struct1) == "path::to::module::TestStruct1"
    .register_type::&lt;TestStruct1&gt;()
    // type_of(struct2) == "MyStruct"
    .register_type_with_name::&lt;TestStruct2&gt;("MyStruct");</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="interop-dynamic-data-with-rust"><a class="header" href="#interop-dynamic-data-with-rust">Interop <code>Dynamic</code> Data with Rust</a></h1>
<h2 id="create-a-dynamic-from-rust-type"><a class="header" href="#create-a-dynamic-from-rust-type">Create a <code>Dynamic</code> from Rust Type</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Rust type<br/><code>T: Clone</code>,<br/><code>K: Into&lt;String&gt;</code></th><th style="text-align: center">Unavailable under</th><th>Use API</th></tr></thead><tbody>
<tr><td><code>INT</code> (<code>i64</code> or <code>i32</code>)</td><td style="text-align: center"></td><td><code>value.into()</code></td></tr>
<tr><td><code>FLOAT</code> (<code>f64</code> or <code>f32</code>)</td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_float</code></a></td><td><code>value.into()</code></td></tr>
<tr><td><a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a> (requires <a href="language//book/start/features.html"><code>decimal</code></a>)</td><td style="text-align: center"></td><td><code>value.into()</code></td></tr>
<tr><td><code>bool</code></td><td style="text-align: center"></td><td><code>value.into()</code></td></tr>
<tr><td><a href="language//book/language/values-and-types.html"><code>()</code></a></td><td style="text-align: center"></td><td><code>value.into()</code></td></tr>
<tr><td><a href="language//book/language/strings-chars.html"><code>String</code></a>, <a href="language//book/language/strings-chars.html"><code>&amp;str</code></a>, <a href="language//book/rust/immutable-string.html"><code>ImmutableString</code></a></td><td style="text-align: center"></td><td><code>value.into()</code></td></tr>
<tr><td><code>char</code></td><td style="text-align: center"></td><td><code>value.into()</code></td></tr>
<tr><td><a href="language//book/language/arrays.html"><code>Array</code></a></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_index</code></a></td><td><code>Dynamic::from_array(value)</code></td></tr>
<tr><td><a href="language//book/language/blobs.html"><code>Blob</code></a></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_index</code></a></td><td><code>Dynamic::from_blob(value)</code></td></tr>
<tr><td><code>Vec&lt;T&gt;</code>, <code>&amp;[T]</code>, <code>Iterator&lt;T&gt;</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_index</code></a></td><td><code>value.into()</code></td></tr>
<tr><td><a href="language//book/language/object-maps.html"><code>Map</code></a></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_object</code></a></td><td><code>Dynamic::from_map(value)</code></td></tr>
<tr><td><code>HashMap&lt;K, T&gt;</code>, <code>HashSet&lt;K&gt;</code>,<br/><code>BTreeMap&lt;K, T&gt;</code>, <code>BTreeSet&lt;K&gt;</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_object</code></a></td><td><code>value.into()</code></td></tr>
<tr><td><a href="language//book/language/ranges.html"><code>INT..INT</code></a>, <a href="language//book/language/ranges.html"><code>INT..=INT</code></a></td><td style="text-align: center"></td><td><code>value.into()</code></td></tr>
<tr><td><code>Rc&lt;RwLock&lt;T&gt;&gt;</code> or <code>Arc&lt;Mutex&lt;T&gt;&gt;</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_closure</code></a></td><td><code>value.into()</code></td></tr>
<tr><td><a href="language//book/language/timestamps.html"><code>Instant</code></a></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_time</code></a> or <a href="language//book/start/features.html"><code>no_std</code></a></td><td><code>value.into()</code></td></tr>
<tr><td>All types (including above)</td><td style="text-align: center"></td><td><code>Dynamic::from(value)</code></td></tr>
</tbody></table>
</div>
<h2 id="type-checking-and-casting"><a class="header" href="#type-checking-and-casting">Type Checking and Casting</a></h2>
<div id="admonition-tip-try_cast-and-try_cast_result" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-try_cast-and-try_cast_result-title">
<div class="admonition-title">
<div id="admonition-tip-try_cast-and-try_cast_result-title">
<p>Tip: <code>try_cast</code> and <code>try_cast_result</code></p>
</div>
<a class="admonition-anchor-link" href="language/dynamic-rust.html#admonition-tip-try_cast-and-try_cast_result"></a>
</div>
<div>
<p>The <code>try_cast</code> method does not panic but returns <code>None</code> upon failure.</p>
<p>The <code>try_cast_result</code> method also does not panic but returns the original value upon failure.</p>
</div>
</div>
<p>A <a href="language//book/language/dynamic.html"><code>Dynamic</code></a> value’s actual type can be checked via <code>Dynamic::is</code>.</p>
<p>The <code>cast</code> method then converts the value into a specific, known type.</p>
<p>Use <code>clone_cast</code> to clone a reference to <a href="language//book/language/dynamic.html"><code>Dynamic</code></a>.</p>
<pre><code class="language-rust">let list: Array = engine.eval("...")?;      // return type is 'Array'
let item = list[0].clone();                 // an element in an 'Array' is 'Dynamic'

item.is::&lt;i64&gt;() == true;                   // 'is' returns whether a 'Dynamic' value is of a particular type

let value = item.cast::&lt;i64&gt;();             // if the element is 'i64', this succeeds; otherwise it panics
let value: i64 = item.cast();               // type can also be inferred

let value = item.try_cast::&lt;i64&gt;()?;        // 'try_cast' does not panic when the cast fails, but returns 'None'

let value = list[0].clone_cast::&lt;i64&gt;();    // use 'clone_cast' on '&amp;Dynamic'
let value: i64 = list[0].clone_cast();</code></pre>
<h2 id="type-name-and-matching-types"><a class="header" href="#type-name-and-matching-types">Type Name and Matching Types</a></h2>
<p>The <code>type_name</code> method gets the name of the actual type as a static string slice,
which can be <code>match</code>-ed against.</p>
<p>This is a very simple and direct way to act on a <a href="language//book/language/dynamic.html"><code>Dynamic</code></a> value based on the actual type of
the data value.</p>
<pre><code class="language-rust">let list: Array = engine.eval("...")?;      // return type is 'Array'
let item = list[0];                         // an element in an 'Array' is 'Dynamic'

match item.type_name() {                    // 'type_name' returns the name of the actual Rust type
    "()" =&gt; ...
    "i64" =&gt; ...
    "f64" =&gt; ...
    "rust_decimal::Decimal" =&gt; ...
    "core::ops::range::Range&lt;i64&gt;" =&gt; ...
    "core::ops::range::RangeInclusive&lt;i64&gt;" =&gt; ...
    "alloc::string::String" =&gt; ...
    "bool" =&gt; ...
    "char" =&gt; ...
    "rhai::FnPtr" =&gt; ...
    "std::time::Instant" =&gt; ...
    "crate::path::to::module::TestStruct" =&gt; ...
        :
}</code></pre>
<div id="admonition-always-full-path-name" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-always-full-path-name-title">
<div class="admonition-title">
<div id="admonition-always-full-path-name-title">
<p>Always full path name</p>
</div>
<a class="admonition-anchor-link" href="language/dynamic-rust.html#admonition-always-full-path-name"></a>
</div>
<div>
<p><code>type_name</code> always returns the <em>full</em> Rust path name of the type, even when the type
has been registered with a friendly name via <code>Engine::register_type_with_name</code>.</p>
<p>This behavior is different from that of the <a href="language//book/language/type-of.html"><code>type_of</code></a> function in Rhai.</p>
</div>
</div>
<h2 id="getting-a-reference-to-data"><a class="header" href="#getting-a-reference-to-data">Getting a Reference to Data</a></h2>
<p>Use <code>Dynamic::read_lock</code> and <code>Dynamic::write_lock</code> to get an immutable/mutable reference to the data
inside a <a href="language//book/language/dynamic.html"><code>Dynamic</code></a>.</p>
<pre><code class="language-rust">struct TheGreatQuestion {
    answer: i64
}

let question = TheGreatQuestion { answer: 42 };

let mut value: Dynamic = Dynamic::from(question);

let q_ref: &amp;TheGreatQuestion =
        &amp;*value.read_lock::&lt;TheGreatQuestion&gt;().unwrap();
//                       ^^^^^^^^^^^^^^^^^^^^ cast to data type

println!("answer = {}", q_ref.answer);          // prints 42

let q_mut: &amp;mut TheGreatQuestion =
        &amp;mut *value.write_lock::&lt;TheGreatQuestion&gt;().unwrap();
//                            ^^^^^^^^^^^^^^^^^^^^ cast to data type

q_mut.answer = 0;                               // mutate value

let value = value.cast::&lt;TheGreatQuestion&gt;();

println!("new answer = {}", value.answer);      // prints 0</code></pre>
<div id="admonition-tldr--why-read_lock-and-write_lock" class="admonition admonish-question" role="note" aria-labelledby="admonition-tldr--why-read_lock-and-write_lock-title">
<div class="admonition-title">
<div id="admonition-tldr--why-read_lock-and-write_lock-title">
<p>TL;DR – Why <code>read_lock</code> and <code>write_lock</code>?</p>
</div>
<a class="admonition-anchor-link" href="language/dynamic-rust.html#admonition-tldr--why-read_lock-and-write_lock"></a>
</div>
<div>
<p>As the naming shows, something is <em>locked</em> in order to allow accessing the data within a <a href="language//book/language/dynamic.html"><code>Dynamic</code></a>,
and that something is a <em>shared value</em> created by capturing variables from <a href="language//book/language/fn-closure.html">closures</a>.</p>
<p>Shared values are implemented as <code>Rc&lt;RefCell&lt;Dynamic&gt;&gt;</code> (<code>Arc&lt;RwLock&lt;Dynamic&gt;&gt;</code> under <a href="language//book/start/features.html"><code>sync</code></a>).</p>
<p>If the value is <em>not</em> a shared value, or if running under <a href="language//book/start/features.html"><code>no_closure</code></a> where there is
no capturing, this API de-sugars to a simple reference cast.</p>
<p>In other words, there is no locking and reference counting overhead for the vast majority of
non-shared values.</p>
<p>If the value <em>is</em> a shared value, then it is first <em>locked</em> and the returned <em>lock guard</em>
allows access to the underlying value in the specified type.</p>
</div>
</div>
<h2 id="methods-and-traits"><a class="header" href="#methods-and-traits">Methods and Traits</a></h2>
<p>The following methods are available when working with <a href="language//book/language/dynamic.html"><code>Dynamic</code></a>:</p>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th style="text-align: center">Not available under</th><th style="text-align: center">Return type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>type_name</code></td><td style="text-align: center"></td><td style="text-align: center"><code>&amp;str</code></td><td>name of the value’s type</td></tr>
<tr><td><code>into_shared</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_closure</code></a></td><td style="text-align: center"><a href="language//book/language/dynamic.html"><code>Dynamic</code></a></td><td>turn the value into a <em>shared</em> value</td></tr>
<tr><td><code>flatten_clone</code></td><td style="text-align: center"></td><td style="text-align: center"><a href="language//book/language/dynamic.html"><code>Dynamic</code></a></td><td>clone the value (a <em>shared</em> value, if any, is cloned into a separate copy)</td></tr>
<tr><td><code>flatten</code></td><td style="text-align: center"></td><td style="text-align: center"><a href="language//book/language/dynamic.html"><code>Dynamic</code></a></td><td>clone the value into a separate copy if it is <em>shared</em> and there are multiple outstanding references, otherwise <em>shared</em> values are turned unshared</td></tr>
<tr><td><code>read_lock&lt;T&gt;</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_closure</code></a> (pass thru’)</td><td style="text-align: center"><code>Option&lt;</code> <em>guard to</em> <code>T&gt;</code></td><td>lock the value for reading</td></tr>
<tr><td><code>write_lock&lt;T&gt;</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_closure</code></a> (pass thru’)</td><td style="text-align: center"><code>Option&lt;</code> <em>guard to</em> <code>T&gt;</code></td><td>lock the value exclusively for writing</td></tr>
<tr><td><code>deep_scan</code></td><td style="text-align: center"></td><td style="text-align: center"></td><td>recursively scan for <a href="language//book/language/dynamic.html"><code>Dynamic</code></a> values (e.g. items inside an <a href="language//book/language/arrays.html">array</a> or <a href="language//book/language/object-maps.html">object map</a>, or <a href="language//book/language/fn-curry.html">curried arguments</a> in a <a href="language//book/language/fn-ptr.html">function pointer</a>)</td></tr>
</tbody></table>
</div>
<h3 id="constructor-instance-methods"><a class="header" href="#constructor-instance-methods">Constructor instance methods</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th style="text-align: center">Not available under</th><th style="text-align: center">Value type</th><th style="text-align: center">Data type</th></tr></thead><tbody>
<tr><td><code>from_bool</code></td><td style="text-align: center"></td><td style="text-align: center"><code>bool</code></td><td style="text-align: center"><code>bool</code></td></tr>
<tr><td><code>from_int</code></td><td style="text-align: center"></td><td style="text-align: center"><code>INT</code></td><td style="text-align: center">integer number</td></tr>
<tr><td><code>from_float</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_float</code></a></td><td style="text-align: center"><code>FLOAT</code></td><td style="text-align: center">floating-point number</td></tr>
<tr><td><code>from_decimal</code></td><td style="text-align: center">non-<a href="language//book/start/features.html"><code>decimal</code></a></td><td style="text-align: center"><a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a></td><td style="text-align: center"><a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a></td></tr>
<tr><td><code>from_str</code></td><td style="text-align: center"></td><td style="text-align: center"><code>&amp;str</code></td><td style="text-align: center"><a href="language//book/language/strings-chars.html">string</a></td></tr>
<tr><td><code>from_char</code></td><td style="text-align: center"></td><td style="text-align: center"><code>char</code></td><td style="text-align: center"><a href="language//book/language/strings-chars.html">character</a></td></tr>
<tr><td><code>from_array</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_index</code></a></td><td style="text-align: center"><code>Vec&lt;T&gt;</code></td><td style="text-align: center"><a href="language//book/language/arrays.html">array</a></td></tr>
<tr><td><code>from_blob</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_index</code></a></td><td style="text-align: center"><code>Vec&lt;u8&gt;</code></td><td style="text-align: center"><a href="language//book/language/blobs.html">BLOB</a></td></tr>
<tr><td><code>from_map</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_object</code></a></td><td style="text-align: center"><code>Map</code></td><td style="text-align: center"><a href="language//book/language/object-maps.html">object map</a></td></tr>
<tr><td><code>from_timestamp</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_time</code></a> or <a href="language//book/start/features.html"><code>no_std</code></a></td><td style="text-align: center"><code>std::time::Instant</code> (<a href="https://crates.io/crates/instant"><code>instant::Instant</code></a> if <a href="language//book/start/builds/wasm.html">WASM</a> build)</td><td style="text-align: center"><a href="language//book/language/timestamps.html">timestamp</a></td></tr>
<tr><td><code>from&lt;T&gt;</code></td><td style="text-align: center"></td><td style="text-align: center"><code>T</code></td><td style="text-align: center"><a href="language//book/rust/custom-types.html">custom type</a></td></tr>
</tbody></table>
</div>
<h3 id="detection-methods"><a class="header" href="#detection-methods">Detection methods</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th style="text-align: center">Not available under</th><th style="text-align: center">Return type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>is&lt;T&gt;</code></td><td style="text-align: center"></td><td style="text-align: center"><code>bool</code></td><td>is the value of type <code>T</code>?</td></tr>
<tr><td><code>is_variant</code></td><td style="text-align: center"></td><td style="text-align: center"><code>bool</code></td><td>is the value a trait object (i.e. not one of Rhai’s <a href="language//book/language/values-and-types.html">standard types</a>)?</td></tr>
<tr><td><code>is_read_only</code></td><td style="text-align: center"></td><td style="text-align: center"><code>bool</code></td><td>is the value <a href="language//book/language/constants.html">constant</a>? A <a href="language//book/language/constants.html">constant</a> value should not be modified.</td></tr>
<tr><td><code>is_shared</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_closure</code></a></td><td style="text-align: center"><code>bool</code></td><td>is the value <em>shared</em> via a <a href="language//book/language/fn-closure.html">closure</a>?</td></tr>
<tr><td><code>is_locked</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_closure</code></a></td><td style="text-align: center"><code>bool</code></td><td>is the value <em>shared</em> and locked (i.e. currently being read)?</td></tr>
<tr><td><code>is_unit</code></td><td style="text-align: center"></td><td style="text-align: center"><code>bool</code></td><td>is the value <a href="language//book/language/values-and-types.html"><code>()</code></a>?</td></tr>
<tr><td><code>is_int</code></td><td style="text-align: center"></td><td style="text-align: center"><code>bool</code></td><td>is the value an integer?</td></tr>
<tr><td><code>is_float</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_float</code></a></td><td style="text-align: center"><code>bool</code></td><td>is the value a floating-point number?</td></tr>
<tr><td><code>is_decimal</code></td><td style="text-align: center">non-<a href="language//book/start/features.html"><code>decimal</code></a></td><td style="text-align: center"><code>bool</code></td><td>is the value a <a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a>?</td></tr>
<tr><td><code>is_bool</code></td><td style="text-align: center"></td><td style="text-align: center"><code>bool</code></td><td>is the value a <code>bool</code>?</td></tr>
<tr><td><code>is_char</code></td><td style="text-align: center"></td><td style="text-align: center"><code>bool</code></td><td>is the value a <a href="language//book/language/strings-chars.html">character</a>?</td></tr>
<tr><td><code>is_string</code></td><td style="text-align: center"></td><td style="text-align: center"><code>bool</code></td><td>is the value a <a href="language//book/language/strings-chars.html">string</a>?</td></tr>
<tr><td><code>is_array</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_index</code></a></td><td style="text-align: center"><code>bool</code></td><td>is the value an <a href="language//book/language/arrays.html">array</a>?</td></tr>
<tr><td><code>is_blob</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_index</code></a></td><td style="text-align: center"><code>bool</code></td><td>is the value a <a href="language//book/language/blobs.html">BLOB</a>?</td></tr>
<tr><td><code>is_map</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_object</code></a></td><td style="text-align: center"><code>bool</code></td><td>is the value an <a href="language//book/language/object-maps.html">object map</a>?</td></tr>
<tr><td><code>is_timestamp</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_time</code></a> or <a href="language//book/start/features.html"><code>no_std</code></a></td><td style="text-align: center"><code>bool</code></td><td>is the value a <a href="language//book/language/timestamps.html">timestamp</a>?</td></tr>
</tbody></table>
</div>
<h3 id="casting-methods"><a class="header" href="#casting-methods">Casting methods</a></h3>
<p>The following methods cast a <a href="language//book/language/dynamic.html"><code>Dynamic</code></a> into a specific type:</p>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th style="text-align: center">Not available under</th><th style="text-align: center">Return type (error is name of actual type if <code>&amp;str</code>)</th></tr></thead><tbody>
<tr><td><code>cast&lt;T&gt;</code></td><td style="text-align: center"></td><td style="text-align: center"><code>T</code> (panics on failure)</td></tr>
<tr><td><code>try_cast&lt;T&gt;</code></td><td style="text-align: center"></td><td style="text-align: center"><code>Option&lt;T&gt;</code></td></tr>
<tr><td><code>try_cast_result&lt;T&gt;</code></td><td style="text-align: center"></td><td style="text-align: center"><code>Result&lt;T, Dynamic&gt;</code></td></tr>
<tr><td><code>clone_cast&lt;T&gt;</code></td><td style="text-align: center"></td><td style="text-align: center">cloned copy of <code>T</code> (panics on failure)</td></tr>
<tr><td><code>as_unit</code></td><td style="text-align: center"></td><td style="text-align: center"><code>Result&lt;(), &amp;str&gt;</code></td></tr>
<tr><td><code>as_int</code></td><td style="text-align: center"></td><td style="text-align: center"><code>Result&lt;INT, &amp;str&gt;</code></td></tr>
<tr><td><code>as_float</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_float</code></a></td><td style="text-align: center"><code>Result&lt;FLOAT, &amp;str&gt;</code></td></tr>
<tr><td><code>as_decimal</code></td><td style="text-align: center">non-<a href="language//book/start/features.html"><code>decimal</code></a></td><td style="text-align: center"><a href="https://crates.io/crates/rust_decimal"><code>Result&lt;Decimal, &amp;str&gt;</code></a></td></tr>
<tr><td><code>as_bool</code></td><td style="text-align: center"></td><td style="text-align: center"><code>Result&lt;bool, &amp;str&gt;</code></td></tr>
<tr><td><code>as_char</code></td><td style="text-align: center"></td><td style="text-align: center"><code>Result&lt;char, &amp;str&gt;</code></td></tr>
<tr><td><code>as_immutable_string_ref</code></td><td style="text-align: center"></td><td style="text-align: center"><a href="language//book/rust/immutable-string.html"><code>Result&lt;impl Deref&lt;Target=ImmutableString&gt;, &amp;str&gt;</code></a></td></tr>
<tr><td><code>as_immutable_string_mut</code></td><td style="text-align: center"></td><td style="text-align: center"><a href="language//book/rust/immutable-string.html"><code>Result&lt;impl DerefMut&lt;Target=ImmutableString&gt;, &amp;str&gt;</code></a></td></tr>
<tr><td><code>as_array_ref</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_index</code></a></td><td style="text-align: center"><a href="language//book/language/arrays.html"><code>Result&lt;impl Deref&lt;Target=Array&gt;, &amp;str&gt;</code></a></td></tr>
<tr><td><code>as_array_mut</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_index</code></a></td><td style="text-align: center"><a href="language//book/language/arrays.html"><code>Result&lt;impl DerefMut&lt;Target=Array&gt;, &amp;str&gt;</code></a></td></tr>
<tr><td><code>as_blob_ref</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_index</code></a></td><td style="text-align: center"><a href="language//book/language/blobs.html"><code>Result&lt;impl Deref&lt;Target=Blob&gt;, &amp;str&gt;</code></a></td></tr>
<tr><td><code>as_blob_mut</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_index</code></a></td><td style="text-align: center"><a href="language//book/language/blobs.html"><code>Result&lt;impl DerefMut&lt;Target=Blob&gt;, &amp;str&gt;</code></a></td></tr>
<tr><td><code>as_map_ref</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_object</code></a></td><td style="text-align: center"><a href="language//book/language/object-maps.html"><code>Result&lt;impl Deref&lt;Target=Map&gt;, &amp;str&gt;</code></a></td></tr>
<tr><td><code>as_map_mut</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_object</code></a></td><td style="text-align: center"><a href="language//book/language/object-maps.html"><code>Result&lt;impl DerefMut&lt;Target=Map&gt;, &amp;str&gt;</code></a></td></tr>
<tr><td><code>into_string</code></td><td style="text-align: center"></td><td style="text-align: center"><code>Result&lt;String, &amp;str&gt;</code></td></tr>
<tr><td><code>into_immutable_string</code></td><td style="text-align: center"></td><td style="text-align: center"><a href="language//book/rust/immutable-string.html"><code>Result&lt;ImmutableString, &amp;str&gt;</code></a></td></tr>
<tr><td><code>into_array</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_index</code></a></td><td style="text-align: center"><a href="language//book/language/arrays.html"><code>Result&lt;Array, &amp;str&gt;</code></a></td></tr>
<tr><td><code>into_blob</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_index</code></a></td><td style="text-align: center"><a href="language//book/language/blobs.html"><code>Result&lt;Blob, &amp;str&gt;</code></a></td></tr>
<tr><td><code>into_typed_array&lt;T&gt;</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_index</code></a></td><td style="text-align: center"><code>Result&lt;Vec&lt;T&gt;, &amp;str&gt;</code></td></tr>
</tbody></table>
</div>
<h3 id="constructor-traits"><a class="header" href="#constructor-traits">Constructor traits</a></h3>
<p>The following constructor traits are implemented for <a href="language//book/language/dynamic.html"><code>Dynamic</code></a> where <code>T: Clone</code>:</p>
<div class="table-wrapper"><table><thead><tr><th>Trait</th><th style="text-align: center">Not available under</th><th style="text-align: center">Data type</th></tr></thead><tbody>
<tr><td><code>From&lt;()&gt;</code></td><td style="text-align: center"></td><td style="text-align: center"><code>()</code></td></tr>
<tr><td><code>From&lt;INT&gt;</code></td><td style="text-align: center"></td><td style="text-align: center">integer number</td></tr>
<tr><td><code>From&lt;FLOAT&gt;</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_float</code></a></td><td style="text-align: center">floating-point number</td></tr>
<tr><td><code>From&lt;Decimal&gt;</code></td><td style="text-align: center">non-<a href="language//book/start/features.html"><code>decimal</code></a></td><td style="text-align: center"><a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a></td></tr>
<tr><td><code>From&lt;bool&gt;</code></td><td style="text-align: center"></td><td style="text-align: center"><code>bool</code></td></tr>
<tr><td><code>From&lt;S: Into&lt;ImmutableString&gt;&gt;</code><br/>e.g. <code>From&lt;String&gt;</code>, <code>From&lt;&amp;str&gt;</code></td><td style="text-align: center"></td><td style="text-align: center"><a href="language//book/rust/immutable-string.html"><code>ImmutableString</code></a></td></tr>
<tr><td><code>From&lt;char&gt;</code></td><td style="text-align: center"></td><td style="text-align: center"><a href="language//book/language/strings-chars.html">character</a></td></tr>
<tr><td><code>From&lt;Vec&lt;T&gt;&gt;</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_index</code></a></td><td style="text-align: center"><a href="language//book/language/arrays.html">array</a></td></tr>
<tr><td><code>From&lt;&amp;[T]&gt;</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_index</code></a></td><td style="text-align: center"><a href="language//book/language/arrays.html">array</a></td></tr>
<tr><td><code>From&lt;BTreeMap&lt;K: Into&lt;SmartString&gt;, T&gt;&gt;</code><br/>e.g. <code>From&lt;BTreeMap&lt;String, T&gt;&gt;</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_object</code></a></td><td style="text-align: center"><a href="language//book/language/object-maps.html">object map</a></td></tr>
<tr><td><code>From&lt;BTreeSet&lt;K: Into&lt;SmartString&gt;&gt;&gt;</code><br/>e.g. <code>From&lt;BTreeSet&lt;String&gt;&gt;</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_object</code></a></td><td style="text-align: center"><a href="language//book/language/object-maps.html">object map</a></td></tr>
<tr><td><code>From&lt;HashMap&lt;K: Into&lt;SmartString&gt;, T&gt;&gt;</code><br/>e.g. <code>From&lt;HashMap&lt;String, T&gt;&gt;</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_object</code></a> or <a href="language//book/start/features.html"><code>no_std</code></a></td><td style="text-align: center"><a href="language//book/language/object-maps.html">object map</a></td></tr>
<tr><td><code>From&lt;HashSet&lt;K: Into&lt;SmartString&gt;&gt;&gt;</code><br/>e.g. <code>From&lt;HashSet&lt;String&gt;&gt;</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_object</code></a> or <a href="language//book/start/features.html"><code>no_std</code></a></td><td style="text-align: center"><a href="language//book/language/object-maps.html">object map</a></td></tr>
<tr><td><code>From&lt;FnPtr&gt;</code></td><td style="text-align: center"></td><td style="text-align: center"><a href="language//book/language/fn-ptr.html">function pointer</a></td></tr>
<tr><td><code>From&lt;Instant&gt;</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_time</code></a> or <a href="language//book/start/features.html"><code>no_std</code></a></td><td style="text-align: center"><a href="language//book/language/timestamps.html">timestamp</a></td></tr>
<tr><td><code>From&lt;Rc&lt;RefCell&lt;Dynamic&gt;&gt;&gt;</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>sync</code></a> or <a href="language//book/start/features.html"><code>no_closure</code></a></td><td style="text-align: center"><a href="language//book/language/dynamic.html"><code>Dynamic</code></a></td></tr>
<tr><td><code>From&lt;Arc&lt;RwLock&lt;Dynamic&gt;&gt;&gt;</code> (<a href="language//book/start/features.html"><code>sync</code></a>)</td><td style="text-align: center">non-<a href="language//book/start/features.html"><code>sync</code></a> or <a href="language//book/start/features.html"><code>no_closure</code></a></td><td style="text-align: center"><a href="language//book/language/dynamic.html"><code>Dynamic</code></a></td></tr>
<tr><td><code>FromIterator&lt;X: IntoIterator&lt;Item=T&gt;&gt;</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_index</code></a></td><td style="text-align: center"><a href="language//book/language/arrays.html">array</a></td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="dynamic-value-tag"><a class="header" href="#dynamic-value-tag">Dynamic Value Tag</a></h1>
<p>Each <a href="language//book/language/dynamic.html"><code>Dynamic</code></a> value can contain a <em>tag</em> that is <code>i32</code> and can contain any arbitrary data.</p>
<p>On 32-bit targets, however, the tag is only <code>i16</code>.</p>
<p>The tag defaults to zero.</p>
<div id="admonition-value-out-of-bounds" class="admonition admonish-bug small" role="note" aria-labelledby="admonition-value-out-of-bounds-title">
<div class="admonition-title">
<div id="admonition-value-out-of-bounds-title">
<p>Value out of bounds</p>
</div>
<a class="admonition-anchor-link" href="language/dynamic-tag.html#admonition-value-out-of-bounds"></a>
</div>
<div>
<p>It is an error to set a tag to a value beyond the bounds of <code>i32</code> (<code>i16</code> on 32-bit targets).</p>
</div>
</div>
<h2 id="examples-5"><a class="header" href="#examples-5">Examples</a></h2>
<pre><code class="language-rust">let x = 42;

x.tag == 0;             // tag defaults to zero

x.tag = 123;            // set tag value

set_tag(x, 123);        // 'set_tag' function also works

x.tag == 123;           // get updated tag value

x.tag() == 123;         // method also works

tag(x) == 123;          // function call style also works

x.tag[3..5] = 2;        // tag can be used as a bit-field

x.tag[3..5] == 2;

let y = x;

y.tag == 123;           // the tag is copied across assignment

y.tag = 3000000000;     // runtime error: 3000000000 is too large for 'i32'</code></pre>
<h2 id="practical-applications"><a class="header" href="#practical-applications">Practical Applications</a></h2>
<p>Attaching arbitrary information together with a value has a lot of practical uses.</p>
<h3 id="identify-code-path"><a class="header" href="#identify-code-path">Identify code path</a></h3>
<p>For example, it is easy to attach an ID number to a value to indicate how or why that value is
originally set.</p>
<p>This is tremendously convenient for debugging purposes where it is necessary to figure out which
code path a particular value went through.</p>
<p>After the script is verified, all tag assignment statements can simply be removed.</p>
<pre><code class="language-js">const ROUTE1 = 1;
const ROUTE2 = 2;
const ROUTE3 = 3;
const ERROR_ROUTE = 9;

fn some_complex_calculation(x) {
    let result;

    if some_complex_condition(x) {
        result = 42;
        result.tag = ROUTE1;        // record route #1
    } else if some_other_very_complex_condition(x) == 1 {
        result = 123;
        result.tag = ROUTE2;        // record route #2
    } else if some_non_understandable_calculation(x) &gt; 0 {
        result = 0;
        result.tag = ROUTE3;        // record route #3
    } else {
        result = -1;
        result.tag = ERROR_ROUTE;   // record error
    }

    result  // this value now contains the tag
}

let my_result = some_complex_calculation(key);

// The code path that 'my_result' went through is now in its tag.

// It is now easy to trace how 'my_result' gets its final value.

print(`Result = ${my_result} and reason = ${my_result.tag}`);
</code></pre>
<h3 id="identify-data-source"><a class="header" href="#identify-data-source">Identify data source</a></h3>
<p>It is convenient to use the tag value to record the <em>source</em> of a piece of data.</p>
<pre><code class="language-js">let x = [0, 1, 2, 3, 42, 99, 123];

// Store the index number of each value into its tag before
// filtering out all even numbers, leaving only odd numbers
let filtered = x.map(|v, i| { v.tag = i; v }).filter(|v| v.is_odd());

// The tag now contains the original index position

for (data, i) in filtered {
    print(`${i + 1}: Value ${data} from position #${data.tag + 1}`);
}
</code></pre>
<h3 id="identify-code-conditions"><a class="header" href="#identify-code-conditions">Identify code conditions</a></h3>
<p>The tag value may also contain a <em><a href="language//book/language/bit-fields.html">bit-field</a></em> of up to 32 (16 under 32-bit targets) individual bits,
recording up to 32 (or 16 under 32-bit targets) logic conditions that contributed to the value.</p>
<p>Again, after the script is verified, all tag assignment statements can simply be removed.</p>
<pre><code class="language-js">
fn some_complex_calculation(x) {
    let result = x;

    // Check first condition
    if some_complex_condition() {
        result += 1;
        result.tag[0] = true;   // Set first bit in bit-field
    }

    // Check second condition
    if some_other_very_complex_condition(x) == 1 {
        result *= 10;
        result.tag[1] = true;   // Set second bit in bit-field
    }

    // Check third condition
    if some_non_understandable_calculation(x) &gt; 0 {
        result -= 42;
        result.tag[2] = true;   // Set third bit in bit-field
    }

    // Check result
    if result &gt; 100 {
        result = 0;
        result.tag[3] = true;   // Set forth bit in bit-field
    }

    result
}

let my_result = some_complex_calculation(42);

// The tag of 'my_result' now contains a bit-field indicating
// the result of each condition.

// It is now easy to trace how 'my_result' gets its final value.
// Use indexing on the tag to get at individual bits.

print(`Result = ${my_result}`);
print(`First condition = ${my_result.tag[0]}`);
print(`Second condition = ${my_result.tag[1]}`);
print(`Third condition = ${my_result.tag[2]}`);
print(`Result check = ${my_result.tag[3]}`);
</code></pre>
<h3 id="return-auxillary-info"><a class="header" href="#return-auxillary-info">Return auxillary info</a></h3>
<p>Sometimes it is useful to return auxillary info from a <a href="language//book/language/functions.html">function</a>.</p>
<pre><code class="language-rust">// Verify Bell's Inequality by calculating a norm
// and comparing it with a hypotenuse.
// https://en.wikipedia.org/wiki/Bell%27s_theorem
//
// Returns the smaller of the norm or hypotenuse.
// Tag is 1 if norm &lt;= hypo, 0 if otherwise.
fn bells_inequality(x, y, z) {
    let norm = sqrt(x ** 2 + y ** 2);
    let result;

    if norm &lt;= z {
        result = norm;
        result.tag = 1;
    } else {
        result = z;
        result.tag = 0;
    }

    result
}

let dist = bells_inequality(x, y, z);

print(`Value = ${dist}`);

if dist.tag == 1 {
    print("Local realism maintained! Einstein rules!");
} else {
    print("Spooky action at a distance detected! Einstein will hate this...");
}</code></pre>
<h3 id="poor-mans-tuples"><a class="header" href="#poor-mans-tuples">Poor-man’s tuples</a></h3>
<p>Rust has <em>tuples</em> but Rhai does not (nor does JavaScript in this sense).</p>
<p>Similar to the JavaScript situation, practical alternatives using Rhai include returning an
<a href="language//book/language/object-maps.html">object map</a> or an <a href="language//book/language/arrays.html">array</a>.</p>
<p>Both of these alternatives, however, incur overhead that may be wasteful when the amount of
additional information is small – e.g. in many cases, a single <code>bool</code>, or a small number.</p>
<p>To return a number of <em>small</em> values from <a href="language//book/language/functions.html">functions</a>, the tag value as a <a href="language//book/language/bit-fields.html">bit-field</a> is an ideal
container without resorting to a full-blown <a href="language//book/language/object-maps.html">object map</a> or <a href="language//book/language/arrays.html">array</a>.</p>
<pre><code class="language-rust">// This function essentially returns a tuple of four numbers:
// (result, a, b, c)
fn complex_calc(x, y, z) {
    let a = x + y;
    let b = x - y + z;
    let c = (a + b) * z / y;
    let r = do_complex_calculation(a, b, c);

    // Store 'a', 'b' and 'c' into tag if they are small
    r.tag[0..8] = a;
    r.tag[8..16] = b;
    r.tag[16..32] = c;

    r
}

// Deconstruct the tuple
let result = complex_calc(x, y, z);
let a = r.tag[0..8];
let b = r.tag[8..16];
let c = r.tag[16..32];</code></pre>
<h2 id="tldr-2"><a class="header" href="#tldr-2">TL;DR</a></h2>
<div id="admonition-tell-me-really-what-is-the-_point_" class="admonition admonish-question" role="note" aria-labelledby="admonition-tell-me-really-what-is-the-_point_-title">
<div class="admonition-title">
<div id="admonition-tell-me-really-what-is-the-_point_-title">
<p>Tell me, really, what is the <em>point</em>?</p>
</div>
<a class="admonition-anchor-link" href="language/dynamic-tag.html#admonition-tell-me-really-what-is-the-_point_"></a>
</div>
<div>
<p>Due to byte alignment requirements on modern CPU’s, there are unused spaces in a <a href="language//book/language/dynamic.html"><code>Dynamic</code></a> type,
of the order of 4 bytes on 64-bit targets (2 bytes on 32-bit).</p>
<p>It is empty space that can be put to good use and not wasted, especially when Rhai does not have
built-in support of tuples in order to return multiple values from <a href="language//book/language/functions.html">functions</a>.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="serialization-and-deserialization-of-dynamic-with-serde"><a class="header" href="#serialization-and-deserialization-of-dynamic-with-serde">Serialization and Deserialization of <code>Dynamic</code> with <code>serde</code></a></h1>
<p>Rhai’s <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> type supports serialization and deserialization by
<a href="https://crates.io/crates/serde"><code>serde</code></a> via the <a href="rust//book/start/features.html"><code>serde</code></a> feature.</p>
<div id="admonition-tip" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="rust/serde.html#admonition-tip"></a>
</div>
<div>
<p><a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> works <em>both</em> as a <em>serialization format</em> as well as a data type that is serializable.</p>
</div>
</div>
<h2 id="serializedeserialize-a-dynamic"><a class="header" href="#serializedeserialize-a-dynamic">Serialize/Deserialize a <code>Dynamic</code></a></h2>
<p>With the <a href="rust//book/start/features.html"><code>serde</code></a> feature turned on, <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> implements <a href="https://docs.serde.rs/serde/trait.Serialize.html"><code>serde::Serialize</code></a> and
<a href="https://docs.serde.rs/serde/trait.Deserialize.html"><code>serde::Deserialize</code></a>, so it can easily be serialized and deserialized with <a href="rust//book/rust/serde.html"><code>serde</code></a> (for example,
to and from JSON via <a href="https://crates.io/crates/serde_json"><code>serde_json</code></a>).</p>
<pre><code class="language-rust">let value: Dynamic = ...;

// Serialize 'Dynamic' to JSON
let json = serde_json::to_string(&amp;value);

// Deserialize 'Dynamic' from JSON
let result: Dynamic = serde_json::from_str(&amp;json);</code></pre>
<div id="admonition-custom-types" class="admonition admonish-note small" role="note" aria-labelledby="admonition-custom-types-title">
<div class="admonition-title">
<div id="admonition-custom-types-title">
<p>Custom types</p>
</div>
<a class="admonition-anchor-link" href="rust/serde.html#admonition-custom-types"></a>
</div>
<div>
<p><a href="rust//book/rust/custom-types.html">Custom types</a> are serialized as text strings of the value’s type name.</p>
</div>
</div>
<div id="admonition-blobs" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-blobs-title">
<div class="admonition-title">
<div id="admonition-blobs-title">
<p>BLOB’s</p>
</div>
<a class="admonition-anchor-link" href="rust/serde.html#admonition-blobs"></a>
</div>
<div>
<p><a href="rust//book/language/blobs.html">BLOB’s</a>, or byte-arrays, are serialized and deserialized as simple <a href="rust//book/language/arrays.html">arrays</a> for some formats such as JSON.</p>
</div>
</div>
<div id="admonition-tip-lighter-alternative-for-json" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-lighter-alternative-for-json-title">
<div class="admonition-title">
<div id="admonition-tip-lighter-alternative-for-json-title">
<p>Tip: Lighter alternative for JSON</p>
</div>
<a class="admonition-anchor-link" href="rust/serde.html#admonition-tip-lighter-alternative-for-json"></a>
</div>
<div>
<p>The <a href="https://crates.io/crates/serde_json"><code>serde_json</code></a> crate is quite heavy.</p>
<p>If only <em>simple</em> JSON parsing (i.e. only deserialization) of a hash object into a Rhai <a href="rust//book/language/object-maps.html">object map</a> is required,
the <a href="rust//book/language/json.html"><code>Engine::parse_json</code></a> method is available as a <em>cheap</em> alternative,
but it does not provide the same level of correctness, nor are there any configurable options.</p>
</div>
</div>
<h2 id="dynamic-as-serialization-format"><a class="header" href="#dynamic-as-serialization-format"><code>Dynamic</code> as Serialization Format</a></h2>
<p>A <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> can be seamlessly converted to and from any type that implements <a href="https://docs.serde.rs/serde/trait.Serialize.html"><code>serde::Serialize</code></a>
and/or <a href="https://docs.serde.rs/serde/trait.Deserialize.html"><code>serde::Deserialize</code></a>, acting as a serialization format.</p>
<h3 id="serialize-any-type-to-dynamic"><a class="header" href="#serialize-any-type-to-dynamic">Serialize Any Type to <code>Dynamic</code></a></h3>
<p>The function <code>rhai::serde::to_dynamic</code> automatically converts any Rust type that implements
<a href="https://docs.serde.rs/serde/trait.Serialize.html"><code>serde::Serialize</code></a> into a <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a>.</p>
<p>For primary types, this is usually not necessary because using <a href="rust//book/language/dynamic.html"><code>Dynamic::from</code></a> is much
easier and is essentially the same thing.  The only difference is treatment for integer values.
<code>Dynamic::from</code> keeps different integer types intact, while <code>rhai::serde::to_dynamic</code> converts them
all into <a href="rust//book/language/values-and-types.html"><code>INT</code></a> (i.e. the system integer type which is <code>i64</code> or <code>i32</code> depending on
the <a href="rust//book/start/features.html"><code>only_i32</code></a> feature).</p>
<p>Rust <code>struct</code>’s (or any type that is marked as a <code>serde</code> map) are converted into <a href="rust//book/language/object-maps.html">object maps</a> while
Rust <code>Vec</code>’s (or any type that is marked as a <code>serde</code> sequence) are converted into <a href="rust//book/language/arrays.html">arrays</a>.</p>
<p>While it is also simple to serialize a Rust type to <code>JSON</code> via <code>serde</code>,
then use <a href="rust//book/language/json.html"><code>Engine::parse_json</code></a> to convert it into an <a href="rust//book/language/object-maps.html">object map</a>,
<code>rhai::serde::to_dynamic</code> serializes it to <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> directly via <code>serde</code> without going through the <code>JSON</code> step.</p>
<pre><code class="language-rust">use rhai::{Dynamic, Map};
use rhai::serde::to_dynamic;

#[derive(Debug, serde::Serialize)]
struct Point {
    x: f64,
    y: f64
}

#[derive(Debug, serde::Serialize)]
struct MyStruct {
    a: i64,
    b: Vec&lt;String&gt;,
    c: bool,
    d: Point
}

let x = MyStruct {
    a: 42,
    b: vec![ "hello".into(), "world".into() ],
    c: true,
    d: Point { x: 123.456, y: 999.0 }
};

// Convert the 'MyStruct' into a 'Dynamic'
let map: Dynamic = to_dynamic(x);

map.is::&lt;Map&gt;() == true;</code></pre>
<h3 id="deserialize-a-dynamic-into-any-type"><a class="header" href="#deserialize-a-dynamic-into-any-type">Deserialize a <code>Dynamic</code> into Any Type</a></h3>
<p>The function <code>rhai::serde::from_dynamic</code> automatically converts a <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> value into any Rust type
that implements <a href="https://docs.serde.rs/serde/trait.Deserialize.html"><code>serde::Deserialize</code></a>.</p>
<p>In particular, <a href="rust//book/language/object-maps.html">object maps</a> are converted into Rust <code>struct</code>’s (or any type that is marked as
a <code>serde</code> map) while <a href="rust//book/language/arrays.html">arrays</a> are converted into Rust <code>Vec</code>’s (or any type that is marked
as a <code>serde</code> sequence).</p>
<pre><code class="language-rust">use rhai::{Engine, Dynamic};
use rhai::serde::from_dynamic;

#[derive(Debug, serde::Deserialize)]
struct Point {
    x: f64,
    y: f64
}

#[derive(Debug, serde::Deserialize)]
struct MyStruct {
    a: i64,
    b: Vec&lt;String&gt;,
    c: bool,
    d: Point
}

let engine = Engine::new();

let result: Dynamic = engine.eval(
r#"
<span class="boring">    {
</span>        a: 42,
        b: [ "hello", "world" ],
        c: true,
        d: #{ x: 123.456, y: 999.0 }
    }
"#)?;

// Convert the 'Dynamic' object map into 'MyStruct'
let x: MyStruct = from_dynamic(&amp;result)?;</code></pre>
<div id="admonition-cannot-deserialize-shared-values" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-cannot-deserialize-shared-values-title">
<div class="admonition-title">
<div id="admonition-cannot-deserialize-shared-values-title">
<p>Cannot deserialize shared values</p>
</div>
<a class="admonition-anchor-link" href="rust/serde.html#admonition-cannot-deserialize-shared-values"></a>
</div>
<div>
<p>A <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> containing a <em>shared</em> value cannot be deserialized.
It will give a type error.</p>
<p>Use <code>Dynamic::flatten</code> to obtain a cloned copy before deserialization
(if the value is not shared, it is simply returned and not cloned).</p>
<p>Shared values are turned off via the <a href="rust//book/start/features.html"><code>no_closure</code></a> feature.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="numbers"><a class="header" href="#numbers">Numbers</a></h1>
<h2 id="integers"><a class="header" href="#integers">Integers</a></h2>
<div id="admonition-tip-bit-fields" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-bit-fields-title">
<div class="admonition-title">
<div id="admonition-tip-bit-fields-title">
<p>Tip: Bit-fields</p>
</div>
<a class="admonition-anchor-link" href="language/numbers.html#admonition-tip-bit-fields"></a>
</div>
<div>
<p>Integers can also be conveniently manipulated as <a href="language//book/language/bit-fields.html">bit-fields</a>.</p>
</div>
</div>
<p>Integer numbers follow C-style format with support for decimal, binary (<code>0b</code>), octal (<code>0o</code>) and hex (<code>0x</code>) notations.</p>
<p>The default system integer type (also aliased to <code>INT</code>) is <code>i64</code>. It can be turned into <code>i32</code> via the <a href="language//book/start/features.html"><code>only_i32</code></a> feature.</p>
<h2 id="floating-point-numbers"><a class="header" href="#floating-point-numbers">Floating-Point Numbers</a></h2>
<div id="admonition-tip-notations" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-notations-title">
<div class="admonition-title">
<div id="admonition-tip-notations-title">
<p>Tip: Notations</p>
</div>
<a class="admonition-anchor-link" href="language/numbers.html#admonition-tip-notations"></a>
</div>
<div>
<p>Both decimal and scientific notations can be used to represent floating-point numbers.</p>
</div>
</div>
<p>Floating-point numbers are also supported if not disabled with <a href="language//book/start/features.html"><code>no_float</code></a>.</p>
<p>The default system floating-point type is <code>f64</code> (also aliased to <code>FLOAT</code>).
It can be turned into <code>f32</code> via the <a href="language//book/start/features.html"><code>f32_float</code></a> feature.</p>
<h2 id="decimal-numbers"><a class="header" href="#decimal-numbers"><code>Decimal</code> Numbers</a></h2>
<p>When rounding errors cannot be accepted, such as in financial calculations, the <a href="language//book/start/features.html"><code>decimal</code></a> feature
turns on support for the <a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a> type, which is a fixed-precision floating-point
number with no rounding errors.</p>
<h2 id="number-literals"><a class="header" href="#number-literals">Number Literals</a></h2>
<p><code>_</code> separators can be added freely and are ignored within a number – except at the very beginning or right after
a decimal point (<code>.</code>).</p>
<div class="table-wrapper"><table><thead><tr><th>Sample</th><th>Format</th><th style="text-align: center">Value type</th><th style="text-align: center"><a href="language//book/start/features.html"><code>no_float</code></a></th><th style="text-align: center"><a href="language//book/start/features.html"><code>no_float</code></a> + <a href="language//book/start/features.html"><code>decimal</code></a></th></tr></thead><tbody>
<tr><td><code>_123</code></td><td><em>improper separator</em></td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td><code>123_345</code>, <code>-42</code></td><td>decimal</td><td style="text-align: center"><code>INT</code></td><td style="text-align: center"><code>INT</code></td><td style="text-align: center"><code>INT</code></td></tr>
<tr><td><code>0o07_76</code></td><td>octal</td><td style="text-align: center"><code>INT</code></td><td style="text-align: center"><code>INT</code></td><td style="text-align: center"><code>INT</code></td></tr>
<tr><td><code>0xab_cd_ef</code></td><td>hex</td><td style="text-align: center"><code>INT</code></td><td style="text-align: center"><code>INT</code></td><td style="text-align: center"><code>INT</code></td></tr>
<tr><td><code>0b0101_1001</code></td><td>binary</td><td style="text-align: center"><code>INT</code></td><td style="text-align: center"><code>INT</code></td><td style="text-align: center"><code>INT</code></td></tr>
<tr><td><code>123._456</code></td><td><em>improper separator</em></td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td><code>123_456.78_9</code></td><td>normal floating-point</td><td style="text-align: center"><code>FLOAT</code></td><td style="text-align: center"><em>syntax error</em></td><td style="text-align: center"><a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a></td></tr>
<tr><td><code>-42.</code></td><td>ending with decimal point</td><td style="text-align: center"><code>FLOAT</code></td><td style="text-align: center"><em>syntax error</em></td><td style="text-align: center"><a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a></td></tr>
<tr><td><code>123_456_.789e-10</code></td><td>scientific notation</td><td style="text-align: center"><code>FLOAT</code></td><td style="text-align: center"><em>syntax error</em></td><td style="text-align: center"><a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a></td></tr>
<tr><td><code>.456</code></td><td><em>missing leading <code>0</code></em></td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td><code>123.456e_10</code></td><td><em>improper separator</em></td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td><code>123.e-10</code></td><td><em>missing decimal <code>0</code></em></td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
</tbody></table>
</div>
<h2 id="warning--no-implicit-type-conversions"><a class="header" href="#warning--no-implicit-type-conversions">Warning – No Implicit Type Conversions</a></h2>
<p>Unlike most C-like languages, Rhai does <em>not</em> provide implicit type conversions between different
numeric types.</p>
<p>For example, a <code>u8</code> is never implicitly converted to <code>i64</code> when used as a parameter in a function
call or as a comparison operand.  <code>f32</code> is never implicitly converted to <code>f64</code>.</p>
<p>This is exactly the same as Rust where all numeric types are distinct.  Rhai is written in Rust afterall.</p>
<div id="admonition-warning" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="language/numbers.html#admonition-warning"></a>
</div>
<div>
<p>Integer variables pushed inside a custom <a href="language//book/engine/scope.html"><code>Scope</code></a> must be the correct type.</p>
<p>It is extremely easy to mess up numeric types since the Rust default integer type is <code>i32</code> while for
Rhai it is <code>i64</code> (unless under <a href="language//book/start/features.html"><code>only_i32</code></a>).</p>
</div>
</div>
<pre><code class="language-rust">use rhai::{Engine, Scope, INT};

let engine = Engine::new();

let mut scope = Scope::new();

scope.push("r", 42);            // 'r' is i32 (Rust default integer type)
scope.push("x", 42_u8);         // 'x' is u8
scope.push("y", 42_i64);        // 'y' is i64
scope.push("z", 42 as INT);     // 'z' is i64 (or i32 under 'only_i32')
scope.push("f", 42.0_f32);      // 'f' is f32

// Rhai integers are i64 (i32 under 'only_i32')
engine.eval::&lt;String&gt;("type_of(42)")? == "i64";

// false - i32 is never equal to i64
engine.eval_with_scope::&lt;bool&gt;(&amp;mut scope, "r == 42")?;

// false - u8 is never equal to i64
engine.eval_with_scope::&lt;bool&gt;(&amp;mut scope, "x == 42")?;

// true - i64 is equal to i64
engine.eval_with_scope::&lt;bool&gt;(&amp;mut scope, "y == 42")?;

// true - INT is i64
engine.eval_with_scope::&lt;bool&gt;(&amp;mut scope, "z == 42")?;

// false - f32 is never equal to f64
engine.eval_with_scope::&lt;bool&gt;(&amp;mut scope, "f == 42.0")?;</code></pre>
<h2 id="floating-point-vs-decimal"><a class="header" href="#floating-point-vs-decimal">Floating-Point vs. Decimal</a></h2>
<div id="admonition-tip-no_float--decimal" class="admonition admonish-tip side wide" role="note" aria-labelledby="admonition-tip-no_float--decimal-title">
<div class="admonition-title">
<div id="admonition-tip-no_float--decimal-title">
<p>Tip: <code>no_float</code> + <code>decimal</code></p>
</div>
<a class="admonition-anchor-link" href="language/numbers.html#admonition-tip-no_float--decimal"></a>
</div>
<div>
<p>When both <a href="language//book/start/features.html"><code>no_float</code></a> and <a href="language//book/start/features.html"><code>decimal</code></a> features are turned on, <a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a> <em>replaces</em>
the standard floating-point type.</p>
<p>Floating-point number literals in scripts parse to <a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a> values.</p>
</div>
</div>
<p><a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a> (enabled via the <a href="language//book/start/features.html"><code>decimal</code></a> feature) represents a fixed-precision
floating-point number which is popular with financial calculations and other usage scenarios where
round-off errors are not acceptable.</p>
<p><a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a> takes up more space (16 bytes) than a standard <code>FLOAT</code> (4-8 bytes) and is
much slower in calculations due to the lack of CPU hardware support. Use it only when necessary.</p>
<p>For most situations, the standard floating-point number type <code>FLOAT</code> (<code>f64</code> or <code>f32</code> with
<a href="language//book/start/features.html"><code>f32_float</code></a>) is enough and is faster than <a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a>.</p>
<p>It is possible to use both <code>FLOAT</code> and <a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a> together with just the <a href="language//book/start/features.html"><code>decimal</code></a> feature
– use <a href="language//book/language/convert.html"><code>parse_decimal</code></a> or <a href="language//book/language/convert.html"><code>to_decimal</code></a> to create a <a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a> value.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="numeric-operators"><a class="header" href="#numeric-operators">Numeric Operators</a></h1>
<p>Numeric operators generally follow C styles.</p>
<h2 id="unary-operators"><a class="header" href="#unary-operators">Unary Operators</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Operator</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>+</code></td><td>positive</td></tr>
<tr><td style="text-align: center"><code>-</code></td><td>negative</td></tr>
</tbody></table>
</div>
<pre><code class="language-rust">let number = +42;

number = -5;

number = -5 - +5;

-(-42) == +42;      // two '-' equals '+'
                    // beware: '++' and '--' are reserved symbols</code></pre>
<h2 id="binary-operators"><a class="header" href="#binary-operators">Binary Operators</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Operator</th><th>Description</th><th style="text-align: center">Result type</th><th style="text-align: center"><code>INT</code></th><th style="text-align: center"><code>FLOAT</code></th><th style="text-align: center"><a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a></th></tr></thead><tbody>
<tr><td style="text-align: center"><code>+</code>, <code>+=</code></td><td>plus</td><td style="text-align: center">numeric</td><td style="text-align: center">yes</td><td style="text-align: center">yes, also with <code>INT</code></td><td style="text-align: center">yes, also with <code>INT</code></td></tr>
<tr><td style="text-align: center"><code>-</code>, <code>-=</code></td><td>minus</td><td style="text-align: center">numeric</td><td style="text-align: center">yes</td><td style="text-align: center">yes, also with <code>INT</code></td><td style="text-align: center">yes, also with <code>INT</code></td></tr>
<tr><td style="text-align: center"><code>*</code>, <code>*=</code></td><td>multiply</td><td style="text-align: center">numeric</td><td style="text-align: center">yes</td><td style="text-align: center">yes, also with <code>INT</code></td><td style="text-align: center">yes, also with <code>INT</code></td></tr>
<tr><td style="text-align: center"><code>/</code>, <code>/=</code></td><td>divide (integer division if acting on integer types)</td><td style="text-align: center">numeric</td><td style="text-align: center">yes</td><td style="text-align: center">yes, also with <code>INT</code></td><td style="text-align: center">yes, also with <code>INT</code></td></tr>
<tr><td style="text-align: center"><code>%</code>, <code>%=</code></td><td>modulo (remainder)</td><td style="text-align: center">numeric</td><td style="text-align: center">yes</td><td style="text-align: center">yes, also with <code>INT</code></td><td style="text-align: center">yes, also with <code>INT</code></td></tr>
<tr><td style="text-align: center"><code>**</code>, <code>**=</code></td><td>power/exponentiation</td><td style="text-align: center">numeric</td><td style="text-align: center">yes</td><td style="text-align: center">yes, also <code>FLOAT**INT</code></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>&lt;&lt;</code>, <code>&lt;&lt;=</code></td><td>left bit-shift (if negative number of bits, shift right instead)</td><td style="text-align: center">numeric</td><td style="text-align: center">yes</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>&gt;&gt;</code>, <code>&gt;&gt;=</code></td><td>right bit-shift (if negative number of bits, shift left instead)</td><td style="text-align: center">numeric</td><td style="text-align: center">yes</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>&amp;</code>, <code>&amp;=</code></td><td>bit-wise <em>And</em></td><td style="text-align: center">numeric</td><td style="text-align: center">yes</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>|</code>, <code>|=</code></td><td>bit-wise <em>Or</em></td><td style="text-align: center">numeric</td><td style="text-align: center">yes</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>^</code>, <code>^=</code></td><td>bit-wise <em>Xor</em></td><td style="text-align: center">numeric</td><td style="text-align: center">yes</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>==</code></td><td>equals to</td><td style="text-align: center"><code>bool</code></td><td style="text-align: center">yes</td><td style="text-align: center">yes, also with <code>INT</code></td><td style="text-align: center">yes, also with <code>INT</code></td></tr>
<tr><td style="text-align: center"><code>!=</code></td><td>not equals to</td><td style="text-align: center"><code>bool</code></td><td style="text-align: center">yes</td><td style="text-align: center">yes, also with <code>INT</code></td><td style="text-align: center">yes, also with <code>INT</code></td></tr>
<tr><td style="text-align: center"><code>&gt;</code></td><td>greater than</td><td style="text-align: center"><code>bool</code></td><td style="text-align: center">yes</td><td style="text-align: center">yes, also with <code>INT</code></td><td style="text-align: center">yes, also with <code>INT</code></td></tr>
<tr><td style="text-align: center"><code>&gt;=</code></td><td>greater than or equals to</td><td style="text-align: center"><code>bool</code></td><td style="text-align: center">yes</td><td style="text-align: center">yes, also with <code>INT</code></td><td style="text-align: center">yes, also with <code>INT</code></td></tr>
<tr><td style="text-align: center"><code>&lt;</code></td><td>less than</td><td style="text-align: center"><code>bool</code></td><td style="text-align: center">yes</td><td style="text-align: center">yes, also with <code>INT</code></td><td style="text-align: center">yes, also with <code>INT</code></td></tr>
<tr><td style="text-align: center"><code>&lt;=</code></td><td>less than or equals to</td><td style="text-align: center"><code>bool</code></td><td style="text-align: center">yes</td><td style="text-align: center">yes, also with <code>INT</code></td><td style="text-align: center">yes, also with <code>INT</code></td></tr>
<tr><td style="text-align: center"><code>..</code></td><td>exclusive range</td><td style="text-align: center"><a href="language//book/language/ranges.html">range</a></td><td style="text-align: center">yes</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>..=</code></td><td>inclusive range</td><td style="text-align: center"><a href="language//book/language/ranges.html">range</a></td><td style="text-align: center">yes</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td></tr>
</tbody></table>
</div>
<h2 id="examples-6"><a class="header" href="#examples-6">Examples</a></h2>
<pre><code class="language-rust">let x = (1 + 2) * (6 - 4) / 2;  // arithmetic, with parentheses

let reminder = 42 % 10;         // modulo

let power = 42 ** 2;            // power

let left_shifted = 42 &lt;&lt; 3;     // left shift

let right_shifted = 42 &gt;&gt; 3;    // right shift

let bit_op = 42 | 99;           // bit masking</code></pre>
<h2 id="floating-point-interoperates-with-integers"><a class="header" href="#floating-point-interoperates-with-integers">Floating-Point Interoperates with Integers</a></h2>
<p>When one of the operands to a binary arithmetic <a href="language//book/appendix/operators.html#operators">operator</a> is floating-point, it works with <code>INT</code> for
the other operand and the result is floating-point.</p>
<pre><code class="language-rust">let x = 41.0 + 1;               // 'FLOAT' + 'INT'

type_of(x) == "f64";            // result is 'FLOAT'

let x = 21 * 2.0;               // 'FLOAT' * 'INT'

type_of(x) == "f64";

(x == 42) == true;              // 'FLOAT' == 'INT'

(10 &lt; x) == true;               // 'INT' &lt; 'FLOAT'</code></pre>
<h2 id="decimal-interoperates-with-integers"><a class="header" href="#decimal-interoperates-with-integers">Decimal Interoperates with Integers</a></h2>
<p>When one of the operands to a binary arithmetic <a href="language//book/appendix/operators.html#operators">operator</a> is <a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a>,
it works with <code>INT</code> for the other operand and the result is <a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a>.</p>
<pre><code class="language-rust">let d = parse_decimal("2");

let x = d + 1;                  // 'Decimal' + 'INT'

type_of(x) == "decimal";        // result is 'Decimal'

let x = 21 * d;                 // 'Decimal' * 'INT'

type_of(x) == "decimal";

(x == 42) == true;              // 'Decimal' == 'INT'

(10 &lt; x) == true;               // 'INT' &lt; 'Decimal'</code></pre>
<h2 id="unary-before-binary"><a class="header" href="#unary-before-binary">Unary Before Binary</a></h2>
<p>In Rhai, unary operators take <a href="language//book/engine/precedence.html">precedence</a> over binary operators.  This is especially important to
remember when handling operators such as <code>**</code> which in some languages bind tighter than the unary
<code>-</code> operator.</p>
<pre><code class="language-rust">-2 + 2 == 0;

-2 - 2 == -4;

-2 * 2 == -4;

-2 / 2 == -1;

-2 % 2 == 0;

-2 ** 2 = 4;            // means: (-2) ** 2
                        // in some languages this means: -(2 ** 2)</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="floating-point-comparison"><a class="header" href="#floating-point-comparison">Floating-point Comparison</a></h1>
<h2 id="01--02--03"><a class="header" href="#01--02--03">0.1 + 0.2 ≠ 0.3</a></h2>
<div id="admonition-see-also" class="admonition admonish-info side wide" role="note" aria-labelledby="admonition-see-also-title">
<div class="admonition-title">
<div id="admonition-see-also-title">
<p>See Also</p>
</div>
<a class="admonition-anchor-link" href="language/float-comp.html#admonition-see-also"></a>
</div>
<div>
<p>See also <a href="https://randomascii.wordpress.com/2012/02/25/comparing-floating-point-numbers-2012-edition/"><em>this article</em></a>
for a detailed discussion on comparing floating-point numbers.</p>
</div>
</div>
<p>Comparing floating-point numbers are tricky because they often fail miserably and unexpectedly.</p>
<p>Take the infamous <code>0.1 + 0.2 ≠ 0.3</code> example from most languages:</p>
<pre><code class="language-js">// JavaScript example

let x = 0.3;            // 0.3
let y = 0.1 + 0.2;      // 0.3?

console.log(x == y);    // false!

console.log(x);         // 0.3
console.log(y);         // 0.30000000000000004
</code></pre>
<h2 id="epsilon-based-implementation"><a class="header" href="#epsilon-based-implementation">Epsilon-Based Implementation</a></h2>
<div id="admonition-warning" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="language/float-comp.html#admonition-warning"></a>
</div>
<div>
<p>If the <a href="language//book/start/features.html"><code>unchecked</code></a> feature is enabled, then all floating-point comparisons are done as per IEEE 754 standard.</p>
</div>
</div>
<p>The IEEE 754 standard for floating-point arithmetic provides an
<a href="https://en.wikipedia.org/wiki/Machine_epsilon"><em>epsilon</em></a> value that can be used to compare floating-point numbers.</p>
<p>With <code>max_diff = max(|x|, |y|) × epsilon</code>, Rhai compares floating-point numbers based on the following:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">operator</th><th style="text-align: center">operands</th><th>algorithm</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>x == y</code></td><td style="text-align: center">has zero</td><td><code>|x - y|</code> &lt; <em>epsilon</em></td></tr>
<tr><td style="text-align: center"><code>x == y</code></td><td style="text-align: center">both non-zero</td><td><code>|x - y|</code> &lt;</td></tr>
<tr><td style="text-align: center"><code>x != y</code></td><td style="text-align: center">has zero</td><td><code>|x - y|</code> ≥ <em>epsilon</em></td></tr>
<tr><td style="text-align: center"><code>x != y</code></td><td style="text-align: center">both non-zero</td><td><code>|x - y|</code> ≥ <code>max_diff</code></td></tr>
<tr><td style="text-align: center"><code>x &gt; y</code></td><td style="text-align: center">has zero</td><td><code>x - y</code> ≥ <em>epsilon</em></td></tr>
<tr><td style="text-align: center"><code>x &gt; y</code></td><td style="text-align: center">both non-zero</td><td><code>x - y</code> ≥ <code>max_diff</code></td></tr>
<tr><td style="text-align: center"><code>x &gt;= y</code></td><td style="text-align: center">has zero</td><td><code>x - y</code> ≥ –<em>epsilon</em></td></tr>
<tr><td style="text-align: center"><code>x &gt;= y</code></td><td style="text-align: center">both non-zero</td><td><code>x - y</code> ≥ –<code>max_diff</code></td></tr>
<tr><td style="text-align: center"><code>x &lt; y</code></td><td style="text-align: center">has zero</td><td><code>y - x</code> ≥ <em>epsilon</em></td></tr>
<tr><td style="text-align: center"><code>x &lt; y</code></td><td style="text-align: center">both non-zero</td><td><code>y - x</code> ≥ <code>max_diff</code></td></tr>
<tr><td style="text-align: center"><code>x &lt;= y</code></td><td style="text-align: center">has zero</td><td><code>y - x</code> ≥ –<em>epsilon</em></td></tr>
<tr><td style="text-align: center"><code>x &lt;= y</code></td><td style="text-align: center">both non-zero</td><td><code>y - x</code> ≥ –<code>max_diff</code></td></tr>
</tbody></table>
</div>
<h2 id="casual-scripting-usage"><a class="header" href="#casual-scripting-usage">Casual Scripting Usage</a></h2>
<p>For most scripts that casually compare floating-point numbers, the default behavior is sufficient to
cover all bases:</p>
<pre><code class="language-rust">let x = 1e-16;          // 0.0000000000000001
x &gt; 0 == false;         // comparing with zero Just Works when value is very small
x == 0 == true;

let x = 1e-15;          // 0.000000000000001
x &gt; 0 == true;          // comparing with zero when value above epsilon
x == 0 == false;

let x = 1e-28;          // 0.0000000000000000000000000001
let y = 1e-29;          // 0.00000000000000000000000000001, 10x smaller than 'x'
x &gt; y == true;          // comparing very small numbers actually wide apart!

let x = 0.00000000000000000001;
let y = 0.000000000000000000010000000000000001;
x &lt; y == false;         // difference is small enough for 'x' == 'y'

let y = 0.00000000000000000001000000000000001;
x &lt; y = true;           // difference is not small enough for 'x' == 'y'</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="numeric-functions"><a class="header" href="#numeric-functions">Numeric Functions</a></h1>
<h2 id="integer-functions"><a class="header" href="#integer-functions">Integer Functions</a></h2>
<p>The following standard functions are defined.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th style="text-align: center">Not available under</th><th style="text-align: center">Package</th><th>Description</th></tr></thead><tbody>
<tr><td><code>is_odd</code> method and property</td><td style="text-align: center"></td><td style="text-align: center"><a href="language//book/rust/packages/builtin.html"><code>ArithmeticPackage</code></a></td><td>returns <code>true</code> if the value is an odd number, otherwise <code>false</code></td></tr>
<tr><td><code>is_even</code> method and property</td><td style="text-align: center"></td><td style="text-align: center"><a href="language//book/rust/packages/builtin.html"><code>ArithmeticPackage</code></a></td><td>returns <code>true</code> if the value is an even number, otherwise <code>false</code></td></tr>
<tr><td><code>min</code></td><td style="text-align: center"></td><td style="text-align: center"><a href="language//book/rust/packages/builtin.html"><code>LogicPackage</code></a></td><td>returns the smaller of two numbers</td></tr>
<tr><td><code>max</code></td><td style="text-align: center"></td><td style="text-align: center"><a href="language//book/rust/packages/builtin.html"><code>LogicPackage</code></a></td><td>returns the larger of two numbers</td></tr>
<tr><td><code>to_float</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_float</code></a></td><td style="text-align: center"><a href="language//book/rust/packages/builtin.html"><code>BasicMathPackage</code></a></td><td>convert the value into <code>f64</code> (<code>f32</code> under <a href="language//book/start/features.html"><code>f32_float</code></a>)</td></tr>
<tr><td><code>to_decimal</code></td><td style="text-align: center">non-<a href="language//book/start/features.html"><code>decimal</code></a></td><td style="text-align: center"><a href="language//book/rust/packages/builtin.html"><code>BasicMathPackage</code></a></td><td>convert the value into <a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a></td></tr>
</tbody></table>
</div>
<h2 id="signed-numeric-functions"><a class="header" href="#signed-numeric-functions">Signed Numeric Functions</a></h2>
<p>The following standard functions are defined in the <a href="language//book/rust/packages/builtin.html"><code>ArithmeticPackage</code></a>
(excluded when using a <a href="language//book/engine/raw.html">raw <code>Engine</code></a>) and operate on <code>i8</code>, <code>i16</code>, <code>i32</code>, <code>i64</code>, <code>f32</code>, <code>f64</code> and
<a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a> (requires <a href="language//book/start/features.html"><code>decimal</code></a>) only.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Description</th></tr></thead><tbody>
<tr><td><code>abs</code></td><td>absolute value</td></tr>
<tr><td><code>sign</code></td><td>returns (<code>INT</code>) −1 if negative, +1 if positive, 0 if zero</td></tr>
<tr><td><code>is_zero</code> method and property</td><td>returns <code>true</code> if the value is zero, otherwise <code>false</code></td></tr>
</tbody></table>
</div>
<h2 id="floating-point-functions"><a class="header" href="#floating-point-functions">Floating-Point Functions</a></h2>
<p>The following standard functions are defined in the <a href="language//book/rust/packages/builtin.html"><code>BasicMathPackage</code></a>
(excluded when using a <a href="language//book/engine/raw.html">raw <code>Engine</code></a>) and operate on <code>f64</code> (<code>f32</code> under <a href="language//book/start/features.html"><code>f32_float</code></a>) and
<a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a> (requires <a href="language//book/start/features.html"><code>decimal</code></a>) only.</p>
<div class="table-wrapper"><table><thead><tr><th>Category</th><th style="text-align: center">Supports <code>Decimal</code></th><th>Functions</th></tr></thead><tbody>
<tr><td>Trigonometry</td><td style="text-align: center">yes</td><td><code>sin</code>, <code>cos</code>, <code>tan</code></td></tr>
<tr><td>Trigonometry</td><td style="text-align: center"><strong>no</strong></td><td><code>sinh</code>, <code>cosh</code>, <code>tanh</code> in radians, <code>hypot(</code><em>x</em><code>,</code><em>y</em><code>)</code></td></tr>
<tr><td>Arc-trigonometry</td><td style="text-align: center"><strong>no</strong></td><td><code>asin</code>, <code>acos</code>, <code>atan(</code><em>v</em><code>)</code>, <code>atan(</code><em>x</em><code>,</code><em>y</em><code>)</code>, <code>asinh</code>, <code>acosh</code>, <code>atanh</code> in radians</td></tr>
<tr><td>Square root</td><td style="text-align: center">yes</td><td><code>sqrt</code></td></tr>
<tr><td>Exponential</td><td style="text-align: center">yes</td><td><code>exp</code> (base <em>e</em>)</td></tr>
<tr><td>Logarithmic</td><td style="text-align: center">yes</td><td><code>ln</code> (base <em>e</em>)</td></tr>
<tr><td>Logarithmic</td><td style="text-align: center">yes</td><td><code>log</code> (base 10)</td></tr>
<tr><td>Logarithmic</td><td style="text-align: center"><strong>no</strong></td><td><code>log(</code><em>x</em><code>,</code><em>base</em><code>)</code></td></tr>
<tr><td>Rounding</td><td style="text-align: center">yes</td><td><code>floor</code>, <code>ceiling</code>, <code>round</code>, <code>int</code>, <code>fraction</code> methods and properties</td></tr>
<tr><td>Conversion</td><td style="text-align: center">yes</td><td><a href="language//book/language/convert.html"><code>to_int</code></a>, <a href="language//book/language/convert.html"><code>to_decimal</code></a> (requires <a href="language//book/start/features.html"><code>decimal</code></a>), <a href="language//book/language/convert.html"><code>to_float</code></a> (not under <a href="language//book/start/features.html"><code>no_float</code></a>)</td></tr>
<tr><td>Conversion</td><td style="text-align: center"><strong>no</strong></td><td><code>to_degrees</code>, <code>to_radians</code></td></tr>
<tr><td>Comparison</td><td style="text-align: center">yes</td><td><code>min</code>, <code>max</code> (also inter-operates with integers)</td></tr>
<tr><td>Testing</td><td style="text-align: center"><strong>no</strong></td><td><code>is_nan</code>, <code>is_finite</code>, <code>is_infinite</code> methods and properties</td></tr>
</tbody></table>
</div>
<h2 id="decimal-rounding-functions"><a class="header" href="#decimal-rounding-functions">Decimal Rounding Functions</a></h2>
<p>The following rounding methods are defined in the <a href="language//book/rust/packages/builtin.html"><code>BasicMathPackage</code></a>
(excluded when using a <a href="language//book/engine/raw.html">raw <code>Engine</code></a>) and operate on <a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a> only,
which requires the <a href="language//book/start/features.html"><code>decimal</code></a> feature.</p>
<div class="table-wrapper"><table><thead><tr><th>Rounding type</th><th>Behavior</th><th>Methods</th></tr></thead><tbody>
<tr><td>None</td><td></td><td><code>floor</code>, <code>ceiling</code>, <code>int</code>, <code>fraction</code> methods and properties</td></tr>
<tr><td>Banker’s rounding</td><td>round to integer</td><td><code>round</code> method and property</td></tr>
<tr><td>Banker’s rounding</td><td>round to specified number of decimal points</td><td><code>round(</code><em>decimal points</em><code>)</code></td></tr>
<tr><td>Round up</td><td>away from zero</td><td><code>round_up(</code><em>decimal points</em><code>)</code></td></tr>
<tr><td>Round down</td><td>towards zero</td><td><code>round_down(</code><em>decimal points</em><code>)</code></td></tr>
<tr><td>Round half-up</td><td>mid-point away from zero</td><td><code>round_half_up(</code><em>decimal points</em><code>)</code></td></tr>
<tr><td>Round half-down</td><td>mid-point towards zero</td><td><code>round_half_down(</code><em>decimal points</em><code>)</code></td></tr>
</tbody></table>
</div>
<h2 id="parsing-functions"><a class="header" href="#parsing-functions">Parsing Functions</a></h2>
<p>The following standard functions are defined in the <a href="language//book/rust/packages/builtin.html"><code>BasicMathPackage</code></a>
(excluded when using a <a href="language//book/engine/raw.html">raw <code>Engine</code></a>) to parse numbers.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th style="text-align: center">No available under</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="language//book/language/convert.html"><code>parse_int</code></a></td><td style="text-align: center"></td><td>converts a <a href="language//book/language/strings-chars.html">string</a> to <code>INT</code> with an optional radix</td></tr>
<tr><td><a href="language//book/language/convert.html"><code>parse_float</code></a></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_float</code></a> and non-<a href="language//book/start/features.html"><code>decimal</code></a></td><td>converts a <a href="language//book/language/strings-chars.html">string</a> to <code>FLOAT</code> (<a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a> under <a href="language//book/start/features.html"><code>no_float</code></a> and <a href="language//book/start/features.html"><code>decimal</code></a>)</td></tr>
<tr><td><a href="language//book/language/convert.html"><code>parse_decimal</code></a></td><td style="text-align: center">non-<a href="language//book/start/features.html"><code>decimal</code></a></td><td>converts a <a href="language//book/language/strings-chars.html">string</a> to <a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a></td></tr>
</tbody></table>
</div>
<h2 id="formatting-functions"><a class="header" href="#formatting-functions">Formatting Functions</a></h2>
<p>The following standard functions are defined in the <a href="language//book/rust/packages/builtin.html"><code>BasicStringPackage</code></a>
(excluded when using a <a href="language//book/engine/raw.html">raw <code>Engine</code></a>) to convert integer numbers into a <a href="language//book/language/strings-chars.html">string</a> of hex, octal
or binary representations.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="language//book/language/convert.html"><code>to_binary</code></a></td><td>converts an integer number to binary</td></tr>
<tr><td><a href="language//book/language/convert.html"><code>to_octal</code></a></td><td>converts an integer number to octal</td></tr>
<tr><td><a href="language//book/language/convert.html"><code>to_hex</code></a></td><td>converts an integer number to hex</td></tr>
</tbody></table>
</div>
<p>These formatting functions are defined for all available integer numbers – i.e. <code>INT</code>, <code>u8</code>,
<code>i8</code>, <code>u16</code>, <code>i16</code>, <code>u32</code>, <code>i32</code>, <code>u64</code>, <code>i64</code>, <code>u128</code> and <code>i128</code> unless disabled by feature flags.</p>
<h2 id="floating-point-constants"><a class="header" href="#floating-point-constants">Floating-point Constants</a></h2>
<p>The following functions return standard mathematical constants.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Description</th></tr></thead><tbody>
<tr><td><code>PI</code></td><td>returns the value of π</td></tr>
<tr><td><code>E</code></td><td>returns the value of <em>e</em></td></tr>
</tbody></table>
</div>
<h2 id="numerical-functions-for-scientific-computing"><a class="header" href="#numerical-functions-for-scientific-computing">Numerical Functions for Scientific Computing</a></h2>
<p>Check out the <a href="language//book/lib/rhai-sci.html"><code>rhai-sci</code></a> crate for more numerical functions.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="value-conversions"><a class="header" href="#value-conversions">Value Conversions</a></h1>
<h2 id="convert-between-integer-and-floating-point"><a class="header" href="#convert-between-integer-and-floating-point">Convert Between Integer and Floating-Point</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th style="text-align: center">Not available under</th><th style="text-align: center">From type</th><th style="text-align: center">To type</th></tr></thead><tbody>
<tr><td><code>to_int</code></td><td style="text-align: center"></td><td style="text-align: center"><code>INT</code>, <code>FLOAT</code>, <a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a></td><td style="text-align: center"><code>INT</code></td></tr>
<tr><td><code>to_float</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_float</code></a></td><td style="text-align: center"><code>INT</code>, <code>FLOAT</code>, <a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a></td><td style="text-align: center"><code>FLOAT</code></td></tr>
<tr><td><code>to_decimal</code></td><td style="text-align: center">non-<a href="language//book/start/features.html"><code>decimal</code></a></td><td style="text-align: center"><code>INT</code>, <code>FLOAT</code>, <a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a></td><td style="text-align: center"><a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a></td></tr>
</tbody></table>
</div>
<p>That’s it; for other conversions, register custom conversion functions.</p>
<pre><code class="language-js">let x = 42;                     // 'x' is an integer

let y = x * 100.0;              // integer and floating-point can inter-operate

let y = x.to_float() * 100.0;   // convert integer to floating-point with 'to_float'

let z = y.to_int() + x;         // convert floating-point to integer with 'to_int'

let d = y.to_decimal();         // convert floating-point to Decimal with 'to_decimal'

let w = z.to_decimal() + x;     // Decimal and integer can inter-operate

let c = 'X';                    // character

print(`c is '${c}' and its code is ${c.to_int()}`); // prints "c is 'X' and its code is 88"
</code></pre>
<h2 id="parse-string-into-number"><a class="header" href="#parse-string-into-number">Parse String into Number</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th style="text-align: center">From type</th><th style="text-align: center">To type</th></tr></thead><tbody>
<tr><td><code>parse_int</code></td><td style="text-align: center"><a href="language//book/language/strings-chars.html">string</a></td><td style="text-align: center"><code>INT</code></td></tr>
<tr><td><code>parse_int</code> with radix 2-36</td><td style="text-align: center"><a href="language//book/language/strings-chars.html">string</a></td><td style="text-align: center"><code>INT</code> (specified radix)</td></tr>
<tr><td><code>parse_float</code> (not <a href="language//book/start/features.html"><code>no_float</code></a>)</td><td style="text-align: center"><a href="language//book/language/strings-chars.html">string</a></td><td style="text-align: center"><code>FLOAT</code></td></tr>
<tr><td><code>parse_float</code> (<a href="language//book/start/features.html"><code>no_float</code></a>+<a href="language//book/start/features.html"><code>decimal</code></a>)</td><td style="text-align: center"><a href="language//book/language/strings-chars.html">string</a></td><td style="text-align: center"><a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a></td></tr>
<tr><td><code>parse_decimal</code> (requires <a href="language//book/start/features.html"><code>decimal</code></a>)</td><td style="text-align: center"><a href="language//book/language/strings-chars.html">string</a></td><td style="text-align: center"><a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a></td></tr>
</tbody></table>
</div>
<pre><code class="language-rust">let x = parse_float("123.4");   // parse as floating-point
x == 123.4;
type_of(x) == "f64";

let x = parse_decimal("123.4"); // parse as Decimal value
type_of(x) == "decimal";

let x = 1234.to_decimal() / 10; // alternate method to create a Decimal value
type_of(x) == "decimal";

let dec = parse_int("42");      // parse as integer
dec == 42;
type_of(dec) == "i64";

let dec = parse_int("42", 10);  // radix = 10 is the default
dec == 42;
type_of(dec) == "i64";

let bin = parse_int("110", 2);  // parse as binary (radix = 2)
bin == 0b110;
type_of(bin) == "i64";

let hex = parse_int("ab", 16);  // parse as hex (radix = 16)
hex == 0xab;
type_of(hex) == "i64";</code></pre>
<h2 id="format-numbers"><a class="header" href="#format-numbers">Format Numbers</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th style="text-align: center">From type</th><th style="text-align: center">To type</th><th style="text-align: center">Format</th></tr></thead><tbody>
<tr><td><code>to_binary</code></td><td style="text-align: center"><code>INT</code></td><td style="text-align: center"><a href="language//book/language/strings-chars.html">string</a></td><td style="text-align: center">binary (i.e. only <code>1</code> and <code>0</code>)</td></tr>
<tr><td><code>to_octal</code></td><td style="text-align: center"><code>INT</code></td><td style="text-align: center"><a href="language//book/language/strings-chars.html">string</a></td><td style="text-align: center">octal (i.e. <code>0</code> … <code>7</code>)</td></tr>
<tr><td><code>to_hex</code></td><td style="text-align: center"><code>INT</code></td><td style="text-align: center"><a href="language//book/language/strings-chars.html">string</a></td><td style="text-align: center">hex (i.e. <code>0</code> … <code>f</code>)</td></tr>
</tbody></table>
</div>
<pre><code class="language-rust">let x = 0x1234abcd;

x == 305441741;

x.to_string() == "305441741";

x.to_binary() == "10010001101001010101111001101";

x.to_octal() == "2215125715";

x.to_hex() == "1234abcd";</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ranges"><a class="header" href="#ranges">Ranges</a></h1>
<h2 id="syntax"><a class="header" href="#syntax">Syntax</a></h2>
<p>Numeric ranges can be constructed by the <code>..</code> (exclusive) or <code>..=</code> (inclusive) operators.</p>
<h3 id="exclusive-range"><a class="header" href="#exclusive-range">Exclusive range</a></h3>
<blockquote>
<p><em>start</em> <code>..</code> <em>end</em></p>
</blockquote>
<p>An <em>exclusive</em> range does not include the last (i.e. “end”) value.</p>
<p>The Rust type of an exclusive range is <code>std::ops::Range&lt;INT&gt;</code>.</p>
<p><a href="language//book/language/type-of.html"><code>type_of()</code></a> an exclusive range returns <code>"range"</code>.</p>
<h3 id="inclusive-range"><a class="header" href="#inclusive-range">Inclusive range</a></h3>
<blockquote>
<p><em>start</em> <code>..=</code> <em>end</em></p>
</blockquote>
<p>An <em>inclusive</em> range includes the last (i.e. “end”) value.</p>
<p>The Rust type of an inclusive range is <code>std::ops::RangeInclusive&lt;INT&gt;</code>.</p>
<p><a href="language//book/language/type-of.html"><code>type_of()</code></a> an inclusive range returns <code>"range="</code>.</p>
<h2 id="usage-scenarios"><a class="header" href="#usage-scenarios">Usage Scenarios</a></h2>
<p>Ranges are commonly used in the following scenarios.</p>
<div class="table-wrapper"><table><thead><tr><th>Scenario</th><th>Example</th></tr></thead><tbody>
<tr><td><a href="language//book/language/for.html"><code>for</code></a> statements</td><td><code>for n in 0..100 { ... }</code></td></tr>
<tr><td><a href="language//book/language/in.html"><code>in</code></a> expressions</td><td><code>if n in 0..100 { ... }</code></td></tr>
<tr><td><a href="language//book/language/switch.html"><code>switch</code></a> expressions</td><td><code>switch n { 0..100 =&gt; ... }</code></td></tr>
<tr><td><a href="language//book/language/bit-fields.html">Bit-fields</a> access</td><td><code>let x = n[2..6];</code></td></tr>
<tr><td>Bits iteration</td><td><code>for bit in n.bits(2..=9) { ... }</code></td></tr>
<tr><td><a href="language//book/language/arrays.html">Array</a> range-based APIs</td><td><code>array.extract(2..8)</code></td></tr>
<tr><td><a href="language//book/language/blobs.html">BLOB</a> range-based APIs</td><td><code>blob.parse_le_int(4..8)</code></td></tr>
<tr><td><a href="language//book/language/strings-chars.html">String</a> range-based APIs</td><td><code>string.sub_string(4..=12)</code></td></tr>
<tr><td><a href="language//book/language/strings-chars.html">Characters</a> iteration</td><td><code>for ch in string.bits(4..=12) { ... }</code></td></tr>
<tr><td><a href="language//book/rust/custom-types.html">Custom types</a></td><td><code>my_obj.action(3..=15, "foo");</code></td></tr>
</tbody></table>
</div>
<h2 id="use-as-parameter-type"><a class="header" href="#use-as-parameter-type">Use as Parameter Type</a></h2>
<p>Native Rust functions that take parameters of type <code>std::ops::Range&lt;INT&gt;</code> or
<code>std::ops::RangeInclusive&lt;INT&gt;</code>, when registered into an <a href="language//book/engine/hello-world.html"><code>Engine</code></a>, accept ranges as arguments.</p>
<div id="admonition-different-types" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-different-types-title">
<div class="admonition-title">
<div id="admonition-different-types-title">
<p>Different types</p>
</div>
<a class="admonition-anchor-link" href="language/ranges.html#admonition-different-types"></a>
</div>
<div>
<p><code>..</code> (exclusive range) and <code>..=</code> (inclusive range) are <em>different</em> types to Rhai
and they do not interoperate.</p>
<p>Two different versions of the same API must be registered to handle both range styles.</p>
</div>
</div>
<pre><code class="language-rust">use std::ops::{Range, RangeInclusive};

/// The actual work function
fn do_work(obj: &amp;mut TestStruct, from: i64, to: i64, inclusive: bool) {
    ...
}

let mut engine = Engine::new();

engine
    /// Version of API that accepts an exclusive range
    .register_fn("do_work", |obj: &amp;mut TestStruct, range: Range&lt;i64&gt;|
        do_work(obj, range.start, range.end, false)
    )
    /// Version of API that accepts an inclusive range
    .register_fn("do_work", |obj: &amp;mut TestStruct, range: RangeInclusive&lt;i64&gt;|
        do_work(obj, range.start(), range.end(), true)
    );

engine.run(
"
    let obj = new_ts();

    obj.do_work(0..12);         // use exclusive range

    obj.do_work(0..=11);        // use inclusive range
")?;</code></pre>
<h3 id="indexers-using-ranges"><a class="header" href="#indexers-using-ranges">Indexers Using Ranges</a></h3>
<p><a href="language//book/rust/indexers.html">Indexers</a> commonly use ranges as parameters.</p>
<pre><code class="language-rust">use std::ops::{Range, RangeInclusive};

let mut engine = Engine::new();

engine
    /// Version of indexer that accepts an exclusive range
    .register_indexer_get_set(
        |obj: &amp;mut TestStruct, range: Range&lt;i64&gt;| -&gt; bool { ... },
        |obj: &amp;mut TestStruct, range: Range&lt;i64&gt;, value: bool| { ... },
    )
    /// Version of indexer that accepts an inclusive range
    .register_indexer_get_set(
        |obj: &amp;mut TestStruct, range: RangeInclusive&lt;i64&gt;| -&gt; bool { ... },
        |obj: &amp;mut TestStruct, range: RangeInclusive&lt;i64&gt;, value: bool| { ... },
    );

engine.run(
"
    let obj = new_ts();

    let x = obj[0..12];         // use exclusive range

    obj[0..=11] = !x;           // use inclusive range
")?;</code></pre>
<h2 id="built-in-functions"><a class="header" href="#built-in-functions">Built-in Functions</a></h2>
<p>The following methods (mostly defined in the <a href="language//book/rust/packages/builtin.html"><code>BasicIteratorPackage</code></a> but
excluded when using a <a href="language//book/engine/raw.html">raw <code>Engine</code></a>) operate on ranges.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th style="text-align: center">Parameter(s)</th><th>Description</th></tr></thead><tbody>
<tr><td><code>start</code> method and property</td><td style="text-align: center"></td><td>beginning of the range</td></tr>
<tr><td><code>end</code> method and property</td><td style="text-align: center"></td><td>end of the range</td></tr>
<tr><td><code>contains</code>, <a href="language//book/language/in.html"><code>in</code></a> operator</td><td style="text-align: center">number to check</td><td>does this range contain the specified number?</td></tr>
<tr><td><code>is_empty</code> method and property</td><td style="text-align: center"></td><td>returns <code>true</code> if the range contains no items</td></tr>
<tr><td><code>is_inclusive</code> method and property</td><td style="text-align: center"></td><td>is the range inclusive?</td></tr>
<tr><td><code>is_exclusive</code> method and property</td><td style="text-align: center"></td><td>is the range exclusive?</td></tr>
</tbody></table>
</div>
<h2 id="tldr-3"><a class="header" href="#tldr-3">TL;DR</a></h2>
<div id="admonition-what-happened-to-the-_open-ended_-ranges" class="admonition admonish-question" role="note" aria-labelledby="admonition-what-happened-to-the-_open-ended_-ranges-title">
<div class="admonition-title">
<div id="admonition-what-happened-to-the-_open-ended_-ranges-title">
<p>What happened to the <em>open-ended</em> ranges?</p>
</div>
<a class="admonition-anchor-link" href="language/ranges.html#admonition-what-happened-to-the-_open-ended_-ranges"></a>
</div>
<div>
<p>Rust has <em>open-ended</em> ranges, such as <code>start..</code>, <code>..end</code> and <code>..=end</code>.  They are not available in Rhai.</p>
<p>They are not needed because Rhai can <a href="language//book/rust/overloading.html">overload</a> functions.</p>
<p>Typically, an API accepting ranges as parameters would have equivalent versions that accept a
starting position and a length (the standard <code>start + len</code> pair), as well as a versions that accept
only the starting position (the length assuming to the end).</p>
<p>In fact, usually all versions redirect to a call to one single version.</p>
<p>For example, a naive implementation of the <code>extract</code> method for <a href="language//book/language/arrays.html">arrays</a> (without any error handling)
would look like:</p>
<pre><code class="language-rust">use std::ops::{Range, RangeInclusive};

// Version with exclusive range
#[rhai_fn(name = "extract", pure)]
pub fn extract_range(array: &amp;mut Array, range: Range&lt;i64&gt;) -&gt; Array {
    array[range].to_vec()
}
// Version with inclusive range
#[rhai_fn(name = "extract", pure)]
pub fn extract_range2(array: &amp;mut Array, range: RangeInclusive&lt;i64&gt;) -&gt; Array {
    extract_range(array, range.start()..range.end() + 1)
}
// Version with start
#[rhai_fn(name = "extract", pure)]
pub fn extract_to_end(array: &amp;mut Array, start: i64) -&gt; Array {
    extract_range(array, start..start + array.len())
}
// Version with start+len
#[rhai_fn(name = "extract", pure)]
pub fn extract(array: &amp;mut Array, start: i64, len: i64) -&gt; Array {
    extract_range(array, start..start + len)
}</code></pre>
<p>Therefore, there should always be a function that can do what open-ended ranges are intended for.</p>
<p>The left-open form (i.e. <code>..end</code> and <code>..=end</code>) is trivially replaced by using zero as the starting
position with a length that corresponds to the end position (for <code>..end</code>).</p>
<p>The right-open form (i.e. <code>start..</code>) is trivially replaced by the version taking a single starting position.</p>
<pre><code class="language-rust">let x = [1, 2, 3, 4, 5];

x.extract(0..3);    // normal range argument
                    // copies 'x' from positions 0-2

x.extract(2);       // copies 'x' from position 2 onwards
                    // equivalent to '2..'

x.extract(0, 2);    // copies 'x' from beginning for 2 items
                    // equivalent to '..2'</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="integer-as-bit-fields"><a class="header" href="#integer-as-bit-fields">Integer as Bit-Fields</a></h1>
<div id="admonition-note" class="admonition admonish-note side" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="language/bit-fields.html#admonition-note"></a>
</div>
<div>
<p>Nothing here cannot be done via standard bit-manipulation (i.e. shifting and masking).</p>
<p>Built-in support is more elegant and performant since it usually replaces a sequence of multiple steps.</p>
</div>
</div>
<p>Since bit-wise operators are defined on integer numbers, individual bits can also be accessed and
manipulated via an indexing syntax.</p>
<p>If a bit is set (i.e. <code>1</code>), the index access returns <code>true</code>.</p>
<p>If a bit is not set (i.e. <code>0</code>), the index access returns <code>false</code>.</p>
<p>When a <a href="language//book/language/ranges.html">range</a> is used, the bits within the <a href="language//book/language/ranges.html">range</a> are shifted and extracted as an integer value.</p>
<p>Bit-fields are very commonly used in embedded systems which must squeeze data into limited memory.
Built-in support makes handling them efficient.</p>
<p>Indexing an integer as a bit-field is disabled for the <a href="language//book/start/features.html"><code>no_index</code></a> feature.</p>
<h2 id="syntax-1"><a class="header" href="#syntax-1">Syntax</a></h2>
<h3 id="from-least-significant-bit-lsb"><a class="header" href="#from-least-significant-bit-lsb">From Least-Significant Bit (LSB)</a></h3>
<p>Bits in a bit-field are accessed with zero-based, non-negative integer indices:</p>
<blockquote>
<p><em>integer</em> <code>[</code> <em>index from 0 to 63 or 31</em> <code>]</code></p>
<p><em>integer</em> <code>[</code> <em>index from 0 to 63 or 31</em> <code>] =</code> <code>true</code> or <code>false</code> ;</p>
</blockquote>
<p><a href="language//book/language/ranges.html">Ranges</a> can also be used:</p>
<blockquote>
<p><em>integer</em> <code>[</code> <em>start</em> <code>..</code> <em>end</em> <code>]</code><br />
<em>integer</em> <code>[</code> <em>start</em> <code>..=</code> <em>end</em> <code>]</code></p>
<p><em>integer</em> <code>[</code> <em>start</em> <code>..</code> <em>end</em> <code>] =</code> <em>new integer value</em> ;<br />
<em>integer</em> <code>[</code> <em>start</em> <code>..=</code> <em>end</em> <code>] =</code> <em>new integer value</em> ;</p>
</blockquote>
<div id="admonition-number-of-bits" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-number-of-bits-title">
<div class="admonition-title">
<div id="admonition-number-of-bits-title">
<p>Number of bits</p>
</div>
<a class="admonition-anchor-link" href="language/bit-fields.html#admonition-number-of-bits"></a>
</div>
<div>
<p>The maximum bit number that can be accessed is 63 (or 31 under <a href="language//book/start/features.html"><code>only_i32</code></a>).</p>
<p>Bits outside of the range are ignored.</p>
</div>
</div>
<h3 id="from-most-significant-bit-msb"><a class="header" href="#from-most-significant-bit-msb">From Most-Significant Bit (MSB)</a></h3>
<p>A <em>negative</em> index accesses a bit in the bit-field counting from the <em>end</em>, or from the
<em>most-significant bit</em>, with −1 being the <em>highest</em> bit.</p>
<blockquote>
<p><em>integer</em> <code>[</code> <em>index from −1 to −64 or −32</em> <code>]</code></p>
<p><em>integer</em> <code>[</code> <em>index from −1 to −64 or −32</em> <code>] =</code> <code>true</code> or <code>false</code> ;</p>
</blockquote>
<p><a href="language//book/language/ranges.html">Ranges</a> always count from the least-significant bit (LSB) and has no support for negative positions.</p>
<div id="admonition-number-of-bits-1" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-number-of-bits-1-title">
<div class="admonition-title">
<div id="admonition-number-of-bits-1-title">
<p>Number of bits</p>
</div>
<a class="admonition-anchor-link" href="language/bit-fields.html#admonition-number-of-bits-1"></a>
</div>
<div>
<p>The maximum bit number that can be accessed is −64 (or −32 under <a href="language//book/start/features.html"><code>only_i32</code></a>).</p>
</div>
</div>
<h2 id="bit-field-functions"><a class="header" href="#bit-field-functions">Bit-Field Functions</a></h2>
<p>The following standard functions (defined in the <a href="language//book/rust/packages/builtin.html"><code>BitFieldPackage</code></a> but excluded
when using a <a href="language//book/engine/raw.html">raw <code>Engine</code></a>) operate on <code>INT</code> bit-fields.</p>
<p>These functions are available even under the <a href="language//book/start/features.html"><code>no_index</code></a> feature.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Parameter(s)</th><th>Description</th></tr></thead><tbody>
<tr><td><code>get_bit</code></td><td>bit number, counting from MSB if &lt; 0</td><td>returns the state of a bit: <code>true</code> if <code>1</code>, <code>false</code> if <code>0</code></td></tr>
<tr><td><code>set_bit</code></td><td><ol><li>bit number, counting from MSB if &lt; 0</li><li>new state: <code>true</code> if <code>1</code>, <code>false</code> if <code>0</code></li></ol></td><td>sets the state of a bit</td></tr>
<tr><td><code>get_bits</code></td><td><ol><li>starting bit number, counting from MSB if &lt; 0</li><li>number of bits to extract, none if &lt; 1, to MSB if ≥ <em>length</em></li></ol></td><td>extracts a number of bits, shifted towards LSB</td></tr>
<tr><td><code>get_bits</code></td><td><a href="language//book/language/ranges.html">range</a> of bits</td><td>extracts a number of bits, shifted towards LSB</td></tr>
<tr><td><code>set_bits</code></td><td><ol><li>starting bit number, counting from MSB if &lt; 0</li><li>number of bits to set, none if &lt; 1, to MSB if ≥ <em>length</em><br/>3) new value</li></ol></td><td>sets a number of bits from the new value</td></tr>
<tr><td><code>set_bits</code></td><td><ol><li><a href="language//book/language/ranges.html">range</a> of bits</li><li>new value</li></ol></td><td>sets a number of bits from the new value</td></tr>
<tr><td><code>bits</code> method and property</td><td><ol><li><em>(optional)</em> starting bit number, counting from MSB if &lt; 0</li><li><em>(optional)</em> number of bits to extract, none if &lt; 1, to MSB if ≥ <em>length</em></li></ol></td><td>allows iteration over the bits of a bit-field</td></tr>
<tr><td><code>bits</code></td><td><a href="language//book/language/ranges.html">range</a> of bits</td><td>allows iteration over the bits of a bit-field</td></tr>
</tbody></table>
</div>
<h2 id="example-12"><a class="header" href="#example-12">Example</a></h2>
<pre><code class="language-js   no_run">// Assume the following bits fields in a single 16-bit word:
// ┌─────────┬────────────┬──────┬─────────┐
// │  15-12  │    11-4    │  3   │   2-0   │
// ├─────────┼────────────┼──────┼─────────┤
// │    0    │ 0-255 data │ flag │ command │
// └─────────┴────────────┴──────┴─────────┘

let value = read_start_hw_register(42);

let command = value.get_bits(0, 3);         // Command = bits 0-2

let flag = value[3];                        // Flag = bit 3

let data = value[4..=11];                   // Data = bits 4-11
let data = value.get_bits(4..=11);          // &lt;- above is the same as this

let reserved = value.get_bits(-4);          // Reserved = last 4 bits

if reserved != 0 {
    throw reserved;
}

switch command {
    0 =&gt; print(`Data = ${data}`),
    1 =&gt; value[4..=11] = data / 2,
    2 =&gt; value[3] = !flag,
    _ =&gt; print(`Unknown: ${command}`)
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="strings-and-characters"><a class="header" href="#strings-and-characters">Strings and Characters</a></h1>
<div id="admonition-safety" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-safety-title">
<div class="admonition-title">
<div id="admonition-safety-title">
<p>Safety</p>
</div>
<a class="admonition-anchor-link" href="language/strings-chars.html#admonition-safety"></a>
</div>
<div>
<p>Always limit the <a href="language//book/safety/max-string-size.html">maximum length of strings</a>.</p>
</div>
</div>
<p>String in Rhai contain any text sequence of valid Unicode characters.</p>
<p>Internally strings are stored in UTF-8 encoding.</p>
<p><a href="language//book/language/type-of.html"><code>type_of()</code></a> a string returns <code>"string"</code>.</p>
<h2 id="string-and-character-literals"><a class="header" href="#string-and-character-literals">String and Character Literals</a></h2>
<p>String and character literals follow JavaScript-style syntax.</p>
<div class="table-wrapper"><table><thead><tr><th>Type</th><th style="text-align: center">Quotes</th><th style="text-align: center">Escapes?</th><th style="text-align: center">Continuation?</th><th style="text-align: center">Interpolation?</th></tr></thead><tbody>
<tr><td>Normal string</td><td style="text-align: center"><code>"..."</code></td><td style="text-align: center">yes</td><td style="text-align: center">with <code>\</code></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td>Raw string</td><td style="text-align: center"><code>#..#"..."#..#</code></td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td>Multi-line literal string</td><td style="text-align: center"><code>`...`</code></td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center">with <code>${...}</code></td></tr>
<tr><td>Character</td><td style="text-align: center"><code>'...'</code></td><td style="text-align: center">yes</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td></tr>
</tbody></table>
</div><div id="admonition-tip-building-strings" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-building-strings-title">
<div class="admonition-title">
<div id="admonition-tip-building-strings-title">
<p>Tip: Building strings</p>
</div>
<a class="admonition-anchor-link" href="language/strings-chars.html#admonition-tip-building-strings"></a>
</div>
<div>
<p>Strings can be built up from other strings and types via the <code>+</code> operator
(provided by the <a href="language//book/rust/packages/builtin.html"><code>MoreStringPackage</code></a> but excluded when using a <a href="language//book/engine/raw.html">raw <code>Engine</code></a>).</p>
<p>This is particularly useful when printing output.</p>
</div>
</div>
<h2 id="standard-escape-sequences"><a class="header" href="#standard-escape-sequences">Standard Escape Sequences</a></h2>
<div id="admonition-tip-character-to_int" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-character-to_int-title">
<div class="admonition-title">
<div id="admonition-tip-character-to_int-title">
<p>Tip: Character <code>to_int()</code></p>
</div>
<a class="admonition-anchor-link" href="language/strings-chars.html#admonition-tip-character-to_int"></a>
</div>
<div>
<p>Use the <code>to_int</code> method to convert a Unicode character into its 32-bit Unicode encoding.</p>
</div>
</div>
<p>There is built-in support for Unicode (<code>\u</code><em>xxxx</em> or <code>\U</code><em>xxxxxxxx</em>) and hex (<code>\x</code><em>xx</em>) escape
sequences for normal strings and characters.</p>
<p>Hex sequences map to ASCII characters, while <code>\u</code> maps to 16-bit common Unicode code points and <code>\U</code>
maps the full, 32-bit extended Unicode code points.</p>
<p>Escape sequences are not supported for multi-line literal strings wrapped by back-ticks (<code>`</code>).</p>
<div class="table-wrapper"><table><thead><tr><th>Escape sequence</th><th>Meaning</th></tr></thead><tbody>
<tr><td><code>\\</code></td><td>back-slash (<code>\</code>)</td></tr>
<tr><td><code>\t</code></td><td>tab</td></tr>
<tr><td><code>\r</code></td><td>carriage-return (<code>CR</code>)</td></tr>
<tr><td><code>\n</code></td><td>line-feed (<code>LF</code>)</td></tr>
<tr><td><code>\"</code> or <code>""</code></td><td>double-quote (<code>"</code>)</td></tr>
<tr><td><code>\'</code></td><td>single-quote (<code>'</code>)</td></tr>
<tr><td><code>\x</code><em>xx</em></td><td>ASCII character in 2-digit hex</td></tr>
<tr><td><code>\u</code><em>xxxx</em></td><td>Unicode character in 4-digit hex</td></tr>
<tr><td><code>\U</code><em>xxxxxxxx</em></td><td>Unicode character in 8-digit hex</td></tr>
</tbody></table>
</div>
<h2 id="line-continuation"><a class="header" href="#line-continuation">Line Continuation</a></h2>
<p>For a normal string wrapped by double-quotes (<code>"</code>), a back-slash (<code>\</code>) character at the end of a
line indicates that the string continues onto the next line <em>without any line-break</em>.</p>
<p>Whitespace up to the indentation of the opening double-quote is ignored in order to enable lining up
blocks of text.</p>
<p>Spaces are <em>not</em> added, so to separate one line with the next with a space, put a space before the
ending back-slash (<code>\</code>) character.</p>
<pre><code class="language-rust">let x = "hello, world!\
         hello world again! \
         this is the ""last"" time!!!";
// ^^^^^^ these whitespaces are ignored

// The above is the same as:
let x = "hello, world!hello world again! this is the \"last\" time!!!";</code></pre>
<p>A string with continuation does not open up a new line.  To do so, a new-line character must be
manually inserted at the appropriate position.</p>
<pre><code class="language-rust">let x = "hello, world!\n\
         hello world again!\n\
         this is the last time!!!";

// The above is the same as:
let x = "hello, world!\nhello world again!\nthis is the last time!!!";</code></pre>
<div id="admonition-no-ending-quote-before-the-line-ends-is-a-syntax-error" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-no-ending-quote-before-the-line-ends-is-a-syntax-error-title">
<div class="admonition-title">
<div id="admonition-no-ending-quote-before-the-line-ends-is-a-syntax-error-title">
<p>No ending quote before the line ends is a syntax error</p>
</div>
<a class="admonition-anchor-link" href="language/strings-chars.html#admonition-no-ending-quote-before-the-line-ends-is-a-syntax-error"></a>
</div>
<div>
<p>If the ending double-quote is omitted, it is a syntax error.</p>
<pre><code class="language-rust">let x = "hello
<span class="boring">";
</span>//            ^ syntax error: unterminated string literal</code></pre>
</div>
</div>
<div id="admonition-why-not-go-multi-line" class="admonition admonish-question small" role="note" aria-labelledby="admonition-why-not-go-multi-line-title">
<div class="admonition-title">
<div id="admonition-why-not-go-multi-line-title">
<p>Why not go multi-line?</p>
</div>
<a class="admonition-anchor-link" href="language/strings-chars.html#admonition-why-not-go-multi-line"></a>
</div>
<div>
<p>Technically speaking, there is no difficulty in allowing strings to run for multiple lines
<em>without</em> the continuation back-slash.</p>
<p>Rhai forces you to manually mark a continuation with a back-slash because the ending quote is easy to omit.
Once it happens, the entire remainder of the script would become one giant, multi-line string.</p>
<p>This behavior is different from Rust, where string literals can run for multiple lines.</p>
</div>
</div>
<h2 id="raw-strings"><a class="header" href="#raw-strings">Raw Strings</a></h2>
<p>A <em>raw string</em> is any text enclosed by a pair of double-quotes (<code>"</code>), wrapped by hash (<code>#</code>) characters.</p>
<p>The number of hash (<code>#</code>) on each side must be the same.</p>
<p>Any text inside the double-quotes, as long as it is not a double-quote (<code>"</code>) followed by the same
number of hash (<code>#</code>) characters, is simply copied verbatim, <em>including control codes and/or
line-breaks</em>.</p>
<p>Raw strings are very useful for embedded regular expressions, file paths, and program code etc.</p>
<pre><code class="language-rust">let x = #"Hello, I am a raw string! which means that I can contain
             line-breaks, \ slashes (not escapes), "quotes" and even # characters!"#

// Use more than one '#' if you happen to have '"###...' inside the string...

let x = ###"In Rhai, you can write ##"hello"## as a raw string."###;
//                                         ^^^ this is not the end of the raw string</code></pre>
<h2 id="indexing"><a class="header" href="#indexing">Indexing</a></h2>
<p>Strings can be <em>indexed</em> into to get access to any individual character.
This is similar to many modern languages but different from Rust.</p>
<h3 id="from-beginning"><a class="header" href="#from-beginning">From beginning</a></h3>
<p>Individual characters within a string can be accessed with zero-based, non-negative integer indices:</p>
<blockquote>
<p><em>string</em> <code>[</code> <em>index from 0 to (total number of characters − 1)</em> <code>]</code></p>
</blockquote>
<h3 id="from-end"><a class="header" href="#from-end">From end</a></h3>
<p>A <em>negative</em> index accesses a character in the string counting from the <em>end</em>, with −1 being the
<em>last</em> character.</p>
<blockquote>
<p><em>string</em> <code>[</code> <em>index from −1 to −(total number of characters)</em> <code>]</code></p>
</blockquote>
<div id="admonition-character-indexing-can-be-sloooooooow" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-character-indexing-can-be-sloooooooow-title">
<div class="admonition-title">
<div id="admonition-character-indexing-can-be-sloooooooow-title">
<p>Character indexing can be SLOOOOOOOOW</p>
</div>
<a class="admonition-anchor-link" href="language/strings-chars.html#admonition-character-indexing-can-be-sloooooooow"></a>
</div>
<div>
<p>Internally, a Rhai string is still stored compactly as a Rust UTF-8 string in order to save memory.</p>
<p>Therefore, getting the character at a particular index involves walking through the entire UTF-8
encoded bytes stream to extract individual Unicode characters, counting them on the way.</p>
<p>Because of this, indexing can be a <em>slow</em> procedure, especially for long strings.
Along the same lines, getting the <em>length</em> of a string (which returns the number of characters, not
bytes) can also be slow.</p>
</div>
</div>
<h2 id="sub-strings"><a class="header" href="#sub-strings">Sub-Strings</a></h2>
<p>Sub-strings, or <em>slices</em> in some programming languages, are parts of strings.</p>
<p>In Rhai, a sub-string can be specified by indexing with a <a href="language//book/language/ranges.html">range</a> of characters:</p>
<blockquote>
<p><em>string</em> <code>[</code> <em>first character (starting from zero)</em> <code>..</code> <em>last character (exclusive)</em> <code>]</code></p>
<p><em>string</em> <code>[</code> <em>first character (starting from zero)</em> <code>..=</code> <em>last character (inclusive)</em> <code>]</code></p>
</blockquote>
<p>Sub-string <a href="language//book/language/ranges.html">ranges</a> always start from zero counting towards the end of the string.
Negative <a href="language//book/language/ranges.html">ranges</a> are not supported.</p>
<h2 id="examples-7"><a class="header" href="#examples-7">Examples</a></h2>
<pre><code class="language-js">let name = "Bob";
let middle_initial = 'C';
let last = "Davis";

let full_name = `${name} ${middle_initial}. ${last}`;
full_name == "Bob C. Davis";

// String building with different types
let age = 42;
let record = `${full_name}: age ${age}`;
record == "Bob C. Davis: age 42";

// Unlike Rust, Rhai strings can be indexed to get a character
// (disabled with 'no_index')
let c = record[4];
c == 'C';                               // single character

let slice = record[4..8];               // sub-string slice
slice == " C. D";

ts.s = record;                          // custom type properties can take strings

let c = ts.s[4];
c == 'C';

let c = ts.s[-4];                       // negative index counts from the end
c == 'e';

let c = "foo"[0];                       // indexing also works on string literals...
c == 'f';

let c = ("foo" + "bar")[5];             // ... and expressions returning strings
c == 'r';

let text = "hello, world!";
text[0] = 'H';                          // modify a single character
text == "Hello, world!";

text[7..=11] = "Earth";                 // modify a sub-string slice
text == "Hello, Earth!";

// Escape sequences in strings
record += " \u2764\n";                  // escape sequence of '❤' in Unicode
record == "Bob C. Davis: age 42 ❤\n";  // '\n' = new-line

// Unlike Rust, Rhai strings can be directly modified character-by-character
// (disabled with 'no_index')
record[4] = '\x58'; // 0x58 = 'X'
record == "Bob X. Davis: age 42 ❤\n";

// Use 'in' to test if a substring (or character) exists in a string
"Davis" in record == true;
'X' in record == true;
'C' in record == false;

// Strings can be iterated with a 'for' statement, yielding characters
for ch in record {
    print(ch);
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="multi-line-literal-strings"><a class="header" href="#multi-line-literal-strings">Multi-Line Literal Strings</a></h1>
<p>A <a href="language//book/language/strings-chars.html">string</a> wrapped by a pair of back-tick (<code>`</code>) characters is interpreted <em>literally</em>.</p>
<p>This means that every single character that lies between the two back-ticks is taken verbatim.</p>
<p>This include new-lines, whitespaces, escape characters etc.</p>
<pre><code class="language-js">let x = `hello, world! "\t\x42"
  hello world again! 'x'
     this is the last time!!! `;

// The above is the same as:
let x = "hello, world! \"\\t\\x42\"\n  hello world again! 'x'\n     this is the last time!!! ";
</code></pre>
<p>If a back-tick (<code>`</code>) appears at the <em>end</em> of a line, then it is understood that the entire text
block starts from the <em>next</em> line; the starting new-line character is stripped.</p>
<pre><code class="language-js">let x = `
        hello, world! "\t\x42"
  hello world again! 'x'
     this is the last time!!!
`;

// The above is the same as:
let x = "        hello, world! \"\\t\\x42\"\n  hello world again! 'x'\n     this is the last time!!!\n";
</code></pre>
<p>To actually put a back-tick (<code>`</code>) character inside a multi-line literal <a href="language//book/language/strings-chars.html">string</a>, use two
back-ticks together (i.e. <code>``</code>).</p>
<pre><code class="language-js">let x = `I have a quote " as well as a back-tick `` here.`;

// The above is the same as:
let x = "I have a quote \" as well as a back-tick ` here.";
</code></pre>
<h1 id="string-interpolation"><a class="header" href="#string-interpolation">String Interpolation</a></h1>
<div id="admonition-only-literal-strings" class="admonition admonish-warning side wide" role="note" aria-labelledby="admonition-only-literal-strings-title">
<div class="admonition-title">
<div id="admonition-only-literal-strings-title">
<p>Only literal strings</p>
</div>
<a class="admonition-anchor-link" href="language/string-interp.html#admonition-only-literal-strings"></a>
</div>
<div>
<p>Interpolation is not supported for normal <a href="language//book/language/strings-chars.html">string</a> or <a href="language//book/language/strings-chars.html">character</a> literals.</p>
</div>
</div>
<div id="admonition-what-if-i-want--inside" class="admonition admonish-question side wide" role="note" aria-labelledby="admonition-what-if-i-want--inside-title">
<div class="admonition-title">
<div id="admonition-what-if-i-want--inside-title">
<p>What if I want <code>${</code> inside?</p>
</div>
<a class="admonition-anchor-link" href="language/string-interp.html#admonition-what-if-i-want--inside"></a>
</div>
<div>
<p>🤦 Well, you just <em>have</em> to ask for the impossible, don’t you?</p>
<p>Currently there is no way to escape <code>${</code>.  Build the <a href="language//book/language/strings-chars.html">string</a> in three pieces:</p>
<pre><code class="language-js">`Interpolations start with "`
      + "${"
      + `" and end with }.`
</code></pre>
</div>
</div>
<p>Multi-line literal <a href="language//book/language/strings-chars.html">strings</a> support <em>string interpolation</em> wrapped in <code>${</code> … <code>}</code>.</p>
<p><code>${</code> … <code>}</code> acts as a statements <em>block</em> and can contain anything that is allowed within a
statements block, including another interpolated <a href="language//book/language/strings-chars.html">string</a>!
The last result of the block is taken as the value for interpolation.</p>
<p>Rhai uses <a href="language//book/rust/print-custom.html"><code>to_string</code></a> to convert any value into a <a href="language//book/language/strings-chars.html">string</a>, then physically joins all the
sub-strings together.</p>
<p>For convenience, if any interpolated value is a <a href="language//book/language/blobs.html">BLOB</a>, however, it is automatically treated as a
UTF-8 encoded string.  That is because it is rarely useful to interpolate a <a href="language//book/language/blobs.html">BLOB</a> into a <a href="language//book/language/strings-chars.html">string</a>,
but extremely useful to be able to directly manipulate UTF-8 encoded text.</p>
<pre><code class="language-js">let x = 42;
let y = 123;

let s = `x = ${x} and y = ${y}.`;                   // &lt;- interpolated string

let s = ("x = " + {x} + " and y = " + {y} + ".");   // &lt;- de-sugars to this

s == "x = 42 and y = 123.";

let s = `
Undeniable logic:
1) Hello, ${let w = `${x} world`; if x &gt; 1 { w += "s" } w}!
2) If ${y} &gt; ${x} then it is ${y &gt; x}!
`;

s == "Undeniable logic:\n1) Hello, 42 worlds!\n2) If 123 &gt; 42 then it is true!\n";

let blob = blob(3, 0x21);

print(blob);                            // prints [212121]

print(`Data: ${blob}`);                 // prints "Data: !!!"
                                        // BLOB is treated as UTF-8 encoded string

print(`Data: ${blob.to_string()}`);     // prints "Data: [212121]"
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-immutablestring-type"><a class="header" href="#the-immutablestring-type">The <code>ImmutableString</code> Type</a></h1>
<div id="admonition-why-smartstring" class="admonition admonish-question side" role="note" aria-labelledby="admonition-why-smartstring-title">
<div class="admonition-title">
<div id="admonition-why-smartstring-title">
<p>Why <code>SmartString</code>?</p>
</div>
<a class="admonition-anchor-link" href="rust/immutable-string.html#admonition-why-smartstring"></a>
</div>
<div>
<p><a href="https://crates.io/crates/smartstring"><code>SmartString</code></a> is used because many strings in scripts are short (fewer than 24 ASCII characters).</p>
</div>
</div>
<p>All <a href="rust//book/language/strings-chars.html">strings</a> in Rhai are implemented as <code>ImmutableString</code>, which is an alias to
<code>Rc&lt;SmartString&gt;</code> (or <code>Arc&lt;SmartString&gt;</code> under the <a href="rust//book/start/features.html"><code>sync</code></a> feature).</p>
<p>An <code>ImmutableString</code> is immutable (i.e. never changes) and therefore can be shared among many users.
Cloning an <code>ImmutableString</code> is cheap since it only copies an immutable reference.</p>
<p>Modifying an <code>ImmutableString</code> causes it first to be cloned, and then the modification made to the copy.
Therefore, direct string modifications are expensive.</p>
<h2 id="avoid-string-parameters"><a class="header" href="#avoid-string-parameters">Avoid <code>String</code> Parameters</a></h2>
<p><code>ImmutableString</code> should be used in place of <code>String</code> for function parameters because using <code>String</code>
is very inefficient (the argument is cloned during every function call).</p>
<p>A alternative is to use <code>&amp;str</code> which de-sugars to <code>ImmutableString</code>.</p>
<p>A function with the first parameter being <code>&amp;mut String</code> does not match a string argument passed to it,
which has type <code>ImmutableString</code>.  In fact, <code>&amp;mut String</code> is treated as an opaque <a href="rust//book/rust/custom-types.html">custom type</a>.</p>
<pre><code class="language-rust">fn slow(s: String) -&gt; i64 { ... }               // string is cloned each call

fn fast1(s: ImmutableString) -&gt; i64 { ... }     // cloning 'ImmutableString' is cheap

fn fast2(s: &amp;str) -&gt; i64 { ... }                // de-sugars to above

fn bad(s: &amp;mut String) { ... }                  // '&amp;mut String' will not match string values</code></pre>
<h2 id="differences-from-rust-strings"><a class="header" href="#differences-from-rust-strings">Differences from Rust Strings</a></h2>
<p>Internally Rhai strings are stored as UTF-8 just like Rust (they <em>are</em> Rust <code>String</code>s!),
but nevertheless there are major differences.</p>
<p>In Rhai a <a href="rust//book/language/strings-chars.html">string</a> is semantically the same as an array of Unicode characters and can be directly
indexed (unlike Rust).</p>
<p>This is similar to most other languages (e.g. JavaScript, C#) where strings are stored internally
not as UTF-8 but as arrays of UCS-16 or UCS-32.</p>
<p>Individual characters within a Rhai string can also be replaced just as if the string is an array of
Unicode characters.</p>
<p>In Rhai, there are also no separate concepts of <code>String</code> and <code>&amp;str</code> (a string slice) as in Rust.</p>
<div id="admonition-performance-considerations" class="admonition admonish-warning" role="note" aria-labelledby="admonition-performance-considerations-title">
<div class="admonition-title">
<div id="admonition-performance-considerations-title">
<p>Performance considerations</p>
</div>
<a class="admonition-anchor-link" href="rust/immutable-string.html#admonition-performance-considerations"></a>
</div>
<div>
<p>Although Rhai exposes a <a href="rust//book/language/strings-chars.html">string</a> as a simple array of <a href="rust//book/language/strings-chars.html">characters</a> which can be directly indexed to
get at a particular <a href="rust//book/language/strings-chars.html">character</a>, such convenient syntax is an <em>illusion</em>.</p>
<p>Internally the <a href="rust//book/language/strings-chars.html">string</a> is still stored in UTF-8 (native Rust <code>String</code>s).</p>
<p>All indexing operations actually require walking through the entire UTF-8 string to find the offset
of the particular <a href="rust//book/language/strings-chars.html">character</a> position, and therefore is <em>much</em> slower than the simple array
indexing for other scripting languages.</p>
<p>This implementation detail is hidden from the user but has a performance implication.</p>
<p>Avoid large scale <a href="rust//book/language/strings-chars.html">character</a>-based processing of <a href="rust//book/language/strings-chars.html">strings</a>; instead, build an actual <a href="rust//book/language/arrays.html">array</a> of
<a href="rust//book/language/strings-chars.html">characters</a> (via the <code>split()</code> method) which can then be manipulated efficiently.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="standard-string-functions"><a class="header" href="#standard-string-functions">Standard String Functions</a></h1>
<p>The following standard methods (mostly defined in the <a href="language//book/rust/packages/builtin.html"><code>MoreStringPackage</code></a> but
excluded when using a <a href="language//book/engine/raw.html">raw <code>Engine</code></a>) operate on <a href="language//book/language/strings-chars.html">strings</a> (and possibly characters).</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Parameter(s)</th><th>Description</th></tr></thead><tbody>
<tr><td><code>len</code> method and property</td><td><em>none</em></td><td>returns the number of characters (<strong>not</strong> number of bytes) in the string</td></tr>
<tr><td><code>bytes</code> method and property</td><td><em>none</em></td><td>returns the number of bytes making up the UTF-8 string; for strings containing only ASCII characters, this is much faster than <code>len</code></td></tr>
<tr><td><code>is_empty</code> method and property</td><td><em>none</em></td><td>returns <code>true</code> if the string is empty</td></tr>
<tr><td><code>to_blob</code><br/>(not available under <a href="language//book/start/features.html"><code>no_index</code></a>)</td><td><em>none</em></td><td>converts the string into an UTF-8 encoded byte-stream and returns it as a <a href="language//book/language/blobs.html">BLOB</a>.</td></tr>
<tr><td><code>to_chars</code><br/>(not available under <a href="language//book/start/features.html"><code>no_index</code></a>)</td><td><em>none</em></td><td>splits the string by individual characters, returning them as an <a href="language//book/language/arrays.html">array</a></td></tr>
<tr><td><code>get</code></td><td>position, counting from end if &lt; 0</td><td>gets the character at a certain position (<a href="language//book/language/values-and-types.html"><code>()</code></a> if the position is not valid)</td></tr>
<tr><td><code>set</code></td><td><ol><li>position, counting from end if &lt; 0</li><li>new character</li></ol></td><td>sets a certain position to a new character (no effect if the position is not valid)</td></tr>
<tr><td><code>pad</code></td><td><ol><li>target length</li><li>character/string to pad</li></ol></td><td>pads the string with a character or a string to at least a specified length</td></tr>
<tr><td><code>append</code>, <code>+=</code> operator</td><td>item to append</td><td>adds the display text of an item to the end of the string</td></tr>
<tr><td><code>remove</code></td><td>character/string to remove</td><td>removes a character or a string from the string</td></tr>
<tr><td><code>pop</code></td><td><em>(optional)</em> number of characters to remove, none if ≤ 0, entire string if ≥ length</td><td>removes the last character (if no parameter) and returns it (<a href="language//book/language/values-and-types.html"><code>()</code></a> if empty); otherwise, removes the last number of characters and returns them as a string</td></tr>
<tr><td><code>clear</code></td><td><em>none</em></td><td>empties the string</td></tr>
<tr><td><code>truncate</code></td><td>target length</td><td>cuts off the string at exactly a specified number of characters</td></tr>
<tr><td><code>to_upper</code></td><td><em>none</em></td><td>converts the string/character into upper-case as a new string/character and returns it</td></tr>
<tr><td><code>to_lower</code></td><td><em>none</em></td><td>converts the string/character into lower-case as a new string/character and returns it</td></tr>
<tr><td><code>make_upper</code></td><td><em>none</em></td><td>converts the string/character into upper-case</td></tr>
<tr><td><code>make_lower</code></td><td><em>none</em></td><td>converts the string/character into lower-case</td></tr>
<tr><td><code>trim</code></td><td><em>none</em></td><td>trims the string of whitespace at the beginning and end</td></tr>
<tr><td><code>contains</code></td><td>character/sub-string to search for</td><td>checks if a certain character or sub-string occurs in the string</td></tr>
<tr><td><code>starts_with</code></td><td>string</td><td>returns <code>true</code> if the string starts with a certain string</td></tr>
<tr><td><code>ends_with</code></td><td>string</td><td>returns <code>true</code> if the string ends with a certain string</td></tr>
<tr><td><code>min</code></td><td><ol><li>first character/string</li><li>second character/string</li><ol></td><td>returns the smaller of two characters/strings</td></tr>
<tr><td><code>max</code></td><td><ol><li>first character/string</li><li>second character/string</li><ol></td><td>returns the larger of two characters/strings</td></tr>
<tr><td><code>index_of</code></td><td><ol><li>character/sub-string to search for</li><li><em>(optional)</em> start position, counting from end if &lt; 0, end if ≥ length</li></ol></td><td>returns the position that a certain character or sub-string occurs in the string, or −1 if not found</td></tr>
<tr><td><code>sub_string</code></td><td><ol><li>start position, counting from end if &lt; 0</li><li><em>(optional)</em> number of characters to extract, none if ≤ 0, to end if omitted</li></ol></td><td>extracts a sub-string</td></tr>
<tr><td><code>sub_string</code></td><td><a href="language//book/language/ranges.html">range</a> of characters to extract, from beginning if ≤ 0, to end if ≥ length</td><td>extracts a sub-string</td></tr>
<tr><td><code>split</code><br/>(not available under <a href="language//book/start/features.html"><code>no_index</code></a>)</td><td><em>none</em></td><td>splits the string by whitespaces, returning an <a href="language//book/language/arrays.html">array</a> of string segments</td></tr>
<tr><td><code>split</code><br/>(not available under <a href="language//book/start/features.html"><code>no_index</code></a>)</td><td>position to split at (in number of characters), counting from end if &lt; 0, end if ≥ length</td><td>splits the string into two segments at the specified character position, returning an <a href="language//book/language/arrays.html">array</a> of two string segments</td></tr>
<tr><td><code>split</code><br/>(not available under <a href="language//book/start/features.html"><code>no_index</code></a>)</td><td><ol><li>delimiter character/string</li><li><em>(optional)</em> maximum number of segments, 1 if &lt; 1</li></ol></td><td>splits the string by the specified delimiter, returning an <a href="language//book/language/arrays.html">array</a> of string segments</td></tr>
<tr><td><code>split_rev</code><br/>(not available under <a href="language//book/start/features.html"><code>no_index</code></a>)</td><td><ol><li>delimiter character/string</li><li><em>(optional)</em> maximum number of segments, 1 if &lt; 1</li></ol></td><td>splits the string by the specified delimiter in reverse order, returning an <a href="language//book/language/arrays.html">array</a> of string segments</td></tr>
<tr><td><code>crop</code></td><td><ol><li>start position, counting from end if &lt; 0</li><li><em>(optional)</em> number of characters to retain, none if ≤ 0, to end if omitted</li></ol></td><td>retains only a portion of the string</td></tr>
<tr><td><code>crop</code></td><td><a href="language//book/language/ranges.html">range</a> of characters to retain, from beginning if ≤ 0, to end if ≥ length</td><td>retains only a portion of the string</td></tr>
<tr><td><code>replace</code></td><td><ol><li>target character/sub-string</li><li>replacement character/string</li></ol></td><td>replaces a sub-string with another</td></tr>
<tr><td><code>chars</code> method and property</td><td><ol><li><em>(optional)</em> start position, counting from end if &lt; 0</li><li><em>(optional)</em> number of characters to iterate, none if ≤ 0</li></ol></td><td>allows iteration of the characters inside the string</td></tr>
</tbody></table>
</div>
<p>Beware that functions that involve indexing into a <a href="language//book/language/strings-chars.html">string</a> to get at individual <a href="language//book/language/strings-chars.html">characters</a>,
e.g. <code>sub_string</code>, require walking through the entire UTF-8 encoded bytes stream to extract
individual Unicode characters and counting them, which can be slow for long <a href="language//book/language/strings-chars.html">strings</a>.</p>
<h2 id="building-strings"><a class="header" href="#building-strings">Building Strings</a></h2>
<p><a href="language//book/language/strings-chars.html">Strings</a> can be built from segments via the <code>+</code> operator.</p>
<div class="table-wrapper"><table><thead><tr><th>Operator</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="language//book/language/strings-chars.html">string</a> <code>+=</code> item</td><td>convert the item into a <a href="language//book/language/strings-chars.html">string</a>, then append it to the first <a href="language//book/language/strings-chars.html">string</a></td></tr>
<tr><td><a href="language//book/language/strings-chars.html">string</a> <code>+</code> item</td><td>convert the item into a <a href="language//book/language/strings-chars.html">string</a>, then concatenate them as a new <a href="language//book/language/strings-chars.html">string</a></td></tr>
<tr><td>item <code>+</code> <a href="language//book/language/strings-chars.html">string</a></td><td>convert the item into a <a href="language//book/language/strings-chars.html">string</a>, then concatenate them as a new <a href="language//book/language/strings-chars.html">string</a></td></tr>
</tbody></table>
</div>
<pre><code class="language-rust">let x = 42;

// Build string with '+'
let s = "The answer is: " + x + "!!!";

// Prints: "The answer is: 42!!!"
print(s);</code></pre>
<h3 id="standard-operators-between-strings-andor-characters"><a class="header" href="#standard-operators-between-strings-andor-characters">Standard Operators Between Strings and/or Characters</a></h3>
<p>The following standard operators inter-operate between <a href="language//book/language/strings-chars.html">strings</a> and/or <a href="language//book/language/strings-chars.html">characters</a>.</p>
<p>When one (or both) of the operands is a <a href="language//book/language/strings-chars.html">character</a>, it is first converted into a one-character
<a href="language//book/language/strings-chars.html">string</a> before running the operator.</p>
<div class="table-wrapper"><table><thead><tr><th>Operator</th><th>Description</th></tr></thead><tbody>
<tr><td><code>+</code>, <code>+=</code></td><td><a href="language//book/language/strings-chars.html">character</a>/<a href="language//book/language/strings-chars.html">string</a> concatenation</td></tr>
<tr><td><code>-</code>, <code>-=</code></td><td>remove <a href="language//book/language/strings-chars.html">character</a>/sub-<a href="language//book/language/strings-chars.html">string</a> from <a href="language//book/language/strings-chars.html">string</a></td></tr>
<tr><td><code>==</code></td><td>equals to</td></tr>
<tr><td><code>!=</code></td><td>not equals to</td></tr>
<tr><td><code>&gt;</code></td><td>greater than</td></tr>
<tr><td><code>&gt;=</code></td><td>greater than or equals to</td></tr>
<tr><td><code>&lt;</code></td><td>less than</td></tr>
<tr><td><code>&lt;=</code></td><td>less than or equals to</td></tr>
</tbody></table>
</div>
<h3 id="interop-with-blobs"><a class="header" href="#interop-with-blobs">Interop with BLOB’s</a></h3>
<p>For convenience, when a <a href="language//book/language/blobs.html">BLOB</a> is appended to a <a href="language//book/language/strings-chars.html">string</a>, or vice versa, it is treated as a UTF-8
encoded byte stream and automatically first converted into the appropriate <a href="language//book/language/strings-chars.html">string</a> value.</p>
<p>That is because it is rarely useful to append a <a href="language//book/language/blobs.html">BLOB</a> into a string, but extremely useful to be
able to directly manipulate UTF-8 encoded text.</p>
<div class="table-wrapper"><table><thead><tr><th>Operator</th><th>Description</th></tr></thead><tbody>
<tr><td><code>+</code>, <code>+=</code></td><td>append a <a href="language//book/language/blobs.html">BLOB</a> (as a UTF-8 encoded byte stream) to the end of the <a href="language//book/language/strings-chars.html">string</a></td></tr>
<tr><td><code>+</code></td><td>concatenate a <a href="language//book/language/blobs.html">BLOB</a> (as a UTF-8 encoded byte stream) with a <a href="language//book/language/strings-chars.html">string</a></td></tr>
</tbody></table>
</div>
<h2 id="examples-8"><a class="header" href="#examples-8">Examples</a></h2>
<pre><code class="language-rust">let full_name == " Bob C. Davis ";
full_name.len == 14;

full_name.trim();
full_name.len == 12;
full_name == "Bob C. Davis";

full_name.pad(15, '$');
full_name.len == 15;
full_name == "Bob C. Davis$$$";

let n = full_name.index_of('$');
n == 12;

full_name.index_of("$$", n + 1) == 13;

full_name.sub_string(n, 3) == "$$$";
full_name.sub_string(n..n+3) == "$$$";

full_name.truncate(6);
full_name.len == 6;
full_name == "Bob C.";

full_name.replace("Bob", "John");
full_name.len == 7;
full_name == "John C.";

full_name.contains('C') == true;
full_name.contains("John") == true;

full_name.crop(5);
full_name == "C.";

full_name.crop(0, 1);
full_name == "C";

full_name.clear();
full_name.len == 0;</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="strings-interner"><a class="header" href="#strings-interner">Strings Interner</a></h1>
<p>Because <a href="rust//book/language/strings-chars.html">strings</a> are immutable (i.e. the use the type <a href="rust//book/rust/immutable-string.html"><code>ImmutableString</code></a> instead of normal Rust <code>String</code>),
each operation on a <a href="rust//book/language/strings-chars.html">string</a> actually creates a new <a href="rust//book/rust/immutable-string.html"><code>ImmutableString</code></a> instance.</p>
<p>A <em>strings interner</em> can substantially reduce memory usage by reusing the same <a href="rust//book/rust/immutable-string.html"><code>ImmutableString</code></a>
instance for the same <a href="rust//book/language/strings-chars.html">string</a> content.</p>
<p>An <a href="rust//book/engine/hello-world.html"><code>Engine</code></a> contains a strings interner which is enabled by default
(disabled when using a <a href="rust//book/engine/raw.html">raw <code>Engine</code></a>).</p>
<p>The maximum number of <a href="rust//book/language/strings-chars.html">strings</a> to be interned can be set via
<a href="rust//book/engine/options.html"><code>Engine::set_max_strings_interned</code></a> (set to zero to disable the strings interner).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="arrays"><a class="header" href="#arrays">Arrays</a></h1>
<div id="admonition-safety" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-safety-title">
<div class="admonition-title">
<div id="admonition-safety-title">
<p>Safety</p>
</div>
<a class="admonition-anchor-link" href="language/arrays.html#admonition-safety"></a>
</div>
<div>
<p>Always limit the <a href="language//book/safety/max-array-size.html">maximum size of arrays</a>.</p>
</div>
</div>
<p>Arrays are first-class citizens in Rhai.</p>
<p>All elements stored in an array are <a href="language//book/language/dynamic.html"><code>Dynamic</code></a>, and the array can freely grow or shrink with
elements added or removed.</p>
<p>The Rust type of a Rhai array is <code>rhai::Array</code> which is an alias to <code>Vec&lt;Dynamic&gt;</code>.</p>
<p><a href="language//book/language/type-of.html"><code>type_of()</code></a> an array returns <code>"array"</code>.</p>
<p>Arrays are disabled via the <a href="language//book/start/features.html"><code>no_index</code></a> feature.</p>
<h2 id="literal-syntax"><a class="header" href="#literal-syntax">Literal Syntax</a></h2>
<p>Array literals are built within square brackets <code>[</code> … <code>]</code> and separated by commas <code>,</code>:</p>
<blockquote>
<p><code>[</code> <em>value</em><code>,</code> <em>value</em><code>,</code> … <code>,</code> <em>value</em> <code>]</code></p>
<p><code>[</code> <em>value</em><code>,</code> <em>value</em><code>,</code> … <code>,</code> <em>value</em> <code>,</code> <code>]</code>     <code>// trailing comma is OK</code></p>
</blockquote>
<h2 id="element-access-syntax"><a class="header" href="#element-access-syntax">Element Access Syntax</a></h2>
<h3 id="from-beginning-1"><a class="header" href="#from-beginning-1">From beginning</a></h3>
<p>Like C, arrays are accessed with zero-based, non-negative integer indices:</p>
<blockquote>
<p><em>array</em> <code>[</code> <em>index position from 0 to (length−1)</em> <code>]</code></p>
</blockquote>
<h3 id="from-end-1"><a class="header" href="#from-end-1">From end</a></h3>
<p>A <em>negative</em> position accesses an element in the array counting from the <em>end</em>, with −1 being the
<em>last</em> element.</p>
<blockquote>
<p><em>array</em> <code>[</code> <em>index position from −1 to −length</em> <code>]</code></p>
</blockquote>
<h2 id="out-of-bounds-index"><a class="header" href="#out-of-bounds-index">Out-of-Bounds Index</a></h2>
<p>Trying to read from an index that is out of bounds causes an error.</p>
<div id="admonition-advanced-tip-override-standard-behavior" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-advanced-tip-override-standard-behavior-title">
<div class="admonition-title">
<div id="admonition-advanced-tip-override-standard-behavior-title">
<p>Advanced tip: Override standard behavior</p>
</div>
<a class="admonition-anchor-link" href="language/arrays.html#admonition-advanced-tip-override-standard-behavior"></a>
</div>
<div>
<p>For fine-tuned control on what happens when an out-of-bounds index is accessed,
see <a href="language/arrays-oob.html"><em>Out-of-Bounds Index for Arrays</em></a>.</p>
</div>
</div>
<h2 id="built-in-functions-1"><a class="header" href="#built-in-functions-1">Built-in Functions</a></h2>
<p>The following methods (mostly defined in the <a href="language//book/rust/packages/builtin.html"><code>BasicArrayPackage</code></a> but excluded
when using a <a href="language//book/engine/raw.html">raw <code>Engine</code></a>) operate on arrays.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Parameter(s)</th><th>Description</th></tr></thead><tbody>
<tr><td><code>get</code></td><td>position, counting from end if &lt; 0</td><td>gets a copy of the element at a certain position (<a href="language//book/language/values-and-types.html"><code>()</code></a> if the position is not valid)</td></tr>
<tr><td><code>set</code></td><td><ol><li>position, counting from end if &lt; 0</li><li>new element</li></ol></td><td>sets a certain position to a new value (no effect if the position is not valid)</td></tr>
<tr><td><code>push</code>, <code>+=</code> operator</td><td>element to append (not an array)</td><td>appends an element to the end</td></tr>
<tr><td><code>append</code>, <code>+=</code> operator</td><td>array to append</td><td>concatenates the second array to the end of the first</td></tr>
<tr><td><code>+</code> operator</td><td><ol><li>first array</li><li>second array</li></ol></td><td>concatenates the first array with the second</td></tr>
<tr><td><code>==</code> operator</td><td><ol><li>first array</li><li>second array</li></ol></td><td>are two arrays the same (elements compared with the <code>==</code> operator, if defined)?</td></tr>
<tr><td><code>!=</code> operator</td><td><ol><li>first array</li><li>second array</li></ol></td><td>are two arrays different (elements compared with the <code>==</code> operator, if defined)?</td></tr>
<tr><td><code>insert</code></td><td><ol><li>position, counting from end if &lt; 0, end if ≥ length</li><li>element to insert</li></ol></td><td>inserts an element at a certain position</td></tr>
<tr><td><code>pop</code></td><td><em>none</em></td><td>removes the last element and returns it (<a href="language//book/language/values-and-types.html"><code>()</code></a> if empty)</td></tr>
<tr><td><code>shift</code></td><td><em>none</em></td><td>removes the first element and returns it (<a href="language//book/language/values-and-types.html"><code>()</code></a> if empty)</td></tr>
<tr><td><code>extract</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li><em>(optional)</em> number of elements to extract, none if ≤ 0, to end if omitted</li></ol></td><td>extracts a portion of the array into a new array</td></tr>
<tr><td><code>extract</code></td><td><a href="language//book/language/ranges.html">range</a> of elements to extract, from beginning if ≤ 0, to end if ≥ length</td><td>extracts a portion of the array into a new array</td></tr>
<tr><td><code>remove</code></td><td>position, counting from end if &lt; 0</td><td>removes an element at a particular position and returns it (<a href="language//book/language/values-and-types.html"><code>()</code></a> if the position is not valid)</td></tr>
<tr><td><code>reverse</code></td><td><em>none</em></td><td>reverses the array</td></tr>
<tr><td><code>len</code> method and property</td><td><em>none</em></td><td>returns the number of elements</td></tr>
<tr><td><code>is_empty</code> method and property</td><td><em>none</em></td><td>returns <code>true</code> if the array is empty</td></tr>
<tr><td><code>pad</code></td><td><ol><li>target length</li><li>element to pad</li></ol></td><td>pads the array with an element to at least a specified length</td></tr>
<tr><td><code>clear</code></td><td><em>none</em></td><td>empties the array</td></tr>
<tr><td><code>truncate</code></td><td>target length</td><td>cuts off the array at exactly a specified length (discarding all subsequent elements)</td></tr>
<tr><td><code>chop</code></td><td>target length</td><td>cuts off the head of the array, leaving the tail at exactly a specified length</td></tr>
<tr><td><code>split</code></td><td><ol><li>array</li><li>position to split at, counting from end if &lt; 0, end if ≥ length</li></ol></td><td>splits the array into two arrays, starting from a specified position</td></tr>
<tr><td><code>for_each</code></td><td><a href="language//book/language/fn-ptr.html">function pointer</a> for processing elements</td><td>run through each element in the array in order, binding each to <code>this</code> and calling the processing function taking the following parameters: <ol><li><code>this</code>: array element</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>drain</code></td><td><a href="language//book/language/fn-ptr.html">function pointer</a> to predicate (usually a <a href="language//book/language/fn-closure.html">closure</a>)</td><td>removes all elements (returning them) that return <code>true</code> when called with the predicate function taking the following parameters (if none, the array element is bound to <code>this</code>):<ol><li>array element</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>drain</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of elements to remove, none if ≤ 0</li></ol></td><td>removes a portion of the array, returning the removed elements as a new array</td></tr>
<tr><td><code>drain</code></td><td><a href="language//book/language/ranges.html">range</a> of elements to remove, from beginning if ≤ 0, to end if ≥ length</td><td>removes a portion of the array, returning the removed elements as a new array</td></tr>
<tr><td><code>retain</code></td><td><a href="language//book/language/fn-ptr.html">function pointer</a> to predicate (usually a <a href="language//book/language/fn-closure.html">closure</a>)</td><td>removes all elements (returning them) that do not return <code>true</code> when called with the predicate function taking the following parameters (if none, the array element is bound to <code>this</code>):<ol><li>array element</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>retain</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of elements to retain, none if ≤ 0</li></ol></td><td>retains a portion of the array, removes all other elements and returning them as a new array</td></tr>
<tr><td><code>retain</code></td><td><a href="language//book/language/ranges.html">range</a> of elements to retain, from beginning if ≤ 0, to end if ≥ length</td><td>retains a portion of the array, removes all other bytes and returning them as a new array</td></tr>
<tr><td><code>splice</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of elements to remove, none if ≤ 0</li><li>array to insert</li></ol></td><td>replaces a portion of the array with another (not necessarily of the same length as the replaced portion)</td></tr>
<tr><td><code>splice</code></td><td><ol><li><a href="language//book/language/ranges.html">range</a> of elements to remove, from beginning if ≤ 0, to end if ≥ length</li><li>array to insert</li></ol></td><td>replaces a portion of the array with another (not necessarily of the same length as the replaced portion)</td></tr>
<tr><td><code>filter</code></td><td><a href="language//book/language/fn-ptr.html">function pointer</a> to predicate (usually a <a href="language//book/language/fn-closure.html">closure</a>)</td><td>constructs a new array with all elements that return <code>true</code> when called with the predicate function taking the following parameters (if none, the array element is bound to <code>this</code>):<ol><li>array element</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>contains</code>, <a href="language//book/language/in.html"><code>in</code></a> operator</td><td>element to find</td><td>does the array contain an element? The <code>==</code> operator (if defined) is used to compare <a href="language//book/rust/custom-types.html">custom types</a></td></tr>
<tr><td><code>index_of</code></td><td><ol><li>element to find (not a <a href="language//book/language/fn-ptr.html">function pointer</a>)</li><li><em>(optional)</em> start position, counting from end if &lt; 0, end if ≥ length</li></ol></td><td>returns the position of the first element in the array that equals the supplied element (using the <code>==</code> operator, if defined), or −1 if not found</li></ol></td></tr>
<tr><td><code>index_of</code></td><td><ol><li><a href="language//book/language/fn-ptr.html">function pointer</a> to predicate (usually a <a href="language//book/language/fn-closure.html">closure</a>)</li><li><em>(optional)</em> start position, counting from end if &lt; 0, end if ≥ length</li></ol></td><td>returns the position of the first element in the array that returns <code>true</code> when called with the predicate function, or −1 if not found:<ol><li>array element (if none, the array element is bound to <code>this</code>)</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>find</code></td><td><ol><li><a href="language//book/language/fn-ptr.html">function pointer</a> to predicate (usually a <a href="language//book/language/fn-closure.html">closure</a>)</li><li><em>(optional)</em> start position, counting from end if &lt; 0, end if ≥ length</li></ol></td><td>returns the first element in the array that returns <code>true</code> when called with the predicate function, or <a href="language//book/language/values-and-types.html"><code>()</code></a> if not found:<ol><li>array element (if none, the array element is bound to <code>this</code>)</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>find_map</code></td><td><ol><li><a href="language//book/language/fn-ptr.html">function pointer</a> to predicate (usually a <a href="language//book/language/fn-closure.html">closure</a>)</li><li><em>(optional)</em> start position, counting from end if &lt; 0, end if ≥ length</li></ol></td><td>returns the first non-<a href="language//book/language/values-and-types.html"><code>()</code></a> value of the first element in the array when called with the predicate function, or <a href="language//book/language/values-and-types.html"><code>()</code></a> if not found:<ol><li>array element (if none, the array element is bound to <code>this</code>)</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>dedup</code></td><td><em>(optional)</em> <a href="language//book/language/fn-ptr.html">function pointer</a> to predicate (usually a <a href="language//book/language/fn-closure.html">closure</a>); if omitted, the <code>==</code> operator is used, if defined</td><td>removes all but the first of <em>consecutive</em> elements in the array that return <code>true</code> when called with the predicate function (non-consecutive duplicates are <em>not</em> removed):<br/>1st &amp; 2nd parameters: two elements in the array</td></tr>
<tr><td><code>map</code></td><td><a href="language//book/language/fn-ptr.html">function pointer</a> to conversion function (usually a <a href="language//book/language/fn-closure.html">closure</a>)</td><td>constructs a new array with all elements mapped to the result of applying the conversion function taking the following parameters (if none, the array element is bound to <code>this</code>):<ol><li>array element</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>reduce</code></td><td><ol><li><a href="language//book/language/fn-ptr.html">function pointer</a> to accumulator function (usually a <a href="language//book/language/fn-closure.html">closure</a>)</li><li><em>(optional)</em> the initial value</li></ol></td><td>reduces the array into a single value via the accumulator function taking the following parameters (if the second parameter is omitted, the array element is bound to <code>this</code>):<ol><li>accumulated value (<a href="language//book/language/values-and-types.html"><code>()</code></a> initially)</li><li><code>this</code>: array element</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>reduce_rev</code></td><td><ol><li><a href="language//book/language/fn-ptr.html">function pointer</a> to accumulator function (usually a <a href="language//book/language/fn-closure.html">closure</a>)</li><li><em>(optional)</em> the initial value</li></ol></td><td>reduces the array (in reverse order) into a single value via the accumulator function taking the following parameters (if the second parameter is omitted, the array element is bound to <code>this</code>):<ol><li>accumulated value (<a href="language//book/language/values-and-types.html"><code>()</code></a> initially)</li><li><code>this</code>: array element</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>zip</code></td><td><ol><li>array to zip</li><li><a href="language//book/language/fn-ptr.html">function pointer</a> to conversion function (usually a <a href="language//book/language/fn-closure.html">closure</a>)</li></ol></td><td>constructs a new array with all element pairs from two arrays mapped to the result of applying the conversion function taking the following parameters:<ol><li>first array element</li><li>second array element</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>some</code></td><td><a href="language//book/language/fn-ptr.html">function pointer</a> to predicate (usually a <a href="language//book/language/fn-closure.html">closure</a>)</td><td>returns <code>true</code> if any element returns <code>true</code> when called with the predicate function taking the following parameters (if none, the array element is bound to <code>this</code>):<ol><li>array element</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>all</code></td><td><a href="language//book/language/fn-ptr.html">function pointer</a> to predicate (usually a <a href="language//book/language/fn-closure.html">closure</a>)</td><td>returns <code>true</code> if all elements return <code>true</code> when called with the predicate function taking the following parameters (if none, the array element is bound to <code>this</code>):<ol><li>array element</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>sort</code></td><td><a href="language//book/language/fn-ptr.html">function pointer</a> to a comparison function (usually a <a href="language//book/language/fn-closure.html">closure</a>)</td><td>sorts the array with a comparison function taking the following parameters:<ol><li>first element</li><li>second element<br/>return value: <code>INT</code> &lt; 0 if first &lt; second, &gt; 0 if first &gt; second, 0 if first == second</li></ol></td></tr>
<tr><td><code>sort</code></td><td><em>none</em></td><td>sorts a <em>homogeneous</em> array containing only elements of the same comparable built-in type (<code>INT</code>, <code>FLOAT</code>, <a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a>, <a href="language//book/language/strings-chars.html">string</a>, <a href="language//book/language/strings-chars.html">character</a>, <code>bool</code>, <a href="language//book/language/values-and-types.html"><code>()</code></a>)</td></tr>
</tbody></table>
</div><div id="admonition-tip-use-custom-types-with-arrays" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-use-custom-types-with-arrays-title">
<div class="admonition-title">
<div id="admonition-tip-use-custom-types-with-arrays-title">
<p>Tip: Use custom types with arrays</p>
</div>
<a class="admonition-anchor-link" href="language/arrays.html#admonition-tip-use-custom-types-with-arrays"></a>
</div>
<div>
<p>To use a <a href="language//book/rust/custom-types.html">custom type</a> with arrays, a number of functions need to be manually implemented,
in particular the <code>==</code> operator in order to support the <a href="language//book/language/in.html"><code>in</code></a> operator which uses <code>==</code> (via the
<code>contains</code> method) to compare elements.</p>
<p>See the section on <a href="language//book/rust/custom-types.html">custom types</a> for more details.</p>
</div>
</div>
<h2 id="examples-9"><a class="header" href="#examples-9">Examples</a></h2>
<pre><code class="language-rust">let y = [2, 3];             // y == [2, 3]

let y = [2, 3,];            // y == [2, 3]

y.insert(0, 1);             // y == [1, 2, 3]

y.insert(999, 4);           // y == [1, 2, 3, 4]

y.len == 4;

y[0] == 1;
y[1] == 2;
y[2] == 3;
y[3] == 4;

(1 in y) == true;           // use 'in' to test if an element exists in the array

(42 in y) == false;         // 'in' uses the 'contains' function, which uses the
                            // '==' operator (that users can override)
                            // to check if the target element exists in the array

y.contains(1) == true;      // the above de-sugars to this

y[1] = 42;                  // y == [1, 42, 3, 4]

(42 in y) == true;

y.remove(2) == 3;           // y == [1, 42, 4]

y.len == 3;

y[2] == 4;                  // elements after the removed element are shifted

ts.list = y;                // arrays can be assigned completely (by value copy)

ts.list[1] == 42;

[1, 2, 3][0] == 1;          // indexing on array literal

[1, 2, 3][-1] == 3;         // negative position counts from the end

fn abc() {
    [42, 43, 44]            // a function returning an array
}

abc()[0] == 42;

y.push(4);                  // y == [1, 42, 4, 4]

y += 5;                     // y == [1, 42, 4, 4, 5]

y.len == 5;

y.shift() == 1;             // y == [42, 4, 4, 5]

y.chop(3);                  // y == [4, 4, 5]

y.len == 3;

y.pop() == 5;               // y == [4, 4]

y.len == 2;

for element in y {          // arrays can be iterated with a 'for' statement
    print(element);
}

y.pad(6, "hello");          // y == [4, 4, "hello", "hello", "hello", "hello"]

y.len == 6;

y.truncate(4);              // y == [4, 4, "hello", "hello"]

y.len == 4;

y.clear();                  // y == []

y.len == 0;

// The examples below use 'a' as the master array

let a = [42, 123, 99];

a.for_each(|| this *= 2);

a == [84, 246, 198];

a.for_each(|i| this /= 2);

a == [42, 123, 99];

a.map(|v| v + 1);           // returns [43, 124, 100]

a.map(|| this + 1);         // returns [43, 124, 100]

a.map(|v, i| v + i);        // returns [42, 124, 101]

a.filter(|v| v &gt; 50);       // returns [123, 99]

a.filter(|| this &gt; 50);     // returns [123, 99]

a.filter(|v, i| i == 1);    // returns [123]

a.filter("is_odd");         // returns [123, 99]

a.filter(Fn("is_odd"));     // &lt;- previous statement is equivalent to this...

a.filter(|v| is_odd(v));    // &lt;- or this

a.some(|v| v &gt; 50);         // returns true

a.some(|| this &gt; 50);       // returns true

a.some(|v, i| v &lt; i);       // returns false

a.all(|v| v &gt; 50);          // returns false

a.all(|| this &gt; 50);        // returns false

a.all(|v, i| v &gt; i);        // returns true

// Reducing - initial value provided directly
a.reduce(|sum| sum + this, 0) == 264;

// Reducing - initial value provided directly
a.reduce(|sum, v| sum + v, 0) == 264;

// Reducing - initial value is '()'
a.reduce(
    |sum, v| if sum.type_of() == "()" { v } else { sum + v }
) == 264;

// Reducing - initial value has index position == 0
a.reduce(|sum, v, i|
    if i == 0 { v } else { sum + v }
) == 264;

// Reducing in reverse - initial value provided directly
a.reduce_rev(|sum| sum + this, 0) == 264;

// Reducing in reverse - initial value provided directly
a.reduce_rev(|sum, v| sum + v, 0) == 264;

// Reducing in reverse - initial value is '()'
a.reduce_rev(
    |sum, v| if sum.type_of() == "()" { v } else { sum + v }
) == 264;

// Reducing in reverse - initial value has index position == 0
a.reduce_rev(|sum, v, i|
    if i == 2 { v } else { sum + v }
) == 264;

// In-place modification

a.splice(1..=1, [1, 3, 2]); // a == [42, 1, 3, 2, 99]

a.extract(1..=3);           // returns [1, 3, 2]

a.sort(|x, y| y - x);       // a == [99, 42, 3, 2, 1]

a.sort();                   // a == [1, 2, 3, 42, 99]

a.drain(|v| v &lt;= 1);        // a == [2, 3, 42, 99]

a.drain(|v, i| i ≥ 3);      // a == [2, 3, 42]

a.retain(|v| v &gt; 10);       // a == [42]

a.retain(|v, i| i &gt; 0);     // a == []</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="blobs"><a class="header" href="#blobs">BLOB’s</a></h1>
<div id="admonition-safety" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-safety-title">
<div class="admonition-title">
<div id="admonition-safety-title">
<p>Safety</p>
</div>
<a class="admonition-anchor-link" href="language/blobs.html#admonition-safety"></a>
</div>
<div>
<p>Always limit the <a href="language//book/safety/max-array-size.html">maximum size of arrays</a>.</p>
</div>
</div>
<p>BLOB’s (<strong>B</strong>inary <strong>L</strong>arge <strong>OB</strong>jects), used to hold packed arrays of bytes, have built-in support in Rhai.</p>
<p>A BLOB has no literal representation, but is created via the <code>blob</code> function, or simply returned as
the result of a function call (e.g. <code>generate_thumbnail_image</code> that generates a thumbnail version of
a large image as a BLOB).</p>
<p>All items stored in a BLOB are bytes (i.e. <code>u8</code>) and the BLOB can freely grow or shrink with bytes
added or removed.</p>
<p>The Rust type of a Rhai BLOB is <code>rhai::Blob</code> which is an alias to <code>Vec&lt;u8&gt;</code>.</p>
<p><a href="language//book/language/type-of.html"><code>type_of()</code></a> a BLOB returns <code>"blob"</code>.</p>
<p>BLOB’s are disabled via the <a href="language//book/start/features.html"><code>no_index</code></a> feature.</p>
<h2 id="element-access-syntax-1"><a class="header" href="#element-access-syntax-1">Element Access Syntax</a></h2>
<h3 id="from-beginning-2"><a class="header" href="#from-beginning-2">From beginning</a></h3>
<p>Like <a href="language//book/language/arrays.html">arrays</a>, BLOB’s are accessed with zero-based, non-negative integer indices:</p>
<blockquote>
<p><em>blob</em> <code>[</code> <em>index position from 0 to (length−1)</em> <code>]</code></p>
</blockquote>
<h3 id="from-end-2"><a class="header" href="#from-end-2">From end</a></h3>
<p>A <em>negative</em> position accesses an element in the BLOB counting from the <em>end</em>, with −1 being the
<em>last</em> element.</p>
<blockquote>
<p><em>blob</em> <code>[</code> <em>index position from −1 to −length</em> <code>]</code></p>
</blockquote>
<div id="admonition-byte-values" class="admonition admonish-info small" role="note" aria-labelledby="admonition-byte-values-title">
<div class="admonition-title">
<div id="admonition-byte-values-title">
<p>Byte values</p>
</div>
<a class="admonition-anchor-link" href="language/blobs.html#admonition-byte-values"></a>
</div>
<div>
<p>The value of a particular byte in a BLOB is mapped to an <code>INT</code> (which can be 64-bit or 32-bit
depending on the <a href="language//book/start/features.html"><code>only_i32</code></a> feature).</p>
<p>Only the lowest 8 bits are significant, all other bits are ignored.</p>
</div>
</div>
<h2 id="create-a-blob"><a class="header" href="#create-a-blob">Create a BLOB</a></h2>
<p>The function <code>blob</code> allows creating an empty BLOB, optionally filling it to a required size with a
particular value (default zero).</p>
<pre><code class="language-rust">let x = blob();             // empty BLOB

let x = blob(10);           // BLOB with ten zeros

let x = blob(50, 42);       // BLOB with 50x 42's</code></pre>
<div id="admonition-tip-initialize-with-byte-stream" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-initialize-with-byte-stream-title">
<div class="admonition-title">
<div id="admonition-tip-initialize-with-byte-stream-title">
<p>Tip: Initialize with byte stream</p>
</div>
<a class="admonition-anchor-link" href="language/blobs.html#admonition-tip-initialize-with-byte-stream"></a>
</div>
<div>
<p>To quickly initialize a BLOB with a particular byte stream, the <code>write_be</code> method can be used to
write eight bytes at a time (four under <a href="language//book/start/features.html"><code>only_i32</code></a>) in big-endian byte order.</p>
<p>If fewer than eight bytes are needed, remember to right-pad the number as big-endian byte order is used.</p>
<pre><code class="language-rust">let buf = blob(12, 0);      // BLOB with 12x zeros

// Write eight bytes at a time, in big-endian order
buf.write_be(0, 8, 0xab_cd_ef_12_34_56_78_90);
buf.write_be(8, 8, 0x0a_0b_0c_0d_00_00_00_00);
                            //   ^^^^^^^^^^^ remember to pad unused bytes

print(buf);                 // prints "[abcdef1234567890 0a0b0c0d]"

buf[3] == 0x12;
buf[10] == 0x0c;

// Under 'only_i32', write four bytes at a time:
buf.write_be(0, 4, 0xab_cd_ef_12);
buf.write_be(4, 4, 0x34_56_78_90);
buf.write_be(8, 4, 0x0a_0b_0c_0d);</code></pre>
</div>
</div>
<h2 id="writing-ascii-bytes"><a class="header" href="#writing-ascii-bytes">Writing ASCII Bytes</a></h2>
<div id="admonition-non-ascii" class="admonition admonish-warning side" role="note" aria-labelledby="admonition-non-ascii-title">
<div class="admonition-title">
<div id="admonition-non-ascii-title">
<p>Non-ASCII</p>
</div>
<a class="admonition-anchor-link" href="language/blobs.html#admonition-non-ascii"></a>
</div>
<div>
<p>Non-ASCII characters (i.e. characters not within 1-127) are ignored.</p>
</div>
</div>
<p>For many embedded applications, it is necessary to encode an ASCII <a href="language//book/language/strings-chars.html">string</a> as a byte stream.</p>
<p>Use the <code>write_ascii</code> method to write ASCII <a href="language//book/language/strings-chars.html">strings</a> into any specific <a href="language//book/language/ranges.html">range</a> within a BLOB.</p>
<p>The following is an example of a building a 16-byte command to send to an embedded device.</p>
<pre><code class="language-rust">// Assume the following 16-byte command for an embedded device:
// ┌─────────┬───────────────┬──────────────────────────────────┬───────┐
// │    0    │       1       │              2-13                │ 14-15 │
// ├─────────┼───────────────┼──────────────────────────────────┼───────┤
// │ command │ string length │ ASCII string, max. 12 characters │  CRC  │
// └─────────┴───────────────┴──────────────────────────────────┴───────┘

let buf = blob(16, 0);      // initialize command buffer

let text = "foo &amp; bar";     // text string to send to device

buf[0] = 0x42;              // command code
buf[1] = s.len();           // length of string

buf.write_ascii(2..14, text);   // write the string

let crc = buf.calc_crc();   // calculate CRC

buf.write_le(14, 2, crc);   // write CRC

print(buf);                 // prints "[4209666f6f202620 626172000000abcd]"
                            //          ^^ command code              ^^^^ CRC
                            //            ^^ string length
                            //              ^^^^^^^^^^^^^^^^^^^ foo &amp; bar

device.send(buf);           // send command to device</code></pre>
<div id="admonition-what-if-i-need-utf-8" class="admonition admonish-question small" role="note" aria-labelledby="admonition-what-if-i-need-utf-8-title">
<div class="admonition-title">
<div id="admonition-what-if-i-need-utf-8-title">
<p>What if I need UTF-8?</p>
</div>
<a class="admonition-anchor-link" href="language/blobs.html#admonition-what-if-i-need-utf-8"></a>
</div>
<div>
<p>The <code>write_utf8</code> function writes a string in UTF-8 encoding.</p>
<p>UTF-8, however, is not very common for embedded applications.</p>
</div>
</div>
<h2 id="built-in-functions-2"><a class="header" href="#built-in-functions-2">Built-in Functions</a></h2>
<p>The following functions (mostly defined in the <a href="language//book/rust/packages/builtin.html"><code>BasicBlobPackage</code></a> but excluded
when using a <a href="language//book/engine/raw.html">raw <code>Engine</code></a>) operate on BLOB’s.</p>
<div class="table-wrapper"><table><thead><tr><th>Functions</th><th>Parameter(s)</th><th>Description</th></tr></thead><tbody>
<tr><td><code>blob</code> constructor function</td><td><ol><li><em>(optional)</em> initial length of the BLOB</li><li><em>(optional)</em> initial byte value</li></ol></td><td>creates a new BLOB, optionally of a particular length filled with an initial byte value (default = 0)</td></tr>
<tr><td><code>to_array</code></td><td><em>none</em></td><td>converts the BLOB into an <a href="language//book/language/arrays.html">array</a> of integers</td></tr>
<tr><td><code>as_string</code></td><td><em>none</em></td><td>converts the BLOB into a <a href="language//book/language/strings-chars.html">string</a> (the byte stream is interpreted as UTF-8)</td></tr>
<tr><td><code>get</code></td><td>position, counting from end if &lt; 0</td><td>gets a copy of the byte at a certain position (0 if the position is not valid)</td></tr>
<tr><td><code>set</code></td><td><ol><li>position, counting from end if &lt; 0</li><li>new byte value</li></ol></td><td>sets a certain position to a new value (no effect if the position is not valid)</td></tr>
<tr><td><code>push</code>, <code>append</code>, <code>+=</code> operator</td><td><ol><li>BLOB</li><li>byte to append</li></ol></td><td>appends a byte to the end</td></tr>
<tr><td><code>append</code>, <code>+=</code> operator</td><td><ol><li>BLOB</li><li>BLOB to append</li></ol></td><td>concatenates the second BLOB to the end of the first</td></tr>
<tr><td><code>append</code>, <code>+=</code> operator</td><td><ol><li>BLOB</li><li><a href="language//book/language/strings-chars.html">string</a>/<a href="language//book/language/strings-chars.html">character</a> to append</li></ol></td><td>concatenates a <a href="language//book/language/strings-chars.html">string</a> or <a href="language//book/language/strings-chars.html">character</a> (as UTF-8 encoded byte-stream) to the end of the BLOB</td></tr>
<tr><td><code>+</code> operator</td><td><ol><li>first BLOB</li><li><a href="language//book/language/strings-chars.html">string</a> to append</li></ol></td><td>creates a new <a href="language//book/language/strings-chars.html">string</a> by concatenating the BLOB (as UTF-8 encoded byte-stream) with the the <a href="language//book/language/strings-chars.html">string</a></td></tr>
<tr><td><code>+</code> operator</td><td><ol><li><a href="language//book/language/strings-chars.html">string</a></li><li>BLOB to append</li></ol></td><td>creates a new <a href="language//book/language/strings-chars.html">string</a> by concatenating the BLOB (as UTF-8 encoded byte-stream) to the end of the <a href="language//book/language/strings-chars.html">string</a></td></tr>
<tr><td><code>+</code> operator</td><td><ol><li>first BLOB</li><li>second BLOB</li></ol></td><td>concatenates the first BLOB with the second</td></tr>
<tr><td><code>==</code> operator</td><td><ol><li>first BLOB</li><li>second BLOB</li></ol></td><td>are two BLOB’s the same?</td></tr>
<tr><td><code>!=</code> operator</td><td><ol><li>first BLOB</li><li>second BLOB</li></ol></td><td>are two BLOB’s different?</td></tr>
<tr><td><code>insert</code></td><td><ol><li>position, counting from end if &lt; 0, end if ≥ length</li><li>byte to insert</li></ol></td><td>inserts a byte at a certain position</td></tr>
<tr><td><code>pop</code></td><td><em>none</em></td><td>removes the last byte and returns it (0 if empty)</td></tr>
<tr><td><code>shift</code></td><td><em>none</em></td><td>removes the first byte and returns it (0 if empty)</td></tr>
<tr><td><code>extract</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li><em>(optional)</em> number of bytes to extract, none if ≤ 0</li></ol></td><td>extracts a portion of the BLOB into a new BLOB</td></tr>
<tr><td><code>extract</code></td><td><a href="language//book/language/ranges.html">range</a> of bytes to extract, from beginning if ≤ 0, to end if ≥ length</td><td>extracts a portion of the BLOB into a new BLOB</td></tr>
<tr><td><code>remove</code></td><td>position, counting from end if &lt; 0</td><td>removes a byte at a particular position and returns it (0 if the position is not valid)</td></tr>
<tr><td><code>reverse</code></td><td><em>none</em></td><td>reverses the BLOB byte by byte</td></tr>
<tr><td><code>len</code> method and property</td><td><em>none</em></td><td>returns the number of bytes in the BLOB</td></tr>
<tr><td><code>is_empty</code> method and property</td><td><em>none</em></td><td>returns <code>true</code> if the BLOB is empty</td></tr>
<tr><td><code>pad</code></td><td><ol><li>target length</li><li>byte value to pad</li></ol></td><td>pads the BLOB with a byte value to at least a specified length</td></tr>
<tr><td><code>clear</code></td><td><em>none</em></td><td>empties the BLOB</td></tr>
<tr><td><code>truncate</code></td><td>target length</td><td>cuts off the BLOB at exactly a specified length (discarding all subsequent bytes)</td></tr>
<tr><td><code>chop</code></td><td>target length</td><td>cuts off the head of the BLOB, leaving the tail at exactly a specified length</td></tr>
<tr><td><code>contains</code>, <a href="language//book/language/in.html"><code>in</code></a> operator</td><td>byte value to find</td><td>does the BLOB contain a particular byte value?</td></tr>
<tr><td><code>split</code></td><td><ol><li>BLOB</li><li>position to split at, counting from end if &lt; 0, end if ≥ length</li></ol></td><td>splits the BLOB into two BLOB’s, starting from a specified position</td></tr>
<tr><td><code>drain</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of bytes to remove, none if ≤ 0</li></ol></td><td>removes a portion of the BLOB, returning the removed bytes as a new BLOB</td></tr>
<tr><td><code>drain</code></td><td><a href="language//book/language/ranges.html">range</a> of bytes to remove, from beginning if ≤ 0, to end if ≥ length</td><td>removes a portion of the BLOB, returning the removed bytes as a new BLOB</td></tr>
<tr><td><code>retain</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of bytes to retain, none if ≤ 0</li></ol></td><td>retains a portion of the BLOB, removes all other bytes and returning them as a new BLOB</td></tr>
<tr><td><code>retain</code></td><td><a href="language//book/language/ranges.html">range</a> of bytes to retain, from beginning if ≤ 0, to end if ≥ length</td><td>retains a portion of the BLOB, removes all other bytes and returning them as a new BLOB</td></tr>
<tr><td><code>splice</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of bytes to remove, none if ≤ 0</li><li>BLOB to insert</li></ol></td><td>replaces a portion of the BLOB with another (not necessarily of the same length as the replaced portion)</td></tr>
<tr><td><code>splice</code></td><td><ol><li><a href="language//book/language/ranges.html">range</a> of bytes to remove, from beginning if ≤ 0, to end if ≥ length</li><li>BLOB to insert</td><td>replaces a portion of the BLOB with another (not necessarily of the same length as the replaced portion)</td></tr>
<tr><td><code>parse_le_int</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of bytes to parse, 8 if &gt; 8 (4 under <a href="language//book/start/features.html"><code>only_i32</code></a>), none if ≤ 0</li></ol></td><td>parses an integer at the particular offset in little-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>parse_le_int</code></td><td><a href="language//book/language/ranges.html">range</a> of bytes to parse, from beginning if ≤ 0, to end if ≥ length (up to 8 bytes, 4 under <a href="language//book/start/features.html"><code>only_i32</code></a>)</td><td>parses an integer at the particular offset in little-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>parse_be_int</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of bytes to parse, 8 if &gt; 8 (4 under <a href="language//book/start/features.html"><code>only_i32</code></a>), none if ≤ 0</li></ol></td><td>parses an integer at the particular offset in big-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>parse_be_int</code></td><td><a href="language//book/language/ranges.html">range</a> of bytes to parse, from beginning if ≤ 0, to end if ≥ length (up to 8 bytes, 4 under <a href="language//book/start/features.html"><code>only_i32</code></a>)</td><td>parses an integer at the particular offset in big-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>parse_le_float</code><br/>(not available under <a href="language//book/start/features.html"><code>no_float</code></a>)</td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of bytes to parse, 8 if &gt; 8 (4 under <a href="language//book/start/features.html"><code>f32_float</code></a>), none if ≤ 0</li></ol></td><td>parses a floating-point number at the particular offset in little-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>parse_le_float</code><br/>(not available under <a href="language//book/start/features.html"><code>no_float</code></a>)</td><td><a href="language//book/language/ranges.html">range</a> of bytes to parse, from beginning if ≤ 0, to end if ≥ length (up to 8 bytes, 4 under <a href="language//book/start/features.html"><code>f32_float</code></a>)</td><td>parses a floating-point number at the particular offset in little-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>parse_be_float</code><br/>(not available under <a href="language//book/start/features.html"><code>no_float</code></a>)</td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of bytes to parse, 8 if &gt; 8 (4 under <a href="language//book/start/features.html"><code>f32_float</code></a>), none if ≤ 0</li></ol></td><td>parses a floating-point number at the particular offset in big-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>parse_be_float</code><br/>(not available under <a href="language//book/start/features.html"><code>no_float</code></a>)</td><td><a href="language//book/language/ranges.html">range</a> of bytes to parse, from beginning if ≤ 0, to end if ≥ length (up to 8 bytes, 4 under <a href="language//book/start/features.html"><code>f32_float</code></a>)</td><td>parses a floating-point number at the particular offset in big-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>write_le</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of bytes to write, 8 if &gt; 8 (4 under <a href="language//book/start/features.html"><code>only_i32</code></a> or <a href="language//book/start/features.html"><code>f32_float</code></a>), none if ≤ 0</li><li>integer or floating-point value</li></ol></td><td>writes a value at the particular offset in little-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>write_le</code></td><td><ol><li><a href="language//book/language/ranges.html">range</a> of bytes to write, from beginning if ≤ 0, to end if ≥ length (up to 8 bytes, 4 under <a href="language//book/start/features.html"><code>only_i32</code></a> or <a href="language//book/start/features.html"><code>f32_float</code></a>)</li><li>integer or floating-point value</li></ol></td><td>writes a value at the particular offset in little-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>write_be</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of bytes to write, 8 if &gt; 8 (4 under <a href="language//book/start/features.html"><code>only_i32</code></a> or <a href="language//book/start/features.html"><code>f32_float</code></a>), none if ≤ 0</li><li>integer or floating-point value</li></ol></td><td>writes a value at the particular offset in big-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>write_be</code></td><td><ol><li><a href="language//book/language/ranges.html">range</a> of bytes to write, from beginning if ≤ 0, to end if ≥ length (up to 8 bytes, 4 under <a href="language//book/start/features.html"><code>only_i32</code></a> or <a href="language//book/start/features.html"><code>f32_float</code></a>)</li><li>integer or floating-point value</li></ol></td><td>writes a value at the particular offset in big-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>write_utf8</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of bytes to write, none if ≤ 0, to end if ≥ length</li><li><a href="language//book/language/strings-chars.html">string</a> to write</li></ol></td><td>writes a <a href="language//book/language/strings-chars.html">string</a> to the particular offset in UTF-8 encoding</td></tr>
<tr><td><code>write_utf8</code></td><td><ol><li><a href="language//book/language/ranges.html">range</a> of bytes to write, from beginning if ≤ 0, to end if ≥ length, to end if ≥ length</li><li><a href="language//book/language/strings-chars.html">string</a> to write</li></ol></td><td>writes a <a href="language//book/language/strings-chars.html">string</a> to the particular offset in UTF-8 encoding</td></tr>
<tr><td><code>write_ascii</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of <a href="language//book/language/strings-chars.html">characters</a> to write, none if ≤ 0, to end if ≥ length</li><li><a href="language//book/language/strings-chars.html">string</a> to write</li></ol></td><td>writes a <a href="language//book/language/strings-chars.html">string</a> to the particular offset in 7-bit ASCII encoding (non-ASCII <a href="language//book/language/strings-chars.html">characters</a> are skipped)</td></tr>
<tr><td><code>write_ascii</code></td><td><ol><li><a href="language//book/language/ranges.html">range</a> of bytes to write, from beginning if ≤ 0, to end if ≥ length, to end if ≥ length</li><li><a href="language//book/language/strings-chars.html">string</a> to write</li></ol></td><td>writes a <a href="language//book/language/strings-chars.html">string</a> to the particular offset in 7-bit ASCII encoding (non-ASCII <a href="language//book/language/strings-chars.html">characters</a> are skipped)</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="out-of-bounds-index-for-arrays"><a class="header" href="#out-of-bounds-index-for-arrays">Out-of-Bounds Index for Arrays</a></h1>
<div id="admonition-requires-internals" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-requires-internals-title">
<div class="admonition-title">
<div id="admonition-requires-internals-title">
<p>Requires <code>internals</code></p>
</div>
<a class="admonition-anchor-link" href="language/arrays-oob.html#admonition-requires-internals"></a>
</div>
<div>
<p>This is an advanced feature that requires the <a href="language//book/start/features.html"><code>internals</code></a> feature to be enabled.</p>
</div>
</div>
<p>Normally, when an index is out-of-bounds for an <a href="language//book/language/arrays.html">array</a>, an error is raised.</p>
<p>It is possible to completely control this behavior via a special callback function
registered into an <a href="language//book/engine/hello-world.html"><code>Engine</code></a> via <code>on_invalid_array_index</code>.</p>
<p>Using this callback, for instance, it is simple to instruct Rhai to extend the <a href="language//book/language/arrays.html">array</a> to
accommodate this new element, or to return a default value instead of raising an error.</p>
<h2 id="function-signature"><a class="header" href="#function-signature">Function Signature</a></h2>
<p>The function signature passed to <a href="https://docs.rs/rhai/1.22.0/rhai/struct.Engine.html#method.on_invalid_array_index"><code>Engine::on_invalid_array_index</code></a> takes the following form.</p>
<blockquote>
<pre><code class="language-rust">Fn(array: &amp;mut Array, index: i64, context: EvalContext) -&gt; Result&lt;Target, Box&lt;EvalAltResult&gt;&gt;</code></pre>
</blockquote>
<p>where:</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th style="text-align: center">Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>array</code></td><td style="text-align: center"><a href="language//book/language/arrays.html"><code>&amp;mut Array</code></a></td><td>the <a href="language//book/language/arrays.html">array</a> being accessed</td></tr>
<tr><td><code>index</code></td><td style="text-align: center"><code>i64</code></td><td>index value</td></tr>
<tr><td><code>context</code></td><td style="text-align: center"><a href="language//book/engine/eval-context.html"><code>EvalContext</code></a></td><td>the current <em>evaluation context</em></td></tr>
</tbody></table>
</div>
<h3 id="return-value"><a class="header" href="#return-value">Return value</a></h3>
<p>The return value is <code>Result&lt;Target, Box&lt;EvalAltResult&gt;&gt;</code>.</p>
<p><a href="https://docs.rs/rhai/latest/rhai/enum.Target.html"><code>Target</code></a> is an advanced type, available only under the <a href="language//book/start/features.html"><code>internals</code></a> feature, that represents a
<em>reference</em> to a <a href="language//book/language/dynamic.html"><code>Dynamic</code></a> value.</p>
<p>It can be used to point to a particular value within the <a href="language//book/language/arrays.html">array</a> or a new temporary value.</p>
<h2 id="example-13"><a class="header" href="#example-13">Example</a></h2>
<pre><code class="language-rust">engine.on_invalid_array_index(|arr, index, _| {
    match index {
        -100 =&gt; {
            // The array can be modified in place
            arr.push((42_i64).into());

            // Return a mutable reference to an element
            let value_ref = arr.last_mut().unwrap();
            Ok(value_ref.into())
        }
        100 =&gt; {
            // Return a temporary value (not a reference)
            let value = Dynamic::from(100_i64);
            Ok(value.into())
        }
        // Return the standard out-of-bounds error
        _ =&gt; Err(EvalAltResult::ErrorArrayBounds(
                arr.len(), index, Position::NONE
             ).into()),
    }
});</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="object-maps"><a class="header" href="#object-maps">Object Maps</a></h1>
<div id="admonition-safety" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-safety-title">
<div class="admonition-title">
<div id="admonition-safety-title">
<p>Safety</p>
</div>
<a class="admonition-anchor-link" href="language/object-maps.html#admonition-safety"></a>
</div>
<div>
<p>Always limit the <a href="language//book/safety/max-map-size.html">maximum size of object maps</a>.</p>
</div>
</div>
<p>Object maps are hash dictionaries. Properties are all <a href="language//book/language/dynamic.html"><code>Dynamic</code></a> and can be freely added and retrieved.</p>
<p>The Rust type of a Rhai object map is <code>rhai::Map</code>.
Currently it is an alias to <code>BTreeMap&lt;SmartString, Dynamic&gt;</code>.</p>
<p><a href="language//book/language/type-of.html"><code>type_of()</code></a> an object map returns <code>"map"</code>.</p>
<p>Object maps are disabled via the <a href="language//book/start/features.html"><code>no_object</code></a> feature.</p>
<div id="admonition-tip-object-maps-are-_fast_" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-object-maps-are-_fast_-title">
<div class="admonition-title">
<div id="admonition-tip-object-maps-are-_fast_-title">
<p>Tip: Object maps are <em>FAST</em></p>
</div>
<a class="admonition-anchor-link" href="language/object-maps.html#admonition-tip-object-maps-are-_fast_"></a>
</div>
<div>
<p>Normally, when <a href="language//book/rust/getters-setters.html">properties</a> are accessed, copies of the data values are made.
This is normally slow.</p>
<p>Object maps have special treatment – properties are accessed via <em>references</em>, meaning that
no copies of data values are made.</p>
<p>This makes object map access fast, especially when deep within a properties chain.</p>
<pre><code class="language-rust">// 'obj' is a normal custom type
let x = obj.a.b.c.d;

// The above is equivalent to:
let a_value = obj.a;        // temp copy of 'a'
let b_value = a_value.b;    // temp copy of 'b'
let c_value = b_value.c;    // temp copy of 'c'
let d_value = c_value.d;    // temp copy of 'd'
let x = d_value;

// 'map' is an object map
let x = map.a.b.c.d;        // direct access to 'd'
                            // 'a', 'b' and 'c' are not copied

map.a.b.c.d = 42;           // directly modifies 'd' in 'a', 'b' and 'c'
                            // no copy of any property value is made

map.a.b.c.d.calc();         // directly calls 'calc' on 'd'
                            // no copy of any property value is made</code></pre>
</div>
</div>
<div id="admonition-tldr-why-smartstring" class="admonition admonish-question small" role="note" aria-labelledby="admonition-tldr-why-smartstring-title">
<div class="admonition-title">
<div id="admonition-tldr-why-smartstring-title">
<p>TL;DR: Why <code>SmartString</code>?</p>
</div>
<a class="admonition-anchor-link" href="language/object-maps.html#admonition-tldr-why-smartstring"></a>
</div>
<div>
<p><a href="https://crates.io/crates/smartstring"><code>SmartString</code></a> is used because most object map properties are short (at least shorter than 23 characters)
and ASCII-based, so they can usually be stored inline without incurring the cost of an allocation.</p>
</div>
</div>
<div id="admonition-tldr-why-btreemap-and-not-hashmap" class="admonition admonish-question small" role="note" aria-labelledby="admonition-tldr-why-btreemap-and-not-hashmap-title">
<div class="admonition-title">
<div id="admonition-tldr-why-btreemap-and-not-hashmap-title">
<p>TL;DR: Why <code>BTreeMap</code> and not <code>HashMap</code>?</p>
</div>
<a class="admonition-anchor-link" href="language/object-maps.html#admonition-tldr-why-btreemap-and-not-hashmap"></a>
</div>
<div>
<p>The vast majority of object maps contain just a few properties.</p>
<p><code>BTreeMap</code> performs significantly better than <code>HashMap</code> when the number of entries is small.</p>
</div>
</div>
<h2 id="literal-syntax-1"><a class="header" href="#literal-syntax-1">Literal Syntax</a></h2>
<p>Object map literals are built within braces <code>#{</code> … <code>}</code> with <em>name</em><code>:</code><em>value</em> pairs separated by
commas <code>,</code>:</p>
<blockquote>
<p><code>#{</code> <em>property</em> <code>:</code> <em>value</em><code>,</code> … <code>,</code> <em>property</em> <code>:</code> <em>value</em> <code>}</code></p>
<p><code>#{</code> <em>property</em> <code>:</code> <em>value</em><code>,</code> … <code>,</code> <em>property</em> <code>:</code> <em>value</em> <code>,</code> <code>}</code>     <code>// trailing comma is OK</code></p>
</blockquote>
<p>The property <em>name</em> can be a simple identifier following the same naming rules as <a href="language//book/language/variables.html">variables</a>,
or a <a href="language//book/appendix/literals.html">string literal</a> without interpolation.</p>
<h2 id="property-access-syntax"><a class="header" href="#property-access-syntax">Property Access Syntax</a></h2>
<h3 id="dot-notation"><a class="header" href="#dot-notation">Dot notation</a></h3>
<p>The <em>dot notation</em> allows only property names that follow the same naming rules as <a href="language//book/language/variables.html">variables</a>.</p>
<blockquote>
<p><em>object</em> <code>.</code> <em>property</em></p>
</blockquote>
<h3 id="elvis-notation"><a class="header" href="#elvis-notation">Elvis notation</a></h3>
<p>The <a href="https://en.wikipedia.org/wiki/Elvis_operator"><em>Elvis notation</em></a> is similar to the <em>dot notation</em> except that it returns <a href="language//book/language/values-and-types.html"><code>()</code></a> if the object
itself is <a href="language//book/language/values-and-types.html"><code>()</code></a>.</p>
<blockquote>
<p><code>// returns () if object is ()</code><br />
<em>object</em> <code>?.</code> <em>property</em></p>
<p><code>// no action if object is ()</code><br />
<em>object</em> <code>?.</code> <em>property</em> <code>=</code> <em>value</em> <code>;</code></p>
</blockquote>
<h3 id="index-notation"><a class="header" href="#index-notation">Index notation</a></h3>
<p>The <em>index notation</em> allows setting/getting properties of arbitrary names (even the empty <a href="language//book/language/strings-chars.html">string</a>).</p>
<blockquote>
<p><em>object</em> <code>[</code> <em>property</em> <code>]</code></p>
</blockquote>
<h2 id="handle-non-existent-properties"><a class="header" href="#handle-non-existent-properties">Handle Non-Existent Properties</a></h2>
<p>Trying to read a non-existent property returns <a href="language//book/language/values-and-types.html"><code>()</code></a> instead of causing an error.</p>
<p>This is similar to JavaScript where accessing a non-existent property returns <code>undefined</code>.</p>
<pre><code class="language-rust">let map = #{ foo: 42 };

// Regular property access
let x = map.foo;            // x == 42

// Non-existent property
let x = map.bar;            // x == ()</code></pre>
<div id="admonition-tip-force-error" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-force-error-title">
<div class="admonition-title">
<div id="admonition-tip-force-error-title">
<p>Tip: Force error</p>
</div>
<a class="admonition-anchor-link" href="language/object-maps.html#admonition-tip-force-error"></a>
</div>
<div>
<p>It is possible to force Rhai to return an <code>EvalAltResult:: ErrorPropertyNotFound</code> via
<a href="language//book/engine/options.html"><code>Engine:: set_fail_on_invalid_map_property</code></a>.</p>
</div>
</div>
<div id="admonition-advanced-tip-override-standard-behavior" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-advanced-tip-override-standard-behavior-title">
<div class="admonition-title">
<div id="admonition-advanced-tip-override-standard-behavior-title">
<p>Advanced tip: Override standard behavior</p>
</div>
<a class="admonition-anchor-link" href="language/object-maps.html#admonition-advanced-tip-override-standard-behavior"></a>
</div>
<div>
<p>For fine-tuned control on what happens when a non-existent property is accessed,
see <a href="language/object-maps-missing-prop.html"><em>Non-Existent Property Handling for Object Maps</em></a>.</p>
</div>
</div>
<h3 id="check-for-property-existence"><a class="header" href="#check-for-property-existence">Check for property existence</a></h3>
<p>Use the <a href="language//book/language/in.html"><code>in</code></a> operator to check whether a property exists in an object-map.</p>
<pre><code class="language-rust">let map = #{ foo: 42 };

"foo" in map == true;

"bar" in map == false;</code></pre>
<h3 id="short-circuit-non-existent-property-access"><a class="header" href="#short-circuit-non-existent-property-access">Short-circuit non-existent property access</a></h3>
<p>Use the <a href="https://en.wikipedia.org/wiki/Elvis_operator"><em>Elvis operator</em></a> (<code>?.</code>) to short-circuit further processing if the object is <a href="language//book/language/values-and-types.html"><code>()</code></a>.</p>
<pre><code class="language-rust">x.a.b.foo();        // &lt;- error if 'x', 'x.a' or 'x.a.b' is ()

x.a.b = 42;         // &lt;- error if 'x' or 'x.a' is ()

x?.a?.b?.foo();     // &lt;- ok! returns () if 'x', 'x.a' or 'x.a.b' is ()

x?.a?.b = 42;       // &lt;- ok even if 'x' or 'x.a' is ()</code></pre>
<h3 id="default-property-value"><a class="header" href="#default-property-value">Default property value</a></h3>
<p>Using the <a href="language/logic.html#null-coalescing-operator">null-coalescing operator</a> to give non-existent
properties default values.</p>
<pre><code class="language-rust">let map = #{ foo: 42 };

// Regular property access
let x = map.foo;            // x == 42

// Non-existent property
let x = map.bar;            // x == ()

// Default value for property
let x = map.bar ?? 42;      // x == 42</code></pre>
<h2 id="built-in-functions-3"><a class="header" href="#built-in-functions-3">Built-in Functions</a></h2>
<p>The following methods (defined in the <a href="language//book/rust/packages/builtin.html"><code>BasicMapPackage</code></a> but excluded when using
a <a href="language//book/engine/raw.html">raw <code>Engine</code></a>) operate on object maps.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Parameter(s)</th><th>Description</th></tr></thead><tbody>
<tr><td><code>get</code></td><td>property name</td><td>gets a copy of the value of a certain property (<a href="language//book/language/values-and-types.html"><code>()</code></a> if the property does not exist); behavior is not affected by <a href="language//book/engine/options.html"><code>Engine::fail_on_invalid_map_property</code></a></td></tr>
<tr><td><code>set</code></td><td><ol><li>property name</li><li>new element</li></ol></td><td>sets a certain property to a new value (property is added if not already exists)</td></tr>
<tr><td><code>len</code></td><td><em>none</em></td><td>returns the number of properties</td></tr>
<tr><td><code>is_empty</code></td><td><em>none</em></td><td>returns <code>true</code> if the object map is empty</td></tr>
<tr><td><code>clear</code></td><td><em>none</em></td><td>empties the object map</td></tr>
<tr><td><code>remove</code></td><td>property name</td><td>removes a certain property and returns it (<a href="language//book/language/values-and-types.html"><code>()</code></a> if the property does not exist)</td></tr>
<tr><td><code>+=</code> operator, <code>mixin</code></td><td>second object map</td><td>mixes in all the properties of the second object map to the first (values of properties with the same names replace the existing values)</td></tr>
<tr><td><code>+</code> operator</td><td><ol><li>first object map</li><li>second object map</li></ol></td><td>merges the first object map with the second</td></tr>
<tr><td><code>==</code> operator</td><td><ol><li>first object map</li><li>second object map</li></ol></td><td>are the two object maps the same (elements compared with the <code>==</code> operator, if defined)?</td></tr>
<tr><td><code>!=</code> operator</td><td><ol><li>first object map</li><li>second object map</li></ol></td><td>are the two object maps different (elements compared with the <code>==</code> operator, if defined)?</td></tr>
<tr><td><code>fill_with</code></td><td>second object map</td><td>adds in all properties of the second object map that do not exist in the object map</td></tr>
<tr><td><code>contains</code>, <a href="language//book/language/in.html"><code>in</code></a> operator</td><td>property name</td><td>does the object map contain a property of a particular name?</td></tr>
<tr><td><code>keys</code></td><td><em>none</em></td><td>returns an <a href="language//book/language/arrays.html">array</a> of all the property names (in random order), not available under <a href="language//book/start/features.html"><code>no_index</code></a></td></tr>
<tr><td><code>values</code></td><td><em>none</em></td><td>returns an <a href="language//book/language/arrays.html">array</a> of all the property values (in random order), not available under <a href="language//book/start/features.html"><code>no_index</code></a></td></tr>
<tr><td><code>drain</code></td><td><a href="language//book/language/fn-ptr.html">function pointer</a> to predicate (usually a <a href="language//book/language/fn-closure.html">closure</a>)</td><td>removes all elements (returning them) that return <code>true</code> when called with the predicate function taking the following parameters:<ol><li>key</li><li><em>(optional)</em> object map element (if omitted, the object map element is bound to <code>this</code>)</li></ol></td></tr>
<tr><td><code>retain</code></td><td><a href="language//book/language/fn-ptr.html">function pointer</a> to predicate (usually a <a href="language//book/language/fn-closure.html">closure</a>)</td><td>removes all elements (returning them) that do not return <code>true</code> when called with the predicate function taking the following parameters:<ol><li>key</li><li><em>(optional)</em> object map element (if omitted, the object map element is bound to <code>this</code>)</li></ol></td></tr>
<tr><td><code>filter</code></td><td><a href="language//book/language/fn-ptr.html">function pointer</a> to predicate (usually a <a href="language//book/language/fn-closure.html">closure</a>)</td><td>constructs a object map with all elements that return <code>true</code> when called with the predicate function taking the following parameters:<ol><li>key</li><li><em>(optional)</em> object map element (if omitted, the object map element is bound to <code>this</code>)</li></ol></td></tr>
<tr><td><code>to_json</code></td><td><em>none</em></td><td>returns a JSON representation of the object map (<a href="language//book/language/values-and-types.html"><code>()</code></a> is mapped to <code>null</code>, all other data types must be supported by JSON)</td></tr>
</tbody></table>
</div>
<h2 id="examples-10"><a class="header" href="#examples-10">Examples</a></h2>
<pre><code class="language-rust">let y = #{              // object map literal with 3 properties
    a: 1,
    bar: "hello",
    "baz!$@": 123.456,  // like JavaScript, you can use any string as property names...
    "": false,          // even the empty string!

    `hello`: 999,       // literal strings are also OK

    a: 42,              // &lt;- syntax error: duplicated property name

    `a${2}`: 42,        // &lt;- syntax error: property name cannot have string interpolation
};

y.a = 42;               // access via dot notation
y.a == 42;

y.baz!$@ = 42;          // &lt;- syntax error: only proper variable names allowed in dot notation
y."baz!$@" = 42;        // &lt;- syntax error: strings not allowed in dot notation
y["baz!$@"] = 42;       // access via index notation is OK

"baz!$@" in y == true;  // use 'in' to test if a property exists in the object map
("z" in y) == false;

ts.obj = y;             // object maps can be assigned completely (by value copy)
let foo = ts.list.a;
foo == 42;

let foo = #{ a:1, };    // trailing comma is OK

let foo = #{ a:1, b:2, c:3 }["a"];
let foo = #{ a:1, b:2, c:3 }.a;
foo == 1;

fn abc() {
<span class="boring">    { a:1, b:2, c:3 }  // a function returning an object map
</span>}

let foo = abc().b;
foo == 2;

let foo = y["a"];
foo == 42;

y.contains("a") == true;
y.contains("xyz") == false;

y.xyz == ();            // a non-existent property returns '()'
y["xyz"] == ();

y.len == ();            // an object map has no property getter function
y.len() == 3;           // method calls are OK

y.remove("a") == 1;     // remove property

y.len() == 2;
y.contains("a") == false;

for name in y.keys() {  // get an array of all the property names via 'keys'
    print(name);
}

for val in y.values() { // get an array of all the property values via 'values'
    print(val);
}

y.clear();              // empty the object map

y.len() == 0;</code></pre>
<h2 id="no-support-for-property-getters"><a class="header" href="#no-support-for-property-getters">No Support for Property Getters</a></h2>
<p>In order not to affect the speed of accessing properties in an object map, new
<a href="language//book/rust/getters-setters.html">property getters</a> cannot be registered because they conflict with the syntax of
property access.</p>
<p>A <a href="language//book/rust/getters-setters.html">property getter</a> function registered via <code>Engine::register_get</code>, for example,
for a <code>Map</code> will never be found – instead, the property will be looked up in the object map.</p>
<p>Properties should be registered as <em>methods</em> instead:</p>
<pre><code class="language-rust">map.len                 // access property 'len', returns '()' if not found

map.len()               // 'len' method - returns the number of properties

map.keys                // access property 'keys', returns '()' if not found

map.keys()              // 'keys' method - returns array of all property names

map.values              // access property 'values', returns '()' if not found

map.values()            // 'values' method - returns array of all property values</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="parse-an-object-map-from-json"><a class="header" href="#parse-an-object-map-from-json">Parse an Object Map from JSON</a></h1>
<h2 id="do-it-without-serde"><a class="header" href="#do-it-without-serde">Do It Without <code>serde</code></a></h2>
<div id="admonition-object-map-vs-json" class="admonition admonish-info side wide" role="note" aria-labelledby="admonition-object-map-vs-json-title">
<div class="admonition-title">
<div id="admonition-object-map-vs-json-title">
<p>Object map vs. JSON</p>
</div>
<a class="admonition-anchor-link" href="language/json.html#admonition-object-map-vs-json"></a>
</div>
<div>
<p>A valid JSON object hash does not start with a hash character <code>#</code> while a Rhai <a href="language//book/language/object-maps.html">object map</a> does.
That’s the only difference!</p>
</div>
</div>
<p>The syntax for an <a href="language//book/language/object-maps.html">object map</a> is extremely similar to the JSON representation of a object hash,
with the exception of <code>null</code> values which can technically be mapped to <a href="language//book/language/values-and-types.html"><code>()</code></a>.</p>
<p>Use the <code>Engine::parse_json</code> method to parse a piece of JSON into an <a href="language//book/language/object-maps.html">object map</a>.</p>
<pre><code class="language-rust">// JSON string - notice that JSON property names are always quoted
//               notice also that comments are acceptable within the JSON string
let json = r#"{
                "a": 1,                 // &lt;- this is an integer number
                "b": true,
                "c": 123.0,             // &lt;- this is a floating-point number
                "$d e f!": "hello",     // &lt;- any text can be a property name
                "^^^!!!": [1,42,"999"], // &lt;- value can be array or another hash
                "z": null               // &lt;- JSON 'null' value
              }"#;

// Parse the JSON expression as an object map
// Set the second boolean parameter to true in order to map 'null' to '()'
let map = engine.parse_json(json, true)?;

map.len() == 6;       // 'map' contains all properties in the JSON string

// Put the object map into a 'Scope'
let mut scope = Scope::new();
scope.push("map", map);

let result = engine.eval_with_scope::&lt;i64&gt;(&amp;mut scope, r#"map["^^^!!!"].len()"#)?;

result == 3;          // the object map is successfully used in the script</code></pre>
<div id="admonition-warning-must-be-object-hash" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-warning-must-be-object-hash-title">
<div class="admonition-title">
<div id="admonition-warning-must-be-object-hash-title">
<p>Warning: Must be object hash</p>
</div>
<a class="admonition-anchor-link" href="language/json.html#admonition-warning-must-be-object-hash"></a>
</div>
<div>
<p>The JSON text must represent a single object hash – i.e. must be wrapped within braces
<code>{</code>…<code>}</code>.</p>
<p>It cannot be a primitive type (e.g. number, string etc.).
Otherwise it cannot be converted into an <a href="language//book/language/object-maps.html">object map</a> and a type error is returned.</p>
</div>
</div>
<div id="admonition-representation-of-numbers" class="admonition admonish-note small" role="note" aria-labelledby="admonition-representation-of-numbers-title">
<div class="admonition-title">
<div id="admonition-representation-of-numbers-title">
<p>Representation of numbers</p>
</div>
<a class="admonition-anchor-link" href="language/json.html#admonition-representation-of-numbers"></a>
</div>
<div>
<p>JSON numbers are all floating-point while Rhai supports integers (<code>INT</code>) and floating-point (<code>FLOAT</code>)
(except under <a href="language//book/start/features.html"><code>no_float</code></a>).</p>
<p>Most common generators of JSON data distinguish between integer and floating-point values by always
serializing a floating-point number with a decimal point (i.e. <code>123.0</code> instead of <code>123</code> which is
assumed to be an integer).</p>
<p>This style can be used successfully with Rhai <a href="language//book/language/object-maps.html">object maps</a>.</p>
</div>
</div>
<p>Sub-objects are handled transparently by <code>Engine::parse_json</code>.</p>
<p>It is <em>not</em> necessary to replace <code>{</code> with <code>#{</code> in order to fake a Rhai <a href="language//book/language/object-maps.html">object map</a> literal.</p>
<pre><code class="language-rust">// JSON with sub-object 'b'.
let json = r#"{"a":1, "b":{"x":true, "y":false}}"#;

// 'parse_json' handles this just fine.
let map = engine.parse_json(json, false)?;

// 'map' contains two properties: 'a' and 'b'
map.len() == 2;</code></pre>
<div id="admonition-tldr--how-is-it-done" class="admonition admonish-question" role="note" aria-labelledby="admonition-tldr--how-is-it-done-title">
<div class="admonition-title">
<div id="admonition-tldr--how-is-it-done-title">
<p>TL;DR – How is it done?</p>
</div>
<a class="admonition-anchor-link" href="language/json.html#admonition-tldr--how-is-it-done"></a>
</div>
<div>
<p>Internally, <code>Engine::parse_json</code> <em>cheats</em> by treating the JSON text as a Rhai script.</p>
<p>That is why it even supports <a href="language//book/language/comments.html">comments</a> and arithmetic expressions in the JSON text,
although it is not a good idea to rely on non-standard JSON formats.</p>
<p>A <a href="language//book/engine/token-mapper.html">token remap filter</a> is used to convert <code>{</code> into <code>#{</code> and <code>null</code> to <a href="language//book/language/values-and-types.html"><code>()</code></a>.</p>
</div>
</div>
<h2 id="use-serde"><a class="header" href="#use-serde">Use <code>serde</code></a></h2>
<div id="admonition-see-also" class="admonition admonish-info side" role="note" aria-labelledby="admonition-see-also-title">
<div class="admonition-title">
<div id="admonition-see-also-title">
<p>See also</p>
</div>
<a class="admonition-anchor-link" href="language/json.html#admonition-see-also"></a>
</div>
<div>
<p>See <em><a href="language//book/rust/serde.html">Serialization/ Deserialization of <code>Dynamic</code> with <code>serde</code></a></em> for more details.</p>
</div>
</div>
<p>Remember, <code>Engine::parse_json</code> is nothing more than a <em>cheap</em> alternative to true JSON parsing.</p>
<p>If strict correctness is needed, or for more configuration possibilities, turn on the
<a href="language//book/start/features.html"><code>serde</code></a> feature to pull in <a href="https://crates.io/crates/serde"><code>serde</code></a> which enables
serialization and deserialization to/from multiple formats, including JSON.</p>
<p>Beware, though… the <a href="https://crates.io/crates/serde"><code>serde</code></a> crate is quite heavy.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="special-support-for-oop-via-object-maps"><a class="header" href="#special-support-for-oop-via-object-maps">Special Support for OOP via Object Maps</a></h1>
<div id="admonition-see-also" class="admonition admonish-info side" role="note" aria-labelledby="admonition-see-also-title">
<div class="admonition-title">
<div id="admonition-see-also-title">
<p>See also</p>
</div>
<a class="admonition-anchor-link" href="language/object-maps-oop.html#admonition-see-also"></a>
</div>
<div>
<p>See the pattern on <a href="language//book/patterns/oop.html"><em>Simulating Object-Oriented Programming</em></a> for more details.</p>
</div>
</div>
<p><a href="language//book/language/object-maps.html">Object maps</a> can be used to simulate <a href="language//book/patterns/oop.html">object-oriented programming (OOP)</a> by storing data
as properties and methods as properties holding <a href="language//book/language/fn-ptr.html">function pointers</a>.</p>
<p>If an <a href="language//book/language/object-maps.html">object map</a>’s property holds a <a href="language//book/language/fn-ptr.html">function pointer</a>, the property can simply be called like
a normal method in method-call syntax.</p>
<p>This is a <em>short-hand</em> to avoid the more verbose syntax of using the <code>call</code> function keyword.</p>
<p>When a property holding a <a href="language//book/language/fn-ptr.html">function pointer</a> or a <a href="language//book/language/fn-closure.html">closure</a> is called like a method, it is replaced
as a method call on the <a href="language//book/language/object-maps.html">object map</a> itself.</p>
<pre><code class="language-rust">let obj = #{
                data: 40,
                action: || this.data += x    // 'action' holds a closure
           };

obj.action(2);                               // calls the function pointer with 'this' bound to 'obj'

obj.call(obj.action, 2);                     // &lt;- the above de-sugars to this

obj.data == 42;

// To achieve the above with normal function pointer call will fail.

fn do_action(map, x) { map.data += x; }      // 'map' is a copy

obj.action = do_action;                      // &lt;- de-sugars to 'Fn("do_action")'

obj.action.call(obj, 2);                     // a copy of 'obj' is passed by value

obj.data == 42;                              // 'obj.data' is not changed</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="non-existent-property-handling-for-object-maps"><a class="header" href="#non-existent-property-handling-for-object-maps">Non-Existent Property Handling for Object Maps</a></h1>
<div id="admonition-requires-internals" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-requires-internals-title">
<div class="admonition-title">
<div id="admonition-requires-internals-title">
<p>Requires <code>internals</code></p>
</div>
<a class="admonition-anchor-link" href="language/object-maps-missing-prop.html#admonition-requires-internals"></a>
</div>
<div>
<p>This is an advanced feature that requires the <a href="language//book/start/features.html"><code>internals</code></a> feature to be enabled.</p>
</div>
</div>
<p>Normally, when a property is accessed from an <a href="language//book/language/object-maps.html">object map</a> that does not exist, <a href="language//book/language/values-and-types.html"><code>()</code></a> is returned.
Via <a href="language//book/engine/options.html"><code>Engine:: set_fail_on_invalid_map_property</code></a>, it is possible to make this an error
instead.</p>
<p>Other than that, it is possible to completely control this behavior via a special callback function
registered into an <a href="language//book/engine/hello-world.html"><code>Engine</code></a> via <code>on_map_missing_property</code>.</p>
<p>Using this callback, for instance, it is simple to instruct Rhai to create a new property in the
<a href="language//book/language/object-maps.html">object map</a> on the fly, possibly with a default value, when a non-existent property is accessed.</p>
<h2 id="function-signature-1"><a class="header" href="#function-signature-1">Function Signature</a></h2>
<p>The function signature passed to <a href="https://docs.rs/rhai/1.22.0/rhai/struct.Engine.html#method.on_map_missing_property"><code>Engine::on_map_missing_property</code></a> takes the following form.</p>
<blockquote>
<pre><code class="language-rust">Fn(map: &amp;mut Map, prop: &amp;str, context: EvalContext) -&gt; Result&lt;Target, Box&lt;EvalAltResult&gt;&gt;</code></pre>
</blockquote>
<p>where:</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th style="text-align: center">Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>map</code></td><td style="text-align: center"><a href="language//book/language/object-maps.html"><code>&amp;mut Map</code></a></td><td>the <a href="language//book/language/object-maps.html">object map</a> being accessed</td></tr>
<tr><td><code>prop</code></td><td style="text-align: center"><code>&amp;str</code></td><td>name of the property being accessed</td></tr>
<tr><td><code>context</code></td><td style="text-align: center"><a href="language//book/engine/eval-context.html"><code>EvalContext</code></a></td><td>the current <em>evaluation context</em></td></tr>
</tbody></table>
</div>
<h3 id="return-value-1"><a class="header" href="#return-value-1">Return value</a></h3>
<p>The return value is <code>Result&lt;Target, Box&lt;EvalAltResult&gt;&gt;</code>.</p>
<p><a href="https://docs.rs/rhai/latest/rhai/enum.Target.html"><code>Target</code></a> is an advanced type, available only under the <a href="language//book/start/features.html"><code>internals</code></a> feature, that represents a
<em>reference</em> to a <a href="language//book/language/dynamic.html"><code>Dynamic</code></a> value.</p>
<p>It can be used to point to a particular value within the <a href="language//book/language/object-maps.html">object map</a>.</p>
<h2 id="example-14"><a class="header" href="#example-14">Example</a></h2>
<pre><code class="language-rust">engine.on_map_missing_property(|map, prop, context| {
    match prop {
        "x" =&gt; {
            // The object-map can be modified in place
            map.insert("y".into(), (42_i64).into());

            // Return a mutable reference to an element
            let value_ref = map.get_mut("y").unwrap();
            Ok(value_ref.into())
        }
        "z" =&gt; {
            // Return a temporary value (not a reference)
            let value = Dynamic::from(100_i64);
            Ok(value.into())
        }
        // Return the standard property-not-found error
        _ =&gt; Err(EvalAltResult::ErrorPropertyNotFound(
                prop.to_string(), Position::NONE
             ).into()),
    }
});</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="timestamps"><a class="header" href="#timestamps">Timestamps</a></h1>
<p>Timestamps are provided by the <a href="language//book/rust/packages/builtin.html"><code>BasicTimePackage</code></a> (excluded when using a <a href="language//book/engine/raw.html">raw <code>Engine</code></a>)
via the <code>timestamp</code> function.</p>
<p>Timestamps are not available under <a href="language//book/start/features.html"><code>no_time</code></a> or <a href="language//book/start/features.html"><code>no_std</code></a>.</p>
<p>The Rust type of a timestamp is <code>std::time::Instant</code> (<a href="https://crates.io/crates/instant"><code>instant::Instant</code></a> in <a href="language//book/start/builds/wasm.html">WASM</a> builds).</p>
<p><a href="language//book/language/type-of.html"><code>type_of()</code></a> a timestamp returns <code>"timestamp"</code>.</p>
<h2 id="built-in-functions-4"><a class="header" href="#built-in-functions-4">Built-in Functions</a></h2>
<p>The following methods (defined in the <a href="language//book/rust/packages/builtin.html"><code>BasicTimePackage</code></a> but excluded when
using a <a href="language//book/engine/raw.html">raw <code>Engine</code></a>) operate on timestamps.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Parameter(s)</th><th>Description</th></tr></thead><tbody>
<tr><td><code>elapsed</code> method and property</td><td><em>none</em></td><td>returns the number of seconds since the timestamp</td></tr>
<tr><td><code>+</code> operator</td><td>number of seconds to add</td><td>returns a new timestamp with a specified number of seconds added</td></tr>
<tr><td><code>+=</code> operator</td><td>number of seconds to add</td><td>adds a specified number of seconds to the timestamp</td></tr>
<tr><td><code>-</code> operator</td><td>number of seconds to subtract</td><td>returns a new timestamp with a specified number of seconds subtracted</td></tr>
<tr><td><code>-=</code> operator</td><td>number of seconds to subtract</td><td>subtracts a specified number of seconds from the timestamp</td></tr>
<tr><td><code>-</code> operator</td><td><ol><li>later timestamp</li><li>earlier timestamp</li></ol></td><td>returns the number of seconds between the two timestamps</td></tr>
</tbody></table>
</div>
<p>The following methods are defined in the <a href="language//book/rust/packages/builtin.html"><code>LanguageCorePackage</code></a> but excluded
when using a <a href="language//book/engine/raw.html">raw <code>Engine</code></a>.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th style="text-align: center">Not available under</th><th>Parameter(s)</th><th>Description</th></tr></thead><tbody>
<tr><td><code>sleep</code></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_std</code></a></td><td>number of seconds to sleep</td><td>blocks the current thread for a specified number of seconds</td></tr>
</tbody></table>
</div>
<h2 id="examples-11"><a class="header" href="#examples-11">Examples</a></h2>
<pre><code class="language-rust">let now = timestamp();

// Do some lengthy operation...

if now.elapsed &gt; 30.0 {
    print("takes too long (over 30 seconds)!")
}</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="keywords"><a class="header" href="#keywords">Keywords</a></h1>
<p>The following are reserved keywords in Rhai.</p>
<div class="table-wrapper"><table><thead><tr><th>Active keywords</th><th>Reserved keywords</th><th>Usage</th><th style="text-align: center">Inactive under feature</th></tr></thead><tbody>
<tr><td><code>true</code>, <code>false</code></td><td></td><td><a href="language//book/language/constants.html">constants</a></td><td style="text-align: center"></td></tr>
<tr><td><a href="language//book/language/variables.html"><code>let</code></a>, <a href="language//book/language/constants.html"><code>const</code></a></td><td><code>var</code>, <code>static</code></td><td><a href="language//book/language/variables.html">variables</a></td><td style="text-align: center"></td></tr>
<tr><td><code>is_shared</code></td><td></td><td><em>shared</em> values</td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_closure</code></a></td></tr>
<tr><td></td><td><code>is</code></td><td>type checking</td><td style="text-align: center"></td></tr>
<tr><td><a href="language//book/language/if.html"><code>if</code></a>, <a href="language//book/language/if.html"><code>else</code></a></td><td><code>goto</code></td><td>control flow</td><td style="text-align: center"></td></tr>
<tr><td><a href="language//book/language/switch.html"><code>switch</code></a></td><td><code>match</code>, <code>case</code></td><td>switching and matching</td><td style="text-align: center"></td></tr>
<tr><td><a href="language//book/language/do.html"><code>do</code></a>, <a href="language//book/language/while.html"><code>while</code></a>, <a href="language//book/language/loop.html"><code>loop</code></a>, <code>until</code>, <a href="language//book/language/for.html"><code>for</code></a>, <a href="language//book/language/in.html"><code>in</code></a>, <code>continue</code>, <code>break</code></td><td></td><td>looping</td><td style="text-align: center"></td></tr>
<tr><td><a href="language//book/language/functions.html"><code>fn</code></a>, <a href="language//book/language/modules/export.html"><code>private</code></a>, <code>is_def_fn</code>, <code>this</code></td><td><code>public</code>, <code>protected</code>, <code>new</code></td><td><a href="language//book/language/functions.html">functions</a></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_function</code></a></td></tr>
<tr><td><a href="language//book/language/return.html"><code>return</code></a></td><td></td><td>return values</td><td style="text-align: center"></td></tr>
<tr><td><a href="language//book/language/throw.html"><code>throw</code></a>, <a href="language//book/language/try-catch.html"><code>try</code></a>, <a href="language//book/language/try-catch.html"><code>catch</code></a></td><td></td><td><a href="language//book/language/try-catch.html">throw/catch</a> <a href="language//book/language/throw.html">exceptions</a></td><td style="text-align: center"></td></tr>
<tr><td><a href="language//book/language/modules/import.html"><code>import</code></a>, <a href="language//book/language/modules/export.html"><code>export</code></a>, <code>as</code></td><td><code>use</code>, <code>with</code>, <code>module</code>, <code>package</code>, <code>super</code></td><td><a href="language//book/rust/modules/index.html">modules</a></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_module</code></a></td></tr>
<tr><td><a href="language//book/language/global.html"><code>global</code></a></td><td></td><td>automatic global <a href="language//book/rust/modules/index.html">module</a></td><td style="text-align: center"><a href="language//book/start/features.html"><code>no_function</code></a>, <a href="language//book/start/features.html"><code>no_module</code></a></td></tr>
<tr><td><a href="language//book/language/fn-ptr.html"><code>Fn</code></a>, <code>call</code>, <a href="language//book/language/fn-curry.html"><code>curry</code></a></td><td></td><td><a href="language//book/language/fn-ptr.html">function pointers</a></td><td style="text-align: center"></td></tr>
<tr><td></td><td><code>spawn</code>, <code>thread</code>, <code>go</code>, <code>sync</code>, <code>async</code>, <code>await</code>, <code>yield</code></td><td>threading/async</td><td style="text-align: center"></td></tr>
<tr><td><a href="language//book/language/type-of.html"><code>type_of</code></a>, <a href="language//book/language/print-debug.html"><code>print</code></a>, <a href="language//book/language/print-debug.html"><code>debug</code></a>, <a href="language//book/language/eval.html"><code>eval</code></a>, <code>is_def_var</code></td><td></td><td>special functions</td><td style="text-align: center"></td></tr>
<tr><td></td><td><code>default</code>, <code>void</code>, <code>null</code>, <code>nil</code></td><td>special values</td><td style="text-align: center"></td></tr>
</tbody></table>
</div><div id="admonition-warning" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="language/keywords.html#admonition-warning"></a>
</div>
<div>
<p>Keywords cannot become the name of a <a href="language//book/language/functions.html">function</a> or <a href="language//book/language/variables.html">variable</a>, even when they are
<a href="language//book/engine/disable-keywords.html">disabled</a>.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="statements"><a class="header" href="#statements">Statements</a></h1>
<p>Statements are terminated by semicolons <code>;</code> and they are mandatory,
except for the <em>last</em> statement in a <em>block</em> (enclosed by <code>{</code> … <code>}</code> pairs) where it can be omitted.</p>
<p>Semicolons can also be omitted for statement types that always end in a block – for example
the <a href="language//book/language/if.html"><code>if</code></a>, <a href="language//book/language/while.html"><code>while</code></a>, <a href="language//book/language/for.html"><code>for</code></a>,  <a href="language//book/language/loop.html"><code>loop</code></a> and <a href="language//book/language/switch.html"><code>switch</code></a> statements.</p>
<pre><code class="language-rust">let a = 42;             // normal assignment statement
let a = foo(42);        // normal function call statement
foo &lt; 42;               // normal expression as statement

let a = { 40 + 2 };     // 'a' is set to the value of the statements block, which is the value of the last statement
//              ^ the last statement does not require a terminating semicolon (but also works with it)
//                ^ semicolon required here to terminate the 'let' statement
//                  it is a syntax error without it, even though it ends with '}'
//                  that is because the 'let' statement doesn't end in a block

if foo { a = 42 }
//               ^ no need to terminate an if-statement with a semicolon
//                 that is because the 'if' statement ends in a block

4 * 10 + 2              // a statement which is just one expression - no ending semicolon is OK
                        // because it is the last statement of the whole block</code></pre>
<h2 id="statements-block"><a class="header" href="#statements-block">Statements Block</a></h2>
<h3 id="syntax-2"><a class="header" href="#syntax-2">Syntax</a></h3>
<p>Statements blocks in Rhai are formed by enclosing zero or more statements within braces <code>{</code>…<code>}</code>.</p>
<blockquote>
<p><code>{</code> <em>statement</em><code>;</code> <em>statement</em><code>;</code> … <em>statement</em> <code>}</code></p>
<p><code>{</code> <em>statement</em><code>;</code> <em>statement</em><code>;</code> … <em>statement</em><code>;</code> <code>}</code>      <code>// trailing semi-colon is optional</code></p>
</blockquote>
<h3 id="closed-scope"><a class="header" href="#closed-scope">Closed scope</a></h3>
<p>A statements block forms a <em>closed</em> scope.</p>
<p>Any <a href="language//book/language/variables.html">variable</a> and/or <a href="language//book/language/constants.html">constant</a> defined within the block are removed outside the block, so are
<a href="language//book/rust/modules/index.html">modules</a> <a href="language//book/language/modules/import.html">imported</a> within the block.</p>
<pre><code class="language-rust">let x = 42;
let y = 18;

{
    import "hello" as h;
    const HELLO = 99;
    let y = 0;

    h::greet();         // ok

    print(y + HELLO);   // prints 99 (y is zero)

        :    
        :    
}                       // &lt;- 'HELLO' and 'y' go away here...

print(x + y);           // prints 60 (y is still 18)

print(HELLO);           // &lt;- error: 'HELLO' not found

h::greet();             // &lt;- error: module 'h' not found</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="statement-expression"><a class="header" href="#statement-expression">Statement Expression</a></h1>
<div id="admonition-differs-from-rust" class="admonition admonish-warning side" role="note" aria-labelledby="admonition-differs-from-rust-title">
<div class="admonition-title">
<div id="admonition-differs-from-rust-title">
<p>Differs from Rust</p>
</div>
<a class="admonition-anchor-link" href="language/statement-expression.html#admonition-differs-from-rust"></a>
</div>
<div>
<p>This is different from Rust where, if the last statement is terminated by a semicolon, the block’s
return value defaults to <code>()</code>.</p>
</div>
</div>
<p>Like Rust, a statement can be used anywhere where an <em>expression</em> is expected.</p>
<p>These are called, for lack of a more creative name, “statement expressions.”</p>
<p>The <em>last</em> statement of a statements block is <em>always</em> the block’s return value when used as a statement,
<em>regardless</em> of whether it is terminated by a semicolon or not.</p>
<p>If the last statement has no return value (e.g. variable definitions, assignments) then it is
assumed to be <a href="language//book/language/values-and-types.html"><code>()</code></a>.</p>
<pre><code class="language-rust">let x = {
    let foo = calc_something();
    let bar = foo + baz;
    bar.further_processing();       // &lt;- this is the return value
};                                  // &lt;- semicolon is needed here...

// The above is equivalent to:
let result;
{
    let foo = calc_something();
    let bar = foo + baz;
    result = bar.further_processing();
}
let x = result;

// Statement expressions can be inserted inside normal expressions
// to avoid duplicated calculations
let x = foo(bar) + { let v = calc(); process(v, v.len, v.abs) } + baz;

// The above is equivalent to:
let foo_result = foo(bar);
let calc_result;
{
    let v = calc();
    result = process(v, v.len, v.abs);  // &lt;- avoid calculating 'v'
}
let x = foo_result + calc_result + baz;

// Statement expressions are also useful as function call arguments
// when side effects are desired
do_work(x, y, { let z = foo(x, y); print(z); z });
           // ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
           //       statement expression</code></pre>
<p>Statement expressions can be disabled via <a href="language//book/engine/options.html"><code>Engine::set_allow_statement_expression</code></a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="variables"><a class="header" href="#variables">Variables</a></h1>
<h2 id="valid-names"><a class="header" href="#valid-names">Valid Names</a></h2>
<div id="admonition-tip-unicode-standard-annex-31-identifiers" class="admonition admonish-tip side wide" role="note" aria-labelledby="admonition-tip-unicode-standard-annex-31-identifiers-title">
<div class="admonition-title">
<div id="admonition-tip-unicode-standard-annex-31-identifiers-title">
<p>Tip: Unicode Standard Annex #31 identifiers</p>
</div>
<a class="admonition-anchor-link" href="language/variables.html#admonition-tip-unicode-standard-annex-31-identifiers"></a>
</div>
<div>
<p>The <a href="language//book/start/features.html"><code>unicode-xid-ident</code></a> feature expands the allowed characters for variable names to the set defined by
<a href="http://www.unicode.org/reports/tr31/">Unicode Standard Annex #31</a>.</p>
</div>
</div>
<p>Variables in Rhai follow normal C naming rules – must contain only ASCII letters, digits and underscores <code>_</code>.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Character set</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>A</code> … <code>Z</code></td><td>Upper-case ASCII letters</td></tr>
<tr><td style="text-align: center"><code>a</code> … <code>z</code></td><td>Lower-case ASCII letters</td></tr>
<tr><td style="text-align: center"><code>0</code> … <code>9</code></td><td>Digit characters</td></tr>
<tr><td style="text-align: center"><code>_</code></td><td>Underscore character</td></tr>
</tbody></table>
</div>
<p>However, unlike Rust, a variable name must also contain at least one ASCII letter, and an ASCII
letter must come <em>before</em> any digits. In other words, the first character that is not an underscore <code>_</code>
must be an ASCII letter and not a digit.</p>
<div id="admonition-why-this-restriction" class="admonition admonish-question side wide" role="note" aria-labelledby="admonition-why-this-restriction-title">
<div class="admonition-title">
<div id="admonition-why-this-restriction-title">
<p>Why this restriction?</p>
</div>
<a class="admonition-anchor-link" href="language/variables.html#admonition-why-this-restriction"></a>
</div>
<div>
<p>To reduce confusion (and subtle bugs) because, for instance, <code>_1</code> can easily be misread (or mistyped)
as <code>-1</code>.</p>
<p>Rhai is dynamic without type checking, so there is no compiler to catch these typos.</p>
</div>
</div>
<p>Therefore, some names acceptable to Rust, like <code>_</code>, <code>_42foo</code>, <code>_1</code> etc., are not valid in Rhai.</p>
<p>For example: <code>c3po</code> and <code>_r2d2_</code> are valid variable names, but <code>3abc</code> and <code>____49steps</code> are not.</p>
<p>Variable names are case <em>sensitive</em>.</p>
<p>Variable names also cannot be the same as a <a href="language//book/appendix/keywords.html">keyword</a> (active or reserved).</p>
<div id="admonition-avoid-names-longer-than-11-letters-on-32-bit" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-avoid-names-longer-than-11-letters-on-32-bit-title">
<div class="admonition-title">
<div id="admonition-avoid-names-longer-than-11-letters-on-32-bit-title">
<p>Avoid names longer than 11 letters on 32-Bit</p>
</div>
<a class="admonition-anchor-link" href="language/variables.html#admonition-avoid-names-longer-than-11-letters-on-32-bit"></a>
</div>
<div>
<p>Rhai uses <a href="https://crates.io/crates/smartstring"><code>SmartString</code></a> which avoids allocations unless a string is over its internal limit
(23 ASCII characters on 64-bit, but only 11 ASCII characters on 32-bit).</p>
<p>On 64-bit systems, <em>most</em> variable names are shorter than 23 letters, so this is unlikely to become
an issue.</p>
<p>However, on 32-bit systems, take care to limit, where possible, variable names to within 11 letters.
This is particularly true for local variables inside a hot loop, where they are created and
destroyed in rapid succession.</p>
<pre><code class="language-js">// The following is SLOW on 32-bit
for my_super_loop_variable in array {
    print(`Super! ${my_super_loop_variable}`);
}

// Suggested revision:
for loop_var in array {
    print(`Super! ${loop_var}`);
}
</code></pre>
</div>
</div>
<h2 id="declare-a-variable"><a class="header" href="#declare-a-variable">Declare a Variable</a></h2>
<p>Variables are declared using the <code>let</code> keyword.</p>
<div id="admonition-tip-no-initial-value" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-no-initial-value-title">
<div class="admonition-title">
<div id="admonition-tip-no-initial-value-title">
<p>Tip: No initial value</p>
</div>
<a class="admonition-anchor-link" href="language/variables.html#admonition-tip-no-initial-value"></a>
</div>
<div>
<p>Variables do not have to be given an initial value.
If none is provided, it defaults to <a href="language//book/language/values-and-types.html"><code>()</code></a>.</p>
</div>
</div>
<div id="admonition-variables-are-local" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-variables-are-local-title">
<div class="admonition-title">
<div id="admonition-variables-are-local-title">
<p>Variables are local</p>
</div>
<a class="admonition-anchor-link" href="language/variables.html#admonition-variables-are-local"></a>
</div>
<div>
<p>A variable defined within a <a href="language/statements.html">statements block</a> is <em>local</em> to that block.</p>
</div>
</div>
<div id="admonition-tip-is_def_var" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-is_def_var-title">
<div class="admonition-title">
<div id="admonition-tip-is_def_var-title">
<p>Tip: <code>is_def_var</code></p>
</div>
<a class="admonition-anchor-link" href="language/variables.html#admonition-tip-is_def_var"></a>
</div>
<div>
<p>Use <code>is_def_var</code> to detect if a variable is defined.</p>
</div>
</div>
<pre><code class="language-rust">let x;              // ok - value is '()'
let x = 3;          // ok
let _x = 42;        // ok
let x_ = 42;        // also ok
let _x_ = 42;       // still ok

let _ = 123;        // &lt;- syntax error: illegal variable name
let _9 = 9;         // &lt;- syntax error: illegal variable name

let x = 42;         // variable is 'x', lower case
let X = 123;        // variable is 'X', upper case

print(x);           // prints 42
print(X);           // prints 123

{
    let x = 999;    // local variable 'x' shadows the 'x' in parent block

    print(x);       // prints 999
}

print(x);           // prints 42 - the parent block's 'x' is not changed

let x = 0;          // new variable 'x' shadows the old 'x'

print(x);           // prints 0

is_def_var("x") == true;

is_def_var("_x") == true;

is_def_var("y") == false;</code></pre>
<h2 id="use-before-definition"><a class="header" href="#use-before-definition">Use Before Definition</a></h2>
<p>By default, variables do not need to be defined before they are used.</p>
<p>If a variable accessed by a script is not defined previously within the same script, it is assumed
to be provided via an external custom <a href="language//book/engine/scope.html"><code>Scope</code></a> passed to the <a href="language//book/engine/hello-world.html"><code>Engine</code></a> via the
<code>Engine::XXX_with_scope</code> API.</p>
<pre><code class="language-rust">let engine = Engine::new();

engine.run("print(answer)")?;       // &lt;- error: variable 'answer' not found

// Create custom scope
let mut scope = Scope::new();

// Add variable to custom scope
scope.push("answer", 42_i64);

// Run with custom scope
engine.run_with_scope(&amp;mut scope,
    "print(answer)"                 // &lt;- prints 42
)?;</code></pre>
<div id="admonition-no-scope" class="admonition admonish-bug small" role="note" aria-labelledby="admonition-no-scope-title">
<div class="admonition-title">
<div id="admonition-no-scope-title">
<p>No <code>Scope</code></p>
</div>
<a class="admonition-anchor-link" href="language/variables.html#admonition-no-scope"></a>
</div>
<div>
<p>If no <a href="language//book/engine/scope.html"><code>Scope</code></a> is used to evaluate the script (e.g. when using <code>Engine::run</code> instead of
<code>Engine::run_with_scope</code>), an undefined variable causes a runtime error when accessed.</p>
</div>
</div>
<h2 id="strict-variables-mode"><a class="header" href="#strict-variables-mode">Strict Variables Mode</a></h2>
<p>With <a href="language//book/engine/options.html"><code>Engine::set_strict_variables</code></a>, it is possible to turn on
<a href="language//book/engine/strict-var.html"><em>Strict Variables</em></a> mode.</p>
<p>When <a href="language//book/engine/strict-var.html">strict variables</a> mode is active, accessing a variable not previously defined within
the same script directly causes a parse error when compiling the script.</p>
<pre><code class="language-rust">let x = 42;

print(x);           // prints 42

print(foo);         // &lt;- parse error under strict variables mode:
                    //    variable 'foo' is undefined</code></pre>
<div id="admonition-tip" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="language/variables.html#admonition-tip"></a>
</div>
<div>
<p>Turn on <a href="language//book/engine/strict-var.html">strict variables</a> mode if no <a href="language//book/engine/scope.html"><code>Scope</code></a> is to be provided for script evaluation runs.
This way, variable access errors are caught during compile time instead of runtime.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="variable-shadowing"><a class="header" href="#variable-shadowing">Variable Shadowing</a></h1>
<p>In Rhai, new <a href="language//book/language/variables.html">variables</a> automatically <em>shadow</em> existing ones of the same name.  There is no error.</p>
<p>This behavior is consistent with Rust.</p>
<pre><code class="language-rust">let x = 42;
let y = 123;

print(x);           // prints 42

let x = 88;         // &lt;- 'x' is shadowed here

// At this point, it is no longer possible to access the
// original 'x' on the first line...

print(x);           // prints 88

let x = 0;          // &lt;- 'x' is shadowed again

// At this point, it is no longer possible to access both
// previously-defined 'x'...

print(x);           // prints 0

{
    let x = 999;    // &lt;- 'x' is shadowed in a block
    
    print(x);       // prints 999
}

print(x);           // prints 0 - shadowing within the block goes away

print(y);           // prints 123 - 'y' is not shadowed</code></pre>
<div id="admonition-tip-disable-shadowing" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-disable-shadowing-title">
<div class="admonition-title">
<div id="admonition-tip-disable-shadowing-title">
<p>Tip: Disable shadowing</p>
</div>
<a class="admonition-anchor-link" href="language/shadow.html#admonition-tip-disable-shadowing"></a>
</div>
<div>
<p>Set <a href="language//book/engine/options.html"><code>Engine::set_allow_shadowing</code></a> to <code>false</code> to turn <a href="language//book/language/variables.html">variables</a> shadowing off.</p>
<pre><code class="language-rust">let x = 42;

let x = 123;        // &lt;- syntax error: variable 'x' already defined
                    //    when variables shadowing is disallowed</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="strict-variables-mode-1"><a class="header" href="#strict-variables-mode-1">Strict Variables Mode</a></h1>
<div id="admonition-scope-constants" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-scope-constants-title">
<div class="admonition-title">
<div id="admonition-scope-constants-title">
<p><code>Scope</code> constants</p>
</div>
<a class="admonition-anchor-link" href="engine/strict-var.html#admonition-scope-constants"></a>
</div>
<div>
<p><a href="engine//book/language/constants.html">Constants</a> in the external <a href="engine//book/engine/scope.html"><code>Scope</code></a>, when provided, count as definition.</p>
</div>
</div>
<p>By default, Rhai looks up access to <a href="engine//book/language/variables.html">variables</a> from the enclosing block scope,
working its way outwards until it reaches the top (global) level, then it
searches the <a href="engine//book/engine/scope.html"><code>Scope</code></a> (if any) that is passed into the <code>Engine::eval_with_scope</code> call.</p>
<p>Setting <a href="engine//book/engine/options.html"><code>Engine::set_strict_variables</code></a> to <code>true</code> turns on <em>Strict Variables Mode</em>,
which requires that:</p>
<ul>
<li>all <a href="engine//book/language/variables.html">variables</a>/<a href="engine//book/language/constants.html">constants</a> be defined within the same script before use,
or they must be <a href="engine//book/language/variables.html">variables</a>/<a href="engine//book/language/constants.html">constants</a> within the provided <a href="engine//book/engine/scope.html"><code>Scope</code></a> (if any),</li>
<li><a href="engine//book/rust/modules/index.html">modules</a> must be <a href="engine//book/language/modules/import.html">imported</a>, also within the same script, before use.</li>
</ul>
<p>Within <em>Strict Variables</em> mode, any attempt to access a <a href="engine//book/language/variables.html">variable</a> or <a href="engine//book/rust/modules/index.html">module</a> before
definition/<a href="engine//book/language/modules/import.html">import</a> results in a parse error.</p>
<p>This way, variable access errors (usually typos) are caught during compile time instead of runtime.</p>
<pre><code class="language-rust">let x = 42;

let y = x * z;          // &lt;- parse error under strict variables mode:
                        //    variable 'z' is not yet defined

let z = x + w;          // &lt;- parse error under strict variables mode:
                        //    variable 'w' is undefined

foo::bar::baz();        // &lt;- parse error under strict variables mode:
                        //    module 'foo' is not yet defined

fn test1() {
    foo::bar::baz();    // &lt;- parse error under strict variables mode:
                        //    module 'foo' is defined
}

import "my_module" as foo;

foo::bar::baz();        // ok!

print(foo::xyz);        // ok!

let x = abc::def;       // &lt;- parse error under strict variables mode:
                        //    module 'abc' is undefined

fn test2() {
    foo:bar::baz();     // ok!
}</code></pre>
<div id="admonition-tldr--why-isnt-there-a-_strict-functions_-mode" class="admonition admonish-question" role="note" aria-labelledby="admonition-tldr--why-isnt-there-a-_strict-functions_-mode-title">
<div class="admonition-title">
<div id="admonition-tldr--why-isnt-there-a-_strict-functions_-mode-title">
<p>TL;DR – Why isn’t there a <em>Strict Functions</em> mode?</p>
</div>
<a class="admonition-anchor-link" href="engine/strict-var.html#admonition-tldr--why-isnt-there-a-_strict-functions_-mode"></a>
</div>
<div>
<p>Why can’t function calls be checked for validity as well?</p>
<p>Rust functions in Rhai can be <a href="engine//book/rust/overloading.html">overloaded</a>. This means that multiple versions of
the same Rust function can exist under the same name, each accepting different numbers and/or types
of arguments.</p>
<p>While it is possible to check, at compile time, whether a <a href="engine//book/language/variables.html">variable</a> has been previously declared,
it is impossible to predict, at compile time, the <em>types</em> of arguments to function calls, unless the
function in question takes no parameters.</p>
<p>Therefore, it is impossible to check, at compile time, whether a function call is valid given that
the types of arguments are unknown until runtime. QED.</p>
<p>Not to mention that it is also impossible to check for a function called via a <a href="engine//book/language/fn-ptr.html">function pointer</a>.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="variable-definition-filter"><a class="header" href="#variable-definition-filter">Variable Definition Filter</a></h1>
<p>Although it is easy to disable variable <em><a href="engine//book/language/shadow.html">shadowing</a></em> via <a href="engine//book/engine/options.html"><code>Engine::set_allow_shadowing</code></a>,
sometimes more fine-grained control is needed.</p>
<p>For example, it may be the case that not <em>all</em> variables <a href="engine//book/language/shadow.html">shadowing</a> must be disallowed, but that only
a particular variable name needs to be protected and not others.  Or only under very special
circumstances.</p>
<p>Under this scenario, it is possible to provide a <em>filter</em> closure to the <a href="engine//book/engine/hello-world.html"><code>Engine</code></a> via
<a href="https://docs.rs/rhai/1.22.0/rhai/struct.Engine.html#method.on_def_var"><code>Engine::on_def_var</code></a> that traps variable definitions (i.e. <a href="engine//book/language/variables.html"><code>let</code></a> or
<a href="engine//book/language/constants.html"><code>const</code></a> statements) in a Rhai script.</p>
<p>The filter is called when a <a href="engine//book/language/variables.html">variable</a> or <a href="engine//book/language/constants.html">constant</a> is defined both during runtime and compilation.</p>
<pre><code class="language-rust">let mut engine = Engine::new();

// Register a variable definition filter.
engine.on_def_var(|is_runtime, info, context| {
    match (info.name, info.is_const) {
        // Disallow defining 'MYSTIC_NUMBER' as a constant!
        ("MYSTIC_NUMBER", true) =&gt; Ok(false),
        // Disallow defining constants not at global level!
        (_, true) if info.nesting_level &gt; 0 =&gt; Ok(false),
        // Throw any exception you like...
        ("hello", _) =&gt; Err(EvalAltResult::ErrorVariableNotFound(info.name.to_string(), Position::NONE).into()),
        // Return Ok(true) to continue with normal variable definition.
        _ =&gt; Ok(true)
    }
});</code></pre>
<h2 id="function-signature-2"><a class="header" href="#function-signature-2">Function Signature</a></h2>
<p>The function signature passed to <a href="https://docs.rs/rhai/1.22.0/rhai/struct.Engine.html#method.on_def_var"><code>Engine::on_def_var</code></a> takes the following form.</p>
<blockquote>
<pre><code class="language-rust">Fn(is_runtime: bool, info: VarDefInfo, context: EvalContext) -&gt; Result&lt;bool, Box&lt;EvalAltResult&gt;&gt;</code></pre>
</blockquote>
<p>where:</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th style="text-align: center">Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>is_runtime</code></td><td style="text-align: center"><code>bool</code></td><td><code>true</code> if the <a href="engine//book/language/variables.html">variable</a> definition event happens during runtime, <code>false</code> if during compilation</td></tr>
<tr><td><code>info</code></td><td style="text-align: center"><code>VarDefInfo</code></td><td>information on the <a href="engine//book/language/variables.html">variable</a> being defined</td></tr>
<tr><td><code>context</code></td><td style="text-align: center"><a href="engine//book/engine/eval-context.html"><code>EvalContext</code></a></td><td>the current <em>evaluation context</em></td></tr>
</tbody></table>
</div>
<p>and <code>VarDefInfo</code> is a simple <code>struct</code> that contains the following fields:</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th style="text-align: center">Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>name</code></td><td style="text-align: center"><code>&amp;str</code></td><td><a href="engine//book/language/variables.html">variable</a> name</td></tr>
<tr><td><code>is_const</code></td><td style="text-align: center"><code>bool</code></td><td><code>true</code> if the definition is a <a href="engine//book/language/constants.html"><code>const</code></a>; <code>false</code> if it is a <a href="engine//book/language/variables.html"><code>let</code></a></td></tr>
<tr><td><code>nesting_level</code></td><td style="text-align: center"><code>usize</code></td><td>the current nesting level; the global level is zero</td></tr>
<tr><td><code>will_shadow</code></td><td style="text-align: center"><code>bool</code></td><td>will this <a href="engine//book/language/variables.html">variable</a> <em><a href="engine//book/language/shadow.html">shadow</a></em> an existing <a href="engine//book/language/variables.html">variable</a> of the same name?</td></tr>
</tbody></table>
</div>
<p>and <a href="engine//book/engine/eval-context.html"><code>EvalContext</code></a> is a type that encapsulates the current <em>evaluation context</em>.</p>
<h3 id="return-value-2"><a class="header" href="#return-value-2">Return value</a></h3>
<p>The return value is <code>Result&lt;bool, Box&lt;EvalAltResult&gt;&gt;</code> where:</p>
<div class="table-wrapper"><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody>
<tr><td><code>Ok(true)</code></td><td>normal <a href="engine//book/language/variables.html">variable</a> definition should continue</td></tr>
<tr><td><code>Ok(false)</code></td><td><a href="engine//book/language/throw.html">throws</a> a runtime or compilation error</td></tr>
<tr><td><code>Err(Box&lt;EvalAltResult&gt;)</code></td><td>error that is reflected back to the <a href="engine//book/engine/hello-world.html"><code>Engine</code></a></td></tr>
</tbody></table>
</div><div id="admonition-error-during-compilation" class="admonition admonish-bug small" role="note" aria-labelledby="admonition-error-during-compilation-title">
<div class="admonition-title">
<div id="admonition-error-during-compilation-title">
<p>Error during compilation</p>
</div>
<a class="admonition-anchor-link" href="engine/def-var.html#admonition-error-during-compilation"></a>
</div>
<div>
<p>During compilation (i.e. when <code>is_runtime</code> is <code>false</code>), <code>EvalAltResult::ErrorParsing</code> is passed
through as the compilation error.</p>
<p>All other errors map to <code>ParseErrorType::ForbiddenVariable</code>.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="variable-resolver"><a class="header" href="#variable-resolver">Variable Resolver</a></h1>
<p>By default, Rhai looks up access to <a href="engine//book/language/variables.html">variables</a> from the enclosing block scope, working its way
outwards until it reaches the top (global) level, then it searches the <a href="engine//book/engine/scope.html"><code>Scope</code></a> that is passed into
the <code>Engine::eval</code> call.</p>
<p>There is a built-in facility for advanced users to <em>hook</em> into the <a href="engine//book/language/variables.html">variable</a> resolution service and
to override its default behavior.</p>
<p>To do so, provide a closure to the <a href="engine//book/engine/hello-world.html"><code>Engine</code></a> via <a href="https://docs.rs/rhai/1.22.0/rhai/struct.Engine.html#method.on_var"><code>Engine::on_var</code></a>.</p>
<pre><code class="language-rust">let mut engine = Engine::new();

// Register a variable resolver.
engine.on_var(|name, index, context| {
    match name {
        "MYSTIC_NUMBER" =&gt; Ok(Some(42_i64.into())),
        // Override a variable - make it not found even if it exists!
        "DO_NOT_USE" =&gt; Err(EvalAltResult::ErrorVariableNotFound(name.to_string(), Position::NONE).into()),
        // Silently maps 'chameleon' into 'innocent'.
        "chameleon" =&gt; context.scope().get_value("innocent").map(Some).ok_or_else(|| 
            EvalAltResult::ErrorVariableNotFound(name.to_string(), Position::NONE).into()
        ),
        // Return Ok(None) to continue with the normal variable resolution process.
        _ =&gt; Ok(None)
    }
});</code></pre>
<div id="admonition-benefits-of-using-a-variable-resolver" class="admonition admonish-info small" role="note" aria-labelledby="admonition-benefits-of-using-a-variable-resolver-title">
<div class="admonition-title">
<div id="admonition-benefits-of-using-a-variable-resolver-title">
<p>Benefits of using a variable resolver</p>
</div>
<a class="admonition-anchor-link" href="engine/var.html#admonition-benefits-of-using-a-variable-resolver"></a>
</div>
<div>
<ol>
<li>
<p>Avoid having to maintain a custom <a href="engine//book/engine/scope.html"><code>Scope</code></a> with all <a href="engine//book/language/variables.html">variables</a> regardless of need
(because a script may not use them all).</p>
</li>
<li>
<p><em>Short-circuit</em> <a href="engine//book/language/variables.html">variable</a> access, essentially overriding standard behavior.</p>
</li>
<li>
<p><em>Lazy-load</em> <a href="engine//book/language/variables.html">variables</a> when they are accessed, not up-front.
This benefits when the number of <a href="engine//book/language/variables.html">variables</a> is very large, when they are timing-dependent,
or when they are expensive to load.</p>
</li>
<li>
<p>Rename system <a href="engine//book/language/variables.html">variables</a> on a script-by-script basis without having to construct different <a href="engine//book/engine/scope.html"><code>Scope</code></a>’s.</p>
</li>
</ol>
</div>
</div>
<div id="admonition-returned-values-are-constants" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-returned-values-are-constants-title">
<div class="admonition-title">
<div id="admonition-returned-values-are-constants-title">
<p>Returned values are constants</p>
</div>
<a class="admonition-anchor-link" href="engine/var.html#admonition-returned-values-are-constants"></a>
</div>
<div>
<p><a href="engine//book/language/variables.html">Variable</a> values returned by a variable resolver are treated as <em><a href="engine//book/language/constants.html">constants</a></em>.</p>
<p>This is to avoid needing a mutable reference to the underlying data provider which may not be possible to obtain.</p>
<p>To change these <a href="engine//book/language/variables.html">variables</a>, better push them into a custom <a href="engine//book/engine/scope.html"><code>Scope</code></a> instead of
using a variable resolver.</p>
</div>
</div>
<div id="admonition-tip-returning-shared-values" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-returning-shared-values-title">
<div class="admonition-title">
<div id="admonition-tip-returning-shared-values-title">
<p>Tip: Returning shared values</p>
</div>
<a class="admonition-anchor-link" href="engine/var.html#admonition-tip-returning-shared-values"></a>
</div>
<div>
<p>It is possible to return a <em>shared</em> value from a variable resolver.</p>
<p>This is one way to implement <a href="engine//book/patterns/global-mutable-state.html">Mutable Global State</a>.</p>
</div>
</div>
<h2 id="function-signature-3"><a class="header" href="#function-signature-3">Function Signature</a></h2>
<p>The function signature passed to <a href="https://docs.rs/rhai/1.22.0/rhai/struct.Engine.html#method.on_var"><code>Engine::on_var</code></a> takes the following form.</p>
<blockquote>
<pre><code class="language-rust">Fn(name: &amp;str, index: usize, context: EvalContext) -&gt; Result&lt;Option&lt;Dynamic&gt;, Box&lt;EvalAltResult&gt;&gt;</code></pre>
</blockquote>
<p>where:</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th style="text-align: center">Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>name</code></td><td style="text-align: center"><code>&amp;str</code></td><td><a href="engine//book/language/variables.html">variable</a> name</td></tr>
<tr><td><code>index</code></td><td style="text-align: center"><code>usize</code></td><td>an offset from the bottom of the current <a href="engine//book/engine/scope.html"><code>Scope</code></a> that the <a href="engine//book/language/variables.html">variable</a> is supposed to reside.<br/>Offsets start from 1, with 1 meaning the last <a href="engine//book/language/variables.html">variable</a> in the current <a href="engine//book/engine/scope.html"><code>Scope</code></a>.  Essentially the correct <a href="engine//book/language/variables.html">variable</a> is at position <code>scope.len() - index</code>.<br/>If <code>index</code> is zero, then there is no pre-calculated offset position and a search through the current <a href="engine//book/engine/scope.html"><code>Scope</code></a> must be performed.</td></tr>
<tr><td><code>context</code></td><td style="text-align: center"><a href="engine//book/engine/eval-context.html"><code>EvalContext</code></a></td><td>mutable reference to the current <em>evaluation context</em></td></tr>
</tbody></table>
</div>
<p>and <a href="engine//book/engine/eval-context.html"><code>EvalContext</code></a> is a type that encapsulates the current <em>evaluation context</em>.</p>
<h3 id="return-value-3"><a class="header" href="#return-value-3">Return value</a></h3>
<p>The return value is <code>Result&lt;Option&lt;Dynamic&gt;, Box&lt;EvalAltResult&gt;&gt;</code> where:</p>
<div class="table-wrapper"><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody>
<tr><td><code>Ok(None)</code></td><td>normal <a href="engine//book/language/variables.html">variable</a> resolution process should continue, i.e. continue searching through the <a href="engine//book/engine/scope.html"><code>Scope</code></a></td></tr>
<tr><td><code>Ok(Some(value))</code></td><td>value (a <a href="engine//book/language/dynamic.html"><code>Dynamic</code></a>) of the <a href="engine//book/language/variables.html">variable</a>, treated as a <a href="engine//book/language/constants.html">constant</a></td></tr>
<tr><td><code>Err(Box&lt;EvalAltResult&gt;)</code></td><td>error that is reflected back to the <a href="engine//book/engine/hello-world.html"><code>Engine</code></a>, normally <code>EvalAltResult::ErrorVariableNotFound</code> to indicate that the <a href="engine//book/language/variables.html">variable</a> does not exist, but it can be any <code>EvalAltResult</code>.</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="constants"><a class="header" href="#constants">Constants</a></h1>
<p>Constants can be defined using the <code>const</code> keyword and are immutable.</p>
<pre><code class="language-rust">const X;            // 'X' is a constant '()'

const X = 40 + 2;   // 'X' is a constant 42

print(X * 2);       // prints 84

X = 123;            // &lt;- syntax error: constant modified</code></pre>
<div id="admonition-tip-naming" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-naming-title">
<div class="admonition-title">
<div id="admonition-tip-naming-title">
<p>Tip: Naming</p>
</div>
<a class="admonition-anchor-link" href="language/constants.html#admonition-tip-naming"></a>
</div>
<div>
<p>Constants follow the same naming rules as <a href="language//book/language/variables.html">variables</a>, but as a convention are often named with
all-capital letters.</p>
</div>
</div>
<h2 id="manually-add-constant-into-custom-scope"><a class="header" href="#manually-add-constant-into-custom-scope">Manually Add Constant into Custom Scope</a></h2>
<div id="admonition-tip-singleton" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-singleton-title">
<div class="admonition-title">
<div id="admonition-tip-singleton-title">
<p>Tip: Singleton</p>
</div>
<a class="admonition-anchor-link" href="language/constants.html#admonition-tip-singleton"></a>
</div>
<div>
<p>A constant value holding a <a href="language//book/rust/custom-types.html">custom type</a> essentially acts
as a <a href="language//book/patterns/singleton.html"><em>singleton</em></a>.</p>
</div>
</div>
<p>It is possible to add a constant into a custom <a href="language//book/engine/scope.html"><code>Scope</code></a> via <code>Scope::push_constant</code> so it’ll be
available to scripts running with that <a href="language//book/engine/scope.html"><code>Scope</code></a>.</p>
<pre><code class="language-rust">use rhai::{Engine, Scope};

#[derive(Debug, Clone)]
struct TestStruct(i64);                                     // custom type

let mut engine = Engine::new();

engine
    .register_type_with_name::&lt;TestStruct&gt;("TestStruct")    // register custom type
    .register_get("value", |obj: &amp;mut TestStruct| obj.0),   // property getter
    .register_fn("update_value",
        |obj: &amp;mut TestStruct, value: i64| obj.0 = value    // mutating method
    );

let script =
"
    MY_NUMBER.update_value(42);
    print(MY_NUMBER.value);
";

let ast = engine.compile(script)?;

let mut scope = Scope::new();                               // create custom scope

scope.push_constant("MY_NUMBER", TestStruct(123_i64));      // add constant variable

// Beware: constant objects can still be modified via a method call!
engine.run_ast_with_scope(&amp;mut scope, &amp;ast)?;               // prints 42

// Running the script directly, as below, is less desirable because
// the constant 'MY_NUMBER' will be propagated and copied into each usage
// during the script optimization step
engine.run_with_scope(&amp;mut scope, script)?;</code></pre>
<h2 id="caveat--constants-can-be-modified-via-rust"><a class="header" href="#caveat--constants-can-be-modified-via-rust">Caveat – Constants Can be Modified via Rust</a></h2>
<div id="admonition-tip-plugin-functions" class="admonition admonish-tip side wide" role="note" aria-labelledby="admonition-tip-plugin-functions-title">
<div class="admonition-title">
<div id="admonition-tip-plugin-functions-title">
<p>Tip: Plugin functions</p>
</div>
<a class="admonition-anchor-link" href="language/constants.html#admonition-tip-plugin-functions"></a>
</div>
<div>
<p>In <a href="language//book/plugins/function.html">plugin functions</a>, <code>&amp;mut</code> parameters disallow constant values by default.</p>
<p>This is different from the <code>Engine::register_XXX</code> API.</p>
<p>However, if a <a href="language//book/plugins/function.html">plugin function</a> is marked with <code>#[export_fn(pure)]</code> or <code>#[rhai_fn(pure)]</code>,
it is assumed <em>pure</em> (i.e. will not modify its arguments) and so constants are allowed.</p>
</div>
</div>
<p>A <a href="language//book/rust/custom-types.html">custom type</a> stored as a constant cannot be modified via script, but <em>can</em> be modified via a
registered Rust function that takes a first <code>&amp;mut</code> parameter – because there is no way for
Rhai to know whether the Rust function modifies its argument!</p>
<p>By default, native Rust functions with a first <code>&amp;mut</code> parameter always allow constants to be passed
to them. This is because using <code>&amp;mut</code> can avoid unnecessary cloning of a <a href="language//book/rust/custom-types.html">custom type</a> value, even
though it is actually not modified – for example returning the size of a collection type.</p>
<p>In line with intuition, Rhai is smart enough to always pass a <em>cloned copy</em> of a constant as the
first <code>&amp;mut</code> argument if the function is called in normal function call style.</p>
<p>If it is called as a <a href="language//book/rust/methods.html">method</a>, however, the Rust function will be able to modify the constant’s value.</p>
<p>Also, property <a href="language//book/rust/getters-setters.html">setters</a> and <a href="language//book/rust/indexers.html">indexers</a> are always assumed to mutate the first
<code>&amp;mut</code> parameter and so they always raise errors when passed constants by default.</p>
<pre><code class="language-rust">// For the below, assume 'increment' is a Rust function with '&amp;mut' first parameter

const X = 42;       // a constant

increment(X);       // call 'increment' in normal FUNCTION-CALL style
                    // since 'X' is constant, a COPY is passed instead

X == 42;            // value is 'X" is unchanged

X.increment();      // call 'increment' in METHOD-CALL style

X == 43;            // value of 'X' is changed!
                    // must use 'Dynamic::is_read_only' to check if parameter is constant

fn double() {
    this *= 2;      // function doubles 'this'
}

let y = 1;          // 'y' is not constant and mutable

y.double();         // double it...

y == 2;             // value of 'y' is changed as expected

X.double();         // since 'X' is constant, a COPY is passed to 'this'

X == 43;            // value of 'X' is unchanged by script</code></pre>
<div id="admonition-implications-on-script-optimization" class="admonition admonish-info small" role="note" aria-labelledby="admonition-implications-on-script-optimization-title">
<div class="admonition-title">
<div id="admonition-implications-on-script-optimization-title">
<p>Implications on script optimization</p>
</div>
<a class="admonition-anchor-link" href="language/constants.html#admonition-implications-on-script-optimization"></a>
</div>
<div>
<p>Rhai <em>assumes</em> that constants are never changed, even via Rust functions.</p>
<p>This is important to keep in mind because the script <a href="language//book/engine/optimize/index.html">optimizer</a>
by default does <em>constant propagation</em> as a operation.</p>
<p>If a constant is eventually modified by a Rust function, the optimizer will not see
the updated value and will propagate the original initialization value instead.</p>
<p><code>Dynamic::is_read_only</code> can be used to detect whether a <a href="language//book/language/dynamic.html"><code>Dynamic</code></a> value is constant or not within
a Rust function.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="automatic-global-module"><a class="header" href="#automatic-global-module">Automatic Global Module</a></h1>
<p>When a <a href="language//book/language/constants.html">constant</a> is declared at global scope, it is added to a special <a href="language//book/rust/modules/index.html">module</a> called <code>global</code>.</p>
<p><a href="language//book/language/functions.html">Functions</a> can access those <a href="language//book/language/constants.html">constants</a> via the special <code>global</code> <a href="language//book/rust/modules/index.html">module</a>.</p>
<p>Naturally, the automatic <code>global</code> <a href="language//book/rust/modules/index.html">module</a> is not available under <a href="language//book/start/features.html"><code>no_function</code></a> nor <a href="language//book/start/features.html"><code>no_module</code></a>.</p>
<pre><code class="language-rust">const CONSTANT = 42;        // this constant is automatically added to 'global'

{
    const INNER = 0;        // this constant is not at global level
}                           // &lt;- it goes away here

fn foo(x) {
    x *= global::CONSTANT;  // ok! 'CONSTANT' exists in 'global'

    x * global::INNER       // &lt;- error: constant 'INNER' not found in 'global'
}</code></pre>
<h2 id="override-global"><a class="header" href="#override-global">Override <code>global</code></a></h2>
<p>It is possible to <em>override</em> the automatic global <a href="language//book/rust/modules/index.html">module</a> by <a href="language//book/language/modules/import.html">importing</a> another <a href="language//book/rust/modules/index.html">module</a>
under the name <code>global</code>.</p>
<pre><code class="language-rust">import "foo" as global;     // import a module as 'global'

const CONSTANT = 42;        // this constant is NOT added to 'global'

fn foo(x) {
    global::CONSTANT        // &lt;- error: constant 'CONSTANT' not found in 'global'
}</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="assignments"><a class="header" href="#assignments">Assignments</a></h1>
<p>Value assignments to <a href="language//book/language/variables.html">variables</a> use the <code>=</code> symbol.</p>
<pre><code class="language-rust">let foo = 42;

bar = 123 * 456 - 789;

x[1][2].prop = do_calculation();</code></pre>
<h2 id="valid-assignment-targets"><a class="header" href="#valid-assignment-targets">Valid Assignment Targets</a></h2>
<p>The left-hand-side (LHS) of an assignment statement must be a valid
<em><a href="https://en.wikipedia.org/wiki/Value_(computer_science)">l-value</a></em>, which must be rooted in a
<a href="language//book/language/variables.html">variable</a>, potentially extended via indexing or properties.</p>
<div id="admonition-assigning-to-invalid-l-value" class="admonition admonish-bug" role="note" aria-labelledby="admonition-assigning-to-invalid-l-value-title">
<div class="admonition-title">
<div id="admonition-assigning-to-invalid-l-value-title">
<p>Assigning to invalid l-value</p>
</div>
<a class="admonition-anchor-link" href="language/assignment.html#admonition-assigning-to-invalid-l-value"></a>
</div>
<div>
<p>Expressions that are not valid <em>l-values</em> cannot be assigned to.</p>
<pre><code class="language-rust">x = 42;                 // variable is an l-value

x[1][2][3] = 42         // variable indexing is an l-value

x.prop1.prop2 = 42;     // variable property is an l-value

foo(x) = 42;            // syntax error: function call is not an l-value

x.foo() = 42;           // syntax error: method call is not an l-value

(x + y) = 42;           // syntax error: binary op is not an l-value</code></pre>
</div>
</div>
<h2 id="values-are-cloned"><a class="header" href="#values-are-cloned">Values are Cloned</a></h2>
<p>Values assigned are always <em>cloned</em>.
So care must be taken when assigning large data types (such as <a href="language//book/language/arrays.html">arrays</a>).</p>
<pre><code class="language-rust">x = y;                  // value of 'y' is cloned

x == y;                 // both 'x' and 'y' hold different copies
                        // of the same value</code></pre>
<h2 id="moving-data"><a class="header" href="#moving-data">Moving Data</a></h2>
<p>When assigning large data types, sometimes it is desirable to <em>move</em> the data instead of cloning it.</p>
<p>Use the <code>take</code> function (defined in the <a href="language//book/rust/packages/builtin.html"><code>LangCorePackage</code></a> but excluded
when using a <a href="language//book/engine/raw.html">raw <code>Engine</code></a>) to <em>move</em> data.</p>
<h3 id="the-original-variable-is-left-with-"><a class="header" href="#the-original-variable-is-left-with-">The original variable is left with <code>()</code></a></h3>
<pre><code class="language-rust">x = take(y);            // value of 'y' is moved to 'x'

y == ();                // 'y' now holds '()'

x != y;                 // 'x' holds the original value of 'y'</code></pre>
<h3 id="return-large-data-types-from-functions"><a class="header" href="#return-large-data-types-from-functions">Return large data types from functions</a></h3>
<p><code>take</code> is convenient when returning large data types from a <a href="language//book/language/functions.html">function</a>.</p>
<pre><code class="language-rust">fn get_large_value_naive() {
    let large_result = do_complex_calculation();

    large_result.done = true;

    // Return a cloned copy of the result, then the
    // local variable 'large_result' is thrown away!
    large_result
}

fn get_large_value_smart() {
    let large_result = do_complex_calculation();

    large_result.done = true;

    // Return the result without cloning!
    // Method style call is also OK.
    large_result.take()
}</code></pre>
<h3 id="assigning-large-data-types-to-object-map-properties"><a class="header" href="#assigning-large-data-types-to-object-map-properties">Assigning large data types to object map properties</a></h3>
<p><code>take</code> is useful when assigning large data types to <a href="language//book/language/object-maps.html">object map</a> properties.</p>
<pre><code class="language-rust">let x = [];

// Build a large array
for n in 0..1000000 { x += n; }

// The following clones the large array from 'x'.
// Both 'my_object.my_property' and 'x' now hold exact copies
// of the same large array!
my_object.my_property = x;

// Move it to object map property via 'take' without cloning.
// 'x' now holds '()'.
my_object.my_property = x.take();

// Without 'take', the following must be done to avoid cloning:
my_object.my_property = [];

for n in 0..1000000 { my_object.my_property += n; }</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="compound-assignments"><a class="header" href="#compound-assignments">Compound Assignments</a></h1>
<p>Compound assignments are assignments with a <a href="language//book/appendix/operators.html#operators">binary operator</a> attached.</p>
<pre><code class="language-rust">number += 8;            // number = number + 8

number -= 7;            // number = number - 7

number *= 6;            // number = number * 6

number /= 5;            // number = number / 5

number %= 4;            // number = number % 4

number **= 3;           // number = number ** 3

number &lt;&lt;= 2;           // number = number &lt;&lt; 2

number &gt;&gt;= 1;           // number = number &gt;&gt; 1

number &amp;= 0x00ff;       // number = number &amp; 0x00ff;

number |= 0x00ff;       // number = number | 0x00ff;

number ^= 0x00ff;       // number = number ^ 0x00ff;</code></pre>
<h2 id="the-flexible-"><a class="header" href="#the-flexible-">The Flexible <code>+=</code></a></h2>
<p>The the <code>+</code> and <code>+=</code> operators are often <a href="language//book/rust/overloading.html">overloaded</a> to perform build-up
operations for different data types.</p>
<h3 id="build-strings"><a class="header" href="#build-strings">Build strings</a></h3>
<pre><code class="language-rust">let my_str = "abc";

my_str += "ABC";
my_str += 12345;

my_str == "abcABC12345"</code></pre>
<h3 id="concatenate-arrays"><a class="header" href="#concatenate-arrays">Concatenate arrays</a></h3>
<pre><code class="language-rust">let my_array = [1, 2, 3];

my_array += [4, 5];

my_array == [1, 2, 3, 4, 5];</code></pre>
<h3 id="concatenate-blobs"><a class="header" href="#concatenate-blobs">Concatenate BLOB’s</a></h3>
<pre><code class="language-rust">let my_blob = blob(3, 0x42);

my_blob += blob(5, 0x89);

my_blob.to_string() == "[4242428989898989]";</code></pre>
<h3 id="mix-two-object-maps-together"><a class="header" href="#mix-two-object-maps-together">Mix two object maps together</a></h3>
<pre><code class="language-rust">let my_obj = #{ a:1, b:2 };

my_obj += #{ c:3, d:4, e:5 };

my_obj == #{ a:1, b:2, c:3, d:4, e:5 };</code></pre>
<h3 id="add-seconds-to-timestamps"><a class="header" href="#add-seconds-to-timestamps">Add seconds to timestamps</a></h3>
<pre><code class="language-rust">let now = timestamp();

now += 42.0;

(now - timestamp()).round() == 42.0;</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="logic-operators"><a class="header" href="#logic-operators">Logic Operators</a></h1>
<h2 id="comparison-operators"><a class="header" href="#comparison-operators">Comparison Operators</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Operator</th><th>Description<br/>(<code>x</code> <em>operator</em> <code>y</code>)</th><th style="text-align: center"><code>x</code>, <code>y</code> same type or are numeric</th><th style="text-align: center"><code>x</code>, <code>y</code> different types</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>==</code></td><td><code>x</code> is equals to <code>y</code></td><td style="text-align: center">error if not defined</td><td style="text-align: center"><code>false</code> if not defined</td></tr>
<tr><td style="text-align: center"><code>!=</code></td><td><code>x</code> is not equals to <code>y</code></td><td style="text-align: center">error if not defined</td><td style="text-align: center"><code>true</code> if not defined</td></tr>
<tr><td style="text-align: center"><code>&gt;</code></td><td><code>x</code> is greater than <code>y</code></td><td style="text-align: center">error if not defined</td><td style="text-align: center"><code>false</code> if not defined</td></tr>
<tr><td style="text-align: center"><code>&gt;=</code></td><td><code>x</code> is greater than or equals to <code>y</code></td><td style="text-align: center">error if not defined</td><td style="text-align: center"><code>false</code> if not defined</td></tr>
<tr><td style="text-align: center"><code>&lt;</code></td><td><code>x</code> is less than <code>y</code></td><td style="text-align: center">error if not defined</td><td style="text-align: center"><code>false</code> if not defined</td></tr>
<tr><td style="text-align: center"><code>&lt;=</code></td><td><code>x</code> is less than or equals to <code>y</code></td><td style="text-align: center">error if not defined</td><td style="text-align: center"><code>false</code> if not defined</td></tr>
</tbody></table>
</div>
<p>Comparison operators between most values of the same type are built in for all <a href="language//book/language/values-and-types.html">standard types</a>.</p>
<p>Others are defined in the <a href="language//book/rust/packages/builtin.html"><code>LogicPackage</code></a> but excluded when using a <a href="language//book/engine/raw.html">raw <code>Engine</code></a>.</p>
<h3 id="floating-point-numbers-interoperate-with-integers"><a class="header" href="#floating-point-numbers-interoperate-with-integers">Floating-point numbers interoperate with integers</a></h3>
<p>Comparing a floating-point number (<code>FLOAT</code>) with an integer is also supported.</p>
<pre><code class="language-rust">42 == 42.0;         // true

42.0 == 42;         // true

42.0 &gt; 42;          // false

42 &gt;= 42.0;         // true

42.0 &lt; 42;          // false</code></pre>
<h3 id="decimal-numbers-interoperate-with-integers"><a class="header" href="#decimal-numbers-interoperate-with-integers">Decimal numbers interoperate with integers</a></h3>
<p>Comparing a <a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a> number with an integer is also supported.</p>
<pre><code class="language-rust">let d = parse_decimal("42");

42 == d;            // true

d == 42;            // true

d &gt; 42;             // false

42 &gt;= d;            // true

d &lt; 42;             // false</code></pre>
<h3 id="strings-interoperate-with-characters"><a class="header" href="#strings-interoperate-with-characters">Strings interoperate with characters</a></h3>
<p>Comparing a <a href="language//book/language/strings-chars.html">string</a> with a <a href="language//book/language/strings-chars.html">character</a> is also supported, with the character first turned into a
<a href="language//book/language/strings-chars.html">string</a> before performing the comparison.</p>
<pre><code class="language-rust">'x' == "x";         // true

"" &lt; 'a';           // true

'x' &gt; "hello";      // false</code></pre>
<h3 id="comparing-different-types-defaults-to-false"><a class="header" href="#comparing-different-types-defaults-to-false">Comparing different types defaults to <code>false</code></a></h3>
<p>Comparing two values of <em>different</em> data types defaults to <code>false</code> unless the appropriate operator
functions have been registered.</p>
<p>The exception is <code>!=</code> (not equals) which defaults to <code>true</code>. This is in line with intuition.</p>
<pre><code class="language-rust">42 &gt; "42";          // false: i64 cannot be compared with string

42 &lt;= "42";         // false: i64 cannot be compared with string

let ts = new_ts();  // custom type

ts == 42;           // false: different types cannot be compared

ts != 42;           // true: different types cannot be compared

ts == ts;           // error: '==' not defined for the custom type</code></pre>
<h3 id="safety-valve-comparing-different-numeric-types-has-no-default"><a class="header" href="#safety-valve-comparing-different-numeric-types-has-no-default">Safety valve: Comparing different <em>numeric</em> types has no default</a></h3>
<p>Beware that the above default does <em>NOT</em> apply to numeric values of different types
(e.g. comparison between <code>i64</code> and <code>u16</code>, <code>i32</code> and <code>f64</code>) – when multiple numeric types are
used it is too easy to mess up and for subtle errors to creep in.</p>
<pre><code class="language-rust">// Assume variable 'x' = 42_u16, 'y' = 42_u16 (both types of u16)

x == y;             // true: '==' operator for u16 is built-in

x == "hello";       // false: different non-numeric operand types default to false

x == 42;            // error: ==(u16, i64) not defined, no default for numeric types

42 == y;            // error: ==(i64, u16) not defined, no default for numeric types</code></pre>
<h3 id="caution-beware-operators-for-custom-types"><a class="header" href="#caution-beware-operators-for-custom-types">Caution: Beware operators for custom types</a></h3>
<div id="admonition-tip-always-the-full-set" class="admonition admonish-tip side wide" role="note" aria-labelledby="admonition-tip-always-the-full-set-title">
<div class="admonition-title">
<div id="admonition-tip-always-the-full-set-title">
<p>Tip: Always the full set</p>
</div>
<a class="admonition-anchor-link" href="language/logic.html#admonition-tip-always-the-full-set"></a>
</div>
<div>
<p>It is strongly recommended that, when defining operators for <a href="language//book/rust/custom-types.html">custom types</a>, always define the
<strong>full set</strong> of six operators together, or at least the <code>==</code> and <code>!=</code> pair.</p>
</div>
</div>
<p>Operators are completely separate from each other.  For example:</p>
<ul>
<li>
<p><code>!=</code> does not equal <code>!(==)</code></p>
</li>
<li>
<p><code>&gt;</code> does not equal <code>!(&lt;=)</code></p>
</li>
<li>
<p><code>&lt;=</code> does not equal <code>&lt;</code> plus <code>==</code></p>
</li>
<li>
<p><code>&lt;=</code> does not imply <code>&lt;</code></p>
</li>
</ul>
<p>Therefore, if a <a href="language//book/rust/custom-types.html">custom type</a> misses an <a href="language//book/appendix/operators.html#operators">operator</a> definition, it simply raises an error
or returns the default.</p>
<p>This behavior can be counter-intuitive.</p>
<pre><code class="language-rust">let ts = new_ts();  // custom type with '&lt;=' and '==' defined

ts &lt;= ts;           // true: '&lt;=' defined

ts &lt; ts;            // error: '&lt;' not defined, even though '&lt;=' is

ts == ts;           // true: '==' defined

ts != ts;           // error: '!=' not defined, even though '==' is</code></pre>
<h2 id="boolean-operators"><a class="header" href="#boolean-operators">Boolean Operators</a></h2>
<div id="admonition-note" class="admonition admonish-note side" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="language/logic.html#admonition-note"></a>
</div>
<div>
<p>All boolean operators are <a href="language//book/engine/builtin.html">built in</a> for the <code>bool</code> data type.</p>
</div>
</div>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Operator</th><th style="text-align: center">Description</th><th style="text-align: center">Arity</th><th style="text-align: center">Short-circuits?</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>!</code> <em>(prefix)</em></td><td style="text-align: center"><em>NOT</em></td><td style="text-align: center">unary</td><td style="text-align: center">no</td></tr>
<tr><td style="text-align: center"><code>&amp;&amp;</code></td><td style="text-align: center"><em>AND</em></td><td style="text-align: center">binary</td><td style="text-align: center"><strong>yes</strong></td></tr>
<tr><td style="text-align: center"><code>&amp;</code></td><td style="text-align: center"><em>AND</em></td><td style="text-align: center">binary</td><td style="text-align: center">no</td></tr>
<tr><td style="text-align: center"><code>||</code></td><td style="text-align: center"><em>OR</em></td><td style="text-align: center">binary</td><td style="text-align: center"><strong>yes</strong></td></tr>
<tr><td style="text-align: center"><code>|</code></td><td style="text-align: center"><em>OR</em></td><td style="text-align: center">binary</td><td style="text-align: center">no</td></tr>
</tbody></table>
</div>
<p>Double boolean operators <code>&amp;&amp;</code> and <code>||</code> <em>short-circuit</em> – meaning that the second operand will not be evaluated
if the first one already proves the condition wrong.</p>
<p>Single boolean operators <code>&amp;</code> and <code>|</code> always evaluate both operands.</p>
<pre><code class="language-rust">a() || b();         // b() is not evaluated if a() is true

a() &amp;&amp; b();         // b() is not evaluated if a() is false

a() | b();          // both a() and b() are evaluated

a() &amp; b();          // both a() and b() are evaluated</code></pre>
<h2 id="null-coalescing-operator"><a class="header" href="#null-coalescing-operator">Null-Coalescing Operator</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Operator</th><th style="text-align: center">Description</th><th style="text-align: center">Arity</th><th style="text-align: center">Short-circuits?</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>??</code></td><td style="text-align: center">Null-coalesce</td><td style="text-align: center">binary</td><td style="text-align: center">yes</td></tr>
</tbody></table>
</div>
<p>The null-coalescing operator (<code>??</code>) returns the first operand if it is not <a href="language//book/language/values-and-types.html"><code>()</code></a>, or the second
operand if the first operand is <a href="language//book/language/values-and-types.html"><code>()</code></a>.</p>
<p>It <em>short-circuits</em>  – meaning that the second operand will not be evaluated if the first
operand is not <a href="language//book/language/values-and-types.html"><code>()</code></a>.</p>
<pre><code class="language-rust">a ?? b              // returns 'a' if it is not (), otherwise 'b'

a() ?? b();         // b() is only evaluated if a() is ()</code></pre>
<div id="admonition-tip-default-value-for-object-map-property" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-default-value-for-object-map-property-title">
<div class="admonition-title">
<div id="admonition-tip-default-value-for-object-map-property-title">
<p>Tip: Default value for object map property</p>
</div>
<a class="admonition-anchor-link" href="language/logic.html#admonition-tip-default-value-for-object-map-property"></a>
</div>
<div>
<p>Use the null-coalescing operator to implement default values for non-existent <a href="language//book/language/object-maps.html">object map</a> properties.</p>
<pre><code class="language-rust">let map = #{ foo: 42 };

// Regular property access
let x = map.foo;            // x == 42

// Non-existent property
let x = map.bar;            // x == ()

// Default value for property
let x = map.bar ?? 42;      // x == 42</code></pre>
</div>
</div>
<h3 id="short-circuit-loops-and-early-returns"><a class="header" href="#short-circuit-loops-and-early-returns">Short-circuit loops and early returns</a></h3>
<p>The following statements are allowed to follow the null-coalescing operator:</p>
<ul>
<li><code>break</code></li>
<li><code>continue</code></li>
<li><a href="language//book/language/return.html"><code>return</code></a></li>
<li><a href="language//book/language/throw.html"><code>throw</code></a></li>
</ul>
<p>This means that you can use the null-coalescing operator to short-circuit loops and/or
early-return from functions when the value tested is <a href="language//book/language/values-and-types.html"><code>()</code></a>.</p>
<pre><code class="language-rust">let total = 0;

for value in list {
    // Whenever 'calculate' returns '()', the loop stops
    total += calculate(value) ?? break;
}</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="in-operator"><a class="header" href="#in-operator">In Operator</a></h1>
<div id="admonition-trivia" class="admonition admonish-question side wide" role="note" aria-labelledby="admonition-trivia-title">
<div class="admonition-title">
<div id="admonition-trivia-title">
<p>Trivia</p>
</div>
<a class="admonition-anchor-link" href="language/in.html#admonition-trivia"></a>
</div>
<div>
<p>The <code>in</code> operator is simply syntactic sugar for a call to the <code>contains</code> function.</p>
<p>Similarly, <code>!in</code> is a call to <code>!contains</code>.</p>
</div>
</div>
<p>The <code>in</code> operator is used to check for <em>containment</em> – i.e. whether a particular collection
data type <em>contains</em> a particular item.</p>
<p>Similarly, <code>!in</code> is used to check for non-existence – i.e. it is <code>true</code> if a particular
collection data type does <em>not</em> contain a particular item.</p>
<pre><code class="language-rust">42 in array;

array.contains(42);     // &lt;- the above is equivalent to this

123 !in array;

!array.contains(123);   // &lt;- the above is equivalent to this</code></pre>
<h2 id="built-in-support-for-standard-data-types"><a class="header" href="#built-in-support-for-standard-data-types">Built-in Support for Standard Data Types</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Data type</th><th style="text-align: center">Check for</th></tr></thead><tbody>
<tr><td style="text-align: center">Numeric <a href="language//book/language/ranges.html">range</a></td><td style="text-align: center">integer number</td></tr>
<tr><td style="text-align: center"><a href="language//book/language/arrays.html">Array</a></td><td style="text-align: center">contained item</td></tr>
<tr><td style="text-align: center"><a href="language//book/language/object-maps.html">Object map</a></td><td style="text-align: center">property name</td></tr>
<tr><td style="text-align: center"><a href="language//book/language/strings-chars.html">String</a></td><td style="text-align: center"><a href="language//book/language/strings-chars.html">sub-string</a> or <a href="language//book/language/strings-chars.html">character</a></td></tr>
</tbody></table>
</div>
<h2 id="examples-12"><a class="header" href="#examples-12">Examples</a></h2>
<pre><code class="language-rust">let array = [1, "abc", 42, ()];

42 in array == true;                // check array for item

let map = #{
    foo: 42,
    bar: true,
    baz: "hello"
};

"foo" in map == true;               // check object map for property name

'w' in "hello, world!" == true;     // check string for character

'w' !in "hello, world!" == false;

"wor" in "hello, world" == true;    // check string for sub-string

42 in -100..100 == true;            // check range for number</code></pre>
<h2 id="array-items-comparison"><a class="header" href="#array-items-comparison">Array Items Comparison</a></h2>
<p>The default implementation of the <code>in</code> operator for <a href="language//book/language/arrays.html">arrays</a> uses the <code>==</code> operator (if defined)
to compare items.</p>
<div id="admonition--defaults-to-false" class="admonition admonish-warning small" role="note" aria-labelledby="admonition--defaults-to-false-title">
<div class="admonition-title">
<div id="admonition--defaults-to-false-title">
<p><code>==</code> defaults to <code>false</code></p>
</div>
<a class="admonition-anchor-link" href="language/in.html#admonition--defaults-to-false"></a>
</div>
<div>
<p>For a <a href="language//book/rust/custom-types.html">custom type</a>, <code>==</code> defaults to <code>false</code> when comparing it with a value of of the same type.</p>
<p>See the section on <a href="language/logic.html"><em>Logic Operators</em></a> for more details.</p>
</div>
</div>
<pre><code class="language-rust">let ts = new_ts();                  // assume 'new_ts' returns a custom type

let array = [1, 2, 3, ts, 42, 999];
//                    ^^ custom type

42 in array == true;                // 42 cannot be compared with 'ts'
                                    // so it defaults to 'false'
                                    // because == operator is not defined</code></pre>
<h2 id="custom-implementation-of-contains"><a class="header" href="#custom-implementation-of-contains">Custom Implementation of <code>contains</code></a></h2>
<p>The <code>in</code> and <code>!in</code> operators map directly to a call to a function <code>contains</code> with the two operands switched.</p>
<pre><code class="language-rust">// This expression...
item in container

// maps to this...
contains(container, item)

// or...
container.contains(item)</code></pre>
<p>Support for the <code>in</code> and <code>!in</code> operators can be easily extended to other types by registering a
custom binary function named <code>contains</code> with the correct parameter types.</p>
<p>Since <code>!in</code> maps to <code>!(... in ...)</code>, <code>contains</code> is enough to support both operators.</p>
<pre><code class="language-rust">let mut engine = Engine::new();

engine.register_type::&lt;TestStruct&gt;()
      .register_fn("new_ts", || TestStruct::new())
      .register_fn("contains", |ts: &amp;mut TestStruct, item: i64| -&gt; bool {
          // Remember the parameters are switched from the 'in' expression
          ts.contains(item)
      });

// Now the 'in' operator can be used for 'TestStruct' and integer

engine.run(
r#"
    let ts = new_ts();

    if 42 in ts {                   // this calls 'ts.contains(42)'
        print("I got 42!");
    } else if 123 !in ts {          // this calls '!ts.contains(123)'
        print("I ain't got 123!");
    }

    let err = "hello" in ts;        // &lt;- runtime error: 'contains' not found
                                    //    for 'TestStruct' and string
"#)?;</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="if-statement"><a class="header" href="#if-statement">If Statement</a></h1>
<p><code>if</code> statements follow C syntax.</p>
<pre><code class="language-rust">if foo(x) {
    print("It's true!");
} else if bar == baz {
    print("It's true again!");
} else if baz.is_foo() {
    print("Yet again true.");
} else if foo(bar - baz) {
    print("True again... this is getting boring.");
} else {
    print("It's finally false!");
}</code></pre>
<div id="admonition-braces-are-mandatory" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-braces-are-mandatory-title">
<div class="admonition-title">
<div id="admonition-braces-are-mandatory-title">
<p>Braces are mandatory</p>
</div>
<a class="admonition-anchor-link" href="language/if.html#admonition-braces-are-mandatory"></a>
</div>
<div>
<p>Unlike C, the condition expression does <em>not</em> need to be enclosed in parentheses <code>(</code>…<code>)</code>, but all
branches of the <code>if</code> statement must be enclosed within braces <code>{</code>…<code>}</code>, even when there is only
one statement inside the branch.</p>
<p>Like Rust, there is no ambiguity regarding which <code>if</code> clause a branch belongs to.</p>
<pre><code class="language-rust">// Rhai is not C!
if (decision) print(42);
//            ^ syntax error, expecting '{'</code></pre>
</div>
</div>
<h2 id="if-expression"><a class="header" href="#if-expression">If Expression</a></h2>
<p>Like Rust, <code>if</code> statements can also be used as <em>expressions</em>, replacing the <code>? :</code> conditional
operators in other C-like languages.</p>
<div id="admonition-tip-disable-if-expressions" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-disable-if-expressions-title">
<div class="admonition-title">
<div id="admonition-tip-disable-if-expressions-title">
<p>Tip: Disable <code>if</code> expressions</p>
</div>
<a class="admonition-anchor-link" href="language/if.html#admonition-tip-disable-if-expressions"></a>
</div>
<div>
<p><code>if</code> expressions can be disabled via <a href="language//book/engine/options.html"><code>Engine::set_allow_if_expression</code></a>.</p>
</div>
</div>
<pre><code class="language-rust">// The following is equivalent to C: int x = 1 + (decision ? 42 : 123) / 2;
let x = 1 + if decision { 42 } else { 123 } / 2;
x == 22;

let x = if decision { 42 }; // no else branch defaults to '()'
x == ();</code></pre>
<div id="admonition-statement-before-expression" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-statement-before-expression-title">
<div class="admonition-title">
<div id="admonition-statement-before-expression-title">
<p>Statement before expression</p>
</div>
<a class="admonition-anchor-link" href="language/if.html#admonition-statement-before-expression"></a>
</div>
<div>
<p>Beware that, like Rust, <code>if</code> is parsed primarily as a statement where it makes sense.
This is to avoid surprises.</p>
<pre><code class="language-rust">fn index_of(x) {
    // 'if' is parsed primarily as a statement
    if this.contains(x) {
        return this.find_index(x)
    }

    -1
}</code></pre>
<p>The above will not be parsed as a single expression:</p>
<pre><code class="language-rust">fn index_of(x) {
    if this.contains(x) { return this.find_index(x) } - 1
    //                          error due to '() - 1' ^
}
</code></pre>
<p>To force parsing as an expression, parentheses are required:</p>
<pre><code class="language-rust">fn calc_index(b, offset) {
    (if b { 1 } else { 0 }) + offset
//  ^---------------------^ parentheses
}</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="switch-statement"><a class="header" href="#switch-statement">Switch Statement</a></h1>
<p>The <code>switch</code> statement allows matching on <a href="language//book/appendix/literals.html">literal</a> values, and it mostly follows Rust’s <code>match</code> syntax.</p>
<pre><code class="language-js">switch calc_secret_value(x) {
    1 =&gt; print("It's one!"),
    2 =&gt; {
        // A statements block instead of a one-line statement
        print("It's two!");
        print("Again!");
    }
    3 =&gt; print("Go!"),
    // A list of alternatives
    4 | 5 | 6 =&gt; print("Some small number!"),
    // _ is the default when no case matches. It must be the last case.
    _ =&gt; print(`Oops! Something's wrong: ${x}`)
}
</code></pre>
<h2 id="default-case"><a class="header" href="#default-case">Default Case</a></h2>
<p>A <em>default</em> case (i.e. when no other cases match) can be specified with <code>_</code>.</p>
<div id="admonition-must-be-last" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-must-be-last-title">
<div class="admonition-title">
<div id="admonition-must-be-last-title">
<p>Must be last</p>
</div>
<a class="admonition-anchor-link" href="language/switch.html#admonition-must-be-last"></a>
</div>
<div>
<p>The default case must be the <em>last</em> case in the <code>switch</code> statement.</p>
</div>
</div>
<pre><code class="language-js">switch wrong_default {
    1 =&gt; 2,
    _ =&gt; 9,     // &lt;- syntax error: default case not the last
    2 =&gt; 3,
    3 =&gt; 4,     // &lt;- ending with extra comma is OK
}

switch wrong_default {
    1 =&gt; 2,
    2 =&gt; 3,
    3 =&gt; 4,
    _ =&gt; 8,     // &lt;- syntax error: default case not the last
    _ =&gt; 9
}
</code></pre>
<h2 id="array-and-object-map-literals-also-work"><a class="header" href="#array-and-object-map-literals-also-work">Array and Object Map Literals Also Work</a></h2>
<p>The <code>switch</code> expression can match against any <em><a href="language//book/appendix/literals.html">literal</a></em>, including <a href="language//book/language/arrays.html">array</a> and <a href="language//book/language/object-maps.html">object map</a> <a href="language//book/appendix/literals.html">literals</a>.</p>
<pre><code class="language-js">// Match on arrays
switch [foo, bar, baz] {
    ["hello", 42, true] =&gt; ...,
    ["hello", 123, false] =&gt; ...,
    ["world", 1, true] =&gt; ...,
    _ =&gt; ...
}

// Match on object maps
switch map {
    #{ a: 1, b: 2, c: true } =&gt; ...,
    #{ a: 42, d: "hello" } =&gt; ...,
    _ =&gt; ...
}
</code></pre>
<div id="admonition-tip-working-with-enums" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-working-with-enums-title">
<div class="admonition-title">
<div id="admonition-tip-working-with-enums-title">
<p>Tip: Working with enums</p>
</div>
<a class="admonition-anchor-link" href="language/switch.html#admonition-tip-working-with-enums"></a>
</div>
<div>
<p>Switching on <a href="language//book/language/arrays.html">arrays</a> is very useful when working with Rust enums
(see <a href="language//book/patterns/enums.html">this section</a> for more details).</p>
</div>
</div>
<h2 id="case-conditions"><a class="header" href="#case-conditions">Case Conditions</a></h2>
<p>Similar to Rust, each case (except the default case at the end) can provide an optional condition
that must evaluate to <code>true</code> in order for the case to match.</p>
<p>All cases are checked in order, so an earlier case that matches will override all later cases.</p>
<pre><code class="language-js">let result = switch calc_secret_value(x) {
    1 if some_external_condition(x, y, z) =&gt; 100,

    1 | 2 | 3 if x &lt; foo =&gt; 200,    // &lt;- all alternatives share the same condition
    
    2 if bar() =&gt; 999,

    2 =&gt; "two",                     // &lt;- fallback value for 2

    2 =&gt; "dead code",               // &lt;- this case is a duplicate and will never match
                                    //    because the previous case matches first

    5 if CONDITION =&gt; 123,          // &lt;- value for 5 matching condition

    5 =&gt; "five",                    // &lt;- fallback value for 5

    _ if CONDITION =&gt; 8888          // &lt;- syntax error: default case cannot have condition
};
</code></pre>
<div id="admonition-tip-use-with-type_of" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-use-with-type_of-title">
<div class="admonition-title">
<div id="admonition-tip-use-with-type_of-title">
<p>Tip: Use with <code>type_of()</code></p>
</div>
<a class="admonition-anchor-link" href="language/switch.html#admonition-tip-use-with-type_of"></a>
</div>
<div>
<p>Case conditions, together with <a href="language//book/language/type-of.html"><code>type_of()</code></a>, makes it extremely easy to work with
values which may be of several different types (like properties in a JSON object).</p>
<pre><code class="language-js">switch value.type_of() {
    // if 'value' is a string...
    "string" if value.len() &lt; 5 =&gt; ...,
    "string" =&gt; ...,

    // if 'value' is an array...
    "array" =&gt; ...,

    // if 'value' is an object map...
    "map" if value.prop == 42 =&gt; ...,
    "map" =&gt; ...,

    // if 'value' is a number...
    "i64" if value &gt; 0 =&gt; ...,
    "i64" =&gt; ...,

    // anything else: probably an error...
    _ =&gt; ...
}
</code></pre>
</div>
</div>
<h2 id="range-cases"><a class="header" href="#range-cases">Range Cases</a></h2>
<p>Because of their popularity, <a href="language//book/appendix/literals.html">literal</a> integer <a href="language//book/language/ranges.html">ranges</a> can also be used as <code>switch</code> cases.</p>
<p>Numeric <a href="language//book/language/ranges.html">ranges</a> are only searched when the <code>switch</code> value is itself a number (including
floating-point and <a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a>). They never match any other data types.</p>
<div id="admonition-must-come-after-numeric-cases" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-must-come-after-numeric-cases-title">
<div class="admonition-title">
<div id="admonition-must-come-after-numeric-cases-title">
<p>Must come after numeric cases</p>
</div>
<a class="admonition-anchor-link" href="language/switch.html#admonition-must-come-after-numeric-cases"></a>
</div>
<div>
<p>Range cases must come <em>after</em> all numeric cases.</p>
</div>
</div>
<pre><code class="language-js">let x = 42;

switch x {
    'x' =&gt; ...,             // no match: wrong data type

    1 =&gt; ...,               // &lt;- specific numeric cases are checked first
    2 =&gt; ...,               // &lt;- but these do not match

    0..50 if x &gt; 45 =&gt; ..., // no match: condition is 'false'

    -10..20 =&gt; ...,         // no match: not in range

    0..50 =&gt; ...,           // &lt;- MATCH!!!

    30..100 =&gt; ...,         // no match: even though it is within range,
                            // the previous case matches first

    42 =&gt; ...,              // &lt;- syntax error: numeric cases cannot follow range cases
}
</code></pre>
<div id="admonition-tip-ranges-can-overlap" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-ranges-can-overlap-title">
<div class="admonition-title">
<div id="admonition-tip-ranges-can-overlap-title">
<p>Tip: Ranges can overlap</p>
</div>
<a class="admonition-anchor-link" href="language/switch.html#admonition-tip-ranges-can-overlap"></a>
</div>
<div>
<p>When more then one <a href="language//book/language/ranges.html">range</a> contain the <code>switch</code> value, the <em>first</em> one with a fulfilled condition
(if any) is evaluated.</p>
<p>Numeric <a href="language//book/language/ranges.html">range</a> cases are tried in the order that they appear in the original script.</p>
</div>
</div>
<h2 id="difference-from-if-else-if-chain"><a class="header" href="#difference-from-if-else-if-chain">Difference From <code>if</code>-<code>else if</code> Chain</a></h2>
<p>Although a <code>switch</code> expression looks <em>almost</em> the same as an <a href="language//book/language/if.html"><code>if</code>-<code>else if</code></a> chain, there are
subtle differences between the two.</p>
<h3 id="look-up-table-vs-x--y"><a class="header" href="#look-up-table-vs-x--y">Look-up Table vs <code>x == y</code></a></h3>
<p>A <code>switch</code> expression matches through <em>hashing</em> via a look-up table. Therefore, matching is very
fast.  Walking down an <a href="language//book/language/if.html"><code>if</code>-<code>else if</code></a> chain is <em>much</em> slower.</p>
<p>On the other hand, operators can be <a href="language//book/rust/operators.html">overloaded</a> in Rhai, meaning that it is
possible to override the <code>==</code> operator for integers such that <code>x == y</code> returns a different result
from the built-in default.</p>
<p><code>switch</code> expressions do <em>not</em> use the <code>==</code> operator for comparison; instead, they <em>hash</em> the data
values and jump directly to the correct statements via a pre-compiled look-up table.  This makes
matching extremely efficient, but it also means that <a href="language//book/rust/operators.html">overloading</a> the <code>==</code>
operator will have no effect.</p>
<p>Therefore, in environments where it is desirable to <a href="language//book/rust/operators.html">overload</a> the <code>==</code>
operator for <a href="language//book/language/values-and-types.html">standard types</a> – though it is difficult to think of valid scenarios where you’d
want <code>1 == 1</code> to return something other than <code>true</code> – avoid using the <code>switch</code> expression.</p>
<h3 id="efficiency"><a class="header" href="#efficiency">Efficiency</a></h3>
<p>Because the <code>switch</code> expression works through a look-up table, it is very efficient even for <em>large</em>
number of cases; in fact, switching is an O(1) operation regardless of the size of the data and
number of cases to match.</p>
<p>A long <a href="language//book/language/if.html"><code>if</code>-<code>else if</code></a> chain becomes increasingly slower with each additional case because
essentially an O(n) <em>linear scan</em> is performed.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="switch-expression"><a class="header" href="#switch-expression">Switch Expression</a></h1>
<p>Like <a href="language//book/language/if.html"><code>if</code></a>, <a href="language//book/language/switch.html"><code>switch</code></a> also works as an <em>expression</em>.</p>
<div id="admonition-tip" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="language/switch-expression.html#admonition-tip"></a>
</div>
<div>
<p>This means that a <a href="language//book/language/switch.html"><code>switch</code></a> expression can appear anywhere a regular expression can,
e.g. as <a href="language//book/language/functions.html">function</a> call arguments.</p>
</div>
</div>
<div id="admonition-tip-disable-switch-expressions" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-disable-switch-expressions-title">
<div class="admonition-title">
<div id="admonition-tip-disable-switch-expressions-title">
<p>Tip: Disable <code>switch</code> expressions</p>
</div>
<a class="admonition-anchor-link" href="language/switch-expression.html#admonition-tip-disable-switch-expressions"></a>
</div>
<div>
<p><a href="language//book/language/switch.html"><code>switch</code></a> expressions can be disabled via <a href="language//book/engine/options.html"><code>Engine::set_allow_switch_expression</code></a>.</p>
</div>
</div>
<pre><code class="language-js">let x = switch foo { 1 =&gt; true, _ =&gt; false };

func(switch foo {
    "hello" =&gt; 42,
    "world" =&gt; 123,
    _ =&gt; 0
});

// The above is somewhat equivalent to:

let x = if foo == 1 { true } else { false };

if foo == "hello" {
    func(42);
} else if foo == "world" {
    func(123);
} else {
    func(0);
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="while-loop"><a class="header" href="#while-loop">While Loop</a></h1>
<p><code>while</code> loops follow C syntax.</p>
<p>Like C, <code>continue</code> can be used to skip to the next iteration, by-passing all following statements;
<code>break</code> can be used to break out of the loop unconditionally.</p>
<div id="admonition-tip-disable-while-loops" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-disable-while-loops-title">
<div class="admonition-title">
<div id="admonition-tip-disable-while-loops-title">
<p>Tip: Disable <code>while</code> loops</p>
</div>
<a class="admonition-anchor-link" href="language/while.html#admonition-tip-disable-while-loops"></a>
</div>
<div>
<p><code>while</code> loops can be disabled via <a href="language//book/engine/options.html"><code>Engine::set_allow_looping</code></a>.</p>
</div>
</div>
<pre><code class="language-rust">let x = 10;

while x &gt; 0 {
    x -= 1;
    if x &lt; 6 { continue; }  // skip to the next iteration
    print(x);
    if x == 5 { break; }    // break out of while loop
}</code></pre>
<h2 id="while-expression"><a class="header" href="#while-expression">While Expression</a></h2>
<p>Like Rust, <code>while</code> statements can also be used as <em>expressions</em>.</p>
<p>The <code>break</code> statement takes an optional expression that provides the return value.</p>
<p>The default return value of a <code>while</code> expression is <a href="language//book/language/values-and-types.html"><code>()</code></a>.</p>
<div id="admonition-tip-disable-all-loop-expressions" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-disable-all-loop-expressions-title">
<div class="admonition-title">
<div id="admonition-tip-disable-all-loop-expressions-title">
<p>Tip: Disable all loop expressions</p>
</div>
<a class="admonition-anchor-link" href="language/while.html#admonition-tip-disable-all-loop-expressions"></a>
</div>
<div>
<p>Loop expressions can be disabled via <a href="language//book/engine/options.html"><code>Engine::set_allow_loop_expressions</code></a>.</p>
</div>
</div>
<pre><code class="language-js">let x = 0;

// 'while' can be used just like an expression
let result = while x &lt; 100 {
    if is_magic_number(x) {
        // if the 'while' loop breaks here, return a specific value
        break get_magic_result(x);
    }

    x += 1;

    // ... if the 'while' loop exits here, the return value is ()
};

if result == () {
    print("Magic number not found!");
} else {
    print(`Magic result = ${result}!`);
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="do-loop"><a class="header" href="#do-loop">Do Loop</a></h1>
<p><code>do</code> loops have two opposite variants: <code>do</code> … <code>while</code> and <code>do</code> … <code>until</code>.</p>
<p>Like the <a href="language//book/language/while.html"><code>while</code></a> loop, <code>continue</code> can be used to skip to the next iteration, by-passing all
following statements; <code>break</code> can be used to break out of the loop unconditionally.</p>
<div id="admonition-tip-disable-do-loops" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-disable-do-loops-title">
<div class="admonition-title">
<div id="admonition-tip-disable-do-loops-title">
<p>Tip: Disable <code>do</code> loops</p>
</div>
<a class="admonition-anchor-link" href="language/do.html#admonition-tip-disable-do-loops"></a>
</div>
<div>
<p><code>do</code> loops can be disabled via <a href="language//book/engine/options.html"><code>Engine::set_allow_looping</code></a>.</p>
</div>
</div>
<pre><code class="language-rust">let x = 10;

do {
    x -= 1;
    if x &lt; 6 { continue; }  // skip to the next iteration
    print(x);
    if x == 5 { break; }    // break out of do loop
} while x &gt; 0;


do {
    x -= 1;
    if x &lt; 6 { continue; }  // skip to the next iteration
    print(x);
    if x == 5 { break; }    // break out of do loop
} until x == 0;</code></pre>
<h2 id="do-expression"><a class="header" href="#do-expression">Do Expression</a></h2>
<p>Like Rust, <code>do</code> statements can also be used as <em>expressions</em>.</p>
<p>The <code>break</code> statement takes an optional expression that provides the return value.</p>
<p>The default return value of a <code>do</code> expression is <a href="language//book/language/values-and-types.html"><code>()</code></a>.</p>
<div id="admonition-tip-disable-all-loop-expressions" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-disable-all-loop-expressions-title">
<div class="admonition-title">
<div id="admonition-tip-disable-all-loop-expressions-title">
<p>Tip: Disable all loop expressions</p>
</div>
<a class="admonition-anchor-link" href="language/do.html#admonition-tip-disable-all-loop-expressions"></a>
</div>
<div>
<p>Loop expressions can be disabled via <a href="language//book/engine/options.html"><code>Engine::set_allow_loop_expressions</code></a>.</p>
</div>
</div>
<pre><code class="language-js">let x = 0;

// 'do' can be used just like an expression
let result = do {
    if is_magic_number(x) {
        // if the 'do' loop breaks here, return a specific value
        break get_magic_result(x);
    }

    x += 1;

    // ... if the 'do' loop exits here, the return value is ()
} until x &gt;= 100;

if result == () {
    print("Magic number not found!");
} else {
    print(`Magic result = ${result}!`);
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="infinite-loop"><a class="header" href="#infinite-loop">Infinite Loop</a></h1>
<p>Infinite loops follow Rust syntax.</p>
<p>Like Rust, <code>continue</code> can be used to skip to the next iteration, by-passing all following statements;
<code>break</code> can be used to break out of the loop unconditionally.</p>
<div id="admonition-tip-disable-loop" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-disable-loop-title">
<div class="admonition-title">
<div id="admonition-tip-disable-loop-title">
<p>Tip: Disable <code>loop</code></p>
</div>
<a class="admonition-anchor-link" href="language/loop.html#admonition-tip-disable-loop"></a>
</div>
<div>
<p><code>loop</code> can be disabled via <a href="language//book/engine/options.html"><code>Engine::set_allow_looping</code></a>.</p>
</div>
</div>
<pre><code class="language-rust">let x = 10;

loop {
    x -= 1;

    if x &gt; 5 { continue; }  // skip to the next iteration

    print(x);

    if x == 0 { break; }    // break out of loop
}</code></pre>
<div id="admonition-remember-the-break-statement" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-remember-the-break-statement-title">
<div class="admonition-title">
<div id="admonition-remember-the-break-statement-title">
<p>Remember the <code>break</code> statement</p>
</div>
<a class="admonition-anchor-link" href="language/loop.html#admonition-remember-the-break-statement"></a>
</div>
<div>
<p>A <code>loop</code> statement without a <code>break</code> statement inside its loop block is infinite.
There is no way for the loop to stop iterating.</p>
</div>
</div>
<h2 id="loop-expression"><a class="header" href="#loop-expression">Loop Expression</a></h2>
<p>Like Rust, <code>loop</code> statements can also be used as <em>expressions</em>.</p>
<p>The <code>break</code> statement takes an optional expression that provides the return value.</p>
<p>The default return value of a <code>loop</code> expression is <a href="language//book/language/values-and-types.html"><code>()</code></a>.</p>
<div id="admonition-tip-disable-all-loop-expressions" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-disable-all-loop-expressions-title">
<div class="admonition-title">
<div id="admonition-tip-disable-all-loop-expressions-title">
<p>Tip: Disable all loop expressions</p>
</div>
<a class="admonition-anchor-link" href="language/loop.html#admonition-tip-disable-all-loop-expressions"></a>
</div>
<div>
<p>Loop expressions can be disabled via <a href="language//book/engine/options.html"><code>Engine::set_allow_loop_expressions</code></a>.</p>
</div>
</div>
<pre><code class="language-js">let x = 0;

// 'loop' can be used just like an expression
let result = loop {
    if is_magic_number(x) {
        // if the loop breaks here, return a specific value
        break get_magic_result(x);
    }

    x += 1;

    // ... if the loop exits here, the return value is ()
};

if result == () {
    print("Magic number not found!");
} else {
    print(`Magic result = ${result}!`);
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="for-loop"><a class="header" href="#for-loop">For Loop</a></h1>
<p>Iterating through a numeric <a href="language//book/language/ranges.html">range</a> or an <a href="language//book/language/arrays.html">array</a>, or any type with a registered <a href="language//book/language/iterator.html">type iterator</a>,
is provided by the <code>for</code> … <code>in</code> loop.</p>
<p>There are two alternative syntaxes, one including a counter variable:</p>
<blockquote>
<p><code>for</code> <em>variable</em> <code>in</code> <em>expression</em> <code>{</code> … <code>}</code></p>
<p><code>for (</code> <em>variable</em> <code>,</code> <em>counter</em> <code>)</code> <code>in</code> <em>expression</em> <code>{</code> … <code>}</code></p>
</blockquote>
<div id="admonition-tip-disable-for-loops" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-disable-for-loops-title">
<div class="admonition-title">
<div id="admonition-tip-disable-for-loops-title">
<p>Tip: Disable <code>for</code> loops</p>
</div>
<a class="admonition-anchor-link" href="language/for.html#admonition-tip-disable-for-loops"></a>
</div>
<div>
<p><code>for</code> loops can be disabled via <a href="language//book/engine/options.html"><code>Engine::set_allow_looping</code></a>.</p>
</div>
</div>
<h2 id="break-or-continue"><a class="header" href="#break-or-continue">Break or Continue</a></h2>
<p>Like C, <code>continue</code> can be used to skip to the next iteration, by-passing all following statements.</p>
<p><code>break</code> can be used to break out of the loop unconditionally.</p>
<h2 id="for-expression"><a class="header" href="#for-expression">For Expression</a></h2>
<p>Unlike Rust, <code>for</code> statements can also be used as <em>expressions</em>.</p>
<p>The <code>break</code> statement takes an optional expression that provides the return value.</p>
<p>The default return value of a <code>for</code> expression is <a href="language//book/language/values-and-types.html"><code>()</code></a>.</p>
<div id="admonition-tip-disable-all-loop-expressions" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-disable-all-loop-expressions-title">
<div class="admonition-title">
<div id="admonition-tip-disable-all-loop-expressions-title">
<p>Tip: Disable all loop expressions</p>
</div>
<a class="admonition-anchor-link" href="language/for.html#admonition-tip-disable-all-loop-expressions"></a>
</div>
<div>
<p>Loop expressions can be disabled via <a href="language//book/engine/options.html"><code>Engine::set_allow_loop_expressions</code></a>.</p>
</div>
</div>
<pre><code class="language-js">let a = [42, 123, 999, 0, true, "hello", "world!", 987.6543];

// 'for' can be used just like an expression
let index = for (item, count) in a {
    // if the 'for' loop breaks here, return a specific value
    switch item.type_of() {
        "i64" if item.is_even =&gt; break count,
        "f64" if item.to_int().is_even =&gt; break count,
    }

    // ... if the 'for' loop exits here, the return value is ()
};

if index == () {
    print("Magic number not found!");
} else {
    print(`Magic number found at index ${index}!`);
}
</code></pre>
<h2 id="counter-variable"><a class="header" href="#counter-variable">Counter Variable</a></h2>
<p>The counter variable, if specified, starts from zero, incrementing upwards.</p>
<pre><code class="language-js   no_run">let a = [42, 123, 999, 0, true, "hello", "world!", 987.6543];

// Loop through the array
for (item, count) in a {
    if x.type_of() == "string" {
        continue;                   // skip to the next iteration
    }

    // 'item' contains a copy of each element during each iteration
    // 'count' increments (starting from zero) for each iteration
    print(`Item #${count + 1} = ${item}`);

    if x == 42 { break; }           // break out of for loop
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="standard-iterable-types"><a class="header" href="#standard-iterable-types">Standard Iterable Types</a></h1>
<p>Certain <a href="language//book/language/values-and-types.html">standard types</a> are iterable via a <a href="language//book/language/for.html"><code>for</code></a> statement.</p>
<h2 id="iterate-through-arrays"><a class="header" href="#iterate-through-arrays">Iterate Through Arrays</a></h2>
<p>Iterating through an <a href="language//book/language/arrays.html">array</a> yields cloned <em>copies</em> of each element.</p>
<pre><code class="language-rust">let a = [1, 3, 5, 7, 9, 42];

// Loop through the array
for x in a {
    if x &gt; 10 { continue; }         // skip to the next iteration

    print(x);

    if x == 42 { break; }           // break out of for loop
}</code></pre>
<h2 id="iterate-through-strings"><a class="header" href="#iterate-through-strings">Iterate Through Strings</a></h2>
<p>Iterating through a <a href="language//book/language/strings-chars.html">string</a> yields individual <a href="language//book/language/strings-chars.html">characters</a>.</p>
<p>The <code>chars</code> method also allow iterating through characters in a <a href="language//book/language/strings-chars.html">string</a>, optionally accepting the
character position to start from (counting from the end if negative), as well as the number of
characters to iterate (defaults to all).</p>
<p><code>char</code> also accepts a <a href="language//book/language/ranges.html">range</a> which can be created via the <code>..</code> (exclusive) and <code>..=</code> (inclusive) operators.</p>
<pre><code class="language-rust">let s = "hello, world!";

// Iterate through all the characters.
for ch in s {
    print(ch);
}

// Iterate starting from the 3rd character and stopping at the 7th.
for ch in s.chars(2, 5) {
    if ch &gt; 'z' { continue; }       // skip to the next iteration

    print(ch);

    if x == '@' { break; }          // break out of for loop
}

// Iterate starting from the 3rd character and stopping at the end.
for ch in s.chars(2..s.len) {
    if ch &gt; 'z' { continue; }       // skip to the next iteration

    print(ch);

    if x == '@' { break; }          // break out of for loop
}</code></pre>
<h2 id="iterate-through-numeric-ranges"><a class="header" href="#iterate-through-numeric-ranges">Iterate Through Numeric Ranges</a></h2>
<p><a href="language//book/language/ranges.html">Ranges</a> are created via the <code>..</code> (exclusive) and <code>..=</code> (inclusive) operators.</p>
<p>The <code>range</code> function similarly creates exclusive <a href="language//book/language/ranges.html">ranges</a>, plus allowing optional step values.</p>
<pre><code class="language-rust">// Iterate starting from 0 and stopping at 49
// The step is assumed to be 1 when omitted for integers
for x in 0..50 {
    if x &gt; 10 { continue; }         // skip to the next iteration

    print(x);

    if x == 42 { break; }           // break out of for loop
}

// The 'range' function is just the same
for x in range(0, 50) {
    if x &gt; 10 { continue; }         // skip to the next iteration

    print(x);

    if x == 42 { break; }           // break out of for loop
}

// The 'range' function also takes a step
for x in range(0, 50, 3) {          // step by 3
    if x &gt; 10 { continue; }         // skip to the next iteration

    print(x);

    if x == 42 { break; }           // break out of for loop
}

// The 'range' function can also step backwards
for x in range(50..0, -3) {         // step down by -3
    if x &lt; 10 { continue; }         // skip to the next iteration

    print(x);

    if x == 42 { break; }           // break out of for loop
}

// It works also for floating-point numbers
for x in range(5.0, 0.0, -2.0) {    // step down by -2.0
    if x &lt; 10 { continue; }         // skip to the next iteration

    print(x);

    if x == 4.2 { break; }          // break out of for loop
}</code></pre>
<h2 id="iterate-through-bit-fields"><a class="header" href="#iterate-through-bit-fields">Iterate Through Bit-Fields</a></h2>
<p>The <code>bits</code> function allows iterating through an integer as a <a href="language//book/language/bit-fields.html">bit-field</a>.</p>
<p><code>bits</code> optionally accepts the bit number to start from (counting from the most-significant-bit if
negative), as well as the number of bits to iterate (defaults all).</p>
<p><code>bits</code> also accepts a <a href="language//book/language/ranges.html">range</a> which can be created via the <code>..</code> (exclusive) and <code>..=</code> (inclusive) operators.</p>
<pre><code class="language-js   no_run">let x = 0b_1001110010_1101100010_1100010100;
let num_on = 0;

// Iterate through all the bits
for bit in x.bits() {
    if bit { num_on += 1; }
}

print(`There are ${num_on} bits turned on!`);

const START = 3;

// Iterate through all the bits from 3 through 12
for (bit, index) in x.bits(START, 10) {
    print(`Bit #${index} is ${if bit { "ON" } else { "OFF" }}!`);

    if index &gt;= 7 { break; }        // break out of for loop
}

// Iterate through all the bits from 3 through 12
for (bit, index) in x.bits(3..=12) {
    print(`Bit #${index} is ${if bit { "ON" } else { "OFF" }}!`);

    if index &gt;= 7 { break; }        // break out of for loop
}
</code></pre>
<h2 id="iterate-through-object-maps"><a class="header" href="#iterate-through-object-maps">Iterate Through Object Maps</a></h2>
<p>Two methods, <code>keys</code> and <code>values</code>, return <a href="language//book/language/arrays.html">arrays</a> containing cloned <em>copies</em>
of all property names and values of an <a href="language//book/language/object-maps.html">object map</a>, respectively.</p>
<p>These <a href="language//book/language/arrays.html">arrays</a> can be iterated.</p>
<pre><code class="language-rust">let map = #{a:1, b:3, c:5, d:7, e:9};

// Property names are returned in unsorted, random order
for x in map.keys() {
    if x &gt; 10 { continue; }         // skip to the next iteration

    print(x);

    if x == 42 { break; }           // break out of for loop
}

// Property values are returned in unsorted, random order
for val in map.values() {
    print(val);
}</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="make-a-custom-type-iterable"><a class="header" href="#make-a-custom-type-iterable">Make a Custom Type Iterable</a></h1>
<div id="admonition-built-in-type-iterators" class="admonition admonish-info side" role="note" aria-labelledby="admonition-built-in-type-iterators-title">
<div class="admonition-title">
<div id="admonition-built-in-type-iterators-title">
<p>Built-in type iterators</p>
</div>
<a class="admonition-anchor-link" href="language/iterator.html#admonition-built-in-type-iterators"></a>
</div>
<div>
<p>Type iterators are already defined for built-in <a href="language//book/language/values-and-types.html">standard types</a> such as <a href="language//book/language/strings-chars.html">strings</a>, <a href="language//book/language/ranges.html">ranges</a>,
<a href="language//book/language/bit-fields.html">bit-fields</a>, <a href="language//book/language/arrays.html">arrays</a> and <a href="language//book/language/object-maps.html">object maps</a>.</p>
<p>That’s why they can be used with the <a href="language//book/language/for.html"><code>for</code></a> loop.</p>
</div>
</div>
<p>If a <a href="language//book/rust/custom-types.html">custom type</a> is iterable, the <a href="language//book/language/for.html"><code>for</code></a> loop can be used to iterate through
its items in sequence, as long as it has a <em>type iterator</em> registered.</p>
<p><code>Engine::register_iterator&lt;T&gt;</code> allows registration of a type iterator for any type
that implements <code>IntoIterator</code>.</p>
<p>With a type iterator registered, the <a href="language//book/rust/custom-types.html">custom type</a> can be iterated through.</p>
<pre><code class="language-rust">// Custom type
#[derive(Debug, Clone)]
struct TestStruct { fields: Vec&lt;i64&gt; }

// Implement 'IntoIterator' trait
impl IntoIterator&lt;Item = i64&gt; for TestStruct {
    type Item = i64;
    type IntoIter = std::vec::IntoIter&lt;Self::Item&gt;;

    fn into_iter(self) -&gt; Self::IntoIter {
        self.fields.into_iter()
    }
}

let mut engine = Engine::new();

// Register API and type iterator for 'TestStruct'
engine.register_type_with_name::&lt;TestStruct&gt;("TestStruct")
      .register_fn("new_ts", || TestStruct { fields: vec![1, 2, 3, 42] })
      .register_iterator::&lt;TestStruct&gt;();

// 'TestStruct' is now iterable
engine.run(
"
    for value in new_ts() {
        ...
    }
")?;</code></pre>
<div id="admonition-tip-fallible-type-iterators" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-fallible-type-iterators-title">
<div class="admonition-title">
<div id="admonition-tip-fallible-type-iterators-title">
<p>Tip: Fallible type iterators</p>
</div>
<a class="admonition-anchor-link" href="language/iterator.html#admonition-tip-fallible-type-iterators"></a>
</div>
<div>
<p><code>Engine::register_iterator_result</code> allows registration of a <em>fallible</em> type iterator –
i.e. an iterator that returns <code>Result&lt;T, Box&lt;EvalAltResult&gt;&gt;</code>.</p>
<p>On in very rare situations will this be necessary though.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="return-value-4"><a class="header" href="#return-value-4">Return Value</a></h1>
<h2 id="return"><a class="header" href="#return"><code>return</code></a></h2>
<p>The <code>return</code> statement is used to immediately stop evaluation and exist the current context
(typically a <a href="language//book/language/functions.html">function</a> call) yielding a <em>return value</em>.</p>
<pre><code class="language-rust">return;             // equivalent to return ();

return 123 + 456;   // returns 579</code></pre>
<p>A <code>return</code> statement at <em>global</em> level stops the entire script evaluation,
the return value is taken as the result of the script evaluation.</p>
<p>A <code>return</code> statement inside a <a href="language//book/language/functions.html">function call</a> exits with a return value to the caller.</p>
<h2 id="exit"><a class="header" href="#exit"><code>exit</code></a></h2>
<p>Similar to the <code>return</code> statement, the <code>exit</code> <em>function</em> is used to immediately stop evaluation,
but it does so regardless of where it is called from, even deep inside nested function calls.</p>
<pre><code class="language-rust">fn foo() {
    exit(42);       // exit with result 42
}
fn bar() {
    foo();
}
fn baz() {
    bar();
}

let x = baz();      // exits with result 42

print(x);           // &lt;- this is never run</code></pre>
<p>The <code>exit</code> function is defined in the <a href="language//book/rust/packages/builtin.html"><code>LanguageCorePackage</code></a> but excluded when using a <a href="language//book/engine/raw.html">raw <code>Engine</code></a>.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Parameter(s)</th><th>Description</th></tr></thead><tbody>
<tr><td><code>exit</code></td><td>result value <em>(optional)</em></td><td>immediately terminate script evaluation (default result value is <a href="language//book/language/values-and-types.html"><code>()</code></a>)</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="throw-exception-on-error"><a class="header" href="#throw-exception-on-error">Throw Exception on Error</a></h1>
<p>All <a href="language//book/engine/hello-world.html"><code>Engine</code></a> evaluation API methods return <code>Result&lt;T, Box&lt;rhai::EvalAltResult&gt;&gt;</code>
with <code>EvalAltResult</code> holding error information.</p>
<p>To deliberately return an error, use the <code>throw</code> keyword.</p>
<pre><code class="language-js">if some_bad_condition_has_happened {
    throw error;    // 'throw' any value as the exception
}

throw;              // defaults to '()'
</code></pre>
<p>Exceptions thrown via <code>throw</code> in the script can be captured in Rust by matching
<code>EvalAltResult::ErrorRuntime(value, position)</code> with the exception value captured by <code>value</code>.</p>
<pre><code class="language-rust">let result = engine.eval::&lt;i64&gt;(
"
    let x = 42;

    if x &gt; 0 {
        throw x;
    }
").expect_err();

println!("{result}");       // prints "Runtime error: 42 (line 5, position 15)"</code></pre>
<h2 id="catch-a-thrown-exception"><a class="header" href="#catch-a-thrown-exception">Catch a Thrown Exception</a></h2>
<p>It is possible to <em>catch</em> an exception instead of having it abort the evaluation
of the entire script via the <a href="language//book/language/try-catch.html"><code>try</code> … <code>catch</code></a>
statement common to many C-like languages.</p>
<pre><code class="language-js">fn code_that_throws() {
    throw 42;
}

try
{
    code_that_throws();
}
catch (err)         // 'err' captures the thrown exception value
{
    print(err);     // prints 42
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="catch-exceptions"><a class="header" href="#catch-exceptions">Catch Exceptions</a></h1>
<p>When an <a href="language//book/language/throw.html">exception</a> is thrown via a <a href="language//book/language/throw.html"><code>throw</code></a> statement, evaluation of the script halts and the
<a href="language//book/engine/hello-world.html"><code>Engine</code></a> returns with <code>EvalAltResult::ErrorRuntime</code> containing the exception value thrown.</p>
<p>It is possible, via the <code>try</code> … <code>catch</code> statement, to <em>catch</em> exceptions, optionally with an
<em>error variable</em>.</p>
<blockquote>
<p><code>try</code> <code>{</code> … <code>}</code> <code>catch</code> <code>{</code> … <code>}</code></p>
<p><code>try</code> <code>{</code> … <code>}</code> <code>catch</code> <code>(</code> <em>error variable</em> <code>)</code> <code>{</code> … <code>}</code></p>
</blockquote>
<pre><code class="language-js">// Catch an exception and capturing its value
try
{
    throw 42;
}
catch (err)         // 'err' captures the thrown exception value
{
    print(err);     // prints 42
}

// Catch an exception without capturing its value
try
{
    print(42/0);    // deliberate divide-by-zero exception
}
catch               // no error variable - exception value is discarded
{
    print("Ouch!");
}

// Exception in the 'catch' block
try
{
    print(42/0);    // throw divide-by-zero exception
}
catch
{
    print("You seem to be dividing by zero here...");

    throw "die";    // a 'throw' statement inside a 'catch' block
                    // throws a new exception
}
</code></pre>
<div id="admonition-tip-re-throw-exception" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-re-throw-exception-title">
<div class="admonition-title">
<div id="admonition-tip-re-throw-exception-title">
<p>Tip: Re-throw exception</p>
</div>
<a class="admonition-anchor-link" href="language/try-catch.html#admonition-tip-re-throw-exception"></a>
</div>
<div>
<p>Like the <code>try</code> … <code>catch</code> syntax in most languages, it is possible to <em>re-throw</em> an exception
within the <code>catch</code> block simply by another <a href="language//book/language/throw.html"><code>throw</code></a> statement without a value.</p>
<pre><code class="language-js">try
{
    // Call something that will throw an exception...
    do_something_bad_that_throws();
}
catch
{
    print("Oooh! You've done something real bad!");

    throw;          // 'throw' without a value within a 'catch' block
                    // re-throws the original exception
}

</code></pre>
</div>
</div>
<div id="admonition-catchable-exceptions" class="admonition admonish-success" role="note" aria-labelledby="admonition-catchable-exceptions-title">
<div class="admonition-title">
<div id="admonition-catchable-exceptions-title">
<p>Catchable exceptions</p>
</div>
<a class="admonition-anchor-link" href="language/try-catch.html#admonition-catchable-exceptions"></a>
</div>
<div>
<p>Many script-oriented exceptions can be caught via <code>try</code> … <code>catch</code>.</p>
<div class="table-wrapper"><table><thead><tr><th>Error type</th><th style="text-align: center">Error value</th></tr></thead><tbody>
<tr><td>Runtime error thrown by a <a href="language//book/language/throw.html"><code>throw</code></a> statement</td><td style="text-align: center">value in <a href="language//book/language/throw.html"><code>throw</code></a> statement</td></tr>
<tr><td>Arithmetic error</td><td style="text-align: center"><a href="language//book/language/object-maps.html">object map</a></td></tr>
<tr><td><a href="language//book/language/variables.html">Variable</a> not found</td><td style="text-align: center"><a href="language//book/language/object-maps.html">object map</a></td></tr>
<tr><td><a href="language//book/language/functions.html">Function</a> not found</td><td style="text-align: center"><a href="language//book/language/object-maps.html">object map</a></td></tr>
<tr><td><a href="language//book/rust/modules/index.html">Module</a> not found</td><td style="text-align: center"><a href="language//book/language/object-maps.html">object map</a></td></tr>
<tr><td>Unbound <code>this</code></td><td style="text-align: center"><a href="language//book/language/object-maps.html">object map</a></td></tr>
<tr><td>Data type mismatch</td><td style="text-align: center"><a href="language//book/language/object-maps.html">object map</a></td></tr>
<tr><td>Assignment to a calculated/<a href="language//book/language/constants.html">constant</a> value</td><td style="text-align: center"><a href="language//book/language/object-maps.html">object map</a></td></tr>
<tr><td><a href="language//book/language/arrays.html">Array</a>/<a href="language//book/language/strings-chars.html">string</a>/<a href="language//book/language/bit-fields.html">bit-field</a> indexing out-of-bounds</td><td style="text-align: center"><a href="language//book/language/object-maps.html">object map</a></td></tr>
<tr><td>Indexing with an inappropriate data type</td><td style="text-align: center"><a href="language//book/language/object-maps.html">object map</a></td></tr>
<tr><td>Error in property access</td><td style="text-align: center"><a href="language//book/language/object-maps.html">object map</a></td></tr>
<tr><td><a href="language//book/language/for.html"><code>for</code></a> statement on a type without a <a href="language//book/language/iterator.html">type iterator</a></td><td style="text-align: center"><a href="language//book/language/object-maps.html">object map</a></td></tr>
<tr><td>Data race detected</td><td style="text-align: center"><a href="language//book/language/object-maps.html">object map</a></td></tr>
<tr><td>Other runtime error</td><td style="text-align: center"><a href="language//book/language/object-maps.html">object map</a></td></tr>
</tbody></table>
</div>
<p>The error value in the <code>catch</code> clause is an <a href="language//book/language/object-maps.html">object map</a> containing information on the particular error,
including its type, line and character position (if any), and source etc.</p>
<p>When the <a href="language//book/start/features.html"><code>no_object</code></a> feature is turned on, however, the error value is a simple <a href="language//book/language/strings-chars.html">string</a> description.</p>
</div>
</div>
<div id="admonition-non-catchable-exceptions" class="admonition admonish-failure" role="note" aria-labelledby="admonition-non-catchable-exceptions-title">
<div class="admonition-title">
<div id="admonition-non-catchable-exceptions-title">
<p>Non-catchable exceptions</p>
</div>
<a class="admonition-anchor-link" href="language/try-catch.html#admonition-non-catchable-exceptions"></a>
</div>
<div>
<p>Some exceptions <em>cannot</em> be caught.</p>
<div class="table-wrapper"><table><thead><tr><th>Error type</th><th>Notes</th></tr></thead><tbody>
<tr><td>System error – e.g. script file not found</td><td>system errors are not recoverable</td></tr>
<tr><td>Syntax error during parsing</td><td>invalid script</td></tr>
<tr><td><a href="language//book/engine/custom-syntax.html">Custom syntax</a> mismatch error</td><td>incompatible <a href="language//book/engine/hello-world.html"><code>Engine</code></a> instance</td></tr>
<tr><td>Script evaluation metrics exceeding <a href="language//book/safety/index.html">limits</a></td><td><a href="language//book/safety/index.html">safety</a> protection</td></tr>
<tr><td>Script evaluation manually <a href="language//book/safety/progress.html">terminated</a></td><td><a href="language//book/safety/index.html">safety</a> protection</td></tr>
</tbody></table>
</div></div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="functions"><a class="header" href="#functions">Functions</a></h1>
<p>Rhai supports defining functions in script via the <code>fn</code> keyword, with a syntax that is very similar to Rust without types.</p>
<p>Valid function names are the same as valid <a href="language//book/language/variables.html">variable</a> names.</p>
<pre><code class="language-rust">fn add(x, y) {
    x + y
}

fn sub(x, y,) {     // trailing comma in parameters list is OK
    x - y
}

add(2, 3) == 5;

sub(2, 3,) == -1;   // trailing comma in arguments list is OK</code></pre>
<div id="admonition-tip-disable-functions" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-disable-functions-title">
<div class="admonition-title">
<div id="admonition-tip-disable-functions-title">
<p>Tip: Disable functions</p>
</div>
<a class="admonition-anchor-link" href="language/functions.html#admonition-tip-disable-functions"></a>
</div>
<div>
<p>Defining functions can be disabled via the <a href="language//book/start/features.html"><code>no_function</code></a> feature.</p>
</div>
</div>
<div id="admonition-tip-is_def_fn" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-is_def_fn-title">
<div class="admonition-title">
<div id="admonition-tip-is_def_fn-title">
<p>Tip: <code>is_def_fn</code></p>
</div>
<a class="admonition-anchor-link" href="language/functions.html#admonition-tip-is_def_fn"></a>
</div>
<div>
<p>Use <code>is_def_fn</code> (not available under <a href="language//book/start/features.html"><code>no_function</code></a>) to detect if a Rhai function is defined
(and therefore callable) based on its name and the number of parameters (<em>arity</em>).</p>
<pre><code class="language-rust">fn foo(x) { x + 1 }

is_def_fn("foo", 1) == true;

is_def_fn("foo", 0) == false;

is_def_fn("foo", 2) == false;

is_def_fn("bar", 1) == false;</code></pre>
</div>
</div>
<h2 id="implicit-return"><a class="header" href="#implicit-return">Implicit Return</a></h2>
<p>Just like in Rust, an implicit return can be used. In fact, the last statement of a block is
<em>always</em> the block’s return value regardless of whether it is terminated with a semicolon <code>;</code>.
This is different from Rust.</p>
<pre><code class="language-rust">fn add(x, y) {      // implicit return:
    x + y;          // value of the last statement (no need for ending semicolon)
                    // is used as the return value
}

fn add2(x) {
    return x + 2;   // explicit return
}

add(2, 3) == 5;

add2(42) == 44;</code></pre>
<h2 id="global-definitions-only"><a class="header" href="#global-definitions-only">Global Definitions Only</a></h2>
<p>Functions can only be defined at the global level, never inside a block or another function.</p>
<p>Again, this is different from Rust.</p>
<pre><code class="language-rust">// Global level is OK
fn add(x, y) {
    x + y
}

// The following will not compile
fn do_addition(x) {
    fn add_y(n) {   // &lt;- syntax error:  cannot define inside another function
        n + y
    }

    add_y(x)
}</code></pre>
<h2 id="no-access-to-external-scope"><a class="header" href="#no-access-to-external-scope">No Access to External Scope</a></h2>
<p>Functions are not <em>closures</em>. They do not capture the calling environment and can only access their
own parameters.</p>
<p>They cannot access <a href="language//book/language/variables.html">variables</a> external to the function itself.</p>
<pre><code class="language-rust">let x = 42;

fn foo() {
    x               // &lt;- error: variable 'x' not found
}</code></pre>
<h2 id="but-can-call-other-functions-and-access-modules"><a class="header" href="#but-can-call-other-functions-and-access-modules">But Can Call Other Functions and Access Modules</a></h2>
<p>All functions in the same <a href="language//book/engine/compile.html"><code>AST</code></a> can call each other.</p>
<pre><code class="language-rust">fn foo(x) {         // function defined in the global namespace
    x + 1
}

fn bar(x) {
    foo(x)          // ok! function 'foo' can be called
}</code></pre>
<p>In addition, <a href="language//book/rust/modules/index.html">modules</a> <a href="language//book/language/modules/import.html">imported</a> at global level can be accessed.</p>
<pre><code class="language-js">import "hello" as hey;
import "world" as woo;

{
    import "x" as xyz;  // &lt;- this module is not at global level
}                       // &lt;- it goes away here

fn foo(x) {
    hey::process(x);    // ok! imported module 'hey' can be accessed

    print(woo::value);  // ok! imported module 'woo' can be accessed

    xyz::do_work();     // &lt;- error: module 'xyz' not found
}
</code></pre>
<h2 id="automatic-global-module-1"><a class="header" href="#automatic-global-module-1">Automatic Global Module</a></h2>
<p>When a <a href="language//book/language/constants.html">constant</a> is declared at global scope, it is added to a special <a href="language//book/rust/modules/index.html">module</a> called <a href="language//book/language/global.html"><code>global</code></a>.</p>
<p>Functions can access those <a href="language//book/language/constants.html">constants</a> via the special <a href="language//book/language/global.html"><code>global</code></a> <a href="language//book/rust/modules/index.html">module</a>.</p>
<p>Naturally, the automatic <a href="language//book/language/global.html"><code>global</code></a> <a href="language//book/rust/modules/index.html">module</a> is not available under <a href="language//book/start/features.html"><code>no_function</code></a> nor <a href="language//book/start/features.html"><code>no_module</code></a>.</p>
<pre><code class="language-rust">const CONSTANT = 42;        // this constant is automatically added to 'global'

let hello = 1;              // variables are not added to 'global'

{
    const INNER = 0;        // this constant is not at global level
}                           // &lt;- it goes away here

fn foo(x) {
    x * global::hello       // &lt;- error: variable 'hello' not found in 'global'

    x * global::CONSTANT    // ok! 'CONSTANT' exists in 'global'

    x * global::INNER       // &lt;- error: constant 'INNER' not found in 'global'
}</code></pre>
<h2 id="use-before-definition-allowed"><a class="header" href="#use-before-definition-allowed">Use Before Definition Allowed</a></h2>
<p>Unlike C/C++, functions in Rhai can be defined <em>anywhere</em> at global level.</p>
<p>A function does not need to be defined prior to being used in a script; a statement in the script
can freely call a function defined afterwards.</p>
<p>This is similar to Rust and many other modern languages, such as JavaScript’s <code>function</code> keyword.</p>
<pre><code class="language-rust">let x = foo(41);    // &lt;- I can do this!

fn foo(x) {         // &lt;- define 'foo' after use
    x + 1
}</code></pre>
<h2 id="arguments-are-passed-by-value"><a class="header" href="#arguments-are-passed-by-value">Arguments are Passed by Value</a></h2>
<p>Functions defined in script always take <a href="language//book/language/dynamic.html"><code>Dynamic</code></a> parameters (i.e. they can be of any types).
Therefore, functions with the same name and same <em>number</em> of parameters are equivalent.</p>
<p>All arguments are passed by <em>value</em>, so all Rhai script-defined functions are <em>pure</em>
(i.e. they never modify their arguments).</p>
<p>Any update to an argument will <strong>not</strong> be reflected back to the caller.</p>
<pre><code class="language-rust">fn change(s) {      // 's' is passed by value
    s = 42;         // only a COPY of 's' is changed
}

let x = 500;

change(x);

x == 500;           // 'x' is NOT changed!</code></pre>
<div id="admonition-rhai-functions-are-pure" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-rhai-functions-are-pure-title">
<div class="admonition-title">
<div id="admonition-rhai-functions-are-pure-title">
<p>Rhai functions are pure</p>
</div>
<a class="admonition-anchor-link" href="language/functions.html#admonition-rhai-functions-are-pure"></a>
</div>
<div>
<p>The only possibility for a Rhai script-defined function to modify an external variable is
via the <a href="language/fn-method.html"><code>this</code></a> pointer.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="this--simulating-an-object-method"><a class="header" href="#this--simulating-an-object-method"><code>this</code> – Simulating an Object Method</a></h1>
<div id="admonition-functions-are-pure" class="admonition admonish-warning side" role="note" aria-labelledby="admonition-functions-are-pure-title">
<div class="admonition-title">
<div id="admonition-functions-are-pure-title">
<p>Functions are pure</p>
</div>
<a class="admonition-anchor-link" href="language/fn-method.html#admonition-functions-are-pure"></a>
</div>
<div>
<p>The only way for a script-defined <a href="language//book/language/functions.html">function</a> to change an external value is via <code>this</code>.</p>
</div>
</div>
<p>Arguments passed to script-defined <a href="language//book/language/functions.html">functions</a> are always by <em>value</em> because <a href="language//book/language/functions.html">functions</a> are <em>pure</em>.</p>
<p>However, <a href="language//book/language/functions.html">functions</a> can also be called in <em>method-call</em> style (not available under <a href="language//book/start/features.html"><code>no_object</code></a>):</p>
<blockquote>
<p><em>object</em> <code>.</code> <em>method</em> <code>(</code> <em>parameters</em> … <code>)</code></p>
</blockquote>
<p>When a <a href="language//book/language/functions.html">function</a> is called this way, the keyword <code>this</code> binds to the object in the method call and
can be changed.</p>
<pre><code class="language-rust">fn change() {       // note that the method does not need a parameter
    this = 42;      // 'this' binds to the object in method-call
}

let x = 500;

x.change();         // call 'change' in method-call style, 'this' binds to 'x'

x == 42;            // 'x' is changed!

change();           // &lt;- error: 'this' is unbound</code></pre>
<h2 id="elvis-operator"><a class="header" href="#elvis-operator">Elvis Operator</a></h2>
<p>The <a href="https://en.wikipedia.org/wiki/Elvis_operator"><em>Elvis</em> operator</a> can be used to short-circuit the method call when the object itself is <a href="language//book/language/values-and-types.html"><code>()</code></a>.</p>
<blockquote>
<p><em>object</em> <code>?.</code> <em>method</em> <code>(</code> <em>parameters</em> … <code>)</code></p>
</blockquote>
<p>In the above, the <em>method</em> is never called if <em>object</em> is <a href="language//book/language/values-and-types.html"><code>()</code></a>.</p>
<h2 id="restrict-the-type-of-this-in-function-definitions"><a class="header" href="#restrict-the-type-of-this-in-function-definitions">Restrict the Type of <code>this</code> in Function Definitions</a></h2>
<div id="admonition-tip-automatically-global" class="admonition admonish-tip side wide" role="note" aria-labelledby="admonition-tip-automatically-global-title">
<div class="admonition-title">
<div id="admonition-tip-automatically-global-title">
<p>Tip: Automatically global</p>
</div>
<a class="admonition-anchor-link" href="language/fn-method.html#admonition-tip-automatically-global"></a>
</div>
<div>
<p>Methods defined this way are automatically exposed to the <a href="language//book/language/fn-namespaces.html">global namespace</a>.</p>
</div>
</div>
<p>In many cases it may be desirable to implement <em>methods</em> for different <a href="language//book/rust/custom-types.html">custom types</a> using
script-defined <a href="language//book/language/functions.html">functions</a>.</p>
<h3 id="the-problem"><a class="header" href="#the-problem">The Problem</a></h3>
<p>Doing so is brittle and requires a lot of type checking code because there can only be one
<a href="language//book/language/functions.html">function</a> definition for the same name and arity:</p>
<pre><code class="language-js">// Really painful way to define a method called 'do_update' on various data types
fn do_update(x) {
    switch type_of(this) {
        "i64" =&gt; this *= x,
        "string" =&gt; this.len += x,
        "bool" if this =&gt; this *= x,
        "bool" =&gt; this *= 42,
        "MyType" =&gt; this.update(x),
        "Strange-Type#Name::with_!@#symbols" =&gt; this.update(x),
        _ =&gt; throw `I don't know how to handle ${type_of(this)}`!`
    }
}
</code></pre>
<h3 id="the-solution"><a class="header" href="#the-solution">The Solution</a></h3>
<p>With a special syntax, it is possible to restrict a <a href="language//book/language/functions.html">function</a> to be callable only when the object
pointed to by <code>this</code> is of a certain type:</p>
<blockquote>
<p><code>fn</code>  <em>type name</em> <code>.</code> <em>method</em> <code>(</code> <em>parameters</em> … <code>)  {</code>  …  <code>}</code></p>
</blockquote>
<p>or in quotes if the type name is not a valid identifier itself:</p>
<blockquote>
<p><code>fn</code>  <code>"</code><em>type name string</em><code>"</code> <code>.</code> <em>method</em> <code>(</code> <em>parameters</em> … <code>)  {</code>  …  <code>}</code></p>
</blockquote>
<p>Needless to say, this <em>typed method</em> definition style is not available under <a href="language//book/start/features.html"><code>no_object</code></a>.</p>
<div id="admonition-type-name-must-be-the-same-as-type_of" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-type-name-must-be-the-same-as-type_of-title">
<div class="admonition-title">
<div id="admonition-type-name-must-be-the-same-as-type_of-title">
<p>Type name must be the same as <code>type_of</code></p>
</div>
<a class="admonition-anchor-link" href="language/fn-method.html#admonition-type-name-must-be-the-same-as-type_of"></a>
</div>
<div>
<p>The <em>type name</em> specified in front of the <a href="language//book/language/functions.html">function</a> name must match the output of <a href="language//book/language/type-of.html"><code>type_of</code></a>
for the required type.</p>
</div>
</div>
<div id="admonition-tip-int-and-float" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-int-and-float-title">
<div class="admonition-title">
<div id="admonition-tip-int-and-float-title">
<p>Tip: <code>int</code> and <code>float</code></p>
</div>
<a class="admonition-anchor-link" href="language/fn-method.html#admonition-tip-int-and-float"></a>
</div>
<div>
<p><code>int</code> can be used in place of the system integer type (usually <code>i64</code> or <code>i32</code>).</p>
<p><code>float</code> can be used in place of the system floating-point type (usually <code>f64</code> or <code>f32</code>).</p>
<p>Using these make scripts more portable.</p>
</div>
</div>
<h3 id="examples-13"><a class="header" href="#examples-13">Examples</a></h3>
<pre><code class="language-js">/// This 'do_update' can only be called on objects of type 'MyType' in method style
fn MyType.do_update(x, y) {
    this.update(x * y);
}

/// This 'do_update' can only be called on objects of type 'Strange-Type#Name::with_!@#symbols'
/// (which can be specified via 'Engine::register_type_with_name') in method style
fn "Strange-Type#Name::with_!@#symbols".do_update(x, y) {
    this.update(x * y);
}

/// Define a blanket version
fn do_update(x, y) {
    this = `${this}, ${x}, ${y}`;
}

/// This 'do_update' can only be called on integers in method style
fn int.do_update(x, y) {
    this += x * y
}

let obj = create_my_type();     // 'x' is 'MyType'

obj.type_of() == "MyType";

obj.do_update(42, 123);         // ok!

let x = 42;                     // 'x' is an integer

x.type_of() == "i64";

x.do_update(42, 123);           // ok!

let x = true;                   // 'x' is a boolean

x.type_of() == "bool";

x.do_update(42, 123);           // &lt;- this works because there is a blanket version

// Use 'is_def_fn' with three parameters to test for typed methods

is_def_fn("MyType", "do_update", 2) == true;

is_def_fn("int", "do_update", 2) == true;
</code></pre>
<h2 id="bind-to-this-for-module-functions"><a class="header" href="#bind-to-this-for-module-functions">Bind to <code>this</code> for Module Functions</a></h2>
<h3 id="the-problem-1"><a class="header" href="#the-problem-1">The Problem</a></h3>
<p>The <em>method-call</em> syntax is not possible for <a href="language//book/language/functions.html">functions</a> <a href="language//book/language/modules/import.html">imported</a> from <a href="language//book/rust/modules/index.html">modules</a>.</p>
<pre><code class="language-js">import "my_module" as foo;

let x = 42;

x.foo::change_value(1);     // &lt;- syntax error
</code></pre>
<h3 id="the-solution-1"><a class="header" href="#the-solution-1">The Solution</a></h3>
<p>In order to call a <a href="language//book/rust/modules/index.html">module</a> <a href="language//book/language/functions.html">function</a> as a method, it must be defined with a restriction on the
type of object pointed to by <code>this</code>:</p>
<pre><code class="language-js">┌────────────────┐
│ my_module.rhai │
└────────────────┘

// This is a typed method function requiring 'this' to be an integer.
// Typed methods are automatically marked global when importing this module.
fn int.change_value(offset) {
    // 'this' is guaranteed to be an integer
    this += offset;
}


┌───────────┐
│ main.rhai │
└───────────┘

import "my_module";

let x = 42;

x.change_value(1);          // ok!

x == 43;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="function-overloading-1"><a class="header" href="#function-overloading-1">Function Overloading</a></h1>
<p><a href="language//book/language/functions.html">Functions</a> defined in script can be <em>overloaded</em> by <em>arity</em> (i.e. they are resolved purely upon the
function’s <em>name</em> and <em>number</em> of parameters, but not parameter <em>types</em> since all parameters are the
same type – <a href="language//book/language/dynamic.html"><code>Dynamic</code></a>).</p>
<p>New definitions <em>overwrite</em> previous definitions of the same name and number of parameters.</p>
<pre><code class="language-js">fn foo(x, y, z) {
    print(`Three!!! ${x}, ${y}, ${z}`);
}
fn foo(x) {
    print(`One! ${x}`);
}
fn foo(x, y) {
    print(`Two! ${x}, ${y}`);
}
fn foo() {
    print("None.");
}
fn foo(x) {     // &lt;- overwrites previous definition
    print(`HA! NEW ONE! ${x}`);
}

foo(1,2,3);     // prints "Three!!! 1,2,3"

foo(42);        // prints "HA! NEW ONE! 42"

foo(1,2);       // prints "Two!! 1,2"

foo();          // prints "None."
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="function-namespaces"><a class="header" href="#function-namespaces">Function Namespaces</a></h1>
<h2 id="each-function-is-a-separate-compilation-unit"><a class="header" href="#each-function-is-a-separate-compilation-unit">Each Function is a Separate Compilation Unit</a></h2>
<p><a href="language//book/language/functions.html">Functions</a> in Rhai are <em>pure</em> and they form individual <em>compilation units</em>.</p>
<p>This means that individual <a href="language//book/language/functions.html">functions</a> can be separated, exported, re-grouped, imported, and
generally mix-’n-matched with other completely unrelated scripts.</p>
<p>For example, the <code>AST::merge</code> and <code>AST::combine</code> methods (or the equivalent <code>+</code> and <code>+=</code> operators)
allow combining all <a href="language//book/language/functions.html">functions</a> in one <a href="language//book/engine/compile.html"><code>AST</code></a> into another, forming a new, unified, group of <a href="language//book/language/functions.html">functions</a>.</p>
<h2 id="namespace-types"><a class="header" href="#namespace-types">Namespace Types</a></h2>
<p>In general, there are two main types of <em>namespaces</em> where <a href="language//book/language/functions.html">functions</a> are looked up:</p>
<div class="table-wrapper"><table><thead><tr><th>Namespace</th><th style="text-align: center">Quantity</th><th>Source</th><th>Lookup</th><th style="text-align: center">Sub-modules?</th><th style="text-align: center">Variables?</th></tr></thead><tbody>
<tr><td>Global</td><td style="text-align: center">one</td><td><ol><li><a href="language//book/engine/compile.html"><code>AST</code></a> being evaluated</li><li><code>Engine::register_XXX</code> API</li><li>global registered <a href="language//book/rust/modules/index.html">modules</a></li><li><a href="language//book/language/functions.html">functions</a> in <a href="language//book/language/modules/import.html">imported</a> <a href="language//book/rust/modules/index.html">modules</a> marked <em>global</em></li><li><a href="language//book/language/functions.html">functions</a> in registered static <a href="language//book/rust/modules/index.html">modules</a> marked <em>global</em></li></ol></td><td>simple name</td><td style="text-align: center">ignored</td><td style="text-align: center">ignored</td></tr>
<tr><td>Module</td><td style="text-align: center">many</td><td><ol><li><a href="language//book/rust/modules/index.html">Module</a> registered via <code>Engine::register_static_module</code></li><li><a href="language//book/rust/modules/index.html">Module</a> loaded via <a href="language//book/language/modules/import.html"><code>import</code></a> statement</li></ol></td><td>namespace-qualified name</td><td style="text-align: center">yes</td><td style="text-align: center">yes</td></tr>
</tbody></table>
</div>
<h3 id="module-namespaces"><a class="header" href="#module-namespaces">Module Namespaces</a></h3>
<p>There can be multiple <a href="language//book/rust/modules/index.html">module</a> namespaces at any time during a script evaluation, usually loaded via
the <a href="language//book/language/modules/import.html"><code>import</code></a> statement.</p>
<p><em>Static</em> <a href="language//book/rust/modules/index.html">module</a> namespaces can also be registered into an <a href="language//book/engine/hello-world.html"><code>Engine</code></a> via <code>Engine::register_static_module</code>.</p>
<p><a href="language//book/language/functions.html">Functions</a> and <a href="language//book/language/variables.html">variables</a> in module namespaces are isolated and encapsulated within their own environments.</p>
<p>They must be called or accessed in a <em>namespace-qualified</em> manner.</p>
<pre><code class="language-js">import "my_module" as m;        // new module namespace 'm' created via 'import'

let x = m::calc_result();       // namespace-qualified function call

let y = m::MY_NUMBER;           // namespace-qualified variable/constant access

let z = calc_result();          // &lt;- error: function 'calc_result' not found
                                //    in global namespace!
</code></pre>
<h3 id="global-namespace"><a class="header" href="#global-namespace">Global Namespace</a></h3>
<p>There is one <em>global</em> namespace for every <a href="language//book/engine/hello-world.html"><code>Engine</code></a>, which includes (in the following search order):</p>
<ul>
<li>
<p>all <a href="language//book/language/functions.html">functions</a> defined in the <a href="language//book/engine/compile.html"><code>AST</code></a> currently being evaluated,</p>
</li>
<li>
<p>all native Rust functions and iterators registered via the <code>Engine::register_XXX</code> API,</p>
</li>
<li>
<p>all functions and iterators defined in global <a href="language//book/rust/modules/index.html">modules</a> that are registered into the <a href="language//book/engine/hello-world.html"><code>Engine</code></a>
via <code>register_global_module</code>,</p>
</li>
<li>
<p>functions defined in <a href="language//book/rust/modules/index.html">modules</a> registered into the <a href="language//book/engine/hello-world.html"><code>Engine</code></a> via <code>register_static_module</code> that
are specifically marked for exposure to the global namespace (e.g. via the <code>#[rhai(global)]</code>
attribute in a <a href="language//book/plugins/module.html">plugin module</a>).</p>
</li>
<li>
<p><a href="language//book/language/functions.html">functions</a> defined in <a href="language//book/language/modules/import.html">imported</a> <a href="language//book/rust/modules/index.html">modules</a> that are specifically marked for exposure to
the global namespace (e.g. via the <code>#[rhai(global)]</code> attribute in a <a href="language//book/plugins/module.html">plugin module</a>).</p>
</li>
</ul>
<p>Anywhere in a Rhai script, when a function call is made, the function is searched within the
global namespace, in the above search order.</p>
<p>Therefore, function calls in Rhai are <em>late</em> bound – meaning that the function called cannot be
determined or guaranteed; there is no way to <em>lock down</em> the function being called.
This aspect is very similar to JavaScript before ES6 modules.</p>
<pre><code class="language-rust">// Compile a script into AST
let ast1 = engine.compile(
r#"
    fn get_message() {
        "Hello!"                // greeting message
    }

    fn say_hello() {
        print(get_message());   // prints message
    }

    say_hello();
"#)?;

// Compile another script with an overriding function
let ast2 = engine.compile(r#"fn get_message() { "Boo!" }"#)?;

// Combine the two AST's
ast1 += ast2;                   // 'message' will be overwritten

engine.run_ast(&amp;ast1)?;         // prints 'Boo!'</code></pre>
<p>Therefore, care must be taken when <em>cross-calling</em> <a href="language//book/language/functions.html">functions</a> to make sure that the correct
<a href="language//book/language/functions.html">function</a> is called.</p>
<p>The only practical way to ensure that a <a href="language//book/language/functions.html">function</a> is a correct one is to use <a href="language//book/rust/modules/index.html">modules</a> –
i.e. define the <a href="language//book/language/functions.html">function</a> in a separate <a href="language//book/rust/modules/index.html">module</a> and then <a href="language//book/language/modules/import.html"><code>import</code></a> it:</p>
<pre><code class="language-js">┌──────────────┐
│ message.rhai │
└──────────────┘

fn get_message() { "Hello!" }


┌─────────────┐
│ script.rhai │
└─────────────┘

import "message" as msg;

fn say_hello() {
    print(msg::get_message());
}
say_hello();
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="function-pointers"><a class="header" href="#function-pointers">Function Pointers</a></h1>
<div id="admonition-trivia" class="admonition admonish-question side" role="note" aria-labelledby="admonition-trivia-title">
<div class="admonition-title">
<div id="admonition-trivia-title">
<p>Trivia</p>
</div>
<a class="admonition-anchor-link" href="language/fn-ptr.html#admonition-trivia"></a>
</div>
<div>
<p>A function pointer simply stores the <em>name</em> of the <a href="language//book/language/functions.html">function</a> as a <a href="language//book/language/strings-chars.html">string</a>.</p>
</div>
</div>
<p>It is possible to store a <em>function pointer</em> in a variable just like a normal value.</p>
<p>A function pointer is created via the <code>Fn</code> <a href="language//book/language/functions.html">function</a>, which takes a <a href="language//book/language/strings-chars.html">string</a> parameter.</p>
<p>Call a function pointer via the <code>call</code> method.</p>
<h2 id="short-hand-notation"><a class="header" href="#short-hand-notation">Short-Hand Notation</a></h2>
<div id="admonition-not-for-native" class="admonition admonish-warning side" role="note" aria-labelledby="admonition-not-for-native-title">
<div class="admonition-title">
<div id="admonition-not-for-native-title">
<p>Not for native</p>
</div>
<a class="admonition-anchor-link" href="language/fn-ptr.html#admonition-not-for-native"></a>
</div>
<div>
<p>Native Rust functions cannot use this short-hand notation.</p>
</div>
</div>
<p>Having to write <code>Fn("foo")</code> in order to create a function pointer to the <a href="language//book/language/functions.html">function</a> <code>foo</code> is a chore,
so there is a short-hand available.</p>
<p>A function pointer to any <em>script-defined</em> <a href="language//book/language/functions.html">function</a> <em>within the same script</em> can be obtained simply
by referring to the <a href="language//book/language/functions.html">function’s</a> name.</p>
<pre><code class="language-rust">fn foo() { ... }        // function definition

let f = foo;            // function pointer to 'foo'

let f = Fn("foo");      // &lt;- the above is equivalent to this

let g = bar;            // error: variable 'bar' not found</code></pre>
<p>The short-hand notation is particularly useful when passing <a href="language//book/language/functions.html">functions</a> as <a href="language//book/language/fn-closure.html">closure</a> arguments.</p>
<pre><code class="language-rust">fn is_even(n) { n % 2 == 0 }

let array = [1, 2, 3, 4, 5];

array.filter(is_even);

array.filter(Fn("is_even"));    // &lt;- the above is equivalent to this

array.filter(|n| n % 2 == 0);   // &lt;- ... or this</code></pre>
<h2 id="built-in-functions-5"><a class="header" href="#built-in-functions-5">Built-in Functions</a></h2>
<p>The following standard methods (mostly defined in the <a href="language//book/rust/packages/builtin.html"><code>BasicFnPackage</code></a> but
excluded when using a <a href="language//book/engine/raw.html">raw <code>Engine</code></a>) operate on function pointers.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Parameter(s)</th><th>Description</th></tr></thead><tbody>
<tr><td><code>name</code> method and property</td><td><em>none</em></td><td>returns the name of the <a href="language//book/language/functions.html">function</a> encapsulated by the function pointer</td></tr>
<tr><td><code>is_anonymous</code> method and property</td><td><em>none</em></td><td>does the function pointer refer to an <a href="language//book/language/fn-anon.html">anonymous function</a>? Not available under <a href="language//book/start/features.html"><code>no_function</code></a>.</td></tr>
<tr><td><code>call</code></td><td><em>arguments</em></td><td>calls the <a href="language//book/language/functions.html">function</a> matching the function pointer’s name with the <em>arguments</em></td></tr>
</tbody></table>
</div>
<h2 id="examples-14"><a class="header" href="#examples-14">Examples</a></h2>
<pre><code class="language-rust">fn foo(x) { 41 + x }

let func = Fn("foo");       // use the 'Fn' function to create a function pointer

let func = foo;             // &lt;- short-hand: equivalent to 'Fn("foo")'

print(func);                // prints 'Fn(foo)'

let func = fn_name.Fn();    // &lt;- error: 'Fn' cannot be called in method-call style

func.type_of() == "Fn";     // type_of() as function pointer is 'Fn'

func.name == "foo";

func.call(1) == 42;         // call a function pointer with the 'call' method

foo(1) == 42;               // &lt;- the above de-sugars to this

call(func, 1);              // normal function call style also works for 'call'

let len = Fn("len");        // 'Fn' also works with registered native Rust functions

len.call("hello") == 5;

let fn_name = "hello";      // the function name does not have to exist yet

let hello = Fn(fn_name + "_world");

hello.call(0);              // error: function not found - 'hello_world (i64)'</code></pre>
<div id="admonition-not-first-class-functions" class="admonition admonish-warning" role="note" aria-labelledby="admonition-not-first-class-functions-title">
<div class="admonition-title">
<div id="admonition-not-first-class-functions-title">
<p>Not First-Class Functions</p>
</div>
<a class="admonition-anchor-link" href="language/fn-ptr.html#admonition-not-first-class-functions"></a>
</div>
<div>
<p>Beware that function pointers are <em>not</em> first-class functions.</p>
<p>They are <em>syntactic sugar</em> only, capturing only the <em>name</em> of a <a href="language//book/language/functions.html">function</a> to call.
They do not hold the actual <a href="language//book/language/functions.html">functions</a>.</p>
<p>The actual <a href="language//book/language/functions.html">function</a> must be defined in the appropriate <a href="language//book/language/fn-namespaces.html">namespace</a>
for the call to succeed.</p>
</div>
</div>
<div id="admonition-global-namespace-only" class="admonition admonish-warning" role="note" aria-labelledby="admonition-global-namespace-only-title">
<div class="admonition-title">
<div id="admonition-global-namespace-only-title">
<p>Global Namespace Only</p>
</div>
<a class="admonition-anchor-link" href="language/fn-ptr.html#admonition-global-namespace-only"></a>
</div>
<div>
<p>Because of their dynamic nature, function pointers cannot refer to functions in <a href="language//book/language/modules/import.html"><code>import</code></a>-ed <a href="language//book/rust/modules/index.html">modules</a>.</p>
<p>They can only refer to <a href="language//book/language/functions.html">functions</a> within the global <a href="language//book/language/fn-namespaces.html">namespace</a>.</p>
<pre><code class="language-js">import "foo" as f;          // assume there is 'f::do_work()'

f::do_work();               // works!

let p = Fn("f::do_work");   // error: invalid function name

fn do_work_now() {          // call it from a local function
    f::do_work();
}

let p = Fn("do_work_now");

p.call();                   // works!
</code></pre>
</div>
</div>
<h2 id="dynamic-dispatch"><a class="header" href="#dynamic-dispatch">Dynamic Dispatch</a></h2>
<p>The purpose of function pointers is to enable rudimentary <em>dynamic dispatch</em>, meaning to determine,
at runtime, which function to call among a group.</p>
<p>Although it is possible to simulate dynamic dispatch via a number and a large
<a href="language//book/language/if.html"><code>if-then-else-if</code></a> statement, using function pointers significantly simplifies the code.</p>
<pre><code class="language-rust">let x = some_calculation();

// These are the functions to call depending on the value of 'x'
fn method1(x) { ... }
fn method2(x) { ... }
fn method3(x) { ... }

// Traditional - using decision variable
let func = sign(x);

// Dispatch with if-statement
if func == -1 {
    method1(42);
} else if func == 0 {
    method2(42);
} else if func == 1 {
    method3(42);
}

// Using pure function pointer
let func = if x &lt; 0 {
    method1
} else if x == 0 {
    method2
} else if x &gt; 0 {
    method3
};

// Dynamic dispatch
func.call(42);

// Using functions map
let map = [ method1, method2, method3 ];

let func = sign(x) + 1;

// Dynamic dispatch
map[func].call(42);</code></pre>
<h2 id="bind-the-this-pointer-1"><a class="header" href="#bind-the-this-pointer-1">Bind the <code>this</code> Pointer</a></h2>
<p>When <code>call</code> is called as a <em>method</em> but not on a function pointer, it is possible to dynamically dispatch
to a function call while binding the object in the method call to the <code>this</code> pointer of the function.</p>
<p>To achieve this, pass the function pointer as the <em>first</em> argument to <code>call</code>:</p>
<pre><code class="language-rust">fn add(x) {                 // define function which uses 'this'
    this += x;
}

let func = add;             // function pointer to 'add'

func.call(1);               // error: 'this' pointer is not bound

let x = 41;

func.call(x, 1);            // error: function 'add (i64, i64)' not found

call(func, x, 1);           // error: function 'add (i64, i64)' not found

x.call(func, 1);            // 'this' is bound to 'x', dispatched to 'func'

x == 42;</code></pre>
<p>Beware that this only works for <a href="language/fn-method.html"><em>method-call</em></a> style.
Normal function-call style cannot bind the <code>this</code> pointer (for syntactic reasons).</p>
<p>Therefore, obviously, binding the <code>this</code> pointer is unsupported under <a href="language//book/start/features.html"><code>no_object</code></a>.</p>
<h2 id="call-a-function-pointer-within-a-rust-function-as-a-callback"><a class="header" href="#call-a-function-pointer-within-a-rust-function-as-a-callback">Call a Function Pointer within a Rust Function (as a Callback)</a></h2>
<p>It is completely normal to register a Rust function with an <a href="language//book/engine/hello-world.html"><code>Engine</code></a> that takes parameters
whose types are function pointers.  The Rust type in question is <code>rhai::FnPtr</code>.</p>
<p>A function pointer in Rhai is essentially syntactic sugar wrapping the <em>name</em> of a function
to call in script.  Therefore, the script’s <em>execution context</em> (i.e. <a href="language//book/rust/context.html"><code>NativeCallContext</code></a>)
is needed in order to call a function pointer.</p>
<pre><code class="language-rust">use rhai::{Engine, FnPtr, NativeCallContext};

let mut engine = Engine::new();

// A function expecting a callback in form of a function pointer.
fn super_call(context: NativeCallContext, callback: FnPtr, value: i64)
                -&gt; Result&lt;String, Box&lt;EvalAltResult&gt;&gt;
{
    // Use 'FnPtr::call_within_context' to call the function pointer using the call context.
    // 'FnPtr::call_within_context' automatically casts to the required result type.
    callback.call_within_context(&amp;context, (value,))
    //                                     ^^^^^^^^ arguments passed in tuple
}

engine.register_fn("super_call", super_call);</code></pre>
<h2 id="call-a-function-pointer-directly"><a class="header" href="#call-a-function-pointer-directly">Call a Function Pointer Directly</a></h2>
<p>The <code>FnPtr::call</code> method allows the function pointer to be called directly on any <a href="language//book/engine/hello-world.html"><code>Engine</code></a> and
<a href="language//book/engine/compile.html"><code>AST</code></a>, making it possible to reuse the <code>FnPtr</code> data type in may different calls and scripting
environments.</p>
<pre><code class="language-rust">use rhai::{Engine, FnPtr};

let engine = Engine::new();

// Compile script to AST
let ast = engine.compile(
r#"
    let test = "hello";
    |x| test + x            // this creates a closure
"#)?;

// Save the closure together with captured variables
let fn_ptr = engine.eval_ast::&lt;FnPtr&gt;(&amp;ast)?;

// 'f' captures: the Engine, the AST, and the closure
let f = move |x: i64| -&gt; Result&lt;String, _&gt; {
            fn_ptr.call(&amp;engine, &amp;ast, (x,))
        };

// 'f' can be called like a normal function
let result = f(42)?;

result == "hello42";</code></pre>
<h2 id="bind-to-a-native-rust-function"><a class="header" href="#bind-to-a-native-rust-function">Bind to a native Rust Function</a></h2>
<p>It is also possible to create a function pointer that binds to a native Rust function or a Rust closure.</p>
<p>The signature of the native Rust function takes the following form.</p>
<blockquote>
<pre><code class="language-rust">Fn(context: NativeCallContext, args: &amp;mut [&amp;mut Dynamic])  
   -&gt; Result&lt;Dynamic, Box&lt;EvalAltResult&gt;&gt; + 'static</code></pre>
</blockquote>
<p>where:</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th style="text-align: center">Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>context</code></td><td style="text-align: center"><a href="language//book/rust/context.html"><code>NativeCallContext</code></a></td><td>mutable reference to the current <em>call context</em></td></tr>
<tr><td><code>args</code></td><td style="text-align: center"><code>&amp;mut [&amp;mut Dynamic]</code></td><td>mutable reference to list of arguments</td></tr>
</tbody></table>
</div>
<p>When such a function pointer is used in script, the native Rust function will be called
with the arguments provided.</p>
<p>The Rust function should check whether the appropriate number of arguments have been passed.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="function-pointer-currying"><a class="header" href="#function-pointer-currying">Function Pointer Currying</a></h1>
<p>It is possible to <em>curry</em> a <a href="language//book/language/fn-ptr.html">function pointer</a> by providing partial (or all) arguments.</p>
<p>Currying is done via the <code>curry</code> keyword and produces a new <a href="language//book/language/fn-ptr.html">function pointer</a> which carries
the curried arguments.</p>
<p>When the curried <a href="language//book/language/fn-ptr.html">function pointer</a> is called, the curried arguments are inserted starting from the <em>left</em>.</p>
<p>The actual call arguments should be reduced by the number of curried arguments.</p>
<pre><code class="language-rust">fn mul(x, y) {                  // function with two parameters
    x * y
}

let func = mul;                 // &lt;- de-sugars to 'Fn("mul")'

func.call(21, 2) == 42;         // two arguments are required for 'mul'

let curried = func.curry(21);   // currying produces a new function pointer which
                                // carries 21 as the first argument

let curried = curry(func, 21);  // function-call style also works

curried.call(2) == 42;          // &lt;- de-sugars to 'func.call(21, 2)'
                                //    only one argument is now required</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="anonymous-functions"><a class="header" href="#anonymous-functions">Anonymous Functions</a></h1>
<p>Many functions in the standard API expect <a href="language//book/language/fn-ptr.html">function pointer</a> as parameters.</p>
<p>For example:</p>
<pre><code class="language-rust">// Function 'double' defined here - used only once
fn double(x) { 2 * x }

// Function 'square' defined here - again used only once
fn square(x) { x * x }

let x = [1, 2, 3, 4, 5];

// Pass a function pointer to 'double'
let y = x.map(double);

// Pass a function pointer to 'square' using Fn(...) notation
let z = y.map(Fn("square"));</code></pre>
<p>Sometimes it gets tedious to define separate <a href="language//book/language/functions.html">functions</a> only to dispatch them via single <a href="language//book/language/fn-ptr.html">function pointers</a> –
essentially, those <a href="language//book/language/functions.html">functions</a> are only ever called in one place.</p>
<p>This scenario is especially common when simulating object-oriented programming (<a href="language//book/patterns/oop.html">OOP</a>).</p>
<pre><code class="language-rust">// Define functions one-by-one
fn obj_inc(x, y) { this.data += x * y; }
fn obj_dec(x) { this.data -= x; }
fn obj_print() { print(this.data); }

// Define object
let obj = #{
    data: 42,
    increment: obj_inc,     // use function pointers to
    decrement: obj_dec,     // refer to method functions
    print: obj_print
};</code></pre>
<h2 id="syntax-3"><a class="header" href="#syntax-3">Syntax</a></h2>
<p>Anonymous <a href="language//book/language/functions.html">functions</a> have a syntax similar to Rust’s <em>closures</em> (they are <em>not</em> the same).</p>
<blockquote>
<p><code>|</code><em>param 1</em><code>,</code> <em>param 2</em><code>,</code> … <code>,</code> <em>param n</em><code>|</code> <em>statement</em></p>
<p><code>|</code><em>param 1</em><code>,</code> <em>param 2</em><code>,</code> … <code>,</code> <em>param n</em><code>| {</code> <em>statements</em>… <code>}</code></p>
</blockquote>
<p>No parameters:</p>
<blockquote>
<p><code>||</code> <em>statement</em></p>
<p><code>|| {</code> <em>statements</em>… <code>}</code></p>
</blockquote>
<p>Anonymous functions can be disabled via <a href="language//book/engine/options.html"><code>Engine::set_allow_anonymous_function</code></a>.</p>
<h2 id="rewrite-using-anonymous-functions"><a class="header" href="#rewrite-using-anonymous-functions">Rewrite Using Anonymous Functions</a></h2>
<p>The above can be rewritten using <em>anonymous <a href="language//book/language/functions.html">functions</a></em>.</p>
<pre><code class="language-rust">let x = [1, 2, 3, 4, 5];

let y = x.map(|x| 2 * x);

let z = y.map(|x| x * x);

let obj = #{
    data: 42,
    increment: |x, y| this.data += x * y,   // one statement
    decrement: |x| this.data -= x,          // one statement
    print_obj: || {
        print(this.data);                   // full function body
    }
};</code></pre>
<p>This de-sugars to:</p>
<pre><code class="language-rust">// Automatically generated...
fn anon_fn_0001(x) { 2 * x }
fn anon_fn_0002(x) { x * x }
fn anon_fn_0003(x, y) { this.data += x * y; }
fn anon_fn_0004(x) { this.data -= x; }
fn anon_fn_0005() { print(this.data); }

let x = [1, 2, 3, 4, 5];

let y = x.map(anon_fn_0001);

let z = y.map(anon_fn_0002);

let obj = #{
    data: 42,
    increment: anon_fn_0003,
    decrement: anon_fn_0004,
    print: anon_fn_0005
};</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="closures"><a class="header" href="#closures">Closures</a></h1>
<div id="admonition-tip-is_shared" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-is_shared-title">
<div class="admonition-title">
<div id="admonition-tip-is_shared-title">
<p>Tip: <code>is_shared</code></p>
</div>
<a class="admonition-anchor-link" href="language/fn-closure.html#admonition-tip-is_shared"></a>
</div>
<div>
<p>Use <code>Dynamic::is_shared</code> to check whether a particular <a href="language//book/language/dynamic.html"><code>Dynamic</code></a> value is shared.</p>
</div>
</div>
<p>Although <a href="language//book/language/fn-anon.html">anonymous functions</a> de-sugar to standard function definitions, they differ from standard
functions because they can <em>captures</em> <a href="language//book/language/variables.html">variables</a> that are not defined within the current scope,
but are instead defined in an external scope – i.e. where the <a href="language//book/language/fn-anon.html">anonymous function</a> is created.</p>
<p>All <a href="language//book/language/variables.html">variables</a> that are accessible during the time the <a href="language//book/language/fn-anon.html">anonymous function</a> is created are
automatically captured when they are used, as long as they are not shadowed by local <a href="language//book/language/variables.html">variables</a>
defined within the function’s.</p>
<p>The captured <a href="language//book/language/variables.html">variables</a> are automatically converted into <strong>reference-counted shared values</strong>
(<code>Rc&lt;RefCell&lt;Dynamic&gt;&gt;</code>, or <code>Arc&lt;RwLock&lt;Dynamic&gt;&gt;</code> under <a href="language//book/start/features.html"><code>sync</code></a>).</p>
<p>Therefore, similar to closures in many languages, these captured shared values persist through
reference counting, and may be read or modified even after the <a href="language//book/language/variables.html">variables</a> that hold them go out of
scope and no longer exist.</p>
<div id="admonition-tip-disable-closures" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-disable-closures-title">
<div class="admonition-title">
<div id="admonition-tip-disable-closures-title">
<p>Tip: Disable closures</p>
</div>
<a class="admonition-anchor-link" href="language/fn-closure.html#admonition-tip-disable-closures"></a>
</div>
<div>
<p>Capturing external <a href="language//book/language/variables.html">variables</a> can be turned off via the <a href="language//book/start/features.html"><code>no_closure</code></a> feature.</p>
</div>
</div>
<h2 id="examples-15"><a class="header" href="#examples-15">Examples</a></h2>
<pre><code class="language-rust">let x = 1;                          // a normal variable

x.is_shared() == false;

let f = |y| x + y;                  // variable 'x' is auto-curried (captured) into 'f'

x.is_shared() == true;              // 'x' is now a shared value!

f.call(2) == 3;                     // 1 + 2 == 3

x = 40;                             // changing 'x'...

f.call(2) == 42;                    // the value of 'x' is 40 because 'x' is shared

// The above de-sugars into something like this:

fn anon_0001(x, y) { x + y }        // parameter 'x' is inserted

make_shared(x);                     // convert variable 'x' into a shared value

let f = anon_0001.curry(x);         // shared 'x' is curried</code></pre>
<div id="admonition-beware-captured-variables-are-truly-shared" class="admonition admonish-bug" role="note" aria-labelledby="admonition-beware-captured-variables-are-truly-shared-title">
<div class="admonition-title">
<div id="admonition-beware-captured-variables-are-truly-shared-title">
<p>Beware: Captured Variables are Truly Shared</p>
</div>
<a class="admonition-anchor-link" href="language/fn-closure.html#admonition-beware-captured-variables-are-truly-shared"></a>
</div>
<div>
<p>The example below is a typical tutorial sample for many languages to illustrate the traps
that may accompany capturing external <a href="language//book/language/variables.html">variables</a> in closures.</p>
<p>It prints <code>9</code>, <code>9</code>, <code>9</code>, … <code>9</code>, <code>9</code>, not <code>0</code>, <code>1</code>, <code>2</code>, … <code>8</code>, <code>9</code>, because there is
ever only <em>one</em> captured <a href="language//book/language/variables.html">variable</a>, and all ten closures capture the <em>same</em> <a href="language//book/language/variables.html">variable</a>.</p>
<pre><code class="language-rust">let list = [];

for i in 0..10 {
    list.push(|| print(i));         // the for loop variable 'i' is captured
}

list.len() == 10;                   // 10 closures stored in the array

list[0].type_of() == "Fn";          // make sure these are closures

for f in list {
    f.call();                       // all references to 'i' are the same variable!
}</code></pre>
</div>
</div>
<div id="admonition-be-careful-to-prevent-data-races" class="admonition admonish-danger" role="note" aria-labelledby="admonition-be-careful-to-prevent-data-races-title">
<div class="admonition-title">
<div id="admonition-be-careful-to-prevent-data-races-title">
<p>Be Careful to Prevent Data Races</p>
</div>
<a class="admonition-anchor-link" href="language/fn-closure.html#admonition-be-careful-to-prevent-data-races"></a>
</div>
<div>
<p>Rust does not have data races, but that doesn’t mean Rhai doesn’t.</p>
<p>Avoid performing a method call on a captured shared <a href="language//book/language/variables.html">variable</a> (which essentially takes a
mutable reference to the shared object) while using that same <a href="language//book/language/variables.html">variable</a> as a parameter
in the method call – this is a sure-fire way to generate a data race error.</p>
<p>If a shared value is used as the <code>this</code> pointer in a method call to a closure function,
then the same shared value <em>must not</em> be captured inside that function, or a data race
will occur and the script will terminate with an error.</p>
<pre><code class="language-rust">let x = 20;

x.is_shared() == false;             // 'x' is not shared, so no data race is possible

let f = |a| this += x + a;          // 'x' is captured in this closure

x.is_shared() == true;              // now 'x' is shared

x.call(f, 2);                       // &lt;- error: data race detected on 'x'</code></pre>
</div>
</div>
<div id="admonition-data-races-in-sync-builds-can-become-deadlocks" class="admonition admonish-danger" role="note" aria-labelledby="admonition-data-races-in-sync-builds-can-become-deadlocks-title">
<div class="admonition-title">
<div id="admonition-data-races-in-sync-builds-can-become-deadlocks-title">
<p>Data Races in <code>sync</code> Builds Can Become Deadlocks</p>
</div>
<a class="admonition-anchor-link" href="language/fn-closure.html#admonition-data-races-in-sync-builds-can-become-deadlocks"></a>
</div>
<div>
<p>Under the <a href="language//book/start/features.html"><code>sync</code></a> feature, shared values are guarded with a <code>RwLock</code>, meaning that data race
conditions no longer raise an error.</p>
<p>Instead, they wait endlessly for the <code>RwLock</code> to be freed, and thus can become deadlocks.</p>
<p>On the other hand, since the same thread (i.e. the <a href="language//book/engine/hello-world.html"><code>Engine</code></a> thread) that is holding the lock
is attempting to read it again, this may also <a href="https://doc.rust-lang.org/std/sync/struct.RwLock.html#panics-1">panic</a>
depending on the O/S.</p>
<pre><code class="language-rust">let x = 20;

let f = |a| this += x + a;          // 'x' is captured in this closure

// Under `sync`, the following may wait forever, or may panic,
// because 'x' is locked as the `this` pointer but also accessed
// via a captured shared value.
x.call(f, 2);</code></pre>
</div>
</div>
<h2 id="tldr-4"><a class="header" href="#tldr-4">TL;DR</a></h2>
<div id="admonition-how-is-it-actually-implemented" class="admonition admonish-question" role="note" aria-labelledby="admonition-how-is-it-actually-implemented-title">
<div class="admonition-title">
<div id="admonition-how-is-it-actually-implemented-title">
<p>How is it actually implemented?</p>
</div>
<a class="admonition-anchor-link" href="language/fn-closure.html#admonition-how-is-it-actually-implemented"></a>
</div>
<div>
<p>The actual implementation of closures de-sugars to:</p>
<ol>
<li>
<p>Keeping track of what <a href="language//book/language/variables.html">variables</a> are accessed inside the <a href="language//book/language/fn-anon.html">anonymous function</a>,</p>
</li>
<li>
<p>If a <a href="language//book/language/variables.html">variable</a> is not defined within the <a href="language//book/language/fn-anon.html">anonymous function’s</a> scope,
it is looked up <em>outside</em> the <a href="language//book/language/functions.html">function</a> and in the current execution scope –
where the <a href="language//book/language/fn-anon.html">anonymous function</a> is created.</p>
</li>
<li>
<p>The <a href="language//book/language/variables.html">variable</a> is added to the parameters list of the <a href="language//book/language/fn-anon.html">anonymous function</a>, at the front.</p>
</li>
<li>
<p>The <a href="language//book/language/variables.html">variable</a> is then converted into a <strong>reference-counted shared value</strong>.</p>
<p>An <a href="language//book/language/fn-anon.html">anonymous function</a> which captures an external <a href="language//book/language/variables.html">variable</a> is the only way to create a
reference-counted shared value in Rhai.</p>
</li>
<li>
<p>The shared value is then <a href="language//book/language/fn-curry.html">curried</a> into the <a href="language//book/language/fn-ptr.html">function pointer</a> itself,
essentially carrying a reference to that shared value and inserting it into future calls of the <a href="language//book/language/functions.html">function</a>.</p>
<p>This process is called <em>Automatic Currying</em>, and is the mechanism through which Rhai simulates closures.</p>
</li>
</ol>
</div>
</div>
<div id="admonition-why-automatic-currying" class="admonition admonish-question" role="note" aria-labelledby="admonition-why-automatic-currying-title">
<div class="admonition-title">
<div id="admonition-why-automatic-currying-title">
<p>Why automatic currying?</p>
</div>
<a class="admonition-anchor-link" href="language/fn-closure.html#admonition-why-automatic-currying"></a>
</div>
<div>
<p>In concept, a closure <em>closes</em> over captured variables from the outer scope – that’s why
they are called <em>closures</em>.  When this happen, a typical language implementation hoists
those variables that are captured away from the stack frame and into heap-allocated storage.
This is because those variables may be needed after the stack frame goes away.</p>
<p>These heap-allocated captured variables only go away when all the closures that need them
are finished with them.  A garbage collector makes this trivial to implement – they are
automatically collected as soon as all closures needing them are destroyed.</p>
<p>In Rust, this can be done by reference counting instead, with the potential pitfall of creating
reference loops that will prevent those variables from being deallocated forever.
Rhai avoids this by clone-copying most data values, so reference loops are hard to create.</p>
<p>Rhai does the hoisting of captured variables into the heap by converting those values
into reference-counted locked values, also allocated on the heap.  The process is identical.</p>
<p>Closures are usually implemented as a data structure containing two items:</p>
<ol>
<li>A function pointer to the function body of the closure,</li>
<li>A data structure containing references to the captured shared variables on the heap.</li>
</ol>
<p>Usually a language implementation passes the structure containing references to captured
shared variables into the function pointer, the function body taking this data structure
as an additional parameter.</p>
<p>This is essentially what Rhai does, except that Rhai passes each variable individually
as separate parameters to the function, instead of creating a structure and passing that
structure as a single parameter.  This is the only difference.</p>
<p>Therefore, in most languages, essentially all closures are implemented as automatic currying of
shared variables hoisted into the heap, automatically passing those variables as parameters into
the function. Rhai just brings this directly up to the front.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="functions-and-custom-types-metadata"><a class="header" href="#functions-and-custom-types-metadata">Functions and Custom Types Metadata</a></h1>
<div id="admonition-requires-metadata" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-requires-metadata-title">
<div class="admonition-title">
<div id="admonition-requires-metadata-title">
<p>Requires <code>metadata</code></p>
</div>
<a class="admonition-anchor-link" href="engine/metadata/index.html#admonition-requires-metadata"></a>
</div>
<div>
<p>Exporting metadata requires the <a href="engine/metadata//book/start/features.html"><code>metadata</code></a> feature.</p>
</div>
</div>
<h2 id="functions-1"><a class="header" href="#functions-1">Functions</a></h2>
<p>The <em>metadata</em> of a <a href="engine/metadata//book/language/functions.html">function</a> means all relevant information related to a function’s
definition including:</p>
<ol>
<li>
<p>Its callable name</p>
</li>
<li>
<p>Its access mode (public or <a href="engine/metadata//book/language/modules/export.html">private</a>)</p>
</li>
<li>
<p>Its parameter names and types (if any)</p>
</li>
<li>
<p>Its return value and type (if any)</p>
</li>
<li>
<p>Its nature (i.e. native Rust or Rhai-scripted)</p>
</li>
<li>
<p>Its <a href="engine/metadata//book/language/fn-namespaces.html">namespace</a> (<a href="engine/metadata//book/rust/modules/index.html">module</a> or global)</p>
</li>
<li>
<p>Its purpose, in the form of <a href="engine/metadata//book/language/doc-comments.html">doc-comments</a></p>
</li>
<li>
<p>Usage notes, warnings, examples etc., in the form of <a href="engine/metadata//book/language/doc-comments.html">doc-comments</a></p>
</li>
</ol>
<p>A function’s <em>signature</em> encapsulates the first four pieces of information in a single concise line
of definition:</p>
<blockquote>
<p><code>[private]</code> <em>name</em> <code>(</code><em>param 1</em><code>:</code><em>type 1</em><code>,</code> <em>param 2</em><code>:</code><em>type 2</em><code>,</code> … <code>,</code> <em>param n</em><code>:</code><em>type n</em><code>) -&gt;</code> <em>return type</em></p>
</blockquote>
<h2 id="custom-types"><a class="header" href="#custom-types">Custom Types</a></h2>
<p>The <em>metadata</em> of a <a href="engine/metadata//book/rust/custom-types.html">custom type</a> include:</p>
<ol>
<li>
<p>Its full Rust type name</p>
</li>
<li>
<p>Its pretty-print <em>display name</em> (which can be the same as its Rust type name)</p>
</li>
<li>
<p>Its purpose, in the form of <a href="engine/metadata//book/language/doc-comments.html">doc-comments</a></p>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="get-functions-metadata-in-scripts"><a class="header" href="#get-functions-metadata-in-scripts">Get Functions Metadata in Scripts</a></h1>
<p>The built-in function <code>get_fn_metadata_list</code> returns an <a href="language//book/language/arrays.html">array</a> of <a href="language//book/language/object-maps.html">object maps</a>, each containing
the metadata of one script-defined <a href="language//book/language/functions.html">function</a> in scope.</p>
<p><code>get_fn_metadata_list</code> is defined in the <a href="language//book/rust/packages/builtin.html"><code>LanguageCorePackage</code></a>, which is
excluded when using a <a href="language//book/engine/raw.html">raw <code>Engine</code></a>.</p>
<p><code>get_fn_metadata_list</code> has a few versions taking different parameters:</p>
<div class="table-wrapper"><table><thead><tr><th>Signature</th><th>Description</th></tr></thead><tbody>
<tr><td><code>get_fn_metadata_list()</code></td><td>returns an <a href="language//book/language/arrays.html">array</a> for <em>all</em> script-defined <a href="language//book/language/functions.html">functions</a></td></tr>
<tr><td><code>get_fn_metadata_list(name)</code></td><td>returns an <a href="language//book/language/arrays.html">array</a> containing all script-defined <a href="language//book/language/functions.html">functions</a> matching a specified name</td></tr>
<tr><td><code>get_fn_metadata_list(name, params)</code></td><td>returns an <a href="language//book/language/arrays.html">array</a> containing all script-defined <a href="language//book/language/functions.html">functions</a> matching a specified name and accepting the specified number of parameters</td></tr>
</tbody></table>
</div>
<p><a href="language//book/language/functions.html">Functions</a> from the following sources are returned, in order:</p>
<ol>
<li>Encapsulated script environment (e.g. when loading a <a href="language//book/rust/modules/index.html">module</a> from a script file),</li>
<li>Current script,</li>
<li><a href="language//book/rust/modules/index.html">Modules</a> registered via <code>Engine::register_global_module</code> (latest registrations first)</li>
<li><a href="language//book/rust/modules/index.html">Modules</a> imported via the <a href="language//book/language/modules/import.html"><code>import</code></a> statement (latest imports first),</li>
<li><a href="language//book/rust/modules/index.html">Modules</a> added via <code>Engine::register_static_module</code> (latest registrations first)</li>
</ol>
<p>The return value is an <a href="language//book/language/arrays.html">array</a> of <a href="language//book/language/object-maps.html">object maps</a> (so <code>get_fn_metadata_list</code> is also not available under
<a href="language//book/start/features.html"><code>no_index</code></a> or <a href="language//book/start/features.html"><code>no_object</code></a>), containing the following fields.</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th style="text-align: center">Type</th><th style="text-align: center">Optional?</th><th>Description</th></tr></thead><tbody>
<tr><td><code>namespace</code></td><td style="text-align: center"><a href="language//book/language/strings-chars.html">string</a></td><td style="text-align: center"><strong>yes</strong></td><td>the module <em>namespace</em> if the <a href="language//book/language/functions.html">function</a> is defined within a <a href="language//book/rust/modules/index.html">module</a></td></tr>
<tr><td><code>access</code></td><td style="text-align: center"><a href="language//book/language/strings-chars.html">string</a></td><td style="text-align: center">no</td><td><code>"public"</code> if the function is public,<br/><code>"private"</code> if it is <a href="language//book/language/modules/export.html">private</a></td></tr>
<tr><td><code>name</code></td><td style="text-align: center"><a href="language//book/language/strings-chars.html">string</a></td><td style="text-align: center">no</td><td><a href="language//book/language/functions.html">function</a> name</td></tr>
<tr><td><code>params</code></td><td style="text-align: center"><a href="language//book/language/arrays.html">array</a> of <a href="language//book/language/strings-chars.html">strings</a></td><td style="text-align: center">no</td><td>parameter names</td></tr>
<tr><td><code>this_type</code></td><td style="text-align: center"><a href="language/strings-chars.html">string</a></td><td style="text-align: center"><strong>yes</strong></td><td>restrict the type of <code>this</code> if the <a href="language//book/language/functions.html">function</a> is a <a href="language//book/rust/methods.html">method</a></td></tr>
<tr><td><code>is_anonymous</code></td><td style="text-align: center"><code>bool</code></td><td style="text-align: center">no</td><td>is this <a href="language//book/language/functions.html">function</a> an <a href="language//book/language/fn-anon.html">anonymous function</a>?</td></tr>
<tr><td><code>comments</code></td><td style="text-align: center"><a href="language//book/language/arrays.html">array</a> of <a href="language//book/language/strings-chars.html">strings</a></td><td style="text-align: center"><strong>yes</strong></td><td><a href="language//book/language/doc-comments.html">doc-comments</a>, if any, one per line</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="get-scripted-functions--metadata-from-ast"><a class="header" href="#get-scripted-functions--metadata-from-ast">Get Scripted Functions  Metadata from AST</a></h1>
<p>Use <a href="https://docs.rs/rhai/latest/rhai/struct.AST.html#method.iter_functions"><code>AST::iter_functions</code></a>
to iterate through all the script-defined <a href="rust//book/language/functions.html">functions</a> in an <a href="rust//book/engine/compile.html"><code>AST</code></a>.</p>
<h2 id="scriptfnmetadata"><a class="header" href="#scriptfnmetadata"><code>ScriptFnMetadata</code></a></h2>
<p>The type returned from the iterator is <code>ScriptFnMetadata</code> with the following fields:</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th style="text-align: center">Requires</th><th style="text-align: center">Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>name</code></td><td style="text-align: center"></td><td style="text-align: center"><code>&amp;str</code></td><td>Name of <a href="rust//book/language/functions.html">function</a></td></tr>
<tr><td><code>params</code></td><td style="text-align: center"></td><td style="text-align: center"><code>Vec&lt;&amp;str&gt;</code></td><td>Number of parameters</td></tr>
<tr><td><code>access</code></td><td style="text-align: center"></td><td style="text-align: center"><code>FnAccess</code></td><td>• <code>FnAccess::Public</code> (public)<br/>• <code>FnAccess::Private</code> (<a href="rust//book/language/modules/export.html"><code>private</code></a>)</td></tr>
<tr><td><code>comments</code></td><td style="text-align: center"><a href="rust//book/start/features.html"><code>metadata</code></a></td><td style="text-align: center"><code>Vec&lt;&amp;str&gt;</code></td><td><a href="rust//book/language/doc-comments.html">Doc-comments</a>, if any, one per line</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="get-native-function-signatures"><a class="header" href="#get-native-function-signatures">Get Native Function Signatures</a></h1>
<h2 id="enginegen_fn_signatures"><a class="header" href="#enginegen_fn_signatures"><code>Engine::gen_fn_signatures</code></a></h2>
<p>As part of a <em>reflections</em> API, <code>Engine::gen_fn_signatures</code> returns a list of function <em>signatures</em>
(as <code>Vec&lt;String&gt;</code>), each corresponding to a particular native function available to that <a href="engine/metadata//book/engine/hello-world.html"><code>Engine</code></a> instance.</p>
<blockquote>
<p><em>name</em> <code>(</code><em>param 1</em><code>:</code><em>type 1</em><code>,</code> <em>param 2</em><code>:</code><em>type 2</em><code>,</code> … <code>,</code> <em>param n</em><code>:</code><em>type n</em><code>) -&gt;</code> <em>return type</em></p>
</blockquote>
<p>The <a href="engine/metadata//book/start/features.html"><code>metadata</code></a> feature must be used to turn on this API.</p>
<h3 id="sources"><a class="header" href="#sources">Sources</a></h3>
<p>Functions from the following sources are included, in order:</p>
<ol>
<li>Native Rust functions registered into the global namespace via the <code>Engine::register_XXX</code> API</li>
<li><em>Public</em> (i.e. non-<a href="engine/metadata//book/language/modules/export.html"><code>private</code></a>) functions (native Rust or Rhai scripted) in global sub-modules
registered via <code>Engine::register_static_module</code>.</li>
<li>Native Rust functions in external <a href="engine/metadata//book/rust/packages/index.html">packages</a> registered via <code>Engine::register_global_module</code></li>
<li>Native Rust functions in <a href="engine/metadata//book/rust/packages/builtin.html">built-in packages</a> (optional)</li>
</ol>
<h2 id="functions-metadata"><a class="header" href="#functions-metadata">Functions Metadata</a></h2>
<p>Beware, however, that not all function signatures contain parameters and return value information.</p>
<h3 id="engineregister_xxx"><a class="header" href="#engineregister_xxx"><code>Engine::register_XXX</code></a></h3>
<p>For instance, functions registered via <code>Engine::register_XXX</code> contain no information on the names of
parameter because Rust simply does not make such metadata available natively.</p>
<p>Type names, however, <em>are</em> provided.</p>
<p>A function registered under the name <code>foo</code> with three parameters.</p>
<blockquote>
<p><code>foo(_: i64, _: char, _: &amp;str) -&gt; String</code></p>
</blockquote>
<p>An <a href="engine/metadata//book/appendix/operators.html#operators">operator</a> function. Notice that function names do not need to be valid identifiers.</p>
<blockquote>
<p><code>+=(_: &amp;mut i64, _: i64)</code></p>
</blockquote>
<p>A <a href="engine/metadata//book/rust/getters-setters.html">property setter</a>.
Notice that function names do not need to be valid identifiers.
In this case, the first parameter should be <code>&amp;mut T</code> of the custom type and the return value is <code>()</code>:</p>
<blockquote>
<p><code>set$prop(_: &amp;mut TestStruct, _: i64)</code></p>
</blockquote>
<h3 id="script-defined-functions"><a class="header" href="#script-defined-functions">Script-Defined Functions</a></h3>
<p>Script-defined <a href="engine/metadata//book/language/functions.html">function</a> signatures contain parameter names.
Since <em>all</em> parameters, as well as the return value, are <a href="engine/metadata//book/language/dynamic.html"><code>Dynamic</code></a> the types are simply not shown.</p>
<blockquote>
<p><code>foo(x, y, z)</code></p>
</blockquote>
<p>is probably defined simply as:</p>
<pre><code class="language-rust">/// This is a doc-comment, included in this function's metadata.
fn foo(x, y, z) {
    ...
}</code></pre>
<p>which is really the same as:</p>
<blockquote>
<p><code>foo(x: Dynamic, y: Dynamic, z: Dynamic) -&gt; Result&lt;Dynamic, Box&lt;EvalAltResult&gt;&gt;</code></p>
</blockquote>
<h3 id="plugin-functions"><a class="header" href="#plugin-functions">Plugin Functions</a></h3>
<p>Functions defined in <a href="engine/metadata//book/plugins/module.html">plugin modules</a> are the best.
They contain all metadata describing the functions, including <a href="engine/metadata//book/language/doc-comments.html">doc-comments</a>.</p>
<p>For example, a plugin function <code>combine</code>:</p>
<blockquote>
<p><code>/// This is a doc-comment, included in this function's metadata.</code><br />
<code>combine(list: &amp;mut MyStruct&lt;i64&gt;, num: usize, name: &amp;str) -&gt; bool</code></p>
</blockquote>
<p>Notice that function names do not need to be valid identifiers.</p>
<p>For example, an <a href="engine/metadata//book/appendix/operators.html#operators">operator</a> defined as a <a href="engine/metadata//book/rust/fallible.html">fallible function</a> in a <a href="engine/metadata//book/plugins/module.html">plugin module</a> via
<code>#[rhai_fn(name="+=", return_raw)]</code> returns <code>Result&lt;bool, Box&lt;EvalAltResult&gt;&gt;</code>:</p>
<blockquote>
<p><code>+=(list: &amp;mut MyStruct&lt;i64&gt;, value: &amp;str) -&gt; Result&lt;bool, Box&lt;EvalAltResult&gt;&gt;</code></p>
</blockquote>
<p>For example, a <a href="engine/metadata//book/rust/getters-setters.html">property getter</a> defined in a <a href="engine/metadata//book/plugins/module.html">plugin module</a>:</p>
<blockquote>
<p><code>get$prop(obj: &amp;mut MyStruct&lt;i64&gt;) -&gt; String</code></p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="export-functions-metadata-to-json"><a class="header" href="#export-functions-metadata-to-json">Export Functions Metadata to JSON</a></h1>
<h2 id="enginegen_fn_metadata_to_jsonenginegen_fn_metadata_with_ast_to_json"><a class="header" href="#enginegen_fn_metadata_to_jsonenginegen_fn_metadata_with_ast_to_json"><code>Engine::gen_fn_metadata_to_json</code><br/><code>Engine::gen_fn_metadata_with_ast_to_json</code></a></h2>
<p>As part of a <em>reflections</em> API, <code>Engine::gen_fn_metadata_to_json</code> and the corresponding
<code>Engine::gen_fn_metadata_with_ast_to_json</code> export the full list of <a href="engine/metadata//book/rust/custom-types.html">custom types</a> and
<a href="engine/metadata//book/engine/metadata/index.html">functions metadata</a> in JSON format.</p>
<div id="admonition-requires-metadata" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-requires-metadata-title">
<div class="admonition-title">
<div id="admonition-requires-metadata-title">
<p>Requires <code>metadata</code></p>
</div>
<a class="admonition-anchor-link" href="engine/metadata/export_to_json.html#admonition-requires-metadata"></a>
</div>
<div>
<p>The <a href="engine/metadata//book/start/features.html"><code>metadata</code></a> feature is required for this API, which also pulls in the
<a href="https://crates.io/crates/serde_json"><code>serde_json</code></a> crate.</p>
</div>
</div>
<h3 id="sources-1"><a class="header" href="#sources-1">Sources</a></h3>
<p>Functions and <a href="engine/metadata//book/rust/custom-types.html">custom types</a> from the following sources are included:</p>
<ol>
<li>Script-defined functions in an <a href="engine/metadata//book/engine/compile.html"><code>AST</code></a> (for <code>Engine::gen_fn_metadata_with_ast_to_json</code>)</li>
<li>Native Rust functions registered into the global namespace via the <code>Engine::register_XXX</code> API</li>
<li><a href="engine/metadata//book/rust/custom-types.html">Custom types</a> registered into the global namespace via the <code>Engine::register_type_with_name</code> API</li>
<li><em>Public</em> (i.e. non-<a href="engine/metadata//book/language/modules/export.html"><code>private</code></a>) functions (native Rust or Rhai scripted) and <a href="engine/metadata//book/rust/custom-types.html">custom types</a> in static modules
registered via <code>Engine::register_static_module</code></li>
<li>Native Rust functions and <a href="engine/metadata//book/rust/custom-types.html">custom types</a> in external <a href="engine/metadata//book/rust/packages/index.html">packages</a> registered via <code>Engine::register_global_module</code></li>
<li>Native Rust functions and <a href="engine/metadata//book/rust/custom-types.html">custom types</a> in <a href="engine/metadata//book/rust/packages/builtin.html">built-in packages</a> (optional)</li>
</ol>
<h2 id="json-schema"><a class="header" href="#json-schema">JSON Schema</a></h2>
<p>The JSON schema used to hold metadata is very simple, containing a nested structure of
<code>modules</code>, a list of <code>customTypes</code> and a list of <code>functions</code>.</p>
<h3 id="module-schema"><a class="header" href="#module-schema">Module Schema</a></h3>
<pre><code class="language-json">{
    "doc": "//! Module documentation",

    "modules":
    {
        "sub_module_1": /* namespace 'sub_module_1' */
        {
            "modules":
            {
                "sub_sub_module_A": /* namespace 'sub_module_1::sub_sub_module_A' */
                {
                    "doc": "//! Module documentation can also occur in any sub-module",

                    "customTypes": /* custom types exported in 'sub_module_1::sub_sub_module_A' */
                    [
                        { ... custom type metadata ... },
                        { ... custom type metadata ... },
                        { ... custom type metadata ... }
                        ...
                    ],
                    "functions": /* functions exported in 'sub_module_1::sub_sub_module_A' */
                    [
                        { ... function metadata ... },
                        { ... function metadata ... },
                        { ... function metadata ... },
                        { ... function metadata ... }
                        ...
                    ]
                },
                "sub_sub_module_B": /* namespace 'sub_module_1::sub_sub_module_B' */
                {
                    ...
                }
            }
        },
        "sub_module_2": /* namespace 'sub_module_2' */
        {
            ...
        },
        ...
    },

    "customTypes": /* custom types registered globally */
    [
        { ... custom type metadata ... },
        { ... custom type metadata ... },
        { ... custom type metadata ... },
        ...
    ],

    "functions": /* functions registered globally or in the 'AST' */
    [
        { ... function metadata ... },
        { ... function metadata ... },
        { ... function metadata ... },
        { ... function metadata ... },
        ...
    ]
}
</code></pre>
<h3 id="custom-type-metadata-schema"><a class="header" href="#custom-type-metadata-schema">Custom Type Metadata Schema</a></h3>
<pre><code class="language-json">{
    "typeName": "alloc::string::String",    /* name of Rust type */
    "displayName": "MyType",
    "docComments":  /* omitted if none */
    [
        "/// My super-string type.",
        ...
    ]
}
</code></pre>
<h3 id="function-metadata-schema"><a class="header" href="#function-metadata-schema">Function Metadata Schema</a></h3>
<pre><code class="language-json">{
    "baseHash": 9876543210,     /* partial hash with only number of parameters */
    "fullHash": 1234567890,     /* full hash with actual parameter types */
    "namespace": "internal" | "global",
    "access": "public" | "private",
    "name": "fn_name",
    "isAnonymous": false,
    "type": "native" | "script",
    "numParams": 42,            /* number of parameters */
    "params":                   /* omitted if no parameters */
    [
        { "name": "param_1", "type": "type_1" },
        { "name": "param_2" },  /* no type name */
        { "type": "type_3" },   /* no parameter name */
        ...
    ],
    "thisType": "this_type",    /* omitted if none */
    "returnType": "ret_type",   /* omitted if () or unknown */
    "signature": "[private] fn_name(param_1: type_1, param_2, _: type_3) -&gt; ret_type",
    "docComments":              /* omitted if none */
    [
        "/// doc-comment line 1",
        "/// doc-comment line 2",
        "/** doc-comment block */",
        ...
    ]
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="generate-definition-files-for-language-server"><a class="header" href="#generate-definition-files-for-language-server">Generate Definition Files for Language Server</a></h1>
<p>Rhai’s <a href="https://github.com/rhaiscript/lsp">language server</a> works with IDEs to provide integrated support for the Rhai scripting language.</p>
<p>Functions and <a href="engine/metadata//book/rust/modules/index.html">modules</a> registered with an <a href="engine/metadata//book/engine/hello-world.html"><code>Engine</code></a> can output their <a href="engine/metadata//book/engine/metadata/index.html">metadata</a>
into <em>definition files</em> which are used by the <a href="https://github.com/rhaiscript/lsp">language server</a>.</p>
<p>Definitions are generated via the <code>Engine::definitions</code> and <code>Engine::definitions_with_scope</code> API.</p>
<p>This API requires the <a href="engine/metadata//book/start/features.html"><code>metadata</code></a> and <a href="engine/metadata//book/start/features.html"><code>internals</code></a> feature.</p>
<h2 id="configurable-options"><a class="header" href="#configurable-options">Configurable Options</a></h2>
<p>The <code>Definitions</code> type supports the following options in a fluent method-chaining style.</p>
<div class="table-wrapper"><table><thead><tr><th>Option</th><th>Method</th><th style="text-align: center">Default</th></tr></thead><tbody>
<tr><td>Write headers in definition files?</td><td><code>with_headers</code></td><td style="text-align: center"><code>false</code></td></tr>
<tr><td>Include <a href="engine/metadata//book/rust/packages/builtin.html">standard packages</a> in definition files?</td><td><code>include_standard_packages</code></td><td style="text-align: center"><code>true</code></td></tr>
</tbody></table>
</div>
<pre><code class="language-rust">engine
    .definitions()
    .with_headers(true)                     // write headers in all files
    .include_standard_packages(false)       // skip standard packages
    .write_to_dir("path/to/my/definitions")
    .unwrap();</code></pre>
<h2 id="example-15"><a class="header" href="#example-15">Example</a></h2>
<pre><code class="language-rust">use rhai::{Engine, Scope};
use rhai::plugin::*;

// Plugin module: 'general_kenobi'
#[export_module]
pub mod general_kenobi {
    use std::convert::TryInto;

    /// Returns a string where "hello there" is repeated 'n' times.
    pub fn hello_there(n: i64) -&gt; String {
        "hello there ".repeat(n.try_into().unwrap())
    }
}

// Create scripting engine
let mut engine = Engine::new();

// Create custom Scope
let mut scope = Scope::new();

// This variable will also show up in the generated definition file.
scope.push("hello_there", "hello there");

// Static module namespaces will generate independent definition files.
engine.register_static_module(
        "general_kenobi",
        exported_module!(general_kenobi).into()
);

// Custom operators will also show up in the generated definition file.
engine.register_custom_operator("minus", 100).unwrap();
engine.register_fn("minus", |a: i64, b: i64| a - b);

engine.run_with_scope(&amp;mut scope,
        "hello_there = general_kenobi::hello_there(4 minus 2);"
)?;

// Output definition files in the specified directory.
engine
    .definitions()
    .write_to_dir("path/to/my/definitions")
    .unwrap();

// Output definition files in the specified directory.
// Variables in the provided 'Scope' are included.
engine
    .definitions_with_scope(&amp;scope)
    .write_to_dir("path/to/my/definitions")
    .unwrap();

// Output a single definition file with everything merged.
// Variables in the provided 'Scope' are included.
engine
    .definitions_with_scope(&amp;scope)
    .write_to_file("path/to/my/definitions/all_in_one.d.rhai")
    .unwrap();

// Output functions metadata to a JSON string.
// Functions in standard packages are skipped and not included.
let json = engine
    .definitions()
    .include_standard_packages(false)   // skip standard packages
    .unwrap();</code></pre>
<h2 id="definition-files"><a class="header" href="#definition-files">Definition Files</a></h2>
<p>The generated definition files will look like the following.</p>
<pre><code class="language-rust">┌───────────────────────┐
│ general_kenobi.d.rhai │
└───────────────────────┘

module general_kenobi;

/// Returns a string where "hello there" is repeated 'n' times.
fn hello_there(n: int) -&gt; String;


┌──────────────────┐
│ __scope__.d.rhai │
└──────────────────┘

module static;

let hello_there;


┌───────────────────┐
│ __static__.d.rhai │
└───────────────────┘

module static;

op minus(int, int) -&gt; int;

        :
        :


┌────────────────────┐
│ __builtin__.d.rhai │
└────────────────────┘

module static;

        :
        :


┌──────────────────────────────┐
│ __builtin-operators__.d.rhai │
└──────────────────────────────┘

module static;

        :
        :
</code></pre>
<h2 id="all-in-one-definition-file"><a class="header" href="#all-in-one-definition-file">All-in-One Definition File</a></h2>
<p><code>Definitions::write_to_file</code> generates a single definition file with everything merged in, like the following.</p>
<pre><code class="language-rust">module static;

op minus(int, int) -&gt; int;

        :
        :

module general_kenobi {
    /// Returns a string where "hello there" is repeated 'n' times.
    fn hello_there(n: int) -&gt; String;
}

let hello_there;</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="print-and-debug"><a class="header" href="#print-and-debug"><code>print</code> and <code>debug</code></a></h1>
<p>The <code>print</code> and <code>debug</code> functions default to printing to <code>stdout</code>, with <code>debug</code> using standard debug formatting.</p>
<pre><code class="language-js">print("hello");         // prints "hello" to stdout

print(1 + 2 + 3);       // prints "6" to stdout

let x = 42;

print(`hello${x}`);     // prints "hello42" to stdout

debug("world!");        // prints "world!" to stdout using debug formatting
</code></pre>
<h2 id="override-print-and-debug-with-callback-functions"><a class="header" href="#override-print-and-debug-with-callback-functions">Override <code>print</code> and <code>debug</code> with Callback Functions</a></h2>
<p>When embedding Rhai into an application, it is usually necessary to trap <code>print</code> and <code>debug</code> output
(for logging into a tracking log, for example) with the <a href="https://docs.rs/rhai/1.22.0/rhai/struct.Engine.html#method.on_print"><code>Engine::on_print</code></a> and <a href="https://docs.rs/rhai/1.22.0/rhai/struct.Engine.html#method.on_debug"><code>Engine::on_debug</code></a> methods.</p>
<pre><code class="language-rust">// Any function or closure that takes an '&amp;str' argument can be used to override 'print'.
engine.on_print(|x| println!("hello: {x}"));

// Any function or closure that takes a '&amp;str', an 'Option&lt;&amp;str&gt;' and a 'Position' argument
// can be used to override 'debug'.
engine.on_debug(|x, src, pos| {
    let src = src.unwrap_or("unknown");
    println!("DEBUG of {src} at {pos:?}: {s}")
});

// Example: quick-'n-dirty logging
let logbook = Arc::new(RwLock::new(Vec::&lt;String&gt;::new()));

// Redirect print/debug output to 'log'
let log = logbook.clone();
engine.on_print(move |s| {
    let entry = format!("entry: {}", s);
    log.write().unwrap().push(entry);
});

let log = logbook.clone();
engine.on_debug(move |s, src, pos| {
    let src = src.unwrap_or("unknown");
    let entry = format!("DEBUG of {src} at {pos:?}: {s}");
    log.write().unwrap().push(entry);
});

// Evaluate script
engine.run(script)?;

// 'logbook' captures all the 'print' and 'debug' output
for entry in logbook.read().unwrap().iter() {
    println!("{entry}");
}</code></pre>
<h2 id="on_debug-callback-signature"><a class="header" href="#on_debug-callback-signature"><code>on_debug</code> Callback Signature</a></h2>
<p>The function signature passed to [<code>Engine::on_debug]</code> takes the following form.</p>
<blockquote>
<pre><code class="language-rust">Fn(text: &amp;str, source: Option&lt;&amp;str&gt;, pos: Position)</code></pre>
</blockquote>
<p>where:</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th style="text-align: center">Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>text</code></td><td style="text-align: center"><code>&amp;str</code></td><td>text to display</td></tr>
<tr><td><code>source</code></td><td style="text-align: center"><code>Option&lt;&amp;str&gt;</code></td><td>source of the current evaluation, if any</td></tr>
<tr><td><code>pos</code></td><td style="text-align: center"><code>Position</code></td><td>position (line number and character offset) of the <code>debug</code> call</td></tr>
</tbody></table>
</div>
<p>The <em>source</em> of a script evaluation is any text string provided to an <a href="language//book/engine/compile.html"><code>AST</code></a> via <code>AST::set_source</code>.</p>
<div id="admonition-tip" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="language/print-debug.html#admonition-tip"></a>
</div>
<div>
<p>If a <a href="language//book/rust/modules/index.html">module</a> is loaded via an <a href="language//book/language/modules/import.html"><code>import</code></a> statement, then the <em>source</em> of functions defined within
the module will be the module’s <em>path</em>.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="modules-1"><a class="header" href="#modules-1">Modules</a></h1>
<p>Rhai allows organizing code (functions, both Rust-based or script-based, and variables) into <em>modules</em>.
Modules can be disabled via the <a href="language/modules//book/start/features.html"><code>no_module</code></a> feature.</p>
<p>A module has the type <code>Module</code> and holds a collection of functions, variables, <a href="language/modules//book/language/iterator.html">type iterators</a> and sub-modules.
It may be created entirely from Rust functions, or it may encapsulate a Rhai script together with the functions
and variables defined by that script.</p>
<p>Other scripts can then load this module and use the functions and variables exported as if they were
defined inside the same script.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="export-variables-functions-and-sub-modules-from-a-script"><a class="header" href="#export-variables-functions-and-sub-modules-from-a-script">Export Variables, Functions and Sub-Modules From a Script</a></h1>
<div id="admonition-see-also" class="admonition admonish-info side" role="note" aria-labelledby="admonition-see-also-title">
<div class="admonition-title">
<div id="admonition-see-also-title">
<p>See also</p>
</div>
<a class="admonition-anchor-link" href="language/modules/export.html#admonition-see-also"></a>
</div>
<div>
<p>See <a href="language/modules//book/rust/modules/ast.html"><em>Create a Module from AST</em></a> for more details.</p>
</div>
</div>
<p>The easiest way to expose a collection of <a href="language/modules//book/language/functions.html">functions</a> as a self-contained <a href="language/modules//book/rust/modules/index.html">module</a> is to do it via a Rhai script itself.</p>
<p>The script text is evaluated.</p>
<p><a href="language/modules//book/language/variables.html">Variables</a> are then selectively exposed via the <code>export</code> statement.</p>
<p><a href="language/modules//book/language/functions.html">Functions</a> defined by the script are automatically exported, unless marked as <code>private</code>.</p>
<p>Modules loaded within this <a href="language/modules//book/rust/modules/index.html">module</a> at the global level become <em>sub-modules</em> and are also automatically exported.</p>
<h2 id="export-global-variables"><a class="header" href="#export-global-variables">Export Global Variables</a></h2>
<p>The <code>export</code> statement, which can only be at global level, exposes a selected <a href="language/modules//book/language/variables.html">variable</a> as member of a <a href="language/modules//book/rust/modules/index.html">module</a>.</p>
<p><a href="language/modules//book/language/variables.html">Variables</a> not exported are <em>private</em> and hidden. They are merely used to initialize the <a href="language/modules//book/rust/modules/index.html">module</a>,
but cannot be accessed from outside.</p>
<p>Everything exported from a <a href="language/modules//book/rust/modules/index.html">module</a> is <strong><a href="language/modules//book/language/constants.html">constant</a></strong> (i.e. read-only).</p>
<pre><code class="language-js">// This is a module script.

let hidden = 123;       // variable not exported - default hidden
let x = 42;             // this will be exported below

export x;               // the variable 'x' is exported under its own name

export const x = 42;    // convenient short-hand to declare a constant and export it
                        // under its own name

export let x = 123;     // variables can be exported as well, though it'll still be constant

export x as answer;     // the variable 'x' is exported under the alias 'answer'
                        // another script can load this module and access 'x' as 'module::answer'

{
    let inner = 0;      // local variable - it disappears when the statements block ends,
                        //                  therefore it is not 'global' and cannot be exported

    export inner;       // &lt;- syntax error: cannot export a local variable
}
</code></pre>
<div id="admonition-tip-multiple-exports" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-multiple-exports-title">
<div class="admonition-title">
<div id="admonition-tip-multiple-exports-title">
<p>Tip: Multiple exports</p>
</div>
<a class="admonition-anchor-link" href="language/modules/export.html#admonition-tip-multiple-exports"></a>
</div>
<div>
<p><a href="language/modules//book/language/variables.html">Variables</a> can be exported under multiple names.
For example, the following exports three <a href="language/modules//book/language/variables.html">variables</a>:</p>
<ul>
<li><code>x</code> as <code>x</code> and <code>hello</code></li>
<li><code>y</code> as <code>foo</code> and <code>bar</code></li>
<li><code>z</code> as <code>z</code></li>
</ul>
<pre><code class="language-js">export x;
export x as hello;
export y as foo;
export x as world;
export y as bar;
export z;
</code></pre>
</div>
</div>
<h2 id="export-functions"><a class="header" href="#export-functions">Export Functions</a></h2>
<div id="admonition-private-functions" class="admonition admonish-info side" role="note" aria-labelledby="admonition-private-functions-title">
<div class="admonition-title">
<div id="admonition-private-functions-title">
<p>Private functions</p>
</div>
<a class="admonition-anchor-link" href="language/modules/export.html#admonition-private-functions"></a>
</div>
<div>
<p><code>private</code> <a href="language/modules//book/language/functions.html">functions</a> are commonly called within the <a href="language/modules//book/rust/modules/index.html">module</a> only.
They cannot be accessed otherwise.</p>
</div>
</div>
<p>All <a href="language/modules//book/language/functions.html">functions</a> are automatically exported, <em>unless</em> it is explicitly opt-out with the <code>private</code> prefix.</p>
<p><a href="language/modules//book/language/functions.html">Functions</a> declared <code>private</code> are hidden to the outside.</p>
<pre><code class="language-rust">// This is a module script.

fn inc(x) { x + 1 }     // script-defined function - default public

private fn foo() {}     // private function - hidden</code></pre>
<h2 id="sub-modules"><a class="header" href="#sub-modules">Sub-Modules</a></h2>
<p>All loaded <a href="language/modules//book/rust/modules/index.html">modules</a> are automatically exported as sub-modules.</p>
<div id="admonition-tip-skip-exporting-a-module" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-skip-exporting-a-module-title">
<div class="admonition-title">
<div id="admonition-tip-skip-exporting-a-module-title">
<p>Tip: Skip exporting a module</p>
</div>
<a class="admonition-anchor-link" href="language/modules/export.html#admonition-tip-skip-exporting-a-module"></a>
</div>
<div>
<p>To prevent a <a href="language/modules//book/rust/modules/index.html">module</a> from being exported, load it inside a block statement so that it goes away at the
end of the block.</p>
<pre><code class="language-js">// This is a module script.

import "hello" as foo;      // &lt;- exported

{
    import "world" as bar;  // &lt;- not exported
}
</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="import-a-module"><a class="header" href="#import-a-module">Import a Module</a></h1>
<div id="admonition-see-also" class="admonition admonish-info side" role="note" aria-labelledby="admonition-see-also-title">
<div class="admonition-title">
<div id="admonition-see-also-title">
<p>See also</p>
</div>
<a class="admonition-anchor-link" href="language/modules/import.html#admonition-see-also"></a>
</div>
<div>
<p>See <a href="language/modules//book/rust/modules/resolvers/index.html"><em>Module Resolvers</em></a> for more details.</p>
</div>
</div>
<p>Before a <a href="language/modules//book/rust/modules/index.html">module</a> can be used (via an <code>import</code> statement) in a script, there must be a
<a href="language/modules//book/rust/modules/resolvers/index.html">module resolver</a> registered into the <a href="language/modules//book/engine/hello-world.html"><code>Engine</code></a>, the default being the <code>FileModuleResolver</code>.</p>
<h2 id="import-statement"><a class="header" href="#import-statement"><code>import</code> Statement</a></h2>
<div id="admonition-tip" class="admonition admonish-tip side wide" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="language/modules/import.html#admonition-tip"></a>
</div>
<div>
<p>A <a href="language/modules//book/rust/modules/index.html">module</a> that is only <code>import</code>-ed but not given any name is simply run.</p>
<p>This is a very simple way to run another script file from within a script.</p>
</div>
</div>
<p>A <a href="language/modules//book/rust/modules/index.html">module</a> can be <em>imported</em> via the <code>import</code> statement, and be given a name.</p>
<p>Its members can be accessed via <code>::</code> similar to C++.</p>
<pre><code class="language-js">import "crypto_banner";         // run the script file 'crypto_banner.rhai' without creating an imported module

import "crypto" as lock;        // run the script file 'crypto.rhai' and import it as a module named 'lock'

const SECRET_NUMBER = 42;

let mod_file = `crypto_${SECRET_NUMBER}`;

import mod_file as my_mod;      // load the script file "crypto_42.rhai" and import it as a module named 'my_mod'
                                // notice that module path names can be dynamically constructed!
                                // any expression that evaluates to a string is acceptable after the 'import' keyword

lock::encrypt(secret);          // use functions defined under the module via '::'

lock::hash::sha256(key);        // sub-modules are also supported

print(lock::status);            // module variables are constants

lock::status = "off";           // &lt;- runtime error: cannot modify a constant
</code></pre>
<div id="admonition-imports-are-_scoped_" class="admonition admonish-info" role="note" aria-labelledby="admonition-imports-are-_scoped_-title">
<div class="admonition-title">
<div id="admonition-imports-are-_scoped_-title">
<p>Imports are <em>scoped</em></p>
</div>
<a class="admonition-anchor-link" href="language/modules/import.html#admonition-imports-are-_scoped_"></a>
</div>
<div>
<p><a href="language/modules//book/rust/modules/index.html">Modules</a> imported via <code>import</code> statements are only accessible inside the relevant block scope.</p>
<pre><code class="language-js">import "hacker" as h;           // import module - visible globally

if secured {                    // &lt;- new block scope
    let mod = "crypt";

    import mod + "o" as c;      // import module (the path needs not be a constant string)

    let x = c::encrypt(key);    // use a function in the module

    h::hack(x);                 // global module 'h' is visible here
}                               // &lt;- module 'c' disappears at the end of the block scope

h::hack(something);             // this works as 'h' is visible

c::encrypt(something);          // &lt;- this causes a run-time error because
                                //    module 'c' is no longer available!

fn foo(something) {
    h::hack(something);         // &lt;- this also works as 'h' is visible
}

for x in 0..1000 {
    import "crypto" as c;       // &lt;- importing a module inside a loop is a Very Bad Idea™

    c.encrypt(something);
}
</code></pre>
</div>
</div>
<div id="admonition-place-import-statements-at-the-top" class="admonition admonish-note" role="note" aria-labelledby="admonition-place-import-statements-at-the-top-title">
<div class="admonition-title">
<div id="admonition-place-import-statements-at-the-top-title">
<p>Place <code>import</code> statements at the top</p>
</div>
<a class="admonition-anchor-link" href="language/modules/import.html#admonition-place-import-statements-at-the-top"></a>
</div>
<div>
<p><code>import</code> statements can appear anywhere a normal statement can be, but in the vast majority of cases they are
usually grouped at the top (beginning) of a script for manageability and visibility.</p>
<p>It is not advised to deviate from this common practice unless there is a <em>Very Good Reason™</em>.</p>
<p>Especially, do not place an <code>import</code> statement within a loop; doing so will repeatedly re-load the
same <a href="language/modules//book/rust/modules/index.html">module</a> during every iteration of the loop!</p>
</div>
</div>
<div id="admonition-recursive-imports" class="admonition admonish-danger" role="note" aria-labelledby="admonition-recursive-imports-title">
<div class="admonition-title">
<div id="admonition-recursive-imports-title">
<p>Recursive imports</p>
</div>
<a class="admonition-anchor-link" href="language/modules/import.html#admonition-recursive-imports"></a>
</div>
<div>
<p>Beware of <em>import cycles</em> – i.e. recursively loading the same <a href="language/modules//book/rust/modules/index.html">module</a>. This is a sure-fire way to
cause a stack overflow in the <a href="language/modules//book/engine/hello-world.html"><code>Engine</code></a>, unless stopped by setting a limit for <a href="language/modules//book/safety/max-modules.html">maximum number of modules</a>.</p>
<p>For instance, importing itself always causes an infinite recursion:</p>
<pre><code class="language-js">┌────────────┐
│ hello.rhai │
└────────────┘

import "hello" as foo;          // import itself - infinite recursion!

foo::do_something();
</code></pre>
<p><a href="language/modules//book/rust/modules/index.html">Modules</a> cross-referencing also cause infinite recursion:</p>
<pre><code class="language-js">┌────────────┐
│ hello.rhai │
└────────────┘

import "world" as foo;
foo::do_something();


┌────────────┐
│ world.rhai │
└────────────┘

import "hello" as bar;
bar::do_something_else();
</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="eval-function"><a class="header" href="#eval-function"><code>eval</code> Function</a></h1>
<h2 id="or-how-to-shoot-yourself-in-the-foot-even-easier"><a class="header" href="#or-how-to-shoot-yourself-in-the-foot-even-easier">Or “How to Shoot Yourself in the Foot even Easier”</a></h2>
<p>Saving the best for last, there is the ever-dreaded… <code>eval</code> <a href="language//book/language/functions.html">function</a>!</p>
<pre><code class="language-rust">let x = 10;

fn foo(x) { x += 12; x }

let script =
"
    let y = x;
    y += foo(y);
    x + y
";

let result = eval(script);      // &lt;- look, JavaScript, we can also do this!

result == 42;

x == 10;                        // prints 10 - arguments are passed by value
y == 32;                        // prints 32 - variables defined in 'eval' persist!

eval("{ let z = y }");          // to keep a variable local, use a statements block

print(z);                       // &lt;- error: variable 'z' not found

"print(42)".eval();             // &lt;- nope... method-call style doesn't work with 'eval'</code></pre>
<div id="admonition-eval-executes-inside-the-current-scope" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-eval-executes-inside-the-current-scope-title">
<div class="admonition-title">
<div id="admonition-eval-executes-inside-the-current-scope-title">
<p><code>eval</code> executes inside the current scope!</p>
</div>
<a class="admonition-anchor-link" href="language/eval.html#admonition-eval-executes-inside-the-current-scope"></a>
</div>
<div>
<p>Script segments passed to <code>eval</code> execute inside the <em>current</em> <a href="language//book/engine/scope.html"><code>Scope</code></a>, so they can access and modify
<em>everything</em>, including all <a href="language//book/language/variables.html">variables</a> that are visible at that position in code!</p>
<pre><code class="language-rust">let script = "x += 32";

let x = 10;
eval(script);       // variable 'x' is visible!
print(x);           // prints 42

// The above is equivalent to:
let script = "x += 32";
let x = 10;
x += 32;
print(x);</code></pre>
<p><code>eval</code> can also be used to define new <a href="language//book/language/variables.html">variables</a> and do other things normally forbidden inside
a <a href="language//book/language/functions.html">function</a> call.</p>
<pre><code class="language-rust">let script = "let x = 42";
eval(script);
print(x);           // prints 42</code></pre>
<p>Treat it as if the script segments are physically pasted in at the position of the <code>eval</code> call.</p>
</div>
</div>
<div id="admonition-cannot-define-new-functions" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-cannot-define-new-functions-title">
<div class="admonition-title">
<div id="admonition-cannot-define-new-functions-title">
<p>Cannot define new functions</p>
</div>
<a class="admonition-anchor-link" href="language/eval.html#admonition-cannot-define-new-functions"></a>
</div>
<div>
<p>New <a href="language//book/language/functions.html">functions</a> cannot be defined within an <code>eval</code> call, since <a href="language//book/language/functions.html">functions</a> can only be defined at
the <em>global</em> level!</p>
</div>
</div>
<div id="admonition-eval-is-evil" class="admonition admonish-failure small" role="note" aria-labelledby="admonition-eval-is-evil-title">
<div class="admonition-title">
<div id="admonition-eval-is-evil-title">
<p><code>eval</code> is evil</p>
</div>
<a class="admonition-anchor-link" href="language/eval.html#admonition-eval-is-evil"></a>
</div>
<div>
<p>For those who subscribe to the (very sensible) motto of <a href="http://linterrors.com/js/eval-is-evil">“<code>eval</code> is evil”</a>,
disable <code>eval</code> via <a href="language//book/engine/disable-keywords.html"><code>Engine::disable_symbol</code></a>.</p>
<pre><code class="language-rust">// Disable usage of 'eval'
engine.disable_symbol("eval");</code></pre>
</div>
</div>
<div id="admonition-do-you-regret-implementing-eval-in-rhai" class="admonition admonish-question small" role="note" aria-labelledby="admonition-do-you-regret-implementing-eval-in-rhai-title">
<div class="admonition-title">
<div id="admonition-do-you-regret-implementing-eval-in-rhai-title">
<p>Do you regret implementing <code>eval</code> in Rhai?</p>
</div>
<a class="admonition-anchor-link" href="language/eval.html#admonition-do-you-regret-implementing-eval-in-rhai"></a>
</div>
<div>
<p>Or course we do.</p>
<p>Having the possibility of an <code>eval</code> call disrupts any predictability in the Rhai script,
thus disabling a large number of optimizations.</p>
</div>
</div>
<div id="admonition-why-did-it-then" class="admonition admonish-question small" role="note" aria-labelledby="admonition-why-did-it-then-title">
<div class="admonition-title">
<div id="admonition-why-did-it-then-title">
<p>Why did it then???!!!</p>
</div>
<a class="admonition-anchor-link" href="language/eval.html#admonition-why-did-it-then"></a>
</div>
<div>
<p>Brendan Eich puts it well: “it is just too easy to implement.” <em>(source wanted)</em></p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="safety-and-protection-against-dos-attacks"><a class="header" href="#safety-and-protection-against-dos-attacks">Safety and Protection Against DOS Attacks</a></h1>
<p>For scripting systems open to untrusted user-land scripts, it is always best to limit the amount of
resources used by a script so that it does not consume more resources that it is allowed to.</p>
<p>These are common vectors for <a href="https://en.wikipedia.org/wiki/Denial-of-service_attack">Denial of Service (DOS)</a> attacks.</p>
<h2 id="most-important-resources"><a class="header" href="#most-important-resources">Most Important Resources</a></h2>
<div id="admonition-memory" class="admonition admonish-bug" role="note" aria-labelledby="admonition-memory-title">
<div class="admonition-title">
<div id="admonition-memory-title">
<p>Memory</p>
</div>
<a class="admonition-anchor-link" href="safety/index.html#admonition-memory"></a>
</div>
<div>
<ul>
<li>
<p>Continuously grow a <a href="safety//book/language/strings-chars.html">string</a>, an <a href="safety//book/language/arrays.html">array</a>, a <a href="safety//book/language/blobs.html">BLOB</a> or <a href="safety//book/language/object-maps.html">object map</a> until all memory is consumed.</p>
</li>
<li>
<p>Continuously create new <a href="safety//book/language/variables.html">variables</a> with large data until all memory is consumed.</p>
</li>
<li>
<p>Continuously define new <a href="safety//book/language/functions.html">functions</a> all memory is consumed (e.g. a simple <a href="safety//book/language/fn-closure.html">closure</a> <code>||</code>,
as short as two characters, is a <a href="safety//book/language/functions.html">function</a> – an attractive target for DOS attacks).</p>
</li>
</ul>
</div>
</div>
<div id="admonition-cpu" class="admonition admonish-bug" role="note" aria-labelledby="admonition-cpu-title">
<div class="admonition-title">
<div id="admonition-cpu-title">
<p>CPU</p>
</div>
<a class="admonition-anchor-link" href="safety/index.html#admonition-cpu"></a>
</div>
<div>
<ul>
<li>Infinite tight loop that consumes all CPU cycles.</li>
</ul>
</div>
</div>
<div id="admonition-time" class="admonition admonish-bug" role="note" aria-labelledby="admonition-time-title">
<div class="admonition-title">
<div id="admonition-time-title">
<p>Time</p>
</div>
<a class="admonition-anchor-link" href="safety/index.html#admonition-time"></a>
</div>
<div>
<ul>
<li>Run indefinitely, thereby blocking the calling system which is waiting for a result.</li>
</ul>
</div>
</div>
<div id="admonition-stack" class="admonition admonish-bug" role="note" aria-labelledby="admonition-stack-title">
<div class="admonition-title">
<div id="admonition-stack-title">
<p>Stack</p>
</div>
<a class="admonition-anchor-link" href="safety/index.html#admonition-stack"></a>
</div>
<div>
<ul>
<li>
<p>Deep recursive call that exhausts the call stack.</p>
</li>
<li>
<p>Large <a href="safety//book/language/arrays.html">array</a> or <a href="safety//book/language/object-maps.html">object map</a> literal that exhausts the stack during parsing.</p>
</li>
<li>
<p>Degenerated deep expression with so many levels that the parser exhausts the call stack when
parsing the expression; or even deeply-nested statements blocks, if nested deep enough.</p>
</li>
<li>
<p><a href="safety//book/language/modules/import.html">Self-referencing module</a>.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-overflows-or-underflows" class="admonition admonish-bug" role="note" aria-labelledby="admonition-overflows-or-underflows-title">
<div class="admonition-title">
<div id="admonition-overflows-or-underflows-title">
<p>Overflows or Underflows</p>
</div>
<a class="admonition-anchor-link" href="safety/index.html#admonition-overflows-or-underflows"></a>
</div>
<div>
<ul>
<li>
<p>Numeric overflows and/or underflows.</p>
</li>
<li>
<p>Divide by zero.</p>
</li>
<li>
<p>Bad floating-point representations.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-files" class="admonition admonish-bug" role="note" aria-labelledby="admonition-files-title">
<div class="admonition-title">
<div id="admonition-files-title">
<p>Files</p>
</div>
<a class="admonition-anchor-link" href="safety/index.html#admonition-files"></a>
</div>
<div>
<ul>
<li>
<p>Continuously <a href="safety//book/language/modules/import.html"><code>import</code></a> an external <a href="safety//book/rust/modules/index.html">module</a> within an infinite loop, thus putting heavy load on the file-system
(or even the network if the file is not local).</p>
<p>Even when <a href="safety//book/rust/modules/index.html">modules</a> are not created from files, they still typically consume a lot of resources to load.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-private-data" class="admonition admonish-bug" role="note" aria-labelledby="admonition-private-data-title">
<div class="admonition-title">
<div id="admonition-private-data-title">
<p>Private data</p>
</div>
<a class="admonition-anchor-link" href="safety/index.html#admonition-private-data"></a>
</div>
<div>
<ul>
<li>
<p>Read from and/or write to private, secret, sensitive data.</p>
<p>Such security breach may put the entire system at risk.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-the-internals-feature" class="admonition admonish-bug" role="note" aria-labelledby="admonition-the-internals-feature-title">
<div class="admonition-title">
<div id="admonition-the-internals-feature-title">
<p>The <a href="safety//book/start/features.html"><code>internals</code></a> feature</p>
</div>
<a class="admonition-anchor-link" href="safety/index.html#admonition-the-internals-feature"></a>
</div>
<div>
<p>The <a href="safety//book/start/features.html"><code>internals</code></a> feature allows third-party access to Rust internal data types and functions (for
example, the <a href="safety//book/engine/compile.html"><code>AST</code></a> and related types).</p>
<p>This is usually a <em>Very Bad Idea™</em> because:</p>
<ul>
<li>
<p>Messing up Rhai’s internal data structures will easily create panics that bring down the host
environment, violating the <em>Don’t Panic</em> guarantee.</p>
</li>
<li>
<p>Allowing access to internal types may open up new attack vectors.</p>
</li>
<li>
<p>Internal Rhai types and functions are volatile, so they may change from version to version and
break code.</p>
</li>
</ul>
<p>Use <a href="safety//book/start/features.html"><code>internals</code></a> only if the operating environment has absolutely no safety concerns – you’d
be surprised under how few scenarios this assumption holds.</p>
<p>One example of such an environment is a Rhai scripting <a href="safety//book/engine/hello-world.html"><code>Engine</code></a> compiled to <a href="safety//book/start/builds/wasm.html">WASM</a> where the
<a href="safety//book/engine/compile.html"><code>AST</code></a> is further translated to include environment-specific modifications.</p>
</div>
</div>
<h2 id="dont-panic-guarantee--any-panic-is-a-bug"><a class="header" href="#dont-panic-guarantee--any-panic-is-a-bug"><em>Don’t Panic</em> Guarantee – Any Panic is a Bug</a></h2>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/Don%27t_Panic.svg/320px-Don%27t_Panic.svg.png" alt="Don’t Panic" /></p>
<p>Rhai is designed to not bring down the host system, regardless of what a script may do to it. This
is a central design goal – Rhai provides a <a href="https://en.wikipedia.org/wiki/Phrases_from_The_Hitchhiker%27s_Guide_to_the_Galaxy#Don&#x27;t_Panic"><em>Don’t
Panic</em></a>
guarantee.</p>
<p>When using Rhai, any panic outside of APIs with explicitly documented panic conditions is
considered a bug in Rhai and should be reported as such.</p>
<div id="admonition-ok-panic-anyway" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-ok-panic-anyway-title">
<div class="admonition-title">
<div id="admonition-ok-panic-anyway-title">
<p>OK, panic anyway</p>
</div>
<a class="admonition-anchor-link" href="safety/index.html#admonition-ok-panic-anyway"></a>
</div>
<div>
<p>All these safe-guards can be turned off via the <a href="safety//book/start/features.html"><code>unchecked</code></a> feature, which disables all safety
checks (even fatal ones).</p>
<p>This increases script evaluation performance somewhat, but very easy for a malicious script
to bring down the host system.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sand-boxing--block-access-to-external-data"><a class="header" href="#sand-boxing--block-access-to-external-data">Sand-Boxing – Block Access to External Data</a></h1>
<p>Rhai is <em>sand-boxed</em> so a script can never read from outside its own environment.</p>
<p>Furthermore, an <a href="safety//book/engine/hello-world.html"><code>Engine</code></a> created non-<code>mut</code> cannot mutate any state, including itself
(and therefore it is also <em>re-entrant</em>).</p>
<p>It is highly recommended that <a href="safety//book/engine/hello-world.html"><code>Engine</code></a>’s be created immutable as much as possible.</p>
<pre><code class="language-rust">let mut engine = Engine::new();

// Use the fluent API to configure an 'Engine'
engine.register_get("field", get_field)
      .register_set("field", set_field)
      .register_fn("do_work", action);

// Then turn it into an immutable instance
let engine = engine;

// 'engine' is immutable...</code></pre>
<div id="admonition-tip-use-rhai-to-control-external-environment" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-use-rhai-to-control-external-environment-title">
<div class="admonition-title">
<div id="admonition-tip-use-rhai-to-control-external-environment-title">
<p>Tip: Use Rhai to control external environment</p>
</div>
<a class="admonition-anchor-link" href="safety/sandbox.html#admonition-tip-use-rhai-to-control-external-environment"></a>
</div>
<div>
<p>How does a <em>sand-boxed</em>, immutable <a href="safety//book/engine/hello-world.html"><code>Engine</code></a> control the external environment?</p>
<p>This is necessary in order to use Rhai as a <em>dynamic control layer</em> over a Rust core system.</p>
<p>There are two general patterns, both involving wrapping the external system
in a shared, interior-mutated object (e.g. <code>Rc&lt;RefCell&lt;T&gt;&gt;</code>):</p>
<ul>
<li>
<p><a href="safety//book/patterns/control.html">Control Layer</a> pattern.</p>
</li>
<li>
<p><a href="safety//book/patterns/singleton.html">Singleton Command Object</a> pattern.</p>
</li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="limiting-run-time"><a class="header" href="#limiting-run-time">Limiting Run Time</a></h1>
<h2 id="track-progress-and-force-termination"><a class="header" href="#track-progress-and-force-termination">Track Progress and Force-Termination</a></h2>
<div id="admonition-operations-count-vs-progress" class="admonition admonish-info side" role="note" aria-labelledby="admonition-operations-count-vs-progress-title">
<div class="admonition-title">
<div id="admonition-operations-count-vs-progress-title">
<p>Operations count vs. progress</p>
</div>
<a class="admonition-anchor-link" href="safety/progress.html#admonition-operations-count-vs-progress"></a>
</div>
<div>
<p><em>Operations count</em> does not indicate the <em>proportion</em> of work already done – thus it is not real <em>progress</em> tracking.</p>
<p>The real progress can be <em>estimated</em> based on the expected number of operations in a typical run.</p>
</div>
</div>
<p>It is impossible to know when, or even whether, a script run will end
(a.k.a. the <a href="http://en.wikipedia.org/wiki/Halting_problem">Halting Problem</a>).</p>
<p>When dealing with third-party untrusted scripts that may be malicious, in order to track evaluation
progress and force-terminate a script prematurely (for any reason), provide a closure to the
<a href="safety//book/engine/hello-world.html"><code>Engine</code></a> via <a href="https://docs.rs/rhai/1.22.0/rhai/struct.Engine.html#method.on_progress"><code>Engine::on_progress</code></a>.</p>
<p>The closure passed to <a href="https://docs.rs/rhai/1.22.0/rhai/struct.Engine.html#method.on_progress"><code>Engine::on_progress</code></a> will be called once for every operation.</p>
<p>Progress tracking is disabled with the <a href="safety//book/start/features.html"><code>unchecked</code></a> feature.</p>
<h2 id="examples-16"><a class="header" href="#examples-16">Examples</a></h2>
<h3 id="periodic-logging"><a class="header" href="#periodic-logging">Periodic Logging</a></h3>
<pre><code class="language-rust">let mut engine = Engine::new();

engine.on_progress(|count| {    // parameter is number of operations already performed
    if count % 1000 == 0 {
        println!("{count}");    // print out a progress log every 1,000 operations
    }
    None                        // return 'None' to continue running the script
                                // return 'Some(token)' to immediately terminate the script
});</code></pre>
<h3 id="limit-running-time"><a class="header" href="#limit-running-time">Limit running time</a></h3>
<pre><code class="language-rust">let mut engine = Engine::new();

let start = get_time();         // get the current system time

engine.on_progress(move |_| {
    let now = get_time();

    if now.duration_since(start).as_secs() &gt; 60 {
        // Return a dummy token just to force-terminate the script
        // after running for more than 60 seconds!
        Some(Dynamic::UNIT)
    } else {
        // Continue
        None
    }
});</code></pre>
<h2 id="function-signature-of-callback"><a class="header" href="#function-signature-of-callback">Function Signature of Callback</a></h2>
<p>The signature of the closure to pass to <a href="https://docs.rs/rhai/1.22.0/rhai/struct.Engine.html#method.on_progress"><code>Engine::on_progress</code></a> is as follows.</p>
<blockquote>
<pre><code class="language-rust">Fn(operations: u64) -&gt; Option&lt;Dynamic&gt;</code></pre>
</blockquote>
<h3 id="return-value-5"><a class="header" href="#return-value-5">Return value</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Value</th><th>Effect</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>Some(token)</code></td><td>terminate immediately, with <code>token</code> (a <a href="safety//book/language/dynamic.html"><code>Dynamic</code></a> value) as <em>termination token</em></td></tr>
<tr><td style="text-align: center"><code>None</code></td><td>continue script evaluation</td></tr>
</tbody></table>
</div>
<h3 id="termination-token"><a class="header" href="#termination-token">Termination Token</a></h3>
<div id="admonition-token" class="admonition admonish-info side" role="note" aria-labelledby="admonition-token-title">
<div class="admonition-title">
<div id="admonition-token-title">
<p>Token</p>
</div>
<a class="admonition-anchor-link" href="safety/progress.html#admonition-token"></a>
</div>
<div>
<p>The termination token is commonly used to provide information on the <em>reason</em> behind the termination decision.</p>
</div>
</div>
<p>The <a href="safety//book/language/dynamic.html"><code>Dynamic</code></a> value returned is a <em>termination token</em>.</p>
<p>A script that is manually terminated returns with the error <code>EvalAltResult::ErrorTerminated(token, position)</code>
wrapping this value.</p>
<p>If the termination token is not needed, simply return <code>Some(Dynamic::UNIT)</code> to terminate the script
run with <a href="safety//book/language/values-and-types.html"><code>()</code></a> as the token.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="limiting-memory-usage"><a class="header" href="#limiting-memory-usage">Limiting Memory Usage</a></h1>
<h2 id="during-evaluation"><a class="header" href="#during-evaluation">During Evaluation</a></h2>
<p>To prevent <em>out-of-memory</em> failures, provide a closure to <a href="safety//book/safety/progress.html"><code>Engine::on_progress</code></a> to track
memory usage and force-terminate a malicious script before it can bring down the host system.</p>
<p>Most O/S provides system calls to obtain the current memory usage of the process.</p>
<pre><code class="language-rust">let mut engine = Engine::new();

const MAX_MEMORY: usize = 10 * 1024 * 1024;   // 10MB

engine.on_progress(|_| {
    // Call a system function to obtain the current memory usage
    let memory_usage = get_current_progress_memory_usage();

    if memory_usage &gt; MAX_MEMORY {
        // Terminate the script
        Some(Dynamic::UNIT)
    } else {
        // Continue
        None
    }
});</code></pre>
<h2 id="during-parsing"><a class="header" href="#during-parsing">During Parsing</a></h2>
<p>A malicious script can be carefully crafted such that it consumes all available memory during the
parsing stage.</p>
<p>Protect against this by via a closure to <a href="safety//book/engine/token-mapper.html"><code>Engine::on_parse_token</code></a>.</p>
<pre><code class="language-rust">let mut engine = Engine::new();

const MAX_MEMORY: usize = 10 * 1024 * 1024;   // 10MB

engine.on_parse_token(|token, _, _| {
    // Call a system function to obtain the current memory usage
    let memory_usage = get_current_progress_memory_usage();

    if memory_usage &gt; MAX_MEMORY {
        // Terminate parsing
        Token::LexError(
            LexError::Runtime("out of memory".into()).into()
        )
    } else {
        // Continue
        token
    }
});</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="limiting-stack-usage"><a class="header" href="#limiting-stack-usage">Limiting Stack Usage</a></h1>
<p>Most O/S differentiates between <em>heap</em> and <em>stack</em> memory.</p>
<p>Usually the stack (around 1MB) is much smaller than the heap (multiple MB’s or even GB’s).</p>
<p>Therefore, it is possible for a carefully-crafted script to consume all available stack memory (such
as deeply-nested expressions) and crash the host system, even though there is ample heap memory
available.</p>
<h2 id="calculate-stack-usage"><a class="header" href="#calculate-stack-usage">Calculate Stack Usage</a></h2>
<p>Some O/S’s provide system calls to get the stack size and/or amount of free stack memory, but these
are in the minority.</p>
<p>In order to determine the amount of stack memory actually used, it is necessary to perform some
pointer arithmetic.</p>
<p>The trick is to get the address of a stack-allocated variable in the very beginning and compare it
to the address of another variable.</p>
<pre><code class="language-rust">// Create a variable on the stack.
let stack_base_ref = Dynamic::UNIT;
// Get a pointer to it.
let stack_base: *const Dynamic = &amp;stack_base_ref;

// ... do a lot of work here ...

// Create another variable on the stack.
let stack_top = Dynamic::UNIT;
// Get a pointer to it.
let stack_top: *const Dynamic = &amp;stack_top;

let usage = unsafe { stack_top.offset_from(stack_base) };</code></pre>
<div id="admonition-negative-values" class="admonition admonish-question small" role="note" aria-labelledby="admonition-negative-values-title">
<div class="admonition-title">
<div id="admonition-negative-values-title">
<p>Negative values</p>
</div>
<a class="admonition-anchor-link" href="safety/stack.html#admonition-negative-values"></a>
</div>
<div>
<p>In many cases, the amount of stack memory used is actually <em>negative</em>
(meaning that the base variable is in a higher memory address than the current variable).</p>
<p>That is because, for many architectures, the stack grows <em>downwards</em> and the heap
grows <em>upwards</em> in order to maximize memory usage efficiency.</p>
</div>
</div>
<h2 id="during-evaluation-1"><a class="header" href="#during-evaluation-1">During Evaluation</a></h2>
<p>To prevent <em>stack-overflow</em> failures, provide a closure to <a href="safety//book/safety/progress.html"><code>Engine::on_progress</code></a> to
track stack usage and force-terminate a malicious script before it can bring down the host system.</p>
<pre><code class="language-rust">let mut engine = Engine::new();

const MAX_STACK: usize = 100 * 1024;    // 10KB

// Create a variable on the stack.
let stack_base_ref = Dynamic::UNIT;
// Get a pointer to it.
let stack_base: *const Dynamic = &amp;stack_base_ref;

engine.on_progress(move |_| {
    // Create another variable on the stack.
    let stack_top = Dynamic::UNIT;
    // Get a pointer to it.
    let stack_top: *const Dynamic = &amp;stack_top;

    let usage = unsafe { stack_base.offset_from(stack_top) };

    if usage &gt; MAX_STACK {
        // Terminate the script 
        Some(Dynamic::UNIT)
    } else {
        // Continue
        None
    }
});</code></pre>
<h2 id="during-parsing-1"><a class="header" href="#during-parsing-1">During Parsing</a></h2>
<p>A malicious script can be carefully crafted such that it consumes all stack memory during the
parsing stage.</p>
<p>Protect against this by via a closure to <a href="safety//book/engine/token-mapper.html"><code>Engine::on_parse_token</code></a>.</p>
<pre><code class="language-rust">let mut engine = Engine::new();

const MAX_STACK: usize = 100 * 1024;    // 10KB

// Create a variable on the stack.
let stack_base_ref = Dynamic::UNIT;
// Get a pointer to it.
let stack_base: *const Dynamic = &amp;stack_base_ref;

engine.on_parse_token(|token, _, _| {
    // Create another variable on the stack.
    let stack_top = Dynamic::UNIT;
    // Get a pointer to it.
    let stack_top: *const Dynamic = &amp;stack_top;

    let usage = unsafe { stack_base.offset_from(stack_top) };

    if usage &gt; MAX_STACK {
        // Terminate parsing
        Token::LexError(
            LexError::Runtime("stack-overflow".into()).into()
        )
    } else {
        // Continue
        token
    }
});</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="built-in-safety-limits"><a class="header" href="#built-in-safety-limits">Built-In Safety Limits</a></h1>
<p>Rhai has a number of safety limits built into the <a href="safety//book/engine/hello-world.html"><code>Engine</code></a>.</p>
<p>All these limits can be disabled, for higher performance (but higher risks as well), via the
<a href="safety//book/start/features.html"><code>unchecked</code></a> feature.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="maximum-length-of-strings"><a class="header" href="#maximum-length-of-strings">Maximum Length of Strings</a></h1>
<p>Rhai by default does not limit how long a <a href="safety//book/language/strings-chars.html">string</a> can be.</p>
<p>This can be changed via the <a href="safety//book/engine/options.html"><code>Engine::set_max_string_size</code></a> method, with zero being
unlimited (the default).</p>
<p>A script attempting to create a <a href="safety//book/language/strings-chars.html">string</a> literal longer than the maximum length will terminate with
a parse error.</p>
<p>Any script operation that produces a <a href="safety//book/language/strings-chars.html">string</a> longer than the maximum also terminates the script
with an error.</p>
<p>This check can be disabled via the <a href="safety//book/start/features.html"><code>unchecked</code></a> feature for higher performance (but higher risks as well).</p>
<pre><code class="language-rust">let mut engine = Engine::new();

engine.set_max_string_size(500);    // allow strings only up to 500 bytes long (in UTF-8 format)

engine.set_max_string_size(0);      // allow unlimited string length</code></pre>
<div id="admonition-maximum-length" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-maximum-length-title">
<div class="admonition-title">
<div id="admonition-maximum-length-title">
<p>Maximum length</p>
</div>
<a class="admonition-anchor-link" href="safety/max-string-size.html#admonition-maximum-length"></a>
</div>
<div>
<p>Be conservative when setting a maximum limit and always consider the fact that a registered function may grow
a string’s length without Rhai noticing until the very end.</p>
<p>For instance, the built-in <code>+</code> operator for strings concatenates two strings together to form one longer string;
if both strings are <em>slightly</em> below the maximum length limit, the resultant string may be almost <em>twice</em> the maximum length.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="maximum-size-of-arrays"><a class="header" href="#maximum-size-of-arrays">Maximum Size of Arrays</a></h1>
<p>Rhai by default does not limit how large an <a href="safety//book/language/arrays.html">array</a> or a <a href="safety//book/language/blobs.html">BLOB</a> can be.</p>
<p>This can be changed via the <a href="safety//book/engine/options.html"><code>Engine::set_max_array_size</code></a> method, with zero being
unlimited (the default).</p>
<p>A script attempting to create an <a href="safety//book/language/arrays.html">array</a> literal larger than the maximum will terminate with a parse error.</p>
<p>Any script operation that produces an <a href="safety//book/language/arrays.html">array</a> or a <a href="safety//book/language/blobs.html">BLOB</a> larger than the maximum also terminates
the script with an error result.</p>
<p>This check can be disabled via the <a href="safety//book/start/features.html"><code>unchecked</code></a> feature for higher performance (but higher risks as well).</p>
<pre><code class="language-rust">let mut engine = Engine::new();

engine.set_max_array_size(500);     // allow arrays only up to 500 items

engine.set_max_array_size(0);       // allow unlimited arrays</code></pre>
<div id="admonition-maximum-size" class="admonition admonish-danger" role="note" aria-labelledby="admonition-maximum-size-title">
<div class="admonition-title">
<div id="admonition-maximum-size-title">
<p>Maximum size</p>
</div>
<a class="admonition-anchor-link" href="safety/max-array-size.html#admonition-maximum-size"></a>
</div>
<div>
<p>Be conservative when setting a maximum limit and always consider the fact that a registered function
may grow an <a href="safety//book/language/arrays.html">array</a>’s or <a href="safety//book/language/blobs.html">BLOB</a>’s size without Rhai noticing until the very end.</p>
<p>For instance, the built-in <code>+</code> operator for <a href="safety//book/language/arrays.html">arrays</a> and <a href="safety//book/language/blobs.html">BLOB’s</a> concatenates two of them together
to form one larger <a href="safety//book/language/arrays.html">array</a> or <a href="safety//book/language/blobs.html">BLOB</a>; if both sources are <em>slightly</em> below the maximum size limit,
the result may be almost <em>twice</em> the maximum size.</p>
<p>As a malicious script may also create a deeply-nested <a href="safety//book/language/arrays.html">array</a> which consumes huge amounts of memory
while each individual <a href="safety//book/language/arrays.html">array</a> still stays under the maximum size limit, Rhai also <em>recursively</em> adds
up the sizes of all <a href="safety//book/language/strings-chars.html">strings</a>, <a href="safety//book/language/arrays.html">arrays</a>, [blobs] and <a href="safety//book/language/object-maps.html">object maps</a> contained within each <a href="safety//book/language/arrays.html">array</a> to
make sure that the <em>aggregate</em> sizes of none of these data structures exceed their respective
maximum size limits (if any).</p>
<pre><code class="language-rust">// Small, innocent array...
let small_array = [42];             // 1-deep... 1 item, 1 array

// ... becomes huge when multiplied!
small_array.push(small_array);      // 2-deep... 2 items, 2 arrays
small_array.push(small_array);      // 3-deep... 4 items, 4 arrays
small_array.push(small_array);      // 4-deep... 8 items, 8 arrays
small_array.push(small_array);      // 5-deep... 16 items, 16 arrays
          :
          :
small_array.push(small_array);      // &lt;- Rhai raises an error somewhere here
small_array.push(small_array);      //    when the TOTAL number of items in
small_array.push(small_array);      //    the entire array tree exceeds limit

// Or this abomination...
let a = [ 42 ];

loop {
    a[0] = a;       // &lt;- only 1 item, but infinite number of arrays
}</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="maximum-size-of-object-maps"><a class="header" href="#maximum-size-of-object-maps">Maximum Size of Object Maps</a></h1>
<p>Rhai by default does not limit how large (i.e. the number of properties) an <a href="safety//book/language/object-maps.html">object map</a> can be.</p>
<p>This can be changed via <code>Engine::set_max_map_size</code>, with zero being unlimited (the default).</p>
<p>A script attempting to create an <a href="safety//book/language/object-maps.html">object map</a> literal with more properties than the maximum will
terminate with a parse error.</p>
<p>Any script operation that produces an <a href="safety//book/language/object-maps.html">object map</a> with more properties than the maximum also
terminates the script with an error.</p>
<p>This check can be disabled via the <a href="safety//book/start/features.html"><code>unchecked</code></a> feature for higher performance (but higher risks as well).</p>
<pre><code class="language-rust">let mut engine = Engine::new();

engine.set_max_map_size(500);       // allow object maps with only up to 500 properties

engine.set_max_map_size(0);         // allow unlimited object maps</code></pre>
<div id="admonition-maximum-size" class="admonition admonish-danger" role="note" aria-labelledby="admonition-maximum-size-title">
<div class="admonition-title">
<div id="admonition-maximum-size-title">
<p>Maximum size</p>
</div>
<a class="admonition-anchor-link" href="safety/max-map-size.html#admonition-maximum-size"></a>
</div>
<div>
<p>Be conservative when setting a maximum limit and always consider the fact that a registered function
may grow an <a href="safety//book/language/object-maps.html">object map</a>’s size without Rhai noticing until the very end.</p>
<p>For instance, the built-in <code>+</code> operator for <a href="safety//book/language/object-maps.html">object maps</a> concatenates two <a href="safety//book/language/object-maps.html">object maps</a> together to
form one larger <a href="safety//book/language/object-maps.html">object map</a>; if both <a href="safety//book/language/object-maps.html">object maps</a> are <em>slightly</em> below the maximum size limit, the
resultant <a href="safety//book/language/object-maps.html">object map</a> may be almost <em>twice</em> the maximum size.</p>
<p>As a malicious script may create a deeply-nested <a href="safety//book/language/object-maps.html">object map</a> which consumes huge amounts of memory
while each individual <a href="safety//book/language/object-maps.html">object map</a> still stays under the maximum size limit, Rhai also <em>recursively</em>
adds up the sizes of all <a href="safety//book/language/strings-chars.html">strings</a>, <a href="safety//book/language/arrays.html">arrays</a> and <a href="safety//book/language/object-maps.html">object maps</a> contained within each <a href="safety//book/language/object-maps.html">object map</a> to
make sure that the <em>aggregate</em> sizes of none of these data structures exceed their respective
maximum size limits (if any).</p>
<pre><code class="language-rust">// Small, innocent object map...
let small_map: #{ x: 42 };          // 1-deep... 1 item, 1 object map

// ... becomes huge when multiplied!
small_map.y = small_map;            // 2-deep... 2 items, 2 object maps
small_map.y = small_map;            // 3-deep... 4 items, 4 object maps
small_map.y = small_map;            // 4-deep... 8 items, 8 object maps
small_map.y = small_map;            // 5-deep... 16 items, 16 object maps
          :
          :
small_map.y = small_map;            // &lt;- Rhai raises an error somewhere here
small_map.y = small_map;            //    when the TOTAL number of items in
small_map.y = small_map;            //    the entire array tree exceeds limit

// Or this abomination...
let map = #{ x: 42 };

loop {
    map.x = map;    // &lt;- only 1 item, but infinite number of object maps
}</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="maximum-number-of-operations"><a class="header" href="#maximum-number-of-operations">Maximum Number of Operations</a></h1>
<p>In Rhai, it is trivial to construct <em>infinite loops</em>, or scripts that run for a very long time.</p>
<pre><code class="language-rust">loop { ... }                        // infinite loop

while 1 &lt; 2 { ... }                 // loop with always-true condition</code></pre>
<p>Rhai by default does not limit how much time or CPU a script consumes.</p>
<p>This can be changed via the <a href="safety//book/engine/options.html"><code>Engine::set_max_operations</code></a> method, with zero being
unlimited (the default).</p>
<p>The <em>operations count</em> is intended to be a very course-grained measurement of the amount of CPU that
a script has consumed, allowing the system to impose a hard upper limit on computing resources.</p>
<p>A script exceeding the maximum operations count terminates with an error result. This can be
disabled via the <a href="safety//book/start/features.html"><code>unchecked</code></a> feature for higher performance (but higher risks as well).</p>
<pre><code class="language-rust">let mut engine = Engine::new();

engine.set_max_operations(500);     // allow only up to 500 operations for this script

engine.set_max_operations(0);       // allow unlimited operations</code></pre>
<div id="admonition-tldr--what-does-one-_operation_-mean" class="admonition admonish-question" role="note" aria-labelledby="admonition-tldr--what-does-one-_operation_-mean-title">
<div class="admonition-title">
<div id="admonition-tldr--what-does-one-_operation_-mean-title">
<p>TL;DR – What does one <em>operation</em> mean?</p>
</div>
<a class="admonition-anchor-link" href="safety/max-operations.html#admonition-tldr--what-does-one-_operation_-mean"></a>
</div>
<div>
<p>The concept of one single <em>operation</em> in Rhai is volatile – it roughly equals one expression
node, loading one <a href="safety//book/language/variables.html">variable</a>/<a href="safety//book/language/constants.html">constant</a>, one <a href="safety//book/appendix/operators.html#operators">operator</a> call, one iteration of a loop, or one
<a href="safety//book/language/functions.html">function</a> call etc. with sub-expressions, statements and <a href="safety//book/language/functions.html">function</a> calls executed inside these
contexts accumulated on top.</p>
<p>A good rule-of-thumb is that one simple non-trivial expression consumes on average 5-10 operations.</p>
<p>One <em>operation</em> can take an unspecified amount of time and real CPU cycles, depending on the particulars.
For example, loading a <a href="safety//book/language/constants.html">constant</a> consumes very few CPU cycles, while calling an external Rust function,
though also counted as only one operation, may consume much more computing resources.</p>
<p>To help visualize, think of an <em>operation</em> as roughly equals to one <em>instruction</em> of a hypothetical CPU
which includes <em>specialized</em> instructions, such as <em>function call</em>, <em>load module</em> etc., each taking up
one CPU cycle to execute.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="maximum-number-of-variables"><a class="header" href="#maximum-number-of-variables">Maximum Number of Variables</a></h1>
<p>Rhai by default does not limit how many <a href="safety//book/language/variables.html">variables</a>/<a href="safety//book/language/constants.html">constants</a> can be defined within a single <a href="safety//book/engine/scope.html"><code>Scope</code></a>.</p>
<p>This can be changed via the <a href="safety//book/engine/options.html"><code>Engine::set_max_variables</code></a> method. Notice that setting the
maximum number of <a href="safety//book/language/variables.html">variables</a> to zero does <em>not</em> indicate unlimited <a href="safety//book/language/variables.html">variables</a>, but disallows
defining any <a href="safety//book/language/variables.html">variable</a> altogether.</p>
<p>A script attempting to define more than the maximum number of <a href="safety//book/language/variables.html">variables</a>/<a href="safety//book/language/constants.html">constants</a> will terminate
with an error result.</p>
<p>This check can be disabled via the <a href="safety//book/start/features.html"><code>unchecked</code></a> feature for higher performance (but higher risks as well).</p>
<pre><code class="language-rust">let mut engine = Engine::new();

engine.set_max_variables(5);      // allow defining only up to 5 variables

engine.set_max_variables(0);      // disallow defining any variable (maximum = zero)

engine.set_max_variables(1000);   // set to a large number for effectively unlimited variables</code></pre>
<div id="admonition-function-calls-are-separate-scopes" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-function-calls-are-separate-scopes-title">
<div class="admonition-title">
<div id="admonition-function-calls-are-separate-scopes-title">
<p>Function calls are separate scopes</p>
</div>
<a class="admonition-anchor-link" href="safety/max-variables.html#admonition-function-calls-are-separate-scopes"></a>
</div>
<div>
<p>Each <a href="safety//book/language/functions.html">function</a> call creates a new, empty <a href="safety//book/engine/scope.html"><code>Scope</code></a>.</p>
<p>Therefore, <a href="safety//book/language/variables.html">variables</a>/<a href="safety//book/language/constants.html">constants</a> defined within <a href="safety//book/language/functions.html">functions</a> are counted afresh.</p>
<p>Care must be taken to avoid deeply-nested (or recursive) <a href="safety//book/language/functions.html">function</a> calls from creating too many
<a href="safety//book/language/variables.html">variables</a>/<a href="safety//book/language/constants.html">constants</a> while staying within the limit of each individual <a href="safety//book/engine/scope.html"><code>Scope</code></a>.</p>
</div>
</div>
<div id="admonition-function-call-arguments-count-as-variables" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-function-call-arguments-count-as-variables-title">
<div class="admonition-title">
<div id="admonition-function-call-arguments-count-as-variables-title">
<p>Function call arguments count as variables</p>
</div>
<a class="admonition-anchor-link" href="safety/max-variables.html#admonition-function-call-arguments-count-as-variables"></a>
</div>
<div>
<p>The parameters of a <a href="safety//book/language/functions.html">function</a> also count as <a href="safety//book/language/variables.html">variables</a> within the <a href="safety//book/language/functions.html">function</a>’s <a href="safety//book/engine/scope.html"><code>Scope</code></a>.</p>
<p>Thus the maximum number of <a href="safety//book/language/variables.html">variables</a>/<a href="safety//book/language/constants.html">constants</a> allowed is reduced by the number of parameters of the <a href="safety//book/language/functions.html">function</a>.</p>
</div>
</div>
<div id="admonition-tip-reusing-a-variable-doesnt-count" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-reusing-a-variable-doesnt-count-title">
<div class="admonition-title">
<div id="admonition-tip-reusing-a-variable-doesnt-count-title">
<p>Tip: Reusing a variable doesn’t count</p>
</div>
<a class="admonition-anchor-link" href="safety/max-variables.html#admonition-tip-reusing-a-variable-doesnt-count"></a>
</div>
<div>
<p>It is possible to <em>reuse</em> a <a href="safety//book/language/variables.html">variable</a> such that it is counted only once.</p>
<pre><code class="language-rust">let x = 42;     // counted as 1 variable
let y = 123;

let x = 0;      // previous 'x' reused: not counted as new variable</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="maximum-number-of-functions"><a class="header" href="#maximum-number-of-functions">Maximum Number of Functions</a></h1>
<p>Rhai by default does not limit how many <a href="safety//book/language/functions.html">functions</a> can be defined in a script.</p>
<p>This can be changed via the <a href="safety//book/engine/options.html"><code>Engine::set_max_functions</code></a> method. Notice that setting the
maximum number of <a href="safety//book/language/functions.html">functions</a> to zero does <em>not</em> indicate unlimited <a href="safety//book/language/functions.html">functions</a>, but disallows
defining any scripted <a href="safety//book/language/functions.html">function</a> altogether.</p>
<p>A script attempting to load more than the maximum number of <a href="safety//book/language/functions.html">functions</a> will terminate with a parse error.</p>
<p>This check can be disabled via the <a href="safety//book/start/features.html"><code>unchecked</code></a> feature for higher performance (but higher risks as well).</p>
<pre><code class="language-rust">let mut engine = Engine::new();

engine.set_max_functions(5);        // allow defining only up to 5 functions

engine.set_max_functions(0);        // disallow defining function (maximum = zero)

engine.set_max_functions(1000);     // set to a large number for effectively unlimited functions</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="maximum-number-of-modules"><a class="header" href="#maximum-number-of-modules">Maximum Number of Modules</a></h1>
<p>Rhai by default does not limit how many <a href="safety//book/rust/modules/index.html">modules</a> can be loaded via <a href="safety//book/language/modules/import.html"><code>import</code></a> statements.</p>
<p>This can be changed via the <a href="safety//book/engine/options.html"><code>Engine::set_max_modules</code></a> method. Notice that setting the
maximum number of modules to zero does <em>not</em> indicate unlimited modules, but disallows loading any
module altogether.</p>
<p>A script attempting to load more than the maximum number of modules will terminate with an error result.</p>
<p>This limit can also be used to stop <a href="safety//book/language/modules/import.html"><code>import</code>-loops</a> (i.e. cycles of modules referring to
each other).</p>
<p>This check can be disabled via the <a href="safety//book/start/features.html"><code>unchecked</code></a> feature for higher performance (but higher risks as well).</p>
<pre><code class="language-rust">let mut engine = Engine::new();

engine.set_max_modules(5);      // allow loading only up to 5 modules

engine.set_max_modules(0);      // disallow loading any module (maximum = zero)

engine.set_max_modules(1000);   // set to a large number for effectively unlimited modules</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="maximum-call-stack-depth"><a class="header" href="#maximum-call-stack-depth">Maximum Call Stack Depth</a></h1>
<p>In Rhai, it is trivial for a function call to perform <em>infinite recursion</em> (or a very deeply-nested
recursion) such that all stack space is exhausted.</p>
<pre><code class="language-rust">// This is a function that, when called, recurses forever.
fn recurse_forever() {
    recurse_forever();
}</code></pre>
<div id="admonition-main-stack-size" class="admonition admonish-info side" role="note" aria-labelledby="admonition-main-stack-size-title">
<div class="admonition-title">
<div id="admonition-main-stack-size-title">
<p>Main stack size</p>
</div>
<a class="admonition-anchor-link" href="safety/max-call-stack.html#admonition-main-stack-size"></a>
</div>
<div>
<p>The main stack-size of a program is <em>not</em> determined by Rust but is platform-dependent.</p>
<p>See <a href="https://doc.rust-lang.org/std/thread/#stack-size">this on-line Rust docs</a> for more details.</p>
</div>
</div>
<p>Because of its intended embedded usage, Rhai, by default, limits function calls to a maximum depth
of 64 levels (8 levels in debug build) in order to fit into most platforms’ default stack sizes.</p>
<p>This limit may be changed via the <a href="safety//book/engine/options.html"><code>Engine::set_max_call_levels</code></a> method.</p>
<p>A script exceeding the maximum call stack depth will terminate with an error result.</p>
<p>This check can be disabled via the <a href="safety//book/start/features.html"><code>unchecked</code></a> feature for higher performance (but higher risks as well).</p>
<pre><code class="language-rust">let mut engine = Engine::new();

engine.set_max_call_levels(10);     // allow only up to 10 levels of function calls

engine.set_max_call_levels(0);      // allow no function calls at all (max depth = zero)</code></pre>
<div id="admonition-additional-considerations" class="admonition admonish-info small" role="note" aria-labelledby="admonition-additional-considerations-title">
<div class="admonition-title">
<div id="admonition-additional-considerations-title">
<p>Additional considerations</p>
</div>
<a class="admonition-anchor-link" href="safety/max-call-stack.html#admonition-additional-considerations"></a>
</div>
<div>
<p>When setting this limit, care must be also be taken to the evaluation depth of each <em>statement</em>
within a function.</p>
<p>It is entirely possible for a malicious script to embed a recursive call deep inside a nested
expression or statements block (see <a href="safety//book/safety/max-stmt-depth.html">maximum statement depth</a>).</p>
<pre><code class="language-rust">fn bad_function(n) {
    // Bail out long before reaching the limit
    if n &gt; 10 {
        return;
    }

    // Nest many, many levels deep...
    if check_1() {
        if check_2() {
            if check_3() {
                if check_4() {
                        :
                    if check_n() {
                        bad_function(n+1);  // &lt;- recursive call!
                    }
                        :
                }
            }
        }
    }
}

// The function call below may still overflow the stack!
bad_function(0);</code></pre>
</div>
</div>
<div id="admonition-tip-getting-around-the-stack-size-limit" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-getting-around-the-stack-size-limit-title">
<div class="admonition-title">
<div id="admonition-tip-getting-around-the-stack-size-limit-title">
<p>Tip: Getting around the stack size limit</p>
</div>
<a class="admonition-anchor-link" href="safety/max-call-stack.html#admonition-tip-getting-around-the-stack-size-limit"></a>
</div>
<div>
<p>While the stack size of a program’s <em>main</em> thread is platform-specific, Rust defaults to a stack
size of 2MB for spawned threads.</p>
<p>This default can further be changed such that a spawned thread has as large a stack as needed.</p>
<p>See <a href="https://doc.rust-lang.org/std/thread/#stack-size">the on-line Rust docs</a> for more details.</p>
<p>Therefore, in order to relax the stack size limit for scripts, run the <a href="safety//book/engine/hello-world.html"><code>Engine</code></a> in a separate
spawned thread with a larger stack.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="maximum-expression-nesting-depth"><a class="header" href="#maximum-expression-nesting-depth">Maximum Expression Nesting Depth</a></h1>
<p>Rhai by default limits statement and expression nesting to a maximum depth of 64 (which should be
plenty) when they are at <em>global</em> level, but only a depth of 32 when they are within <a href="safety//book/language/functions.html">function</a> bodies.</p>
<p>For debug builds, these limits are set further downwards to 32 and 16 respectively.</p>
<p>That is because it is possible to overflow the <a href="safety//book/engine/hello-world.html"><code>Engine</code></a>’s stack when it tries to recursively parse
an extremely deeply-nested code stream.</p>
<pre><code class="language-rust">// The following, if long enough, can easily cause stack overflow during parsing.
let a = (1+(1+(1+(1+(1+(1+(1+(1+(1+(1+(...)+1)))))))))));</code></pre>
<p>This limit may be changed via <a href="safety//book/engine/options.html"><code>Engine::set_max_expr_depths</code></a>.</p>
<p>There are two limits to set, one for the maximum depth at global level, and the other for <a href="safety//book/language/functions.html">function</a> bodies.</p>
<p>A script exceeding the maximum nesting depths will terminate with a parse error. The malicious
<a href="safety//book/engine/compile.html"><code>AST</code></a> will not be able to get past parsing in the first place.</p>
<p>This check can be disabled via the <a href="safety//book/start/features.html"><code>unchecked</code></a> feature for higher performance (but higher risks as well).</p>
<pre><code class="language-rust">let mut engine = Engine::new();

engine.set_max_expr_depths(50, 5);  // allow nesting up to 50 layers of expressions/statements
                                    // at global level, but only 5 inside functions</code></pre>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="safety/max-stmt-depth.html#admonition-warning"></a>
</div>
<div>
<p>Multiple layers of expressions may be generated for a simple language construct, even though it may correspond
to only one AST node.</p>
<p>That is because the Rhai <em>parser</em> internally runs a recursive chain of <a href="safety//book/language/functions.html">function</a> calls and it is important that
a malicious script does not panic the parser in the first place.</p>
</div>
</div>
<div id="admonition-beware-of-recursion" class="admonition admonish-danger" role="note" aria-labelledby="admonition-beware-of-recursion-title">
<div class="admonition-title">
<div id="admonition-beware-of-recursion-title">
<p>Beware of recursion</p>
</div>
<a class="admonition-anchor-link" href="safety/max-stmt-depth.html#admonition-beware-of-recursion"></a>
</div>
<div>
<p><em><a href="safety//book/language/functions.html">Functions</a></em> are placed under stricter limits because of the multiplicative effect of <em>recursion</em>.</p>
<p>A <a href="safety//book/language/functions.html">function</a> can effectively call itself while deep inside an expression chain within the <a href="safety//book/language/functions.html">function</a>
body, thereby overflowing the stack even when the level of recursion is within limit.</p>
<pre><code class="language-rust">fn deep_calc(a, n) {
    (a+(a+(a+(a+(a+(a+(a+(a+(a+ ... (a+deep_calc(a,n+1)) ... )))))))))
    //                                 ^^^^^^^^^^^^^^^^ recursive call!
}

let a = 42;

let result = (a+(a+(a+(a+(a+(a+(a+(a+(a+ ... (a+deep_calc(a,0)) ... )))))))));</code></pre>
<p>In the contrived example above, each recursive call to the <a href="safety//book/language/functions.html">function</a> <code>deep_calc</code> adds the total
number of nested expression layers to Rhai’s evaluation stack.  Sooner or later (most likely sooner
than the limit for <a href="safety//book/safety/max-call-stack.html">maximum depth of function calls</a> is reached), a stack
overflow can be expected.</p>
<p>In general, make sure that <code>C x ( 5 + F ) + S</code> layered calls do not cause a stack overflow, where:</p>
<ul>
<li><code>C</code> = maximum call stack depth,</li>
<li><code>F</code> = maximum statement depth for <a href="safety//book/language/functions.html">functions</a>,</li>
<li><code>S</code> = maximum statement depth at global level.</li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="turning-off-safety-checks"><a class="header" href="#turning-off-safety-checks">Turning Off Safety Checks</a></h1>
<h2 id="checked-arithmetic"><a class="header" href="#checked-arithmetic">Checked Arithmetic</a></h2>
<div id="admonition-dont-panic" class="admonition admonish-bug side" role="note" aria-labelledby="admonition-dont-panic-title">
<div class="admonition-title">
<div id="admonition-dont-panic-title">
<p>Don’t Panic</p>
</div>
<a class="admonition-anchor-link" href="safety/checked.html#admonition-dont-panic"></a>
</div>
<div>
<p>Scripts under normal builds of Rhai never crash the host system – any panic is a bug.</p>
</div>
</div>
<p>By default, all arithmetic calculations in Rhai are <em>checked</em>, meaning that the script terminates
with a runtime error whenever it detects a numeric over-flow/under-flow condition or an invalid
floating-point operation.</p>
<p>This checking can be turned off via the <a href="safety//book/start/features.html"><code>unchecked</code></a> feature for higher performance (but higher
risks as well).</p>
<pre><code class="language-rust">let x = 1_000_000_000_000;

x * x;      // Normal build - runtime error: multiplication overflow

x * x;      // 'unchecked' debug build - panic!
            // 'unchecked' release build - overflow with no error

x / 0;      // Normal build - runtime error: division by zero

x / 0;      // 'unchecked' build - panic!</code></pre>
<h2 id="other-safety-checks"><a class="header" href="#other-safety-checks">Other Safety Checks</a></h2>
<p>In addition to overflows, there are many other safety checks performed by Rhai at runtime.
<a href="safety//book/start/features.html"><code>unchecked</code></a> turns them <strong>all</strong> off as well, such as…</p>
<h3 id="infinite-loops"><a class="header" href="#infinite-loops"><a href="safety//book/safety/max-operations.html">Infinite loops</a></a></h3>
<pre><code class="language-rust">// Normal build - runtime error: exceeds maximum number of operations
loop {
    foo();
}

// 'unchecked' build - never terminates!
loop {
    foo();
}</code></pre>
<h3 id="infinite-recursion"><a class="header" href="#infinite-recursion"><a href="safety//book/safety/max-call-stack.html">Infinite recursion</a></a></h3>
<pre><code class="language-rust">fn foo() {
    foo();
}

foo();      // Normal build - runtime error: exceeds maximum stack depth

foo();      // 'unchecked' build - panic due to stack overflow!</code></pre>
<h3 id="gigantic-data-structures"><a class="header" href="#gigantic-data-structures"><a href="safety//book/safety/max-array-size.html">Gigantic data structures</a></a></h3>
<pre><code class="language-rust">let x = [];

// Normal build - runtime error: array exceeds maximum size
loop {
    x += 42;
}

// 'unchecked' build - panic due to out-of-memory!
loop {
    x += 42;
}</code></pre>
<h3 id="improper-range-iteration"><a class="header" href="#improper-range-iteration">Improper range iteration</a></h3>
<pre><code class="language-rust">// Normal build - runtime error: zero step
for x in range(0, 10, 0) { ... }

// 'unchecked' build - never terminates!
for x in range(0, 10, 0) { ... }

// Normal build - empty range
for x in range(0, 10, -1) { ... }

// 'unchecked' build - panic due to numeric underflow!
for x in range(0, 10, -1) { ... }</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="script-optimization"><a class="header" href="#script-optimization">Script Optimization</a></h1>
<p>Rhai includes an <em>optimizer</em> that tries to optimize a script after parsing.
This can reduce resource utilization and increase execution speed.</p>
<p>Script optimization can be turned off via the <a href="engine/optimize//book/start/features.html"><code>no_optimize</code></a> feature.</p>
<h1 id="optimization-levels"><a class="header" href="#optimization-levels">Optimization Levels</a></h1>
<p>There are three levels of optimization: <code>None</code>, <code>Simple</code> and <code>Full</code>.
The default is <code>Simple</code>.</p>
<p>An <a href="engine/optimize//book/engine/hello-world.html"><code>Engine</code></a>’s optimization level is set via <a href="engine/optimize//book/engine/options.html"><code>Engine::set_optimization_level</code></a>.</p>
<pre><code class="language-rust">// Turn on aggressive optimizations
engine.set_optimization_level(rhai::OptimizationLevel::Full);</code></pre>
<h2 id="none"><a class="header" href="#none"><code>None</code></a></h2>
<p><code>None</code> is obvious – no optimization on the AST is performed.</p>
<h2 id="simple-default"><a class="header" href="#simple-default"><code>Simple</code> (Default)</a></h2>
<p><code>Simple</code> performs only relatively <em>safe</em> optimizations without causing side-effects (i.e. it only
relies on static analysis and <a href="engine/optimize//book/engine/builtin.html">built-in operators</a> for <a href="engine/optimize//book/language/constants.html">constant</a> <a href="engine/optimize//book/language/values-and-types.html">standard types</a>, and will not
perform any external function calls).</p>
<div id="admonition-warning" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="engine/optimize/index.html#admonition-warning"></a>
</div>
<div>
<p>After <em>constants propagation</em> is performed, if the <a href="engine/optimize//book/language/constants.html">constants</a> are then modified (yes, it is possible, via Rust functions),
the modified values will <em>not</em> show up in the optimized script.</p>
<p>Only the initialization values of <a href="engine/optimize//book/language/constants.html">constants</a> are ever retained.</p>
</div>
</div>
<div id="admonition-warning-1" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-warning-1-title">
<div class="admonition-title">
<div id="admonition-warning-1-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="engine/optimize/index.html#admonition-warning-1"></a>
</div>
<div>
<p>Overriding a <a href="engine/optimize//book/engine/builtin.html">built-in operator</a> in the <a href="engine/optimize//book/engine/hello-world.html"><code>Engine</code></a> afterwards has no effect after the
optimizer replaces an expression with its calculated value.</p>
</div>
</div>
<h2 id="full"><a class="header" href="#full"><code>Full</code></a></h2>
<p><code>Full</code> is <em>much</em> more aggressive, <em>including</em> calling external functions on <a href="engine/optimize//book/language/constants.html">constant</a> arguments to
determine their results.</p>
<p>One benefit to this is that many more optimization opportunities arise, especially with regards to
comparison operators.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="optimization-passes"><a class="header" href="#optimization-passes">Optimization Passes</a></h1>
<p><a href="engine/optimize//book/engine/optimize/index.html">Script optimization</a> is performed via multiple <em>passes</em>.
Each pass does a specific optimization.</p>
<p>The optimization is completed when no passes can simplify the <a href="engine/optimize//book/engine/compile.html"><code>AST</code></a> any further.</p>
<h2 id="built-in-optimization-passes"><a class="header" href="#built-in-optimization-passes">Built-in Optimization Passes</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Pass</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="engine/optimize/dead-code.html">Dead code elimination</a></td><td>Eliminates code that cannot be reached</td></tr>
<tr><td><a href="engine/optimize/constants.html">Constants propagation</a></td><td>Replaces <a href="engine/optimize//book/language/constants.html">constants</a> with values</td></tr>
<tr><td><a href="engine/optimize/rewrite.html">Compound assignments rewrite</a></td><td>Rewrites assignments into compound assignments</td></tr>
<tr><td><a href="engine/optimize/op-eval.html">Eager operator evaluation</a></td><td>Eagerly calls operators with <a href="engine/optimize//book/language/constants.html">constant</a> arguments</td></tr>
<tr><td><a href="engine/optimize/eager.html">Eager function evaluation</a></td><td>Eagerly calls functions with <a href="engine/optimize//book/language/constants.html">constant</a> arguments</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="dead-code-elimination"><a class="header" href="#dead-code-elimination">Dead Code Elimination</a></h1>
<div id="admonition-but-who-writes-dead-code" class="admonition admonish-question side wide" role="note" aria-labelledby="admonition-but-who-writes-dead-code-title">
<div class="admonition-title">
<div id="admonition-but-who-writes-dead-code-title">
<p>But who writes dead code?</p>
</div>
<a class="admonition-anchor-link" href="engine/optimize/dead-code.html#admonition-but-who-writes-dead-code"></a>
</div>
<div>
<p>Nobody deliberately writes scripts with dead code (we hope).</p>
<p>They are, however, extremely common in template-based machine-generated scripts.</p>
</div>
</div>
<p>Rhai attempts to eliminate <em>dead code</em>.</p>
<p>“Dead code” is code that does nothing and has no side effects.</p>
<p>Example is an pure expression by itself as a statement (allowed in Rhai).
The result of the expression is calculated then immediately discarded and not used.</p>
<pre><code class="language-rust">{
    let x = 999;            // NOT eliminated: variable may be used later on (perhaps even an 'eval')
    
    123;                    // eliminated: no effect
    
    "hello";                // eliminated: no effect
    
    [1, 2, x, 4];           // eliminated: no effect
    
    if 42 &gt; 0 {             // '42 &gt; 0' is replaced by 'true' and the first branch promoted
        foo(42);            // promoted, NOT eliminated: the function 'foo' may have side-effects
    } else {
        bar(x);             // eliminated: branch is never reached
    }
    
    let z = x;              // eliminated: local variable, no side-effects, and only pure afterwards
    
    666                     // NOT eliminated: this is the return value of the block,
                            // and the block is the last one so this is the return value of the whole script
}</code></pre>
<p>The above script optimizes to:</p>
<pre><code class="language-rust">{
    let x = 999;
    foo(42);
    666
}</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="constants-propagation"><a class="header" href="#constants-propagation">Constants Propagation</a></h1>
<div id="admonition-tip" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="engine/optimize/constants.html#admonition-tip"></a>
</div>
<div>
<p>Effective in template-based machine-generated scripts to turn on/off certain sections.</p>
</div>
</div>
<p><a href="engine/optimize//book/language/constants.html">Constants</a> propagation is commonly used to:</p>
<ul>
<li>
<p>remove dead code,</p>
</li>
<li>
<p>avoid <a href="engine/optimize//book/language/variables.html">variable</a> lookups,</p>
</li>
<li>
<p><a href="engine/optimize/op-eval.html">pre-calculate</a> <a href="engine/optimize//book/language/constants.html">constant</a> expressions.</p>
</li>
</ul>
<pre><code class="language-rust">const ABC = true;
const X = 41;

if ABC || calc(X+1) { print("done!"); }     // 'ABC' is constant so replaced by 'true'...
                                            // 'X' is constant so replaced by 41... 

if true || calc(42) { print("done!"); }     // '41+1' is replaced by 42
                                            // since '||' short-circuits, 'calc' is never called

if true { print("done!"); }                 // &lt;- the line above is equivalent to this

print("done!");                             // &lt;- the line above is further simplified to this
                                            //    because the condition is always true</code></pre>
<div id="admonition-tip-custom-scope-constants" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-custom-scope-constants-title">
<div class="admonition-title">
<div id="admonition-tip-custom-scope-constants-title">
<p>Tip: Custom <code>Scope</code> constants</p>
</div>
<a class="admonition-anchor-link" href="engine/optimize/constants.html#admonition-tip-custom-scope-constants"></a>
</div>
<div>
<p><a href="engine/optimize//book/language/constants.html">Constant</a> values can be provided in a custom <a href="engine/optimize//book/engine/scope.html"><code>Scope</code></a> object to the <a href="engine/optimize//book/engine/hello-world.html"><code>Engine</code></a>
for optimization purposes.</p>
<pre><code class="language-rust">use rhai::{Engine, Scope};

let engine = Engine::new();

let mut scope = Scope::new();

// Add constant to custom scope
scope.push_constant("ABC", true);

// Evaluate script with custom scope
engine.run_with_scope(&amp;mut scope,
r#"
    if ABC {    // 'ABC' is replaced by 'true'
        print("done!");
    }
"#)?;</code></pre>
</div>
</div>
<div id="admonition-tip-customer-module-constants" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-customer-module-constants-title">
<div class="admonition-title">
<div id="admonition-tip-customer-module-constants-title">
<p>Tip: Customer module constants</p>
</div>
<a class="admonition-anchor-link" href="engine/optimize/constants.html#admonition-tip-customer-module-constants"></a>
</div>
<div>
<p><a href="engine/optimize//book/language/constants.html">Constants</a> defined in <a href="engine/optimize//book/rust/modules/index.html">modules</a> that are registered into an <a href="engine/optimize//book/engine/hello-world.html"><code>Engine</code></a> via
<code>Engine::register_global_module</code> are used in optimization.</p>
<pre><code class="language-rust">use rhai::{Engine, Module};

let mut engine = Engine::new();

let mut module = Module::new();

// Add constant to module
module.set_var("ABC", true);

// Register global module
engine.register_global_module(module.into());

// Evaluate script
engine.run(
r#"
    if ABC {    // 'ABC' is replaced by 'true'
        print("done!");
    }
"#)?;</code></pre>
</div>
</div>
<div id="admonition-caveat-constants-in-custom-scope-and-modules-are-also-propagated-into-functions" class="admonition admonish-danger" role="note" aria-labelledby="admonition-caveat-constants-in-custom-scope-and-modules-are-also-propagated-into-functions-title">
<div class="admonition-title">
<div id="admonition-caveat-constants-in-custom-scope-and-modules-are-also-propagated-into-functions-title">
<p>Caveat: Constants in custom scope and modules are also propagated into functions</p>
</div>
<a class="admonition-anchor-link" href="engine/optimize/constants.html#admonition-caveat-constants-in-custom-scope-and-modules-are-also-propagated-into-functions"></a>
</div>
<div>
<p><a href="engine/optimize//book/language/constants.html">Constants</a> defined at <em>global</em> level typically cannot be seen by script <a href="engine/optimize//book/language/functions.html">functions</a> because they are <em>pure</em>.</p>
<pre><code class="language-rust">const MY_CONSTANT = 42;     // &lt;- constant defined at global level

print(MY_CONSTANT);         // &lt;- optimized to: print(42)

fn foo() {
    MY_CONSTANT             // &lt;- not optimized: 'foo' cannot see 'MY_CONSTANT'
}

print(foo());               // error: 'MY_CONSTANT' not found</code></pre>
<p>When <a href="engine/optimize//book/language/constants.html">constants</a> are provided in a custom <a href="engine/optimize//book/engine/scope.html"><code>Scope</code></a> (e.g. via <code>Engine::compile_with_scope</code>,
<code>Engine::eval_with_scope</code> or <code>Engine::run_with_scope</code>), or in a <a href="engine/optimize//book/rust/modules/index.html">module</a> registered via
<code>Engine::register_global_module</code>, instead of defined within the same script, they are also
propagated to <a href="engine/optimize//book/language/functions.html">functions</a>.</p>
<p>This is usually the intuitive usage and behavior expected by regular users, even though it means
that a script will behave differently (essentially a runtime error) when <a href="engine/optimize//book/engine/optimize/index.html">script optimization</a> is disabled.</p>
<pre><code class="language-rust">use rhai::{Engine, Scope};

let engine = Engine::new();

let mut scope = Scope::new();

// Add constant to custom scope
scope.push_constant("MY_CONSTANT", 42_i64);

engine.run_with_scope(&amp;mut scope,
"
    print(MY_CONSTANT);     // optimized to: print(42)

    fn foo() {
        MY_CONSTANT         // optimized to: fn foo() { 42 }
    }

    print(foo());           // prints 42
")?;</code></pre>
<p>The script will act differently when <a href="engine/optimize//book/engine/optimize/index.html">script optimization</a> is disabled because script <a href="engine/optimize//book/language/functions.html">functions</a>
are <em>pure</em> and typically cannot see <a href="engine/optimize//book/language/constants.html">constants</a> within the custom <a href="engine/optimize//book/engine/scope.html"><code>Scope</code></a>.</p>
<p>Therefore, constants in <a href="engine/optimize//book/language/functions.html">functions</a> now throw a runtime error.</p>
<pre><code class="language-rust">use rhai::{Engine, Scope, OptimizationLevel};

let mut engine = Engine::new();

// Turn off script optimization, no constants propagation is performed
engine.set_optimization_level(OptimizationLevel::None);

let mut scope = Scope::new();

// Add constant to custom scope
scope.push_constant("MY_CONSTANT", 42_i64);

engine.run_with_scope(&amp;mut scope,
"
    print(MY_CONSTANT);     // prints 42

    fn foo() {
        MY_CONSTANT         // &lt;- 'foo' cannot see 'MY_CONSTANT'
    }

    print(foo());           // error: 'MY_CONSTANT' not found
")?;</code></pre>
</div>
</div>
<div id="admonition-caveat-beware-of-large-constants" class="admonition admonish-danger" role="note" aria-labelledby="admonition-caveat-beware-of-large-constants-title">
<div class="admonition-title">
<div id="admonition-caveat-beware-of-large-constants-title">
<p>Caveat: Beware of large constants</p>
</div>
<a class="admonition-anchor-link" href="engine/optimize/constants.html#admonition-caveat-beware-of-large-constants"></a>
</div>
<div>
<p><a href="engine/optimize//book/language/constants.html">Constants</a> propagation replaces each usage of the <a href="engine/optimize//book/language/constants.html">constant</a> with a clone of its value.</p>
<p>This may have negative implications to performance if the <a href="engine/optimize//book/language/constants.html">constant</a> value is expensive to clone
(e.g. if the type is very large).</p>
<pre><code class="language-rust">let mut scope = Scope::new();

// Push a large constant into the scope...
let big_type = AVeryLargeType::take_long_time_to_create();
scope.push_constant("MY_BIG_TYPE", big_type);

// Causes each usage of 'MY_BIG_TYPE' in the script below to be replaced
// by cloned copies of 'AVeryLargeType'.
let result = engine.run_with_scope(&amp;mut scope,
"
    let value = MY_BIG_TYPE.value;
    let data = MY_BIG_TYPE.data;
    let len = MY_BIG_TYPE.len();
    let has_options = MY_BIG_TYPE.has_options();
    let num_options = MY_BIG_TYPE.options_len();
")?;</code></pre>
<p>To avoid this, compile the script first to an <a href="engine/optimize//book/engine/compile.html"><code>AST</code></a> <em>without</em> the <a href="engine/optimize//book/language/constants.html">constants</a>, then evaluate the
<a href="engine/optimize//book/engine/compile.html"><code>AST</code></a> (e.g. with <code>Engine::eval_ast_with_scope</code> or <code>Engine::run_ast_with_scope</code>) together with
the <a href="engine/optimize//book/language/constants.html">constants</a>.</p>
</div>
</div>
<div id="admonition-caveat-constants-may-be-modified-by-rust-methods" class="admonition admonish-danger" role="note" aria-labelledby="admonition-caveat-constants-may-be-modified-by-rust-methods-title">
<div class="admonition-title">
<div id="admonition-caveat-constants-may-be-modified-by-rust-methods-title">
<p>Caveat: Constants may be modified by Rust methods</p>
</div>
<a class="admonition-anchor-link" href="engine/optimize/constants.html#admonition-caveat-constants-may-be-modified-by-rust-methods"></a>
</div>
<div>
<p>If the <a href="engine/optimize//book/language/constants.html">constants</a> are modified later on (yes, it is possible, via Rust <em>methods</em>),
the modified values will not show up in the optimized script.
Only the initialization values of <a href="engine/optimize//book/language/constants.html">constants</a> are ever retained.</p>
<pre><code class="language-rust">const MY_SECRET_ANSWER = 42;

MY_SECRET_ANSWER.update_to(666);    // assume 'update_to(&amp;mut i64)' is a Rust function

print(MY_SECRET_ANSWER);            // prints 42 because the constant is propagated</code></pre>
<p>This is almost never a problem because real-world scripts seldom modify a <a href="engine/optimize//book/language/constants.html">constant</a>,
but the possibility is always there.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="compound-assignment-rewrite"><a class="header" href="#compound-assignment-rewrite">Compound Assignment Rewrite</a></h1>
<div id="admonition-avoid-cloning" class="admonition admonish-info side" role="note" aria-labelledby="admonition-avoid-cloning-title">
<div class="admonition-title">
<div id="admonition-avoid-cloning-title">
<p>Avoid cloning</p>
</div>
<a class="admonition-anchor-link" href="engine/optimize/rewrite.html#admonition-avoid-cloning"></a>
</div>
<div>
<p>Arguments passed as value are always cloned.</p>
</div>
</div>
<p>Usually, a <em>compound assignment</em> (e.g. <code>+=</code> for append) takes a mutable first parameter
(i.e. <code>&amp;mut</code>) while the corresponding simple <a href="engine/optimize//book/appendix/operators.html#operators">operator</a> (i.e. <code>+</code>) does not.</p>
<p>The script optimizer rewrites normal assignments into <em>compound assignments</em> wherever possible in
order to avoid unnecessary cloning.</p>
<pre><code class="language-rust">let big = create_some_very_big_type();

big = big + 1;
//    ^ 'big' is cloned here

// The above is equivalent to:
let temp_value = big + 1;
big = temp_value;

big += 1;           // &lt;- 'big' is NOT cloned</code></pre>
<div id="admonition-warning-simple-references-only" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-warning-simple-references-only-title">
<div class="admonition-title">
<div id="admonition-warning-simple-references-only-title">
<p>Warning: Simple references only</p>
</div>
<a class="admonition-anchor-link" href="engine/optimize/rewrite.html#admonition-warning-simple-references-only"></a>
</div>
<div>
<p>Only <em>simple variable references</em> are optimized.</p>
<p>No <a href="https://en.wikipedia.org/wiki/Common_subexpression_elimination"><em>common sub-expression elimination</em></a>
is performed by Rhai.</p>
<pre><code class="language-rust">x = x + 1;          // &lt;- this statement...

x += 1;             // &lt;- ... is rewritten to this

x[y] = x[y] + 1;    // &lt;- but this is not,
                    //    so MUCH slower...

x[y] += 1;          // &lt;- ... than this</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="eager-operator-evaluation"><a class="header" href="#eager-operator-evaluation">Eager Operator Evaluation</a></h1>
<p>Most operators are actually function calls, and those functions can be overridden, so whether they
are optimized away depends on the situation:</p>
<div id="admonition-no-external-functions" class="admonition admonish-info side wide" role="note" aria-labelledby="admonition-no-external-functions-title">
<div class="admonition-title">
<div id="admonition-no-external-functions-title">
<p>No external functions</p>
</div>
<a class="admonition-anchor-link" href="engine/optimize/op-eval.html#admonition-no-external-functions"></a>
</div>
<div>
<p>Rhai guarantees that no external function will be run, which may trigger side-effects
(unless the optimization level is <a href="engine/optimize//book/engine/optimize/index.html"><code>OptimizationLevel::Full</code></a>).</p>
</div>
</div>
<ul>
<li>
<p>if the operands are not <a href="engine/optimize//book/language/constants.html">constant</a> values, it is <strong>not</strong> optimized;</p>
</li>
<li>
<p>if the <a href="engine/optimize//book/appendix/operators.html#operators">operator</a> is <a href="engine/optimize//book/rust/operators.html">overloaded</a>, it is <strong>not</strong> optimized because the
overloading function may not be <em>pure</em> (i.e. may cause side-effects when called);</p>
</li>
<li>
<p>if the <a href="engine/optimize//book/appendix/operators.html#operators">operator</a> is not <em>built-in</em> (see list of <a href="engine/optimize//book/engine/builtin.html">built-in operators</a>), it is <strong>not</strong> optimized;</p>
</li>
<li>
<p>if the <a href="engine/optimize//book/appendix/operators.html#operators">operator</a> is a <a href="engine/optimize//book/engine/builtin.html">built-in operator</a> for a <a href="engine/optimize//book/language/values-and-types.html">standard type</a>, it is called and
replaced by a <a href="engine/optimize//book/language/constants.html">constant</a> result.</p>
</li>
</ul>
<pre><code class="language-js">// The following is most likely generated by machine.

const DECISION = 1;             // this is an integer, one of the standard types

if DECISION == 1 {              // this is optimized into 'true'
    :
} else if DECISION == 2 {       // this is optimized into 'false'
    :
} else if DECISION == 3 {       // this is optimized into 'false'
    :
} else {
    :
}

// Or an equivalent using 'switch':

switch DECISION {
    1 =&gt; ...,                   // this statement is promoted
    2 =&gt; ...,                   // this statement is eliminated
    3 =&gt; ...,                   // this statement is eliminated
    _ =&gt; ...                    // this statement is eliminated
}
</code></pre>
<h2 id="pre-evaluation-of-constant-expressions"><a class="header" href="#pre-evaluation-of-constant-expressions">Pre-Evaluation of Constant Expressions</a></h2>
<p>Because of the eager evaluation of <a href="engine/optimize//book/engine/builtin.html">operators</a> for <a href="engine/optimize//book/language/values-and-types.html">standard types</a>, many
<a href="engine/optimize//book/language/constants.html">constant</a> expressions will be evaluated and replaced by the result.</p>
<pre><code class="language-rust">let x = (1+2) * 3 - 4/5 % 6;    // will be replaced by 'let x = 9'

let y = (1 &gt; 2) || (3 &lt;= 4);    // will be replaced by 'let y = true'</code></pre>
<p>For operators that are not optimized away due to one of the above reasons, the function calls are
simply left behind.</p>
<pre><code class="language-rust">// Assume 'new_state' returns some custom type that is NOT one of the standard types.
// Also assume that the '==' operator is defined for that custom type.
const DECISION_1 = new_state(1);
const DECISION_2 = new_state(2);
const DECISION_3 = new_state(3);

if DECISION == 1 {              // NOT optimized away because the operator is not built-in
    :                           // and may cause side-effects if called!
    :
} else if DECISION == 2 {       // same here, NOT optimized away
    :
} else if DECISION == 3 {       // same here, NOT optimized away
    :
} else {
    :
}</code></pre>
<p>Alternatively, turn the optimizer to <a href="engine/optimize//book/engine/optimize/index.html"><code>OptimizationLevel::Full</code></a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="eager-function-evaluation-when-using-full-optimization-level"><a class="header" href="#eager-function-evaluation-when-using-full-optimization-level">Eager Function Evaluation When Using Full Optimization Level</a></h1>
<p>When the optimization level is <a href="engine/optimize//book/engine/optimize/index.html"><code>OptimizationLevel::Full</code></a>, the <a href="engine/optimize//book/engine/hello-world.html"><code>Engine</code></a> assumes all functions to
be <em>pure</em> and will <em>eagerly</em> evaluated all function calls with constant arguments, using the result
to replace the call.</p>
<p>This also applies to all operators (which are implemented as functions).</p>
<pre><code class="language-rust">// When compiling the following with OptimizationLevel::Full...

const DECISION = 1;
                            //    this condition is now eliminated because 'sign(DECISION) &gt; 0'
if sign(DECISION) &gt; 0       // &lt;- is a call to the 'sign' and '&gt;' functions, and they return 'true'
{
    print("hello!");        // &lt;- this block is promoted to the parent level
} else {
    print("boo!");          // &lt;- this block is eliminated because it is never reached
}

print("hello!");            // &lt;- the above is equivalent to this
                            //    ('print' and 'debug' are handled specially)</code></pre>
<div id="admonition-wont-this-be-dangerous" class="admonition admonish-danger" role="note" aria-labelledby="admonition-wont-this-be-dangerous-title">
<div class="admonition-title">
<div id="admonition-wont-this-be-dangerous-title">
<p>Won’t this be dangerous?</p>
</div>
<a class="admonition-anchor-link" href="engine/optimize/eager.html#admonition-wont-this-be-dangerous"></a>
</div>
<div>
<p>Yes! <em>Very!</em></p>
<pre><code class="language-rust">// Nuclear silo control
if launch_nukes &amp;&amp; president_okeyed {
    print("This is NOT a drill!");
    update_defcon(1);
    start_world_war(3);
    launch_all_nukes();
} else {
    print("This is a drill.  Thank you for your cooperation.");
}</code></pre>
<p>In the script above (well… as if nuclear silos will one day be controlled by Rhai scripts),
the functions <code>update_defcon</code>, <code>start_world_war</code> and <code>launch_all_nukes</code> will be evaluated
during <em>compilation</em> because they have constant arguments.</p>
<p>The <a href="engine/optimize//book/language/variables.html">variables</a> <code>launch_nukes</code> and <code>president_okeyed</code> are never checked, because the script
actually has not yet been run!  The functions are called during compilation.
This is, <em>obviously</em>, not what you want.</p>
<p><strong>Moral of the story: compile with an <a href="engine/optimize//book/engine/hello-world.html"><code>Engine</code></a> that does not have any functions registered.
Register functions <em>AFTER</em> compilation.</strong></p>
</div>
</div>
<div id="admonition-why-would-i-ever-want-to-do-this-then" class="admonition admonish-question" role="note" aria-labelledby="admonition-why-would-i-ever-want-to-do-this-then-title">
<div class="admonition-title">
<div id="admonition-why-would-i-ever-want-to-do-this-then-title">
<p>Why would I ever want to do this then?</p>
</div>
<a class="admonition-anchor-link" href="engine/optimize/eager.html#admonition-why-would-i-ever-want-to-do-this-then"></a>
</div>
<div>
<p>Good question! There are two reasons:</p>
<ul>
<li>
<p>A function call may result in cleaner code than the resultant value.
In Rust, this would have been handled via a <code>const</code> function.</p>
</li>
<li>
<p>Evaluating a value to a <a href="engine/optimize//book/rust/custom-types.html">custom type</a> that has no representation in script.</p>
</li>
</ul>
<pre><code class="language-rust">// A complex function that returns a unique ID based on the arguments
let id = make_unique_id(123, "hello", true);

// The above is arguably clearer than:
//   let id = 835781293546; // generated from 123, "hello" and true

// A custom type that cannot be represented in script
let complex_obj = make_complex_obj(42);</code></pre>
</div>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="side-effect-considerations-for-full-optimization-level"><a class="header" href="#side-effect-considerations-for-full-optimization-level">Side-Effect Considerations for Full Optimization Level</a></h1>
<p>All of Rhai’s built-in functions (and operators which are implemented as functions) are <em>pure</em>
(i.e. they do not mutate state nor cause any side-effects, with the exception of <code>print</code> and <code>debug</code>
which are handled specially) so using <a href="engine/optimize//book/engine/optimize/index.html"><code>OptimizationLevel::Full</code></a> is usually quite safe <em>unless</em>
custom types and functions are registered.</p>
<p>If custom functions are registered, they <em>may</em> be called (or maybe not, if the calls happen to lie
within a pruned code block).</p>
<p>If custom functions are registered to overload <a href="engine/optimize//book/engine/builtin.html">built-in operators</a>, they will also be called when
the operators are used (in an <a href="engine/optimize//book/language/if.html"><code>if</code></a> statement, for example), potentially causing side-effects.</p>
<div id="admonition-rule-of-thumb" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-rule-of-thumb-title">
<div class="admonition-title">
<div id="admonition-rule-of-thumb-title">
<p>Rule of thumb</p>
</div>
<a class="admonition-anchor-link" href="engine/optimize/side-effects.html#admonition-rule-of-thumb"></a>
</div>
<div>
<ul>
<li>
<p><em>Always</em> register custom types and functions <em>after</em> compiling scripts if <a href="engine/optimize//book/engine/optimize/index.html"><code>OptimizationLevel::Full</code></a> is used.</p>
</li>
<li>
<p><em>DO NOT</em> depend on knowledge that the functions have no side-effects, because those functions can change later on and,
when that happens, existing scripts may break in subtle ways.</p>
</li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="volatility-considerations-for-full-optimization-level"><a class="header" href="#volatility-considerations-for-full-optimization-level">Volatility Considerations for Full Optimization Level</a></h1>
<p>Even if a custom function does not mutate state nor cause side-effects, it may still be <em>volatile</em>,
i.e. it <em>depends</em> on external environment and does not guarantee the same result for the same inputs.</p>
<p>A perfect example is a function that gets the current time – obviously each run will return a
different value!</p>
<pre><code class="language-rust">print(get_current_time(true));      // prints the current time
                                    // notice the call to 'get_current_time'
                                    // has constant arguments

// The above, under full optimization level, is rewritten to:

print("10:25AM");                   // the function call is replaced by
                                    // its result at the time of optimization!</code></pre>
<div id="admonition-warning" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="engine/optimize/volatility.html#admonition-warning"></a>
</div>
<div>
<p><strong>Avoid using <a href="engine/optimize//book/engine/optimize/index.html"><code>OptimizationLevel::Full</code></a></strong> if volatile custom functions are involved.</p>
</div>
</div>
<p>The optimizer, when using <a href="engine/optimize//book/engine/optimize/index.html"><code>OptimizationLevel::Full</code></a>, <em>merrily assumes</em> that all functions are
<em>non-volatile</em>, so when it finds <a href="engine/optimize//book/language/constants.html">constant</a> arguments (or none) it eagerly executes the function
call and replaces it with the result.</p>
<p>This causes the script to behave differently from the intended semantics.</p>
<div id="admonition-tip-mark-a-function-as-volatile" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-mark-a-function-as-volatile-title">
<div class="admonition-title">
<div id="admonition-tip-mark-a-function-as-volatile-title">
<p>Tip: Mark a function as volatile</p>
</div>
<a class="admonition-anchor-link" href="engine/optimize/volatility.html#admonition-tip-mark-a-function-as-volatile"></a>
</div>
<div>
<p>All native functions are assumed to be <strong>non-volatile</strong>, meaning that they are eagerly called under
<a href="engine/optimize//book/engine/optimize/index.html"><code>OptimizationLevel::Full</code></a> when all arguments are <a href="engine/optimize//book/language/constants.html">constant</a> (or none).</p>
<p>It is possible to <a href="engine/optimize//book/plugins/module.html#volatile-functions">mark a function defined within a plugin module as volatile</a>
to prevent this behavior.</p>
<pre><code class="language-rust">#[export_module]
mod my_module {
    // This function is marked 'volatile' and will not be
    // eagerly executed even under OptimizationLevel::Full.
    #[rhai_fn(volatile)]
    pub get_current_time(am_pm: bool) -&gt; String {
        // ...
    }
}</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="subtle-semantic-changes-after-optimization"><a class="header" href="#subtle-semantic-changes-after-optimization">Subtle Semantic Changes After Optimization</a></h1>
<p>Some optimizations can alter subtle semantics of the script, causing the script to behave
differently when run with or without optimization.</p>
<p>Typically, this involves some form of error that may arise in the original, unoptimized script but
is optimized away by the <a href="engine/optimize//book/engine/optimize/index.html">script optimizer</a>.</p>
<div id="admonition-do-not-depend-on-runtime-errors" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-do-not-depend-on-runtime-errors-title">
<div class="admonition-title">
<div id="admonition-do-not-depend-on-runtime-errors-title">
<p>DO NOT depend on runtime errors</p>
</div>
<a class="admonition-anchor-link" href="engine/optimize/semantics.html#admonition-do-not-depend-on-runtime-errors"></a>
</div>
<div>
<p>Needless to say, it is usually a <em>Very Bad Idea™</em> to depend on a script failing with a runtime error
or such kind of subtleties.</p>
<p>If it turns out to be necessary (why? I would never guess), turn script optimization off by setting
the optimization level to <a href="engine/optimize//book/engine/optimize/index.html"><code>OptimizationLevel::None</code></a>.</p>
</div>
</div>
<h2 id="disappearing-runtime-errors"><a class="header" href="#disappearing-runtime-errors">Disappearing Runtime Errors</a></h2>
<p>For example:</p>
<pre><code class="language-rust">if true {           // condition always true
    123.456;        // eliminated
    hello;          // eliminated, EVEN THOUGH the variable doesn't exist!
    foo(42)         // promoted up-level
}

foo(42)             // &lt;- the above optimizes to this</code></pre>
<p>If the original script were evaluated instead, it would have been an error –
the variable <code>hello</code> does not exist, so the script would have been terminated at that point
with a runtime error.</p>
<p>In fact, any errors inside a statement that has been eliminated will silently <em>disappear</em>.</p>
<pre><code class="language-rust">print("start!");
if my_decision { /* do nothing... */ }  // eliminated due to no effect
print("end!");

// The above optimizes to:

print("start!");
print("end!");</code></pre>
<p>In the script above, if <code>my_decision</code> holds anything other than a boolean value,
the script should have been terminated due to a type error.</p>
<p>However, after optimization, the entire <a href="engine/optimize//book/language/if.html"><code>if</code></a> statement is removed (because an access to
<code>my_decision</code> produces no side-effects), thus the script silently runs to completion without errors.</p>
<h2 id="eliminated-useless-work"><a class="header" href="#eliminated-useless-work">Eliminated Useless Work</a></h2>
<p>Another example is more subtle – that of an empty loop body.</p>
<pre><code class="language-rust">// ... say, the 'Engine' is limited to no more than 10,000 operations...

// The following should fail because it exceeds the operations limit:
for n in 0..42000 {
    // empty loop
}

// The above is optimized away because the loop body is empty
// and the iterations simply do nothing.
()</code></pre>
<p>Normally, and empty loop body inside a <a href="engine/optimize//book/language/for.html"><code>for</code></a> statement with a pure iterator does nothing and can
be safely eliminated.</p>
<p>Thus the script now runs silently to completion without errors.</p>
<p>Without optimization, the script may fail by exceeding the <a href="engine/optimize//book/safety/max-operations.html">maximum number of operations</a> allowed.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="re-optimize-an-ast"><a class="header" href="#re-optimize-an-ast">Re-Optimize an AST</a></h1>
<p>Sometimes it is more efficient to store one single, large script with delimited code blocks guarded by
constant variables.  This script is compiled once to an <a href="engine/optimize//book/engine/compile.html"><code>AST</code></a>.</p>
<p>Then, depending on the execution environment, constants are passed into the <a href="engine/optimize//book/engine/hello-world.html"><code>Engine</code></a> and the
<a href="engine/optimize//book/engine/compile.html"><code>AST</code></a> is <em>re</em>-optimized based on those constants via <code>Engine::optimize_ast</code>, effectively pruning
out unused code sections.</p>
<p>The final, optimized <a href="engine/optimize//book/engine/compile.html"><code>AST</code></a> is then used for evaluations.</p>
<pre><code class="language-rust">// Compile master script to AST
let master_ast = engine.compile(
"
    fn do_work() {
        // Constants in scope are also propagated into functions
        print(SCENARIO);
    }

    switch SCENARIO {
        1 =&gt; do_work(),
        2 =&gt; do_something(),
        3 =&gt; do_something_else(),
        _ =&gt; do_nothing()
    }
")?;

for n in 0..5_i64 {
    // Create a new scope - put constants in it to aid optimization
    let mut scope = Scope::new();
    scope.push_constant("SCENARIO", n);

    // Re-optimize the AST
    let new_ast = engine.optimize_ast(&amp;scope, master_ast.clone(), OptimizationLevel::Simple);

    // Run it
    engine.run_ast(&amp;new_ast)?;
}</code></pre>
<div id="admonition-constants-propagation" class="admonition admonish-note small" role="note" aria-labelledby="admonition-constants-propagation-title">
<div class="admonition-title">
<div id="admonition-constants-propagation-title">
<p>Constants propagation</p>
</div>
<a class="admonition-anchor-link" href="engine/optimize/reoptimize.html#admonition-constants-propagation"></a>
</div>
<div>
<p>Beware that <a href="engine/optimize//book/language/constants.html">constants</a> inside the custom <a href="engine/optimize//book/engine/scope.html"><code>Scope</code></a> will also be propagated to <a href="engine/optimize//book/language/functions.html">functions</a> defined
within the script while normally such <a href="engine/optimize//book/language/functions.html">functions</a> are <em>pure</em> and cannot see <a href="engine/optimize//book/language/variables.html">variables</a>/<a href="engine/optimize//book/language/constants.html">constants</a>
within the global <a href="engine/optimize//book/engine/scope.html"><code>Scope</code></a>.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="manage-asts"><a class="header" href="#manage-asts">Manage <code>AST</code>’s</a></h1>
<p>When compiling a Rhai script to an <a href="engine//book/engine/compile.html"><code>AST</code></a>, the following data are packaged together as a single unit:</p>
<div class="table-wrapper"><table><thead><tr><th>Data</th><th style="text-align: center">Type</th><th>Description</th><th style="text-align: center">Requires feature</th><th style="text-align: center">Access API</th></tr></thead><tbody>
<tr><td>Source name</td><td style="text-align: center"><a href="engine//book/rust/immutable-string.html"><code>ImmutableString</code></a></td><td>optional text name to identify the source of the script</td><td style="text-align: center"></td><td style="text-align: center"><code>source(&amp;self)</code>,<br/><code>clone_source(&amp;self)</code>,<br/><code>set_source(&amp;mut self, source)</code>,<br/><code>clear_source(&amp;mut self)</code></td></tr>
<tr><td><a href="engine//book/language/comments.html">Module documentation</a></td><td style="text-align: center"><a href="https://crates.io/crates/smartstring"><code>Vec&lt;SmartString&gt;</code></a></td><td>documentation of the script</td><td style="text-align: center"><a href="engine//book/start/features.html"><code>metadata</code></a></td><td style="text-align: center"><code>doc(&amp;self)</code>,<br/><code>clear_doc(&amp;mut self)</code></td></tr>
<tr><td>Statements</td><td style="text-align: center"><code>Vec&lt;Stmt&gt;</code></td><td>list of script statements at global level</td><td style="text-align: center"><a href="engine//book/start/features.html"><code>internals</code></a></td><td style="text-align: center"><code>statements(&amp;self)</code>,<br/><code>statements_mut(&amp;mut self)</code></td></tr>
<tr><td>Functions</td><td style="text-align: center"><a href="engine//book/rust/modules/index.html"><code>Shared&lt;Module&gt;</code></a></td><td><a href="engine//book/language/functions.html">functions</a> defined in the script</td><td style="text-align: center"><a href="engine//book/start/features.html"><code>internals</code></a>,<br/>not <a href="engine//book/start/features.html"><code>no_function</code></a></td><td style="text-align: center"><code>shared_lib(&amp;self)</code></td></tr>
<tr><td>Embedded <a href="engine//book/rust/modules/resolvers/index.html">module resolver</a></td><td style="text-align: center"><a href="engine//book/rust/modules/resolvers/index.html"><code>StaticModuleResolver</code></a></td><td>embedded <a href="engine//book/rust/modules/resolvers/index.html">module resolver</a> for <a href="engine//book/rust/modules/self-contained.html">self-contained <code>AST</code></a></td><td style="text-align: center"><a href="engine//book/start/features.html"><code>internals</code></a>,<br/>not <a href="engine//book/start/features.html"><code>no_module</code></a></td><td style="text-align: center"><code>resolver(&amp;self)</code></td></tr>
</tbody></table>
</div>
<p>Most of the <a href="engine//book/engine/compile.html"><code>AST</code></a> API is available only under the <a href="engine//book/start/features.html"><code>internals</code></a> feature.</p>
<div id="admonition-tip-source-name" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-source-name-title">
<div class="admonition-title">
<div id="admonition-tip-source-name-title">
<p>Tip: Source name</p>
</div>
<a class="admonition-anchor-link" href="engine/ast.html#admonition-tip-source-name"></a>
</div>
<div>
<p>Use the source name to identify the source script in errors – useful when multiple <a href="engine//book/rust/modules/index.html">modules</a>
are imported recursively.</p>
</div>
</div>
<div id="admonition-ast-public-api" class="admonition admonish-info small" role="note" aria-labelledby="admonition-ast-public-api-title">
<div class="admonition-title">
<div id="admonition-ast-public-api-title">
<p><code>AST</code> public API</p>
</div>
<a class="admonition-anchor-link" href="engine/ast.html#admonition-ast-public-api"></a>
</div>
<div>
<p>For the complete <a href="engine//book/engine/compile.html"><code>AST</code></a> API, refer to the <a href="https://docs.rs/rhai/1.22.0/rhai/struct.AST.html">documentation</a> online.</p>
</div>
</div>
<h2 id="extract-only-functions"><a class="header" href="#extract-only-functions">Extract Only Functions</a></h2>
<p>The following methods, not available under <a href="engine//book/start/features.html"><code>no_function</code></a>, allow manipulation of the <a href="engine//book/language/functions.html">functions</a>
encapsulated within an <a href="engine//book/engine/compile.html"><code>AST</code></a>:</p>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody>
<tr><td><code>clone_functions_only(&amp;self)</code></td><td>clone the <a href="engine//book/engine/compile.html"><code>AST</code></a> into a new <a href="engine//book/engine/compile.html"><code>AST</code></a> with only <a href="engine//book/language/functions.html">functions</a>, excluding statements</td></tr>
<tr><td><code>clone_functions_only_filtered(&amp;self, filter)</code></td><td>clone the <a href="engine//book/engine/compile.html"><code>AST</code></a> into a new <a href="engine//book/engine/compile.html"><code>AST</code></a> with only <a href="engine//book/language/functions.html">functions</a> that pass the filter predicate, excluding statements</td></tr>
<tr><td><code>retain_functions(&amp;mut self, filter)</code></td><td>remove all <a href="engine//book/language/functions.html">functions</a> in the <a href="engine//book/engine/compile.html"><code>AST</code></a> that do not pass a particular predicate filter; statements are untouched</td></tr>
<tr><td><code>iter_functions(&amp;self)</code></td><td>return an iterator on all the <a href="engine//book/language/functions.html">functions</a> in the <a href="engine//book/engine/compile.html"><code>AST</code></a></td></tr>
<tr><td><code>clear_functions(&amp;mut self)</code></td><td>remove all <a href="engine//book/language/functions.html">functions</a> from the <a href="engine//book/engine/compile.html"><code>AST</code></a>, leaving only statements</td></tr>
</tbody></table>
</div>
<h2 id="extract-only-statements"><a class="header" href="#extract-only-statements">Extract Only Statements</a></h2>
<p>The following methods allow manipulation of the statements in an <a href="engine//book/engine/compile.html"><code>AST</code></a>:</p>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody>
<tr><td><code>clone_statements_only(&amp;self)</code></td><td>clone the <a href="engine//book/engine/compile.html"><code>AST</code></a> into a new <a href="engine//book/engine/compile.html"><code>AST</code></a> with only the statements, excluding <a href="engine//book/language/functions.html">functions</a></td></tr>
<tr><td><code>clear_statements(&amp;mut self)</code></td><td>remove all statements from the <a href="engine//book/engine/compile.html"><code>AST</code></a>, leaving only <a href="engine//book/language/functions.html">functions</a></td></tr>
<tr><td><code>iter_literal_variables(&amp;self, constants, variables)</code></td><td>return an iterator on all top-level literal constant and/or variable definitions in the <a href="engine//book/engine/compile.html"><code>AST</code></a></td></tr>
</tbody></table>
</div>
<h2 id="merge-and-combine-asts"><a class="header" href="#merge-and-combine-asts">Merge and Combine AST’s</a></h2>
<p>The following methods merge one <a href="engine//book/engine/compile.html"><code>AST</code></a> with another:</p>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody>
<tr><td><code>merge(&amp;self, &amp;ast)</code>,<br /><code>+</code> operator</td><td>append the second <a href="engine//book/engine/compile.html"><code>AST</code></a> to this <a href="engine//book/engine/compile.html"><code>AST</code></a>, yielding a new <a href="engine//book/engine/compile.html"><code>AST</code></a> that is a combination of the two; statements are simply appended, <a href="engine//book/language/functions.html">functions</a> in the second <a href="engine//book/engine/compile.html"><code>AST</code></a> of the same name and arity override similar <a href="engine//book/language/functions.html">functions</a> in this <a href="engine//book/engine/compile.html"><code>AST</code></a></td></tr>
<tr><td><code>merge_filtered(&amp;self, &amp;ast, filter)</code></td><td>append the second <a href="engine//book/engine/compile.html"><code>AST</code></a> (but only <a href="engine//book/language/functions.html">functions</a> that pass the predicate filter) to this <a href="engine//book/engine/compile.html"><code>AST</code></a>, yielding a new <a href="engine//book/engine/compile.html"><code>AST</code></a> that is a combination of the two; statements are simply appended, <a href="engine//book/language/functions.html">functions</a> in the second <a href="engine//book/engine/compile.html"><code>AST</code></a> of the same name and arity override similar <a href="engine//book/language/functions.html">functions</a> in this <a href="engine//book/engine/compile.html"><code>AST</code></a></td></tr>
<tr><td><code>combine(&amp;mut self, ast)</code>,<br /><code>+=</code> operator</td><td>append the second <a href="engine//book/engine/compile.html"><code>AST</code></a> to this <a href="engine//book/engine/compile.html"><code>AST</code></a>; statements are simply appended, <a href="engine//book/language/functions.html">functions</a> in the second <a href="engine//book/engine/compile.html"><code>AST</code></a> of the same name and arity override similar <a href="engine//book/language/functions.html">functions</a> in this <a href="engine//book/engine/compile.html"><code>AST</code></a></td></tr>
<tr><td><code>combine_filtered(&amp;mut self, ast, filter)</code></td><td>append the second <a href="engine//book/engine/compile.html"><code>AST</code></a> (but only <a href="engine//book/language/functions.html">functions</a> that pass the predicate filter) to this <a href="engine//book/engine/compile.html"><code>AST</code></a>; statements are simply appended, <a href="engine//book/language/functions.html">functions</a> in the second <a href="engine//book/engine/compile.html"><code>AST</code></a> of the same name and arity override similar <a href="engine//book/language/functions.html">functions</a> in this <a href="engine//book/engine/compile.html"><code>AST</code></a></td></tr>
</tbody></table>
</div>
<p>When statements are appended, beware that this may change the semantics of the script.</p>
<pre><code class="language-rust">// First script
let ast1 = engine.compile(
"
     fn foo(x) { 42 + x }
     foo(1)
")?;

// Second script
let ast2 = engine.compile(
"
     fn foo(n) { `hello${n}` }
     foo("!")
")?;

// Merge them
let merged = ast1.merge(&amp;ast2);

// Notice that using the '+' operator also works:
let merged = &amp;ast1 + &amp;ast2;</code></pre>
<p><code>merged</code> in the above example essentially contains the following script program:</p>
<pre><code class="language-js">fn foo(n) { `hello${n}` }   // &lt;- definition of first 'foo' is overwritten
foo(1)                      // &lt;- notice this will be "hello1" instead of 43,
                            //    but it is no longer the return value
foo("!")                    // &lt;- returns "hello!"
</code></pre>
<h2 id="walk-an-ast"><a class="header" href="#walk-an-ast">Walk an AST</a></h2>
<p>The <a href="engine//book/start/features.html"><code>internals</code></a> feature allows access to internal Rhai data structures, particularly the nodes
that make up the <a href="engine//book/engine/compile.html"><code>AST</code></a>.</p>
<h3 id="ast-node-types"><a class="header" href="#ast-node-types">AST node types</a></h3>
<p>There are a few useful types when walking an <a href="engine//book/engine/compile.html"><code>AST</code></a>:</p>
<div class="table-wrapper"><table><thead><tr><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>ASTNode</code></td><td>an <code>enum</code> with two variants: <code>Expr</code> or <code>Stmt</code></td></tr>
<tr><td><code>Expr</code></td><td>an <em>expression</em></td></tr>
<tr><td><code>Stmt</code></td><td>a <em>statement</em></td></tr>
<tr><td><code>BinaryExpr</code></td><td>a sub-type containing the LHS and RHS of a binary expression</td></tr>
<tr><td><code>FnCallExpr</code></td><td>a sub-type containing information on a function call</td></tr>
<tr><td><code>CustomExpr</code></td><td>a sub-type containing information on a <a href="engine//book/engine/custom-syntax.html">custom syntax</a> expression</td></tr>
</tbody></table>
</div>
<p>The <code>AST::walk</code> method takes a callback function and recursively walks the <a href="engine//book/engine/compile.html"><code>AST</code></a> in depth-first
manner, with the parent node visited before its children.</p>
<h3 id="callback-function-signature"><a class="header" href="#callback-function-signature">Callback function signature</a></h3>
<p>The signature of the callback function takes the following form.</p>
<blockquote>
<pre><code class="language-rust">FnMut(&amp;[ASTNode]) -&gt; bool</code></pre>
</blockquote>
<p>The single argument passed to the method contains a slice of <code>ASTNode</code> types representing the path
from the current node to the root of the <a href="engine//book/engine/compile.html"><code>AST</code></a>.</p>
<p>Return <code>true</code> to continue walking the <a href="engine//book/engine/compile.html"><code>AST</code></a>, or <code>false</code> to terminate.</p>
<h3 id="children-visit-order"><a class="header" href="#children-visit-order">Children visit order</a></h3>
<p>The order of visits to the children of each node type:</p>
<div class="table-wrapper"><table><thead><tr><th>Node type</th><th>Children visit order</th></tr></thead><tbody>
<tr><td><a href="engine//book/language/if.html"><code>if</code></a> statement</td><td><ol><li>condition expression</li><li><em>then</em> statements</li><li><em>else</em> statements (if any)</li></ol></td></tr>
<tr><td><a href="engine//book/language/switch.html"><code>switch</code></a> statement</td><td><ol><li>match element</li><li>each of the case conditions and statements, in order</li><li>each of the range conditions and statements, in order</li><li>default statements (if any)</li></ol></td></tr>
<tr><td><a href="engine//book/language/while.html"><code>while</code></a>, <a href="engine//book/language/do.html"><code>do</code></a>, <a href="engine//book/language/loop.html"><code>loop</code></a> statement</td><td><ol><li>condition expression</li><li>statements body</li></ol></td></tr>
<tr><td><a href="engine//book/language/for.html"><code>for</code></a> statement</td><td><ol><li>collection expression</li><li>statements body</li></ol></td></tr>
<tr><td><a href="engine//book/language/return.html"><code>return</code></a> statement</td><td>return value expression</td></tr>
<tr><td><a href="engine//book/language/throw.html"><code>throw</code></a> statement</td><td>exception value expression</td></tr>
<tr><td><a href="engine//book/language/throw.html"><code>try</code> … <code>catch</code></a> statement</td><td><ol><li><code>try</code> statements body</li><li><code>catch</code> statements body</li></ol></td></tr>
<tr><td><a href="engine//book/language/modules/import.html"><code>import</code></a> statement</td><td>path expression</td></tr>
<tr><td><a href="engine//book/language/arrays.html">Array</a> literal</td><td>each of the element expressions, in order</td></tr>
<tr><td><a href="engine//book/language/object-maps.html">Object map</a> literal</td><td>each of the element expressions, in order</td></tr>
<tr><td>Interpolated <a href="engine//book/language/strings-chars.html">string</a></td><td>each of the <a href="engine//book/language/strings-chars.html">string</a>/expression segments, in order</td></tr>
<tr><td>Indexing</td><td><ol><li>LHS expression</li><li>RHS (index) expression</li></ol></td></tr>
<tr><td>Field access/method call</td><td><ol><li>LHS expression</li><li>RHS expression</li></ol></td></tr>
<tr><td><code>&amp;&amp;</code>, <code>||</code>, <code>??</code></td><td><ol><li>LHS expression</li><li>RHS expression</li></ol></td></tr>
<tr><td><a href="engine//book/language/functions.html">Function</a> call, <a href="engine//book/appendix/operators.html#operators">operator</a> expression</td><td>each of the argument expressions, in order</td></tr>
<tr><td><a href="engine//book/language/variables.html"><code>let</code></a>, <a href="engine//book/language/constants.html"><code>const</code></a> statement</td><td>value expression</td></tr>
<tr><td>Assignment statement</td><td><ol><li>l-value expression</li><li>value expression</li></ol></td></tr>
<tr><td>Statements block</td><td>each of the statements, in order</td></tr>
<tr><td>Custom syntax expression</td><td>each of the inputs stream, in order</td></tr>
<tr><td>All others</td><td>single child (if any)</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="use-the-low-level-api-to-register-a-rust-function"><a class="header" href="#use-the-low-level-api-to-register-a-rust-function">Use the Low-Level API to Register a Rust Function</a></h1>
<p>When a native Rust function is registered with an <a href="rust//book/engine/hello-world.html"><code>Engine</code></a> using the <code>register_XXX</code> API, Rhai
transparently converts all function arguments from <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> into the correct types before calling
the function.</p>
<p>For more power and flexibility, there is a <em>low-level</em> API to work directly with <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> values
without the conversions.</p>
<h2 id="raw-function-registration"><a class="header" href="#raw-function-registration">Raw Function Registration</a></h2>
<p>The <code>Engine::register_raw_fn</code> method is marked <em>volatile</em>, meaning that it may be changed without warning.</p>
<p>If this is acceptable, then using this method to register a Rust function opens up more opportunities.</p>
<pre><code class="language-rust">engine.register_raw_fn(
    "increment_by",                                         // function name
    &amp;[                                                      // a slice containing parameter types
        std::any::TypeId::of::&lt;i64&gt;(),                      // type of first parameter
        std::any::TypeId::of::&lt;i64&gt;()                       // type of second parameter
    ],
    |context, args| {                                       // fixed function signature
        // Arguments are guaranteed to be correct in number and of the correct types.

        // But remember this is Rust, so you can keep only one mutable reference at any one time!
        // Therefore, get a '&amp;mut' reference to the first argument _last_.
        // Alternatively, use `args.split_first_mut()` etc. to split the slice first.

        let y = *args[1].read_lock::&lt;i64&gt;().unwrap();       // get a reference to the second argument
                                                            // then copy it because it is a primary type

        let y = args[1].take().cast::&lt;i64&gt;();               // alternatively, directly 'consume' it

        let y = args[1].as_int().unwrap();                  // alternatively, use 'as_xxx()'

        let x = args[0].write_lock::&lt;i64&gt;().unwrap();       // get a '&amp;mut' reference to the first argument

        *x += y;                                            // perform the action

        Ok(Dynamic::UNIT)                                   // must be 'Result&lt;Dynamic, Box&lt;EvalAltResult&gt;&gt;'
    }
);

// The above is the same as (in fact, internally they are equivalent):

engine.register_fn("increment_by", |x: &amp;mut i64, y: i64| *x += y);</code></pre>
<h2 id="function-signature-4"><a class="header" href="#function-signature-4">Function Signature</a></h2>
<p>The function signature passed to <code>Engine::register_raw_fn</code> takes the following form.</p>
<blockquote>
<pre><code class="language-rust">Fn(context: NativeCallContext, args: &amp;mut [&amp;mut Dynamic]) -&gt; Result&lt;T, Box&lt;EvalAltResult&gt;&gt;</code></pre>
</blockquote>
<p>where:</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th style="text-align: center">Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>T</code></td><td style="text-align: center"><code>impl Clone</code></td><td>return type of the function</td></tr>
<tr><td><code>context</code></td><td style="text-align: center"><a href="rust//book/rust/context.html"><code>NativeCallContext</code></a></td><td>the current <em>native call context</em>, useful for recursively calling functions on the same <a href="rust//book/engine/hello-world.html"><code>Engine</code></a></td></tr>
<tr><td><code>args</code></td><td style="text-align: center"><code>&amp;mut [&amp;mut Dynamic]</code></td><td>a slice containing <code>&amp;mut</code> references to <a href="rust//book/language/dynamic.html"><code>Dynamic</code></a> values.<br/>The slice is guaranteed to contain enough arguments <em>of the correct types</em>.</td></tr>
</tbody></table>
</div>
<h3 id="return-value-6"><a class="header" href="#return-value-6">Return value</a></h3>
<p>The return value is the result of the function call.</p>
<p>Remember, in Rhai, all arguments <em>except</em> the <em>first</em> one are always passed by <em>value</em> (i.e. cloned).
Therefore, it is unnecessary to ever mutate any argument except the first one, as all mutations
will be on the cloned copy.</p>
<h2 id="extract-the-first-mut-argument-if-any"><a class="header" href="#extract-the-first-mut-argument-if-any">Extract The First <code>&amp;mut</code> Argument (If Any)</a></h2>
<p>To extract the first <code>&amp;mut</code> argument passed by reference from the <code>args</code> parameter (<code>&amp;mut [&amp;mut Dynamic]</code>),
use the following to get a mutable reference to the underlying value:</p>
<pre><code class="language-rust">let value: &amp;mut T = &amp;mut *args[0].write_lock::&lt;T&gt;().unwrap();

*value = ...    // overwrite the existing value of the first `&amp;mut` parameter</code></pre>
<p>When there is a mutable reference to the first <code>&amp;mut</code> argument, there can be no other immutable
references to <code>args</code>, otherwise the Rust borrow checker will complain.</p>
<p>Therefore, always extract the mutable reference last, <em>after</em> all other arguments are taken.</p>
<h2 id="extract-other-pass-by-value-arguments"><a class="header" href="#extract-other-pass-by-value-arguments">Extract Other Pass-By-Value Arguments</a></h2>
<p>To extract an argument passed by value from the <code>args</code> parameter (<code>&amp;mut [&amp;mut Dynamic]</code>), use the following statements.</p>
<div class="table-wrapper"><table><thead><tr><th>Argument type</th><th>Access statement (<code>n</code> = argument position)</th><th style="text-align: center">Result</th><th style="text-align: center">Original value</th></tr></thead><tbody>
<tr><td><code>INT</code></td><td><code>args[n].as_int().unwrap()</code></td><td style="text-align: center"><code>INT</code></td><td style="text-align: center">untouched</td></tr>
<tr><td><code>FLOAT</code></td><td><code>args[n].as_float().unwrap()</code></td><td style="text-align: center"><code>FLOAT</code></td><td style="text-align: center">untouched</td></tr>
<tr><td><a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a></td><td><code>args[n].as_decimal().unwrap()</code></td><td style="text-align: center"><a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a></td><td style="text-align: center">untouched</td></tr>
<tr><td><code>bool</code></td><td><code>args[n].as_bool().unwrap()</code></td><td style="text-align: center"><code>bool</code></td><td style="text-align: center">untouched</td></tr>
<tr><td><code>char</code></td><td><code>args[n].as_char().unwrap()</code></td><td style="text-align: center"><code>char</code></td><td style="text-align: center">untouched</td></tr>
<tr><td><code>()</code></td><td><code>args[n].as_unit().unwrap()</code></td><td style="text-align: center"><code>()</code></td><td style="text-align: center">untouched</td></tr>
<tr><td><a href="rust//book/language/strings-chars.html">String</a></td><td><code>&amp;*args[n].as_immutable_string_ref().unwrap()</code></td><td style="text-align: center"><a href="rust//book/rust/immutable-string.html"><code>&amp;ImmutableString</code></a></td><td style="text-align: center">untouched</td></tr>
<tr><td><a href="rust//book/language/strings-chars.html">String</a> (consumed)</td><td><code>args[n].take().cast::&lt;ImmutableString&gt;()</code></td><td style="text-align: center"><a href="rust//book/rust/immutable-string.html"><code>ImmutableString</code></a></td><td style="text-align: center"><a href="rust//book/language/values-and-types.html"><code>()</code></a></td></tr>
<tr><td>Others</td><td><code>&amp;*args[n].read_lock::&lt;T&gt;().unwrap()</code></td><td style="text-align: center"><code>&amp;T</code></td><td style="text-align: center">untouched</td></tr>
<tr><td>Others (consumed)</td><td><code>args[n].take().cast::&lt;T&gt;()</code></td><td style="text-align: center"><code>T</code></td><td style="text-align: center"><a href="rust//book/language/values-and-types.html"><code>()</code></a></td></tr>
</tbody></table>
</div>
<h2 id="example--pass-a-callback-to-a-rust-function"><a class="header" href="#example--pass-a-callback-to-a-rust-function">Example – Pass a Callback to a Rust Function</a></h2>
<p>The low-level API is useful when there is a need to interact with the scripting <a href="rust//book/engine/hello-world.html"><code>Engine</code></a>
within a function.</p>
<p>The following example registers a function that takes a <a href="rust//book/language/fn-ptr.html">function pointer</a> as an argument,
then calls it within the same <a href="rust//book/engine/hello-world.html"><code>Engine</code></a>.  This way, a <em>callback</em> function can be provided
to a native Rust function.</p>
<p>The example also showcases the use of <code>FnPtr::call_raw</code>, a low-level API which allows binding the
<code>this</code> pointer to the function pointer call.</p>
<pre><code class="language-rust">use rhai::{Engine, FnPtr};

let mut engine = Engine::new();

// Register a Rust function
engine.register_raw_fn(
    "bar",
    &amp;[
        std::any::TypeId::of::&lt;i64&gt;(),                      // parameter types
        std::any::TypeId::of::&lt;FnPtr&gt;(),
        std::any::TypeId::of::&lt;i64&gt;(),
    ],
    |context, args| {
        // 'args' is guaranteed to contain enough arguments of the correct types

        let fp = args[1].take().cast::&lt;FnPtr&gt;();            // 2nd argument - function pointer
        let value = args[2].take();                         // 3rd argument - function argument

        // The 1st argument holds the 'this' pointer.
        // This should be done last as it gets a mutable reference to 'args'.
        let this_ptr = args.get_mut(0).unwrap();

        // Use 'FnPtr::call_raw' to call the function pointer with the context
        // while also binding the 'this' pointer!
        fp.call_raw(&amp;context, Some(this_ptr), [value])
    },
);

let result = engine.eval::&lt;i64&gt;(
r#"
    fn foo(x) { this += x; }        // script-defined function 'foo'

    let x = 41;                     // object
    x.bar(foo, 1);                  // pass 'foo' as function pointer
    x
"#)?;</code></pre>
<div id="admonition-tip-hold-multiple-references" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-hold-multiple-references-title">
<div class="admonition-title">
<div id="admonition-tip-hold-multiple-references-title">
<p>Tip: Hold multiple references</p>
</div>
<a class="admonition-anchor-link" href="rust/register-raw.html#admonition-tip-hold-multiple-references"></a>
</div>
<div>
<p>In order to access a value argument that is expensive to clone <em>while</em> holding a mutable reference
to the first argument, use one of the following tactics:</p>
<ol>
<li>
<p>If it is a <a href="rust//book/language/values-and-types.html">primary type</a> other than <a href="rust//book/language/strings-chars.html">string</a>, use <code>as_xxx()</code> as above;</p>
</li>
<li>
<p>Directly <em>consume</em> that argument via <code>arg[i].take()</code> as above.</p>
</li>
<li>
<p>Use <code>split_first_mut</code> to partition the slice:</p>
</li>
</ol>
<pre><code class="language-rust">// Partition the slice
let (first, rest) = args.split_first_mut().unwrap();

// Mutable reference to the first parameter, of type '&amp;mut A'
let this_ptr = &amp;mut *first.write_lock::&lt;A&gt;().unwrap();

// Immutable reference to the second value parameter, of type '&amp;B'
// This can be mutable but there is no point because the parameter is passed by value
let value_ref = &amp;*rest[0].read_lock::&lt;B&gt;().unwrap();</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="evalcontext"><a class="header" href="#evalcontext"><code>EvalContext</code></a></h1>
<p>Many functions in advanced APIs contain a parameter of type <code>EvalContext</code> in order to allow the
current evaluation state to be accessed and/or modified.</p>
<p><code>EvalContext</code> encapsulates the current <em>evaluation context</em> and exposes the following methods.</p>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th style="text-align: center">Return type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>scope()</code></td><td style="text-align: center"><a href="engine//book/engine/scope.html"><code>&amp;Scope</code></a></td><td>reference to the current <a href="engine//book/engine/scope.html"><code>Scope</code></a></td></tr>
<tr><td><code>scope_mut()</code></td><td style="text-align: center"><a href="engine//book/engine/scope.html"><code>&amp;mut Scope</code></a></td><td>mutable reference to the current <a href="engine//book/engine/scope.html"><code>Scope</code></a>; <a href="engine//book/language/variables.html">variables</a> can be added to/removed from it</td></tr>
<tr><td><code>engine()</code></td><td style="text-align: center"><a href="engine//book/engine/hello-world.html"><code>&amp;Engine</code></a></td><td>reference to the current <a href="engine//book/engine/hello-world.html"><code>Engine</code></a></td></tr>
<tr><td><code>source()</code></td><td style="text-align: center"><code>Option&lt;&amp;str&gt;</code></td><td>reference to the current source, if any</td></tr>
<tr><td><code>tag()</code></td><td style="text-align: center"><a href="engine//book/language/dynamic.html"><code>&amp;Dynamic</code></a></td><td>reference to the custom state that is persistent during the current run</td></tr>
<tr><td><code>tag_mut()</code></td><td style="text-align: center"><a href="engine//book/language/dynamic.html"><code>&amp;mut Dynamic</code></a></td><td>mutable reference to the custom state that is persistent during the current run</td></tr>
<tr><td><code>iter_imports()</code></td><td style="text-align: center"><code>impl Iterator&lt;Item = (&amp;str,</code><a href="engine//book/rust/modules/index.html"><code>&amp;Module</code></a><code>)&gt;</code></td><td>iterator of the current stack of <a href="engine//book/rust/modules/index.html">modules</a> imported via <a href="engine//book/language/modules/import.html"><code>import</code></a> statements, in reverse order (i.e. later <a href="engine//book/rust/modules/index.html">modules</a> come first); not available under <a href="engine//book/start/features.html"><code>no_module</code></a></td></tr>
<tr><td><code>global_runtime_state()</code></td><td style="text-align: center"><a href="https://docs.rs/rhai/1.22.0/rhai/struct.GlobalRuntimeState.html"><code>&amp;GlobalRuntimeState</code></a></td><td>reference to the current <a href="https://docs.rs/rhai/1.22.0/rhai/struct.GlobalRuntimeState.html">global runtime state</a> (including the stack of <a href="engine//book/rust/modules/index.html">modules</a> imported via <a href="engine//book/language/modules/import.html"><code>import</code></a> statements)</td></tr>
<tr><td><code>global_runtime_state_mut()</code></td><td style="text-align: center"><a href="https://docs.rs/rhai/1.22.0/rhai/struct.GlobalRuntimeState.html"><code>&amp;mut &amp;mut GlobalRuntimeState</code></a></td><td>mutable reference to the current <a href="https://docs.rs/rhai/1.22.0/rhai/struct.GlobalRuntimeState.html">global runtime state</a>; use this to access the <a href="engine//book/engine/debugging/debugger.html"><code>debugger</code></a> field in order to set/clear <a href="engine//book/engine/debugging/break-points.html">break-points</a></td></tr>
<tr><td><code>iter_namespaces()</code></td><td style="text-align: center"><code>impl Iterator&lt;Item =</code><a href="engine//book/rust/modules/index.html"><code>&amp;Module</code></a><code>&gt;</code></td><td>iterator of the <a href="engine//book/language/fn-namespaces.html">namespaces</a> (as <a href="engine//book/rust/modules/index.html">modules</a>) containing all script-defined <a href="engine//book/language/functions.html">functions</a>, in reverse order (i.e. later <a href="engine//book/rust/modules/index.html">modules</a> come first)</td></tr>
<tr><td><code>namespaces()</code></td><td style="text-align: center"><a href="engine//book/rust/modules/index.html"><code>&amp;[&amp;Module]</code></a></td><td>reference to the <a href="engine//book/language/fn-namespaces.html">namespaces</a> (as <a href="engine//book/rust/modules/index.html">modules</a>) containing all script-defined <a href="engine//book/language/functions.html">functions</a></td></tr>
<tr><td><code>this_ptr()</code></td><td style="text-align: center"><a href="engine//book/language/dynamic.html"><code>Option&lt;&amp;Dynamic&gt;</code></a></td><td>reference to the current bound <code>this</code> pointer, if any</td></tr>
<tr><td><code>this_ptr_mut()</code></td><td style="text-align: center"><a href="engine//book/language/dynamic.html"><code>&amp;mut Option&lt;&amp;mut Dynamic&gt;</code></a></td><td>mutable reference to the current bound <code>this</code> pointer, if any</td></tr>
<tr><td><code>call_level()</code></td><td style="text-align: center"><code>usize</code></td><td>the current nesting level of <a href="engine//book/language/functions.html">function</a> calls</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="call-a-function-within-the-callers-scope"><a class="header" href="#call-a-function-within-the-callers-scope">Call a Function Within the Caller’s Scope</a></h1>
<h2 id="peeking-out-of-the-pure-box"><a class="header" href="#peeking-out-of-the-pure-box">Peeking Out of The Pure Box</a></h2>
<div id="admonition-only-scripts" class="admonition admonish-info side" role="note" aria-labelledby="admonition-only-scripts-title">
<div class="admonition-title">
<div id="admonition-only-scripts-title">
<p>Only scripts</p>
</div>
<a class="admonition-anchor-link" href="language/fn-parent-scope.html#admonition-only-scripts"></a>
</div>
<div>
<p>This is only meaningful for <em>scripted</em> <a href="language//book/language/functions.html">functions</a>.</p>
<p>Native Rust functions can never access any <a href="language//book/engine/scope.html"><code>Scope</code></a>.</p>
</div>
</div>
<p>Rhai <a href="language//book/language/functions.html">functions</a> are <em>pure</em>, meaning that they depend on on their arguments and have no access to
the calling environment.</p>
<p>When a <a href="language//book/language/functions.html">function</a> accesses a <a href="language//book/language/variables.html">variable</a> that is not defined within that <a href="language//book/language/functions.html">function</a>’s <a href="language//book/engine/scope.html"><code>Scope</code></a>,
it raises an evaluation error.</p>
<p>It is possible, through a special syntax, to actually run the <a href="language//book/language/functions.html">function</a> call within the <a href="language//book/engine/scope.html"><code>Scope</code></a>
of the parent caller – i.e. the <a href="language//book/engine/scope.html"><code>Scope</code></a> that makes the <a href="language//book/language/functions.html">function</a> call – and
access/mutate <a href="language//book/language/variables.html">variables</a> defined there.</p>
<pre><code class="language-rust">fn foo(y) {             // function accesses 'x' and 'y', but 'x' is not defined
    x += y;             // 'x' is modified in this function
    let z = 0;          // 'z' is defined in this function's scope
    x
}

let x = 1;              // 'x' is defined here in the parent scope

foo(41);                // error: variable 'x' not found

// Calling a function with a '!' causes it to run within the caller's scope

foo!(41) == 42;         // the function can access and mutate the value of 'x'!

x == 42;                // 'x' is changed!

z == 0;                 // &lt;- error: variable 'z' not found

x.method!();            // &lt;- syntax error: not allowed in method-call style

// Also works for function pointers

let f = foo;            // &lt;- de-sugars to 'Fn("foo")'

call!(f, 42) == 84;     // must use function-call style

x == 84;                // 'x' is changed once again

f.call!(41);            // &lt;- syntax error: not allowed in method-call style

// But not allowed for module functions

import "hello" as h;

h::greet!();            // &lt;- syntax error: not allowed in namespace-qualified calls</code></pre>
<div id="admonition-the-callers-scope-can-be-mutated" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-the-callers-scope-can-be-mutated-title">
<div class="admonition-title">
<div id="admonition-the-callers-scope-can-be-mutated-title">
<p>The caller’s scope can be mutated</p>
</div>
<a class="admonition-anchor-link" href="language/fn-parent-scope.html#admonition-the-callers-scope-can-be-mutated"></a>
</div>
<div>
<p>Changes to <a href="language//book/language/variables.html">variables</a> in the calling <a href="language//book/engine/scope.html"><code>Scope</code></a> persist.</p>
<p>With this syntax, it is possible for a Rhai <a href="language//book/language/functions.html">function</a> to mutate its calling environment.</p>
</div>
</div>
<div id="admonition-new-variables-are-not-retained" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-new-variables-are-not-retained-title">
<div class="admonition-title">
<div id="admonition-new-variables-are-not-retained-title">
<p>New variables are not retained</p>
</div>
<a class="admonition-anchor-link" href="language/fn-parent-scope.html#admonition-new-variables-are-not-retained"></a>
</div>
<div>
<p><a href="language//book/language/variables.html">Variables</a> or <a href="language//book/language/constants.html">constants</a> defined within the <a href="language//book/language/functions.html">function</a> are <em>not</em> retained.
They remain local to the <a href="language//book/language/functions.html">function</a>.</p>
<p>Although the syntax resembles a Rust <em>macro</em> invocation, it is still a <a href="language//book/language/functions.html">function</a> call.</p>
</div>
</div>
<div id="admonition-caveat-emptor" class="admonition admonish-danger" role="note" aria-labelledby="admonition-caveat-emptor-title">
<div class="admonition-title">
<div id="admonition-caveat-emptor-title">
<p>Caveat emptor</p>
</div>
<a class="admonition-anchor-link" href="language/fn-parent-scope.html#admonition-caveat-emptor"></a>
</div>
<div>
<p><a href="language//book/language/functions.html">Functions</a> relying on the calling <a href="language//book/engine/scope.html"><code>Scope</code></a> is often a <em>Very Bad Idea™</em> because it makes code
almost impossible to reason about and maintain, as their behaviors are volatile and unpredictable.</p>
<p>Rhai <a href="language//book/language/functions.html">functions</a> are normally <em>pure</em>, meaning that you can rely on the fact that they never mutate
the outside environment.  Using this syntax breaks this guarantee.</p>
<p><a href="language//book/language/functions.html">Functions</a> called in this manner behave more like macros that are expanded inline than actual
function calls, thus the syntax is also similar to Rust’s macro invocations.</p>
<p>This usage should be at the last resort.</p>
<p><strong>YOU HAVE BEEN WARNED</strong>.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="use-rhai-in-dynamic-libraries"><a class="header" href="#use-rhai-in-dynamic-libraries">Use Rhai in Dynamic Libraries</a></h1>
<p>Sometimes functions registered into a Rhai <a href="engine//book/engine/hello-world.html"><code>Engine</code></a> come from <em>dynamic libraries</em> (a.k.a. <em>shared
libraries</em> in Linux or <em>DLL’s</em> in Windows), which are compiled separately from the main binary, not
statically linked but loaded dynamically at runtime.</p>
<div id="admonition-rhai-dylib" class="admonition admonish-example small" role="note" aria-labelledby="admonition-rhai-dylib-title">
<div class="admonition-title">
<div id="admonition-rhai-dylib-title">
<p><code>rhai-dylib</code></p>
</div>
<a class="admonition-anchor-link" href="engine/dynamic-lib.html#admonition-rhai-dylib"></a>
</div>
<div>
<p>The project <a href="engine//book/lib/rhai-dylib.html"><code>rhai-dylib</code></a> demonstrates an API for creating dynamically-loadable libraries
for use with a Rhai <a href="engine//book/engine/hello-world.html"><code>Engine</code></a>.</p>
</div>
</div>
<h2 id="problem-symptom"><a class="header" href="#problem-symptom">Problem Symptom</a></h2>
<p>The symptom is usually <em>Function Not Found</em> errors even though the relevant functions (within the
dynamic library) have already been registered into the <a href="engine//book/engine/hello-world.html"><code>Engine</code></a>.</p>
<p>This usually happens when a mutable reference to the <a href="engine//book/engine/hello-world.html"><code>Engine</code></a> is passed into an entry-point
function exposed by the dynamic library and the <a href="engine//book/engine/hello-world.html"><code>Engine</code></a>’s function registration API is called
inside the dynamic library.</p>
<h2 id="problem-cause"><a class="header" href="#problem-cause">Problem Cause</a></h2>
<p>To counter <a href="https://en.wikipedia.org/wiki/Denial-of-service_attack">DOS</a> attacks, the <em>hasher</em> used by Rhai, <a href="https://crates.io/crates/ahash"><code>ahash</code></a>, automatically generates a different
<em>seed</em> for hashing during each compilation and execution run.</p>
<p>This means that hash values generated by the hasher will not be <em>stable</em> – they change
during each compile, and during each run.</p>
<p>This creates hash mismatches between the main binary and the loaded dynamic library because, as they
are not linked together at compile time, two independent copies of the hasher reside in them,
resulting in different hashes for even the same function signature.</p>
<h2 id="solution"><a class="header" href="#solution">Solution</a></h2>
<p>Use <a href="engine//book/patterns/static-hash.html">static hashing</a> for force predictable hashes.</p>
<div id="admonition-warning-safety-considerations" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-warning-safety-considerations-title">
<div class="admonition-title">
<div id="admonition-warning-safety-considerations-title">
<p>Warning: Safety considerations</p>
</div>
<a class="admonition-anchor-link" href="engine/dynamic-lib.html#admonition-warning-safety-considerations"></a>
</div>
<div>
<p>Static hashing allows dynamic libraries with Rhai code to be loaded and used with
an <a href="engine//book/engine/hello-world.html"><code>Engine</code></a> in the main binary.</p>
<p>However, a fixed seed enlarges the attack surface of Rhai to malicious intent
(e.g. <a href="https://en.wikipedia.org/wiki/Denial-of-service_attack">DOS</a> attacks).</p>
<p>This safety trade-off should be carefully considered.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="use-rhai-as-a-domain-specific-language-dsl"><a class="header" href="#use-rhai-as-a-domain-specific-language-dsl">Use Rhai as a Domain-Specific Language (DSL)</a></h1>
<p>Rhai can be successfully used as a domain-specific language (DSL).</p>
<h2 id="expressions-only"><a class="header" href="#expressions-only">Expressions Only</a></h2>
<p>In many DSL scenarios, only evaluation of expressions is needed.</p>
<p>The <a href="engine//book/engine/expressions.html"><code>Engine::eval_expression_XXX</code></a> API can be used to restrict a script to
expressions only.</p>
<h2 id="unicode-standard-annex-31-identifiers"><a class="header" href="#unicode-standard-annex-31-identifiers">Unicode Standard Annex #31 Identifiers</a></h2>
<p><a href="engine//book/language/variables.html">Variable</a> names and other identifiers do not necessarily need to be ASCII-only.</p>
<p>The <a href="engine//book/start/features.html"><code>unicode-xid-ident</code></a> feature, when turned on, causes Rhai to allow <a href="engine//book/language/variables.html">variable</a> names and
identifiers that follow <a href="http://www.unicode.org/reports/tr31/">Unicode Standard Annex #31</a>.</p>
<p>This is sometimes useful in a non-English DSL.</p>
<h2 id="disable-keywords-andor-operators"><a class="header" href="#disable-keywords-andor-operators">Disable Keywords and/or Operators</a></h2>
<p>In some DSL scenarios, it is necessary to further restrict the language to exclude certain
language features that are not necessary or dangerous to the application.</p>
<p>For example, a DSL may disable the <a href="engine//book/language/while.html"><code>while</code></a> loop while keeping all other statement types intact.</p>
<p>It is possible, in Rhai, to surgically <a href="engine//book/engine/disable-keywords.html">disable keywords and operators</a>.</p>
<h2 id="custom-operators"><a class="header" href="#custom-operators">Custom Operators</a></h2>
<p>Some DSL scenarios require special operators that make sense only for that specific environment.
In such cases, it is possible to define <a href="engine//book/engine/custom-op.html">custom operators</a> in Rhai.</p>
<pre><code class="language-rust">let animal = "rabbit";
let food = "carrot";

animal eats food            // custom operator 'eats'

eats(animal, food)          // &lt;- the above actually de-sugars to this

let x = foo # bar;          // custom operator '#'

let x = #(foo, bar)         // &lt;- the above actually de-sugars to this</code></pre>
<p>Although a <a href="engine//book/engine/custom-op.html">custom operator</a> always de-sugars to a simple function call, nevertheless it makes the
DSL syntax much simpler and expressive.</p>
<h2 id="custom-syntax"><a class="header" href="#custom-syntax">Custom Syntax</a></h2>
<p>For advanced DSL scenarios, it is possible to define entire expression <a href="engine//book/engine/custom-syntax.html"><em>syntax</em></a> –
essentially custom statement types.</p>
<p>For example, the following is a SQL-like syntax for some obscure DSL operation:</p>
<pre><code class="language-rust">let table = [..., ..., ..., ...];

// Syntax = calculate $ident$ ( $expr$ -&gt; $ident$ ) =&gt; $ident$ : $expr$
let total = calculate sum(table-&gt;price) =&gt; row : row.weight &gt; 50;

// Note: There is nothing special about those symbols; to make it look exactly like SQL:
// Syntax = SELECT $ident$ ( $ident$ ) AS $ident$ FROM $expr$ WHERE $expr$
let total = SELECT sum(price) AS row FROM table WHERE row.weight &gt; 50;</code></pre>
<p>After registering this <a href="engine//book/engine/custom-syntax.html">custom syntax</a> with Rhai, it can be used anywhere inside a script as
a normal expression.</p>
<p>For its evaluation, the callback function will receive the following list of inputs:</p>
<ul>
<li><code>inputs[0] = "sum"</code> – math operator</li>
<li><code>inputs[1] = "price"</code> – field name</li>
<li><code>inputs[2] = "row"</code> – loop variable name</li>
<li><code>inputs[3] = Expression(table)</code> – data source</li>
<li><code>inputs[4] = Expression(row.weight &gt; 50)</code> – filter predicate</li>
</ul>
<p>Other identifiers, such as <code>"calculate"</code>, <code>"FROM"</code>, as well as symbols such as <code>-&gt;</code> and <code>:</code> etc.,
are parsed in the order defined within the <a href="engine//book/engine/custom-syntax.html">custom syntax</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="remap-tokens-during-parsing"><a class="header" href="#remap-tokens-during-parsing">Remap Tokens During Parsing</a></h1>
<p>The Rhai <a href="engine//book/engine/hello-world.html"><code>Engine</code></a> first parses a script into a stream of <em>tokens</em>.</p>
<p>Tokens have the type <a href="https://docs.rs/rhai/1.22.0/rhai/enum.Token.html"><code>Token</code></a> which is only exported under <a href="engine//book/start/features.html"><code>internals</code></a>.</p>
<p>The function <a href="https://docs.rs/rhai/1.22.0/rhai/struct.Engine.html#method.on_parse_token"><code>Engine::on_parse_token</code></a>, available only under <a href="engine//book/start/features.html"><code>internals</code></a>, allows registration of a
<em>mapper function</em> that converts (remaps) a <a href="https://docs.rs/rhai/1.22.0/rhai/enum.Token.html"><code>Token</code></a> into another.</p>
<div id="admonition-hot-tips-use-as-safety-checks" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-hot-tips-use-as-safety-checks-title">
<div class="admonition-title">
<div id="admonition-hot-tips-use-as-safety-checks-title">
<p>Hot Tips: Use as safety checks</p>
</div>
<a class="admonition-anchor-link" href="engine/token-mapper.html#admonition-hot-tips-use-as-safety-checks"></a>
</div>
<div>
<p>Since it is called for <em>every</em> token parsed from the script, this token mapper function
can also be used to implement <em>safety checks</em> against, say, stack-overflow or out-of-memory
situations during parsing.</p>
<p>See <a href="engine//book/safety/memory.html">here</a> for more details.</p>
</div>
</div>
<h2 id="function-signature-5"><a class="header" href="#function-signature-5">Function Signature</a></h2>
<div id="admonition-tip-raising-errors" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-raising-errors-title">
<div class="admonition-title">
<div id="admonition-tip-raising-errors-title">
<p>Tip: Raising errors</p>
</div>
<a class="admonition-anchor-link" href="engine/token-mapper.html#admonition-tip-raising-errors"></a>
</div>
<div>
<p>Raise a parse error by returning <a href="https://docs.rs/rhai/1.22.0/rhai/enum.Token.html#variant.LexError"><code>Token::LexError</code></a>
as the mapped token.</p>
</div>
</div>
<p>The function signature passed to <a href="https://docs.rs/rhai/1.22.0/rhai/struct.Engine.html#method.on_parse_token"><code>Engine::on_parse_token</code></a> takes the following form.</p>
<blockquote>
<pre><code class="language-rust">Fn(token: Token, pos: Position, state: &amp;TokenizeState) -&gt; Token</code></pre>
</blockquote>
<p>where:</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th style="text-align: center">Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>token</code></td><td style="text-align: center"><a href="https://docs.rs/rhai/1.22.0/rhai/enum.Token.html"><code>Token</code></a></td><td>the next symbol parsed</td></tr>
<tr><td><code>pos</code></td><td style="text-align: center"><code>Position</code></td><td>location of the <a href="https://docs.rs/rhai/1.22.0/rhai/enum.Token.html">token</a></td></tr>
<tr><td><code>state</code></td><td style="text-align: center"><a href="https://docs.rs/rhai/1.22.0/rhai/struct.TokenizeState.html"><code>&amp;TokenizeState</code></a></td><td>current state of the tokenizer</td></tr>
</tbody></table>
</div>
<h2 id="example-16"><a class="header" href="#example-16">Example</a></h2>
<pre><code class="language-rust">use rhai::{Engine, FLOAT, Token};

let mut engine = Engine::new();

// Register a token mapper function.
engine.on_parse_token(|token, pos, state| {
    match token {
        // Change 'begin' ... 'end' to '{' ... '}'
        Token::Identifier(s) if &amp;s == "begin" =&gt; Token::LeftBrace,
        Token::Identifier(s) if &amp;s == "end" =&gt; Token::RightBrace,

        // Change all integer literals to floating-point
        Token::IntegerConstant(n) =&gt; Token::FloatConstant((n as FLOAT).into()),
        
        // Disallow '()'
        Token::Unit =&gt; Token::LexError(
            LexError::ImproperSymbol("()".to_string(), "".to_string()).into()
        ),

        // Pass through all other tokens unchanged
        _ =&gt; token
    }
});</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="disable-certain-keywords-andor-operators"><a class="header" href="#disable-certain-keywords-andor-operators">Disable Certain Keywords and/or Operators</a></h1>
<p>For certain embedded usage, it is sometimes necessary to restrict the language to a strict subset of
Rhai to prevent usage of certain language features.</p>
<p>Rhai supports surgically disabling a <a href="engine//book/appendix/keywords.html">keyword</a> or <a href="engine//book/appendix/operators.html#operators">operator</a> via <code>Engine::disable_symbol</code>.</p>
<pre><code class="language-rust">use rhai::Engine;

let mut engine = Engine::new();

engine
    .disable_symbol("if")       // disable the 'if' keyword
    .disable_symbol("+=");      // disable the '+=' operator

// The following all return parse errors.

engine.compile("let x = if true { 42 } else { 0 };")?;
//                      ^ 'if' is rejected as a reserved keyword

engine.compile("let x = 40 + 2; x += 1;")?;
//                                ^ '+=' is not recognized as an operator
//                         ^ other operators are not affected</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="disable-looping"><a class="header" href="#disable-looping">Disable Looping</a></h1>
<p>For certain scripts, especially those in embedded usage for straight calculations, or where Rhai
script <a href="engine//book/engine/compile.html"><code>AST</code></a>’s are eventually transcribed into some other instruction set, looping may be
undesirable as it may not be supported by the application itself.</p>
<p>Rhai looping constructs include the <a href="engine//book/language/while.html"><code>while</code></a>, <a href="engine//book/language/loop.html"><code>loop</code></a>, <a href="engine//book/language/do.html"><code>do</code></a> and <a href="engine//book/language/for.html"><code>for</code></a> statements.</p>
<p>Although it is possible to disable these keywords via
<a href="engine//book/engine/disable-keywords.html"><code>Engine::disable_symbol</code></a>, it is simpler to disable all looping
via <a href="engine//book/engine/options.html"><code>Engine::set_allow_looping</code></a>.</p>
<pre><code class="language-rust">use rhai::Engine;

let mut engine = Engine::new();

// Disable looping
engine.set_allow_looping(false);

// The following all return parse errors.

engine.compile("while x == y { x += 1; }")?;

engine.compile(r#"loop { print("hello world!"); }"#)?;

engine.compile("do { x += 1; } until x &gt; 10;")?;

engine.compile("for n in 0..10 { print(n); }")?;</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="custom-operators-1"><a class="header" href="#custom-operators-1">Custom Operators</a></h1>
<div id="admonition-see-also" class="admonition admonish-info side" role="note" aria-labelledby="admonition-see-also-title">
<div class="admonition-title">
<div id="admonition-see-also-title">
<p>See also</p>
</div>
<a class="admonition-anchor-link" href="engine/custom-op.html#admonition-see-also"></a>
</div>
<div>
<p>See <a href="engine//book/engine/precedence.html">this section</a> for details on operator <a href="engine//book/engine/precedence.html">precedence</a>.</p>
</div>
</div>
<p>For use as a DSL (Domain-Specific Languages), it is sometimes more convenient to augment Rhai with
customized operators performing specific logic.</p>
<p><code>Engine::register_custom_operator</code> registers a <a href="engine//book/appendix/keywords.html">keyword</a> as a custom operator, giving it a particular
<em><a href="engine//book/engine/precedence.html">precedence</a></em> (which cannot be zero).</p>
<p>Support for custom operators can be disabled via the <a href="engine//book/start/features.html"><code>no_custom_syntax</code></a> feature.</p>
<h2 id="example-17"><a class="header" href="#example-17">Example</a></h2>
<pre><code class="language-rust">use rhai::Engine;

let mut engine = Engine::new();

// Register a custom operator '#' and give it a precedence of 160
// (i.e. between +|- and *|/)
// Also register the implementation of the custom operator as a function
engine.register_custom_operator("#", 160)?
      .register_fn("#", |x: i64, y: i64| (x * y) - (x + y));

// The custom operator can be used in expressions
let result = engine.eval_expression::&lt;i64&gt;("1 + 2 * 3 # 4 - 5 / 6")?;
//                                                    ^ custom operator

// The above is equivalent to: 1 + ((2 * 3) # 4) - (5 / 6)
result == 15;</code></pre>
<h2 id="alternatives-to-a-custom-operator"><a class="header" href="#alternatives-to-a-custom-operator">Alternatives to a Custom Operator</a></h2>
<p>Custom operators are merely <em>syntactic sugar</em>.  They map directly to registered functions.</p>
<pre><code class="language-rust">let mut engine = Engine::new();

// Define 'foo' operator
engine.register_custom_operator("foo", 160)?;

engine.eval::&lt;i64&gt;("1 + 2 * 3 foo 4 - 5 / 6")?;       // use custom operator

engine.eval::&lt;i64&gt;("1 + foo(2 * 3, 4) - 5 / 6")?;     // &lt;- above is equivalent to this</code></pre>
<p>A script using custom operators can always be pre-processed, via a pre-processor application,
into a syntax that uses the corresponding function calls.</p>
<p>Using <code>Engine::register_custom_operator</code> merely enables a convenient shortcut.</p>
<h2 id="must-be-a-valid-identifier-or-reserved-symbol"><a class="header" href="#must-be-a-valid-identifier-or-reserved-symbol">Must be a Valid Identifier or Reserved Symbol</a></h2>
<p>All custom operators must be <em>identifiers</em> that follow the same naming rules as <a href="engine//book/language/variables.html">variables</a>.</p>
<p>Alternatively, they can also be <a href="engine//book/appendix/operators.html#symbols">reserved symbols</a>,
<a href="engine//book/engine/disable-keywords.html">disabled operators or keywords</a>.</p>
<pre><code class="language-rust">engine.register_custom_operator("foo", 20)?;          // 'foo' is a valid custom operator

engine.register_custom_operator("#", 20)?;            // the reserved symbol '#' is also
                                                      // a valid custom operator

engine.register_custom_operator("+", 30)?;            // &lt;- error: '+' is an active operator

engine.register_custom_operator("=&gt;", 30)?;           // &lt;- error: '=&gt;' is an active symbol</code></pre>
<h2 id="binary-operators-only"><a class="header" href="#binary-operators-only">Binary Operators Only</a></h2>
<p>All custom operators must be <em>binary</em> (i.e. they take two operands).
<em>Unary</em> custom operators are not supported.</p>
<pre><code class="language-rust">// Register unary '#' operator
engine.register_custom_operator("#", 160)?
      .register_fn("#", |x: i64| x * x);

engine.eval::&lt;i64&gt;("# 42")?;                          // &lt;- syntax error</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="operator-precedence"><a class="header" href="#operator-precedence">Operator Precedence</a></h1>
<p>All operators in Rhai has a <em>precedence</em> indicating how tightly they bind.</p>
<p>A higher precedence binds more tightly than a lower precedence, so <code>*</code> and <code>/</code> binds before <code>+</code> and <code>-</code> etc.</p>
<p>When registering a custom operator, the operator’s precedence must also be provided.</p>
<p>The following <em>precedence table</em> shows the built-in precedence of standard Rhai operators:</p>
<div class="table-wrapper"><table><thead><tr><th>Category</th><th style="text-align: center">Operators</th><th style="text-align: center">Binding</th><th style="text-align: center">Precedence (0-255)</th></tr></thead><tbody>
<tr><td>Logic and bit masks</td><td style="text-align: center"><code>||</code>,  <code>|</code>, <code>^</code></td><td style="text-align: center">left</td><td style="text-align: center">30</td></tr>
<tr><td>Logic and bit masks</td><td style="text-align: center"><code>&amp;&amp;</code>, <code>&amp;</code></td><td style="text-align: center">left</td><td style="text-align: center">60</td></tr>
<tr><td>Comparisons</td><td style="text-align: center"><code>==</code>, <code>!=</code></td><td style="text-align: center">left</td><td style="text-align: center">90</td></tr>
<tr><td>Containment</td><td style="text-align: center"><a href="engine//book/language/in.html"><code>in</code></a></td><td style="text-align: center">left</td><td style="text-align: center">110</td></tr>
<tr><td>Comparisons</td><td style="text-align: center"><code>&gt;</code>, <code>&gt;=</code>, <code>&lt;</code>, <code>&lt;=</code></td><td style="text-align: center">left</td><td style="text-align: center">130</td></tr>
<tr><td>Null-coalesce</td><td style="text-align: center"><code>??</code></td><td style="text-align: center">left</td><td style="text-align: center">135</td></tr>
<tr><td>Ranges</td><td style="text-align: center"><code>..</code>, <code>..=</code></td><td style="text-align: center">left</td><td style="text-align: center">140</td></tr>
<tr><td>Arithmetic</td><td style="text-align: center"><code>+</code>, <code>-</code></td><td style="text-align: center">left</td><td style="text-align: center">150</td></tr>
<tr><td>Arithmetic</td><td style="text-align: center"><code>*</code>, <code>/</code>, <code>%</code></td><td style="text-align: center">left</td><td style="text-align: center">180</td></tr>
<tr><td>Arithmetic</td><td style="text-align: center"><code>**</code></td><td style="text-align: center">right</td><td style="text-align: center">190</td></tr>
<tr><td>Bit-shifts</td><td style="text-align: center"><code>&lt;&lt;</code>, <code>&gt;&gt;</code></td><td style="text-align: center">left</td><td style="text-align: center">210</td></tr>
<tr><td>Unary operators</td><td style="text-align: center"><code>+</code>, <code>-</code>, <code>!</code></td><td style="text-align: center">right</td><td style="text-align: center">highest</td></tr>
<tr><td>Object field access</td><td style="text-align: center"><code>.</code>, <code>?.</code></td><td style="text-align: center">right</td><td style="text-align: center">highest</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="extend-rhai-with-custom-syntax"><a class="header" href="#extend-rhai-with-custom-syntax">Extend Rhai with Custom Syntax</a></h1>
<p>For the ultimate adventurous, there is a built-in facility to <em>extend</em> the Rhai language with
custom-defined <em>syntax</em>.</p>
<p>But before going off to define the next weird statement type, heed this warning:</p>
<div id="admonition-dont-do-it" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-dont-do-it-title">
<div class="admonition-title">
<div id="admonition-dont-do-it-title">
<p>Don’t Do It™</p>
</div>
<a class="admonition-anchor-link" href="engine/custom-syntax.html#admonition-dont-do-it"></a>
</div>
<div>
<p>Stick with standard language syntax as much as possible.</p>
<p>Having to learn Rhai is bad enough, no sane user would ever want to learn <em>yet</em> another obscure
language syntax just to do something.</p>
<p>Try <a href="engine//book/engine/custom-op.html">custom operators</a> first.  A custom syntax should be considered a <em>last resort</em>.</p>
</div>
</div>
<div id="admonition-where-this-might-be-useful" class="admonition admonish-success small" role="note" aria-labelledby="admonition-where-this-might-be-useful-title">
<div class="admonition-title">
<div id="admonition-where-this-might-be-useful-title">
<p>Where this might be useful</p>
</div>
<a class="admonition-anchor-link" href="engine/custom-syntax.html#admonition-where-this-might-be-useful"></a>
</div>
<div>
<ul>
<li>
<p>Where an operation is used a <em>LOT</em> and a custom syntax saves a lot of typing.</p>
</li>
<li>
<p>Where a custom syntax <em>significantly</em> simplifies the code and <em>significantly</em> enhances
understanding of the code’s intent.</p>
</li>
<li>
<p>Where certain logic cannot be easily encapsulated inside a function.</p>
</li>
<li>
<p>Where you just want to confuse your user and make their lives miserable, because you can.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-disable-custom-syntax" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-disable-custom-syntax-title">
<div class="admonition-title">
<div id="admonition-disable-custom-syntax-title">
<p>Disable custom syntax</p>
</div>
<a class="admonition-anchor-link" href="engine/custom-syntax.html#admonition-disable-custom-syntax"></a>
</div>
<div>
<p>Custom syntax can be disabled via the <a href="engine//book/start/features.html"><code>no_custom_syntax</code></a> feature.</p>
</div>
</div>
<h2 id="how-to-do-it"><a class="header" href="#how-to-do-it">How to Do It</a></h2>
<h3 id="step-one--design-the-syntax"><a class="header" href="#step-one--design-the-syntax">Step One – Design The Syntax</a></h3>
<p>A custom syntax is simply a list of symbols.</p>
<p>These symbol types can be used:</p>
<ul>
<li>Standard <a href="engine//book/appendix/keywords.html">keywords</a></li>
<li>Standard <a href="engine//book/appendix/operators.html#operators">operators</a></li>
<li>Reserved <a href="engine//book/appendix/operators.html#symbols">symbols</a>.</li>
<li>Identifiers following the <a href="engine//book/language/variables.html">variable</a> naming rules.</li>
<li><code>$expr$</code> – any valid expression, statement or statements block.</li>
<li><code>$block$</code> – any valid statements block (i.e. must be enclosed by <code>{</code> … <code>}</code>).</li>
<li><code>$func$</code> – any valid <a href="engine//book/language/fn-closure.html">closure</a>, or any valid statements block as the body of a <a href="engine//book/language/fn-closure.html">closure</a> with no parameters (if not <a href="engine//book/start/features.html"><code>no_function</code></a>).</li>
<li><code>$ident$</code> – any <a href="engine//book/language/variables.html">variable</a> name.</li>
<li><code>$symbol$</code> – any <a href="engine//book/appendix/operators.html#operators">symbol</a>, active or reserved.</li>
<li><code>$bool$</code> – a boolean value.</li>
<li><code>$int$</code> – an integer number.</li>
<li><code>$float$</code> – a floating-point number (if not <a href="engine//book/start/features.html"><code>no_float</code></a>).</li>
<li><code>$string$</code> – a <a href="engine//book/language/strings-chars.html">string</a> literal.</li>
</ul>
<h4 id="the-first-symbol-must-be-an-identifier"><a class="header" href="#the-first-symbol-must-be-an-identifier">The first symbol must be an identifier</a></h4>
<p>There is no specific limit on the combination and sequencing of each symbol type,
except the <em>first</em> symbol which must be a custom <a href="engine//book/appendix/keywords.html">keyword</a> that follows the naming rules
of <a href="engine//book/language/variables.html">variables</a>.</p>
<p>The first symbol also cannot be a normal <a href="engine//book/appendix/keywords.html">keyword</a> unless it is <a href="engine//book/engine/disable-keywords.html">disabled</a>.
Any valid identifier that is not an active <a href="engine//book/appendix/keywords.html">keyword</a> works fine, even if it is a reserved <a href="engine//book/appendix/keywords.html">keyword</a>.</p>
<h4 id="the-first-symbol-must-be-unique"><a class="header" href="#the-first-symbol-must-be-unique">The first symbol must be unique</a></h4>
<p>Rhai uses the <em>first</em> symbol as a clue to parse custom syntax.</p>
<p>Therefore, at any one time, there can only be <em>one</em> custom syntax starting with each unique symbol.</p>
<p>Any new custom syntax definition using the same first symbol simply <em>overwrites</em> the previous one.</p>
<h4 id="example-18"><a class="header" href="#example-18">Example</a></h4>
<pre><code class="language-rust">exec [ $ident$ $symbol$ $int$ ] &lt;- $expr$ : $block$</code></pre>
<p>The above syntax is made up of a stream of symbols:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Position</th><th style="text-align: center">Input slot</th><th style="text-align: center">Symbol</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: center">1</td><td style="text-align: center"></td><td style="text-align: center"><code>exec</code></td><td>custom keyword</td></tr>
<tr><td style="text-align: center">2</td><td style="text-align: center"></td><td style="text-align: center"><code>[</code></td><td>the left bracket symbol</td></tr>
<tr><td style="text-align: center">2</td><td style="text-align: center">0</td><td style="text-align: center"><code>$ident$</code></td><td>a <a href="engine//book/language/variables.html">variable</a> name</td></tr>
<tr><td style="text-align: center">3</td><td style="text-align: center">1</td><td style="text-align: center"><code>$symbol$</code></td><td>the operator</td></tr>
<tr><td style="text-align: center">4</td><td style="text-align: center">2</td><td style="text-align: center"><code>$int$</code></td><td>an integer number</td></tr>
<tr><td style="text-align: center">5</td><td style="text-align: center"></td><td style="text-align: center"><code>]</code></td><td>the right bracket symbol</td></tr>
<tr><td style="text-align: center">6</td><td style="text-align: center"></td><td style="text-align: center"><code>&lt;-</code></td><td>the left-arrow symbol (which is a <a href="engine//book/appendix/operators.html#symbols">reserved symbol</a> in Rhai).</td></tr>
<tr><td style="text-align: center">7</td><td style="text-align: center">3</td><td style="text-align: center"><code>$expr$</code></td><td>an expression, which may be enclosed with <code>{</code> … <code>}</code>, or not.</td></tr>
<tr><td style="text-align: center">8</td><td style="text-align: center"></td><td style="text-align: center"><code>:</code></td><td>the colon symbol</td></tr>
<tr><td style="text-align: center">9</td><td style="text-align: center">4</td><td style="text-align: center"><code>$block$</code></td><td>a statements block, which must be enclosed with <code>{</code> … <code>}</code>.</td></tr>
</tbody></table>
</div>
<p>This syntax matches the following sample code and generates five inputs (one for each non-keyword):</p>
<pre><code class="language-rust">// Assuming the 'exec' custom syntax implementation declares the variable 'hello':
let x = exec [hello &lt; 42] &lt;- foo(1, 2) : {
            hello += bar(hello);
            baz(hello);
        };

print(x);       // variable 'x'  has a value returned by the custom syntax

print(hello);   // variable declared by a custom syntax persists!</code></pre>
<h3 id="step-two--implementation"><a class="header" href="#step-two--implementation">Step Two – Implementation</a></h3>
<p>Any custom syntax must include an <em>implementation</em> of it.</p>
<h4 id="function-signature-6"><a class="header" href="#function-signature-6">Function signature</a></h4>
<p>The signature of an implementation function is as follows.</p>
<blockquote>
<pre><code class="language-rust">Fn(context: &amp;mut EvalContext, inputs: &amp;[Expression]) -&gt; Result&lt;Dynamic, Box&lt;EvalAltResult&gt;&gt;</code></pre>
</blockquote>
<p>where:</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th style="text-align: center">Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>context</code></td><td style="text-align: center"><a href="engine//book/engine/eval-context.html"><code>&amp;mut EvalContext</code></a></td><td>mutable reference to the current <em>evaluation context</em></td></tr>
<tr><td><code>inputs</code></td><td style="text-align: center"><code>&amp;[Expression]</code></td><td>a list of input expression trees</td></tr>
</tbody></table>
</div>
<p>and <a href="engine//book/engine/eval-context.html"><code>EvalContext</code></a> is a type that encapsulates the current <em>evaluation context</em>.</p>
<h4 id="return-value-7"><a class="header" href="#return-value-7">Return value</a></h4>
<p>Return value is the result of evaluating the custom syntax expression.</p>
<h4 id="access-arguments"><a class="header" href="#access-arguments">Access arguments</a></h4>
<p>The most important argument is <code>inputs</code> where the matched identifiers (<code>$ident$</code>), expressions/statements (<code>$expr$</code>)
and statements blocks (<code>$block$</code>) are provided.</p>
<p>To access a particular argument, use the following patterns:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Argument type</th><th>Pattern (<code>n</code> = slot in <code>inputs</code>)</th><th style="text-align: center">Result type</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>$ident$</code></td><td><code>inputs[n].get_string_value().unwrap()</code></td><td style="text-align: center"><code>&amp;str</code></td><td><a href="engine//book/language/variables.html">variable</a> name</td></tr>
<tr><td style="text-align: center"><code>$symbol$</code></td><td><code>inputs[n].get_literal_value::&lt;ImmutableString&gt;().unwrap()</code></td><td style="text-align: center"><a href="engine//book/rust/immutable-string.html"><code>ImmutableString</code></a></td><td>symbol literal</td></tr>
<tr><td style="text-align: center"><code>$expr$</code></td><td><code>&amp;inputs[n]</code></td><td style="text-align: center"><code>&amp;Expression</code></td><td>an expression tree</td></tr>
<tr><td style="text-align: center"><code>$block$</code></td><td><code>&amp;inputs[n]</code></td><td style="text-align: center"><code>&amp;Expression</code></td><td>an expression tree</td></tr>
<tr><td style="text-align: center"><code>$func$</code></td><td><code>&amp;inputs[n]</code></td><td style="text-align: center"><code>&amp;Expression</code></td><td>an expression tree (output is a <a href="engine//book/language/fn-ptr.html">function pointer</a>)</td></tr>
<tr><td style="text-align: center"><code>$bool$</code></td><td><code>inputs[n].get_literal_value::&lt;bool&gt;().unwrap()</code></td><td style="text-align: center"><code>bool</code></td><td>boolean value</td></tr>
<tr><td style="text-align: center"><code>$int$</code></td><td><code>inputs[n].get_literal_value::&lt;INT&gt;().unwrap()</code></td><td style="text-align: center"><code>INT</code></td><td>integer number</td></tr>
<tr><td style="text-align: center"><code>$float$</code></td><td><code>inputs[n].get_literal_value::&lt;FLOAT&gt;().unwrap()</code></td><td style="text-align: center"><code>FLOAT</code></td><td>floating-point number</td></tr>
<tr><td style="text-align: center"><code>$string$</code></td><td><code>inputs[n].get_literal_value::&lt;ImmutableString&gt;().unwrap()</code><br/><br/><code>inputs[n].get_string_value().unwrap()</code></td><td style="text-align: center"><a href="engine//book/rust/immutable-string.html"><code>ImmutableString</code></a><br/><br/><code>&amp;str</code></td><td><a href="engine//book/language/strings-chars.html">string</a> text</td></tr>
</tbody></table>
</div>
<h4 id="get-literal-constants"><a class="header" href="#get-literal-constants">Get literal constants</a></h4>
<p>Several argument types represent literal constants that can be obtained directly via
<code>Expression::get_literal_value&lt;T&gt;</code> or <code>Expression::get_string_value</code> (for <a href="engine//book/language/strings-chars.html">strings</a>).</p>
<pre><code class="language-rust">let expression = &amp;inputs[0];

// Use 'get_literal_value' with a turbo-fish type to extract the value
let string_value = expression.get_literal_value::&lt;ImmutableString&gt;().unwrap();
let string_slice = expression.get_string_value().unwrap();

let float_value = expression.get_literal_value::&lt;FLOAT&gt;().unwrap();

// Or assign directly to a variable with type...
let int_value: i64 = expression.get_literal_value().unwrap();

// Or use type inference!
let bool_value = expression.get_literal_value().unwrap();

if bool_value { ... }       // 'bool_value' inferred to be 'bool'</code></pre>
<h4 id="evaluate-an-expression-tree"><a class="header" href="#evaluate-an-expression-tree">Evaluate an expression tree</a></h4>
<p>Use the <code>EvalContext::eval_expression_tree</code> method to evaluate an arbitrary expression tree
within the current evaluation context.</p>
<pre><code class="language-rust">let expression = &amp;inputs[0];
let result = context.eval_expression_tree(expression)?;</code></pre>
<h4 id="retain-variables-in-block-scope"><a class="header" href="#retain-variables-in-block-scope">Retain variables in block scope</a></h4>
<p>When an expression tree actually contains a statements block (i.e. <code>$block</code>), local
<a href="engine//book/language/variables.html">variables</a>/<a href="engine//book/language/constants.html">constants</a> defined within that block are usually removed at the end of the block.</p>
<p>Sometimes it is useful to retain these local <a href="engine//book/language/variables.html">variables</a>/<a href="engine//book/language/constants.html">constants</a> for further processing
(e.g. collecting new <a href="engine//book/language/variables.html">variables</a> into an <a href="engine//book/language/object-maps.html">object map</a>).</p>
<p>As such, evaluate the expression tree using the <code>EvalContext::eval_expression_tree_raw</code> method which
contains a parameter to control whether the statements block should be rewound.</p>
<pre><code class="language-rust">// Assume 'expression' contains a statements block with local variable definitions
let expression = &amp;inputs[0];
let result = context.eval_expression_tree_raw(expression, false)?;

// Variables defined within 'expression' persist in context.scope()</code></pre>
<h4 id="declare-variables"><a class="header" href="#declare-variables">Declare variables</a></h4>
<p>New <a href="engine//book/language/variables.html">variables</a>/<a href="engine//book/language/constants.html">constants</a> maybe declared (usually with a <a href="engine//book/language/variables.html">variable</a> name that is passed in via <code>$ident$</code>).</p>
<p>It can simply be pushed into the <a href="engine//book/engine/scope.html"><code>Scope</code></a>.</p>
<pre><code class="language-rust">let var_name = inputs[0].get_string_value().unwrap();
let expression = &amp;inputs[1];

context.scope_mut().push(var_name, 0_i64);      // declare new variable

let result = context.eval_expression_tree(expression)?;</code></pre>
<h3 id="step-three--register-the-custom-syntax"><a class="header" href="#step-three--register-the-custom-syntax">Step Three – Register the Custom Syntax</a></h3>
<p>Use <code>Engine::register_custom_syntax</code> to register a custom syntax.</p>
<p>Again, beware that the <em>first</em> symbol must be unique.  If there already exists a custom syntax starting
with that symbol, the previous syntax will be overwritten.</p>
<p>The syntax is passed simply as a slice of <code>&amp;str</code>.</p>
<pre><code class="language-rust">// Custom syntax implementation
fn implementation_func(context: &amp;mut EvalContext, inputs: &amp;[Expression]) -&gt; Result&lt;Dynamic, Box&lt;EvalAltResult&gt;&gt; {
    let var_name = inputs[0].get_string_value().unwrap();
    let stmt = &amp;inputs[1];
    let condition = &amp;inputs[2];

    // Push new variable into the scope BEFORE 'context.eval_expression_tree'
    context.scope_mut().push(var_name.to_string(), 0_i64);

    let mut count = 0_i64;

    loop {
        // Evaluate the statements block
        context.eval_expression_tree(stmt)?;

        count += 1;

        // Declare a new variable every three turns...
        if count % 3 == 0 {
            context.scope_mut().push(format!("{var_name}{count}"), count);
        }

        // Evaluate the condition expression
        let expr_result = !context.eval_expression_tree(condition)?;

        match expr_result.as_bool() {
            Ok(true) =&gt; (),
            Ok(false) =&gt; break,
            Err(err) =&gt; return Err(EvalAltResult::ErrorMismatchDataType(
                            "bool".to_string(),
                            err.to_string(),
                            condition.position(),
                        ).into()),
        }
    }

    Ok(Dynamic::UNIT)
}

// Register the custom syntax (sample): exec&lt;x&gt; -&gt; { x += 1 } while x &lt; 0
engine.register_custom_syntax(
    [ "exec", "&lt;", "$ident$", "&gt;", "-&gt;", "$block$", "while", "$expr$" ], // the custom syntax
    true,  // variables declared within this custom syntax
    implementation_func
)?;</code></pre>
<p>Remember that a custom syntax acts as an <em>expression</em>, so it can show up practically anywhere:</p>
<pre><code class="language-rust">// Use as an expression:
let foo = (exec&lt;x&gt; -&gt; { x += 1 } while x &lt; 42) * 100;

// New variables are successfully declared...
x == 42;
x3 == 3;
x6 == 6;

// Use as a function call argument:
do_something(exec&lt;x&gt; -&gt; { x += 1 } while x &lt; 42, 24, true);

// Use as a statement:
exec&lt;x&gt; -&gt; { x += 1 } while x &lt; 0;
//                               ^ terminate statement with ';' unless the custom
//                                 syntax already ends with '}'</code></pre>
<h3 id="step-four--disable-unneeded-statement-types"><a class="header" href="#step-four--disable-unneeded-statement-types">Step Four – Disable Unneeded Statement Types</a></h3>
<p>When a DSL needs a custom syntax, most likely than not it is extremely specialized.
Therefore, many statement types actually may not make sense under the same usage scenario.</p>
<p>So, while at it, better <a href="engine//book/engine/disable-keywords.html">disable</a> those built-in keywords
and <a href="engine//book/appendix/operators.html#operators">operators</a> that should not be used by the user.  The would leave only the bare minimum
language surface exposed, together with the custom syntax that is tailor-designed for
the scenario.</p>
<p>A <a href="engine//book/appendix/keywords.html">keyword</a> or <a href="engine//book/appendix/operators.html#operators">operator</a> that is disabled can still be used in a custom syntax.</p>
<p>In an extreme case, it is possible to disable <em>every</em> <a href="engine//book/appendix/keywords.html">keyword</a> in the language, leaving only
custom syntax (plus possibly expressions).  But again, Don’t Do It™ – unless you are certain
of what you’re doing.</p>
<h3 id="step-five--document"><a class="header" href="#step-five--document">Step Five – Document</a></h3>
<p>For custom syntax, documentation is crucial.</p>
<p>Make sure there are <em>lots</em> of examples for users to follow.</p>
<h3 id="step-six--profit"><a class="header" href="#step-six--profit">Step Six – Profit!</a></h3>
<h2 id="practical-example--matrix-literal"><a class="header" href="#practical-example--matrix-literal">Practical Example – Matrix Literal</a></h2>
<p>Say you’d want to use something like <a href="https://crates.io/crates/ndarray"><code>ndarray</code></a> to manipulate matrices.</p>
<p>However, you’d like to write matrix literals in a more intuitive syntax than an <a href="engine//book/language/arrays.html">array</a>
of <a href="engine//book/language/arrays.html">arrays</a>.</p>
<p>In other words, you’d like to turn:</p>
<pre><code class="language-rust">// Array of arrays
let matrix = [ [  a, b,     0 ],
               [ -b, a,     0 ],
               [  0, 0, c * d ] ];</code></pre>
<p>into:</p>
<pre><code class="language-rust">// Directly parse to an ndarray::Array (look ma, no commas!)
let matrix = @|  a   b   0  |
              | -b   a   0  |
              |  0   0  c*d |;</code></pre>
<p>This can easily be done via a custom syntax, which yields a syntax that is more pleasing.</p>
<pre><code class="language-rust">// Disable the '|' symbol since it'll conflict with the bit-wise OR operator.
// Do this BEFORE registering the custom syntax.
engine.disable_symbol("|");

engine.register_custom_syntax(
    ["@", "|", "$expr$", "$expr$", "$expr$", "|", 
          "|", "$expr$", "$expr$", "$expr$", "|",
          "|", "$expr$", "$expr$", "$expr$", "|" 
    ],
    false,
    |context, inputs| {
        use ndarray::arr2;

        let mut values = [[0.0; 3]; 3];

        for y in 0..3 {
            for x in 0..3 {
                let offset = y * 3 + x;

                match context.eval_expression_tree(&amp;inputs[offset])?.as_float() {
                    Ok(v) =&gt; values[y][x] = v,
                    Err(typ) =&gt; return Err(Box::new(EvalAltResult::ErrorMismatchDataType(
                                            "float".to_string(), typ.to_string(),
                                            inputs[offset].position()
                                )))
                }
            }
        }

        let matrix = arr2(&amp;values);

        Ok(Dynamic::from(matrix))
    },
)?;</code></pre>
<p>For matrices of flexible dimensions, check out <a href="engine/custom-syntax-parsers.html">custom syntax parsers</a>.</p>
<h2 id="practical-example--defining-temporary-variables"><a class="header" href="#practical-example--defining-temporary-variables">Practical Example – Defining Temporary Variables</a></h2>
<p>It is possible to define temporary <a href="engine//book/language/variables.html">variables</a>/<a href="engine//book/language/constants.html">constants</a> which are available only to code blocks
within the custom syntax.</p>
<pre><code class="language-rust">engine.register_custom_syntax(
    [ "with", "offset", "(", "$expr$", ",", "$expr$", ")", "$block$", ],
    true,   // must be true in order to define new variables
    |context, inputs| {
        // Get the two offsets
        let x = context.eval_expression_tree(&amp;inputs[0])?.as_int().map_err(|typ| Box::new(
            EvalAltResult::ErrorMismatchDataType("integer".to_string(), typ.to_string(), inputs[0].position())
        ))?;
        let y = context.eval_expression_tree(&amp;inputs[1])?.as_int().map_err(|typ| Box::new(
            EvalAltResult::ErrorMismatchDataType("integer".to_string(), typ.to_string(), inputs[1].position())
        ))?;

        // Add them as temporary constants into the scope, available only to the code block
        let orig_len = context.scope().len();

        context.scope_mut().push_constant("x", x);
        context.scope_mut().push_constant("y", y);

        // Run the code block
        let result = context.eval_expression_tree(&amp;inputs[2]);

        // Remove the temporary constants from the scope so they don't leak outside
        context.scope_mut().rewind(orig_len);

        // Return the result
        result
    },
)?;</code></pre>
<h2 id="practical-example--recreating-cs-ternary-operator"><a class="header" href="#practical-example--recreating-cs-ternary-operator">Practical Example – Recreating C’s Ternary Operator</a></h2>
<p>Rhai has <a href="engine/../language/if.html#if-expression">if-expressions</a>, but sometimes a C-style <em>ternary</em> operator
is more concise.</p>
<pre><code class="language-rust">// A custom syntax must start with a unique symbol, so we use 'iff'.
// Register the custom syntax: iff condition ? true-value : false-value
engine.register_custom_syntax(
    ["iff", "$expr$", "?", "$expr$", ":", "$expr$"],
    false,
    |context, inputs| match context.eval_expression_tree(&amp;inputs[0])?.as_bool() {
        Ok(true) =&gt; context.eval_expression_tree(&amp;inputs[1]),
        Ok(false) =&gt; context.eval_expression_tree(&amp;inputs[2]),
        Err(typ) =&gt; Err(Box::new(EvalAltResult::ErrorMismatchDataType(
            "bool".to_string(), typ.to_string(), inputs[0].position()
        ))),
    },
)?;</code></pre>
<div id="admonition-tip-custom-syntax-performance" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-custom-syntax-performance-title">
<div class="admonition-title">
<div id="admonition-tip-custom-syntax-performance-title">
<p>Tip: Custom syntax performance</p>
</div>
<a class="admonition-anchor-link" href="engine/custom-syntax.html#admonition-tip-custom-syntax-performance"></a>
</div>
<div>
<p>The code in the example above is essentially what the <a href="engine//book/language/if.html"><code>if</code></a> statement does internally, and since
custom syntax is pre-parsed, there really is no performance penalty!</p>
</div>
</div>
<h2 id="practical-example--recreating-javascripts-var-statement"><a class="header" href="#practical-example--recreating-javascripts-var-statement">Practical Example – Recreating JavaScript’s <code>var</code> Statement</a></h2>
<p>The following example recreates a statement similar to the <code>var</code> variable declaration syntax in
JavaScript, which creates a global variable if one doesn’t already exist.
There is currently no equivalent in Rhai.</p>
<pre><code class="language-rust">// Register the custom syntax: var x = ???
engine.register_custom_syntax([ "var", "$ident$", "=", "$expr$" ], true, |context, inputs| {
    let var_name = inputs[0].get_string_value().unwrap().to_string();
    let expr = &amp;inputs[1];

    // Evaluate the expression
    let value = context.eval_expression_tree(expr)?;

    // Push a new variable into the scope if it doesn't already exist.
    // Otherwise just set its value.
    if !context.scope().is_constant(var_name).unwrap_or(false) {
        context.scope_mut().set_value(var_name.to_string(), value);
        Ok(Dynamic::UNIT)
    } else {
        Err(format!("variable {} is constant", var_name).into())
    }
})?;</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="really-advanced--custom-parsers"><a class="header" href="#really-advanced--custom-parsers">Really Advanced – Custom Parsers</a></h1>
<p>Sometimes it is desirable to have multiple <a href="engine//book/engine/custom-syntax.html">custom syntax</a> starting with the same symbol.</p>
<p>This is especially common for <em>command-style</em> syntax where the second symbol calls a particular command:</p>
<pre><code class="language-rust">// The following simulates a command-style syntax, all starting with 'perform'.
perform hello world;        // A fixed sequence of symbols
perform action 42;          // Perform a system action with a parameter
perform update system;      // Update the system
perform check all;          // Check all system settings
perform cleanup;            // Clean up the system
perform add something;      // Add something to the system
perform remove something;   // Delete something from the system</code></pre>
<p>Alternatively, a <a href="engine//book/engine/custom-syntax.html">custom syntax</a> may have variable length, with a termination symbol:</p>
<pre><code class="language-rust">// The following is a variable-length list terminated by '&gt;'  
tags &lt; "foo", "bar", 123, ... , x+y, true &gt;</code></pre>
<p>For even more flexibility in order to handle these advanced use cases, there is a
<em>low level</em> API for <a href="engine//book/engine/custom-syntax.html">custom syntax</a> that allows the registration of an entire mini-parser.</p>
<p>Use <code>Engine::register_custom_syntax_with_state_raw</code> to register a <a href="engine//book/engine/custom-syntax.html">custom syntax</a> <em>parser</em> together
with an implementation function, both of which accept a custom user-defined <em>state</em> value.</p>
<h2 id="how-custom-parsers-work"><a class="header" href="#how-custom-parsers-work">How Custom Parsers Work</a></h2>
<h3 id="leading-symbol"><a class="header" href="#leading-symbol">Leading Symbol</a></h3>
<p>Under this API, the leading symbol for a custom parser is no longer restricted to be valid identifiers.</p>
<p>It can either be:</p>
<ul>
<li>
<p>an identifier that isn’t a normal <a href="engine//book/appendix/keywords.html">keyword</a> unless <a href="engine//book/engine/disable-keywords.html">disabled</a>, or</p>
</li>
<li>
<p>a valid symbol (see <a href="engine//book/appendix/operators.html">list</a>) which is not a normal <a href="engine//book/appendix/operators.html#operators">operator</a> unless <a href="engine//book/engine/disable-keywords.html">disabled</a>.</p>
</li>
</ul>
<h3 id="parser-function-signature"><a class="header" href="#parser-function-signature">Parser Function Signature</a></h3>
<p>The <a href="engine//book/engine/custom-syntax.html">custom syntax</a> parser has the following signature.</p>
<blockquote>
<pre><code class="language-rust">Fn(symbols: &amp;[ImmutableString], look_ahead: &amp;str, state: &amp;mut Dynamic) -&gt; Result&lt;Option&lt;ImmutableString&gt;, ParseError&gt;</code></pre>
</blockquote>
<p>where:</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th style="text-align: center">Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>symbols</code></td><td style="text-align: center"><a href="engine//book/rust/immutable-string.html"><code>&amp;[ImmutableString]</code></a></td><td>a slice of symbols that have been parsed so far, possibly containing <code>$expr$</code> and/or <code>$block$</code>; <code>$ident$</code> and other literal markers are replaced by the actual text</td></tr>
<tr><td><code>look_ahead</code></td><td style="text-align: center"><code>&amp;str</code></td><td>a string slice containing the next symbol that is about to be read</td></tr>
<tr><td><code>state</code></td><td style="text-align: center"><a href="engine//book/language/dynamic.html"><code>&amp;mut Dynamic</code></a></td><td>mutable reference to a user-defined <em>state</em></td></tr>
</tbody></table>
</div>
<p>Most strings are <a href="engine//book/rust/immutable-string.html"><code>ImmutableString</code></a>’s so it is usually more efficient to just <code>clone</code> the appropriate one
(if any matches, or keep an internal cache for commonly-used symbols) as the return value.</p>
<h3 id="parameter-1--symbols-parsed-so-far"><a class="header" href="#parameter-1--symbols-parsed-so-far">Parameter #1 – Symbols Parsed So Far</a></h3>
<p>The symbols parsed so far are provided as a slice of <a href="engine//book/rust/immutable-string.html"><code>ImmutableString</code></a>s.</p>
<p>The custom parser can inspect this symbols stream to determine the next symbol to parse.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Argument type</th><th>Value</th></tr></thead><tbody>
<tr><td style="text-align: center">text <a href="engine//book/language/strings-chars.html">string</a></td><td>text value</td></tr>
<tr><td style="text-align: center"><code>$ident$</code></td><td>identifier name</td></tr>
<tr><td style="text-align: center"><code>$symbol$</code></td><td>symbol literal</td></tr>
<tr><td style="text-align: center"><code>$expr$</code></td><td><code>$expr$</code></td></tr>
<tr><td style="text-align: center"><code>$block$</code></td><td><code>$block$</code></td></tr>
<tr><td style="text-align: center"><code>$func$</code></td><td><code>$func$</code></td></tr>
<tr><td style="text-align: center"><code>$bool$</code></td><td><code>true</code> or <code>false</code></td></tr>
<tr><td style="text-align: center"><code>$int$</code></td><td>value of number</td></tr>
<tr><td style="text-align: center"><code>$float$</code></td><td>value of number</td></tr>
<tr><td style="text-align: center"><code>$string$</code></td><td><a href="engine//book/language/strings-chars.html">string</a> text</td></tr>
</tbody></table>
</div>
<h3 id="parameter-2--look-ahead-symbol"><a class="header" href="#parameter-2--look-ahead-symbol">Parameter #2 – Look-Ahead Symbol</a></h3>
<p>The <em>look-ahead</em> symbol is the symbol that will be parsed <em>next</em>.</p>
<p>If the look-ahead is an expected symbol, the customer parser just returns it to continue parsing,
or it can return <code>$ident$</code> to parse it as an identifier, or even <code>$expr$</code> to start parsing
an expression.</p>
<div id="admonition-tip-strings-vs-identifiers" class="admonition admonish-tip side wide" role="note" aria-labelledby="admonition-tip-strings-vs-identifiers-title">
<div class="admonition-title">
<div id="admonition-tip-strings-vs-identifiers-title">
<p>Tip: Strings vs identifiers</p>
</div>
<a class="admonition-anchor-link" href="engine/custom-syntax-parsers.html#admonition-tip-strings-vs-identifiers"></a>
</div>
<div>
<p>The look-ahead of an identifier (e.g. <a href="engine//book/language/variables.html">variable</a> name) is its text name.</p>
<p>That of a <a href="engine//book/language/strings-chars.html">string</a> literal is its content wrapped in <em>quotes</em> (<code>"</code>), e.g. <code>"this is a string"</code>.</p>
</div>
</div>
<p>If the look-ahead is <code>{</code>, then the custom parser may also return <code>$block$</code> to start parsing a
statements block.</p>
<p>If the look-ahead is unexpected, the custom parser should then return the symbol expected
and Rhai will fail with a parse error containing information about the expected symbol.</p>
<h3 id="parameter-3--user-defined-custom-state"><a class="header" href="#parameter-3--user-defined-custom-state">Parameter #3 – User-Defined Custom <em>State</em></a></h3>
<p>The <em>state’s</em> value starts off as <a href="engine//book/language/values-and-types.html"><code>()</code></a>.</p>
<p>Its type is <a href="engine//book/language/dynamic.html"><code>Dynamic</code></a>, possible to hold any value.</p>
<p>Usually it is set to an <a href="engine//book/language/object-maps.html">object map</a> that contains information on the state of parsing.</p>
<h3 id="return-value-8"><a class="header" href="#return-value-8">Return value</a></h3>
<p>The return value is <code>Result&lt;Option&lt;ImmutableString&gt;, ParseError&gt;</code> where:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Value</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>Ok(None)</code></td><td>parsing is complete and there is no more symbol to match</td></tr>
<tr><td style="text-align: center"><code>Ok(Some(symbol))</code></td><td>the next <code>symbol</code> to match, which can also be <code>$expr$</code>, <code>$ident$</code>, <code>$block$</code> etc.</td></tr>
<tr><td style="text-align: center"><code>Err(error)</code></td><td><code>error</code> that is reflected back to the <a href="engine//book/engine/hello-world.html"><code>Engine</code></a> – normally <code>ParseError( ParseErrorType::BadInput( LexError::ImproperSymbol(message) ), Position::NONE)</code> to indicate that there is a syntax error, but it can be any <code>ParseError</code>.</td></tr>
</tbody></table>
</div>
<p>A custom parser always returns <code>Some</code> with the <em>next</em> symbol expected (which can be <code>$ident$</code>,
<code>$expr$</code>, <code>$block$</code> etc.) or <code>None</code> if parsing should terminate (<em>without</em> reading the
look-ahead symbol).</p>
<h4 id="the--return-symbol-short-cut"><a class="header" href="#the--return-symbol-short-cut">The <code>$$</code> return symbol short-cut</a></h4>
<p>A return symbol starting with <code>$$</code> is treated specially.</p>
<p>Like <code>None</code>, it also terminates parsing, but at the same time it adds this symbol as text into the
<em>inputs</em> stream at the end.</p>
<p>This is typically used to inform the implementation function which <a href="engine//book/engine/custom-syntax.html">custom syntax</a> variant was
actually parsed.</p>
<pre><code class="language-rust">fn implementation_fn(context: &amp;mut EvalContext, inputs: &amp;[Expression], state: &amp;Dynamic) -&gt; Result&lt;Dynamic, Box&lt;EvalAltResult&gt;&gt;
{
    // Get the last symbol
    let key = inputs.last().unwrap().get_string_value().unwrap();

    // Make sure it starts with '$$'
    assert!(key.starts_with("$$"));

    // Execute the custom syntax expression
    match key {
        "$$hello" =&gt; { ... }
        "$$world" =&gt; { ... }
        "$$foo" =&gt; { ... }
        "$$bar" =&gt; { ... }
        _ =&gt; Err(...)
    }
}</code></pre>
<p><code>$$</code> is a convenient <em>short-cut</em>. An alternative method is to pass such information in the user-defined
custom <em>state</em>.</p>
<h3 id="implementation-function-signature"><a class="header" href="#implementation-function-signature">Implementation Function Signature</a></h3>
<p>The signature of an implementation function for <code>Engine::register_custom_syntax_with_state_raw</code> is
as follows, which is slightly different from the function for <code>Engine::register_custom_syntax</code>.</p>
<blockquote>
<pre><code class="language-rust">Fn(context: &amp;mut EvalContext, inputs: &amp;[Expression], state: &amp;Dynamic) -&gt; Result&lt;Dynamic, Box&lt;EvalAltResult&gt;&gt;</code></pre>
</blockquote>
<p>where:</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th style="text-align: center">Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>context</code></td><td style="text-align: center"><a href="engine//book/engine/eval-context.html"><code>&amp;mut EvalContext</code></a></td><td>mutable reference to the current <em>evaluation context</em></td></tr>
<tr><td><code>inputs</code></td><td style="text-align: center"><code>&amp;[Expression]</code></td><td>a list of input expression trees</td></tr>
<tr><td><code>state</code></td><td style="text-align: center"><a href="engine//book/language/dynamic.html"><code>&amp;Dynamic</code></a></td><td>reference to the user-defined state</td></tr>
</tbody></table>
</div>
<h2 id="custom-parser-example"><a class="header" href="#custom-parser-example">Custom Parser Example</a></h2>
<pre><code class="language-rust">engine.register_custom_syntax_with_state_raw(
    // The leading symbol - which needs not be an identifier.
    "perform",
    // The custom parser implementation - always returns the next symbol expected
    // 'look_ahead' is the next symbol about to be read
    //
    // Return symbols starting with '$$' also terminate parsing but allows us
    // to determine which syntax variant was actually parsed so we can perform the
    // appropriate action.  This is a convenient short-cut to keeping the value
    // inside the state.
    //
    // The return type is 'Option&lt;ImmutableString&gt;' to allow common text strings
    // to be interned and shared easily, reducing allocations during parsing.
    |symbols, look_ahead, state| match symbols.len() {
        // perform ...
        1 =&gt; Ok(Some("$ident$".into())),
        // perform command ...
        2 =&gt; match symbols[1].as_str() {
            "action" =&gt; Ok(Some("$expr$".into())),
            "hello" =&gt; Ok(Some("world".into())),
            "update" | "check" | "add" | "remove" =&gt; Ok(Some("$ident$".into())),
            "cleanup" =&gt; Ok(Some("$$cleanup".into())),
            cmd =&gt; Err(LexError::ImproperSymbol(format!("Improper command: {cmd}"))
                       .into_err(Position::NONE)),
        },
        // perform command arg ...
        3 =&gt; match (symbols[1].as_str(), symbols[2].as_str()) {
            ("action", _) =&gt; Ok(Some("$$action".into())),
            ("hello", "world") =&gt; Ok(Some("$$hello-world".into())),
            ("update", arg) =&gt; match arg {
                "system" =&gt; Ok(Some("$$update-system".into())),
                "client" =&gt; Ok(Some("$$update-client".into())),
                _ =&gt; Err(LexError::ImproperSymbol(format!("Cannot update {arg}"))
                         .into_err(Position::NONE))
            },
            ("check", arg) =&gt; Ok(Some("$$check".into())),
            ("add", arg) =&gt; Ok(Some("$$add".into())),
            ("remove", arg) =&gt; Ok(Some("$$remove".into())),
            (cmd, arg) =&gt; Err(LexError::ImproperSymbol(
                format!("Invalid argument for command {cmd}: {arg}")
            ).into_err(Position::NONE)),
        },
        _ =&gt; unreachable!(),
    },
    // No variables declared/removed by this custom syntax
    false,
    // Implementation function
    |context, inputs, state| {
        let cmd = inputs.last().unwrap().get_string_value().unwrap();

        match cmd {
            "$$cleanup" =&gt; { ... }
            "$$action" =&gt; { ... }
            "$$update-system" =&gt; { ... }
            "$$update-client" =&gt; { ... }
            "$$check" =&gt; { ... }
            "$$add" =&gt; { ... }
            "$$remove" =&gt; { ... }
            _ =&gt; Err(format!("Invalid command: {cmd}"))
        }
    }
);</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="debugging-interface"><a class="header" href="#debugging-interface">Debugging Interface</a></h1>
<p>For systems open to external user-created scripts, it is usually desirable to provide a <em>debugging</em>
experience to the user. The alternative is to provide a custom implementation of <a href="engine/debugging//book/language/print-debug.html"><code>debug</code></a> via
<code>Engine::on_debug</code> that traps debug output to show in a side panel, for example, which is actually
extremely simple.</p>
<p>Nevertheless, in some systems, it may not be convenient, or even possible, for the user to debug his
or her scripts simply via good-old <a href="engine/debugging//book/language/print-debug.html"><code>print</code></a> or <a href="engine/debugging//book/language/print-debug.html"><code>debug</code></a> statements – the system does not
have any facility for printed output, for instance.</p>
<p>Or the system may require more advanced debugging facilities than mere <a href="engine/debugging//book/language/print-debug.html"><code>print</code></a> statements –
such as <a href="engine/debugging//book/engine/debugging/break-points.html">break-points</a>.</p>
<p>For these advanced scenarios, Rhai contains a <em>Debugging</em> interface, turned on via the <a href="engine/debugging//book/start/features.html"><code>debugging</code></a>
feature (which implies the <a href="engine/debugging//book/start/features.html"><code>internals</code></a> feature).</p>
<p>The debugging interface resides under the <code>debugger</code> sub-module.</p>
<div id="admonition-the-rhai-debugger" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-the-rhai-debugger-title">
<div class="admonition-title">
<div id="admonition-the-rhai-debugger-title">
<p>The Rhai Debugger</p>
</div>
<a class="admonition-anchor-link" href="engine/debugging/index.html#admonition-the-rhai-debugger"></a>
</div>
<div>
<p>The <a href="https://github.com/rhaiscript/rhai/blob/main/src/bin/rhai-dbg.rs"><code>rhai-dbg</code></a> bin tool shows a simple example of
employing the debugging interface to create a debugger for Rhai scripts!</p>
</div>
</div>
<h2 id="built-in-functions-6"><a class="header" href="#built-in-functions-6">Built-in Functions</a></h2>
<p>The following functions (defined in the <a href="engine/debugging//book/rust/packages/builtin.html"><code>DebuggingPackage</code></a> but excluded when
using a <a href="engine/debugging//book/engine/raw.html">raw <code>Engine</code></a>) provides runtime information for debugging purposes.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Parameter(s)</th><th style="text-align: center">Not available under</th><th>Description</th></tr></thead><tbody>
<tr><td><code>back_trace</code></td><td><em>none</em></td><td style="text-align: center"><a href="engine/debugging//book/start/features.html"><code>no_function</code></a>, <a href="engine/debugging//book/start/features.html"><code>no_index</code></a></td><td>returns an <a href="engine/debugging//book/language/arrays.html">array</a> of <a href="engine/debugging//book/language/object-maps.html">object maps</a> or <a href="engine/debugging//book/language/strings-chars.html">strings</a>, each containing one level of <a href="engine/debugging//book/language/functions.html">function</a> call;</br>returns an empty <a href="engine/debugging//book/language/arrays.html">array</a> if no <a href="engine/debugging//book/engine/debugging/debugger.html">debugger</a> is registered</td></tr>
</tbody></table>
</div>
<pre><code class="language-rust">// This recursive function prints its own call stack during each run
fn foo(x) {
    print(back_trace());        // prints the current call stack

    if x &gt; 0 {
        foo(x - 1)
    }
}</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="register-with-the-debugger"><a class="header" href="#register-with-the-debugger">Register with the Debugger</a></h1>
<p>Hooking up a debugging interface is as simple as providing closures to the <a href="engine/debugging//book/engine/hello-world.html"><code>Engine</code></a>’s built-in
debugger via <code>Engine::register_debugger</code>.</p>
<pre><code class="language-rust">use rhai::debugger::{ASTNode, DebuggerCommand};

let mut engine = Engine::new();

engine.register_debugger(
    // Provide a callback to initialize the debugger state
    |engine, mut debugger| {
        debugger.set_state(...);
        debugger
    },
    // Provide a callback for each debugging step
    |context, event, node, source, pos| {
        ...

        DebuggerCommand::StepOver
    }
);</code></pre>
<div id="admonition-tip-accessing-the-debugger" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-accessing-the-debugger-title">
<div class="admonition-title">
<div id="admonition-tip-accessing-the-debugger-title">
<p>Tip: Accessing the <code>Debugger</code></p>
</div>
<a class="admonition-anchor-link" href="engine/debugging/debugger.html#admonition-tip-accessing-the-debugger"></a>
</div>
<div>
<p>The type <code>debugger::Debugger</code> allows for manipulating <a href="engine/debugging//book/engine/debugging/break-points.html">break-points</a>, among others.</p>
<p>The <a href="engine/debugging//book/engine/hello-world.html"><code>Engine</code></a>’s debugger instance can be accessed via <code>context.global_runtime_state().debugger()</code> (immutable)
or <code>context.global_runtime_state_mut().debugger_mut()</code> (mutable).</p>
</div>
</div>
<h2 id="callback-functions-signature"><a class="header" href="#callback-functions-signature">Callback Functions Signature</a></h2>
<p>There are two callback functions to register for the debugger.</p>
<p>The first is simply a function to initialize the state of the debugger with the following signature.</p>
<blockquote>
<pre><code class="language-rust">Fn(&amp;Engine, debugger::Debugger) -&gt; debugger::Debugger</code></pre>
</blockquote>
<p>The second callback is a function which will be called by the debugger during each step, with the
following signature.</p>
<blockquote>
<pre><code class="language-rust">Fn(context: EvalContext, event: debugger::DebuggerEvent, node: ASTNode, source: &amp;str, pos: Position) -&gt; Result&lt;debugger::DebuggerCommand, Box&lt;EvalAltResult&gt;&gt;</code></pre>
</blockquote>
<p>where:</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th style="text-align: center">Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>context</code></td><td style="text-align: center"><a href="engine/debugging//book/engine/eval-context.html"><code>EvalContext</code></a></td><td>the current <em>evaluation context</em></td></tr>
<tr><td><code>event</code></td><td style="text-align: center"><code>DebuggerEvent</code></td><td>an <code>enum</code> indicating the event that triggered the debugger</td></tr>
<tr><td><code>node</code></td><td style="text-align: center"><code>ASTNode</code></td><td>an <code>enum</code> with two variants: <code>Expr</code> or <code>Stmt</code>, corresponding to the current expression node or statement node in the <a href="engine/debugging//book/engine/compile.html"><code>AST</code></a></td></tr>
<tr><td><code>source</code></td><td style="text-align: center"><code>&amp;str</code></td><td>the source of the current <a href="engine/debugging//book/engine/compile.html"><code>AST</code></a>, or empty if none</td></tr>
<tr><td><code>pos</code></td><td style="text-align: center"><code>Position</code></td><td>position of the current node, same as <code>node.position()</code></td></tr>
</tbody></table>
</div>
<p>and <a href="engine/debugging//book/engine/eval-context.html"><code>EvalContext</code></a> is a type that encapsulates the current <em>evaluation context</em>.</p>
<h3 id="event"><a class="header" href="#event">Event</a></h3>
<p>The <code>event</code> parameter of the second closure passed to <code>Engine::register_debugger</code> contains a
<code>debugger::DebuggerEvent</code> which is an <code>enum</code> with the following variants.</p>
<div class="table-wrapper"><table><thead><tr><th><code>DebuggerEvent</code> variant</th><th>Description</th></tr></thead><tbody>
<tr><td><code>Start</code></td><td>the debugger is triggered at the beginning of evaluation</td></tr>
<tr><td><code>Step</code></td><td>the debugger is triggered at the next step of evaluation</td></tr>
<tr><td><code>BreakPoint(</code><em>n</em><code>)</code></td><td>the debugger is triggered by the <em>n</em>-th <a href="engine/debugging//book/engine/debugging/break-points.html">break-point</a></td></tr>
<tr><td><code>FunctionExitWithValue(</code><em>r</em><code>)</code></td><td>the debugger is triggered by a function call returning with value <em>r</em> which is <code>&amp;Dynamic</code></td></tr>
<tr><td><code>FunctionExitWithError(</code><em>err</em><code>)</code></td><td>the debugger is triggered by a function call exiting with error <em>err</em> which is <code>&amp;EvalAltResult</code></td></tr>
<tr><td><code>End</code></td><td>the debugger is triggered at the end of evaluation</td></tr>
</tbody></table>
</div>
<h3 id="return-value-9"><a class="header" href="#return-value-9">Return value</a></h3>
<div id="admonition-tip-initialization" class="admonition admonish-tip side wide" role="note" aria-labelledby="admonition-tip-initialization-title">
<div class="admonition-title">
<div id="admonition-tip-initialization-title">
<p>Tip: Initialization</p>
</div>
<a class="admonition-anchor-link" href="engine/debugging/debugger.html#admonition-tip-initialization"></a>
</div>
<div>
<p>When a script starts evaluation, the debugger always stops at the very <em>first</em> <a href="engine/debugging//book/engine/compile.html"><code>AST</code></a> node
with the <code>event</code> parameter set to <code>DebuggerStatus::Start</code>.</p>
<p>This allows initialization to be done (e.g. setting up <a href="engine/debugging//book/engine/debugging/break-points.html">break-points</a>).</p>
</div>
</div>
<p>The second closure passed to <code>Engine::register_debugger</code> will be called when stepping into or over
expressions and statements, or when <a href="engine/debugging//book/engine/debugging/break-points.html">break-points</a> are hit.</p>
<p>The return type of the closure is <code>Result&lt;debugger::DebuggerCommand, Box&lt;EvalAltResult&gt;&gt;</code>.</p>
<p>If an error is returned, the script evaluation at that particular instance returns with that
particular error. It is thus possible to <em>abort</em> the script evaluation by returning an error that is
not <em>catchable</em>, such as <code>EvalAltResult::ErrorTerminated</code>.</p>
<p>If no error is returned, then the return <code>debugger::DebuggerCommand</code> variant determines the
continued behavior of the debugger.</p>
<div class="table-wrapper"><table><thead><tr><th><code>DebuggerCommand</code> variant</th><th>Behavior</th><th style="text-align: center"><code>gdb</code> equivalent</th></tr></thead><tbody>
<tr><td><code>Continue</code></td><td>continue with normal script evaluation</td><td style="text-align: center"><code>continue</code></td></tr>
<tr><td><code>StepInto</code></td><td>run to the next expression or statement, diving into functions</td><td style="text-align: center"><code>step</code></td></tr>
<tr><td><code>StepOver</code></td><td>run to the next expression or statement, skipping over functions</td><td style="text-align: center"></td></tr>
<tr><td><code>Next</code></td><td>run to the next statement, skipping over functions</td><td style="text-align: center"><code>next</code></td></tr>
<tr><td><code>FunctionExit</code></td><td>run to the end of the current function call; debugger is triggered <em>before</em> the function call returns and the <a href="engine/debugging//book/engine/scope.html"><code>Scope</code></a> cleared</td><td style="text-align: center"><code>finish</code></td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="debugger-state"><a class="header" href="#debugger-state">Debugger State</a></h1>
<p>Sometimes it is useful to keep a persistent <em>state</em> within the <a href="engine/debugging//book/engine/debugging/debugger.html">debugger</a>.</p>
<p>The <code>Engine::register_debugger</code> API accepts a function that returns the initial value of the
<a href="engine/debugging//book/engine/debugging/debugger.html">debugger’s</a> state, which is a <a href="engine/debugging//book/language/dynamic.html"><code>Dynamic</code></a> and can hold any value.</p>
<p>This state value is the stored into the <a href="engine/debugging//book/engine/debugging/debugger.html">debugger</a>’s custom state.</p>
<h2 id="access-the-debugger-state"><a class="header" href="#access-the-debugger-state">Access the Debugger State</a></h2>
<p>Use <code>EvalContext::global_runtime_state().debugger()</code> (immutable) or
<code>EvalContext::global_runtime_state_mut().debugger_mut()</code> (mutable) to gain access to the current
<a href="engine/debugging//book/engine/debugging/debugger.html"><code>debugger::Debugger</code></a> instance.</p>
<p>The following <a href="engine/debugging//book/engine/debugging/debugger.html"><code>debugger::Debugger</code></a> methods allow access to the custom <a href="engine/debugging//book/engine/debugging/debugger.html">debugger</a> state.</p>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th style="text-align: center">Parameter type</th><th style="text-align: center">Return type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>state</code></td><td style="text-align: center"><em>none</em></td><td style="text-align: center"><a href="engine/debugging//book/language/dynamic.html"><code>&amp;Dynamic</code></a></td><td>returns the custom state</td></tr>
<tr><td><code>state_mut</code></td><td style="text-align: center"><em>none</em></td><td style="text-align: center"><a href="engine/debugging//book/language/dynamic.html"><code>&amp;mut Dynamic</code></a></td><td>returns a mutable reference to the custom state</td></tr>
<tr><td><code>set_state</code></td><td style="text-align: center"><a href="engine/debugging//book/language/dynamic.html"><code>impl Into&lt;Dynamic&gt;</code></a></td><td style="text-align: center"><em>none</em></td><td>sets the value of the custom state</td></tr>
</tbody></table>
</div>
<h2 id="example-19"><a class="header" href="#example-19">Example</a></h2>
<pre><code class="language-rust">engine.register_debugger(
    |engine, mut debugger| {
        // Say, use an object map for the debugger state
        let mut state = Map::new();
        // Initialize properties
        state.insert("hello".into(), 42_64.into());
        state.insert("foo".into(), false.into());
        
        debugger.set_state(state);
        debugger
    },
    |context, node, source, pos| {
        // Print debugger state - which is an object map
        let state = context.global_runtime_state().debugger().state();
        println!("Current state = {state}");

        // Get the state as an object map
        let mut state = context.global_runtime_state_mut()
                               .debugger_mut().state_mut()
                               .write_lock::&lt;Map&gt;().unwrap();

        // Read state
        let hello = state.get("hello").unwrap().as_int().unwrap();

        // Modify state
        state.insert("hello".into(), (hello + 1).into());
        state.insert("foo".into(), true.into());
        state.insert("something_new".into(), "hello, world!".into());

        // Continue with debugging
        Ok(DebuggerCommand::StepInto)
    }
);</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="call-stack"><a class="header" href="#call-stack">Call Stack</a></h1>
<div id="admonition-call-stack-frames" class="admonition admonish-info side wide" role="note" aria-labelledby="admonition-call-stack-frames-title">
<div class="admonition-title">
<div id="admonition-call-stack-frames-title">
<p>Call stack frames</p>
</div>
<a class="admonition-anchor-link" href="engine/debugging/call-stack.html#admonition-call-stack-frames"></a>
</div>
<div>
<p>Each “frame” in the call stack corresponds to one layer of <a href="engine/debugging//book/language/functions.html">function</a> call (script-defined
or native Rust).</p>
<p>A call stack frame has the type <code>debugger::CallStackFrame</code>.</p>
</div>
</div>
<p>The <a href="engine/debugging//book/engine/debugging/debugger.html">debugger</a> keeps a <em>call stack</em> of <a href="engine/debugging//book/language/functions.html">function</a> calls with argument values.</p>
<p>This call stack can be examined to determine the control flow at any particular point.</p>
<p>The <code>Debugger::call_stack</code> method returns a slice of all call stack frames.</p>
<pre><code class="language-rust">use rhai::debugger::*;

let debugger = &amp;mut context.global_runtime_state().debugger();

// Get depth of the call stack.
let depth = debugger.call_stack().len();

// Display all function calls
for frame in debugger.call_stack().iter() {
    println!("{frame}");
}</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="break-points"><a class="header" href="#break-points">Break-Points</a></h1>
<p>A <em>break-point</em> <strong>always</strong> stops the current evaluation and calls the <a href="engine/debugging//book/engine/debugging/debugger.html">debugging</a>
callback.</p>
<p>A break-point is represented by the <code>debugger::BreakPoint</code> type, which is an <code>enum</code> with
the following variants.</p>
<div class="table-wrapper"><table><thead><tr><th><code>BreakPoint</code> variant</th><th style="text-align: center">Not available under</th><th>Description</th></tr></thead><tbody>
<tr><td><code>AtPosition { source, pos, enabled }</code></td><td style="text-align: center"><a href="engine/debugging//book/start/features.html"><code>no_position</code></a></td><td>breaks at the specified position in the specified source (empty if none);<br/>if <code>pos</code> is at beginning of line, breaks anywhere on the line</td></tr>
<tr><td><code>AtFunctionName { name, enabled }</code></td><td style="text-align: center"></td><td>breaks when a function matching the specified name is called (can be <a href="engine/debugging//book/appendix/operators.html#operators">operator</a>)</td></tr>
<tr><td><code>AtFunctionCall { name, args, enabled }</code></td><td style="text-align: center"></td><td>breaks when a function matching the specified name (can be <a href="engine/debugging//book/appendix/operators.html#operators">operator</a>) and the specified number of arguments is called</td></tr>
<tr><td><code>AtProperty { name, enabled }</code></td><td style="text-align: center"><a href="engine/debugging//book/start/features.html"><code>no_object</code></a></td><td>breaks at the specified property access</td></tr>
</tbody></table>
</div>
<h2 id="access-break-points"><a class="header" href="#access-break-points">Access Break-Points</a></h2>
<p>The following <a href="engine/debugging//book/engine/debugging/debugger.html"><code>debugger::Debugger</code></a> methods allow access to break-points for manipulation.</p>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th style="text-align: center">Return type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>break_points</code></td><td style="text-align: center"><code>&amp;[BreakPoint]</code></td><td>returns a slice of all <code>BreakPoint</code>’s</td></tr>
<tr><td><code>break_points_mut</code></td><td style="text-align: center"><code>&amp;mut Vec&lt;BreakPoint&gt;</code></td><td>returns a mutable reference to all <code>BreakPoint</code>’s</td></tr>
</tbody></table>
</div>
<h2 id="example-20"><a class="header" href="#example-20">Example</a></h2>
<pre><code class="language-rust">use rhai::debugger::*;

let debugger = &amp;mut context.global_runtime_state_mut().debugger_mut();

// Get number of break-points.
let num_break_points = debugger.break_points().len();

// Add a new break-point on calls to 'foo(_, _, _)'
debugger.break_points_mut().push(
    BreakPoint::AtFunctionCall { name: "foo".into(), args: 3 }
);

// Display all break-points
for bp in debugger.break_points().iter() {
    println!("{bp}");
}

// Clear all break-points
debugger.break_points_mut().clear();</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="implement-a-debugging-server"><a class="header" href="#implement-a-debugging-server">Implement a Debugging Server</a></h1>
<p>Sometimes it is desirable to embed a debugging <em>server</em> inside the application such that an external
debugger interface can connect to the application’s running instance at runtime.</p>
<p>This way, when scripts are run within the application, it is easy for an external interface to debug
those scripts as they run.</p>
<p>Such connections may take the form of any communication channel, for example a TCP/IP connection, a
named pipe, or an MPSC channel.</p>
<h2 id="example-21"><a class="header" href="#example-21">Example</a></h2>
<h3 id="server-side"><a class="header" href="#server-side">Server side</a></h3>
<p>The following example assumes bi-direction, blocking messaging channels, such as a WebSocket
connection, with a server that accepts connections and creates those channels.</p>
<pre><code class="language-rust">use rhai::debugger::{ASTNode, DebuggerCommand};

let mut engine = Engine::new();

engine.register_debugger(
    // Use the initialization callback to set up the communications channel
    // and listen to it
    |engine, mut debugger| {
        // Create server that will listen to requests
        let mut server = MyCommServer::new();
        server.listen("localhost:8080");

        // Wrap it up in a shared locked cell so it can be 'Clone'
        let server = Rc::new(RefCell::new(server));

        // Store the channel in the debugger state
        debugger.set_state(Dynamic::from(server));
        debugger
    },
    // Trigger the server during each debugger stop point
    |context, event, node, source, pos| {
        // Get the state
        let mut state = context.tag_mut();

        // Get the server
        let mut server = state.write_lock::&lt;MyCommServer&gt;().unwrap();

        // Send the event to the server - blocking call
        server.send_message(...);

        // Receive command - blocking call
        match server.receive_message() {
            None =&gt; DebuggerCommand::StepOver,
            // Decode command
            Ok(...) =&gt; { ... }
            Ok(...) =&gt; { ... }
            Ok(...) =&gt; { ... }
            Ok(...) =&gt; { ... }
            Ok(...) =&gt; { ... }
                :
                :
        }
    }
);</code></pre>
<h3 id="client-side"><a class="header" href="#client-side">Client side</a></h3>
<p>The client can be any system that can work with WebSockets for messaging.</p>
<pre><code class="language-js">// Connect to the application's debugger
let webSocket = new WebSocket("wss://localhost:8080");

webSocket.on_message = (event) =&gt; {
    let msg = JSON.parse(event.data);

    switch msg.type {
        // handle debugging events from the application...
        case "step": {
                :
        }
                :
                :
    }
};

// Send command to the application
webSocket.send("step-over");
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="object-oriented-programming-oop"><a class="header" href="#object-oriented-programming-oop">Object-Oriented Programming (OOP)</a></h1>
<p>Rhai does not have <em>objects</em> per se and is not object-oriented (in the traditional sense),
but it is possible to <em>simulate</em> object-oriented programming.</p>
<div id="admonition-to-oop-or-not-to-oop-that-is-the-question" class="admonition admonish-question small" role="note" aria-labelledby="admonition-to-oop-or-not-to-oop-that-is-the-question-title">
<div class="admonition-title">
<div id="admonition-to-oop-or-not-to-oop-that-is-the-question-title">
<p>To OOP or not to OOP, that is the question.</p>
</div>
<a class="admonition-anchor-link" href="patterns/oop.html#admonition-to-oop-or-not-to-oop-that-is-the-question"></a>
</div>
<div>
<p>Regardless of whether object-oriented programming (OOP) should be treated as a pattern or
an <em>anti-pattern</em> (the programming world is split 50-50 on this), there are always users who
would like to write Rhai in “the OOP way.”</p>
<p>Rust itself is not object-oriented in the traditional sense; JavaScript also isn’t, but that didn’t
prevent generations of programmers trying to shoehorn a class-based inheritance system onto it.</p>
<p>So… as soon as Rhai gained in usage, way way before version 1.0, PR’s started coming in to make
it possible to write Rhai in “the OOP way.”</p>
</div>
</div>
<h2 id="use-object-maps-to-simulate-oop"><a class="header" href="#use-object-maps-to-simulate-oop">Use Object Maps to Simulate OOP</a></h2>
<p>Rhai’s <a href="patterns//book/language/object-maps.html">object maps</a> has <a href="patterns//book/language/object-maps-oop.html">special support for OOP</a>.</p>
<div class="table-wrapper"><table><thead><tr><th>Rhai concept</th><th style="text-align: center">Maps to OOP</th></tr></thead><tbody>
<tr><td><a href="patterns//book/language/object-maps.html">Object maps</a></td><td style="text-align: center">objects</td></tr>
<tr><td><a href="patterns//book/language/object-maps.html">Object map</a> properties holding values</td><td style="text-align: center">properties</td></tr>
<tr><td><a href="patterns//book/language/object-maps.html">Object map</a> properties that hold <a href="patterns//book/language/fn-ptr.html">function pointers</a></td><td style="text-align: center">methods</td></tr>
</tbody></table>
</div>
<p>When a property of an <a href="patterns//book/language/object-maps.html">object map</a> is called like a method function, and if it happens to hold a
valid <a href="patterns//book/language/fn-ptr.html">function pointer</a> (perhaps defined via an <a href="patterns//book/language/fn-anon.html">anonymous function</a> or more commonly as a <a href="patterns//book/language/fn-closure.html">closure</a>),
then the call will be dispatched to the actual function with <code>this</code> binding to the
<a href="patterns//book/language/object-maps.html">object map</a> itself.</p>
<h2 id="use-closures-to-define-methods"><a class="header" href="#use-closures-to-define-methods">Use Closures to Define Methods</a></h2>
<p><a href="patterns//book/language/fn-closure.html">Closures</a> defined as values for <a href="patterns//book/language/object-maps.html">object map</a> properties take on a syntactic shape which resembles
very closely that of class methods in an OOP language.</p>
<p><a href="patterns//book/language/fn-closure.html">Closures</a> also <em>capture</em> <a href="patterns//book/language/variables.html">variables</a> from the defining environment, which is a very common language
feature.  It can be turned off via the <a href="patterns//book/start/features.html"><code>no_closure</code></a> feature.</p>
<pre><code class="language-rust">let factor = 1;

// Define the object
let obj = #{
        data: 0,                            // object field
        increment: |x| this.data += x,      // 'this' binds to 'obj'
        update: |x| this.data = x * factor, // 'this' binds to 'obj', 'factor' is captured
        action: || print(this.data)         // 'this' binds to 'obj'
    };

// Use the object
obj.increment(1);
obj.action();                               // prints 1

obj.update(42);
obj.action();                               // prints 42

factor = 2;

obj.update(42);
obj.action();                               // prints 84</code></pre>
<h2 id="simulating-inheritance-with-polyfills"><a class="header" href="#simulating-inheritance-with-polyfills">Simulating Inheritance with Polyfills</a></h2>
<p>The <code>fill_with</code> method of <a href="patterns//book/language/object-maps.html">object maps</a> can be conveniently used to <em>polyfill</em> default method
implementations from a <em>base class</em>, as per OOP lingo.</p>
<p>Do not use the <code>mixin</code> method because it <em>overwrites</em> existing fields.</p>
<pre><code class="language-rust">// Define base class
let BaseClass = #{
    factor: 1,
    data: 42,

    get_data: || this.data * 2,
    update: |x| this.data += x * this.factor
};

let obj = #{
    // Override base class field
    factor: 100,

    // Override base class method
    // Notice that the base class can also be accessed, if in scope
    get_data: || this.call(BaseClass.get_data) * 999,
}

// Polyfill missing fields/methods
obj.fill_with(BaseClass);

// By this point, 'obj' has the following:
//
// #{
//      factor: 100
//      data: 42,
//      get_data: || this.call(BaseClass.get_data) * 999,
//      update: |x| this.data += x * this.factor
// }

// obj.get_data() =&gt; (this.data (42) * 2) * 999
obj.get_data() == 83916;

obj.update(1);

obj.data == 142</code></pre>
<h2 id="prototypical-inheritance-via-mixin"><a class="header" href="#prototypical-inheritance-via-mixin">Prototypical Inheritance via Mixin</a></h2>
<p>Some languages like JavaScript has <em>prototypical</em> inheritance, which bases inheritance on a
<em>prototype</em> object.</p>
<p>It is possible to simulate this form of inheritance using <a href="patterns//book/language/object-maps.html">object maps</a>, leveraging the fact that,
in Rhai, all values are cloned and there are no pointers. This significantly simplifies coding logic.</p>
<pre><code class="language-rust">// Define prototype 'class'

const PrototypeClass = #{
    field: 42,

    get_field: || this.field,
    set_field: |x| this.field = x
};

// Create instances of the 'class'

let obj1 = PrototypeClass;                  // a copy of 'PrototypeClass'

obj1.get_field() == 42;

let obj2 = PrototypeClass;                  // a copy of 'PrototypeClass'

obj2.mixin(#{                               // override fields and methods
    field: 1,
    get_field: || this.field * 2
};

obj2.get_field() == 2;

let obj2 = PrototypeClass + #{              // compact syntax with '+'
    field: 1,
    get_field: || this.field * 2
};

obj2.get_field() == 2;

// Inheritance chain

const ParentClass = #{
    field: 123,
    new_field: 0,
    action: || print(this.new_field * this.field)
};

const ChildClass = #{
    action: || {
        this.field = this.new_field;
        this.new_field = ();
    }
}

let obj3 = PrototypeClass + ParentClass + ChildClass;

// Alternate formulation

const ParentClass = PrototypeClass + #{
    field: 123,
    new_field: 0,
    action: || print(this.new_field * this.field)
};

const ChildClass = ParentClass + #{
    action: || {
        this.field = this.new_field;
        this.new_field = ();
    }
}

let obj3 = ChildClass;                      // a copy of 'ChildClass'</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="scriptable-event-handler-with-state"><a class="header" href="#scriptable-event-handler-with-state">Scriptable Event Handler with State</a></h1>
<div id="admonition-important-pattern" class="admonition admonish-tip" role="note" aria-labelledby="admonition-important-pattern-title">
<div class="admonition-title">
<div id="admonition-important-pattern-title">
<p>IMPORTANT PATTERN</p>
</div>
<a class="admonition-anchor-link" href="patterns/events.html#admonition-important-pattern"></a>
</div>
<div>
<p>In many usage scenarios, a scripting engine is used to provide flexibility in event handling.</p>
<p>That means to execute certain <strong>actions</strong> in response to certain <strong><em>events</em></strong> that occur at run-time,
and scripts are used to provide flexibility for coding those actions.</p>
<p>You’d be surprised how many applications fit under this pattern – they are all essentially
event handling systems.</p>
</div>
</div>
<div id="admonition-examples" class="admonition admonish-example" role="note" aria-labelledby="admonition-examples-title">
<div class="admonition-title">
<div id="admonition-examples-title">
<p>Examples</p>
</div>
<a class="admonition-anchor-link" href="patterns/events.html#admonition-examples"></a>
</div>
<div>
<p>Because of the importance of this pattern, runnable examples are included.</p>
<p>See the <a href="patterns/../start/examples/rust.html"><em>Examples</em></a> section for details.</p>
</div>
</div>
<div id="admonition-usage-scenario" class="admonition admonish-info" role="note" aria-labelledby="admonition-usage-scenario-title">
<div class="admonition-title">
<div id="admonition-usage-scenario-title">
<p>Usage scenario</p>
</div>
<a class="admonition-anchor-link" href="patterns/events.html#admonition-usage-scenario"></a>
</div>
<div>
<ul>
<li>
<p>A system sends <em>events</em> that must be handled.</p>
</li>
<li>
<p>Flexibility in event handling must be provided, through user-side scripting.</p>
</li>
<li>
<p>State must be kept between invocations of event handlers.</p>
</li>
<li>
<p>State may be provided by the system or the user, or both.</p>
</li>
<li>
<p>Default implementations of event handlers can be provided.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-key-concepts" class="admonition admonish-abstract" role="note" aria-labelledby="admonition-key-concepts-title">
<div class="admonition-title">
<div id="admonition-key-concepts-title">
<p>Key concepts</p>
</div>
<a class="admonition-anchor-link" href="patterns/events.html#admonition-key-concepts"></a>
</div>
<div>
<ul>
<li>
<p>An <em>event handler</em> object is declared that holds the following items:</p>
<ul>
<li><a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> with registered functions serving as an API,</li>
<li><a href="patterns//book/engine/compile.html"><code>AST</code></a> of the user script,</li>
<li><a href="patterns//book/engine/scope.html"><code>Scope</code></a> containing system-provided default state.</li>
</ul>
</li>
<li>
<p>User-provided state is initialized by a <a href="patterns//book/language/functions.html">function</a> called via <a href="patterns//book/engine/call-fn.html"><code>Engine::call_fn_with_options</code></a>.</p>
</li>
<li>
<p>Upon an event, the appropriate event handler <a href="patterns//book/language/functions.html">function</a> in the script is called via
<a href="patterns//book/engine/call-fn.html"><code>Engine::call_fn</code></a>.</p>
</li>
<li>
<p>Optionally, trap the <code>EvalAltResult::ErrorFunctionNotFound</code> error to provide a default implementation.</p>
</li>
</ul>
</div>
</div>
<h2 id="basic-infrastructure"><a class="header" href="#basic-infrastructure">Basic Infrastructure</a></h2>
<h3 id="declare-handler-object"><a class="header" href="#declare-handler-object">Declare handler object</a></h3>
<p>In most cases, it would be simpler to store an <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> instance together with the handler object
because it only requires registering all API functions only once.</p>
<p>In rare cases where handlers are created and destroyed in a tight loop, a new <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> instance
can be created for each event. See <a href="patterns/parallel.html"><em>One Engine Instance Per Call</em></a> for more details.</p>
<pre><code class="language-rust">use rhai::{Engine, Scope, AST};

// Event handler
struct Handler {
    // Scripting engine
    pub engine: Engine,
    // Use a custom 'Scope' to keep stored state
    pub scope: Scope&lt;'static&gt;,
    // Program script
    pub ast: AST
}</code></pre>
<h3 id="register-api-for-custom-types"><a class="header" href="#register-api-for-custom-types">Register API for custom types</a></h3>
<p><a href="patterns//book/rust/custom-types.html">Custom types</a> are often used to hold state. The easiest way to register an entire API is via a <a href="patterns//book/plugins/module.html">plugin module</a>.</p>
<pre><code class="language-rust">use rhai::plugin::*;

// A custom type to a hold state value.
#[derive(Debug, Clone, Eq, PartialEq, Hash, Default)]
pub struct TestStruct {
    data: i64
}

// Plugin module containing API to TestStruct
#[export_module]
mod test_struct_api {
    #[rhai_fn(global)]
    pub fn new_state(value: i64) -&gt; TestStruct {
        TestStruct { data: value }
    }
    #[rhai_fn(global)]
    pub fn func1(obj: &amp;mut TestStruct) -&gt; bool {
                :
    }
    #[rhai_fn(global)]
    pub fn func2(obj: &amp;mut TestStruct) -&gt; i64 {
                :
    }
    pub fn process(data: i64) -&gt; i64 {
                :
    }
    #[rhai_fn(get = "value", pure)]
    pub fn get_value(obj: &amp;mut TestStruct) -&gt; i64 {
        obj.data
    }
    #[rhai_fn(set = "value")]
    pub fn set_value(obj: &amp;mut TestStruct, value: i64) {
        obj.data = value;
    }
}</code></pre>
<h3 id="initialize-handler-object"><a class="header" href="#initialize-handler-object">Initialize handler object</a></h3>
<p>Steps to initialize the event handler:</p>
<ol>
<li>Register an API with the <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a>,</li>
<li>Create a custom <a href="patterns//book/engine/scope.html"><code>Scope</code></a> to serve as the stored state,</li>
<li>Add default state <a href="patterns//book/language/variables.html">variables</a> into the custom <a href="patterns//book/engine/scope.html"><code>Scope</code></a>,</li>
<li>Optionally, call an initiation <a href="patterns//book/language/functions.html">function</a> to create new state <a href="patterns//book/language/variables.html">variables</a>;
<code>Engine::call_fn_with_options</code> is used instead of <code>Engine::call_fn</code> so that <a href="patterns//book/language/variables.html">variables</a> created
inside the <a href="patterns//book/language/functions.html">function</a> will not be removed from the custom <a href="patterns//book/engine/scope.html"><code>Scope</code></a> upon exit,</li>
<li>Get the handler script and <a href="patterns//book/engine/compile.html">compile</a> it,</li>
<li>Store the compiled <a href="patterns//book/engine/compile.html"><code>AST</code></a> for future evaluations,</li>
<li>Run the <a href="patterns//book/engine/compile.html"><code>AST</code></a> to initialize event handler state <a href="patterns//book/language/variables.html">variables</a>.</li>
</ol>
<pre><code class="language-rust">impl Handler {
    // Create a new 'Handler'.
    pub fn new(path: impl Into&lt;PathBuf&gt;) -&gt; Self {
        let mut engine = Engine::new();

        // Register custom types and APIs
        engine.register_type_with_name::&lt;TestStruct&gt;("TestStruct")
              .register_global_module(exported_module!(test_struct_api).into());

        // Create a custom 'Scope' to hold state
        let mut scope = Scope::new();

        // Add any system-provided state into the custom 'Scope'.
        // Constants can be used to optimize the script.
        scope.push_constant("MY_CONSTANT", 42_i64);

                    :
                    :
        // Initialize state variables
                    :
                    :

        // Compile the handler script.
        // In a real application you'd be handling errors...
        let ast = engine.compile_file_with_scope(&amp;mut scope, path).unwrap();

        // The event handler is essentially these three items:
        Self { engine, scope, ast }
    }
}</code></pre>
<h3 id="hook-up-events"><a class="header" href="#hook-up-events">Hook up events</a></h3>
<p>There is usually an interface or trait that gets called when an event comes from the system.</p>
<p>Mapping an event from the system into a scripted handler is straight-forward, via <code>Engine::call_fn</code>.</p>
<pre><code class="language-rust">impl Handler {
    // Say there are three events: 'start', 'end', 'update'.
    // In a real application you'd be handling errors...
    pub fn on_event(&amp;mut self, event_name: &amp;str, event_data: i64) -&gt; Dynamic {
        let engine = &amp;self.engine;
        let scope = &amp;mut self.scope;
        let ast = &amp;self.ast;

        match event_name {
            // The 'start' event maps to function 'start'.
            // In a real application you'd be handling errors...
            "start" =&gt; engine.call_fn(scope, ast, "start", (event_data,)).unwrap(),

            // The 'end' event maps to function 'end'.
            // In a real application you'd be handling errors...
            "end" =&gt; engine.call_fn(scope, ast, "end", (event_data,)).unwrap(),

            // The 'update' event maps to function 'update'.
            // This event provides a default implementation when the scripted function is not found.
            "update" =&gt;
                engine.call_fn(scope, ast, "update", (event_data,))
                      .or_else(|err| match *err {
                          EvalAltResult::ErrorFunctionNotFound(fn_name, _)
                              if fn_name.starts_with("update") =&gt;
                          {
                              // Default implementation of 'update' event handler.
                              self.scope.set_value("obj_state", TestStruct::new(42));
                              // Turn function-not-found into a success.
                              Ok(Dynamic::UNIT)
                          }
                          _ =&gt; Err(err)
                      }).unwrap(),

            // In a real application you'd be handling unknown events...
            _ =&gt; panic!("unknown event: {}", event_name)
        }
    }
}</code></pre>
<h2 id="scripting-styles"><a class="header" href="#scripting-styles">Scripting Styles</a></h2>
<p>Depending on needs and scripting style, there are three different ways to implement this pattern.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th style="text-align: center"><a href="patterns/events-1.html">Main style</a></th><th style="text-align: center"><a href="patterns/events-2.html">JS style</a></th><th style="text-align: center"><a href="patterns/events-3.html">Map style</a></th></tr></thead><tbody>
<tr><td>States store</td><td style="text-align: center">custom <a href="patterns//book/engine/scope.html"><code>Scope</code></a></td><td style="text-align: center"><a href="patterns//book/language/object-maps.html">object map</a> bound to <code>this</code></td><td style="text-align: center"><a href="patterns//book/language/object-maps.html">object map</a> in custom <a href="patterns//book/engine/scope.html"><code>Scope</code></a></td></tr>
<tr><td>Access state <a href="patterns//book/language/variables.html">variable</a></td><td style="text-align: center">normal <a href="patterns//book/language/variables.html">variable</a></td><td style="text-align: center"><a href="patterns//book/language/object-maps.html">property</a> of <code>this</code></td><td style="text-align: center"><a href="patterns//book/language/object-maps.html">property</a> of state variable</td></tr>
<tr><td>Access global <a href="patterns//book/language/constants.html">constants</a>?</td><td style="text-align: center">yes</td><td style="text-align: center">yes</td><td style="text-align: center">yes</td></tr>
<tr><td>Add new state <a href="patterns//book/language/variables.html">variable</a>?</td><td style="text-align: center"><code>init</code> <a href="patterns//book/language/functions.html">function</a> only</td><td style="text-align: center">all <a href="patterns//book/language/functions.html">functions</a></td><td style="text-align: center">all <a href="patterns//book/language/functions.html">functions</a></td></tr>
<tr><td>Add new global <a href="patterns//book/language/constants.html">constants</a>?</td><td style="text-align: center">yes</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td><a href="patterns//book/patterns/oop.html">OOP</a>-style <a href="patterns//book/language/functions.html">functions</a> on states?</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center">yes</td><td style="text-align: center">yes</td></tr>
<tr><td>Detect system-provided initial states?</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center">yes</td><td style="text-align: center">yes</td></tr>
<tr><td>Local <a href="patterns//book/language/variables.html">variable</a> may <em><a href="patterns//book/language/shadow.html">shadow</a></em> state <a href="patterns//book/language/variables.html">variable</a>?</td><td style="text-align: center">yes</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td>Benefits</td><td style="text-align: center">simple</td><td style="text-align: center">fewer surprises</td><td style="text-align: center">versatile</td></tr>
<tr><td>Disadvantages</td><td style="text-align: center"><ul><li>no new variables in <a href="patterns//book/language/functions.html">functions</a> (apart from <code>init</code>)</li><li>easy variable name collisions</li></ul></td><td style="text-align: center"><ul><li><code>this.xxx</code> all over the place</li><li>more complex implementation</li></ul></td><td style="text-align: center"><ul><li><code>state.xxx</code> all over the place</li><li>inconsistent syntax</li></ul></td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="scriptable-event-handler-with-statemain-style"><a class="header" href="#scriptable-event-handler-with-statemain-style">Scriptable Event Handler with State<br/>Main Style</a></h1>
<div id="admonition-example" class="admonition admonish-example" role="note" aria-labelledby="admonition-example-title">
<div class="admonition-title">
<div id="admonition-example-title">
<p>Example</p>
</div>
<a class="admonition-anchor-link" href="patterns/events-1.html#admonition-example"></a>
</div>
<div>
<p>A runnable example of this implementation is included.</p>
<p>See the <a href="patterns//book/start/examples/rust.html"><em>Examples</em></a> section for details.</p>
</div>
</div>
<h2 id="initialize-handler-instance-with-enginecall_fn_with_options"><a class="header" href="#initialize-handler-instance-with-enginecall_fn_with_options">Initialize Handler Instance with <code>Engine::call_fn_with_options</code></a></h2>
<p>Use <code>Engine::call_fn_with_options</code> instead of <code>Engine::call_fn</code> in order to retain new <a href="patterns//book/language/variables.html">variables</a>
defined inside the custom <a href="patterns//book/engine/scope.html"><code>Scope</code></a> when running the <code>init</code> function.</p>
<pre><code class="language-rust">impl Handler {
    // Create a new 'Handler'.
    pub fn new(path: impl Into&lt;PathBuf&gt;) -&gt; Self {
        let mut engine = Engine::new();

                    :
            // Code omitted
                    :

        // Run the 'init' function to initialize the state, retaining variables.
        let options = CallFnOptions::new()
                        .eval_ast(false)        // do not re-evaluate the AST
                        .rewind_scope(false);   // do not rewind scope

        // In a real application you'd again be handling errors...
        engine.call_fn_with_options(options, &amp;mut scope, &amp;ast, "init", ()).unwrap();

                    :
            // Code omitted
                    :

        Self { engine, scope, ast }
    }
}</code></pre>
<h2 id="handler-scripting-style"><a class="header" href="#handler-scripting-style">Handler Scripting Style</a></h2>
<p>Because the stored state is kept in a custom <a href="patterns//book/engine/scope.html"><code>Scope</code></a>, it is possible for all <a href="patterns//book/language/functions.html">functions</a> defined
in the handler script to access and modify these state variables.</p>
<p>The API registered with the <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> can be also used throughout the script.</p>
<h3 id="sample-script"><a class="header" href="#sample-script">Sample script</a></h3>
<pre><code class="language-js">/// Initialize user-provided state (shadows system-provided state, if any).
/// Because 'CallFnOptions::rewind_scope' is 'false', new variables introduced
/// will remain inside the custom 'Scope'.
fn init() {
    // Add 'bool_state' and 'obj_state' as new state variables
    let bool_state = false;
    let obj_state = new_state(0);

    // Constants can also be added!
    const EXTRA_CONSTANT = "hello, world!";
}

/// Without 'OOP' support, the can only be a function.
fn log(value, data) {
    print(`State = ${value}, data = ${data}`);
}

/// 'start' event handler
fn start(data) {
    if bool_state {
        throw "Already started!";
    }
    if obj_state.func1() || obj_state.func2() {
        throw "Conditions not yet ready to start!";
    }
    bool_state = true;
    obj_state.value = data;

    // Constants 'MY_CONSTANT' and 'EXTRA_CONSTANT'
    // in custom scope are also visible!
    print(`MY_CONSTANT = ${MY_CONSTANT}`);
    print(`EXTRA_CONSTANT = ${EXTRA_CONSTANT}`);
}

/// 'end' event handler
fn end(data) {
    if !bool_state {
        throw "Not yet started!";
    }
    if !obj_state.func1() &amp;&amp; !obj_state.func2() {
        throw "Conditions not yet ready to end!";
    }
    bool_state = false;
    obj_state.value = data;
}

/// 'update' event handler
fn update(data) {
    obj_state.value += process(data);

    // Without OOP support, can only call function
    log(obj_state.value, data);
}
</code></pre>
<h2 id="disadvantages-of-this-style"><a class="header" href="#disadvantages-of-this-style">Disadvantages of This Style</a></h2>
<p>This style is simple to implement and intuitive to use, but it is not very flexible.</p>
<p>New user state <a href="patterns//book/language/variables.html">variables</a> are introduced by evaluating a special initialization script <a href="patterns//book/language/functions.html">function</a>
(e.g. <code>init</code>) that defines them, and <code>Engine::call_fn_with_scope</code> is used to keep them inside the
custom <a href="patterns//book/engine/scope.html"><code>Scope</code></a> (together with setting <code>CallFnOptions::rewind_scope</code> to <code>false</code>).</p>
<p>However, this has the disadvantage that no other <a href="patterns//book/language/functions.html">function</a> can introduce new state <a href="patterns//book/language/variables.html">variables</a>,
otherwise they’d simply <em><a href="patterns//book/language/shadow.html">shadow</a></em> existing <a href="patterns//book/language/variables.html">variables</a> in the custom <a href="patterns//book/engine/scope.html"><code>Scope</code></a>.  Thus, <a href="patterns//book/language/functions.html">functions</a>
are called during events via <code>Engine::call_fn</code> which does not retain any <a href="patterns//book/language/variables.html">variables</a>.</p>
<p>When there are a large number of state <a href="patterns//book/language/variables.html">variables</a>, this style also makes it easy for local
<a href="patterns//book/language/variables.html">variables</a> defined in user <a href="patterns//book/language/functions.html">functions</a> to accidentally <em><a href="patterns//book/language/shadow.html">shadow</a></em> a state <a href="patterns//book/language/variables.html">variable</a> with a
<a href="patterns//book/language/variables.html">variable</a> that just happens to be the same name.</p>
<pre><code class="language-rust">// 'start' event handler
fn start(data) {
    let bool_state = false; // &lt;- oops! bad variable name!
        
        :                   // there is now no way to access the
        :                   // state variable 'bool_state'...

    if bool_state {         // &lt;- 'bool_state' is not the right thing
        ...                 //    unless this is what you actually want
    }

        :
        :
}</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="scriptable-event-handler-with-statejs-style"><a class="header" href="#scriptable-event-handler-with-statejs-style">Scriptable Event Handler with State<br/>JS Style</a></h1>
<div id="admonition-example" class="admonition admonish-example" role="note" aria-labelledby="admonition-example-title">
<div class="admonition-title">
<div id="admonition-example-title">
<p>Example</p>
</div>
<a class="admonition-anchor-link" href="patterns/events-2.html#admonition-example"></a>
</div>
<div>
<p>A runnable example of this implementation is included.</p>
<p>See the <a href="patterns//book/start/examples/rust.html"><em>Examples</em></a> section for details.</p>
</div>
</div>
<h2 id="keep-state-in-object-map"><a class="header" href="#keep-state-in-object-map">Keep State in Object Map</a></h2>
<p>This style allows defining new user state <a href="patterns//book/language/variables.html">variables</a> everywhere by packaging them all inside an
<a href="patterns//book/language/object-maps.html">object map</a>, which is then exposed via the <code>this</code> pointer.</p>
<p>Because this scripting style resembles JavaScript, it is so named.</p>
<p>State variables can be freely created by <em>all</em> <a href="patterns//book/language/functions.html">functions</a> (not just the <code>init</code> <a href="patterns//book/language/functions.html">function</a>).</p>
<p>The event handler type needs to hold this <a href="patterns//book/language/object-maps.html">object map</a> instead of a custom <a href="patterns//book/engine/scope.html"><code>Scope</code></a>.</p>
<pre><code class="language-rust">use rhai::{Engine, Scope, Dynamic, AST};

// Event handler
struct Handler {
    // Scripting engine
    pub engine: Engine,
    // The custom 'Scope' can be used to hold global constants
    pub scope: Scope&lt;'static&gt;,
    // Use an object map (as a 'Dynamic') to keep stored state
    pub states: Dynamic,
    // Program script
    pub ast: AST
}</code></pre>
<h2 id="bind-object-map-to-this-pointer"><a class="header" href="#bind-object-map-to-this-pointer">Bind Object Map to <code>this</code> Pointer</a></h2>
<p>Initialization can simply be done via binding the <a href="patterns//book/language/object-maps.html">object map</a> containing global states to the
<code>this</code> pointer.</p>
<pre><code class="language-rust">impl Handler {
    // Create a new 'Handler'.
    pub fn new(path: impl Into&lt;PathBuf&gt;) -&gt; Self {
        let mut engine = Engine::new();

                    :
            // Code omitted
                    :

        // Use an object map to hold state
        let mut states = Map::new();

        // Default states can be added
        states.insert("bool_state".into(), Dynamic::FALSE);

        // Convert the object map into 'Dynamic'
        let mut states: Dynamic = states.into();

        // Use 'call_fn_with_options' instead of 'call_fn' to bind the 'this' pointer
        let options = CallFnOptions::new()
                        .eval_ast(false)                // do not re-evaluate the AST
                        .rewind_scope(true)             // rewind scope
                        .bind_this_ptr(&amp;mut states);    // bind the 'this' pointer

        // In a real application you'd again be handling errors...
        engine.call_fn_with_options(options, &amp;mut scope, &amp;ast, "init", ()).unwrap();

                    :
            // Code omitted
                    :

        Self { engine, scope, states, ast }
    }
}</code></pre>
<h2 id="bind-this-pointer-during-events-handling"><a class="header" href="#bind-this-pointer-during-events-handling">Bind <code>this</code> Pointer During Events Handling</a></h2>
<p>Events handling should also use <code>Engine::call_fn_with_options</code> to bind the <a href="patterns//book/language/object-maps.html">object map</a> containing
global states to the <code>this</code> pointer via <code>CallFnOptions::this_ptr</code>.</p>
<pre><code class="language-rust">pub fn on_event(&amp;mut self, event_name: &amp;str, event_data: i64) -&gt; Dynamic {
    let engine = &amp;self.engine;
    let scope = &amp;mut self.scope;
    let states = &amp;mut self.states;
    let ast = &amp;self.ast;

    let options = CallFnOptions::new()
                    .eval_ast(false)                // do not re-evaluate the AST
                    .rewind_scope(true)             // rewind scope
                    .bind_this_ptr(&amp;mut states);    // bind the 'this' pointer

    match event_name {
        // In a real application you'd be handling errors...
        "start" =&gt; engine.call_fn_with_options(options, scope, ast, "start", (event_data,)).unwrap(),
            :
            :
    }
}</code></pre>
<h2 id="handler-scripting-style-1"><a class="header" href="#handler-scripting-style-1">Handler Scripting Style</a></h2>
<div id="admonition-no-shadowing" class="admonition admonish-note side" role="note" aria-labelledby="admonition-no-shadowing-title">
<div class="admonition-title">
<div id="admonition-no-shadowing-title">
<p>No shadowing</p>
</div>
<a class="admonition-anchor-link" href="patterns/events-2.html#admonition-no-shadowing"></a>
</div>
<div>
<p>Notice that <code>this</code> can never be <a href="patterns//book/language/shadow.html">shadowed</a> because it is not a valid <a href="patterns//book/language/variables.html">variable</a> name.</p>
</div>
</div>
<p>Because the stored state is kept in an <a href="patterns//book/language/object-maps.html">object map</a>, which in turn is bound to <code>this</code>, it is
necessary for <a href="patterns//book/language/functions.html">functions</a> to always access or modify these state <a href="patterns//book/language/variables.html">variables</a> via the <code>this</code> pointer.</p>
<p>As it is impossible to declare a local <a href="patterns//book/language/variables.html">variable</a> named <code>this</code>, there is no risk of accidentally
<em><a href="patterns//book/language/shadow.html">shadowing</a></em> a state <a href="patterns//book/language/variables.html">variable</a>.</p>
<p>Because an <a href="patterns//book/language/object-maps.html">object map</a> is used to hold state values, it is even possible to add user-defined
<a href="patterns//book/language/functions.html">functions</a>, leveraging the <a href="patterns//book/patterns/oop.html">OOP</a> support for <a href="patterns//book/language/object-maps.html">object maps</a>.</p>
<h3 id="sample-script-1"><a class="header" href="#sample-script-1">Sample script</a></h3>
<pre><code class="language-js">/// Initialize user-provided state.
/// State is stored inside an object map bound to 'this'.
fn init() {
    // Can detect system-provided default states!
    // Add 'bool_state' as new state variable if one does not exist
    if "bool_state" !in this {
        this.bool_state = false;
    }
    // Add 'obj_state' as new state variable (overwrites any existing)
    this.obj_state = new_state(0);

    // Can also add OOP-style functions!
    this.log = |x| print(`State = ${this.obj_state.value}, data = ${x}`);
}

/// 'start' event handler
fn start(data) {
    // Access state variables via 'this'
    if this.bool_state {
        throw "Already started!";
    }

    // New state variables can be created anywhere
    this.start_mode = data;

    if this.obj_state.func1() || this.obj_state.func2() {
        throw "Conditions not yet ready to start!";
    }
    this.bool_state = true;
    this.obj_state.value = data;

    // Constant 'MY_CONSTANT' in custom scope is also visible!
    print(`MY_CONSTANT = ${MY_CONSTANT}`);
}

/// 'end' event handler
fn end(data) {
    if !this.bool_state || !("start_mode" in this) {
        throw "Not yet started!";
    }
    if !this.obj_state.func1() &amp;&amp; !this.obj_state.func2() {
        throw "Conditions not yet ready to end!";
    }
    this.bool_state = false;
    this.obj_state.value = data;
}

/// 'update' event handler
fn update(data) {
    this.obj_state.value += process(data);

    // Call user-defined function OOP-style!
    this.log(data);
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="scriptable-event-handler-with-statemap-style"><a class="header" href="#scriptable-event-handler-with-statemap-style">Scriptable Event Handler with State<br/>Map Style</a></h1>
<div id="admonition-example" class="admonition admonish-example" role="note" aria-labelledby="admonition-example-title">
<div class="admonition-title">
<div id="admonition-example-title">
<p>Example</p>
</div>
<a class="admonition-anchor-link" href="patterns/events-3.html#admonition-example"></a>
</div>
<div>
<p>A runnable example of this implementation is included.</p>
<p>See the <a href="patterns//book/start/examples/rust.html"><em>Examples</em></a> section for details.</p>
</div>
</div>
<h2 id="i-hate-this--how-can-i-get-rid-of-it"><a class="header" href="#i-hate-this--how-can-i-get-rid-of-it">I Hate <code>this</code>!  How Can I Get Rid of It?</a></h2>
<p>You’re using Rust and you don’t want people to think you’re writing lowly JavaScript?</p>
<p>Taking inspiration from the <a href="patterns/events-2.html"><em>JS Style</em></a>, a slight modification of the
<a href="patterns/events-1.html"><em>Main Style</em></a> is to store all states inside an <a href="patterns//book/language/object-maps.html">object map</a> inside a custom <a href="patterns//book/engine/scope.html"><code>Scope</code></a>.</p>
<p>Nevertheless, instead of writing <code>this.variable_name</code> everywhere to access a state variable
(in the <a href="patterns/events-2.html"><em>JS Style</em></a>), you’d write <code>state.variable_name</code> instead.</p>
<p>It is up to you to decide whether this is an improvement!</p>
<h2 id="handler-initialization"><a class="header" href="#handler-initialization">Handler Initialization</a></h2>
<div id="admonition-no-shadowing-state" class="admonition admonish-note side" role="note" aria-labelledby="admonition-no-shadowing-state-title">
<div class="admonition-title">
<div id="admonition-no-shadowing-state-title">
<p>No shadowing ‘state’</p>
</div>
<a class="admonition-anchor-link" href="patterns/events-3.html#admonition-no-shadowing-state"></a>
</div>
<div>
<p>Notice that a <a href="patterns//book/engine/def-var.html">variable definition filter</a> is used to prevent <a href="patterns//book/language/shadow.html">shadowing</a> of the states <a href="patterns//book/language/object-maps.html">object map</a>.</p>
</div>
</div>
<p>Implementation wise, this style follows closely the <a href="patterns/events-1.html"><em>Main Style</em></a>, but a single
<a href="patterns//book/language/object-maps.html">object map</a> is added to the custom <a href="patterns//book/engine/scope.html"><code>Scope</code></a> which holds all state values.</p>
<p>Global <a href="patterns//book/language/constants.html">constants</a> can still be added to the custom <a href="patterns//book/engine/scope.html"><code>Scope</code></a> as normal and used through the script.</p>
<p>Calls to the <code>init</code> <a href="patterns//book/language/functions.html">function</a> no longer need to avoid rewinding the <a href="patterns//book/engine/scope.html"><code>Scope</code></a> because state
<a href="patterns//book/language/variables.html">variables</a> are added as properties under the states <a href="patterns//book/language/object-maps.html">object map</a>.</p>
<pre><code class="language-rust">impl Handler {
    // Create a new 'Handler'.
    pub fn new(path: impl Into&lt;PathBuf&gt;) -&gt; Self {
        let mut engine = Engine::new();

        // Forbid shadowing of 'state' variable
        engine.on_def_var(|_, info, _| Ok(info.name != "state"));

                    :
            // Code omitted
                    :

        // Use an object map to hold state
        let mut states = Map::new();

        // Default states can be added
        states.insert("bool_state".into(), Dynamic::FALSE);

        // Add the main states-holding object map and call it 'state'
        scope.push("state", states);

        // Just a simple 'call_fn' can do here because we're rewinding the 'Scope'
        // In a real application you'd again be handling errors...
        engine.call_fn(&amp;mut scope, &amp;ast, "init", ()).unwrap();

                    :
            // Code omitted
                    :

        Self { engine, scope, ast }
    }
}</code></pre>
<h2 id="handler-scripting-style-2"><a class="header" href="#handler-scripting-style-2">Handler Scripting Style</a></h2>
<p>The stored state is kept in an <a href="patterns//book/language/object-maps.html">object map</a> in the custom <a href="patterns//book/engine/scope.html"><code>Scope</code></a>.</p>
<p>In this example, that <a href="patterns//book/language/object-maps.html">object map</a> is named <code>state</code>, but it can be any name.</p>
<h3 id="user-defined-functions-in-state"><a class="header" href="#user-defined-functions-in-state">User-defined functions in state</a></h3>
<p>Because an <a href="patterns//book/language/object-maps.html">object map</a> is used to hold state values, it is even possible to add user-defined
<a href="patterns//book/language/functions.html">functions</a>, leveraging the <a href="patterns//book/patterns/oop.html">OOP</a> support for <a href="patterns//book/language/object-maps.html">object maps</a>.</p>
<p>However, within these user-defined <a href="patterns//book/language/functions.html">functions</a>, the <code>this</code> pointer binds to the <a href="patterns//book/language/object-maps.html">object map</a>.
Therefore, the variable-accessing syntax is different from the main body of the script.</p>
<pre><code class="language-js">fn do_action() {
    // Access state: `state.xxx`
    state.number = 42;

    // Add OOP functions - you still need to use `this`...
    state.log = |x| print(`State = ${this.value}, data = ${x}`);
}
</code></pre>
<h3 id="sample-script-2"><a class="header" href="#sample-script-2">Sample script</a></h3>
<pre><code class="language-js">/// Initialize user-provided state.
/// State is stored inside an object map bound to 'state'.
fn init() {
    // Add 'bool_state' as new state variable if one does not exist
    if "bool_state" !in state {
        state.bool_state = false;
    }
    // Add 'obj_state' as new state variable (overwrites any existing)
    state.obj_state = new_state(0);

    // Can also add OOP-style functions!
    state.log = |x| print(`State = ${this.obj_state.value}, data = ${x}`);
}

/// 'start' event handler
fn start(data) {
    // Can detect system-provided default states!
    // Access state variables in 'state'
    if state.bool_state {
        throw "Already started!";
    }

    // New values can be added to the state
    state.start_mode = data;

    if state.obj_state.func1() || state.obj_state.func2() {
        throw "Conditions not yet ready to start!";
    }
    state.bool_state = true;
    state.obj_state.value = data;

    // Constant 'MY_CONSTANT' in custom scope is also visible!
    print(`MY_CONSTANT = ${MY_CONSTANT}`);
}

/// 'end' event handler
fn end(data) {
    if !state.bool_state || "start_mode" !in state {
        throw "Not yet started!";
    }
    if !state.obj_state.func1() &amp;&amp; !state.obj_state.func2() {
        throw "Conditions not yet ready to end!";
    }
    state.bool_state = false;
    state.obj_state.value = data;
}

/// 'update' event handler
fn update(data) {
    state.obj_state.value += process(data);

    // Call user-defined function OOP-style!
    state.log(data);
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="scriptable-control-layer-over-rust-backend"><a class="header" href="#scriptable-control-layer-over-rust-backend">Scriptable Control Layer Over Rust Backend</a></h1>
<div id="admonition-usage-scenario" class="admonition admonish-info" role="note" aria-labelledby="admonition-usage-scenario-title">
<div class="admonition-title">
<div id="admonition-usage-scenario-title">
<p>Usage scenario</p>
</div>
<a class="admonition-anchor-link" href="patterns/control.html#admonition-usage-scenario"></a>
</div>
<div>
<ul>
<li>
<p>A system provides core functionalities, but no driving logic.</p>
</li>
<li>
<p>The driving logic must be dynamic and hot-loadable.</p>
</li>
<li>
<p>A script is used to drive the system and provide control intelligence.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-key-concepts" class="admonition admonish-abstract" role="note" aria-labelledby="admonition-key-concepts-title">
<div class="admonition-title">
<div id="admonition-key-concepts-title">
<p>Key concepts</p>
</div>
<a class="admonition-anchor-link" href="patterns/control.html#admonition-key-concepts"></a>
</div>
<div>
<ul>
<li>
<p>Expose a Control API.</p>
</li>
<li>
<p>Leverage <a href="patterns//book/rust/overloading.html">function overloading</a> to simplify the API design.</p>
</li>
<li>
<p>Since Rhai is <em><a href="patterns//book/safety/sandbox.html">sand-boxed</a></em>, it cannot mutate anything outside of its internal environment.
To perform external actions via an API, the actual system must be wrapped in a <code>RefCell</code>
(or <code>RwLock</code>/<code>Mutex</code> for <a href="patterns//book/start/features.html"><code>sync</code></a>) and shared to the <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a>.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-using-rhai-for-games" class="admonition admonish-danger" role="note" aria-labelledby="admonition-using-rhai-for-games-title">
<div class="admonition-title">
<div id="admonition-using-rhai-for-games-title">
<p>Using Rhai for games</p>
</div>
<a class="admonition-anchor-link" href="patterns/control.html#admonition-using-rhai-for-games"></a>
</div>
<div>
<p>Although this usage pattern appears a perfect fit for <em>game</em> logic, avoid writing the <em>entire game</em>
in Rhai.  Performance will not be acceptable.</p>
<p>Implement as much functionalities of the game engine in Rust as possible. Rhai integrates well with
Rust so this is usually not a hinderance.</p>
<p>Lift as much out of Rhai as possible. Use Rhai only for the logic that <em>must</em> be dynamic or
hot-loadable.</p>
</div>
</div>
<h2 id="implementation-2"><a class="header" href="#implementation-2">Implementation</a></h2>
<p>There are two broad ways for Rhai to control an external system, both of which involve wrapping the
system in a shared, interior-mutated object.</p>
<p>This is one way which does not involve exposing the data structures of the external system,
but only through exposing an abstract API primarily made up of functions.</p>
<p>Use this when the API is relatively simple and clean, and the number of functions is small enough.</p>
<p>For a complex API involving lots of functions, or an API that has a clear object structure, use the
<a href="patterns//book/patterns/singleton.html">Singleton Command Object</a> pattern instead.</p>
<h3 id="control-api"><a class="header" href="#control-api">Control API</a></h3>
<p>Assume that a system provides the following API:</p>
<pre><code class="language-rust">struct EnergizerBunny;

impl EnergizerBunny {
    pub fn new () -&gt; Self { ... }
    pub fn go (&amp;mut self) { ... }
    pub fn stop (&amp;mut self) { ... }
    pub fn is_going (&amp;self) { ... }
    pub fn get_speed (&amp;self) -&gt; i64 { ... }
    pub fn set_speed (&amp;mut self, speed: i64) { ... }
}</code></pre>
<h3 id="wrap-api-in-shared-object"><a class="header" href="#wrap-api-in-shared-object">Wrap API in shared object</a></h3>
<pre><code class="language-rust">pub type SharedBunny = Rc&lt;RefCell&lt;EnergizerBunny&gt;&gt;;</code></pre>
<p>or in multi-threaded environments with the <a href="patterns//book/start/features.html"><code>sync</code></a> feature, use one of the following:</p>
<pre><code class="language-rust">pub type SharedBunny = Arc&lt;RwLock&lt;EnergizerBunny&gt;&gt;;

pub type SharedBunny = Arc&lt;Mutex&lt;EnergizerBunny&gt;&gt;;</code></pre>
<h3 id="register-control-api"><a class="header" href="#register-control-api">Register control API</a></h3>
<p>The trick to building a Control API is to clone the shared API object and
move it into each function registration via a closure.</p>
<p>Therefore, it is not possible to use a <a href="patterns//book/plugins/module.html">plugin module</a> to achieve this, and each function must be
registered one after another.</p>
<pre><code class="language-rust">// Notice 'move' is used to move the shared API object into the closure.
let b = bunny.clone();
engine.register_fn("bunny_power", move |on: bool| {
    if on {
        if b.borrow().is_going() {
            println!("Still going...");
        } else {
            b.borrow_mut().go();
        }
    } else {
        if b.borrow().is_going() {
            b.borrow_mut().stop();
        } else {
            println!("Already out of battery!");
        }
    }
});

let b = bunny.clone();
engine.register_fn("bunny_is_going", move || b.borrow().is_going());

let b = bunny.clone();
engine.register_fn("bunny_get_speed", move ||
    if b.borrow().is_going() { b.borrow().get_speed() } else { 0 }
);

let b = bunny.clone();
engine.register_fn("bunny_set_speed", move |speed: i64| -&gt; Result&lt;_, Box&lt;EvalAltResult&gt;&gt;
    if speed &lt;= 0 {
        return Err("Speed must be positive!".into());
    } else if speed &gt; 100 {
        return Err("Bunny will be going too fast!".into());
    }

    if b.borrow().is_going() {
        b.borrow_mut().set_speed(speed)
    } else {
        return Err("Bunny is not yet going!".into());
    }

    Ok(())
);</code></pre>
<h3 id="use-the-api"><a class="header" href="#use-the-api">Use the API</a></h3>
<pre><code class="language-rust">if !bunny_is_going() { bunny_power(true); }

if bunny_get_speed() &gt; 50 { bunny_set_speed(50); }</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="singleton-command-object"><a class="header" href="#singleton-command-object">Singleton Command Object</a></h1>
<div id="admonition-usage-scenario" class="admonition admonish-info" role="note" aria-labelledby="admonition-usage-scenario-title">
<div class="admonition-title">
<div id="admonition-usage-scenario-title">
<p>Usage scenario</p>
</div>
<a class="admonition-anchor-link" href="patterns/singleton.html#admonition-usage-scenario"></a>
</div>
<div>
<ul>
<li>
<p>A system provides core functionalities, but no driving logic.</p>
</li>
<li>
<p>The driving logic must be dynamic and hot-loadable.</p>
</li>
<li>
<p>A script is used to drive the system and provide control intelligence.</p>
</li>
<li>
<p>The API is multiplexed, meaning that it can act on multiple system-provided entities, or</p>
</li>
<li>
<p>The API lends itself readily to an object-oriented (OO) representation.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-key-concepts" class="admonition admonish-abstract" role="note" aria-labelledby="admonition-key-concepts-title">
<div class="admonition-title">
<div id="admonition-key-concepts-title">
<p>Key concepts</p>
</div>
<a class="admonition-anchor-link" href="patterns/singleton.html#admonition-key-concepts"></a>
</div>
<div>
<ul>
<li>
<p>Expose a Command type with an API.  The <a href="patterns//book/start/features.html"><code>no_object</code></a> feature must not be on.</p>
</li>
<li>
<p>Leverage <a href="patterns//book/rust/overloading.html">function overloading</a> to simplify the API design.</p>
</li>
<li>
<p>Since Rhai is <em><a href="patterns//book/safety/sandbox.html">sand-boxed</a></em>, it cannot mutate anything outside of its internal environment.
To perform external actions via an API, the command object type must be wrapped in a <code>RefCell</code>
(or <code>RwLock</code>/<code>Mutex</code> for <a href="patterns//book/start/features.html"><code>sync</code></a>) and shared to the <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a>.</p>
</li>
<li>
<p>Load each command object into a custom <a href="patterns//book/engine/scope.html"><code>Scope</code></a> as constant variables.</p>
</li>
<li>
<p>Control each command object in script via the constants.</p>
</li>
</ul>
</div>
</div>
<h2 id="implementation-3"><a class="header" href="#implementation-3">Implementation</a></h2>
<p>There are two broad ways for Rhai to control an external system, both of which involve wrapping the
system in a shared, interior-mutated object.</p>
<p>This is the other way which involves directly exposing the data structures of the external system as
a name singleton object in the scripting space.</p>
<p>Use this when the API is complex but has a clear object structure.</p>
<p>For a relatively simple API that is action-based and not object-based, use the
<a href="patterns//book/patterns/control.html">Control Layer</a> pattern instead.</p>
<h3 id="control-api-1"><a class="header" href="#control-api-1">Control API</a></h3>
<p>Assume the following command object type:</p>
<pre><code class="language-rust">struct EnergizerBunny { ... }

impl EnergizerBunny {
    pub fn new () -&gt; Self { ... }
    pub fn go (&amp;mut self) { ... }
    pub fn stop (&amp;mut self) { ... }
    pub fn is_going (&amp;self) -&gt; bool { ... }
    pub fn get_speed (&amp;self) -&gt; i64 { ... }
    pub fn set_speed (&amp;mut self, speed: i64) { ... }
    pub fn turn (&amp;mut self, left_turn: bool) { ... }
}</code></pre>
<h3 id="wrap-command-object-type-as-shared"><a class="header" href="#wrap-command-object-type-as-shared">Wrap command object type as shared</a></h3>
<pre><code class="language-rust">pub type SharedBunny = Rc&lt;RefCell&lt;EnergizerBunny&gt;&gt;;</code></pre>
<p>or in multi-threaded environments with the <a href="patterns//book/start/features.html"><code>sync</code></a> feature, use one of the following:</p>
<pre><code class="language-rust">pub type SharedBunny = Arc&lt;RwLock&lt;EnergizerBunny&gt;&gt;;

pub type SharedBunny = Arc&lt;Mutex&lt;EnergizerBunny&gt;&gt;;</code></pre>
<h3 id="develop-a-plugin-with-methods-and-getterssetters"><a class="header" href="#develop-a-plugin-with-methods-and-getterssetters">Develop a plugin with methods and getters/setters</a></h3>
<p>The easiest way to develop a complete set of API for a <a href="patterns//book/rust/custom-types.html">custom type</a> is via a <a href="patterns//book/plugins/module.html">plugin module</a>.</p>
<p>Notice that putting <code>pure</code> in <code>#[rhai_fn(...)]</code> allows a <a href="patterns//book/rust/getters-setters.html">getter/setter</a> to operate
on a <a href="patterns//book/language/constants.html">constant</a> without raising an error.  Therefore, it is needed on <em>all</em> functions.</p>
<pre><code class="language-rust">use rhai::plugin::*;

// Remember to put 'pure' on all functions, or they'll choke on constants!

#[export_module]
pub mod bunny_api {
    // Custom type 'SharedBunny' will be called 'EnergizerBunny' in scripts
    pub type EnergizerBunny = SharedBunny;

    // This constant is also available to scripts
    pub const MAX_SPEED: i64 = 100;

    #[rhai_fn(get = "power", pure)]
    pub fn get_power(bunny: &amp;mut EnergizerBunny) -&gt; bool {
        bunny.borrow().is_going()
    }
    #[rhai_fn(set = "power", pure)]
    pub fn set_power(bunny: &amp;mut EnergizerBunny, on: bool) {
        if on {
            if bunny.borrow().is_going() {
                println!("Still going...");
            } else {
                bunny.borrow_mut().go();
            }
        } else {
            if bunny.borrow().is_going() {
                bunny.borrow_mut().stop();
            } else {
                println!("Already out of battery!");
            }
        }
    }
    #[rhai_fn(get = "speed", pure)]
    pub fn get_speed(bunny: &amp;mut EnergizerBunny) -&gt; i64 {
        if bunny.borrow().is_going() {
            bunny.borrow().get_speed()
        } else {
            0
        }
    }
    #[rhai_fn(set = "speed", pure, return_raw)]
    pub fn set_speed(bunny: &amp;mut EnergizerBunny, speed: i64)
            -&gt; Result&lt;(), Box&lt;EvalAltResult&gt;&gt;
    {
        if speed &lt;= 0 {
            Err("Speed must be positive!".into())
        } else if speed &gt; MAX_SPEED {
            Err("Bunny will be going too fast!".into())
        } else if !bunny.borrow().is_going() {
            Err("Bunny is not yet going!".into())
        } else {
            b.borrow_mut().set_speed(speed);
            Ok(())
        }
    }
    #[rhai_fn(pure)]
    pub fn turn_left(bunny: &amp;mut EnergizerBunny) {
        if bunny.borrow().is_going() {
            bunny.borrow_mut().turn(true);
        }
    }
    #[rhai_fn(pure)]
    pub fn turn_right(bunny: &amp;mut EnergizerBunny) {
        if bunny.borrow().is_going() {
            bunny.borrow_mut().turn(false);
        }
    }
}

engine.register_global_module(exported_module!(bunny_api).into());</code></pre>
<div id="admonition-tip-friendly-name-for-custom-type" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-friendly-name-for-custom-type-title">
<div class="admonition-title">
<div id="admonition-tip-friendly-name-for-custom-type-title">
<p>Tip: Friendly name for custom type</p>
</div>
<a class="admonition-anchor-link" href="patterns/singleton.html#admonition-tip-friendly-name-for-custom-type"></a>
</div>
<div>
<p>It is customary to register a <em>friendly display name</em> for any <a href="patterns//book/rust/custom-types.html">custom type</a>
involved in the plugin.</p>
<p>This can easily be done via a <em>type alias</em> in the plugin module.</p>
</div>
</div>
<h3 id="compile-script-into-ast"><a class="header" href="#compile-script-into-ast">Compile script into AST</a></h3>
<pre><code class="language-rust">let ast = engine.compile(script)?;</code></pre>
<h3 id="push-constant-command-object-into-custom-scope-and-run-ast"><a class="header" href="#push-constant-command-object-into-custom-scope-and-run-ast">Push constant command object into custom scope and run AST</a></h3>
<pre><code class="language-rust">let bunny: SharedBunny = Rc::new(RefCell::new(EnergizerBunny::new()));

let mut scope = Scope::new();

// Add the singleton command object into a custom Scope.
// Constants, as a convention, are named with all-capital letters.
scope.push_constant("BUNNY", bunny.clone());

// Run the compiled AST
engine.run_ast_with_scope(&amp;mut scope, &amp;ast)?;

// Running the script directly, as below, is less desirable because
// the constant 'BUNNY' will be propagated and copied into each usage
// during the script optimization step
engine.run_with_scope(&amp;mut scope, script)?;</code></pre>
<div id="admonition-tip-prevent-shadowing" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-prevent-shadowing-title">
<div class="admonition-title">
<div id="admonition-tip-prevent-shadowing-title">
<p>Tip: Prevent shadowing</p>
</div>
<a class="admonition-anchor-link" href="patterns/singleton.html#admonition-tip-prevent-shadowing"></a>
</div>
<div>
<p>It is usually desirable to prevent <a href="patterns//book/language/shadow.html">shadowing</a> of the singleton command object.</p>
<p>This can be easily achieved via a <a href="patterns//book/engine/def-var.html">variable definition filter</a>.</p>
<pre><code class="language-rust">// Now the script can no longer define a variable named 'BUNNY'
engine.on_def_var(|_, info, _| Ok(info.name != "BUNNY"));</code></pre>
</div>
</div>
<h3 id="use-the-command-api-in-script"><a class="header" href="#use-the-command-api-in-script">Use the command API in script</a></h3>
<pre><code class="language-rust">// Access the command object via constant variable 'BUNNY'.

if !BUNNY.power { BUNNY.power = true; }

if BUNNY.speed &gt; 50 { BUNNY.speed = 50; }

BUNNY.turn_left();

let BUNNY = 42;     // &lt;- syntax error if variable definition filter is set</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="loadable-configuration"><a class="header" href="#loadable-configuration">Loadable Configuration</a></h1>
<div id="admonition-usage-scenario" class="admonition admonish-info" role="note" aria-labelledby="admonition-usage-scenario-title">
<div class="admonition-title">
<div id="admonition-usage-scenario-title">
<p>Usage scenario</p>
</div>
<a class="admonition-anchor-link" href="patterns/config.html#admonition-usage-scenario"></a>
</div>
<div>
<ul>
<li>
<p>A system where settings and configurations are complex and logic-driven.</p>
</li>
<li>
<p>Where said system is too complex to configure via standard configuration file formats such as
<code>JSON</code>, <code>TOML</code> or <code>YAML</code>.</p>
</li>
<li>
<p>The system is complex enough to require a full programming language to configure.
Essentially <em>configuration by code</em>.</p>
</li>
<li>
<p>Yet the configuration must be flexible, late-bound and dynamically loadable, just like a
configuration file.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-key-concepts" class="admonition admonish-abstract" role="note" aria-labelledby="admonition-key-concepts-title">
<div class="admonition-title">
<div id="admonition-key-concepts-title">
<p>Key concepts</p>
</div>
<a class="admonition-anchor-link" href="patterns/config.html#admonition-key-concepts"></a>
</div>
<div>
<ul>
<li>
<p>Leverage the loadable <a href="patterns//book/rust/modules/index.html">modules</a> of Rhai.  The <a href="patterns//book/start/features.html"><code>no_module</code></a> feature must not be on.</p>
</li>
<li>
<p>Expose the configuration API.  Use separate scripts to configure that API.
Dynamically load scripts via the <code>import</code> statement.</p>
</li>
<li>
<p>Leverage <a href="patterns//book/rust/overloading.html">function overloading</a> to simplify the API design.</p>
</li>
<li>
<p>Since Rhai is <em>sand-boxed</em>, it cannot mutate the environment.  To modify the external
configuration object via an API, it must be wrapped in a <code>RefCell</code> (or <code>RwLock</code>/<code>Mutex</code> for
<a href="patterns//book/start/features.html"><code>sync</code></a>) and shared to the <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a>.</p>
</li>
</ul>
</div>
</div>
<h2 id="implementation-4"><a class="header" href="#implementation-4">Implementation</a></h2>
<h3 id="configuration-type"><a class="header" href="#configuration-type">Configuration type</a></h3>
<pre><code class="language-rust">#[derive(Debug, Clone, Default)]
struct Config {
    id: String,
    some_field: i64,
    some_list: Vec&lt;String&gt;,
    some_map: HashMap&lt;String, bool&gt;,
}</code></pre>
<h3 id="make-shared-object"><a class="header" href="#make-shared-object">Make shared object</a></h3>
<pre><code class="language-rust">type SharedConfig = Rc&lt;RefCell&lt;Config&gt;&gt;;

let config = SharedConfig::default();</code></pre>
<p>or in multi-threaded environments with the <a href="patterns//book/start/features.html"><code>sync</code></a> feature, use one of the following:</p>
<pre><code class="language-rust">type SharedConfig = Arc&lt;RwLock&lt;Config&gt;&gt;;

type SharedConfig = Arc&lt;Mutex&lt;Config&gt;&gt;;</code></pre>
<h3 id="register-config-api"><a class="header" href="#register-config-api">Register config API</a></h3>
<p>The trick to building a Config API is to clone the shared configuration object and move it into each
function registration via a closure.</p>
<p>Therefore, it is not possible to use a <a href="patterns//book/plugins/module.html">plugin module</a> to achieve this, and each function must be
registered one after another.</p>
<pre><code class="language-rust">// Notice 'move' is used to move the shared configuration object into the closure.
let cfg = config.clone();
engine.register_fn("config_set_id", move |id: String| cfg.borrow_mut().id = id);

let cfg = config.clone();
engine.register_fn("config_get_id", move || cfg.borrow().id.clone());

let cfg = config.clone();
engine.register_fn("config_set", move |value: i64| cfg.borrow_mut().some_field = value);

// Remember Rhai functions can be overloaded when designing the API.

let cfg = config.clone();
engine.register_fn("config_add", move |value: String|
    cfg.borrow_mut().some_list.push(value)
);

let cfg = config.clone();
engine.register_fn("config_add", move |values: &amp;mut Array|
    cfg.borrow_mut().some_list.extend(values.into_iter().map(|v| v.to_string()))
);

let cfg = config.clone();
engine.register_fn("config_add", move |key: String, value: bool|
    cfg.borrow_mut().some_map.insert(key, value)
);

let cfg = config.clone();
engine.register_fn("config_contains", move |value: String|
    cfg.borrow().some_list.contains(&amp;value)
);

let cfg = config.clone();
engine.register_fn("config_is_set", move |value: String|
    cfg.borrow().some_map.get(&amp;value).cloned().unwrap_or(false)
);</code></pre>
<h3 id="configuration-script"><a class="header" href="#configuration-script">Configuration script</a></h3>
<pre><code class="language-rust">┌────────────────┐
│ my_config.rhai │
└────────────────┘

config_set_id("hello");

config_add("foo");          // add to list
config_add("bar", true);    // add to map

if config_contains("hey") || config_is_set("hey") {
    config_add("baz", false);   // add to map
}</code></pre>
<h3 id="load-the-configuration"><a class="header" href="#load-the-configuration">Load the configuration</a></h3>
<pre><code class="language-rust">import "my_config";         // run configuration script without creating a module

let id = config_get_id();

id == "hello";</code></pre>
<h2 id="consider-a-custom-syntax"><a class="header" href="#consider-a-custom-syntax">Consider a Custom Syntax</a></h2>
<p>This is probably one of the few scenarios where a <a href="patterns//book/engine/custom-syntax.html">custom syntax</a> can be recommended.</p>
<p>A properly-designed <a href="patterns//book/engine/custom-syntax.html">custom syntax</a> can make the configuration file clean, simple to write,
easy to understand and quick to modify.</p>
<p>For example, the above configuration example may be expressed by this custom syntax:</p>
<pre><code class="language-rust">┌────────────────┐
│ my_config.rhai │
└────────────────┘

// Configure ID
id "hello";

// Add to list
list + "foo";

// Add to map
map "bar" =&gt; true;

if config contains "hey" || config is_set "hey" {
    map "baz" =&gt; false;
}</code></pre>
<p>Notice that <code>contains</code> and <code>is_set</code> may also be implemented as a <a href="patterns//book/engine/custom-op.html">custom operator</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="multi-layered-functions"><a class="header" href="#multi-layered-functions">Multi-Layered Functions</a></h1>
<div id="admonition-usage-scenario" class="admonition admonish-info" role="note" aria-labelledby="admonition-usage-scenario-title">
<div class="admonition-title">
<div id="admonition-usage-scenario-title">
<p>Usage scenario</p>
</div>
<a class="admonition-anchor-link" href="patterns/multi-layer.html#admonition-usage-scenario"></a>
</div>
<div>
<ul>
<li>
<p>A system is divided into separate <em>layers</em>, each providing logic in terms of scripted <a href="patterns//book/language/functions.html">functions</a>.</p>
</li>
<li>
<p>A lower layer provides <em>default implementations</em> of certain <a href="patterns//book/language/functions.html">functions</a>.</p>
</li>
<li>
<p>Higher layers each provide progressively more specific implementations of the same <a href="patterns//book/language/functions.html">functions</a>.</p>
</li>
<li>
<p>A more specific <a href="patterns//book/language/functions.html">function</a>, if defined in a higher layer, always overrides the implementation
in a lower layer.</p>
</li>
<li>
<p>This is akin to object-oriented programming but with <a href="patterns//book/language/functions.html">functions</a>.</p>
</li>
<li>
<p>This type of system is extremely convenient for dynamic business rules configuration, setting
corporate-wide policies, granting permissions for specific roles etc. where specific, local rules
need to override corporate-wide defaults.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-practical-scenario" class="admonition admonish-tip" role="note" aria-labelledby="admonition-practical-scenario-title">
<div class="admonition-title">
<div id="admonition-practical-scenario-title">
<p>Practical scenario</p>
</div>
<a class="admonition-anchor-link" href="patterns/multi-layer.html#admonition-practical-scenario"></a>
</div>
<div>
<p>Assuming a LOB (line-of-business) system for a large MNC (multi-national corporation) with branches,
facilities and offices across the globe.</p>
<p>The system needs to provide basic, corporate-wide policies to be enforced through the worldwide
organization, but also cater for country- or region-specific rules, practices and regulations.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Layer</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>corporate</code></td><td>corporate-wide policies</td></tr>
<tr><td style="text-align: center"><code>regional</code></td><td>regional policy overrides</td></tr>
<tr><td style="text-align: center"><code>country</code></td><td>country-specific modifications for legal compliance</td></tr>
<tr><td style="text-align: center"><code>office</code></td><td>special treatments for individual office locations</td></tr>
</tbody></table>
</div></div>
</div>
<div id="admonition-key-concepts" class="admonition admonish-abstract" role="note" aria-labelledby="admonition-key-concepts-title">
<div class="admonition-title">
<div id="admonition-key-concepts-title">
<p>Key concepts</p>
</div>
<a class="admonition-anchor-link" href="patterns/multi-layer.html#admonition-key-concepts"></a>
</div>
<div>
<ul>
<li>
<p>Each layer is a separate script.</p>
</li>
<li>
<p>The lowest layer script is compiled into a base <a href="patterns//book/engine/compile.html"><code>AST</code></a>.</p>
</li>
<li>
<p>Higher layer scripts are also compiled into <a href="patterns//book/engine/compile.html"><code>AST</code></a> and <em>combined</em> into the base using
<a href="patterns//book/engine/ast.html"><code>AST::combine</code></a> (or the <code>+=</code> operator), overriding any existing <a href="patterns//book/language/functions.html">functions</a>.</p>
</li>
</ul>
</div>
</div>
<h2 id="examples-17"><a class="header" href="#examples-17">Examples</a></h2>
<p>Assume the following four scripts, one for each layer:</p>
<pre><code class="language-rust">┌────────────────┐
│ corporate.rhai │
└────────────────┘

// Default implementation of 'foo'.
fn foo(x) { x + 1 }

// Default implementation of 'bar'.
fn bar(x, y) { x + y }

// Default implementation of 'no_touch'.
fn no_touch() { throw "do not touch me!"; }


┌───────────────┐
│ regional.rhai │
└───────────────┘

// Specific implementation of 'foo'.
fn foo(x) { x * 2 }

// New implementation for this layer.
fn baz() { print("hello!"); }


┌──────────────┐
│ country.rhai │
└──────────────┘

// Specific implementation of 'bar'.
fn bar(x, y) { x - y }

// Specific implementation of 'baz'.
fn baz() { print("hey!"); }


┌─────────────┐
│ office.rhai │
└─────────────┘

// Specific implementation of 'foo'.
fn foo(x) { x + 42 }</code></pre>
<p>Load and combine them sequentially:</p>
<pre><code class="language-rust">let engine = Engine::new();

// Compile the baseline layer.
let mut ast = engine.compile_file("corporate.rhai".into())?;

// Combine the first layer.
let lowest = engine.compile_file("regional.rhai".into())?;
ast += lowest;

// Combine the second layer.
let middle = engine.compile_file("country.rhai".into())?;
ast += middle;

// Combine the third layer.
let highest = engine.compile_file("office.rhai".into())?;
ast += highest;

// Now, 'ast' contains the following functions:
//
// fn no_touch() {                // from 'corporate.rhai'
//     throw "do not touch me!";
// }
// fn foo(x) { x + 42 }           // from 'office.rhai'
// fn bar(x, y) { x - y }         // from 'country.rhai'
// fn baz() { print("hey!"); }    // from 'country.rhai'</code></pre>
<div id="admonition-no-super-call" class="admonition admonish-failure small" role="note" aria-labelledby="admonition-no-super-call-title">
<div class="admonition-title">
<div id="admonition-no-super-call-title">
<p>No super call</p>
</div>
<a class="admonition-anchor-link" href="patterns/multi-layer.html#admonition-no-super-call"></a>
</div>
<div>
<p>Unfortunately, there is no <code>super</code> call that calls the base implementation (i.e. no way for a
higher-layer function to call an equivalent lower-layer function).</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hot-reloading"><a class="header" href="#hot-reloading">Hot Reloading</a></h1>
<div id="admonition-usage-scenario" class="admonition admonish-info" role="note" aria-labelledby="admonition-usage-scenario-title">
<div class="admonition-title">
<div id="admonition-usage-scenario-title">
<p>Usage scenario</p>
</div>
<a class="admonition-anchor-link" href="patterns/hot-reload.html#admonition-usage-scenario"></a>
</div>
<div>
<ul>
<li>
<p>A system where scripts are used for behavioral control.</p>
</li>
<li>
<p>All or parts of the control scripts need to be modified dynamically without re-initializing the
host system.</p>
</li>
<li>
<p>New scripts must be active as soon as possible after modifications are detected.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-key-concepts" class="admonition admonish-abstract" role="note" aria-labelledby="admonition-key-concepts-title">
<div class="admonition-title">
<div id="admonition-key-concepts-title">
<p>Key concepts</p>
</div>
<a class="admonition-anchor-link" href="patterns/hot-reload.html#admonition-key-concepts"></a>
</div>
<div>
<ul>
<li>
<p>The Rhai <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> is <em>re-entrant</em>, meaning that it is decoupled from scripts.</p>
</li>
<li>
<p>A new script only needs to be recompiled and the new <a href="patterns//book/engine/compile.html"><code>AST</code></a> replaces the old for new behaviors
to be active.</p>
</li>
<li>
<p>Surgically <em>patch</em> scripts when only parts of the scripts are modified.</p>
</li>
</ul>
</div>
</div>
<h2 id="implementation-5"><a class="header" href="#implementation-5">Implementation</a></h2>
<h3 id="embed-scripting-engine-and-script-into-system"><a class="header" href="#embed-scripting-engine-and-script-into-system">Embed scripting engine and script into system</a></h3>
<p>Say, a system has a Rhai <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> plus a compiled script (in <a href="patterns//book/engine/compile.html"><code>AST</code></a> form), with the <a href="patterns//book/engine/compile.html"><code>AST</code></a> kept
with interior mutability…</p>
<pre><code class="language-rust">// Main system object
struct System {
    engine: Engine,
    script: Rc&lt;RefCell&lt;AST&gt;&gt;,
      :
}

// Embed Rhai 'Engine' and control script
let engine = Engine::new();
let ast = engine.compile_file("config.rhai")?;

let mut system = System { engine, script: Rc::new(RefCell::new(ast)) };

// Handle events with script functions
system.on_event(|sys: &amp;System, event: &amp;str, data: Map| {
    let mut scope = Scope::new();

    // Call script function which is the same name as the event
    sys.engine.call_fn(&amp;mut scope, sys.script.borrow(), event, (data,)).unwrap();

    result
});</code></pre>
<h3 id="hot-reload-entire-script-upon-change"><a class="header" href="#hot-reload-entire-script-upon-change">Hot reload entire script upon change</a></h3>
<p>If the control scripts are small enough and changes are infrequent, it is much simpler just to
recompile the whole set of script and replace the original <a href="patterns//book/engine/compile.html"><code>AST</code></a> with the new one.</p>
<pre><code class="language-rust">// Watch for script file change
system.watch(|sys: &amp;System, file: &amp;str| {
    // Compile the new script
    let ast = sys.engine.compile_file(file.into())?;

    // Hot reload - just replace the old script!
    *sys.script.borrow_mut() = ast;

    Ok(())
});</code></pre>
<h3 id="hot-patch-specific-functions"><a class="header" href="#hot-patch-specific-functions">Hot patch specific functions</a></h3>
<p>If the control scripts are large and complicated, and if the system can detect changes to specific <a href="patterns//book/language/functions.html">functions</a>,
it is also possible to <em>patch</em> just the changed <a href="patterns//book/language/functions.html">functions</a>.</p>
<pre><code class="language-rust">// Watch for changes in the script
system.watch_for_script_change(|sys: &amp;mut System, fn_name: &amp;str| {
    // Get the script file that contains the function
    let script = get_script_file_path(fn_name);

    // Compile the new script
    let mut patch_ast = sys.engine.compile_file(script)?;

    // Remove everything other than the specified function
    patch_ast.clear_statements();
    patch_ast.retain_functions(|_, _, name, _| name == fn_name);

    // Hot reload (via +=) only those functions in the script!
    *sys.script.borrow_mut() += patch_ast;
});</code></pre>
<div id="admonition-tip-multi-threaded-considerations" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-multi-threaded-considerations-title">
<div class="admonition-title">
<div id="admonition-tip-multi-threaded-considerations-title">
<p>Tip: Multi-threaded considerations</p>
</div>
<a class="admonition-anchor-link" href="patterns/hot-reload.html#admonition-tip-multi-threaded-considerations"></a>
</div>
<div>
<p>For a multi-threaded environments, replace <code>Rc</code> with <code>Arc</code>, <code>RefCell</code> with <code>RwLock</code> or <code>Mutex</code>, and
turn on the <a href="patterns//book/start/features.html"><code>sync</code></a> feature.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="builder-pattern--fluent-api"><a class="header" href="#builder-pattern--fluent-api">Builder Pattern / Fluent API</a></h1>
<div id="admonition-usage-scenario" class="admonition admonish-info" role="note" aria-labelledby="admonition-usage-scenario-title">
<div class="admonition-title">
<div id="admonition-usage-scenario-title">
<p>Usage scenario</p>
</div>
<a class="admonition-anchor-link" href="patterns/builder.html#admonition-usage-scenario"></a>
</div>
<div>
<ul>
<li>
<p>An API uses the <a href="https://en.wikipedia.org/wiki/Builder_pattern">Builder Pattern</a> or a <a href="https://en.wikipedia.org/wiki/Fluent_interface">fluent API</a>.</p>
</li>
<li>
<p>The builder type is not necessarily <code>Clone</code>.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-key-concepts" class="admonition admonish-abstract" role="note" aria-labelledby="admonition-key-concepts-title">
<div class="admonition-title">
<div id="admonition-key-concepts-title">
<p>Key concepts</p>
</div>
<a class="admonition-anchor-link" href="patterns/builder.html#admonition-key-concepts"></a>
</div>
<div>
<ul>
<li>Wrap the builder type in shared interior mutability (aka <code>Rc&lt;RefCell&lt;T&gt;&gt;</code> or <code>Arc&lt;RwLock&lt;T&gt;&gt;</code>).</li>
</ul>
</div>
</div>
<div id="admonition-tip-fluent-api" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-fluent-api-title">
<div class="admonition-title">
<div id="admonition-tip-fluent-api-title">
<p>Tip: Fluent API</p>
</div>
<a class="admonition-anchor-link" href="patterns/builder.html#admonition-tip-fluent-api"></a>
</div>
<div>
<p>This same pattern can be used to implement any <a href="https://en.wikipedia.org/wiki/Fluent_interface"><em>fluent API</em></a>.</p>
</div>
</div>
<h2 id="implementation-with-clonable-builder-type"><a class="header" href="#implementation-with-clonable-builder-type">Implementation With Clonable Builder Type</a></h2>
<p>This assumes that the builder type implements <code>Clone</code>.
This is the most common scenario.</p>
<pre><code class="language-rust">/// Builder for `Foo` instances.
#[derive(Clone)]
pub struct FooBuilder {
    /// The `foo` option.
    foo: i64,
    /// The `bar` option.
    bar: bool,
    /// The `baz` option.
    baz: String,
}

/// `FooBuilder` API which uses moves.
impl FooBuilder {
    /// Creates a new builder for `Foo`.
    pub fn new() -&gt; Self {
        Self { foo: 0, bar: false, baz: String::new() }
    }
    /// Sets the `foo` option.
    pub fn with_foo(mut self, foo: i64) -&gt; Self {
        self.foo = foo;
        self
    }
    /// Sets the `bar` option.
    pub fn with_bar(mut self, bar: bool) -&gt; Self {
        self.bar = bar;
        self
    }
    /// Sets the `baz` option.
    pub fn with_baz(mut self, baz: &amp;str) -&gt; Self {
        self.baz = baz.to_string();
        self
    }
    /// Builds the `Foo` instance.
    pub fn build(self) -&gt; Foo {
        Foo { foo: self.foo, bar: self.bar, baz: self.baz }
    }
}

let mut engine = Engine::new();

engine
    .register_fn("get_foo", FooBuilder::new)
    .register_fn("with_foo", FooBuilder::with_foo)
    .register_fn("with_bar", FooBuilder::with_bar)
    .register_fn("with_baz", FooBuilder::with_baz)
    .register_fn("create", FooBuilder::build);</code></pre>
<h2 id="implementation-with-mutable-reference"><a class="header" href="#implementation-with-mutable-reference">Implementation With Mutable Reference</a></h2>
<p>This assumes that the builder type’s API uses mutable references.
The builder type does not need to implement <code>Clone</code>.</p>
<pre><code class="language-rust">use rhai::plugin::*;

/// Builder for `Foo` instances.
/// Notice that this type does not need to be `Clone`.
pub struct FooBuilder {
    /// The `foo` option.
    foo: i64,
    /// The `bar` option.
    bar: bool,
    /// The `baz` option.
    baz: String,
}

/// Builder type API uses mutable references.
impl FooBuilder {
    /// Creates a new builder for `Foo`.
    pub fn new() -&gt; Self {
        Self { foo: 0, bar: false, baz: String::new() }
    }
    /// Sets the `foo` option.
    pub fn with_foo(&amp;mut self, foo: i64) -&gt; &amp;mut Self {
        self.foo = foo; self
    }
    /// Sets the `bar` option.
    pub fn with_bar(&amp;mut self, bar: bool) -&gt; &amp;mut Self {
        self.bar = bar; self
    }
    /// Sets the `baz` option.
    pub fn with_baz(&amp;mut self, baz: &amp;str) -&gt; &amp;mut Self {
        self.baz = baz.to_string(); self
    }
    /// Builds the `Foo` instance.
    pub fn build(&amp;self) -&gt; Foo {
        Foo { foo: self.foo, bar: self.bar, baz: self.baz.clone() }
    }
}

/// Builder for `Foo`.
#[export_module]
pub mod foo_builder {
    use super::{Foo, FooBuilder as BuilderImpl};
    use std::cell::RefCell;
    use std::rc::Rc;

    /// The builder for `Foo`.
    // This type is `Clone`.
    pub type FooBuilder = Rc&lt;RefCell&lt;super::BuilderImpl&gt;&gt;;

    /// Creates a new builder for `Foo`.
    pub fn default() -&gt; FooBuilder {
        Rc::new(RefCell::new(BuilderImpl::new()))
    }
    /// Sets the `foo` option.
    #[rhai_fn(global, pure)]
    pub fn with_foo(builder: &amp;mut FooBuilder, foo: i64) -&gt; FooBuilder {
        builder.set_foo(foo);
        builder.clone()
    }
    /// Sets the `bar` option.
    #[rhai_fn(global, pure)]
    pub fn with_bar(builder: &amp;mut FooBuilder, bar: bool) -&gt; FooBuilder {
        builder.set_bar(bar);
        builder.clone()
    }
    /// Sets the `baz` option.
    #[rhai_fn(global, pure)]
    pub fn with_baz(builder: &amp;mut FooBuilder, baz: &amp;str) -&gt; FooBuilder {
        builder.set_baz(baz);
        builder.clone()
    }
    /// Builds the `Foo` instance.
    #[rhai_fn(global, pure)]
    pub fn create(builder: &amp;mut FooBuilder) -&gt; Foo {
        builder.borrow().build()
    }
}</code></pre>
<h2 id="implementation-with-moves"><a class="header" href="#implementation-with-moves">Implementation With Moves</a></h2>
<p>What if the builder type’s API relies on moves instead of mutable references?
And the builder type does not implement <code>Clone</code>?</p>
<p>Not too worry: the following trick has you covered!</p>
<pre><code class="language-rust">use rhai::plugin::*;

/// Builder for `Foo` instances.
/// Notice that this type does not need to be `Clone`.
pub struct FooBuilder {
    /// The `foo` option.
    foo: i64,
    /// The `bar` option.
    bar: bool,
    /// The `baz` option.
    baz: String,
}

/// `FooBuilder` API which uses moves.
impl FooBuilder {
    /// Creates a new builder for `Foo`.
    pub fn new() -&gt; Self {
        Self { foo: 0, bar: false, baz: String::new() }
    }
    /// Sets the `foo` option.
    pub fn with_foo(mut self, foo: i64) -&gt; Self {
        self.foo = foo;
        self
    }
    /// Sets the `bar` option.
    pub fn with_bar(mut self, bar: bool) -&gt; Self {
        self.bar = bar;
        self
    }
    /// Sets the `baz` option.
    pub fn with_baz(mut self, baz: &amp;str) -&gt; Self {
        self.baz = baz.to_string();
        self
    }
    /// Builds the `Foo` instance.
    pub fn build(self) -&gt; Foo {
        Foo { foo: self.foo, bar: self.bar, baz: self.baz }
    }
}

/// Builder for `Foo`.
#[export_module]
pub mod foo_builder {
    use super::{Foo, FooBuilder as BuilderImpl};
    use std::cell::RefCell;
    use std::mem;
    use std::rc::Rc;

    /// The builder for `Foo`.
    // This type is `Clone`.
    // An `Option` is used for easy extraction of the builder type.
    // If it is `None` then the builder is already consumed.
    pub type FooBuilder = Rc&lt;RefCell&lt;Option&lt;BuilderImpl&gt;&gt;&gt;;

    /// Creates a new builder for `Foo`.
    pub fn default() -&gt; FooBuilder {
        Rc::new(RefCell::new(Some(BuilderImpl::new())))
    }
    /// Sets the `foo` option.
    #[rhai_fn(return_raw, global, pure)]
    pub fn with_foo(builder: &amp;mut FooBuilder, foo: i64) -&gt; Result&lt;FooBuilder, Box&lt;EvalAltResult&gt;&gt; {
        let b = &amp;mut *builder.borrow_mut();

        if let Some(obj) = mem::take(b) {
            *b = Some(obj.with_foo(foo));
            Ok(builder.clone())
        } else {
            Err("Builder is already consumed".into())
        }
    }
    /// Sets the `bar` option.
    #[rhai_fn(return_raw, global, pure)]
    pub fn with_bar(builder: &amp;mut FooBuilder, bar: bool) -&gt; Result&lt;FooBuilder, Box&lt;EvalAltResult&gt;&gt; {
        let b = &amp;mut *builder.borrow_mut();

        if let Some(obj) = mem::take(b) {
            *b = Some(obj.with_bar(bar));
            Ok(builder.clone())
        } else {
            Err("Builder is already consumed".into())
        }
    }
    /// Sets the `baz` option.
    #[rhai_fn(return_raw, global, pure)]
    pub fn with_baz(builder: &amp;mut FooBuilder, baz: &amp;str) -&gt; Result&lt;FooBuilder, Box&lt;EvalAltResult&gt;&gt; {
        let b = &amp;mut *builder.borrow_mut();

        if let Some(obj) = mem::take(b) {
            *b = Some(obj.with_baz(baz));
            Ok(builder.clone())
        } else {
            Err("Builder is already consumed".into())
        }
    }
    /// Builds the `Foo` instance.
    #[rhai_fn(return_raw, global, pure)]
    pub fn create(builder: &amp;mut FooBuilder) -&gt; Result&lt;Foo, Box&lt;EvalAltResult&gt;&gt; {
        let b = &amp;mut *builder.borrow_mut();

        if let Some(obj) = mem::take(b) {
            Ok(obj.build())
        } else {
            Err("Builder is already consumed".into())
        }
    }
}</code></pre>
<h2 id="usage-1"><a class="header" href="#usage-1">Usage</a></h2>
<p>It is easy to see that the Rhai script API mirrors the Rust API almost perfectly.</p>
<pre><code class="language-rust">┌──────┐
│ Rust │
└──────┘

let mut engine = Engine::new();

engine.register_static_module("Foo", exported_module!(foo_builder).into());

let foo = FooBuilder::new().with_foo(42).with_bar(true).with_baz("Hello").build();


┌─────────────┐
│ Rhai script │
└─────────────┘

let foo = Foo::default().with_foo(42).with_bar(true).with_baz("Hello").create();</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="objects-with-defined-behaviors"><a class="header" href="#objects-with-defined-behaviors">Objects with Defined Behaviors</a></h1>
<div id="admonition-usage-scenario" class="admonition admonish-info" role="note" aria-labelledby="admonition-usage-scenario-title">
<div class="admonition-title">
<div id="admonition-usage-scenario-title">
<p>Usage scenario</p>
</div>
<a class="admonition-anchor-link" href="patterns/objects.html#admonition-usage-scenario"></a>
</div>
<div>
<ul>
<li>
<p>To simulate specific <em>object types</em> coded in Rust with fields and methods.</p>
</li>
<li>
<p>Native Rust methods (not scripted) are pre-defined for these types.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-key-concepts" class="admonition admonish-abstract" role="note" aria-labelledby="admonition-key-concepts-title">
<div class="admonition-title">
<div id="admonition-key-concepts-title">
<p>Key concepts</p>
</div>
<a class="admonition-anchor-link" href="patterns/objects.html#admonition-key-concepts"></a>
</div>
<div>
<ul>
<li>
<p>Use an <a href="patterns//book/language/object-maps.html">object map</a> as the main container of the type.</p>
</li>
<li>
<p>Create <a href="patterns//book/language/fn-ptr.html">function pointers</a> binding to <em>native Rust functions</em> and store them as properties
of the <a href="patterns//book/language/object-maps.html">object map</a>.</p>
</li>
</ul>
</div>
</div>
<p>Rhai does not have <em>objects</em> per se and is not object-oriented (in the traditional sense), but it is
possible to <em>simulate</em> object-oriented programming via <a href="patterns//book/language/object-maps.html">object maps</a>.</p>
<p>When using <a href="patterns//book/language/object-maps.html">object maps</a> to simulate objects (See <a href="patterns/oop.html">here</a> for more details), a property that
holds a <a href="patterns//book/language/fn-ptr.html">function pointer</a> can be called like a method function with the <a href="patterns//book/language/object-maps.html">object map</a> being the
object of the method call.</p>
<p>It is also possible to create <a href="patterns//book/language/fn-ptr.html">function pointers</a> that bind to native Rust functions/closures so
that those are called when the <a href="patterns//book/language/fn-ptr.html">function pointers</a> are called.</p>
<h2 id="implementation-6"><a class="header" href="#implementation-6">Implementation</a></h2>
<p>A <a href="patterns//book/language/fn-ptr.html">function pointer</a> can be created that binds to a specific Rust function or closure.</p>
<p>(See <a href="patterns//book/language/fn-ptr.html#bind-to-a-native-rust-function">here</a> for details on using
<code>FnPtr::from_fn</code> and <code>FnPtr::from_dyn_fn</code>).</p>
<pre><code class="language-rust">// This is the pre-defined behavior for the 'Awesome' object type.
fn my_awesome_fn(ctx: NativeCallContext, args: &amp;mut[&amp;mut Dynamic]) -&gt; Result&lt;Dynamic, Box&lt;EvalAltResult&gt;&gt; {
    // Check number of arguments
    if args.len() != 2 {
        return Err("one argument is required, plus the object".into());
    }

    // Get call arguments
    let x = args[1].try_cast::&lt;i64&gt;().map_err(|_| "argument must be an integer".into())?;

    // Get mutable reference to the object map, which is passed as the first argument
    let map = &amp;mut *args[0].as_map_mut().map_err(|_| "object must be a map".into())?;

    // Do something awesome here ...
    let result = ...

    Ok(result.into())
}

// Register a function to create a pre-defined object
engine.register_fn("create_awesome_object", || {
    // Use an object map as base
    let mut map = Map::new();

    // Create a function pointer that binds to 'my_awesome_fn'
    let fp = FnPtr::from_fn("awesome", my_awesome_fn)?;
    //                      ^ name of method
    //                                 ^ native function

    // Store the function pointer in the object map
    map.insert("awesome".into(), fp.into());

    Ok(Dynamic::from_map(map))
});</code></pre>
<p>The <a href="patterns//book/language/object-maps.html">object map</a> can then be used just like any object-oriented object.</p>
<pre><code class="language-rust">let obj = create_awesome_object();

let result = obj.awesome(42);   // calls 'my_awesome_fn' with '42' as argument</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dynamic-constants-provider"><a class="header" href="#dynamic-constants-provider">Dynamic Constants Provider</a></h1>
<div id="admonition-usage-scenario" class="admonition admonish-info" role="note" aria-labelledby="admonition-usage-scenario-title">
<div class="admonition-title">
<div id="admonition-usage-scenario-title">
<p>Usage scenario</p>
</div>
<a class="admonition-anchor-link" href="patterns/dynamic-const.html#admonition-usage-scenario"></a>
</div>
<div>
<ul>
<li>
<p>A system has a <em>large</em> number of constants, but only a minor set will be used by any script.</p>
</li>
<li>
<p>The system constants are expensive to load.</p>
</li>
<li>
<p>The system constants set is too massive to push into a custom <a href="patterns//book/engine/scope.html"><code>Scope</code></a>.</p>
</li>
<li>
<p>The values of system constants are volatile and call-dependent.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-key-concepts" class="admonition admonish-abstract" role="note" aria-labelledby="admonition-key-concepts-title">
<div class="admonition-title">
<div id="admonition-key-concepts-title">
<p>Key concepts</p>
</div>
<a class="admonition-anchor-link" href="patterns/dynamic-const.html#admonition-key-concepts"></a>
</div>
<div>
<ul>
<li>
<p>Use a <a href="patterns//book/engine/var.html">variable resolver</a> to intercept variable access.</p>
</li>
<li>
<p>Only load a variable when it is being used.</p>
</li>
<li>
<p>Perform a lookup based on variable name, and provide the correct data value.</p>
</li>
<li>
<p>May even perform back-end network access or look up the latest value from a database.</p>
</li>
</ul>
</div>
</div>
<h2 id="implementation-7"><a class="header" href="#implementation-7">Implementation</a></h2>
<pre><code class="language-rust">let mut engine = Engine::new();

// Create shared data provider.
// Assume that SystemValuesProvider::get(&amp;str) -&gt; Option&lt;value&gt; gets a value.
let provider = Arc::new(SystemValuesProvider::new());

// Clone the shared provider
let db = provider.clone();

// Register a variable resolver.
// Move the shared provider into the closure.
engine.on_var(move |name, _, _| Ok(db.get(name).map(Dynamic::from)));</code></pre>
<div id="admonition-values-are-constants" class="admonition admonish-note small" role="note" aria-labelledby="admonition-values-are-constants-title">
<div class="admonition-title">
<div id="admonition-values-are-constants-title">
<p>Values are constants</p>
</div>
<a class="admonition-anchor-link" href="patterns/dynamic-const.html#admonition-values-are-constants"></a>
</div>
<div>
<p>All values provided by a <a href="patterns//book/engine/var.html">variable resolver</a> are <em><a href="patterns//book/language/constants.html">constants</a></em> due to their dynamic nature.
They cannot be assigned to.</p>
<p>In order to change values in an external system, register a dedicated API for that purpose.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="global-constants"><a class="header" href="#global-constants">Global Constants</a></h1>
<div id="admonition-usage-scenario" class="admonition admonish-info" role="note" aria-labelledby="admonition-usage-scenario-title">
<div class="admonition-title">
<div id="admonition-usage-scenario-title">
<p>Usage scenario</p>
</div>
<a class="admonition-anchor-link" href="patterns/constants.html#admonition-usage-scenario"></a>
</div>
<div>
<ul>
<li>
<p>Script has a lot of duplicated <a href="patterns//book/language/constants.html">constants</a> used inside <a href="patterns//book/language/functions.html">functions</a>.</p>
</li>
<li>
<p>For easier management, <a href="patterns//book/language/constants.html">constants</a> are declared at the top of the script.</p>
</li>
<li>
<p>As Rhai <a href="patterns//book/language/functions.html">functions</a> are pure, they cannot access <a href="patterns//book/language/constants.html">constants</a> declared at global level
except through <a href="patterns//book/language/global.html"><code>global</code></a>.</p>
</li>
<li>
<p>Sprinkling large number of <a href="patterns//book/language/global.html"><code>global::CONSTANT</code></a> throughout the script makes
it slow and cumbersome.</p>
</li>
<li>
<p>Using <a href="patterns//book/language/global.html"><code>global</code></a> or a <a href="patterns//book/engine/var.html">variable resolver</a> defeats
<a href="patterns//book/engine/optimize/constants.html">constants propagation</a> in <a href="patterns//book/engine/optimize/index.html">script optimization</a>.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-key-concepts" class="admonition admonish-abstract" role="note" aria-labelledby="admonition-key-concepts-title">
<div class="admonition-title">
<div id="admonition-key-concepts-title">
<p>Key concepts</p>
</div>
<a class="admonition-anchor-link" href="patterns/constants.html#admonition-key-concepts"></a>
</div>
<div>
<ul>
<li>
<p>The key to global <a href="patterns//book/language/constants.html">constants</a> is to use them to <a href="patterns//book/engine/optimize/index.html">optimize</a> a script.
Otherwise, it would be just as simple to pass the constants into a custom <a href="patterns//book/engine/scope.html"><code>Scope</code></a> instead.</p>
</li>
<li>
<p>The script is first compiled into an <a href="patterns//book/engine/compile.html"><code>AST</code></a>, and all <a href="patterns//book/language/constants.html">constants</a> are extracted.</p>
</li>
<li>
<p>The <a href="patterns//book/language/constants.html">constants</a> are then supplied to <a href="patterns//book/engine/optimize/index.html">re-optimize</a> the <a href="patterns//book/engine/compile.html"><code>AST</code></a>.</p>
</li>
<li>
<p>This pattern also works under <a href="patterns//book/engine/strict-var.html"><em>Strict Variables Mode</em></a>.</p>
</li>
</ul>
</div>
</div>
<h2 id="example-22"><a class="header" href="#example-22">Example</a></h2>
<p>Assume that the following Rhai script needs to work (but it doesn’t).</p>
<pre><code class="language-rust">// These are constants

const FOO = 1;
const BAR = 123;
const MAGIC_NUMBER = 42;

fn get_magic() {
    MAGIC_NUMBER        // &lt;- oops! 'MAGIC_NUMBER' not found!
}

fn calc_foo(x) {
    x * global::FOO     // &lt;- works but cumbersome; not desirable!
}

let magic = get_magic() * BAR;

let x = calc_foo(magic);

print(x);</code></pre>
<h2 id="step-1--compile-script-into-ast"><a class="header" href="#step-1--compile-script-into-ast">Step 1 – Compile Script into <code>AST</code></a></h2>
<p>Compile the script into <a href="patterns//book/engine/compile.html"><code>AST</code></a> form.</p>
<p>Normally, it is useful to disable <a href="patterns//book/engine/optimize/index.html">optimizations</a> at this stage since
the <a href="patterns//book/engine/compile.html"><code>AST</code></a> will be re-optimized later.</p>
<p><a href="patterns//book/engine/strict-var.html"><em>Strict Variables Mode</em></a> must be OFF for this to work.</p>
<pre><code class="language-rust">// Turn Strict Variables Mode OFF (if necessary)
engine.set_strict_variables(false);

// Turn optimizations OFF
engine.set_optimization_level(OptimizationLevel::None);

let ast = engine.compile("...")?;</code></pre>
<h2 id="step-2--extract-constants"><a class="header" href="#step-2--extract-constants">Step 2 – Extract Constants</a></h2>
<p>Use <a href="https://docs.rs/rhai/1.22.0/rhai/struct.AST.html#method.iter_literal_variables"><code>AST::iter_literal_variables</code></a>
to extract top-level <a href="patterns//book/language/constants.html">constants</a> from the <a href="patterns//book/engine/compile.html"><code>AST</code></a>.</p>
<pre><code class="language-rust">let mut scope = Scope::new();

// Extract all top-level constants without running the script
ast.iter_literal_variables(true, false).for_each(|(name, _, value)|
    scope.push_constant(name, value);
);

// 'scope' now contains: FOO, BAR, MAGIC_NUMBER</code></pre>
<h2 id="step-3a--propagate-constants"><a class="header" href="#step-3a--propagate-constants">Step 3a – Propagate Constants</a></h2>
<p><a href="patterns//book/engine/optimize/index.html">Re-optimize</a> the <a href="patterns//book/engine/compile.html"><code>AST</code></a> using the new constants.</p>
<pre><code class="language-rust">// Turn optimization back ON
engine.set_optimization_level(OptimizationLevel::Simple);

let ast = engine.optimize_ast(&amp;scope, ast, engine.optimization_level());</code></pre>
<h2 id="step-3b--recompile-script-alternative"><a class="header" href="#step-3b--recompile-script-alternative">Step 3b – Recompile Script (Alternative)</a></h2>
<p>If <a href="patterns//book/engine/strict-var.html"><em>Strict Variables Mode</em></a> is used, however, it is necessary to re-compile the
script in order to detect undefined <a href="patterns//book/language/variables.html">variable</a> usages.</p>
<pre><code class="language-rust">// Turn Strict Variables Mode back ON
engine.set_strict_variables(true);

// Turn optimization back ON
engine.set_optimization_level(OptimizationLevel::Simple);

// Re-compile the script using constants in 'scope'
let ast = engine.compile_with_scope(&amp;scope, "...")?;</code></pre>
<h2 id="step-4--run-the-script"><a class="header" href="#step-4--run-the-script">Step 4 – Run the Script</a></h2>
<p>At this step, the <a href="patterns//book/engine/compile.html"><code>AST</code></a> is now optimized with constants propagated into all access sites.</p>
<p>The script essentially becomes:</p>
<pre><code class="language-rust">// These are constants

const FOO = 1;
const BAR = 123;
const MAGIC_NUMBER = 42;

fn get_magic() {
    42      // &lt;- constant replaced by value
}

fn calc_foo(x) {
    x * global::FOO
}

let magic = get_magic() * 123;  // &lt;- constant replaced by value

let x = calc_foo(magic);

print(x);</code></pre>
<p>Run it via <code>Engine::run_ast</code> or <code>Engine::eval_ast</code>.</p>
<pre><code class="language-rust">// The 'scope' is no longer necessary
engine.run_ast(&amp;ast)?;</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mutable-global-state"><a class="header" href="#mutable-global-state">Mutable Global State</a></h1>
<h2 id="dont-do-it"><a class="header" href="#dont-do-it">Don’t Do It™</a></h2>
<div id="admonition-consider-javascript" class="admonition admonish-question side" role="note" aria-labelledby="admonition-consider-javascript-title">
<div class="admonition-title">
<div id="admonition-consider-javascript-title">
<p>Consider JavaScript</p>
</div>
<a class="admonition-anchor-link" href="patterns/global-mutable-state.html#admonition-consider-javascript"></a>
</div>
<div>
<p>Generations of programmers struggled to get around mutable global state (a.k.a. the <code>window</code> object)
in the design of JavaScript.</p>
</div>
</div>
<p>In contrast to <a href="patterns/constants.html">global constants</a>, <em>mutable</em> global states are <strong>strongly
discouraged</strong> because:</p>
<ol>
<li>
<p>It is a sure-fire way to create race conditions – that is why Rust does not support it;</p>
</li>
<li>
<p>It adds considerably to debug complexity – it is difficult to reason, in large code bases,
where/when a state value is being modified;</p>
</li>
<li>
<p>It forces hard (but obscure) dependencies between separate pieces of code that are difficult to
break when the need arises;</p>
</li>
<li>
<p>It is almost impossible to add new layers of redirection and/or abstraction afterwards without
major surgery.</p>
</li>
</ol>
<h2 id="alternative--use-this"><a class="header" href="#alternative--use-this">Alternative – Use <code>this</code></a></h2>
<p>In the majority of the such scenarios, there is only <em>one</em> mutable global state of interest.</p>
<p>Therefore, it is a <em>much</em> better solution to bind that global state to the <code>this</code> pointer.</p>
<pre><code class="language-rust">// Say this is a mutable global state...
let state = #{ counter: 0 };

// This function tries to access the global 'state'
// which will fail.
fn inc() {
    state.counter += 1;
}

// The function should be written with 'this'
fn inc() {
    this.counter += 1;
}

state.inc();        // call 'inc' with 'state' bound to 'this'

// Or this way... why hard-code the state in the first place?
fn inc() {
    this += 1;
}

state.counter.inc();</code></pre>
<div id="admonition-why-is-this-better" class="admonition admonish-question small" role="note" aria-labelledby="admonition-why-is-this-better-title">
<div class="admonition-title">
<div id="admonition-why-is-this-better-title">
<p>Why is this better?</p>
</div>
<a class="admonition-anchor-link" href="patterns/global-mutable-state.html#admonition-why-is-this-better"></a>
</div>
<div>
<p>There are good reasons why using <code>this</code> is a better solution:</p>
<ul>
<li>the state is never <em>hidden</em> – it is always clear to see what is being modified</li>
<li>it is just as fast – the <code>this</code> pointer works by reference</li>
<li>you can pass other states in, in the future, without changing the script code</li>
<li>there are no hard links within functions that will be difficult to unravel</li>
<li>only the <a href="patterns//book/language/variables.html">variable</a> bound to <code>this</code> is ever modified; everything else is immutable</li>
</ul>
</div>
</div>
<div id="admonition-i-dont-care-i-want-it-just-tell-me-how-to-do-it-now" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-i-dont-care-i-want-it-just-tell-me-how-to-do-it-now-title">
<div class="admonition-title">
<div id="admonition-i-dont-care-i-want-it-just-tell-me-how-to-do-it-now-title">
<p>I don’t care! I want it! Just tell me how to do it! Now!</p>
</div>
<a class="admonition-anchor-link" href="patterns/global-mutable-state.html#admonition-i-dont-care-i-want-it-just-tell-me-how-to-do-it-now"></a>
</div>
<div>
<p>This is not something that Rhai encourages.  <em>You Have Been Warned™</em>.</p>
<p>There are two ways…</p>
</div>
</div>
<h2 id="option-1--getset-functions"><a class="header" href="#option-1--getset-functions">Option 1 – Get/Set Functions</a></h2>
<p>This is similar to the <a href="patterns/control.html">Control Layer</a> pattern.</p>
<p>Use get/set functions to read/write the global mutable state.</p>
<pre><code class="language-rust">// The globally mutable shared value
let value = Rc::new(RefCell::new(42));

// Register an API to access the globally mutable shared value
let v = value.clone();
engine.register_fn("get_global_value", move || *v.borrow());

let v = value.clone();
engine.register_fn("set_global_value", move |value: i64| *v.borrow_mut() = value);</code></pre>
<p>These functions can be used in script <a href="patterns//book/language/functions.html">functions</a> to access the shared global state.</p>
<pre><code class="language-rust">fn foo() {
    let current = get_global_value();       // Get global state value
    current += 1;
    set_global_value(current);              // Modify global state value
}</code></pre>
<p>This option is preferred because it is possible to modify the get/set functions later on to
add/change functionalities without introducing breaking script changes.</p>
<h2 id="option-2--variable-resolver"><a class="header" href="#option-2--variable-resolver">Option 2 – Variable Resolver</a></h2>
<p>Declare a <a href="patterns//book/engine/var.html">variable resolver</a> that returns a <em>shared</em> value which is the global state.</p>
<pre><code class="language-rust">// Use a shared value as the global state
let value: Dynamic = 1.into();
let mut value = value.into_shared();        // convert into shared value

// Clone the shared value
let v = value.clone();

// Register a variable resolver.
engine.on_var(move |name, _, _| {
    match name
        "value" =&gt; Ok(Some(v.clone())),
        _ =&gt; Ok(None)
    }
});

// The shared global state can be modified
*value.write_lock::&lt;i64&gt;().unwrap() = 42;</code></pre>
<p>The global state variable can now be used just like a normal local variable,
including modifications.</p>
<pre><code class="language-rust">fn foo() {
    value = value * 2;
//          ^ global variable can be read
//  ^ global variable can also be modified
}</code></pre>
<div id="admonition-anti-pattern" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-anti-pattern-title">
<div class="admonition-title">
<div id="admonition-anti-pattern-title">
<p>Anti-Pattern</p>
</div>
<a class="admonition-anchor-link" href="patterns/global-mutable-state.html#admonition-anti-pattern"></a>
</div>
<div>
<p>This option makes mutable global state so easy to implement that it should actually be
considered an <em>Anti-Pattern</em>.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="working-with-rust-enums"><a class="header" href="#working-with-rust-enums">Working With Rust Enums</a></h1>
<div id="admonition-why-enums-are-hard" class="admonition admonish-question side wide" role="note" aria-labelledby="admonition-why-enums-are-hard-title">
<div class="admonition-title">
<div id="admonition-why-enums-are-hard-title">
<p>Why enums are hard</p>
</div>
<a class="admonition-anchor-link" href="patterns/enums.html#admonition-why-enums-are-hard"></a>
</div>
<div>
<p>Rust enum variants are not considered separate types.</p>
<p>Although Rhai integrates fine with Rust enums (treated transparently as <a href="patterns//book/rust/custom-types.html">custom types</a>),
it is impossible (short of registering a complete API) to distinguish between individual
variants and to extract internal data from them.</p>
</div>
</div>
<p>Enums in Rust can hold data and are typically used with <em>pattern matching</em>.</p>
<p>Unlike Rust, Rhai does not have built-in pattern matching capabilities, so working with enum
variants that contain embedded data is not an easy proposition.</p>
<p>Since Rhai is dynamic and <a href="patterns//book/language/variables.html">variables</a> can hold any type of data, they are essentially enums
by nature.</p>
<p>Multiple distinct types can be stored in a single <a href="patterns//book/language/dynamic.html"><code>Dynamic</code></a> without merging them into an enum
as variants.</p>
<p>This section outlines a number of possible solutions to work with Rust enums.</p>
<h2 id="simulate-an-enum-api"><a class="header" href="#simulate-an-enum-api">Simulate an Enum API</a></h2>
<p>A <a href="patterns//book/plugins/module.html">plugin module</a> is extremely handy in creating an entire API for a custom enum type.</p>
<pre><code class="language-rust">use rhai::plugin::*;
use rhai::{Dynamic, Engine, EvalAltResult};

#[derive(Debug, Clone, Eq, PartialEq, Hash)]
enum MyEnum {
    Foo,
    Bar(i64),
    Baz(String, bool),
}

// Create a plugin module with functions constructing the 'MyEnum' variants
#[export_module]
mod MyEnumModule {
    // Constructors for 'MyEnum' variants

    /// `MyEnum::Foo` with no inner data.
    pub const Foo: MyEnum = MyEnum::Foo;

    /// `MyEnum::Bar(value)`
    pub fn Bar(value: i64) -&gt; MyEnum { MyEnum::Bar(value) }

    /// `MyEnum::Baz(name, flag)`
    pub fn Baz(name: String, flag: bool) -&gt; MyEnum { MyEnum::Baz(name, flag) }

    /// Return the current variant of `MyEnum`.
    #[rhai_fn(global, get = "enum_type", pure)]
    pub fn get_type(my_enum: &amp;mut MyEnum) -&gt; String {
        match my_enum {
            MyEnum::Foo =&gt; "Foo".to_string(),
            MyEnum::Bar(_) =&gt; "Bar".to_string(),
            MyEnum::Baz(_, _) =&gt; "Baz".to_string()
        }
    }

    /// Return the inner value.
    #[rhai_fn(global, get = "value", pure)]
    pub fn get_value(my_enum: &amp;mut MyEnum) -&gt; Dynamic {
        match my_enum {
            MyEnum::Foo =&gt; Dynamic::UNIT,
            MyEnum::Bar(x) =&gt; Dynamic::from(x),
            MyEnum::Baz(_, f) =&gt; Dynamic::from(f),
        }
    }

    // Access to inner values by position

    /// Return the value kept in the first position of `MyEnum`.
    #[rhai_fn(global, get = "field_0", pure)]
    pub fn get_field_0(my_enum: &amp;mut MyEnum) -&gt; Dynamic {
        match my_enum {
            MyEnum::Foo =&gt; Dynamic::UNIT,
            MyEnum::Bar(x) =&gt; Dynamic::from(x),
            MyEnum::Baz(x, _) =&gt; Dynamic::from(x)
        }
    }
    /// Return the value kept in the second position of `MyEnum`.
    #[rhai_fn(global, get = "field_1", pure)]
    pub fn get_field_1(my_enum: &amp;mut MyEnum) -&gt; Dynamic {
        match my_enum {
            MyEnum::Foo | MyEnum::Bar(_) =&gt; Dynamic::UNIT,
            MyEnum::Baz(_, x) =&gt; Dynamic::from(x)
        }
    }

    // Printing
    #[rhai_fn(global, name = "to_string", name = "to_debug", pure)]
    pub fn to_string(my_enum: &amp;mut MyEnum) -&gt; String {
        format!("{my_enum:?}")
    }

    // '==' and '!=' operators
    #[rhai_fn(global, name = "==", pure)]
    pub fn eq(my_enum: &amp;mut MyEnum, my_enum2: MyEnum) -&gt; bool {
        my_enum == &amp;my_enum2
    }
    #[rhai_fn(global, name = "!=", pure)]
    pub fn neq(my_enum: &amp;mut MyEnum, my_enum2: MyEnum) -&gt; bool {
        my_enum != &amp;my_enum2
    }
}

let mut engine = Engine::new();

// Load the module as the module namespace "MyEnum"
engine.register_type_with_name::&lt;MyEnum&gt;("MyEnum")
      .register_static_module("MyEnum", exported_module!(MyEnumModule).into());</code></pre>
<p>With this API in place, working with enums feels almost the same as in Rust:</p>
<pre><code class="language-rust">let x = MyEnum::Foo;

let y = MyEnum::Bar(42);

let z = MyEnum::Baz("hello", true);

x == MyEnum::Foo;

y != MyEnum::Bar(0);

// Detect enum types

x.enum_type == "Foo";

y.enum_type == "Bar";

z.enum_type == "Baz";

// Extract enum fields

x.value == ();

y.value == 42;

z.value == ();

x.name == ();

y.name == ();

z.name == "hello";

y.field_0 == 42;

y.field_1 == ();

z.field_0 == "hello";

z.field_1 == true;</code></pre>
<div id="admonition-tip-use-a-macro" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-use-a-macro-title">
<div class="admonition-title">
<div id="admonition-tip-use-a-macro-title">
<p>Tip: Use a macro</p>
</div>
<a class="admonition-anchor-link" href="patterns/enums.html#admonition-tip-use-a-macro"></a>
</div>
<div>
<p>For enums containing only variants with no inner data, it is convenient to use a simple macro to create
such a <a href="patterns//book/plugins/module.html">plugin module</a>.</p>
<pre><code class="language-rust">// The 'create_enum_module!' macro
macro_rules! create_enum_module {
    ($module:ident : $typ:ty =&gt; $($variant:ident),+) =&gt; {
        #[export_module]
        pub mod $module {
            $(
                #[allow(non_upper_case_globals)]
                pub const $variant: $typ = &lt;$typ&gt;::$variant;
            )*
        }
    };
}

// The enum
#[derive(Debug, Copy, Clone, Eq, PartialEq, Hash)]
pub enum MyEnum { Foo, Bar, Baz, Hello, World }

// This creates a plugin module called 'my_enum_module'
expand_enum! { my_enum_module: MyEnum =&gt; Foo, Bar, Baz, Hello, World }</code></pre>
</div>
</div>
<h2 id="use-enums-with-switch"><a class="header" href="#use-enums-with-switch">Use Enums With <code>switch</code></a></h2>
<p>Since enums are internally treated as <a href="patterns//book/rust/custom-types.html">custom types</a>, they are not <em>literals</em> and cannot be used as
a match case in <a href="patterns//book/language/switch.html"><code>switch</code></a> statements.  This is quite a limitation because the equivalent <code>match</code>
statement is commonly used in Rust to work with enums and bind variables to variant-internal data.</p>
<p>It is possible, however, to <a href="patterns//book/language/switch.html"><code>switch</code></a> through enum variants based on their types:</p>
<pre><code class="language-c   no_run">switch my_enum.enum_type {
  "Foo" =&gt; ...,
  "Bar" =&gt; {
    let value = foo.value;
    ...
  }
  "Baz" =&gt; {
    let name = foo.name;
    let flag = foo.flag;
    ...
  }
}
</code></pre>
<h2 id="use-switch-through-arrays"><a class="header" href="#use-switch-through-arrays">Use <code>switch</code> Through Arrays</a></h2>
<p>Another way to work with Rust enums in a <a href="patterns//book/language/switch.html"><code>switch</code></a> statement is through exposing the internal data
(or at least those that act as effective <em>discriminants</em>) of each enum variant as a variable-length
<a href="patterns//book/language/arrays.html">array</a>, usually with the name of the variant as the first item for convenience:</p>
<pre><code class="language-rust">use rhai::Array;

engine.register_get("enum_data", |my_enum: &amp;mut MyEnum| {
    match my_enum {
        MyEnum::Foo =&gt; vec![ "Foo".into() ] as Array,

        // Say, skip the data field because it is not
        // used as a discriminant
        MyEnum::Bar(value) =&gt; vec![ "Bar".into() ] as Array,

        // Say, all fields act as discriminants
        MyEnum::Baz(name, flag) =&gt; vec![
            "Baz".into(), name.clone().into(), (*flag).into()
        ] as Array
    }
});</code></pre>
<p>Then it is a simple matter to match an enum via a <a href="patterns//book/language/switch.html"><code>switch</code></a> expression.</p>
<pre><code class="language-c   no_run">// Assume 'value' = 'MyEnum::Baz("hello", true)'
// 'enum_data' creates a variable-length array with 'MyEnum' data
let x = switch value.enum_data {
    ["Foo"] =&gt; 1,
    ["Bar"] =&gt; value.field_1,
    ["Baz", "hello", false] =&gt; 4,
    ["Baz", "hello", true] =&gt; 5,
    _ =&gt; 9
};

x == 5;

// Which is essentially the same as:
let x = switch [value.type, value.field_0, value.field_1] {
    ["Foo", (), ()] =&gt; 1,
    ["Bar", 42, ()] =&gt; 42,
    ["Bar", 123, ()] =&gt; 123,
            :
    ["Baz", "hello", false] =&gt; 4,
    ["Baz", "hello", true] =&gt; 5,
    _ =&gt; 9
}
</code></pre>
<p>Usually, a helper method returns an <a href="patterns//book/language/arrays.html">array</a> of values that can uniquely determine the <a href="patterns//book/language/switch.html"><code>switch</code></a> case
based on actual usage requirements – which means that it probably skips fields that contain
data instead of discriminants.</p>
<p>Then <a href="patterns//book/language/switch.html"><code>switch</code></a> is used to very quickly match through a large number of <a href="patterns//book/language/arrays.html">array</a> shapes and jump to the
appropriate case implementation.</p>
<p>Data fields can then be extracted from the enum independently.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="simulate-macros-to-simplify-scripts"><a class="header" href="#simulate-macros-to-simplify-scripts">Simulate Macros to Simplify Scripts</a></h1>
<div id="admonition-usage-scenario" class="admonition admonish-info" role="note" aria-labelledby="admonition-usage-scenario-title">
<div class="admonition-title">
<div id="admonition-usage-scenario-title">
<p>Usage scenario</p>
</div>
<a class="admonition-anchor-link" href="patterns/macros.html#admonition-usage-scenario"></a>
</div>
<div>
<ul>
<li>
<p>Scripts need to access existing data in <a href="patterns//book/language/variables.html">variables</a>.</p>
</li>
<li>
<p>The particular fields to access correspond to long/complex expressions (e.g. long
<a href="patterns//book/rust/indexers.html">indexing</a> and/or <a href="patterns//book/rust/getters-setters.html">property</a> chains <code>foo[x][y].bar[z].baz</code>).</p>
</li>
<li>
<p>Usage is prevalent inside the scripts, requiring extensive duplications of code that
are prone to typos and errors.</p>
</li>
<li>
<p>There are a few such <a href="patterns//book/language/variables.html">variables</a> to modify at the same time – otherwise, it would
be simpler to bind the <code>this</code> pointer to the <a href="patterns//book/language/variables.html">variable</a>.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-key-concepts" class="admonition admonish-abstract" role="note" aria-labelledby="admonition-key-concepts-title">
<div class="admonition-title">
<div id="admonition-key-concepts-title">
<p>Key concepts</p>
</div>
<a class="admonition-anchor-link" href="patterns/macros.html#admonition-key-concepts"></a>
</div>
<div>
<ul>
<li>
<p>Pick a <em>macro</em> syntax that is unlikely to conflict with content in literal <a href="patterns//book/language/strings-chars.html">strings</a>.</p>
</li>
<li>
<p>Before script evaluation/compilation, globally replace macros with their corresponding expansions.</p>
</li>
</ul>
</div>
</div>
<h2 id="pick-a-macro-syntax"><a class="header" href="#pick-a-macro-syntax">Pick a Macro Syntax</a></h2>
<div id="admonition-warning-not-real-macros" class="admonition admonish-danger side" role="note" aria-labelledby="admonition-warning-not-real-macros-title">
<div class="admonition-title">
<div id="admonition-warning-not-real-macros-title">
<p>Warning: Not real macros</p>
</div>
<a class="admonition-anchor-link" href="patterns/macros.html#admonition-warning-not-real-macros"></a>
</div>
<div>
<p>The technique described here is to <em>simulate</em> macros.
They are not <em>REAL</em> macros.</p>
</div>
</div>
<p>Pick a syntax that is intuitive for the domain but <strong>unlikely to occur naturally inside
<a href="patterns//book/language/strings-chars.html">string</a> literals</strong>.</p>
<div class="table-wrapper"><table><thead><tr><th>Sample Syntax</th><th>Sample usage</th></tr></thead><tbody>
<tr><td><code>#FOO</code></td><td><code>#FOO = 42;</code></td></tr>
<tr><td><code>$Bar</code></td><td><code>$Bar.work();</code></td></tr>
<tr><td><code>&lt;Baz&gt;</code></td><td><code>print(&lt;Baz&gt;);</code></td></tr>
<tr><td><code>#HELLO#</code></td><td><code>let x = #HELLO#;</code></td></tr>
<tr><td><code>%HEY%</code></td><td><code>%HEY% += 1;</code></td></tr>
</tbody></table>
</div><div id="admonition-tip-avoid-normal-words" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-avoid-normal-words-title">
<div class="admonition-title">
<div id="admonition-tip-avoid-normal-words-title">
<p>Tip: Avoid normal words</p>
</div>
<a class="admonition-anchor-link" href="patterns/macros.html#admonition-tip-avoid-normal-words"></a>
</div>
<div>
<p>Avoid normal syntax that may show up inside a <a href="patterns//book/language/strings-chars.html">string</a> literal.</p>
<p>For example, if using <code>Target</code> as a macro:</p>
<pre><code class="language-rust">// This script...
Target.do_damage(10);

if Target.hp &lt;= 0 {
    print("Target is destroyed!");
}

// Will turn to this...
entities["monster"].do_damage(10);

if entities["monster"].hp &lt;= 0 {
    // Text in string literal erroneously replaced!
    print("entities["monster"] is destroyed!");
}</code></pre>
</div>
</div>
<h2 id="global-searchreplace"><a class="header" href="#global-searchreplace">Global Search/Replace</a></h2>
<pre><code class="language-rust">// Replace macros with expansions
let script = script.replace("#FOO", "foo[x][y].bar[z].baz");

let mut scope = Scope::new();

// Add global variables
scope.push("foo", ...);
scope.push_constant("x", ...);
scope.push_constant("y", ...);
scope.push_constant("z", ...);

// Run the script as normal
engine.run_with_scope(&amp;mut scope, script)?;</code></pre>
<div id="admonition-example-script" class="admonition admonish-example small" role="note" aria-labelledby="admonition-example-script-title">
<div class="admonition-title">
<div id="admonition-example-script-title">
<p>Example script</p>
</div>
<a class="admonition-anchor-link" href="patterns/macros.html#admonition-example-script"></a>
</div>
<div>
<pre><code class="language-js">print(`Found entity FOO at (${x},${y},${z})`);

let speed = #FOO.speed;

if speed &lt; 42 {
    #FOO.speed *= 2;
} else {
    #FOO.teleport(#FOO.home());
}

print(`FOO is now at (${ #FOO.current_location() })`);
</code></pre>
</div>
</div>
<div id="admonition-character-positions" class="admonition admonish-bug small" role="note" aria-labelledby="admonition-character-positions-title">
<div class="admonition-title">
<div id="admonition-character-positions-title">
<p>Character positions</p>
</div>
<a class="admonition-anchor-link" href="patterns/macros.html#admonition-character-positions"></a>
</div>
<div>
<p>After macro expansion, the <em>character positions</em> of different script
elements will be shifted based on the length of the expanded text.</p>
<p>Therefore, error positions may no longer point to the correct locations
in the original, unexpanded scripts.</p>
<p>Line numbers are not affected.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="one-engine-instance-per-call"><a class="header" href="#one-engine-instance-per-call">One <code>Engine</code> Instance Per Call</a></h1>
<div id="admonition-usage-scenario" class="admonition admonish-info" role="note" aria-labelledby="admonition-usage-scenario-title">
<div class="admonition-title">
<div id="admonition-usage-scenario-title">
<p>Usage scenario</p>
</div>
<a class="admonition-anchor-link" href="patterns/parallel.html#admonition-usage-scenario"></a>
</div>
<div>
<ul>
<li>
<p>A system where scripts are called a <em>lot</em>, in tight loops or in parallel.</p>
</li>
<li>
<p>Keeping a global <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> instance is sub-optimal due to contention and locking.</p>
</li>
<li>
<p>Scripts need to be executed independently from each other, perhaps concurrently.</p>
</li>
<li>
<p>Scripts are used to <a href="patterns//book/engine/func.html">create Rust closures</a> that are stored and may be called at any time,
perhaps concurrently. In this case, the <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> instance is usually moved into the closure itself.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-key-concepts" class="admonition admonish-abstract" role="note" aria-labelledby="admonition-key-concepts-title">
<div class="admonition-title">
<div id="admonition-key-concepts-title">
<p>Key concepts</p>
</div>
<a class="admonition-anchor-link" href="patterns/parallel.html#admonition-key-concepts"></a>
</div>
<div>
<ul>
<li>
<p>Rhai’s <a href="patterns//book/engine/compile.html"><code>AST</code></a> structure is sharable – meaning that one copy of the <a href="patterns//book/engine/compile.html"><code>AST</code></a> can be run on
multiple instances of <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> simultaneously.</p>
</li>
<li>
<p>Rhai’s <a href="patterns//book/rust/packages/index.html">packages</a> and <a href="patterns//book/rust/modules/index.html">modules</a> are also sharable.</p>
</li>
<li>
<p>This means that <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> instances can be <em>decoupled</em> from the base system (<a href="patterns//book/rust/packages/index.html">packages</a> and
<a href="patterns//book/rust/modules/index.html">modules</a>) as well as the scripts (<a href="patterns//book/engine/compile.html"><code>AST</code></a>) so they can be created very cheaply.</p>
</li>
</ul>
</div>
</div>
<h2 id="procedure"><a class="header" href="#procedure">Procedure</a></h2>
<ul>
<li>
<p>Gather up all common custom functions into a <a href="patterns//book/rust/packages/create.html">custom package</a>.</p>
<ul>
<li>
<p>This <a href="patterns//book/rust/packages/create.html">custom package</a> should also include standard <a href="patterns//book/rust/packages/index.html">packages</a> needed. For example, to duplicate
<code>Engine::new</code>, use a <a href="patterns//book/rust/packages/builtin.html"><code>StandardPackage</code></a>.</p>
</li>
<li>
<p><a href="patterns//book/rust/packages/index.html">Packages</a> are sharable, so using a <a href="patterns//book/rust/packages/create.html">custom package</a> is <em>much cheaper</em> than registering all the
functions one by one.</p>
</li>
</ul>
</li>
<li>
<p>Store a global <a href="patterns//book/engine/compile.html"><code>AST</code></a> for use with all <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> instances.</p>
</li>
<li>
<p>Always use <code>Engine::new_raw</code> to create a <a href="patterns//book/engine/raw.html">raw <code>Engine</code></a>, instead of <code>Engine::new</code> which is <em>much</em>
more expensive. A <a href="patterns//book/engine/raw.html">raw <code>Engine</code></a> is <em>extremely</em> cheap to create.</p>
</li>
<li>
<p>Register the <a href="patterns//book/rust/packages/create.html">custom package</a> with the <a href="patterns//book/engine/raw.html">raw <code>Engine</code></a> via <code>Package::register_into_engine</code>.</p>
</li>
</ul>
<h2 id="examples-18"><a class="header" href="#examples-18">Examples</a></h2>
<pre><code class="language-rust">use rhai::def_package;
use rhai::packages::{Package, StandardPackage};
use rhai::FuncRegistration;

// Define the custom package 'MyCustomPackage'.
def_package! {
    /// My own personal super-duper custom package
    // Aggregate other base packages simply by listing them after the colon.
    pub MyCustomPackage(module) : StandardPackage {
      // Register additional Rust functions.
      FuncRegistration::new("foo")
          .with_params(&amp;["s: ImmutableString", "i64"])
          .set_into_module(module, |s: ImmutableString| foo(s.into_owned()));
    }
}

let ast = /* ... some AST ... */;

let my_custom_package = MyCustomPackage::new();

// The following loop creates 10,000 Engine instances!

for x in 0..10_000 {
    // Create a raw Engine - extremely cheap
    let mut engine = Engine::new_raw();

    // Register custom package - cheap
    my_custom_package.register_into_engine(&amp;mut engine);

    // Evaluate script
    engine.run_ast(&amp;ast)?;
}</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="multi-threaded-synchronization"><a class="header" href="#multi-threaded-synchronization">Multi-Threaded Synchronization</a></h1>
<div id="admonition-usage-scenarios" class="admonition admonish-info" role="note" aria-labelledby="admonition-usage-scenarios-title">
<div class="admonition-title">
<div id="admonition-usage-scenarios-title">
<p>Usage scenarios</p>
</div>
<a class="admonition-anchor-link" href="patterns/multi-threading.html#admonition-usage-scenarios"></a>
</div>
<div>
<ul>
<li>
<p>A system needs to communicate with an <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> running in a separate thread.</p>
</li>
<li>
<p>Multiple <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a>s running in separate threads need to coordinate/synchronize with each other.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-key-concepts" class="admonition admonish-abstract" role="note" aria-labelledby="admonition-key-concepts-title">
<div class="admonition-title">
<div id="admonition-key-concepts-title">
<p>Key concepts</p>
</div>
<a class="admonition-anchor-link" href="patterns/multi-threading.html#admonition-key-concepts"></a>
</div>
<div>
<ul>
<li>
<p>An MPSC channel (or any other appropriate synchronization primitive) is used to send/receive
messages to/from an <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> running in a separate thread.</p>
</li>
<li>
<p>An API is registered with the <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> that is essentially <em>blocking</em> until synchronization is achieved.</p>
</li>
</ul>
</div>
</div>
<h2 id="example-23"><a class="header" href="#example-23">Example</a></h2>
<pre><code class="language-rust">use rhai::{Engine};

fn main() {
    // Channel: Script -&gt; Master
    let (tx_script, rx_master) = std::sync::mpsc::channel();
    // Channel: Master -&gt; Script
    let (tx_master, rx_script) = std::sync::mpsc::channel();

    // Spawn thread with Engine
    std::thread::spawn(move || {
        // Create Engine
        let mut engine = Engine::new();

        // Register API
        // Notice that the API functions are blocking
        engine.register_fn("get", move || rx_script.recv().unwrap())
              .register_fn("put", move |v: i64| tx_script.send(v).unwrap());

        // Run script
        engine.run(
        r#"
            print("Starting script loop...");

            loop {
                // The following call blocks until there is data
                // in the channel
                let x = get();
                print(`Script Read: ${x}`);

                x += 1;

                print(`Script Write: ${x}`);

                // The following call blocks until the data
                // is successfully sent to the channel
                put(x);
            }
        "#).unwrap();
    });

    // This is the main processing thread

    println!("Starting main loop...");

    let mut value = 0_i64;

    while value &lt; 10 {
        println!("Value: {value}");
        // Send value to script
        tx_master.send(value).unwrap();
        // Receive value from script
        value = rx_master.recv().unwrap();
    }
}</code></pre>
<h2 id="considerations-for-sync"><a class="header" href="#considerations-for-sync">Considerations for <a href="patterns//book/start/features.html"><code>sync</code></a></a></h2>
<p><code>std::mpsc::Sender</code> and <code>std::mpsc::Receiver</code> are not <code>Sync</code>, therefore they cannot be used in
registered functions if the <a href="patterns//book/start/features.html"><code>sync</code></a> feature is enabled.</p>
<p>In that situation, it is possible to wrap the <code>Sender</code> and <code>Receiver</code> each in a <code>Mutex</code> or <code>RwLock</code>,
which makes them <code>Sync</code>.</p>
<p>This, however, incurs the additional overhead of locking and unlocking the <code>Mutex</code> or <code>RwLock</code>
during every function call, which is technically not necessary because there are no other references
to them.</p>
<div id="admonition-async" class="admonition admonish-note" role="note" aria-labelledby="admonition-async-title">
<div class="admonition-title">
<div id="admonition-async-title">
<p>Async</p>
</div>
<a class="admonition-anchor-link" href="patterns/multi-threading.html#admonition-async"></a>
</div>
<div>
<p>The example above highlights the fact that Rhai scripts can call any Rust function, including ones
that are <em>blocking</em>.</p>
<p>However, Rhai is essentially a blocking, single-threaded engine. Therefore it does <em>not</em> provide an
async API.</p>
<p>That means, although it is simple to use Rhai within a multi-threading environment where blocking a
thread is acceptable or even expected, it is currently not possible to call <em>async</em> functions within
Rhai scripts because there is no mechanism in <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> to wrap the state of the call stack inside
a future.</p>
<p>Fortunately an <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> is re-entrant so it can be shared among many async tasks. It is usually
possible to split a script into multiple parts to avoid having to call async functions.</p>
<p>Creating an <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> is also relatively cheap (extremely cheap if creating a <a href="patterns//book/engine/raw.html">raw <code>Engine</code></a>),
so it is also a valid pattern to spawn a new <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> instance for each task.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="blockingasync-function-calls"><a class="header" href="#blockingasync-function-calls">Blocking/Async Function Calls</a></h1>
<div id="admonition-warning-async-and-scripting-dont-mix-well" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-warning-async-and-scripting-dont-mix-well-title">
<div class="admonition-title">
<div id="admonition-warning-async-and-scripting-dont-mix-well-title">
<p>Warning: Async and scripting don’t mix well</p>
</div>
<a class="admonition-anchor-link" href="patterns/blocking.html#admonition-warning-async-and-scripting-dont-mix-well"></a>
</div>
<div>
<p>Otherwise, you reinvent the <a href="https://en.wiktionary.org/wiki/callback_hell"><em>Callback Hell</em></a>
which is JavaScript before all the async extensions.</p>
</div>
</div>
<div id="admonition-usage-scenarios" class="admonition admonish-info" role="note" aria-labelledby="admonition-usage-scenarios-title">
<div class="admonition-title">
<div id="admonition-usage-scenarios-title">
<p>Usage scenarios</p>
</div>
<a class="admonition-anchor-link" href="patterns/blocking.html#admonition-usage-scenarios"></a>
</div>
<div>
<ul>
<li>A system’s API contains async functions.</li>
</ul>
</div>
</div>
<div id="admonition-key-concepts" class="admonition admonish-abstract" role="note" aria-labelledby="admonition-key-concepts-title">
<div class="admonition-title">
<div id="admonition-key-concepts-title">
<p>Key concepts</p>
</div>
<a class="admonition-anchor-link" href="patterns/blocking.html#admonition-key-concepts"></a>
</div>
<div>
<ul>
<li>
<p>This pattern is based upon the <em><a href="patterns/multi-threading.html">Multi-Threaded Synchronization</a></em> pattern.</p>
</li>
<li>
<p>An independent thread is used to run the scripting <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a>.</p>
</li>
<li>
<p>An MPSC channel (or any other appropriate synchronization primitive) is used to send function call
arguments, packaged as a message, to another Rust thread that will perform the actual async calls.</p>
</li>
<li>
<p>Results are marshaled back to the <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> thread via another MPSC channel.</p>
</li>
</ul>
</div>
</div>
<h2 id="implementation-8"><a class="header" href="#implementation-8">Implementation</a></h2>
<div id="admonition-see-also" class="admonition admonish-info side" role="note" aria-labelledby="admonition-see-also-title">
<div class="admonition-title">
<div id="admonition-see-also-title">
<p>See also</p>
</div>
<a class="admonition-anchor-link" href="patterns/blocking.html#admonition-see-also"></a>
</div>
<div>
<p>See the <em><a href="patterns/multi-threading.html">Multi-Threaded Synchronization</a></em> pattern.</p>
</div>
</div>
<ol>
<li>
<p>Spawn a thread to run the scripting <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a>.  Usually the <a href="patterns//book/start/features.html"><code>sync</code></a> feature is
<em>NOT</em> used for this pattern.</p>
</li>
<li>
<p>Spawn another thread (the <code>worker</code> thread) that can perform the actual async calls in Rust.
This thread may actually be the main thread of the program.</p>
</li>
<li>
<p>Create a pair of MPSC channels (named <code>command</code> and <code>reply</code> below) for full-duplex
communications between the two threads.</p>
</li>
<li>
<p>Register async API function to the <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> with a closure that captures the MPSC end-points.</p>
</li>
<li>
<p>If there are more than one async function, the receive end-point on the <code>reply</code> channel can simply be cloned.
The send end-point on the <code>command</code> channel can be wrapped in an <code>Arc&lt;Mutex&lt;Channel&gt;&gt;</code> for shared access.</p>
</li>
<li>
<p>In the async function, the name of the function and call arguments are serialized into JSON
(or any appropriate message format) and sent to <code>command</code> channel, where they’ll be removed
by the <code>worker</code> thread and the appropriate async function called.</p>
</li>
<li>
<p>The <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> blocks on the function call, waiting for a reply message on the <code>reply</code> channel.</p>
</li>
<li>
<p>When the async function call complete on the <code>worker</code> thread, the result is sent back to
the <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> thread via the <code>reply</code> channel.</p>
</li>
<li>
<p>After the result is obtained from the <code>reply</code> channel, the <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> returns it as the return value
of the function call, ending the block and continuing evaluation.</p>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="passing-external-references-to-rhai-unsafe"><a class="header" href="#passing-external-references-to-rhai-unsafe">Passing External References to Rhai (Unsafe)</a></h1>
<div id="admonition-dont-do-it" class="admonition admonish-danger" role="note" aria-labelledby="admonition-dont-do-it-title">
<div class="admonition-title">
<div id="admonition-dont-do-it-title">
<p>Don’t Do It™</p>
</div>
<a class="admonition-anchor-link" href="patterns/references.html#admonition-dont-do-it"></a>
</div>
<div>
<p>As with anything <code>unsafe</code>, don’t do this unless you have exhausted all possible alternatives.</p>
<p>There are usually alternatives.</p>
</div>
</div>
<div id="admonition-usage-scenario" class="admonition admonish-info" role="note" aria-labelledby="admonition-usage-scenario-title">
<div class="admonition-title">
<div id="admonition-usage-scenario-title">
<p>Usage scenario</p>
</div>
<a class="admonition-anchor-link" href="patterns/references.html#admonition-usage-scenario"></a>
</div>
<div>
<ul>
<li>
<p>A system where an embedded <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> is used to call scripts within a callback function/closure
from some external system.</p>
<p>This is extremely common when working with an ECS (Entity Component System) or a GUI library where the script
must draw via the provided graphics context.</p>
</li>
<li>
<p>Said external system provides only <em>references</em> (mutable or immutable) to work with their internal states.</p>
</li>
<li>
<p>Such states are not available outside of references (and therefore cannot be made shared).</p>
</li>
<li>
<p>Said external system’s API require such states to function.</p>
</li>
<li>
<p>It is impossible to pass references into Rhai because the <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> does not track lifetimes.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-key-concepts" class="admonition admonish-abstract" role="note" aria-labelledby="admonition-key-concepts-title">
<div class="admonition-title">
<div id="admonition-key-concepts-title">
<p>Key concepts</p>
</div>
<a class="admonition-anchor-link" href="patterns/references.html#admonition-key-concepts"></a>
</div>
<div>
<ul>
<li>
<p>Make a newtype that wraps an integer which is set to the CPU’s pointer size (typically <code>usize</code>).</p>
</li>
<li>
<p><a href="https://doc.rust-lang.org/std/mem/fn.transmute.html"><code>transmute</code></a> the reference provided by the system into an integer and store it within the newtype.
This requires <code>unsafe</code> code.</p>
</li>
<li>
<p>Use the newtype as a <em>handle</em> for all registered API functions, <a href="https://doc.rust-lang.org/std/mem/fn.transmute.html"><code>transmute</code></a> the integer back
to a reference before use. This also requires <code>unsafe</code> code.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-here-be-dragons" class="admonition admonish-bug" role="note" aria-labelledby="admonition-here-be-dragons-title">
<div class="admonition-title">
<div id="admonition-here-be-dragons-title">
<p>Here be dragons…</p>
</div>
<a class="admonition-anchor-link" href="patterns/references.html#admonition-here-be-dragons"></a>
</div>
<div>
<p>Make <strong>absolutely sure</strong> that the newtype is never stored anywhere permanent (e.g. in a <a href="patterns//book/engine/scope.html"><code>Scope</code></a>)
nor does it ever live outside of the reference’s scope!</p>
<p>Otherwise, a crash is the system being nice to you…</p>
</div>
</div>
<h2 id="example-24"><a class="header" href="#example-24">Example</a></h2>
<pre><code class="language-rust">/// Newtype wrapping a reference (pointer) cast into 'usize'
/// together with a unique ID for protection.
#[derive(Debug, Eq, PartialEq, Clone, Hash)]
pub struct WorldHandle(usize, i64);

/// Create handle from reference
impl From&lt;&amp;mut World&gt; for WorldHandle {
    fn from(world: &amp;mut World) -&gt; Self {
        Self::new(world)
    }
}

/// Recover reference from handle
impl AsMut&lt;World&gt; for WorldHandle {
    fn as_mut(&amp;mut self) -&gt; &amp;mut World {
        unsafe { std::mem::transmute(self.0) }
    }
}

impl WorldHandle {
    /// Create handle from reference, using a random number as unique ID
    pub fn new(world: &amp;mut World) -&gt; Self {
        let handle =unsafe { std::mem::transmute(world) };
        let unique_id = rand::random();

        Self(handle, unique_id)
    }

    /// Get the unique ID of this instance
    pub fn unique_id(&amp;self) -&gt; i64 {
        self.1
    }
}

/// API for handle to 'World'
#[export_module]
pub mod handle_module {
    pub type Handle = WorldHandle;

    /// Draw a bunch of pretty shapes.
    #[rhai_fn(return_raw)]
    pub fn draw(context: NativeCallContext, handle: &amp;mut Handle, shapes: Array) -&gt; Result&lt;(), Box&lt;EvalAltResult&gt;&gt; {
        // Double check the pointer is still fresh
        // by comparing the handle's unique ID with
        // the version stored in the engine's tag!
        if handle.unique_id() != context.tag() {
            return "Ouch! The handle is stale!".into();
        }

        // Get the reference to 'World'
        let world: &amp;mut World = handle.as_mut();

        // ... work with reference
        world.draw_really_pretty_shapes(shapes);

        Ok(())
    }
}

// Register API for handle type
engine.register_global_module(exported_module!(handle_module).into());

// Successfully pass a reference to 'World' into Rhai
super_ecs_system.query(...).for_each(|world: &amp;mut World| {
    // Create handle from reference to 'World'
    let handle: WorldHandle = world.into();

    // Set the handle's ID into the engine's tag.
    // Alternatively, use 'Engine::call_fn_with_options'.
    engine.set_default_tag(handle.unique_id());

    // Add handle into scope
    let mut scope = Scope::new();
    scope.push("world", handle);
    
    // Work with handle
    engine.run_with_scope(&amp;mut scope, "world.draw([1, 2, 3])")

    // Make sure no instance of 'handle' leaks outside this scope!
});</code></pre>
<div id="admonition-here-be-many-dragons" class="admonition admonish-bug" role="note" aria-labelledby="admonition-here-be-many-dragons-title">
<div class="admonition-title">
<div id="admonition-here-be-many-dragons-title">
<p>Here be Many Dragons!</p>
</div>
<a class="admonition-anchor-link" href="patterns/references.html#admonition-here-be-many-dragons"></a>
</div>
<div>
<p>It is of utmost importance that no instance of the handle newtype ever <strong><em>leaks</em></strong> outside of the
appropriate scope where the wrapped reference may no longer be valid.</p>
<p>For example, do not allow the script to store a copy of the handle anywhere that can
potentially be persistent (e.g. within an <a href="patterns//book/language/object-maps.html">object map</a>).</p>
<h4 id="safety-check-via-unique-id"><a class="header" href="#safety-check-via-unique-id">Safety check via unique ID</a></h4>
<p>One solution, as illustrated in the example, is to always tag each handle instance together with
a unique random ID. That same ID can then be set into the <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> (via <a href="https://docs.rs/rhai/1.22.0/rhai/struct.Engine.html#method.set_default_tag"><code>Engine::set_default_tag</code></a>)
before running scripts.</p>
<p>Before executing any API function, first check whether the handle’s ID matches that of the current <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a>
(via <a href="patterns//book/rust/context.html"><code>NativeCallContext::tag</code></a>). If they differ, the handle is stale and should never be used;
an error should be returned instead.</p>
<h4 id="alternative-to-engineset_default_tag"><a class="header" href="#alternative-to-engineset_default_tag">Alternative to <code>Engine::set_default_tag</code></a></h4>
<p>Alternatively, if the <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> cannot be made mutable, use <code>Engine::call_fn_with_options</code>
to set the ID before directly calling a script <a href="patterns//book/language/functions.html">function</a> in a compiled <a href="patterns//book/engine/compile.html"><code>AST</code></a>.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="static-hashing"><a class="header" href="#static-hashing">Static Hashing</a></h1>
<p>To counter <a href="https://en.wikipedia.org/wiki/Denial-of-service_attack">DOS</a> attacks, the <em>hasher</em> used by Rhai, <a href="https://crates.io/crates/ahash"><code>ahash</code></a>, automatically generates a different
<em>seed</em> for hashing during each compilation and execution run.</p>
<p>This means that hash values generated by the hasher will not be <em>stable</em> – they change
during each compile, and during each run.</p>
<p>For certain niche scenarios, however, dynamic hashes are undesirable.</p>
<p>So, when <em>static hashing</em> is employed, all hashing uses a fixed, predictable seed all the time.</p>
<div id="admonition-hashing-seed" class="admonition admonish-abstract small" role="note" aria-labelledby="admonition-hashing-seed-title">
<div class="admonition-title">
<div id="admonition-hashing-seed-title">
<p>Hashing seed</p>
</div>
<a class="admonition-anchor-link" href="patterns/static-hash.html#admonition-hashing-seed"></a>
</div>
<div>
<p>A hashing seed requires four 64-bit numbers (i.e. <code>u64</code>).</p>
</div>
</div>
<div id="admonition-tip-static-hashes-are-consistent-and-predictable" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-static-hashes-are-consistent-and-predictable-title">
<div class="admonition-title">
<div id="admonition-tip-static-hashes-are-consistent-and-predictable-title">
<p>Tip: Static hashes are consistent and predictable</p>
</div>
<a class="admonition-anchor-link" href="patterns/static-hash.html#admonition-tip-static-hashes-are-consistent-and-predictable"></a>
</div>
<div>
<p>Under static hashing, the same function signature <em>always</em> generate the same hash value,
given the same seed.</p>
</div>
</div>
<div id="admonition-warning-safety-considerations" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-warning-safety-considerations-title">
<div class="admonition-title">
<div id="admonition-warning-safety-considerations-title">
<p>Warning: Safety considerations</p>
</div>
<a class="admonition-anchor-link" href="patterns/static-hash.html#admonition-warning-safety-considerations"></a>
</div>
<div>
<p>A fixed hashing seed enlarges the attack surface of Rhai to malicious intent
(e.g. <a href="https://en.wikipedia.org/wiki/Denial-of-service_attack">DOS</a> attacks).</p>
</div>
</div>
<h2 id="set-at-run-time"><a class="header" href="#set-at-run-time">Set at Run-Time</a></h2>
<p>Call the static function <code>rhai::config::hashing::set_ahash_seed</code> with four <code>u64</code> numbers that make
up the hashing seed.</p>
<p>The seed specified is always used to initialize the hasher.</p>
<pre><code class="language-rust">// Set specific hashing seed - do this BEFORE anything else!
rhai::config::hashing::set_ahash_seed(Some([123, 456, 789, 42]))?;

// ... from now on, all hashing will be predictable
let engine = Engine::new();</code></pre>
<div id="admonition-warning-only-call-once" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-warning-only-call-once-title">
<div class="admonition-title">
<div id="admonition-warning-only-call-once-title">
<p>Warning: Only call once</p>
</div>
<a class="admonition-anchor-link" href="patterns/static-hash.html#admonition-warning-only-call-once"></a>
</div>
<div>
<p><code>rhai::config::hashing::set_ahash_seed</code> can only ever be called <em>once</em>,
and must be called <em>BEFORE</em> performing any operation on Rhai (e.g. creating
an <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a>).</p>
<p>Calling it a second time simply returns an error.</p>
</div>
</div>
<h2 id="set-at-compile-time"><a class="header" href="#set-at-compile-time">Set at Compile Time</a></h2>
<p>The hashing seed can also be provided, at <em>compile time</em>, via the environment variable
<code>RHAI_AHASH_SEED</code>, with four <code>u64</code> numbers that must be specified in Rust array literal format.</p>
<div id="admonition-warning" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="patterns/static-hash.html#admonition-warning"></a>
</div>
<div>
<p>If a hashing seed is also set via <code>rhai::config::hashing::set_ahash_seed</code>,
this environment variable has no effect.</p>
</div>
</div>
<pre><code class="language-sh">RHAI_AHASH_SEED="[123, 456, 789, 42]" cargo build ...
</code></pre>
<p>The seed specified in <code>RHAI_AHASH_SEED</code> is always used to initialize the hasher.</p>
<p>If the environment variable is missing, or it contains all zeros (i.e. <code>[0, 0, 0, 0]</code>),
then static hashing is disabled.</p>
<h2 id="tldr-5"><a class="header" href="#tldr-5">TL;DR</a></h2>
<div id="admonition-why-cant-we-tell-ahash-to-use-a-static-fixed-seed" class="admonition admonish-question" role="note" aria-labelledby="admonition-why-cant-we-tell-ahash-to-use-a-static-fixed-seed-title">
<div class="admonition-title">
<div id="admonition-why-cant-we-tell-ahash-to-use-a-static-fixed-seed-title">
<p>Why can’t we tell <code>ahash</code> to use a static (fixed) seed?</p>
</div>
<a class="admonition-anchor-link" href="patterns/static-hash.html#admonition-why-cant-we-tell-ahash-to-use-a-static-fixed-seed"></a>
</div>
<div>
<p>For static hashing seed, <a href="https://crates.io/crates/ahash"><code>ahash</code></a> requires:</p>
<ul>
<li><code>default-features = false</code></li>
<li><code>runtime-rng</code> feature is <em>not</em> set (default on)</li>
<li><code>compile-time-rng</code> feature is <em>not</em> set</li>
</ul>
<h4 id="the-bane-of-additive-cargo-features"><a class="header" href="#the-bane-of-additive-cargo-features">The bane of additive Cargo features</a></h4>
<p>However, <a href="https://crates.io/crates/ahash"><code>ahash</code></a> is also extremely popular, used by many many other crates,
most notably <a href="https://crates.io/crates/hashbrown"><code>hashbrown</code></a>.</p>
<p>Chances are that there are dependency crates that in turn depend on <a href="https://crates.io/crates/ahash"><code>ahash</code></a> with
default features. Since cargo features are <em>additive</em>, it is almost certain that <a href="https://crates.io/crates/ahash"><code>ahash</code></a>
will use a runtime-generated seed for large projects.</p>
<p>Hence, there exists a need to tell <a href="https://crates.io/crates/ahash"><code>ahash</code></a> to use a fixed seed, even when its feature flags
say otherwise.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="serialize-an-ast"><a class="header" href="#serialize-an-ast">Serialize an AST</a></h1>
<p>In many situations, it is tempting to <em>serialize</em> an <a href="patterns//book/engine/compile.html"><code>AST</code></a>, so that it can be loaded and recreated
later on.</p>
<p>In Rhai, there is usually little reason to do so.</p>
<div id="admonition-dont-do-this" class="admonition admonish-failure small" role="note" aria-labelledby="admonition-dont-do-this-title">
<div class="admonition-title">
<div id="admonition-dont-do-this-title">
<p>Don’t Do This</p>
</div>
<a class="admonition-anchor-link" href="patterns/serialize-ast.html#admonition-dont-do-this"></a>
</div>
<div>
<p>Serialize the <a href="patterns//book/engine/compile.html"><code>AST</code></a> into some format for storage.</p>
</div>
</div>
<div id="admonition-do-this" class="admonition admonish-success small" role="note" aria-labelledby="admonition-do-this-title">
<div class="admonition-title">
<div id="admonition-do-this-title">
<p>Do This</p>
</div>
<a class="admonition-anchor-link" href="patterns/serialize-ast.html#admonition-do-this"></a>
</div>
<div>
<p>Store a copy of the original script, preferably compressed.</p>
</div>
</div>
<p>Storing the original script text, preferably compressed (via <code>gzip</code> etc.) usually yields much smaller data size.</p>
<p>Plus, is it possibly faster to recompile the original script than to recreate the <a href="patterns//book/engine/compile.html"><code>AST</code></a> via
deserialization.</p>
<p>That is because the deserialization processing is essentially a form of parsing, in this case
parsing the serialized data into an <a href="patterns//book/engine/compile.html"><code>AST</code></a> – an equivalent process to what Rhai does, which
is parsing the script text into the same <a href="patterns//book/engine/compile.html"><code>AST</code></a>.</p>
<h2 id="illustration"><a class="header" href="#illustration">Illustration</a></h2>
<p>The following script occupies only 42 bytes, possibly less if compressed.
That is only slightly more than 5 words on a 64-bit CPU!</p>
<pre><code class="language-rust">fn sum(x, y) { x + y }
print(sum(42, 1));</code></pre>
<p>The <a href="patterns//book/engine/compile.html"><code>AST</code></a> would be <em>much</em> more complicated and looks something like this:</p>
<pre><code class="language-json">FnDef {
    Name: "sum",
    ThisType: None,
    Parameters: [
        "x",
        "y"
    ],
    Body: Block [
        Return {
            Expression {
                FnCall {
                    Name: "+",
                    Arguments: [
                        Variable "x",
                        Variable "y"
                    ]
                }
            }
        }
    ]
}
Block [
    FnCall {
        Name: "print",
        Arguments: [
            Expression {
                FnCall {
                    Name: "sum",
                    Arguments: [
                        Constant 42,
                        Constant 1
                    ]
                }
            }
        ]
    }
]
</code></pre>
<p>which would take <em>much</em> more space to serialize.</p>
<p>For instance, the constant 1 alone would take up 8 bytes, while the script text takes up only one byte!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="domain-specific-tools"><a class="header" href="#domain-specific-tools">Domain-Specific Tools</a></h1>
<div id="admonition-usage-scenario" class="admonition admonish-info" role="note" aria-labelledby="admonition-usage-scenario-title">
<div class="admonition-title">
<div id="admonition-usage-scenario-title">
<p>Usage scenario</p>
</div>
<a class="admonition-anchor-link" href="patterns/domain-tools.html#admonition-usage-scenario"></a>
</div>
<div>
<ul>
<li>
<p>A system has a <em>domain-specific</em> API, requiring <a href="patterns//book/rust/custom-types.html">custom types</a> and/or
Rust <a href="patterns//book/rust/functions.html">functions</a> to be registered and exposed to scripting.</p>
</li>
<li>
<p>The system’s behavior is controlled by Rhai script <a href="patterns//book/language/functions.html">functions</a>, such as in the
<a href="patterns/events.html"><em>Scriptable Event Handler with State</em></a>, <a href="patterns/control.html"><em>Control Layer</em></a> or
<a href="patterns/singleton.html"><em>Singleton Command Object</em></a> patterns.</p>
</li>
<li>
<p>It is desirable to be able to <em>interactively</em> test the system with different scripts,
and/or <a href="patterns//book/engine/debugging/debugger.html">debug</a> them.</p>
</li>
</ul>
</div>
</div>
<div id="admonition-key-concepts" class="admonition admonish-abstract" role="note" aria-labelledby="admonition-key-concepts-title">
<div class="admonition-title">
<div id="admonition-key-concepts-title">
<p>Key concepts</p>
</div>
<a class="admonition-anchor-link" href="patterns/domain-tools.html#admonition-key-concepts"></a>
</div>
<div>
<ul>
<li>
<p>Leverage the pre-packaged <a href="patterns//book/start/bin.html">bin tools</a> – it is easy because each of them is
one single source file.</p>
</li>
<li>
<p>Modify the <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a> creation code to include domain-specific registrations.</p>
</li>
</ul>
</div>
</div>
<h2 id="implementation-9"><a class="header" href="#implementation-9">Implementation</a></h2>
<h3 id="copy-necessary-tool-source-files"><a class="header" href="#copy-necessary-tool-source-files">Copy necessary tool source files</a></h3>
<p>Each <a href="patterns//book/start/bin.html">bin tool</a> is a single source file.</p>
<p>Download the necessary one(s) into the project’s <code>bin</code> or <code>example</code> subdirectory.</p>
<div class="table-wrapper"><table><thead><tr><th>Select this source file</th><th>To make</th></tr></thead><tbody>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/src/bin/rhai-run.rs"><code>rhai-run.rs</code></a></td><td>a simple script runner for the system</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/src/bin/rhai-repl.rs"><code>rhai-repl.rs</code></a></td><td>an interactive REPL for the system</td></tr>
<tr><td><a href="https://github.com/rhaiscript/rhai/blob/main/src/bin/rhai-dbg.rs"><code>rhai-dbg.rs</code></a></td><td>a script debugger for the system</td></tr>
</tbody></table>
</div>
<h4 id="example-25"><a class="header" href="#example-25">Example</a></h4>
<pre><code class="language-sh">rhai-run.rs -&gt; /path/to/my_project/examples/test.rs
rhai-repl.rs -&gt; /path/to/my_project/examples/repl.rs
rhai-dbg.rs -&gt; /path/to/my_project/examples/db.rs
</code></pre>
<h3 id="leverage-engine-configuration-code-in-the-project"><a class="header" href="#leverage-engine-configuration-code-in-the-project">Leverage <code>Engine</code> configuration code in the project</a></h3>
<p>Assume the project already contains configuration code for a customized <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a>.</p>
<pre><code class="language-rust">use rhai::Engine;
use rhai::plugin::*;

// Domain-specific data types
use my_project::*;

#[export_module]
mod my_domain_api {
            :
            :
    // plugin module
            :
            :
}

// This function creates a new Rhai scripting engine and
// configures it properly
fn create_scripting_engine(config: MySystemConfig) -&gt; Engine {
    let mut engine = Engine::new();

    // Register domain-specific API into the Engine
    engine.register_type_with_name::&lt;MyObject&gt;("MyObject")
          .register_type_with_name::&lt;MyOtherObject&gt;("MyOtherObject")
          .register_fn(...)
          .register_fn(...)
          .register_fn(...)
                    :
                    :
        // register API functions
                    :
                    :
          .register_get_set(...)
          .register_index_get_set(...)
          .register_fn(...);

    // Plugin modules can be used to easily and quickly
    // register an entire API
    engine.register_global_module(exported_module!(my_domain_api).into());

    // Configuration options in 'MySystemConfig' may be used
    // to control the Engine's behavior
    if config.strict_mode {
        engine.set_strict_variables(true);
    }

    // Return the scripting engine
    engine
}</code></pre>
<h3 id="modify-engine-creation"><a class="header" href="#modify-engine-creation">Modify <code>Engine</code> creation</a></h3>
<p>Each <a href="patterns//book/start/bin.html">bin tool</a> contains a line that creates the main script <a href="patterns//book/engine/hello-world.html"><code>Engine</code></a>.</p>
<p>Modify it to call the project’s creation function.</p>
<pre><code class="language-rust">// Initialize scripting engine
let mut engine = Engine::new();

// Modify to this:
let mut engine = create_scripting_engine(my_config);</code></pre>
<h3 id="make-sure-that-rhai-has-the-appropriate-features"><a class="header" href="#make-sure-that-rhai-has-the-appropriate-features">Make sure that Rhai has the appropriate feature(s)</a></h3>
<p>In the project’s <code>Cargo.toml</code>, specify the Rhai dependency with <code>bin-features</code>.</p>
<pre><code class="language-toml">[dependencies]
rhai = { version = "1.22.0", features = ["bin-features"] }
</code></pre>
<h3 id="rebuild"><a class="header" href="#rebuild">Rebuild</a></h3>
<p>Rebuild the project, which should automatically build all the customized tools.</p>
<h3 id="run-tools"><a class="header" href="#run-tools">Run tools</a></h3>
<p>Each customized tool now has access to the entire domain-specific API.
Functions and <a href="patterns//book/rust/custom-types.html">custom types</a> can be used in REPL, <a href="patterns//book/engine/debugging/debugger.html">debugging</a> etc.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="multiple-instantiation"><a class="header" href="#multiple-instantiation">Multiple Instantiation</a></h1>
<p>Rhai’s <a href="patterns//book/start/features.html">features</a> are not strictly additive.  This is easily deduced from the <a href="patterns//book/start/features.html"><code>no_std</code></a> feature
which prepares the crate for <code>no-std</code> builds.  Obviously, turning on this feature has a material
impact on how Rhai behaves.</p>
<p>Many crates resolve this by going the opposite direction: build for <code>no-std</code> in default, but add a
<code>std</code> feature, included by default, which builds for the <code>stdlib</code>.</p>
<p>Rhai, however, is more complex.</p>
<h2 id="rhai-language-features-are-not-additive"><a class="header" href="#rhai-language-features-are-not-additive">Rhai Language Features Are Not Additive</a></h2>
<p>Language features cannot be easily made <em>additive</em>.</p>
<p>That is because the <em>lack</em> of a language feature is a feature by itself.</p>
<div id="admonition-a-practical-illustration" class="admonition admonish-question" role="note" aria-labelledby="admonition-a-practical-illustration-title">
<div class="admonition-title">
<div id="admonition-a-practical-illustration-title">
<p>A practical illustration</p>
</div>
<a class="admonition-anchor-link" href="patterns/multiple.html#admonition-a-practical-illustration"></a>
</div>
<div>
<p>Assume an <em>additive</em> feature called <code>floating-point</code> that adds floating-point support.</p>
<p>Assume also that the application <em>omits</em> the <code>floating-point</code> feature (why? perhaps integers are all
that make sense within the project domain). Floating-point numbers do not even parse under this
configuration and will generate syntax errors.</p>
<p>Now, assume that a dependent crate <em>also</em> depends on Rhai, but a new version suddenly decides to
<em>require</em> floating-point support. That dependent crate would, naturally, specify the
<code>floating-point</code> feature.</p>
<p>Under such circumstances, unless <em>exact</em> versioning is used and the dependent crate depends on a
<em>different</em> version of Rhai, Cargo automatically <em>merges</em> both dependencies, with the <code>floating-point</code>
feature turned on because features are <em>additive</em>.</p>
<p>This will in turn break the application, which by itself specifically omits <code>floating-point</code> and
expects floating-point numbers to be rejected, in unexpected ways. Suddenly and without warning,
floating-point numbers show up in data which the application is not prepared to handle.</p>
<p>There is no way out of this dilemma, because the <em>lack</em> of a language feature can be depended upon
as a feature.</p>
</div>
</div>
<h2 id="multiple-instantiations-of-rhai-within-the-same-project"><a class="header" href="#multiple-instantiations-of-rhai-within-the-same-project">Multiple Instantiations of Rhai Within The Same Project</a></h2>
<p>The trick is to differentiate between multiple identical copies of Rhai, each having
a different <a href="patterns//book/start/features.html">features</a> set, by their <em>sources</em>:</p>
<ul>
<li>
<p>Different versions from <a href="https://crates.io/crates/rhai/"><code>crates.io</code></a> – The official crate.</p>
</li>
<li>
<p>Different releases from <a href="https://github.com/rhaiscript/rhai"><code>GitHub</code></a> – Crate source on GitHub.</p>
</li>
<li>
<p>Forked copy of <a href="https://github.com/rhaiscript/rhai">https://github.com/rhaiscript/rhai</a> on GitHub.</p>
</li>
<li>
<p>Local copy of <a href="https://github.com/rhaiscript/rhai">https://github.com/rhaiscript/rhai</a> downloaded form GitHub.</p>
</li>
</ul>
<p>Use the following configuration in <code>Cargo.toml</code> to pull in multiple copies of Rhai within the same project:</p>
<pre><code class="language-toml">[dependencies]
rhai = { version = "1.22.0", features = [ "no_float" ] }
rhai_github = { git = "https://github.com/rhaiscript/rhai", features = [ "unchecked" ] }
rhai_my_github = { git = "https://github.com/my_github/rhai", branch = "variation1", features = [ "serde", "no_closure" ] }
rhai_local = { path = "../rhai_copy" }
</code></pre>
<p>The example above creates four different modules: <code>rhai</code>, <code>rhai_github</code>, <code>rhai_my_github</code> and
<code>rhai_local</code>, each referring to a different Rhai copy with the appropriate <a href="patterns//book/start/features.html">features</a> set.</p>
<p>Only one crate of any particular version can be used from each source, because Cargo merges all
candidate cases within the same source, adding all <a href="patterns//book/start/features.html">features</a> together.</p>
<p>If more than four different instantiations of Rhai is necessary (why?), create more local
repositories or GitHub forks or branches.</p>
<div id="admonition-no-way-to-avoid-dependency-conflicts" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-no-way-to-avoid-dependency-conflicts-title">
<div class="admonition-title">
<div id="admonition-no-way-to-avoid-dependency-conflicts-title">
<p>No way To avoid dependency conflicts</p>
</div>
<a class="admonition-anchor-link" href="patterns/multiple.html#admonition-no-way-to-avoid-dependency-conflicts"></a>
</div>
<div>
<p>Unfortunately, pulling in Rhai from different sources do not resolve the problem of <a href="patterns//book/start/features.html">features</a>
conflict between dependencies.  Even overriding <code>crates.io</code> via the <code>[patch]</code> manifest section
doesn’t work – all dependencies will eventually find the only one copy.</p>
<p>What is necessary – multiple copies of Rhai, one for each dependent crate that requires it,
together with their <em>unique</em> <a href="patterns//book/start/features.html">features</a> set intact.  In other words, turning off Cargo’s crate
merging feature <em>just for Rhai</em>.</p>
<p>Unfortunately, as of this writing, there is no known method to achieve it.</p>
<p>Therefore, moral of the story: avoid pulling in multiple crates that depend on Rhai.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rhai-language-reference"><a class="header" href="#rhai-language-reference">Rhai Language Reference</a></h1>
<p><img src="ref//book/images/logo/rhai-banner-transparent-colour.svg" alt="Rhai Logo" /></p>
<p>This is a stand-alone reference for the Rhai scripting language.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="comments-1"><a class="header" href="#comments-1">Comments</a></h1>
<p>Comments are C-style, including <code>/*</code> … <code>*/</code> pairs for block comments and <code>//</code> for comments to the
end of the line.</p>
<p>Block comments can be nested.</p>
<pre><code class="language-rust">let /* intruder comment */ name = "Bob";

// This is a very important one-line comment

/* This comment spans
   multiple lines, so it
   only makes sense that
   it is even more important */

/* Fear not, Rhai satisfies all nesting needs with nested comments:
   /*/*/*/*/**/*/*/*/*/
*/</code></pre>
<h1 id="doc-comments-1"><a class="header" href="#doc-comments-1">Doc-Comments</a></h1>
<p>Comments starting with <code>///</code> (three slashes) or <code>/**</code> (two asterisks) are <em>doc-comments</em>.</p>
<p>Doc-comments can only appear in front of <a href="ref/functions.html">function</a> definitions, not any other elements.</p>
<pre><code class="language-rust">/// This is a valid one-line doc-comment
fn foo() {}

/** This is a
 ** valid block
 ** doc-comment
 **/
fn bar(x) {
   /// Syntax error: this doc-comment is invalid
   x + 1
}

/** Syntax error: this doc-comment is invalid */
let x = 42;

/// Syntax error: this doc-comment is also invalid
{
   let x = 42;
}</code></pre>
<div id="admonition-tip-special-cases" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-special-cases-title">
<div class="admonition-title">
<div id="admonition-tip-special-cases-title">
<p>Tip: Special cases</p>
</div>
<a class="admonition-anchor-link" href="ref/comments.html#admonition-tip-special-cases"></a>
</div>
<div>
<p>Long streams of <code>//////</code>… and <code>/*****</code>… do <em>NOT</em> form doc-comments.
This is consistent with popular comment block styles for C-like languages.</p>
<pre><code class="language-rust">///////////////////////////////  &lt;- this is not a doc-comment
// This is not a doc-comment //  &lt;- this is not a doc-comment
///////////////////////////////  &lt;- this is not a doc-comment

// However, watch out for comment lines starting with '///'

//////////////////////////////////////////  &lt;- this is not a doc-comment
/// This, however, IS a doc-comment!!! ///  &lt;- doc-comment!
//////////////////////////////////////////  &lt;- this is not a doc-comment

/****************************************
 *                                      *
 * This is also not a doc-comment block *
 * so we don't have to put this in      *
 * front of a function.                 *
 *                                      *
 ****************************************/</code></pre>
</div>
</div>
<h1 id="module-documentation-1"><a class="header" href="#module-documentation-1">Module Documentation</a></h1>
<p>Comment lines starting with <code>//!</code> make up the <em>module documentation</em>.</p>
<p>They are used to document the containing <a href="ref/modules/index.html">module</a> –
or for a Rhai script file, to document the file itself.</p>
<pre><code class="language-rust">//! Documentation for this script file.
//! This script is used to calculate something and display the result.

fn calculate(x) {
   ...
}

fn display(msg) {
   //! Module documentation can be placed anywhere within the file.
   ...
}

//! All module documentation lines will be collected into a single block.</code></pre>
<p>For the example above, the module documentation block is:</p>
<pre><code class="language-rust">//! Documentation for this script file.
//! This script is used to calculate something and display the result.
//! Module documentation can be placed anywhere within the file.
//! All module documentation lines will be collected into a single block.</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="value-types"><a class="header" href="#value-types">Value Types</a></h1>
<p>The following primitive value types are supported natively.</p>
<div class="table-wrapper"><table><thead><tr><th>Category</th><th><a href="ref/type-of.html"><code>type_of()</code></a></th><th><code>to_string()</code></th></tr></thead><tbody>
<tr><td><strong>System integer</strong></td><td><code>"i32"</code> or <code>"i64"</code></td><td><code>"42"</code>, <code>"123"</code> etc.</td></tr>
<tr><td><strong>Other integer number</strong></td><td><code>"i32"</code>, <code>"u64"</code> etc.</td><td><code>"42"</code>, <code>"123"</code> etc.</td></tr>
<tr><td><strong>Integer numeric <a href="ref/ranges.html">range</a></strong></td><td><code>"range"</code>, <code>"range="</code></td><td><code>"2..7"</code>, <code>"0..=15"</code> etc.</td></tr>
<tr><td><strong>Floating-point number</strong></td><td><code>"f32"</code> or <code>"f64"</code></td><td><code>"123.4567"</code> etc.</td></tr>
<tr><td><strong>Fixed precision decimal number</strong></td><td><code>"decimal"</code></td><td><code>"42"</code>, <code>"123.4567"</code> etc.</td></tr>
<tr><td><strong>Boolean value</strong></td><td><code>"bool"</code></td><td><code>"true"</code> or <code>"false"</code></td></tr>
<tr><td><strong>Unicode character</strong></td><td><code>"char"</code></td><td><code>"A"</code>, <code>"x"</code> etc.</td></tr>
<tr><td><strong>Immutable Unicode <a href="ref/strings-chars.html">string</a></strong></td><td><code>"string"</code></td><td><code>"hello"</code> etc.</td></tr>
<tr><td><strong><a href="ref/arrays.html"><code>Array</code></a></strong></td><td><code>"array"</code></td><td><code>"[ 1, 2, 3 ]"</code> etc.</td></tr>
<tr><td><strong>Byte array – <a href="ref/blobs.html"><code>BLOB</code></a></strong></td><td><code>"blob"</code></td><td><code>"[01020304abcd]"</code> etc.</td></tr>
<tr><td><strong><a href="ref/object-maps.html">Object map</a></strong></td><td><code>"map"</code></td><td><code>"#{ "a": 1, "b": true }"</code> etc.</td></tr>
<tr><td><strong><a href="ref/timestamps.html">Timestamp</a></strong></td><td><code>"timestamp"</code></td><td><code>"&lt;timestamp&gt;"</code></td></tr>
<tr><td><strong><a href="ref/fn-ptr.html">Function pointer</a></strong></td><td><code>"Fn"</code></td><td><code>"Fn(foo)"</code> etc.</td></tr>
<tr><td><strong>Dynamic value</strong> (i.e. can be anything)</td><td><em>the actual type</em></td><td><em>actual value</em></td></tr>
<tr><td><strong>Shared value</strong> (a reference-counted, shared dynamic value, created via <a href="ref/fn-closure.html">closures</a></td><td><em>the actual type</em></td><td><em>actual value</em></td></tr>
<tr><td><strong>Nothing/void/nil/null/Unit</strong> (or whatever it is called)</td><td><code>"()"</code></td><td><code>""</code> <em>(empty string)</em></td></tr>
</tbody></table>
</div><div id="admonition-all-types-are-distinct" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-all-types-are-distinct-title">
<div class="admonition-title">
<div id="admonition-all-types-are-distinct-title">
<p>All types are distinct</p>
</div>
<a class="admonition-anchor-link" href="ref/values-and-types.html#admonition-all-types-are-distinct"></a>
</div>
<div>
<p>All types are treated strictly distinct by Rhai, meaning that <code>i32</code> and <code>i64</code> and <code>u32</code> are
completely different. They cannot even be added together.</p>
<p>This is very similar to Rust.</p>
</div>
</div>
<div id="admonition-strings" class="admonition admonish-info small" role="note" aria-labelledby="admonition-strings-title">
<div class="admonition-title">
<div id="admonition-strings-title">
<p>Strings</p>
</div>
<a class="admonition-anchor-link" href="ref/values-and-types.html#admonition-strings"></a>
</div>
<div>
<p><a href="ref/strings-chars.html">Strings</a> in Rhai are <em>immutable</em>, meaning that they can be shared but not modified.</p>
<p>Any modification done to a Rhai string causes the <a href="ref/strings-chars.html">string</a> to be cloned and
the modifications made to the copy.</p>
</div>
</div>
<div id="admonition-tip-convert-to-string" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-convert-to-string-title">
<div class="admonition-title">
<div id="admonition-tip-convert-to-string-title">
<p>Tip: Convert to string</p>
</div>
<a class="admonition-anchor-link" href="ref/values-and-types.html#admonition-tip-convert-to-string"></a>
</div>
<div>
<p>The <code>to_string</code> function converts a standard type into a <a href="ref/strings-chars.html">string</a> for display purposes.</p>
<p>The <code>to_debug</code> function converts a standard type into a <a href="ref/strings-chars.html">string</a> in debug format.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dynamic-values-1"><a class="header" href="#dynamic-values-1">Dynamic Values</a></h1>
<p>A dynamic value can be <em>any</em> type.</p>
<pre><code class="language-rust">let x = 42;         // value is an integer

x = 123.456;        // value is now a floating-point number

x = "hello";        // value is now a string

x = x.len &gt; 0;      // value is now a boolean

x = [x];            // value is now an array

x = #{x: x};        // value is now an object map</code></pre>
<h2 id="use-type_of-to-get-value-type-1"><a class="header" href="#use-type_of-to-get-value-type-1">Use <code>type_of()</code> to Get Value Type</a></h2>
<p>Because <a href="ref/type-of.html"><code>type_of()</code></a> a dynamic value returns the type of the actual value,
it is usually used to perform type-specific actions based on the actual value’s type.</p>
<pre><code class="language-js">let mystery = get_some_dynamic_value();

switch type_of(mystery) {
    "()" =&gt; print("Hey, I got the unit () here!"),
    "i64" =&gt; print("Hey, I got an integer here!"),
    "f64" =&gt; print("Hey, I got a float here!"),
    "decimal" =&gt; print("Hey, I got a decimal here!"),
    "range" =&gt; print("Hey, I got an exclusive range here!"),
    "range=" =&gt; print("Hey, I got an inclusive range here!"),
    "string" =&gt; print("Hey, I got a string here!"),
    "bool" =&gt; print("Hey, I got a boolean here!"),
    "array" =&gt; print("Hey, I got an array here!"),
    "blob" =&gt; print("Hey, I got a BLOB here!"),
    "map" =&gt; print("Hey, I got an object map here!"),
    "Fn" =&gt; print("Hey, I got a function pointer here!"),
    "timestamp" =&gt; print("Hey, I got a time-stamp here!"),
    "TestStruct" =&gt; print("Hey, I got the TestStruct custom type here!"),
    _ =&gt; print(`I don't know what this is: ${type_of(mystery)}`)
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="type_of-1"><a class="header" href="#type_of-1"><code>type_of()</code></a></h1>
<p>The <code>type_of</code> function detects the actual type of a value.</p>
<p>This is useful because all <a href="ref/variables.html">variables</a> are dynamic in nature.</p>
<pre><code class="language-js">// Use 'type_of()' to get the actual types of values
type_of('c') == "char";
type_of(42) == "i64";

let x = 123;
x.type_of() == "i64";       // method-call style is also OK
type_of(x) == "i64";

x = 99.999;
type_of(x) == "f64";

x = "hello";
if type_of(x) == "string" {
    do_something_first_with_string(x);
}

switch type_of(x) {
    "string" =&gt; do_something_with_string(x),
    "char" =&gt; do_something_with_char(x),
    "i64" =&gt; do_something_with_int(x),
    "f64" =&gt; do_something_with_float(x),
    "bool" =&gt; do_something_with_bool(x),
    _ =&gt; throw `I cannot work with ${type_of(x)}!!!`
}
</code></pre>
<div id="admonition-standard-types" class="admonition admonish-info small" role="note" aria-labelledby="admonition-standard-types-title">
<div class="admonition-title">
<div id="admonition-standard-types-title">
<p>Standard types</p>
</div>
<a class="admonition-anchor-link" href="ref/type-of.html#admonition-standard-types"></a>
</div>
<div>
<p>See <a href="ref/values-and-types.html">here</a> for the <code>type_of</code> output of standard types.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dynamic-value-tag-1"><a class="header" href="#dynamic-value-tag-1">Dynamic Value Tag</a></h1>
<p>Each dynamic value can contain a <em>tag</em> that is <code>i32</code> and can contain any arbitrary 32-bit signed data.</p>
<p>On 32-bit targets, however, the tag is only <code>i16</code> (16-bit signed).</p>
<p>The tag defaults to zero.</p>
<div id="admonition-value-out-of-bounds" class="admonition admonish-bug small" role="note" aria-labelledby="admonition-value-out-of-bounds-title">
<div class="admonition-title">
<div id="admonition-value-out-of-bounds-title">
<p>Value out of bounds</p>
</div>
<a class="admonition-anchor-link" href="ref/dynamic-tag.html#admonition-value-out-of-bounds"></a>
</div>
<div>
<p>It is an error to set a tag to a value beyond the bounds of <code>i32</code> (<code>i16</code> on 32-bit targets).</p>
</div>
</div>
<h2 id="examples-19"><a class="header" href="#examples-19">Examples</a></h2>
<pre><code class="language-rust">let x = 42;

x.tag == 0;             // tag defaults to zero

x.tag = 123;            // set tag value

set_tag(x, 123);        // 'set_tag' function also works

x.tag == 123;           // get updated tag value

x.tag() == 123;         // method also works

tag(x) == 123;          // function call style also works

x.tag[3..5] = 2;        // tag can be used as a bit-field

x.tag[3..5] == 2;

let y = x;

y.tag == 123;           // the tag is copied across assignment

y.tag = 3000000000;     // runtime error: 3000000000 is too large for 'i32'</code></pre>
<h2 id="practical-applications-1"><a class="header" href="#practical-applications-1">Practical Applications</a></h2>
<p>Attaching arbitrary information together with a value has a lot of practical uses.</p>
<h3 id="identify-code-path-1"><a class="header" href="#identify-code-path-1">Identify code path</a></h3>
<p>For example, it is easy to attach an ID number to a value to indicate how or why that value is
originally set.</p>
<p>This is tremendously convenient for debugging purposes where it is necessary to figure out which
code path a particular value went through.</p>
<p>After the script is verified, all tag assignment statements can simply be removed.</p>
<pre><code class="language-js">const ROUTE1 = 1;
const ROUTE2 = 2;
const ROUTE3 = 3;
const ERROR_ROUTE = 9;

fn some_complex_calculation(x) {
    let result;

    if some_complex_condition(x) {
        result = 42;
        result.tag = ROUTE1;        // record route #1
    } else if some_other_very_complex_condition(x) == 1 {
        result = 123;
        result.tag = ROUTE2;        // record route #2
    } else if some_non_understandable_calculation(x) &gt; 0 {
        result = 0;
        result.tag = ROUTE3;        // record route #3
    } else {
        result = -1;
        result.tag = ERROR_ROUTE;   // record error
    }

    result  // this value now contains the tag
}

let my_result = some_complex_calculation(key);

// The code path that 'my_result' went through is now in its tag.

// It is now easy to trace how 'my_result' gets its final value.

print(`Result = ${my_result} and reason = ${my_result.tag}`);
</code></pre>
<h3 id="identify-data-source-1"><a class="header" href="#identify-data-source-1">Identify data source</a></h3>
<p>It is convenient to use the tag value to record the <em>source</em> of a piece of data.</p>
<pre><code class="language-js">let x = [0, 1, 2, 3, 42, 99, 123];

// Store the index number of each value into its tag before
// filtering out all even numbers, leaving only odd numbers
let filtered = x.map(|v, i| { v.tag = i; v }).filter(|v| v.is_odd());

// The tag now contains the original index position

for (data, i) in filtered {
    print(`${i + 1}: Value ${data} from position #${data.tag + 1}`);
}
</code></pre>
<h3 id="identify-code-conditions-1"><a class="header" href="#identify-code-conditions-1">Identify code conditions</a></h3>
<p>The tag value may also contain a <em><a href="ref/bit-fields.html">bit-field</a></em> of up to 32 (16 under 32-bit targets)
individual bits, recording up to 32 (or 16 under 32-bit targets) logic conditions that contributed
to the value.</p>
<p>Again, after the script is verified, all tag assignment statements can simply be removed.</p>
<pre><code class="language-js">
fn some_complex_calculation(x) {
    let result = x;

    // Check first condition
    if some_complex_condition() {
        result += 1;
        result.tag[0] = true;   // Set first bit in bit-field
    }

    // Check second condition
    if some_other_very_complex_condition(x) == 1 {
        result *= 10;
        result.tag[1] = true;   // Set second bit in bit-field
    }

    // Check third condition
    if some_non_understandable_calculation(x) &gt; 0 {
        result -= 42;
        result.tag[2] = true;   // Set third bit in bit-field
    }

    // Check result
    if result &gt; 100 {
        result = 0;
        result.tag[3] = true;   // Set forth bit in bit-field
    }

    result
}

let my_result = some_complex_calculation(42);

// The tag of 'my_result' now contains a bit-field indicating
// the result of each condition.

// It is now easy to trace how 'my_result' gets its final value.
// Use indexing on the tag to get at individual bits.

print(`Result = ${my_result}`);
print(`First condition = ${my_result.tag[0]}`);
print(`Second condition = ${my_result.tag[1]}`);
print(`Third condition = ${my_result.tag[2]}`);
print(`Result check = ${my_result.tag[3]}`);
</code></pre>
<h3 id="return-auxillary-info-1"><a class="header" href="#return-auxillary-info-1">Return auxillary info</a></h3>
<p>Sometimes it is useful to return auxillary info from a <a href="ref/functions.html">function</a>.</p>
<pre><code class="language-rust">// Verify Bell's Inequality by calculating a norm
// and comparing it with a hypotenuse.
// https://en.wikipedia.org/wiki/Bell%27s_theorem
//
// Returns the smaller of the norm or hypotenuse.
// Tag is 1 if norm &lt;= hypo, 0 if otherwise.
fn bells_inequality(x, y, z) {
    let norm = sqrt(x ** 2 + y ** 2);
    let result;

    if norm &lt;= z {
        result = norm;
        result.tag = 1;
    } else {
        result = z;
        result.tag = 0;
    }

    result
}

let dist = bells_inequality(x, y, z);

print(`Value = ${dist}`);

if dist.tag == 1 {
    print("Local realism maintained! Einstein rules!");
} else {
    print("Spooky action at a distance detected! Einstein will hate this...");
}</code></pre>
<h3 id="poor-mans-tuples-1"><a class="header" href="#poor-mans-tuples-1">Poor-man’s tuples</a></h3>
<p>Rhai does not have <em>tuples</em> (nor does JavaScript in this sense).</p>
<p>Similar to the JavaScript situation, practical alternatives using Rhai include returning an
<a href="ref/object-maps.html">object map</a> or an <a href="ref/arrays.html">array</a>.</p>
<p>Both of these alternatives, however, incur overhead that may be wasteful when the amount of
additional information is small – e.g. in many cases, a single <code>bool</code>, or a small number.</p>
<p>To return a number of <em>small</em> values from <a href="ref/functions.html">functions</a>, the tag value as a
<a href="ref/bit-fields.html">bit-field</a> is an ideal container without resorting to a full-blown
<a href="ref/object-maps.html">object map</a> or <a href="ref/arrays.html">array</a>.</p>
<pre><code class="language-rust">// This function essentially returns a tuple of four numbers:
// (result, a, b, c)
fn complex_calc(x, y, z) {
    let a = x + y;
    let b = x - y + z;
    let c = (a + b) * z / y;
    let r = do_complex_calculation(a, b, c);

    // Store 'a', 'b' and 'c' into tag if they are small
    r.tag[0..8] = a;
    r.tag[8..16] = b;
    r.tag[16..32] = c;

    r
}

// Deconstruct the tuple
let result = complex_calc(x, y, z);
let a = r.tag[0..8];
let b = r.tag[8..16];
let c = r.tag[16..32];</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="numbers-1"><a class="header" href="#numbers-1">Numbers</a></h1>
<h2 id="integers-1"><a class="header" href="#integers-1">Integers</a></h2>
<p>Integer numbers follow C-style format with support for decimal, binary (<code>0b</code>), octal (<code>0o</code>) and hex (<code>0x</code>) notations.</p>
<p>Integers can also be conveniently manipulated as <a href="ref/bit-fields.html">bit-fields</a>.</p>
<h2 id="floating-point-numbers-1"><a class="header" href="#floating-point-numbers-1">Floating-Point Numbers</a></h2>
<p>Both decimal and scientific notations can be used to represent floating-point numbers.</p>
<h2 id="decimal-numbers-1"><a class="header" href="#decimal-numbers-1">Decimal Numbers</a></h2>
<p>When rounding errors cannot be accepted, such as in financial calculations, use the decimal type,
which is a fixed-precision floating-point number with no rounding errors.</p>
<h2 id="number-literals-1"><a class="header" href="#number-literals-1">Number Literals</a></h2>
<p><code>_</code> separators can be added freely and are ignored within a number – except at the very
beginning or right after a decimal point (<code>.</code>).</p>
<div class="table-wrapper"><table><thead><tr><th>Sample</th><th>Format</th></tr></thead><tbody>
<tr><td><code>_123</code></td><td><em>improper separator</em></td></tr>
<tr><td><code>123_345</code>, <code>-42</code></td><td>decimal</td></tr>
<tr><td><code>0o07_76</code></td><td>octal</td></tr>
<tr><td><code>0xab_cd_ef</code></td><td>hex</td></tr>
<tr><td><code>0b0101_1001</code></td><td>binary</td></tr>
<tr><td><code>123._456</code></td><td><em>improper separator</em></td></tr>
<tr><td><code>123_456.78_9</code></td><td>normal floating-point</td></tr>
<tr><td><code>-42.</code></td><td>ending with decimal point</td></tr>
<tr><td><code>123_456_.789e-10</code></td><td>scientific notation</td></tr>
<tr><td><code>.456</code></td><td><em>missing leading <code>0</code></em></td></tr>
<tr><td><code>123.456e_10</code></td><td><em>improper separator</em></td></tr>
<tr><td><code>123.e-10</code></td><td><em>missing decimal <code>0</code></em></td></tr>
</tbody></table>
</div>
<h2 id="floating-point-vs-decimal-1"><a class="header" href="#floating-point-vs-decimal-1">Floating-Point vs. Decimal</a></h2>
<p>Decimal numbers represents a fixed-precision floating-point number which is popular with financial
calculations and other usage scenarios where round-off errors are not acceptable.</p>
<p>Decimal numbers take up more space (16 bytes each) than a standard floating-point number (4-8 bytes)
and is much slower in calculations due to the lack of CPU hardware support. Use it only when
necessary.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="numeric-operators-1"><a class="header" href="#numeric-operators-1">Numeric Operators</a></h1>
<p>Numeric operators generally follow C styles.</p>
<h2 id="unary-operators-1"><a class="header" href="#unary-operators-1">Unary Operators</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Operator</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>+</code></td><td>positive</td></tr>
<tr><td style="text-align: center"><code>-</code></td><td>negative</td></tr>
</tbody></table>
</div>
<pre><code class="language-rust">let number = +42;

number = -5;

number = -5 - +5;

-(-42) == +42;      // two '-' equals '+'
                    // beware: '++' and '--' are reserved symbols</code></pre>
<h2 id="binary-operators-1"><a class="header" href="#binary-operators-1">Binary Operators</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Operator</th><th>Description</th><th style="text-align: center">Result type</th><th style="text-align: center">Integer</th><th style="text-align: center">Floating-point</th><th style="text-align: center">Decimal</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>+</code>, <code>+=</code></td><td>plus</td><td style="text-align: center">numeric</td><td style="text-align: center">yes</td><td style="text-align: center">yes, also integer</td><td style="text-align: center">yes, also integer</td></tr>
<tr><td style="text-align: center"><code>-</code>, <code>-=</code></td><td>minus</td><td style="text-align: center">numeric</td><td style="text-align: center">yes</td><td style="text-align: center">yes, also integer</td><td style="text-align: center">yes, also integer</td></tr>
<tr><td style="text-align: center"><code>*</code>, <code>*=</code></td><td>multiply</td><td style="text-align: center">numeric</td><td style="text-align: center">yes</td><td style="text-align: center">yes, also integer</td><td style="text-align: center">yes, also integer</td></tr>
<tr><td style="text-align: center"><code>/</code>, <code>/=</code></td><td>divide (integer division if acting on integer types)</td><td style="text-align: center">numeric</td><td style="text-align: center">yes</td><td style="text-align: center">yes, also integer</td><td style="text-align: center">yes, also integer</td></tr>
<tr><td style="text-align: center"><code>%</code>, <code>%=</code></td><td>modulo (remainder)</td><td style="text-align: center">numeric</td><td style="text-align: center">yes</td><td style="text-align: center">yes, also integer</td><td style="text-align: center">yes, also integer</td></tr>
<tr><td style="text-align: center"><code>**</code>, <code>**=</code></td><td>power/exponentiation</td><td style="text-align: center">numeric</td><td style="text-align: center">yes</td><td style="text-align: center">yes, also <code>FLOAT**INT</code></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>&lt;&lt;</code>, <code>&lt;&lt;=</code></td><td>left bit-shift (if negative number of bits, shift right instead)</td><td style="text-align: center">numeric</td><td style="text-align: center">yes</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>&gt;&gt;</code>, <code>&gt;&gt;=</code></td><td>right bit-shift (if negative number of bits, shift left instead)</td><td style="text-align: center">numeric</td><td style="text-align: center">yes</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>&amp;</code>, <code>&amp;=</code></td><td>bit-wise <em>And</em></td><td style="text-align: center">numeric</td><td style="text-align: center">yes</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>|</code>, <code>|=</code></td><td>bit-wise <em>Or</em></td><td style="text-align: center">numeric</td><td style="text-align: center">yes</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>^</code>, <code>^=</code></td><td>bit-wise <em>Xor</em></td><td style="text-align: center">numeric</td><td style="text-align: center">yes</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>==</code></td><td>equals to</td><td style="text-align: center"><code>bool</code></td><td style="text-align: center">yes</td><td style="text-align: center">yes, also integer</td><td style="text-align: center">yes, also integer</td></tr>
<tr><td style="text-align: center"><code>!=</code></td><td>not equals to</td><td style="text-align: center"><code>bool</code></td><td style="text-align: center">yes</td><td style="text-align: center">yes, also integer</td><td style="text-align: center">yes, also integer</td></tr>
<tr><td style="text-align: center"><code>&gt;</code></td><td>greater than</td><td style="text-align: center"><code>bool</code></td><td style="text-align: center">yes</td><td style="text-align: center">yes, also integer</td><td style="text-align: center">yes, also integer</td></tr>
<tr><td style="text-align: center"><code>&gt;=</code></td><td>greater than or equals to</td><td style="text-align: center"><code>bool</code></td><td style="text-align: center">yes</td><td style="text-align: center">yes, also integer</td><td style="text-align: center">yes, also integer</td></tr>
<tr><td style="text-align: center"><code>&lt;</code></td><td>less than</td><td style="text-align: center"><code>bool</code></td><td style="text-align: center">yes</td><td style="text-align: center">yes, also integer</td><td style="text-align: center">yes, also integer</td></tr>
<tr><td style="text-align: center"><code>&lt;=</code></td><td>less than or equals to</td><td style="text-align: center"><code>bool</code></td><td style="text-align: center">yes</td><td style="text-align: center">yes, also integer</td><td style="text-align: center">yes, also integer</td></tr>
<tr><td style="text-align: center"><code>..</code></td><td>exclusive range</td><td style="text-align: center"><a href="ref/ranges.html">range</a></td><td style="text-align: center">yes</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>..=</code></td><td>inclusive range</td><td style="text-align: center"><a href="ref/ranges.html">range</a></td><td style="text-align: center">yes</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td></tr>
</tbody></table>
</div>
<h2 id="examples-20"><a class="header" href="#examples-20">Examples</a></h2>
<pre><code class="language-rust">let x = (1 + 2) * (6 - 4) / 2;  // arithmetic, with parentheses

let reminder = 42 % 10;         // modulo

let power = 42 ** 2;            // power

let left_shifted = 42 &lt;&lt; 3;     // left shift

let right_shifted = 42 &gt;&gt; 3;    // right shift

let bit_op = 42 | 99;           // bit masking</code></pre>
<h2 id="floating-point-interoperates-with-integers-1"><a class="header" href="#floating-point-interoperates-with-integers-1">Floating-Point Interoperates with Integers</a></h2>
<p>When one of the operands to a binary arithmetic operator is floating-point, it works with integer
for the other operand and the result is floating-point.</p>
<pre><code class="language-rust">let x = 41.0 + 1;               // float + integer

type_of(x) == "f64";            // result is float

let x = 21 * 2.0;               // float * integer

type_of(x) == "f64";

(x == 42) == true;              // float == integer

(10 &lt; x) == true;               // integer &lt; float</code></pre>
<h2 id="decimal-interoperates-with-integers-1"><a class="header" href="#decimal-interoperates-with-integers-1">Decimal Interoperates with Integers</a></h2>
<p>When one of the operands to a binary arithmetic operator is decimal,
it works with integer for the other operand and the result is decimal.</p>
<pre><code class="language-rust">let d = parse_decimal("2");

let x = d + 1;                  // decimal + integer

type_of(x) == "decimal";        // result is decimal

let x = 21 * d;                 // decimal * integer

type_of(x) == "decimal";

(x == 42) == true;              // decimal == integer

(10 &lt; x) == true;               // integer &lt; decimal</code></pre>
<h2 id="unary-before-binary-1"><a class="header" href="#unary-before-binary-1">Unary Before Binary</a></h2>
<p>In Rhai, unary operators take [precedence] over binary operators.  This is especially important to
remember when handling operators such as <code>**</code> which in some languages bind tighter than the unary
<code>-</code> operator.</p>
<pre><code class="language-rust">-2 + 2 == 0;

-2 - 2 == -4;

-2 * 2 == -4;

-2 / 2 == -1;

-2 % 2 == 0;

-2 ** 2 = 4;            // means: (-2) ** 2
                        // in some languages this means: -(2 ** 2)</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="numeric-functions-1"><a class="header" href="#numeric-functions-1">Numeric Functions</a></h1>
<h2 id="integer-functions-1"><a class="header" href="#integer-functions-1">Integer Functions</a></h2>
<p>The following standard functions operate on integers only.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Description</th></tr></thead><tbody>
<tr><td><code>is_odd</code> method and property</td><td>returns <code>true</code> if the value is an odd number, otherwise <code>false</code></td></tr>
<tr><td><code>is_even</code> method and property</td><td>returns <code>true</code> if the value is an even number, otherwise <code>false</code></td></tr>
<tr><td><code>min</code></td><td>returns the smaller of two numbers, the first number if equal</td></tr>
<tr><td><code>max</code></td><td>returns the larger of two numbers, the first number if equal</td></tr>
<tr><td><code>to_float</code></td><td>convert the value into <code>f64</code> (<code>f32</code> under 32-bit)</td></tr>
<tr><td><code>to_decimal</code></td><td>convert the value into decimal</td></tr>
</tbody></table>
</div>
<h2 id="signed-numeric-functions-1"><a class="header" href="#signed-numeric-functions-1">Signed Numeric Functions</a></h2>
<p>The following standard functions operate on signed numbers (including floating-point and decimal) only.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Description</th></tr></thead><tbody>
<tr><td><code>abs</code></td><td>absolute value</td></tr>
<tr><td><code>sign</code></td><td>returns −1 if negative, +1 if positive, 0 if zero</td></tr>
<tr><td><code>is_zero</code> method and property</td><td>returns <code>true</code> if the value is zero, otherwise <code>false</code></td></tr>
</tbody></table>
</div>
<h2 id="floating-point-functions-1"><a class="header" href="#floating-point-functions-1">Floating-Point Functions</a></h2>
<p>The following standard functions operate on floating-point and decimal numbers only.</p>
<div class="table-wrapper"><table><thead><tr><th>Category</th><th style="text-align: center">Decimal?</th><th>Functions</th></tr></thead><tbody>
<tr><td>Trigonometry</td><td style="text-align: center">yes</td><td><code>sin</code>, <code>cos</code>, <code>tan</code></td></tr>
<tr><td>Trigonometry</td><td style="text-align: center"><strong>no</strong></td><td><code>sinh</code>, <code>cosh</code>, <code>tanh</code> in radians, <code>hypot(</code><em>x</em><code>,</code><em>y</em><code>)</code></td></tr>
<tr><td>Arc-trigonometry</td><td style="text-align: center"><strong>no</strong></td><td><code>asin</code>, <code>acos</code>, <code>atan(</code><em>v</em><code>)</code>, <code>atan(</code><em>x</em><code>,</code><em>y</em><code>)</code>, <code>asinh</code>, <code>acosh</code>, <code>atanh</code> in radians</td></tr>
<tr><td>Square root</td><td style="text-align: center">yes</td><td><code>sqrt</code></td></tr>
<tr><td>Exponential</td><td style="text-align: center">yes</td><td><code>exp</code> (base <em>e</em>)</td></tr>
<tr><td>Logarithmic</td><td style="text-align: center">yes</td><td><code>ln</code> (base <em>e</em>), <code>log</code> (base 10)</td></tr>
<tr><td>Logarithmic</td><td style="text-align: center"><strong>no</strong></td><td><code>log(</code><em>x</em><code>,</code><em>base</em><code>)</code></td></tr>
<tr><td>Rounding</td><td style="text-align: center">yes</td><td><code>floor</code>, <code>ceiling</code>, <code>round</code>, <code>int</code>, <code>fraction</code> methods and properties</td></tr>
<tr><td>Conversion</td><td style="text-align: center">yes</td><td><a href="ref/convert.html"><code>to_int</code></a>, <a href="ref/convert.html"><code>to_decimal</code></a>, <a href="ref/convert.html"><code>to_float</code></a></td></tr>
<tr><td>Conversion</td><td style="text-align: center"><strong>no</strong></td><td><code>to_degrees</code>, <code>to_radians</code></td></tr>
<tr><td>Comparison</td><td style="text-align: center">yes</td><td><code>min</code>, <code>max</code> (also inter-operates with integers)</td></tr>
<tr><td>Testing</td><td style="text-align: center"><strong>no</strong></td><td><code>is_nan</code>, <code>is_finite</code>, <code>is_infinite</code> methods and properties</td></tr>
</tbody></table>
</div>
<h2 id="decimal-rounding-functions-1"><a class="header" href="#decimal-rounding-functions-1">Decimal Rounding Functions</a></h2>
<p>The following rounding methods operate on decimal numbers only.</p>
<div class="table-wrapper"><table><thead><tr><th>Rounding type</th><th>Behavior</th><th>Methods</th></tr></thead><tbody>
<tr><td>None</td><td></td><td><code>floor</code>, <code>ceiling</code>, <code>int</code>, <code>fraction</code> methods and properties</td></tr>
<tr><td>Banker’s rounding</td><td>round to integer</td><td><code>round</code> method and property</td></tr>
<tr><td>Banker’s rounding</td><td>round to specified number of decimal points</td><td><code>round(</code><em>decimal points</em><code>)</code></td></tr>
<tr><td>Round up</td><td>away from zero</td><td><code>round_up(</code><em>decimal points</em><code>)</code></td></tr>
<tr><td>Round down</td><td>towards zero</td><td><code>round_down(</code><em>decimal points</em><code>)</code></td></tr>
<tr><td>Round half-up</td><td>mid-point away from zero</td><td><code>round_half_up(</code><em>decimal points</em><code>)</code></td></tr>
<tr><td>Round half-down</td><td>mid-point towards zero</td><td><code>round_half_down(</code><em>decimal points</em><code>)</code></td></tr>
</tbody></table>
</div>
<h2 id="parsing-functions-1"><a class="header" href="#parsing-functions-1">Parsing Functions</a></h2>
<p>The following standard functions parse numbers.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="ref/convert.html"><code>parse_int</code></a></td><td>converts a <a href="ref/strings-chars.html">string</a> to integer with an optional radix</td></tr>
<tr><td><a href="ref/convert.html"><code>parse_float</code></a></td><td>converts a <a href="ref/strings-chars.html">string</a> to floating-point</td></tr>
<tr><td><a href="ref/convert.html"><code>parse_decimal</code></a></td><td>converts a <a href="ref/strings-chars.html">string</a> to decimal</td></tr>
</tbody></table>
</div>
<h2 id="formatting-functions-1"><a class="header" href="#formatting-functions-1">Formatting Functions</a></h2>
<p>The following standard functions convert integer numbers into a <a href="ref/strings-chars.html">string</a> of hex,
octal or binary representations.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="ref/convert.html"><code>to_binary</code></a></td><td>converts an integer number to binary</td></tr>
<tr><td><a href="ref/convert.html"><code>to_octal</code></a></td><td>converts an integer number to octal</td></tr>
<tr><td><a href="ref/convert.html"><code>to_hex</code></a></td><td>converts an integer number to hex</td></tr>
</tbody></table>
</div>
<h2 id="floating-point-constants-1"><a class="header" href="#floating-point-constants-1">Floating-point Constants</a></h2>
<p>The following functions return standard mathematical constants.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Description</th></tr></thead><tbody>
<tr><td><code>PI</code></td><td>returns the value of π</td></tr>
<tr><td><code>E</code></td><td>returns the value of <em>e</em></td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="value-conversions-1"><a class="header" href="#value-conversions-1">Value Conversions</a></h1>
<h2 id="convert-between-integer-and-floating-point-1"><a class="header" href="#convert-between-integer-and-floating-point-1">Convert Between Integer and Floating-Point</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th style="text-align: center">From type</th><th style="text-align: center">To type</th></tr></thead><tbody>
<tr><td><code>to_int</code></td><td style="text-align: center">floating-point, decimal</td><td style="text-align: center">integer</td></tr>
<tr><td><code>to_float</code></td><td style="text-align: center">integer, decimal</td><td style="text-align: center">floating-point</td></tr>
<tr><td><code>to_decimal</code></td><td style="text-align: center">integer, floating-point</td><td style="text-align: center">decimal</td></tr>
</tbody></table>
</div>
<p>That’s it; for other conversions, register custom conversion functions.</p>
<pre><code class="language-js">let x = 42;                     // 'x' is an integer

let y = x * 100.0;              // integer and floating-point can inter-operate

let y = x.to_float() * 100.0;   // convert integer to floating-point with 'to_float'

let z = y.to_int() + x;         // convert floating-point to integer with 'to_int'

let d = y.to_decimal();         // convert floating-point to Decimal with 'to_decimal'

let w = z.to_decimal() + x;     // Decimal and integer can inter-operate

let c = 'X';                    // character

print(`c is '${c}' and its code is ${c.to_int()}`); // prints "c is 'X' and its code is 88"
</code></pre>
<h2 id="parse-string-into-number-1"><a class="header" href="#parse-string-into-number-1">Parse String into Number</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th style="text-align: center">From type</th><th style="text-align: center">To type</th></tr></thead><tbody>
<tr><td><code>parse_int</code></td><td style="text-align: center"><a href="ref/strings-chars.html">string</a></td><td style="text-align: center">integer</td></tr>
<tr><td><code>parse_int</code> with radix 2-36</td><td style="text-align: center"><a href="ref/strings-chars.html">string</a></td><td style="text-align: center">integer (specified radix)</td></tr>
<tr><td><code>parse_float</code></td><td style="text-align: center"><a href="ref/strings-chars.html">string</a></td><td style="text-align: center">floating-point</td></tr>
<tr><td><code>parse_decimal</code></td><td style="text-align: center"><a href="ref/strings-chars.html">string</a></td><td style="text-align: center">decimal</td></tr>
</tbody></table>
</div>
<pre><code class="language-rust">let x = parse_float("123.4");   // parse as floating-point
x == 123.4;
type_of(x) == "f64";

let x = parse_decimal("123.4"); // parse as Decimal value
type_of(x) == "decimal";

let x = 1234.to_decimal() / 10; // alternate method to create a Decimal value
type_of(x) == "decimal";

let dec = parse_int("42");      // parse as integer
dec == 42;
type_of(dec) == "i64";

let dec = parse_int("42", 10);  // radix = 10 is the default
dec == 42;
type_of(dec) == "i64";

let bin = parse_int("110", 2);  // parse as binary (radix = 2)
bin == 0b110;
type_of(bin) == "i64";

let hex = parse_int("ab", 16);  // parse as hex (radix = 16)
hex == 0xab;
type_of(hex) == "i64";</code></pre>
<h2 id="format-numbers-1"><a class="header" href="#format-numbers-1">Format Numbers</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th style="text-align: center">From type</th><th style="text-align: center">To type</th><th style="text-align: center">Format</th></tr></thead><tbody>
<tr><td><code>to_binary</code></td><td style="text-align: center">integer</td><td style="text-align: center"><a href="ref/strings-chars.html">string</a></td><td style="text-align: center">binary (i.e. only <code>1</code> and <code>0</code>)</td></tr>
<tr><td><code>to_octal</code></td><td style="text-align: center">integer</td><td style="text-align: center"><a href="ref/strings-chars.html">string</a></td><td style="text-align: center">octal (i.e. <code>0</code> … <code>7</code>)</td></tr>
<tr><td><code>to_hex</code></td><td style="text-align: center">integer</td><td style="text-align: center"><a href="ref/strings-chars.html">string</a></td><td style="text-align: center">hex (i.e. <code>0</code> … <code>f</code>)</td></tr>
</tbody></table>
</div>
<pre><code class="language-rust">let x = 0x1234abcd;

x == 305441741;

x.to_string() == "305441741";

x.to_binary() == "10010001101001010101111001101";

x.to_octal() == "2215125715";

x.to_hex() == "1234abcd";</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ranges-1"><a class="header" href="#ranges-1">Ranges</a></h1>
<h2 id="syntax-4"><a class="header" href="#syntax-4">Syntax</a></h2>
<p>Numeric ranges can be constructed by the <code>..</code> (exclusive) or <code>..=</code> (inclusive) operators.</p>
<h3 id="exclusive-range-1"><a class="header" href="#exclusive-range-1">Exclusive range</a></h3>
<blockquote>
<p><em>start</em> <code>..</code> <em>end</em></p>
</blockquote>
<p>An <em>exclusive</em> range does not include the last (i.e. “end”) value.</p>
<p><a href="ref/type-of.html"><code>type_of()</code></a> an exclusive range returns <code>"range"</code>.</p>
<h3 id="inclusive-range-1"><a class="header" href="#inclusive-range-1">Inclusive range</a></h3>
<blockquote>
<p><em>start</em> <code>..=</code> <em>end</em></p>
</blockquote>
<p>An <em>inclusive</em> range includes the last (i.e. “end”) value.</p>
<p><a href="ref/type-of.html"><code>type_of()</code></a> an inclusive range returns <code>"range="</code>.</p>
<h2 id="usage-scenarios-1"><a class="header" href="#usage-scenarios-1">Usage Scenarios</a></h2>
<p>Ranges are commonly used in the following scenarios.</p>
<div class="table-wrapper"><table><thead><tr><th>Scenario</th><th>Example</th></tr></thead><tbody>
<tr><td><a href="ref/for.html"><code>for</code></a> statements</td><td><code>for n in 0..100 { ... }</code></td></tr>
<tr><td><a href="ref/operators.html"><code>in</code></a> expressions</td><td><code>if n in 0..100 { ... }</code></td></tr>
<tr><td><a href="ref/switch.html"><code>switch</code></a> expressions</td><td><code>switch n { 0..100 =&gt; ... }</code></td></tr>
<tr><td><a href="ref/bit-fields.html">Bit-fields</a> access</td><td><code>let x = n[2..6];</code></td></tr>
<tr><td>Bits iteration</td><td><code>for bit in n.bits(2..=9) { ... }</code></td></tr>
<tr><td><a href="ref/arrays.html">Array</a> range-based APIs</td><td><code>array.extract(2..8)</code></td></tr>
<tr><td><a href="ref/blobs.html">BLOB</a> range-based APIs</td><td><code>blob.parse_le_int(4..8)</code></td></tr>
<tr><td><a href="ref/strings-chars.html">String</a> range-based APIs</td><td><code>string.sub_string(4..=12)</code></td></tr>
<tr><td><a href="ref/strings-chars.html">Characters</a> iteration</td><td><code>for ch in string.bits(4..=12) { ... }</code></td></tr>
</tbody></table>
</div>
<h2 id="built-in-functions-7"><a class="header" href="#built-in-functions-7">Built-in Functions</a></h2>
<p>The following methods operate on ranges.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th style="text-align: center">Parameter(s)</th><th>Description</th></tr></thead><tbody>
<tr><td><code>start</code> method and property</td><td style="text-align: center"></td><td>beginning of the range</td></tr>
<tr><td><code>end</code> method and property</td><td style="text-align: center"></td><td>end of the range</td></tr>
<tr><td><code>contains</code>, <code>in</code> operator</td><td style="text-align: center">number to check</td><td>does this range contain the specified number?</td></tr>
<tr><td><code>is_empty</code> method and property</td><td style="text-align: center"></td><td>returns <code>true</code> if the range contains no items</td></tr>
<tr><td><code>is_inclusive</code> method and property</td><td style="text-align: center"></td><td>is the range inclusive?</td></tr>
<tr><td><code>is_exclusive</code> method and property</td><td style="text-align: center"></td><td>is the range exclusive?</td></tr>
</tbody></table>
</div>
<h2 id="tldr-6"><a class="header" href="#tldr-6">TL;DR</a></h2>
<div id="admonition-what-happened-to-the-_open-ended_-ranges" class="admonition admonish-question" role="note" aria-labelledby="admonition-what-happened-to-the-_open-ended_-ranges-title">
<div class="admonition-title">
<div id="admonition-what-happened-to-the-_open-ended_-ranges-title">
<p>What happened to the <em>open-ended</em> ranges?</p>
</div>
<a class="admonition-anchor-link" href="ref/ranges.html#admonition-what-happened-to-the-_open-ended_-ranges"></a>
</div>
<div>
<p>Rust has <em>open-ended</em> ranges, such as <code>start..</code>, <code>..end</code> and <code>..=end</code>.  They are not available in Rhai.</p>
<p>They are not needed because Rhai can overload functions.</p>
<p>Typically, an API accepting ranges as parameters would have equivalent versions that accept a
starting position and a length (the standard <code>start + len</code> pair), as well as a versions that accept
only the starting position (the length assuming to the end).</p>
<p>In fact, usually all versions redirect to a call to one single version.</p>
<p>Therefore, there should always be a function that can do what open-ended ranges are intended for.</p>
<p>The left-open form (i.e. <code>..end</code> and <code>..=end</code>) is trivially replaced by using zero as the starting
position with a length that corresponds to the end position (for <code>..end</code>).</p>
<p>The right-open form (i.e. <code>start..</code>) is trivially replaced by the version taking a single starting position.</p>
<pre><code class="language-rust">let x = [1, 2, 3, 4, 5];

x.extract(0..3);    // normal range argument
                    // copies 'x' from positions 0-2

x.extract(2);       // copies 'x' from position 2 onwards
                    // equivalent to '2..'

x.extract(0, 2);    // copies 'x' from beginning for 2 items
                    // equivalent to '..2'</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="integer-as-bit-fields-1"><a class="header" href="#integer-as-bit-fields-1">Integer as Bit-Fields</a></h1>
<div id="admonition-note" class="admonition admonish-note side" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="ref/bit-fields.html#admonition-note"></a>
</div>
<div>
<p>Nothing here cannot be done via standard bit-manipulation (i.e. shifting and masking).</p>
<p>Built-in support is more elegant and performant since it usually replaces a sequence of multiple steps.</p>
</div>
</div>
<p>Since bit-wise operators are defined on integer numbers, individual bits can also be accessed and
manipulated via an indexing syntax.</p>
<p>If a bit is set (i.e. <code>1</code>), the index access returns <code>true</code>.</p>
<p>If a bit is not set (i.e. <code>0</code>), the index access returns <code>false</code>.</p>
<p>When a <a href="ref/ranges.html">range</a> is used, the bits within the <a href="ref/ranges.html">range</a> are shifted and extracted
as an integer value.</p>
<p>Bit-fields are very commonly used in embedded systems which must squeeze data into limited memory.</p>
<p>Built-in support makes handling them efficient.</p>
<h2 id="syntax-5"><a class="header" href="#syntax-5">Syntax</a></h2>
<h3 id="from-least-significant-bit-lsb-1"><a class="header" href="#from-least-significant-bit-lsb-1">From Least-Significant Bit (LSB)</a></h3>
<p>Bits in a bit-field are accessed with zero-based, non-negative integer indices:</p>
<blockquote>
<p><em>integer</em> <code>[</code> <em>index from 0 to 63 or 31</em> <code>]</code></p>
<p><em>integer</em> <code>[</code> <em>index from 0 to 63 or 31</em> <code>] =</code> <code>true</code> or <code>false</code> ;</p>
</blockquote>
<p>[Ranges] can also be used:</p>
<blockquote>
<p><em>integer</em> <code>[</code> <em>start</em> <code>..</code> <em>end</em> <code>]</code><br />
<em>integer</em> <code>[</code> <em>start</em> <code>..=</code> <em>end</em> <code>]</code></p>
<p><em>integer</em> <code>[</code> <em>start</em> <code>..</code> <em>end</em> <code>] =</code> <em>new integer value</em> ;<br />
<em>integer</em> <code>[</code> <em>start</em> <code>..=</code> <em>end</em> <code>] =</code> <em>new integer value</em> ;</p>
</blockquote>
<div id="admonition-number-of-bits" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-number-of-bits-title">
<div class="admonition-title">
<div id="admonition-number-of-bits-title">
<p>Number of bits</p>
</div>
<a class="admonition-anchor-link" href="ref/bit-fields.html#admonition-number-of-bits"></a>
</div>
<div>
<p>The maximum bit number that can be accessed is one less than the number of bits for the
system integer type (usually 63).</p>
<p>Bits outside of the range are ignored.</p>
</div>
</div>
<h3 id="from-most-significant-bit-msb-1"><a class="header" href="#from-most-significant-bit-msb-1">From Most-Significant Bit (MSB)</a></h3>
<p>A <em>negative</em> index accesses a bit in the bit-field counting from the <em>end</em>, or from the
<em>most-significant bit</em>, with −1 being the <em>highest</em> bit.</p>
<blockquote>
<p><em>integer</em> <code>[</code> <em>index from −1 to −64 or −32</em> <code>]</code></p>
<p><em>integer</em> <code>[</code> <em>index from −1 to −64 or −32</em> <code>] =</code> <code>true</code> or <code>false</code> ;</p>
</blockquote>
<p><a href="ref/ranges.html">Ranges</a> always count from the least-significant bit (LSB) and has no support for
negative positions.</p>
<div id="admonition-number-of-bits-1" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-number-of-bits-1-title">
<div class="admonition-title">
<div id="admonition-number-of-bits-1-title">
<p>Number of bits</p>
</div>
<a class="admonition-anchor-link" href="ref/bit-fields.html#admonition-number-of-bits-1"></a>
</div>
<div>
<p>The maximum bit number that can be accessed is negative the number of bits for the
system integer type (usually −64).</p>
</div>
</div>
<h2 id="bit-field-functions-1"><a class="header" href="#bit-field-functions-1">Bit-Field Functions</a></h2>
<p>The following standard functions operate on bit-fields.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Parameter(s)</th><th>Description</th></tr></thead><tbody>
<tr><td><code>get_bit</code></td><td>bit number, counting from MSB if &lt; 0</td><td>returns the state of a bit: <code>true</code> if <code>1</code>, <code>false</code> if <code>0</code></td></tr>
<tr><td><code>set_bit</code></td><td><ol><li>bit number, counting from MSB if &lt; 0</li><li>new state: <code>true</code> if <code>1</code>, <code>false</code> if <code>0</code></li></ol></td><td>sets the state of a bit</td></tr>
<tr><td><code>get_bits</code></td><td><ol><li>starting bit number, counting from MSB if &lt; 0</li><li>number of bits to extract, none if &lt; 1, to MSB if ≥ <em>length</em></li></ol></td><td>extracts a number of bits, shifted towards LSB</td></tr>
<tr><td><code>get_bits</code></td><td><a href="ref/ranges.html">range</a> of bits</td><td>extracts a number of bits, shifted towards LSB</td></tr>
<tr><td><code>set_bits</code></td><td><ol><li>starting bit number, counting from MSB if &lt; 0</li><li>number of bits to set, none if &lt; 1, to MSB if ≥ <em>length</em><br/>3) new value</li></ol></td><td>sets a number of bits from the new value</td></tr>
<tr><td><code>set_bits</code></td><td><ol><li><a href="ref/ranges.html">range</a> of bits</li><li>new value</li></ol></td><td>sets a number of bits from the new value</td></tr>
<tr><td><code>bits</code> method and property</td><td><ol><li><em>(optional)</em> starting bit number, counting from MSB if &lt; 0</li><li><em>(optional)</em> number of bits to extract, none if &lt; 1, to MSB if ≥ <em>length</em></li></ol></td><td>allows iteration over the bits of a bit-field</td></tr>
<tr><td><code>bits</code></td><td><a href="ref/ranges.html">range</a> of bits</td><td>allows iteration over the bits of a bit-field</td></tr>
</tbody></table>
</div>
<h2 id="example-26"><a class="header" href="#example-26">Example</a></h2>
<pre><code class="language-js   no_run">// Assume the following bits fields in a single 16-bit word:
// ┌─────────┬────────────┬──────┬─────────┐
// │  15-12  │    11-4    │  3   │   2-0   │
// ├─────────┼────────────┼──────┼─────────┤
// │    0    │ 0-255 data │ flag │ command │
// └─────────┴────────────┴──────┴─────────┘

let value = read_start_hw_register(42);

let command = value.get_bits(0, 3);         // Command = bits 0-2

let flag = value[3];                        // Flag = bit 3

let data = value[4..=11];                   // Data = bits 4-11
let data = value.get_bits(4..=11);          // &lt;- above is the same as this

let reserved = value.get_bits(-4);          // Reserved = last 4 bits

if reserved != 0 {
    throw reserved;
}

switch command {
    0 =&gt; print(`Data = ${data}`),
    1 =&gt; value[4..=11] = data / 2,
    2 =&gt; value[3] = !flag,
    _ =&gt; print(`Unknown: ${command}`)
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="strings-and-characters-1"><a class="header" href="#strings-and-characters-1">Strings and Characters</a></h1>
<p>String in Rhai contain any text sequence of valid Unicode characters.</p>
<p><a href="ref/type-of.html"><code>type_of()</code></a> a string returns <code>"string"</code>.</p>
<h2 id="string-and-character-literals-1"><a class="header" href="#string-and-character-literals-1">String and Character Literals</a></h2>
<p>String and character literals follow JavaScript-style syntax.</p>
<div class="table-wrapper"><table><thead><tr><th>Type</th><th style="text-align: center">Quotes</th><th style="text-align: center">Escapes?</th><th style="text-align: center">Continuation?</th><th style="text-align: center">Interpolation?</th></tr></thead><tbody>
<tr><td>Normal string</td><td style="text-align: center"><code>"..."</code></td><td style="text-align: center">yes</td><td style="text-align: center">with <code>\</code></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td>Raw string</td><td style="text-align: center"><code>#..#"..."#..#</code></td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td>Multi-line literal string</td><td style="text-align: center"><code>`...`</code></td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center">with <code>${...}</code></td></tr>
<tr><td>Character</td><td style="text-align: center"><code>'...'</code></td><td style="text-align: center">yes</td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center"><strong>no</strong></td></tr>
</tbody></table>
</div><div id="admonition-tip-building-strings" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-building-strings-title">
<div class="admonition-title">
<div id="admonition-tip-building-strings-title">
<p>Tip: Building strings</p>
</div>
<a class="admonition-anchor-link" href="ref/strings-chars.html#admonition-tip-building-strings"></a>
</div>
<div>
<p>Strings can be built up from other strings and types via the <code>+</code> or <code>+=</code> operators.</p>
</div>
</div>
<h2 id="standard-escape-sequences-1"><a class="header" href="#standard-escape-sequences-1">Standard Escape Sequences</a></h2>
<div id="admonition-tip-character-to_int" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-character-to_int-title">
<div class="admonition-title">
<div id="admonition-tip-character-to_int-title">
<p>Tip: Character <code>to_int()</code></p>
</div>
<a class="admonition-anchor-link" href="ref/strings-chars.html#admonition-tip-character-to_int"></a>
</div>
<div>
<p>Use the <code>to_int</code> method to convert a Unicode character into its 32-bit Unicode encoding.</p>
</div>
</div>
<p>There is built-in support for Unicode (<code>\u</code><em>xxxx</em> or <code>\U</code><em>xxxxxxxx</em>) and hex (<code>\x</code><em>xx</em>) escape
sequences for normal strings and characters.</p>
<p>Hex sequences map to ASCII characters, while <code>\u</code> maps to 16-bit common Unicode code points and <code>\U</code>
maps the full, 32-bit extended Unicode code points.</p>
<p>Escape sequences are not supported for multi-line literal strings wrapped by back-ticks (<code>`</code>).</p>
<div class="table-wrapper"><table><thead><tr><th>Escape sequence</th><th>Meaning</th></tr></thead><tbody>
<tr><td><code>\\</code></td><td>back-slash (<code>\</code>)</td></tr>
<tr><td><code>\t</code></td><td>tab</td></tr>
<tr><td><code>\r</code></td><td>carriage-return (<code>CR</code>)</td></tr>
<tr><td><code>\n</code></td><td>line-feed (<code>LF</code>)</td></tr>
<tr><td><code>\"</code> or <code>""</code></td><td>double-quote (<code>"</code>)</td></tr>
<tr><td><code>\'</code></td><td>single-quote (<code>'</code>)</td></tr>
<tr><td><code>\x</code><em>xx</em></td><td>ASCII character in 2-digit hex</td></tr>
<tr><td><code>\u</code><em>xxxx</em></td><td>Unicode character in 4-digit hex</td></tr>
<tr><td><code>\U</code><em>xxxxxxxx</em></td><td>Unicode character in 8-digit hex</td></tr>
</tbody></table>
</div>
<h2 id="line-continuation-1"><a class="header" href="#line-continuation-1">Line Continuation</a></h2>
<p>For a normal string wrapped by double-quotes (<code>"</code>), a back-slash (<code>\</code>) character at the end of a
line indicates that the string continues onto the next line <em>without any line-break</em>.</p>
<p>Whitespace up to the indentation of the opening double-quote is ignored in order to enable lining up
blocks of text.</p>
<p>Spaces are <em>not</em> added, so to separate one line with the next with a space, put a space before the
ending back-slash (<code>\</code>) character.</p>
<pre><code class="language-rust">let x = "hello, world!\
         hello world again! \
         this is the ""last"" time!!!";
// ^^^^^^ these whitespaces are ignored

// The above is the same as:
let x = "hello, world!hello world again! this is the \"last\" time!!!";</code></pre>
<p>A string with continuation does not open up a new line.  To do so, a new-line character must be
manually inserted at the appropriate position.</p>
<pre><code class="language-rust">let x = "hello, world!\n\
         hello world again!\n\
         this is the last time!!!";

// The above is the same as:
let x = "hello, world!\nhello world again!\nthis is the last time!!!";</code></pre>
<div id="admonition-no-ending-quote-before-the-line-ends-is-a-syntax-error" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-no-ending-quote-before-the-line-ends-is-a-syntax-error-title">
<div class="admonition-title">
<div id="admonition-no-ending-quote-before-the-line-ends-is-a-syntax-error-title">
<p>No ending quote before the line ends is a syntax error</p>
</div>
<a class="admonition-anchor-link" href="ref/strings-chars.html#admonition-no-ending-quote-before-the-line-ends-is-a-syntax-error"></a>
</div>
<div>
<p>If the ending double-quote is omitted, it is a syntax error.</p>
<pre><code class="language-rust">let x = "hello
<span class="boring">";
</span>//            ^ syntax error: unterminated string literal</code></pre>
</div>
</div>
<div id="admonition-why-not-go-multi-line" class="admonition admonish-question small" role="note" aria-labelledby="admonition-why-not-go-multi-line-title">
<div class="admonition-title">
<div id="admonition-why-not-go-multi-line-title">
<p>Why not go multi-line?</p>
</div>
<a class="admonition-anchor-link" href="ref/strings-chars.html#admonition-why-not-go-multi-line"></a>
</div>
<div>
<p>Technically speaking, there is no difficulty in allowing strings to run for multiple lines
<em>without</em> the continuation back-slash.</p>
<p>Rhai forces you to manually mark a continuation with a back-slash because the ending quote is easy to omit.
Once it happens, the entire remainder of the script would become one giant, multi-line string.</p>
<p>This behavior is different from Rust, where string literals can run for multiple lines.</p>
</div>
</div>
<h2 id="raw-strings-1"><a class="header" href="#raw-strings-1">Raw Strings</a></h2>
<p>A <em>raw string</em> is any text enclosed by a pair of double-quotes (<code>"</code>), wrapped by hash (<code>#</code>) characters.</p>
<p>The number of hash (<code>#</code>) on each side must be the same.</p>
<p>Any text inside the double-quotes, as long as it is not a double-quote (<code>"</code>) followed by the same
number of hash (<code>#</code>) characters, is simply copied verbatim, <em>including control codes and/or
line-breaks</em>.</p>
<p>Raw strings are very useful for embedded regular expressions, file paths, and program code etc.</p>
<pre><code class="language-rust">let x = #"Hello, I am a raw string! which means that I can contain
             line-breaks, \ slashes (not escapes), "quotes" and even # characters!"#

// Use more than one '#' if you happen to have '"###...' inside the string...

let x = ###"In Rhai, you can write ##"hello"## as a raw string."###;
//                                         ^^^ this is not the end of the raw string</code></pre>
<h2 id="multi-line-literal-strings-1"><a class="header" href="#multi-line-literal-strings-1">Multi-Line Literal Strings</a></h2>
<p>A string wrapped by a pair of back-tick (<code>`</code>) characters is interpreted <em>literally</em>,
meaning that every single character that lies between the two back-ticks is taken verbatim.
This include new-lines, whitespaces, escape characters etc.</p>
<pre><code class="language-js">let x = `hello, world! "\t\x42"
  hello world again! 'x'
     this is the last time!!! `;

// The above is the same as:
let x = "hello, world! \"\\t\\x42\"\n  hello world again! 'x'\n     this is the last time!!! ";
</code></pre>
<p>If a back-tick (<code>`</code>) appears at the <em>end</em> of a line, then it is understood that the entire text
block starts from the <em>next</em> line; the starting new-line character is stripped.</p>
<pre><code class="language-js">let x = `
        hello, world! "\t\x42"
  hello world again! 'x'
     this is the last time!!!
`;

// The above is the same as:
let x = "        hello, world! \"\\t\\x42\"\n  hello world again! 'x'\n     this is the last time!!!\n";
</code></pre>
<p>To actually put a back-tick (<code>`</code>) character inside a multi-line literal string, use two
back-ticks together (i.e. <code>``</code>).</p>
<pre><code class="language-js">let x = `I have a quote " as well as a back-tick `` here.`;

// The above is the same as:
let x = "I have a quote \" as well as a back-tick ` here.";
</code></pre>
<h2 id="string-interpolation-1"><a class="header" href="#string-interpolation-1">String Interpolation</a></h2>
<div id="admonition-what-if-i-want--inside" class="admonition admonish-question side wide" role="note" aria-labelledby="admonition-what-if-i-want--inside-title">
<div class="admonition-title">
<div id="admonition-what-if-i-want--inside-title">
<p>What if I want <code>${</code> inside?</p>
</div>
<a class="admonition-anchor-link" href="ref/strings-chars.html#admonition-what-if-i-want--inside"></a>
</div>
<div>
<p>🤦 Well, you just <em>have</em> to ask for the impossible, don’t you?</p>
<p>Currently there is no way to escape <code>${</code>.  Build the string in three pieces:</p>
<pre><code class="language-js">`Interpolations start with "`
    + "${"
    + `" and end with }.`
</code></pre>
</div>
</div>
<p>Multi-line literal strings support <em>string interpolation</em> wrapped in <code>${</code> … <code>}</code>.</p>
<p>Interpolation is not supported for normal string or character literals.</p>
<p><code>${</code> … <code>}</code> acts as a statements <em>block</em> and can contain anything that is allowed within a
statements block, including another interpolated string!
The last result of the block is taken as the value for interpolation.</p>
<p>Rhai uses <a href="ref/convert.html"><code>to_string</code></a> to convert any value into a string, then physically joins all
the sub-strings together.</p>
<p>For convenience, if any interpolated value is a <a href="ref/blobs.html">BLOB</a>, however, it is automatically treated as a
UTF-8 encoded string.  That is because it is rarely useful to interpolate a <a href="ref/blobs.html">BLOB</a> into a string,
but extremely useful to be able to directly manipulate UTF-8 encoded text.</p>
<pre><code class="language-js">let x = 42;
let y = 123;

let s = `x = ${x} and y = ${y}.`;                   // &lt;- interpolated string

let s = ("x = " + {x} + " and y = " + {y} + ".");   // &lt;- de-sugars to this

s == "x = 42 and y = 123.";

let s = `
Undeniable logic:
1) Hello, ${let w = `${x} world`; if x &gt; 1 { w += "s" } w}!
2) If ${y} &gt; ${x} then it is ${y &gt; x}!
`;

s == "Undeniable logic:\n1) Hello, 42 worlds!\n2) If 123 &gt; 42 then it is true!\n";

let blob = blob(3, 0x21);

print(blob);                            // prints [212121]

print(`Data: ${blob}`);                 // prints "Data: !!!"
                                        // BLOB is treated as UTF-8 encoded string

print(`Data: ${blob.to_string()}`);     // prints "Data: [212121]"
</code></pre>
<h2 id="indexing-1"><a class="header" href="#indexing-1">Indexing</a></h2>
<p>Strings can be <em>indexed</em> into to get access to any individual character.
This is similar to many modern languages but different from Rust.</p>
<h3 id="from-beginning-3"><a class="header" href="#from-beginning-3">From beginning</a></h3>
<p>Individual characters within a string can be accessed with zero-based, non-negative integer indices:</p>
<blockquote>
<p><em>string</em> <code>[</code> <em>index from 0 to (total number of characters − 1)</em> <code>]</code></p>
</blockquote>
<h3 id="from-end-3"><a class="header" href="#from-end-3">From end</a></h3>
<p>A <em>negative</em> index accesses a character in the string counting from the <em>end</em>, with −1 being the
<em>last</em> character.</p>
<blockquote>
<p><em>string</em> <code>[</code> <em>index from −1 to −(total number of characters)</em> <code>]</code></p>
</blockquote>
<div id="admonition-character-indexing-can-be-sloooooooow" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-character-indexing-can-be-sloooooooow-title">
<div class="admonition-title">
<div id="admonition-character-indexing-can-be-sloooooooow-title">
<p>Character indexing can be SLOOOOOOOOW</p>
</div>
<a class="admonition-anchor-link" href="ref/strings-chars.html#admonition-character-indexing-can-be-sloooooooow"></a>
</div>
<div>
<p>Internally, a Rhai string is still stored compactly as a Rust UTF-8 string in order to save memory.</p>
<p>Therefore, getting the character at a particular index involves walking through the entire UTF-8
encoded bytes stream to extract individual Unicode characters, counting them on the way.</p>
<p>Because of this, indexing can be a <em>slow</em> procedure, especially for long strings.
Along the same lines, getting the <em>length</em> of a string (which returns the number of characters, not
bytes) can also be slow.</p>
</div>
</div>
<h2 id="sub-strings-1"><a class="header" href="#sub-strings-1">Sub-Strings</a></h2>
<p>Sub-strings, or <em>slices</em> in some programming languages, are parts of strings.</p>
<p>In Rhai, a sub-string can be specified by indexing with a <a href="ref/ranges.html">range</a> of characters:</p>
<blockquote>
<p><em>string</em> <code>[</code> <em>first character (starting from zero)</em> <code>..</code> <em>last character (exclusive)</em> <code>]</code></p>
<p><em>string</em> <code>[</code> <em>first character (starting from zero)</em> <code>..=</code> <em>last character (inclusive)</em> <code>]</code></p>
</blockquote>
<p>Sub-string <a href="ref/ranges.html">ranges</a> always start from zero counting towards the end of the string.
Negative <a href="ref/ranges.html">ranges</a> are not supported.</p>
<h2 id="examples-21"><a class="header" href="#examples-21">Examples</a></h2>
<pre><code class="language-js">let name = "Bob";
let middle_initial = 'C';
let last = "Davis";

let full_name = `${name} ${middle_initial}. ${last}`;
full_name == "Bob C. Davis";

// String building with different types
let age = 42;
let record = `${full_name}: age ${age}`;
record == "Bob C. Davis: age 42";

// Unlike Rust, Rhai strings can be indexed to get a character
// (disabled with 'no_index')
let c = record[4];
c == 'C';                               // single character

let slice = record[4..8];               // sub-string slice
slice == " C. D";

ts.s = record;                          // custom type properties can take strings

let c = ts.s[4];
c == 'C';

let c = ts.s[-4];                       // negative index counts from the end
c == 'e';

let c = "foo"[0];                       // indexing also works on string literals...
c == 'f';

let c = ("foo" + "bar")[5];             // ... and expressions returning strings
c == 'r';

let text = "hello, world!";
text[0] = 'H';                          // modify a single character
text == "Hello, world!";

text[7..=11] = "Earth";                 // modify a sub-string slice
text == "Hello, Earth!";

// Escape sequences in strings
record += " \u2764\n";                  // escape sequence of '❤' in Unicode
record == "Bob C. Davis: age 42 ❤\n";  // '\n' = new-line

// Unlike Rust, Rhai strings can be directly modified character-by-character
// (disabled with 'no_index')
record[4] = '\x58'; // 0x58 = 'X'
record == "Bob X. Davis: age 42 ❤\n";

// Use 'in' to test if a substring (or character) exists in a string
"Davis" in record == true;
'X' in record == true;
'C' in record == false;

// Strings can be iterated with a 'for' statement, yielding characters
for ch in record {
    print(ch);
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="standard-string-functions-1"><a class="header" href="#standard-string-functions-1">Standard String Functions</a></h1>
<p>The following standard methods operate on <a href="ref/strings-chars.html">strings</a> (and possibly characters).</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Parameter(s)</th><th>Description</th></tr></thead><tbody>
<tr><td><code>len</code> method and property</td><td><em>none</em></td><td>returns the number of characters (<strong>not</strong> number of bytes) in the string</td></tr>
<tr><td><code>bytes</code> method and property</td><td><em>none</em></td><td>returns the number of bytes making up the UTF-8 string; for strings containing only ASCII characters, this is much faster than <code>len</code></td></tr>
<tr><td><code>is_empty</code> method and property</td><td><em>none</em></td><td>returns <code>true</code> if the string is empty</td></tr>
<tr><td><code>to_blob</code></td><td><em>none</em></td><td>converts the string into an UTF-8 encoded byte-stream and returns it as a <a href="ref/blobs.html">BLOB</a>.</td></tr>
<tr><td><code>to_chars</code></td><td><em>none</em></td><td>splits the string by individual characters, returning them as an <a href="ref/arrays.html">array</a></td></tr>
<tr><td><code>get</code></td><td>position, counting from end if &lt; 0</td><td>gets the character at a certain position (<code>()</code> if the position is not valid)</td></tr>
<tr><td><code>set</code></td><td><ol><li>position, counting from end if &lt; 0</li><li>new character</li></ol></td><td>sets a certain position to a new character (no effect if the position is not valid)</td></tr>
<tr><td><code>pad</code></td><td><ol><li>target length</li><li>character/string to pad</li></ol></td><td>pads the string with a character or a string to at least a specified length</td></tr>
<tr><td><code>append</code>, <code>+=</code> operator</td><td>item to append</td><td>adds the display text of an item to the end of the string</td></tr>
<tr><td><code>remove</code></td><td>character/string to remove</td><td>removes a character or a string from the string</td></tr>
<tr><td><code>pop</code></td><td><em>(optional)</em> number of characters to remove, none if ≤ 0, entire string if ≥ length</td><td>removes the last character (if no parameter) and returns it (<code>()</code> if empty); otherwise, removes the last number of characters and returns them as a string</td></tr>
<tr><td><code>clear</code></td><td><em>none</em></td><td>empties the string</td></tr>
<tr><td><code>truncate</code></td><td>target length</td><td>cuts off the string at exactly a specified number of characters</td></tr>
<tr><td><code>to_upper</code></td><td><em>none</em></td><td>converts the string/character into upper-case as a new string/character and returns it</td></tr>
<tr><td><code>to_lower</code></td><td><em>none</em></td><td>converts the string/character into lower-case as a new string/character and returns it</td></tr>
<tr><td><code>make_upper</code></td><td><em>none</em></td><td>converts the string/character into upper-case</td></tr>
<tr><td><code>make_lower</code></td><td><em>none</em></td><td>converts the string/character into lower-case</td></tr>
<tr><td><code>trim</code></td><td><em>none</em></td><td>trims the string of whitespace at the beginning and end</td></tr>
<tr><td><code>contains</code></td><td>character/sub-string to search for</td><td>checks if a certain character or sub-string occurs in the string</td></tr>
<tr><td><code>starts_with</code></td><td>string</td><td>returns <code>true</code> if the string starts with a certain string</td></tr>
<tr><td><code>ends_with</code></td><td>string</td><td>returns <code>true</code> if the string ends with a certain string</td></tr>
<tr><td><code>min</code></td><td><ol><li>first character/string</li><li>second character/string</li><ol></td><td>returns the smaller of two characters/strings</td></tr>
<tr><td><code>max</code></td><td><ol><li>first character/string</li><li>second character/string</li><ol></td><td>returns the larger of two characters/strings</td></tr>
<tr><td><code>index_of</code></td><td><ol><li>character/sub-string to search for</li><li><em>(optional)</em> start position, counting from end if &lt; 0, end if ≥ length</li></ol></td><td>returns the position that a certain character or sub-string occurs in the string, or −1 if not found</td></tr>
<tr><td><code>sub_string</code></td><td><ol><li>start position, counting from end if &lt; 0</li><li><em>(optional)</em> number of characters to extract, none if ≤ 0, to end if omitted</li></ol></td><td>extracts a sub-string</td></tr>
<tr><td><code>sub_string</code></td><td><a href="ref/ranges.html">range</a> of characters to extract, from beginning if ≤ 0, to end if ≥ length</td><td>extracts a sub-string</td></tr>
<tr><td><code>split</code></td><td><em>none</em></td><td>splits the string by whitespaces, returning an <a href="ref/arrays.html">array</a> of string segments</td></tr>
<tr><td><code>split</code></td><td>position to split at (in number of characters), counting from end if &lt; 0, end if ≥ length</td><td>splits the string into two segments at the specified character position, returning an <a href="ref/arrays">array</a> of two string segments</td></tr>
<tr><td><code>split</code></td><td><ol><li>delimiter character/string</li><li><em>(optional)</em> maximum number of segments, 1 if &lt; 1</li></ol></td><td>splits the string by the specified delimiter, returning an <a href="ref/arrays">array</a> of string segments</td></tr>
<tr><td><code>split_rev</code></td><td><ol><li>delimiter character/string</li><li><em>(optional)</em> maximum number of segments, 1 if &lt; 1</li></ol></td><td>splits the string by the specified delimiter in reverse order, returning an <a href="ref/arrays">array</a> of string segments</td></tr>
<tr><td><code>crop</code></td><td><ol><li>start position, counting from end if &lt; 0</li><li><em>(optional)</em> number of characters to retain, none if ≤ 0, to end if omitted</li></ol></td><td>retains only a portion of the string</td></tr>
<tr><td><code>crop</code></td><td><a href="ref/ranges.html">range</a> of characters to retain, from beginning if ≤ 0, to end if ≥ length</td><td>retains only a portion of the string</td></tr>
<tr><td><code>replace</code></td><td><ol><li>target character/sub-string</li><li>replacement character/string</li></ol></td><td>replaces a sub-string with another</td></tr>
<tr><td><code>chars</code> method and property</td><td><ol><li><em>(optional)</em> start position, counting from end if &lt; 0</li><li><em>(optional)</em> number of characters to iterate, none if ≤ 0</li></ol></td><td>allows iteration of the characters inside the string</td></tr>
</tbody></table>
</div>
<p>Beware that functions that involve indexing into a <a href="ref/strings-chars.html">string</a> to get at individual
<a href="ref/strings-chars.html">characters</a>, e.g. <code>sub_string</code>, require walking through the entire UTF-8 encoded
bytes stream to extract individual Unicode characters and counting them, which can be slow for long
<a href="ref/strings-chars.html">strings</a>.</p>
<h2 id="building-strings-1"><a class="header" href="#building-strings-1">Building Strings</a></h2>
<p><a href="ref/strings-chars.html">Strings</a> can be built from segments via the <code>+</code> operator.</p>
<div class="table-wrapper"><table><thead><tr><th>Operator</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="ref/strings-chars.html">string</a> <code>+=</code> item</td><td>convert the item into a <a href="ref/strings-chars.html">string</a>, then append it to the first <a href="ref/strings-chars.html">string</a></td></tr>
<tr><td><a href="ref/strings-chars.html">string</a> <code>+</code> item</td><td>convert the item into a <a href="ref/strings-chars.html">string</a>, then concatenate them as a new <a href="ref/strings-chars.html">string</a></td></tr>
<tr><td>item <code>+</code> <a href="ref/strings-chars.html">string</a></td><td>convert the item into a <a href="ref/strings-chars.html">string</a>, then concatenate them as a new <a href="ref/strings-chars.html">string</a></td></tr>
</tbody></table>
</div>
<pre><code class="language-rust">let x = 42;

// Build string with '+'
let s = "The answer is: " + x + "!!!";

// Prints: "The answer is: 42!!!"
print(s);</code></pre>
<h3 id="standard-operators-between-strings-andor-characters-1"><a class="header" href="#standard-operators-between-strings-andor-characters-1">Standard Operators Between Strings and/or Characters</a></h3>
<p>The following standard operators inter-operate between <a href="ref/strings-chars.html">strings</a> and/or
<a href="ref/strings-chars.html">characters</a>.</p>
<p>When one (or both) of the operands is a <a href="ref/strings-chars.html">character</a>, it is first converted into a
one-character <a href="ref/strings-chars.html">string</a> before running the operator.</p>
<div class="table-wrapper"><table><thead><tr><th>Operator</th><th>Description</th></tr></thead><tbody>
<tr><td><code>+</code>, <code>+=</code></td><td><a href="ref/strings-chars.html">character</a>/<a href="ref/strings-chars.html">string</a> concatenation</td></tr>
<tr><td><code>-</code>, <code>-=</code></td><td>remove [character](strings-chars.md/<a href="ref/strings-chars.html">sub-string</a> from <a href="ref/strings-chars.html">string</a></td></tr>
<tr><td><code>==</code></td><td>equals to</td></tr>
<tr><td><code>!=</code></td><td>not equals to</td></tr>
<tr><td><code>&gt;</code></td><td>greater than</td></tr>
<tr><td><code>&gt;=</code></td><td>greater than or equals to</td></tr>
<tr><td><code>&lt;</code></td><td>less than</td></tr>
<tr><td><code>&lt;=</code></td><td>less than or equals to</td></tr>
</tbody></table>
</div>
<h3 id="interop-with-blobs-1"><a class="header" href="#interop-with-blobs-1">Interop with BLOB’s</a></h3>
<p>For convenience, when a <a href="ref/blobs.html">BLOB</a> is appended to a <a href="ref/strings-chars.html">string</a>, or vice
versa, it is treated as a UTF-8 encoded byte stream and automatically first converted into the appropriate
<a href="ref/strings-chars.html">string</a> value.</p>
<p>That is because it is rarely useful to append a <a href="ref/blobs.html">BLOB</a> into a string, but extremely useful
to be able to directly manipulate UTF-8 encoded text.</p>
<div class="table-wrapper"><table><thead><tr><th>Operator</th><th>Description</th></tr></thead><tbody>
<tr><td><code>+</code>, <code>+=</code></td><td>append a <a href="ref/blobs.html">BLOB</a> (as a UTF-8 encoded byte stream) to the end of the <a href="ref/strings-chars.html">string</a></td></tr>
<tr><td><code>+</code></td><td>concatenate a <a href="ref/blobs.html">BLOB</a> (as a UTF-8 encoded byte stream) with a <a href="ref/strings-chars.html">string</a></td></tr>
</tbody></table>
</div>
<h2 id="examples-22"><a class="header" href="#examples-22">Examples</a></h2>
<pre><code class="language-rust">let full_name == " Bob C. Davis ";
full_name.len == 14;

full_name.trim();
full_name.len == 12;
full_name == "Bob C. Davis";

full_name.pad(15, '$');
full_name.len == 15;
full_name == "Bob C. Davis$$$";

let n = full_name.index_of('$');
n == 12;

full_name.index_of("$$", n + 1) == 13;

full_name.sub_string(n, 3) == "$$$";
full_name.sub_string(n..n+3) == "$$$";

full_name.truncate(6);
full_name.len == 6;
full_name == "Bob C.";

full_name.replace("Bob", "John");
full_name.len == 7;
full_name == "John C.";

full_name.contains('C') == true;
full_name.contains("John") == true;

full_name.crop(5);
full_name == "C.";

full_name.crop(0, 1);
full_name == "C";

full_name.clear();
full_name.len == 0;</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="arrays-1"><a class="header" href="#arrays-1">Arrays</a></h1>
<p>Arrays are first-class citizens in Rhai.</p>
<p>All elements stored in an array are dynamic, and the array can freely grow or shrink with elements
added or removed.</p>
<p><a href="ref/type-of.html"><code>type_of()</code></a> an array returns <code>"array"</code>.</p>
<h2 id="literal-syntax-2"><a class="header" href="#literal-syntax-2">Literal Syntax</a></h2>
<p>Array literals are built within square brackets <code>[</code> … <code>]</code> and separated by commas <code>,</code>:</p>
<blockquote>
<p><code>[</code> <em>value</em><code>,</code> <em>value</em><code>,</code> … <code>,</code> <em>value</em> <code>]</code></p>
<p><code>[</code> <em>value</em><code>,</code> <em>value</em><code>,</code> … <code>,</code> <em>value</em> <code>,</code> <code>]</code>     <code>// trailing comma is OK</code></p>
</blockquote>
<h2 id="element-access-syntax-2"><a class="header" href="#element-access-syntax-2">Element Access Syntax</a></h2>
<h3 id="from-beginning-4"><a class="header" href="#from-beginning-4">From beginning</a></h3>
<p>Like C, arrays are accessed with zero-based, non-negative integer indices:</p>
<blockquote>
<p><em>array</em> <code>[</code> <em>index position from 0 to length−1</em> <code>]</code></p>
</blockquote>
<h3 id="from-end-4"><a class="header" href="#from-end-4">From end</a></h3>
<p>A <em>negative</em> position accesses an element in the array counting from the <em>end</em>, with −1 being the
<em>last</em> element.</p>
<blockquote>
<p><em>array</em> <code>[</code> <em>index position from −1 to −length</em> <code>]</code></p>
</blockquote>
<h2 id="built-in-functions-8"><a class="header" href="#built-in-functions-8">Built-in Functions</a></h2>
<p>The following methods operate on arrays.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Parameter(s)</th><th>Description</th></tr></thead><tbody>
<tr><td><code>get</code></td><td>position, counting from end if &lt; 0</td><td>gets a copy of the element at a certain position (<code>()</code> if the position is not valid)</td></tr>
<tr><td><code>set</code></td><td><ol><li>position, counting from end if &lt; 0</li><li>new element</li></ol></td><td>sets a certain position to a new value (no effect if the position is not valid)</td></tr>
<tr><td><code>push</code>, <code>+=</code> operator</td><td>element to append (not an array)</td><td>appends an element to the end</td></tr>
<tr><td><code>append</code>, <code>+=</code> operator</td><td>array to append</td><td>concatenates the second array to the end of the first</td></tr>
<tr><td><code>+</code> operator</td><td><ol><li>first array</li><li>second array</li></ol></td><td>concatenates the first array with the second</td></tr>
<tr><td><code>==</code> operator</td><td><ol><li>first array</li><li>second array</li></ol></td><td>are two arrays the same (elements compared with the <code>==</code> operator, if defined)?</td></tr>
<tr><td><code>!=</code> operator</td><td><ol><li>first array</li><li>second array</li></ol></td><td>are two arrays different (elements compared with the <code>==</code> operator, if defined)?</td></tr>
<tr><td><code>insert</code></td><td><ol><li>position, counting from end if &lt; 0, end if ≥ length</li><li>element to insert</li></ol></td><td>inserts an element at a certain position</td></tr>
<tr><td><code>pop</code></td><td><em>none</em></td><td>removes the last element and returns it (<code>()</code> if empty)</td></tr>
<tr><td><code>shift</code></td><td><em>none</em></td><td>removes the first element and returns it (<code>()</code> if empty)</td></tr>
<tr><td><code>extract</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li><em>(optional)</em> number of elements to extract, none if ≤ 0, to end if omitted</li></ol></td><td>extracts a portion of the array into a new array</td></tr>
<tr><td><code>extract</code></td><td><a href="ref/ranges.html">range</a> of elements to extract, from beginning if ≤ 0, to end if ≥ length</td><td>extracts a portion of the array into a new array</td></tr>
<tr><td><code>remove</code></td><td>position, counting from end if &lt; 0</td><td>removes an element at a particular position and returns it (<code>()</code> if the position is not valid)</td></tr>
<tr><td><code>reverse</code></td><td><em>none</em></td><td>reverses the array</td></tr>
<tr><td><code>len</code> method and property</td><td><em>none</em></td><td>returns the number of elements</td></tr>
<tr><td><code>is_empty</code> method and property</td><td><em>none</em></td><td>returns <code>true</code> if the array is empty</td></tr>
<tr><td><code>pad</code></td><td><ol><li>target length</li><li>element to pad</li></ol></td><td>pads the array with an element to at least a specified length</td></tr>
<tr><td><code>clear</code></td><td><em>none</em></td><td>empties the array</td></tr>
<tr><td><code>truncate</code></td><td>target length</td><td>cuts off the array at exactly a specified length (discarding all subsequent elements)</td></tr>
<tr><td><code>chop</code></td><td>target length</td><td>cuts off the head of the array, leaving the tail at exactly a specified length</td></tr>
<tr><td><code>split</code></td><td><ol><li>array</li><li>position to split at, counting from end if &lt; 0, end if ≥ length</li></ol></td><td>splits the array into two arrays, starting from a specified position</td></tr>
<tr><td><code>for_each</code></td><td><a href="ref/fn-ptr.html">function pointer</a> for processing elements</td><td>run through each element in the array in order, binding each to <code>this</code> and calling the processing function taking the following parameters: <ol><li><code>this</code>: array element</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>drain</code></td><td><a href="ref/fn-ptr.html">function pointer</a> to predicate (usually a <a href="ref/fn-closure.html">closure</a>)</td><td>removes all elements (returning them) that return <code>true</code> when called with the predicate function taking the following parameters (if none, the array element is bound to <code>this</code>):<ol><li>array element</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>drain</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of elements to remove, none if ≤ 0</li></ol></td><td>removes a portion of the array, returning the removed elements as a new array</td></tr>
<tr><td><code>drain</code></td><td><a href="ref/ranges.html">range</a> of elements to remove, from beginning if ≤ 0, to end if ≥ length</td><td>removes a portion of the array, returning the removed elements as a new array</td></tr>
<tr><td><code>retain</code></td><td><a href="ref/fn-ptr.html">function pointer</a> to predicate (usually a <a href="ref/fn-closure.html">closure</a>)</td><td>removes all elements (returning them) that do not return <code>true</code> when called with the predicate function taking the following parameters (if none, the array element is bound to <code>this</code>):<ol><li>array element</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>retain</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of elements to retain, none if ≤ 0</li></ol></td><td>retains a portion of the array, removes all other elements and returning them as a new array</td></tr>
<tr><td><code>retain</code></td><td><a href="ref/ranges.html">range</a> of elements to retain, from beginning if ≤ 0, to end if ≥ length</td><td>retains a portion of the array, removes all other bytes and returning them as a new array</td></tr>
<tr><td><code>splice</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of elements to remove, none if ≤ 0</li><li>array to insert</li></ol></td><td>replaces a portion of the array with another (not necessarily of the same length as the replaced portion)</td></tr>
<tr><td><code>splice</code></td><td><ol><li><a href="ref/ranges.html">range</a> of elements to remove, from beginning if ≤ 0, to end if ≥ length</li><li>array to insert</li></ol></td><td>replaces a portion of the array with another (not necessarily of the same length as the replaced portion)</td></tr>
<tr><td><code>filter</code></td><td><a href="ref/fn-ptr.html">function pointer</a> to predicate (usually a <a href="ref/fn-closure.html">closure</a>)</td><td>constructs a new array with all elements that return <code>true</code> when called with the predicate function taking the following parameters (if none, the array element is bound to <code>this</code>):<ol><li>array element</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>contains</code>, <code>in</code> operator</td><td>element to find</td><td>does the array contain an element? The <code>==</code> operator is used for comparison</td></tr>
<tr><td><code>index_of</code></td><td><ol><li>element to find (not a <a href="ref/fn-ptr.html">function pointer</a>)</li><li><em>(optional)</em> start position, counting from end if &lt; 0, end if ≥ length</li></ol></td><td>returns the position of the first element in the array that equals the supplied element (using the <code>==</code> operator, if defined), or −1 if not found</li></ol></td></tr>
<tr><td><code>index_of</code></td><td><ol><li><a href="ref/fn-ptr.html">function pointer</a> to predicate (usually a <a href="ref/fn-closure.html">closure</a>)</li><li><em>(optional)</em> start position, counting from end if &lt; 0, end if ≥ length</li></ol></td><td>returns the position of the first element in the array that returns <code>true</code> when called with the predicate function, or −1 if not found:<ol><li><code>this</code>: array element</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>find</code></td><td><ol><li><a href="ref/fn-ptr.html">function pointer</a> to predicate (usually a <a href="ref/fn-closure.html">closure</a>)</li><li><em>(optional)</em> start position, counting from end if &lt; 0, end if ≥ length</li></ol></td><td>returns the first element in the array that returns <code>true</code> when called with the predicate function, or <code>()</code> if not found:<ol><li>array element (if none, the array element is bound to <code>this</code>)</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>find_map</code></td><td><ol><li><a href="ref/fn-ptr.html">function pointer</a> to predicate (usually a <a href="ref/fn-closure.html">closure</a>)</li><li><em>(optional)</em> start position, counting from end if &lt; 0, end if ≥ length</li></ol></td><td>returns the first non-<code>()</code> value of the first element in the array when called with the predicate function, or <code>()</code> if not found:<ol><li>array element (if none, the array element is bound to <code>this</code>)</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>dedup</code></td><td><em>(optional)</em> <a href="ref/fn-ptr.html">function pointer</a> to predicate (usually a <a href="ref/fn-closure.html">closure</a>); if omitted, the <code>==</code> operator is used, if defined</td><td>removes all but the first of <em>consecutive</em> elements in the array that return <code>true</code> when called with the predicate function (non-consecutive duplicates are <em>not</em> removed):<br/>1st &amp; 2nd parameters: two elements in the array</td></tr>
<tr><td><code>map</code></td><td><a href="ref/fn-ptr.html">function pointer</a> to conversion function (usually a <a href="ref/fn-closure.html">closure</a>)</td><td>constructs a new array with all elements mapped to the result of applying the conversion function taking the following parameters (if none, the array element is bound to <code>this</code>):<ol><li>array element</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>reduce</code></td><td><ol><li><a href="ref/fn-ptr.html">function pointer</a> to accumulator function (usually a <a href="ref/fn-closure.html">closure</a>)</li><li><em>(optional)</em> the initial value</li></ol></td><td>reduces the array into a single value via the accumulator function taking the following parameters (if the second parameter is omitted, the array element is bound to <code>this</code>):<ol><li>accumulated value (<code>()</code> initially)</li><li>array element</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>reduce_rev</code></td><td><ol><li><a href="ref/fn-ptr.html">function pointer</a> to accumulator function (usually a <a href="ref/fn-closure.html">closure</a>)</li><li><em>(optional)</em> the initial value</li></ol></td><td>reduces the array (in reverse order) into a single value via the accumulator function taking the following parameters (if the second parameter is omitted, the array element is bound to <code>this</code>):<ol><li>accumulated value (<code>()</code> initially)</li><li>array element</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>some</code></td><td><a href="ref/fn-ptr.html">function pointer</a> to predicate (usually a <a href="ref/fn-closure.html">closure</a>)</td><td>returns <code>true</code> if any element returns <code>true</code> when called with the predicate function taking the following parameters (if none, the array element is bound to <code>this</code>):<ol><li>array element</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>all</code></td><td><a href="ref/fn-ptr.html">function pointer</a> to predicate (usually a <a href="ref/fn-closure.html">closure</a>)</td><td>returns <code>true</code> if all elements return <code>true</code> when called with the predicate function taking the following parameters (if none, the array element is bound to <code>this</code>):<ol><li>array element</li><li><em>(optional)</em> index position</li></ol></td></tr>
<tr><td><code>sort</code></td><td><a href="ref/fn-ptr.html">function pointer</a> to a comparison function (usually a <a href="ref/fn-closure.html">closure</a>)</td><td>sorts the array with a comparison function taking the following parameters:<ol><li>first element</li><li>second element<br/>return value: <code>INT</code> &lt; 0 if first &lt; second, &gt; 0 if first &gt; second, 0 if first == second</li></ol></td></tr>
<tr><td><code>sort</code></td><td><em>none</em></td><td>sorts a <em>homogeneous</em> array containing only elements of the same comparable built-in type (integers, floating-point, decimal, <a href="ref/strings-chars.html">string</a>, <a href="ref/strings-chars.html">character</a>, <code>bool</code>, <code>()</code>)</td></tr>
</tbody></table>
</div>
<h2 id="examples-23"><a class="header" href="#examples-23">Examples</a></h2>
<pre><code class="language-rust">let y = [2, 3];             // y == [2, 3]

let y = [2, 3,];            // y == [2, 3]

y.insert(0, 1);             // y == [1, 2, 3]

y.insert(999, 4);           // y == [1, 2, 3, 4]

y.len == 4;

y[0] == 1;
y[1] == 2;
y[2] == 3;
y[3] == 4;

(1 in y) == true;           // use 'in' to test if an element exists in the array

(42 in y) == false;         // 'in' uses the 'contains' function, which uses the
                            // '==' operator (that users can override)
                            // to check if the target element exists in the array

y.contains(1) == true;      // the above de-sugars to this

y[1] = 42;                  // y == [1, 42, 3, 4]

(42 in y) == true;

y.remove(2) == 3;           // y == [1, 42, 4]

y.len == 3;

y[2] == 4;                  // elements after the removed element are shifted

ts.list = y;                // arrays can be assigned completely (by value copy)

ts.list[1] == 42;

[1, 2, 3][0] == 1;          // indexing on array literal

[1, 2, 3][-1] == 3;         // negative position counts from the end

fn abc() {
    [42, 43, 44]            // a function returning an array
}

abc()[0] == 42;

y.push(4);                  // y == [1, 42, 4, 4]

y += 5;                     // y == [1, 42, 4, 4, 5]

y.len == 5;

y.shift() == 1;             // y == [42, 4, 4, 5]

y.chop(3);                  // y == [4, 4, 5]

y.len == 3;

y.pop() == 5;               // y == [4, 4]

y.len == 2;

for element in y {          // arrays can be iterated with a 'for' statement
    print(element);
}

y.pad(6, "hello");          // y == [4, 4, "hello", "hello", "hello", "hello"]

y.len == 6;

y.truncate(4);              // y == [4, 4, "hello", "hello"]

y.len == 4;

y.clear();                  // y == []

y.len == 0;

// The examples below use 'a' as the master array

let a = [42, 123, 99];

a.map(|v| v + 1);           // returns [43, 124, 100]

a.map(|| this + 1);         // returns [43, 124, 100]

a.map(|v, i| v + i);        // returns [42, 124, 101]

a.filter(|v| v &gt; 50);       // returns [123, 99]

a.filter(|| this &gt; 50);     // returns [123, 99]

a.filter(|v, i| i == 1);    // returns [123]

a.filter("is_odd");         // returns [123, 99]

a.filter(Fn("is_odd"));     // &lt;- previous statement is equivalent to this...

a.filter(|v| is_odd(v));    // &lt;- or this

a.some(|v| v &gt; 50);         // returns true

a.some(|| this &gt; 50);       // returns true

a.some(|v, i| v &lt; i);       // returns false

a.all(|v| v &gt; 50);          // returns false

a.all(|| this &gt; 50);        // returns false

a.all(|v, i| v &gt; i);        // returns true

// Reducing - initial value provided directly
a.reduce(|sum| sum + this, 0) == 264;

// Reducing - initial value provided directly
a.reduce(|sum, v| sum + v, 0) == 264;

// Reducing - initial value is '()'
a.reduce(
    |sum, v| if sum.type_of() == "()" { v } else { sum + v }
) == 264;

// Reducing - initial value has index position == 0
a.reduce(|sum, v, i|
    if i == 0 { v } else { sum + v }
) == 264;

// Reducing in reverse - initial value provided directly
a.reduce_rev(|sum| sum + this, 0) == 264;

// Reducing in reverse - initial value provided directly
a.reduce_rev(|sum, v| sum + v, 0) == 264;

// Reducing in reverse - initial value is '()'
a.reduce_rev(
    |sum, v| if sum.type_of() == "()" { v } else { sum + v }
) == 264;

// Reducing in reverse - initial value has index position == 0
a.reduce_rev(|sum, v, i|
    if i == 2 { v } else { sum + v }
) == 264;

// In-place modification

a.splice(1..=1, [1, 3, 2]); // a == [42, 1, 3, 2, 99]

a.extract(1..=3);           // returns [1, 3, 2]

a.sort(|x, y| y - x);       // a == [99, 42, 3, 2, 1]

a.sort();                   // a == [1, 2, 3, 42, 99]

a.drain(|v| v &lt;= 1);        // a == [2, 3, 42, 99]

a.drain(|v, i| i ≥ 3);      // a == [2, 3, 42]

a.retain(|v| v &gt; 10);       // a == [42]

a.retain(|v, i| i &gt; 0);     // a == []</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="blobs-1"><a class="header" href="#blobs-1">BLOB’s</a></h1>
<p>BLOB’s (<strong>B</strong>inary <strong>L</strong>arge <strong>OB</strong>jects), used to hold packed arrays of bytes, have built-in
support in Rhai.</p>
<p>A BLOB has no literal representation, but is created via the <code>blob</code> function, or simply returned as
the result of a function call (e.g. <code>generate_thumbnail_image</code> that generates a thumbnail version of
a large image as a BLOB).</p>
<p>All items stored in a BLOB are bytes (i.e. <code>u8</code>) and the BLOB can freely grow or shrink with bytes
added or removed.</p>
<p><a href="ref/type-of.html"><code>type_of()</code></a> a BLOB returns <code>"blob"</code>.</p>
<h2 id="element-access-syntax-3"><a class="header" href="#element-access-syntax-3">Element Access Syntax</a></h2>
<h3 id="from-beginning-5"><a class="header" href="#from-beginning-5">From beginning</a></h3>
<p>Like <a href="ref/arrays.html">arrays</a>, BLOB’s are accessed with zero-based, non-negative integer indices:</p>
<blockquote>
<p><em>blob</em> <code>[</code> <em>index position from 0 to length−1</em> <code>]</code></p>
</blockquote>
<h3 id="from-end-5"><a class="header" href="#from-end-5">From end</a></h3>
<p>A <em>negative</em> position accesses an element in the BLOB counting from the <em>end</em>, with −1 being the
<em>last</em> element.</p>
<blockquote>
<p><em>blob</em> <code>[</code> <em>index position from −1 to −length</em> <code>]</code></p>
</blockquote>
<div id="admonition-byte-values" class="admonition admonish-info small" role="note" aria-labelledby="admonition-byte-values-title">
<div class="admonition-title">
<div id="admonition-byte-values-title">
<p>Byte values</p>
</div>
<a class="admonition-anchor-link" href="ref/blobs.html#admonition-byte-values"></a>
</div>
<div>
<p>The value of a particular byte in a BLOB is mapped to an integer.</p>
<p>Only the lowest 8 bits are significant, all other bits are ignored.</p>
</div>
</div>
<h2 id="create-a-blob-1"><a class="header" href="#create-a-blob-1">Create a BLOB</a></h2>
<p>The function <code>blob</code> allows creating an empty BLOB, optionally filling it to a required size with a
particular value (default zero).</p>
<pre><code class="language-rust">let x = blob();             // empty BLOB

let x = blob(10);           // BLOB with ten zeros

let x = blob(50, 42);       // BLOB with 50x 42's</code></pre>
<div id="admonition-tip-initialize-with-byte-stream" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-initialize-with-byte-stream-title">
<div class="admonition-title">
<div id="admonition-tip-initialize-with-byte-stream-title">
<p>Tip: Initialize with byte stream</p>
</div>
<a class="admonition-anchor-link" href="ref/blobs.html#admonition-tip-initialize-with-byte-stream"></a>
</div>
<div>
<p>To quickly initialize a BLOB with a particular byte stream, the <code>write_be</code> method can be used to
write eight bytes at a time (four under 32-bit) in big-endian byte order.</p>
<p>If fewer than eight bytes are needed, remember to right-pad the number as big-endian byte order is used.</p>
<pre><code class="language-rust">let buf = blob(12, 0);      // BLOB with 12x zeros

// Write eight bytes at a time, in big-endian order
buf.write_be(0, 8, 0xab_cd_ef_12_34_56_78_90);
buf.write_be(8, 8, 0x0a_0b_0c_0d_00_00_00_00);
                            //   ^^^^^^^^^^^ remember to pad unused bytes

print(buf);                 // prints "[abcdef1234567890 0a0b0c0d]"

buf[3] == 0x12;
buf[10] == 0x0c;

// Under 'only_i32', write four bytes at a time:
buf.write_be(0, 4, 0xab_cd_ef_12);
buf.write_be(4, 4, 0x34_56_78_90);
buf.write_be(8, 4, 0x0a_0b_0c_0d);</code></pre>
</div>
</div>
<h2 id="writing-ascii-bytes-1"><a class="header" href="#writing-ascii-bytes-1">Writing ASCII Bytes</a></h2>
<div id="admonition-non-ascii" class="admonition admonish-warning side" role="note" aria-labelledby="admonition-non-ascii-title">
<div class="admonition-title">
<div id="admonition-non-ascii-title">
<p>Non-ASCII</p>
</div>
<a class="admonition-anchor-link" href="ref/blobs.html#admonition-non-ascii"></a>
</div>
<div>
<p>Non-ASCII characters (i.e. characters not within 1-127) are ignored.</p>
</div>
</div>
<p>For many embedded applications, it is necessary to encode an ASCII <a href="ref/strings-chars.html">string</a> as a
byte stream.</p>
<p>Use the <code>write_ascii</code> method to write ASCII <a href="ref/strings-chars.html">strings</a> into any specific
<a href="ref/ranges.html">range</a> within a BLOB.</p>
<p>The following is an example of a building a 16-byte command to send to an embedded device.</p>
<pre><code class="language-rust">// Assume the following 16-byte command for an embedded device:
// ┌─────────┬───────────────┬──────────────────────────────────┬───────┐
// │    0    │       1       │              2-13                │ 14-15 │
// ├─────────┼───────────────┼──────────────────────────────────┼───────┤
// │ command │ string length │ ASCII string, max. 12 characters │  CRC  │
// └─────────┴───────────────┴──────────────────────────────────┴───────┘

let buf = blob(16, 0);      // initialize command buffer

let text = "foo &amp; bar";     // text string to send to device

buf[0] = 0x42;              // command code
buf[1] = s.len();           // length of string

buf.write_ascii(2..14, text);   // write the string

let crc = buf.calc_crc();   // calculate CRC

buf.write_le(14, 2, crc);   // write CRC

print(buf);                 // prints "[4209666f6f202620 626172000000abcd]"
                            //          ^^ command code              ^^^^ CRC
                            //            ^^ string length
                            //              ^^^^^^^^^^^^^^^^^^^ foo &amp; bar

device.send(buf);           // send command to device</code></pre>
<div id="admonition-what-if-i-need-utf-8" class="admonition admonish-question small" role="note" aria-labelledby="admonition-what-if-i-need-utf-8-title">
<div class="admonition-title">
<div id="admonition-what-if-i-need-utf-8-title">
<p>What if I need UTF-8?</p>
</div>
<a class="admonition-anchor-link" href="ref/blobs.html#admonition-what-if-i-need-utf-8"></a>
</div>
<div>
<p>The <code>write_utf8</code> function writes a string in UTF-8 encoding.</p>
<p>UTF-8, however, is not very common for embedded applications.</p>
</div>
</div>
<h2 id="built-in-functions-9"><a class="header" href="#built-in-functions-9">Built-in Functions</a></h2>
<p>The following functions operate on BLOB’s.</p>
<div class="table-wrapper"><table><thead><tr><th>Functions</th><th>Parameter(s)</th><th>Description</th></tr></thead><tbody>
<tr><td><code>blob</code> constructor function</td><td><ol><li><em>(optional)</em> initial length of the BLOB</li><li><em>(optional)</em> initial byte value</li></ol></td><td>creates a new BLOB, optionally of a particular length filled with an initial byte value (default = 0)</td></tr>
<tr><td><code>to_array</code></td><td><em>none</em></td><td>converts the BLOB into an <a href="ref/arrays.html">array</a> of integers</td></tr>
<tr><td><code>as_string</code></td><td><em>none</em></td><td>converts the BLOB into a <a href="ref/strings-chars.html">string</a> (the byte stream is interpreted as UTF-8)</td></tr>
<tr><td><code>get</code></td><td>position, counting from end if &lt; 0</td><td>gets a copy of the byte at a certain position (0 if the position is not valid)</td></tr>
<tr><td><code>set</code></td><td><ol><li>position, counting from end if &lt; 0</li><li>new byte value</li></ol></td><td>sets a certain position to a new value (no effect if the position is not valid)</td></tr>
<tr><td><code>push</code>, <code>append</code>, <code>+=</code> operator</td><td><ol><li>BLOB</li><li>byte to append</li></ol></td><td>appends a byte to the end</td></tr>
<tr><td><code>append</code>, <code>+=</code> operator</td><td><ol><li>BLOB</li><li>BLOB to append</li></ol></td><td>concatenates the second BLOB to the end of the first</td></tr>
<tr><td><code>append</code>, <code>+=</code> operator</td><td><ol><li>BLOB</li><li><a href="ref/strings-chars.html">string/character</a> to append</li></ol></td><td>concatenates a <a href="ref/strings-chars.html">string/character</a> (as UTF-8 encoded byte-stream) to the end of the BLOB</td></tr>
<tr><td><code>+</code> operator</td><td><ol><li>first BLOB</li><li><a href="ref/strings-chars.html">string</a> to append</li></ol></td><td>creates a new <a href="ref/strings-chars.html">string</a> by concatenating the BLOB (as UTF-8 encoded byte-stream) with the the <a href="ref/strings-chars.html">string</a></td></tr>
<tr><td><code>+</code> operator</td><td><ol><li><a href="ref/strings-chars.html">string</a></li><li>BLOB to append</li></ol></td><td>creates a new <a href="ref/strings-chars.html">string</a> by concatenating the BLOB (as UTF-8 encoded byte-stream) to the end of the <a href="ref/strings-chars.html">string</a></td></tr>
<tr><td><code>+</code> operator</td><td><ol><li>first BLOB</li><li>second BLOB</li></ol></td><td>concatenates the first BLOB with the second</td></tr>
<tr><td><code>==</code> operator</td><td><ol><li>first BLOB</li><li>second BLOB</li></ol></td><td>are two BLOB’s the same?</td></tr>
<tr><td><code>!=</code> operator</td><td><ol><li>first BLOB</li><li>second BLOB</li></ol></td><td>are two BLOB’s different?</td></tr>
<tr><td><code>insert</code></td><td><ol><li>position, counting from end if &lt; 0, end if ≥ length</li><li>byte to insert</li></ol></td><td>inserts a byte at a certain position</td></tr>
<tr><td><code>pop</code></td><td><em>none</em></td><td>removes the last byte and returns it (0 if empty)</td></tr>
<tr><td><code>shift</code></td><td><em>none</em></td><td>removes the first byte and returns it (0 if empty)</td></tr>
<tr><td><code>extract</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li><em>(optional)</em> number of bytes to extract, none if ≤ 0</li></ol></td><td>extracts a portion of the BLOB into a new BLOB</td></tr>
<tr><td><code>extract</code></td><td><a href="ref/ranges.html">range</a> of bytes to extract, from beginning if ≤ 0, to end if ≥ length</td><td>extracts a portion of the BLOB into a new BLOB</td></tr>
<tr><td><code>remove</code></td><td>position, counting from end if &lt; 0</td><td>removes a byte at a particular position and returns it (0 if the position is not valid)</td></tr>
<tr><td><code>reverse</code></td><td><em>none</em></td><td>reverses the BLOB byte by byte</td></tr>
<tr><td><code>len</code> method and property</td><td><em>none</em></td><td>returns the number of bytes in the BLOB</td></tr>
<tr><td><code>is_empty</code> method and property</td><td><em>none</em></td><td>returns <code>true</code> if the BLOB is empty</td></tr>
<tr><td><code>pad</code></td><td><ol><li>target length</li><li>byte value to pad</li></ol></td><td>pads the BLOB with a byte value to at least a specified length</td></tr>
<tr><td><code>clear</code></td><td><em>none</em></td><td>empties the BLOB</td></tr>
<tr><td><code>truncate</code></td><td>target length</td><td>cuts off the BLOB at exactly a specified length (discarding all subsequent bytes)</td></tr>
<tr><td><code>chop</code></td><td>target length</td><td>cuts off the head of the BLOB, leaving the tail at exactly a specified length</td></tr>
<tr><td><code>contains</code>, <code>in</code> operator</td><td>byte value to find</td><td>does the BLOB contain a particular byte value?</td></tr>
<tr><td><code>split</code></td><td><ol><li>BLOB</li><li>position to split at, counting from end if &lt; 0, end if ≥ length</li></ol></td><td>splits the BLOB into two BLOB’s, starting from a specified position</td></tr>
<tr><td><code>drain</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of bytes to remove, none if ≤ 0</li></ol></td><td>removes a portion of the BLOB, returning the removed bytes as a new BLOB</td></tr>
<tr><td><code>drain</code></td><td><a href="ref/ranges.html">range</a> of bytes to remove, from beginning if ≤ 0, to end if ≥ length</td><td>removes a portion of the BLOB, returning the removed bytes as a new BLOB</td></tr>
<tr><td><code>retain</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of bytes to retain, none if ≤ 0</li></ol></td><td>retains a portion of the BLOB, removes all other bytes and returning them as a new BLOB</td></tr>
<tr><td><code>retain</code></td><td><a href="ref/ranges.html">range</a> of bytes to retain, from beginning if ≤ 0, to end if ≥ length</td><td>retains a portion of the BLOB, removes all other bytes and returning them as a new BLOB</td></tr>
<tr><td><code>splice</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of bytes to remove, none if ≤ 0</li><li>BLOB to insert</li></ol></td><td>replaces a portion of the BLOB with another (not necessarily of the same length as the replaced portion)</td></tr>
<tr><td><code>splice</code></td><td><ol><li><a href="ref/ranges.html">range</a> of bytes to remove, from beginning if ≤ 0, to end if ≥ length</li><li>BLOB to insert</td><td>replaces a portion of the BLOB with another (not necessarily of the same length as the replaced portion)</td></tr>
<tr><td><code>parse_le_int</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of bytes to parse, 8 if &gt; 8 (4 under 32-bit), none if ≤ 0</li></ol></td><td>parses an integer at the particular offset in little-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>parse_le_int</code></td><td><a href="ref/ranges.html">range</a> of bytes to parse, from beginning if ≤ 0, to end if ≥ length (up to 8 bytes, 4 under 32-bit)</td><td>parses an integer at the particular offset in little-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>parse_be_int</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of bytes to parse, 8 if &gt; 8 (4 under 32-bit), none if ≤ 0</li></ol></td><td>parses an integer at the particular offset in big-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>parse_be_int</code></td><td><a href="ref/ranges.html">range</a> of bytes to parse, from beginning if ≤ 0, to end if ≥ length (up to 8 bytes, 4 under 32-bit)</td><td>parses an integer at the particular offset in big-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>parse_le_float</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of bytes to parse, 8 if &gt; 8 (4 under 32-bit), none if ≤ 0</li></ol></td><td>parses a floating-point number at the particular offset in little-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>parse_le_float</code></td><td><a href="ref/ranges.html">range</a> of bytes to parse, from beginning if ≤ 0, to end if ≥ length (up to 8 bytes, 4 under 32-bit)</td><td>parses a floating-point number at the particular offset in little-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>parse_be_float</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of bytes to parse, 8 if &gt; 8 (4 under 32-bit), none if ≤ 0</li></ol></td><td>parses a floating-point number at the particular offset in big-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>parse_be_float</code></td><td><a href="ref/ranges.html">range</a> of bytes to parse, from beginning if ≤ 0, to end if ≥ length (up to 8 bytes, 4 under 32-bit)</td><td>parses a floating-point number at the particular offset in big-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>write_le</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of bytes to write, 8 if &gt; 8 (4 under 32-bit), none if ≤ 0</li><li>integer or floating-point value</li></ol></td><td>writes a value at the particular offset in little-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>write_le</code></td><td><ol><li><a href="ref/ranges.html">range</a> of bytes to write, from beginning if ≤ 0, to end if ≥ length (up to 8 bytes, 4 under 32-bit)</li><li>integer or floating-point value</li></ol></td><td>writes a value at the particular offset in little-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>write_be</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of bytes to write, 8 if &gt; 8 (4 under 32-bit), none if ≤ 0</li><li>integer or floating-point value</li></ol></td><td>writes a value at the particular offset in big-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>write_be</code></td><td><ol><li><a href="ref/ranges.html">range</a> of bytes to write, from beginning if ≤ 0, to end if ≥ length (up to 8 bytes, 4 under 32-bit)</li><li>integer or floating-point value</li></ol></td><td>writes a value at the particular offset in big-endian byte order (if not enough bytes, zeros are padded; extra bytes are ignored)</td></tr>
<tr><td><code>write_utf8</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of bytes to write, none if ≤ 0, to end if ≥ length</li><li><a href="ref/strings-chars.html">string</a> to write</li></ol></td><td>writes a <a href="ref/strings-chars.html">string</a> to the particular offset in UTF-8 encoding</td></tr>
<tr><td><code>write_utf8</code></td><td><ol><li><a href="ref/ranges.html">range</a> of bytes to write, from beginning if ≤ 0, to end if ≥ length, to end if ≥ length</li><li><a href="ref/strings-chars.html">string</a> to write</li></ol></td><td>writes a <a href="ref/strings-chars.html">string</a> to the particular offset in UTF-8 encoding</td></tr>
<tr><td><code>write_ascii</code></td><td><ol><li>start position, counting from end if &lt; 0, end if ≥ length</li><li>number of <a href="ref/strings-chars.html">characters</a> to write, none if ≤ 0, to end if ≥ length</li><li><a href="ref/strings-chars.html">string</a> to write</li></ol></td><td>writes a <a href="ref/strings-chars.html">string</a> to the particular offset in 7-bit ASCII encoding (non-ASCII <a href="ref/strings-chars.html">characters</a> are skipped)</td></tr>
<tr><td><code>write_ascii</code></td><td><ol><li><a href="ref/ranges.html">range</a> of bytes to write, from beginning if ≤ 0, to end if ≥ length, to end if ≥ length</li><li><a href="ref/strings-chars.html">string</a> to write</li></ol></td><td>writes a <a href="ref/strings-chars.html">string</a> to the particular offset in 7-bit ASCII encoding (non-ASCII <a href="ref/strings-chars.html">characters</a> are skipped)</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="object-maps-1"><a class="header" href="#object-maps-1">Object Maps</a></h1>
<p>Object maps are hash dictionaries. Properties are all dynamic values and can be freely added and retrieved.</p>
<p><a href="ref/type-of.html"><code>type_of()</code></a> an object map returns <code>"map"</code>.</p>
<div id="admonition-tip-object-maps-are-_fast_" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-object-maps-are-_fast_-title">
<div class="admonition-title">
<div id="admonition-tip-object-maps-are-_fast_-title">
<p>Tip: Object maps are <em>FAST</em></p>
</div>
<a class="admonition-anchor-link" href="ref/object-maps.html#admonition-tip-object-maps-are-_fast_"></a>
</div>
<div>
<p>Normally, when <a href="ref/getters-setters.html">properties</a> are accessed, copies of the data values are made.
This is normally slow.</p>
<p>Object maps have special treatment – properties are accessed via <em>references</em>, meaning that
no copies of data values are made.</p>
<p>This makes object map access fast, especially when deep within a properties chain.</p>
<pre><code class="language-rust">// 'obj' is a normal custom type
let x = obj.a.b.c.d;

// The above is equivalent to:
let a_value = obj.a;        // temp copy of 'a'
let b_value = a_value.b;    // temp copy of 'b'
let c_value = b_value.c;    // temp copy of 'c'
let d_value = c_value.d;    // temp copy of 'd'
let x = d_value;

// 'map' is an object map
let x = map.a.b.c.d;        // direct access to 'd'
                            // 'a', 'b' and 'c' are not copied

map.a.b.c.d = 42;           // directly modifies 'd' in 'a', 'b' and 'c'
                            // no copy of any property value is made

map.a.b.c.d.calc();         // directly calls 'calc' on 'd'
                            // no copy of any property value is made</code></pre>
</div>
</div>
<h2 id="literal-syntax-3"><a class="header" href="#literal-syntax-3">Literal Syntax</a></h2>
<p>Object map literals are built within braces <code>#{</code> … <code>}</code> with <em>name</em><code>:</code><em>value</em> pairs separated by
commas <code>,</code>:</p>
<blockquote>
<p><code>#{</code> <em>property</em> <code>:</code> <em>value</em><code>,</code> … <code>,</code> <em>property</em> <code>:</code> <em>value</em> <code>}</code></p>
<p><code>#{</code> <em>property</em> <code>:</code> <em>value</em><code>,</code> … <code>,</code> <em>property</em> <code>:</code> <em>value</em> <code>,</code> <code>}</code>     <code>// trailing comma is OK</code></p>
</blockquote>
<p>The property <em>name</em> can be a simple identifier following the same naming rules as
<a href="ref/variables.html">variables</a>, or a <a href="ref/../appendix/literals.html">string literal</a> without interpolation.</p>
<h2 id="property-access-syntax-1"><a class="header" href="#property-access-syntax-1">Property Access Syntax</a></h2>
<h3 id="dot-notation-1"><a class="header" href="#dot-notation-1">Dot notation</a></h3>
<p>The <em>dot notation</em> allows only property names that follow the same naming rules as
<a href="ref/variables.html">variables</a>.</p>
<blockquote>
<p><em>object</em> <code>.</code> <em>property</em></p>
</blockquote>
<h3 id="elvis-notation-1"><a class="header" href="#elvis-notation-1">Elvis notation</a></h3>
<p>The <a href="https://en.wikipedia.org/wiki/Elvis_operator"><em>Elvis notation</em></a> is similar to the <em>dot
notation</em> except that it returns <code>()</code> if the object itself is <code>()</code>.</p>
<blockquote>
<p><code>// returns () if object is ()</code><br />
<em>object</em> <code>?.</code> <em>property</em></p>
<p><code>// no action if object is ()</code><br />
<em>object</em> <code>?.</code> <em>property</em> <code>=</code> <em>value</em> <code>;</code></p>
</blockquote>
<h3 id="index-notation-1"><a class="header" href="#index-notation-1">Index notation</a></h3>
<p>The <em>index notation</em> allows setting/getting properties of arbitrary names (even the empty
<a href="ref/strings-chars.html">string</a>).</p>
<blockquote>
<p><em>object</em> <code>[</code> <em>property</em> <code>]</code></p>
</blockquote>
<h2 id="handle-non-existent-properties-1"><a class="header" href="#handle-non-existent-properties-1">Handle Non-Existent Properties</a></h2>
<p>Trying to read a non-existent property returns <code>()</code> instead of causing an error.</p>
<p>This is similar to JavaScript where accessing a non-existent property returns <code>undefined</code>.</p>
<pre><code class="language-rust">let map = #{ foo: 42 };

// Regular property access
let x = map.foo;            // x == 42

// Non-existent property
let x = map.bar;            // x == ()</code></pre>
<h3 id="check-for-property-existence-1"><a class="header" href="#check-for-property-existence-1">Check for property existence</a></h3>
<p>Use the <a href="ref/operators.html#in-operator"><code>in</code></a> operator to check whether a property exists in an object-map.</p>
<pre><code class="language-rust">let map = #{ foo: 42 };

"foo" in map == true;

"bar" in map == false;</code></pre>
<h3 id="short-circuit-non-existent-property-access-1"><a class="header" href="#short-circuit-non-existent-property-access-1">Short-circuit non-existent property access</a></h3>
<p>Use the <a href="https://en.wikipedia.org/wiki/Elvis_operator"><em>Elvis operator</em></a> (<code>?.</code>) to short-circuit
further processing if the object is <code>()</code>.</p>
<pre><code class="language-rust">x.a.b.foo();        // &lt;- error if 'x', 'x.a' or 'x.a.b' is ()

x.a.b = 42;         // &lt;- error if 'x' or 'x.a' is ()

x?.a?.b?.foo();     // &lt;- ok! returns () if 'x', 'x.a' or 'x.a.b' is ()

x?.a?.b = 42;       // &lt;- ok even if 'x' or 'x.a' is ()</code></pre>
<h3 id="default-property-value-1"><a class="header" href="#default-property-value-1">Default property value</a></h3>
<p>Using the <a href="ref/operators.html#null-coalescing-operator">null-coalescing operator</a> to give non-existent
properties default values.</p>
<pre><code class="language-rust">let map = #{ foo: 42 };

// Regular property access
let x = map.foo;            // x == 42

// Non-existent property
let x = map.bar;            // x == ()

// Default value for property
let x = map.bar ?? 42;      // x == 42</code></pre>
<h2 id="built-in-functions-10"><a class="header" href="#built-in-functions-10">Built-in Functions</a></h2>
<p>The following methods operate on object maps.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Parameter(s)</th><th>Description</th></tr></thead><tbody>
<tr><td><code>get</code></td><td>property name</td><td>gets a copy of the value of a certain property (<code>()</code> if the property does not exist)</td></tr>
<tr><td><code>set</code></td><td><ol><li>property name</li><li>new element</li></ol></td><td>sets a certain property to a new value (property is added if not already exists)</td></tr>
<tr><td><code>len</code></td><td><em>none</em></td><td>returns the number of properties</td></tr>
<tr><td><code>is_empty</code></td><td><em>none</em></td><td>returns <code>true</code> if the object map is empty</td></tr>
<tr><td><code>clear</code></td><td><em>none</em></td><td>empties the object map</td></tr>
<tr><td><code>remove</code></td><td>property name</td><td>removes a certain property and returns it (<code>()</code> if the property does not exist)</td></tr>
<tr><td><code>+=</code> operator, <code>mixin</code></td><td>second object map</td><td>mixes in all the properties of the second object map to the first (values of properties with the same names replace the existing values)</td></tr>
<tr><td><code>+</code> operator</td><td><ol><li>first object map</li><li>second object map</li></ol></td><td>merges the first object map with the second</td></tr>
<tr><td><code>==</code> operator</td><td><ol><li>first object map</li><li>second object map</li></ol></td><td>are the two object maps the same (elements compared with the <code>==</code> operator, if defined)?</td></tr>
<tr><td><code>!=</code> operator</td><td><ol><li>first object map</li><li>second object map</li></ol></td><td>are the two object maps different (elements compared with the <code>==</code> operator, if defined)?</td></tr>
<tr><td><code>fill_with</code></td><td>second object map</td><td>adds in all properties of the second object map that do not exist in the object map</td></tr>
<tr><td><code>contains</code>, <code>in</code> operator</td><td>property name</td><td>does the object map contain a property of a particular name?</td></tr>
<tr><td><code>drain</code></td><td><a href="ref/fn-ptr.html">function pointer</a> to predicate (usually a <a href="ref/fn-closure.html">closure</a>)</td><td>removes all elements (returning them) that return <code>true</code> when called with the predicate function taking the following parameters:<ol><li>key</li><li><em>(optional)</em> object map element (if omitted, the object map element is bound to <code>this</code>)</li></ol></td></tr>
<tr><td><code>retain</code></td><td><a href="ref/fn-ptr.html">function pointer</a> to predicate (usually a <a href="ref/fn-closure.html">closure</a>)</td><td>removes all elements (returning them) that do not return <code>true</code> when called with the predicate function taking the following parameters:<ol><li>key</li><li><em>(optional)</em> object map element (if omitted, the object map element is bound to <code>this</code>)</li></ol></td></tr>
<tr><td><code>filter</code></td><td><a href="ref/fn-ptr.html">function pointer</a> to predicate (usually a <a href="ref/fn-closure.html">closure</a>)</td><td>constructs a object map with all elements that return <code>true</code> when called with the predicate function taking the following parameters:<ol><li>key</li><li><em>(optional)</em> object map element (if omitted, the object map element is bound to <code>this</code>)</li></ol></td></tr>
<tr><td><code>keys</code></td><td><em>none</em></td><td>returns an <a href="ref/arrays.html">array</a> of all the property names (in random order)</td></tr>
<tr><td><code>values</code></td><td><em>none</em></td><td>returns an <a href="ref/arrays.html">array</a> of all the property values (in random order)</td></tr>
<tr><td><code>to_json</code></td><td><em>none</em></td><td>returns a JSON representation of the object map (<code>()</code> is mapped to <code>null</code>, all other data types must be supported by JSON)</td></tr>
</tbody></table>
</div>
<h2 id="examples-24"><a class="header" href="#examples-24">Examples</a></h2>
<pre><code class="language-rust">let y = #{              // object map literal with 3 properties
    a: 1,
    bar: "hello",
    "baz!$@": 123.456,  // like JavaScript, you can use any string as property names...
    "": false,          // even the empty string!

    `hello`: 999,       // literal strings are also OK

    a: 42,              // &lt;- syntax error: duplicated property name

    `a${2}`: 42,        // &lt;- syntax error: property name cannot have string interpolation
};

y.a = 42;               // access via dot notation
y.a == 42;

y.baz!$@ = 42;          // &lt;- syntax error: only proper variable names allowed in dot notation
y."baz!$@" = 42;        // &lt;- syntax error: strings not allowed in dot notation
y["baz!$@"] = 42;       // access via index notation is OK

"baz!$@" in y == true;  // use 'in' to test if a property exists in the object map
("z" in y) == false;

ts.obj = y;             // object maps can be assigned completely (by value copy)
let foo = ts.list.a;
foo == 42;

let foo = #{ a:1, };    // trailing comma is OK

let foo = #{ a:1, b:2, c:3 }["a"];
let foo = #{ a:1, b:2, c:3 }.a;
foo == 1;

fn abc() {
<span class="boring">    { a:1, b:2, c:3 }  // a function returning an object map
</span>}

let foo = abc().b;
foo == 2;

let foo = y["a"];
foo == 42;

y.contains("a") == true;
y.contains("xyz") == false;

y.xyz == ();            // a non-existent property returns '()'
y["xyz"] == ();

y.len == ();            // an object map has no property getter function
y.len() == 3;           // method calls are OK

y.remove("a") == 1;     // remove property

y.len() == 2;
y.contains("a") == false;

for name in y.keys() {  // get an array of all the property names via 'keys'
    print(name);
}

for val in y.values() { // get an array of all the property values via 'values'
    print(val);
}

y.clear();              // empty the object map

y.len() == 0;</code></pre>
<h2 id="special-support-for-oop"><a class="header" href="#special-support-for-oop">Special Support for OOP</a></h2>
<p>Object maps can be used to simulate object-oriented programming (OOP) by storing data as properties
and methods as properties holding <a href="ref/fn-ptr.html">function pointers</a>.</p>
<p>If an object map’s property holds a <a href="ref/fn-ptr.html">function pointer</a>, the property can simply be called
like a normal method in method-call syntax.</p>
<p>This is a <em>short-hand</em> to avoid the more verbose syntax of using the <code>call</code> function keyword.</p>
<p>When a property holding a <a href="ref/fn-ptr.html">function pointer</a> or a <a href="ref/fn-closure.html">closure</a> is called like
a method, it is replaced as a method call on the object map itself.</p>
<pre><code class="language-rust">let obj = #{
                data: 40,
                action: || this.data += x    // 'action' holds a closure
           };

obj.action(2);                               // calls the function pointer with 'this' bound to 'obj'

obj.call(obj.action, 2);                     // &lt;- the above de-sugars to this

obj.data == 42;

// To achieve the above with normal function pointer call will fail.

fn do_action(map, x) { map.data += x; }      // 'map' is a copy

obj.action = do_action;                      // &lt;- de-sugars to 'Fn("do_action")'

obj.action.call(obj, 2);                     // a copy of 'obj' is passed by value

obj.data == 42;                              // 'obj.data' is not changed</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="timestamps-1"><a class="header" href="#timestamps-1">Timestamps</a></h1>
<p>Timestamps are provided by the via the <code>timestamp</code> function.</p>
<p><a href="ref/type-of.html"><code>type_of()</code></a> a timestamp returns <code>"timestamp"</code>.</p>
<h2 id="built-in-functions-11"><a class="header" href="#built-in-functions-11">Built-in Functions</a></h2>
<p>The following methods operate on timestamps.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Parameter(s)</th><th>Description</th></tr></thead><tbody>
<tr><td><code>elapsed</code> method and property</td><td><em>none</em></td><td>returns the number of seconds since the timestamp</td></tr>
<tr><td><code>+</code> operator</td><td>number of seconds to add</td><td>returns a new timestamp with a specified number of seconds added</td></tr>
<tr><td><code>+=</code> operator</td><td>number of seconds to add</td><td>adds a specified number of seconds to the timestamp</td></tr>
<tr><td><code>-</code> operator</td><td>number of seconds to subtract</td><td>returns a new timestamp with a specified number of seconds subtracted</td></tr>
<tr><td><code>-=</code> operator</td><td>number of seconds to subtract</td><td>subtracts a specified number of seconds from the timestamp</td></tr>
<tr><td><code>-</code> operator</td><td><ol><li>later timestamp</li><li>earlier timestamp</li></ol></td><td>returns the number of seconds between the two timestamps</td></tr>
</tbody></table>
</div>
<p>The following time-related functions are also available.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Parameter(s)</th><th>Description</th></tr></thead><tbody>
<tr><td><code>sleep</code></td><td>number of seconds to sleep</td><td>blocks the current thread for a specified number of seconds</td></tr>
</tbody></table>
</div>
<h2 id="examples-25"><a class="header" href="#examples-25">Examples</a></h2>
<pre><code class="language-rust">let now = timestamp();

// Do some lengthy operation...

if now.elapsed &gt; 30.0 {
    print("takes too long (over 30 seconds)!")
}</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="keywords-1"><a class="header" href="#keywords-1">Keywords</a></h1>
<p>The following are reserved keywords in Rhai.</p>
<div class="table-wrapper"><table><thead><tr><th>Active keywords</th><th>Reserved keywords</th><th>Usage</th></tr></thead><tbody>
<tr><td><code>true</code>, <code>false</code></td><td></td><td>constants</td></tr>
<tr><td><a href="ref/variable.html"><code>let</code></a>, <a href="ref/constant.html"><code>const</code></a></td><td><code>var</code>, <code>static</code></td><td>variables</td></tr>
<tr><td><code>is_shared</code></td><td></td><td><em>shared</em> values</td></tr>
<tr><td></td><td><code>is</code></td><td>type checking</td></tr>
<tr><td><a href="ref/if.html"><code>if</code></a>, <a href="ref/if.html"><code>else</code></a></td><td><code>goto</code></td><td>control flow</td></tr>
<tr><td><a href="ref/switch.html"><code>switch</code></a></td><td><code>match</code>, <code>case</code></td><td>switching and matching</td></tr>
<tr><td><a href="ref/do.html"><code>do</code></a>, <a href="ref/while.html"><code>while</code></a>, <a href="ref/loop.html"><code>loop</code></a>, <code>until</code>, <a href="ref/for.html"><code>for</code></a>, <a href="ref/operators.html"><code>in</code></a>, <code>continue</code>, <code>break</code></td><td></td><td>looping</td></tr>
<tr><td><a href="ref/functions.html"><code>fn</code></a>, <a href="ref/modules/export.html"><code>private</code></a>, <code>is_def_fn</code>, <code>this</code></td><td><code>public</code>, <code>protected</code>, <code>new</code></td><td><a href="ref/functions.html">functions</a></td></tr>
<tr><td><a href="ref/return.html"><code>return</code></a></td><td></td><td>return values</td></tr>
<tr><td><a href="ref/throw.html"><code>throw</code></a>, <a href="ref/try-catch.html"><code>try</code></a>, <a href="ref/try-catch.html"><code>catch</code></a></td><td></td><td><a href="ref/try-catch.html">throw/catch</a> exceptions</td></tr>
<tr><td><a href="ref/modules/import.html"><code>import</code></a>, <a href="ref/modules/export.html"><code>export</code></a>, <code>as</code></td><td><code>use</code>, <code>with</code>, <code>module</code>, <code>package</code>, <code>super</code></td><td><a href="ref/modules/index.html">modules</a></td></tr>
<tr><td><a href="ref/global.html"><code>global</code></a></td><td></td><td>automatic global <a href="ref/modules/index.html">module</a></td></tr>
<tr><td><a href="ref/fn-ptr.html"><code>Fn</code></a>, <code>call</code>, <a href="ref/fn-curry.html"><code>curry</code></a></td><td></td><td><a href="ref/fn-ptr.html">function pointers</a></td></tr>
<tr><td></td><td><code>spawn</code>, <code>thread</code>, <code>go</code>, <code>sync</code>, <code>async</code>, <code>await</code>, <code>yield</code></td><td>threading/async</td></tr>
<tr><td><a href="ref/type-of.html"><code>type_of</code></a>, <a href="ref/print-debug.html"><code>print</code></a>, <a href="ref/print-debug.html"><code>debug</code></a>, <a href="ref/eval.html"><code>eval</code></a>, <code>is_def_var</code></td><td></td><td>special functions</td></tr>
<tr><td></td><td><code>default</code>, <code>void</code>, <code>null</code>, <code>nil</code></td><td>special values</td></tr>
</tbody></table>
</div><div id="admonition-warning" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="ref/keywords.html#admonition-warning"></a>
</div>
<div>
<p>Keywords cannot become the name of a function or variable, even when they are disabled.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="statements-1"><a class="header" href="#statements-1">Statements</a></h1>
<p>Statements are terminated by semicolons <code>;</code> and they are mandatory, except for the <em>last</em> statement
in a <em>block</em> (enclosed by <code>{</code> … <code>}</code> pairs) where it can be omitted.</p>
<p>Semicolons can also be omitted for statement types that always end in a block – for example
the <a href="ref/if.html"><code>if</code></a>, <a href="ref/while.html"><code>while</code></a>, <a href="ref/for.html"><code>for</code></a>,  <a href="ref/loop.html"><code>loop</code></a> and
<a href="ref/switch.html"><code>switch</code></a> statements.</p>
<pre><code class="language-rust">let a = 42;             // normal assignment statement
let a = foo(42);        // normal function call statement
foo &lt; 42;               // normal expression as statement

let a = { 40 + 2 };     // 'a' is set to the value of the statements block, which is the value of the last statement
//              ^ the last statement does not require a terminating semicolon (but also works with it)
//                ^ semicolon required here to terminate the 'let' statement
//                  it is a syntax error without it, even though it ends with '}'
//                  that is because the 'let' statement doesn't end in a block

if foo { a = 42 }
//               ^ no need to terminate an if-statement with a semicolon
//                 that is because the 'if' statement ends in a block

4 * 10 + 2              // a statement which is just one expression - no ending semicolon is OK
                        // because it is the last statement of the whole block</code></pre>
<h2 id="statements-block-1"><a class="header" href="#statements-block-1">Statements Block</a></h2>
<h3 id="syntax-6"><a class="header" href="#syntax-6">Syntax</a></h3>
<p>Statements blocks in Rhai are formed by enclosing zero or more statements within braces <code>{</code>…<code>}</code>.</p>
<blockquote>
<p><code>{</code> <em>statement</em><code>;</code> <em>statement</em><code>;</code> … <em>statement</em> <code>}</code></p>
<p><code>{</code> <em>statement</em><code>;</code> <em>statement</em><code>;</code> … <em>statement</em><code>;</code> <code>}</code>      <code>// trailing semi-colon is optional</code></p>
</blockquote>
<h3 id="closed-scope-1"><a class="header" href="#closed-scope-1">Closed scope</a></h3>
<p>A statements block forms a <em>closed</em> scope.</p>
<p>Any <a href="ref/variable.html">variable</a> and/or <a href="ref/constant.html">constant</a> defined within the block are removed
outside the block, so are <a href="ref/modules/index.html">modules</a> <a href="ref/modules/import.html">imported</a> within the block.</p>
<pre><code class="language-rust">let x = 42;
let y = 18;

{
    import "hello" as h;
    const HELLO = 99;
    let y = 0;

    h::greet();         // ok

    print(y + HELLO);   // prints 99 (y is zero)

        :    
        :    
}                       // &lt;- 'HELLO' and 'y' go away here...

print(x + y);           // prints 60 (y is still 18)

print(HELLO);           // &lt;- error: 'HELLO' not found

h::greet();             // &lt;- error: module 'h' not found</code></pre>
<h1 id="statement-expression-1"><a class="header" href="#statement-expression-1">Statement Expression</a></h1>
<p>A statement can be used anywhere where an <em>expression</em> is expected.</p>
<p>These are called, for lack of a more creative name, “statement expressions.”</p>
<p>The <em>last</em> statement of a statements block is <em>always</em> the block’s return value when used as a statement,
<em>regardless</em> of whether it is terminated by a semicolon or not.</p>
<p>If the last statement has no return value (e.g. variable definitions, assignments) then it is
assumed to be <code>()</code>.</p>
<pre><code class="language-rust">let x = {
    let foo = calc_something();
    let bar = foo + baz;
    bar.further_processing();       // &lt;- this is the return value
};                                  // &lt;- semicolon is needed here...

// The above is equivalent to:
let result;
{
    let foo = calc_something();
    let bar = foo + baz;
    result = bar.further_processing();
}
let x = result;

// Statement expressions can be inserted inside normal expressions
// to avoid duplicated calculations
let x = foo(bar) + { let v = calc(); process(v, v.len, v.abs) } + baz;

// The above is equivalent to:
let foo_result = foo(bar);
let calc_result;
{
    let v = calc();
    result = process(v, v.len, v.abs);  // &lt;- avoid calculating 'v'
}
let x = foo_result + calc_result + baz;

// Statement expressions are also useful as function call arguments
// when side effects are desired
do_work(x, y, { let z = foo(x, y); print(z); z });
           // ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
           //       statement expression</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="variables-1"><a class="header" href="#variables-1">Variables</a></h1>
<h2 id="valid-names-1"><a class="header" href="#valid-names-1">Valid Names</a></h2>
<p>Variables in Rhai follow normal C naming rules – must contain only ASCII letters, digits and underscores <code>_</code>.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Character set</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>A</code> … <code>Z</code></td><td>Upper-case ASCII letters</td></tr>
<tr><td style="text-align: center"><code>a</code> … <code>z</code></td><td>Lower-case ASCII letters</td></tr>
<tr><td style="text-align: center"><code>0</code> … <code>9</code></td><td>Digit characters</td></tr>
<tr><td style="text-align: center"><code>_</code></td><td>Underscore character</td></tr>
</tbody></table>
</div>
<p>However, a variable name must also contain at least one ASCII letter, and an ASCII
letter must come <em>before</em> any digits. In other words, the first character that is not an underscore <code>_</code>
must be an ASCII letter and not a digit.</p>
<div id="admonition-why-this-restriction" class="admonition admonish-question side wide" role="note" aria-labelledby="admonition-why-this-restriction-title">
<div class="admonition-title">
<div id="admonition-why-this-restriction-title">
<p>Why this restriction?</p>
</div>
<a class="admonition-anchor-link" href="ref/variables.html#admonition-why-this-restriction"></a>
</div>
<div>
<p>To reduce confusion (and subtle bugs) because, for instance, <code>_1</code> can easily be misread (or mistyped)
as <code>-1</code>.</p>
<p>Rhai is dynamic without type checking, so there is no compiler to catch these typos.</p>
</div>
</div>
<p>Therefore, some names, e.g. <code>_</code>, <code>_42foo</code>, <code>_1</code> etc., are not valid in Rhai.</p>
<p>For example: <code>c3po</code> and <code>_r2d2_</code> are valid variable names, but <code>3abc</code> and <code>____49steps</code> are not.</p>
<p>Variable names are case <em>sensitive</em>.</p>
<p>Variable names also cannot be the same as a <a href="ref/keywords.html">keyword</a> (active or reserved).</p>
<div id="admonition-avoid-names-longer-than-11-letters-on-32-bit" class="admonition admonish-warning" role="note" aria-labelledby="admonition-avoid-names-longer-than-11-letters-on-32-bit-title">
<div class="admonition-title">
<div id="admonition-avoid-names-longer-than-11-letters-on-32-bit-title">
<p>Avoid names longer than 11 letters on 32-Bit</p>
</div>
<a class="admonition-anchor-link" href="ref/variables.html#admonition-avoid-names-longer-than-11-letters-on-32-bit"></a>
</div>
<div>
<p>Rhai <em>inlines</em> a string, which avoids allocations unless it is over its internal limit
(23 ASCII characters on 64-bit, but only 11 ASCII characters on 32-bit).</p>
<p>On 64-bit systems, <em>most</em> variable names are shorter than 23 letters, so this is unlikely to become
an issue.</p>
<p>However, on 32-bit systems, take care to limit, where possible, variable names to within 11 letters.
This is particularly true for local variables inside a hot loop, where they are created and
destroyed in rapid succession.</p>
<pre><code class="language-js">// The following is SLOW on 32-bit
for my_super_loop_variable in array {
    print(`Super! ${my_super_loop_variable}`);
}

// Suggested revision:
for loop_var in array {
    print(`Super! ${loop_var}`);
}
</code></pre>
</div>
</div>
<h2 id="declare-a-variable-1"><a class="header" href="#declare-a-variable-1">Declare a Variable</a></h2>
<p>Variables are declared using the <code>let</code> keyword.</p>
<div id="admonition-tip-no-initial-value" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-no-initial-value-title">
<div class="admonition-title">
<div id="admonition-tip-no-initial-value-title">
<p>Tip: No initial value</p>
</div>
<a class="admonition-anchor-link" href="ref/variables.html#admonition-tip-no-initial-value"></a>
</div>
<div>
<p>Variables do not have to be given an initial value.
If none is provided, it defaults to <code>()</code>.</p>
</div>
</div>
<div id="admonition-variables-are-local" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-variables-are-local-title">
<div class="admonition-title">
<div id="admonition-variables-are-local-title">
<p>Variables are local</p>
</div>
<a class="admonition-anchor-link" href="ref/variables.html#admonition-variables-are-local"></a>
</div>
<div>
<p>A variable defined within a <a href="ref/statements.html">statements block</a> is <em>local</em> to that block.</p>
</div>
</div>
<div id="admonition-tip-is_def_var" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-is_def_var-title">
<div class="admonition-title">
<div id="admonition-tip-is_def_var-title">
<p>Tip: <code>is_def_var</code></p>
</div>
<a class="admonition-anchor-link" href="ref/variables.html#admonition-tip-is_def_var"></a>
</div>
<div>
<p>Use <code>is_def_var</code> to detect if a variable is defined.</p>
</div>
</div>
<pre><code class="language-rust">let x;              // ok - value is '()'
let x = 3;          // ok
let _x = 42;        // ok
let x_ = 42;        // also ok
let _x_ = 42;       // still ok

let _ = 123;        // &lt;- syntax error: illegal variable name
let _9 = 9;         // &lt;- syntax error: illegal variable name

let x = 42;         // variable is 'x', lower case
let X = 123;        // variable is 'X', upper case

print(x);           // prints 42
print(X);           // prints 123

{
    let x = 999;    // local variable 'x' shadows the 'x' in parent block

    print(x);       // prints 999
}

print(x);           // prints 42 - the parent block's 'x' is not changed

let x = 0;          // new variable 'x' shadows the old 'x'

print(x);           // prints 0

is_def_var("x") == true;

is_def_var("_x") == true;

is_def_var("y") == false;</code></pre>
<h2 id="shadowing"><a class="header" href="#shadowing">Shadowing</a></h2>
<p>New variables automatically <em>shadow</em> existing ones of the same name.  There is no error.</p>
<pre><code class="language-rust">let x = 42;
let y = 123;

print(x);           // prints 42

let x = 88;         // &lt;- 'x' is shadowed here

// At this point, it is no longer possible to access the
// original 'x' on the first line...

print(x);           // prints 88

let x = 0;          // &lt;- 'x' is shadowed again

// At this point, it is no longer possible to access both
// previously-defined 'x'...

print(x);           // prints 0

{
    let x = 999;    // &lt;- 'x' is shadowed in a block
    
    print(x);       // prints 999
}

print(x);           // prints 0 - shadowing within the block goes away

print(y);           // prints 123 - 'y' is not shadowed</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="constants-1"><a class="header" href="#constants-1">Constants</a></h1>
<p>Constants can be defined using the <code>const</code> keyword and are immutable.</p>
<pre><code class="language-rust">const X;            // 'X' is a constant '()'

const X = 40 + 2;   // 'X' is a constant 42

print(X * 2);       // prints 84

X = 123;            // &lt;- syntax error: constant modified</code></pre>
<div id="admonition-tip-naming" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-naming-title">
<div class="admonition-title">
<div id="admonition-tip-naming-title">
<p>Tip: Naming</p>
</div>
<a class="admonition-anchor-link" href="ref/constants.html#admonition-tip-naming"></a>
</div>
<div>
<p>Constants follow the same naming rules as <a href="ref/variables.html">variables</a>,
but as a convention are often named with all-capital letters.</p>
</div>
</div>
<h2 id="automatic-global-module-2"><a class="header" href="#automatic-global-module-2">Automatic Global Module</a></h2>
<p>When a <a href="ref/constants.html">constant</a> is declared at global scope, it is added to a special
<a href="ref/modules/index.html">module</a> called <code>global</code>.</p>
<p><a href="ref/functions.html">Functions</a> can access those <a href="ref/constants.html">constants</a> via the special <code>global</code>
<a href="ref/modules/index.html">module</a>.</p>
<pre><code class="language-rust">const CONSTANT = 42;        // this constant is automatically added to 'global'

{
    const INNER = 0;        // this constant is not at global level
}                           // &lt;- it goes away here

fn foo(x) {
    x *= global::CONSTANT;  // ok! 'CONSTANT' exists in 'global'

    x * global::INNER       // &lt;- error: constant 'INNER' not found in 'global'
}</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="assignments-1"><a class="header" href="#assignments-1">Assignments</a></h1>
<p>Value assignments to <a href="ref/variables.html">variables</a> use the <code>=</code> symbol.</p>
<pre><code class="language-rust">let foo = 42;

bar = 123 * 456 - 789;

x[1][2].prop = do_calculation();</code></pre>
<h2 id="valid-assignment-targets-1"><a class="header" href="#valid-assignment-targets-1">Valid Assignment Targets</a></h2>
<p>The left-hand-side (LHS) of an assignment statement must be a valid
<em><a href="https://en.wikipedia.org/wiki/Value_(computer_science)">l-value</a></em>, which must be rooted in a
<a href="ref/variables.html">variable</a>, potentially extended via indexing or properties.</p>
<div id="admonition-assigning-to-invalid-l-value" class="admonition admonish-bug" role="note" aria-labelledby="admonition-assigning-to-invalid-l-value-title">
<div class="admonition-title">
<div id="admonition-assigning-to-invalid-l-value-title">
<p>Assigning to invalid l-value</p>
</div>
<a class="admonition-anchor-link" href="ref/assignment.html#admonition-assigning-to-invalid-l-value"></a>
</div>
<div>
<p>Expressions that are not valid <em>l-values</em> cannot be assigned to.</p>
<pre><code class="language-rust">x = 42;                 // variable is an l-value

x[1][2][3] = 42         // variable indexing is an l-value

x.prop1.prop2 = 42;     // variable property is an l-value

foo(x) = 42;            // syntax error: function call is not an l-value

x.foo() = 42;           // syntax error: method call is not an l-value

(x + y) = 42;           // syntax error: binary op is not an l-value</code></pre>
</div>
</div>
<h2 id="values-are-cloned-1"><a class="header" href="#values-are-cloned-1">Values are Cloned</a></h2>
<p>Values assigned are always <em>cloned</em>.
So care must be taken when assigning large data types (such as <a href="ref/arrays.html">arrays</a>).</p>
<pre><code class="language-rust">x = y;                  // value of 'y' is cloned

x == y;                 // both 'x' and 'y' hold different copies
                        // of the same value</code></pre>
<h2 id="moving-data-1"><a class="header" href="#moving-data-1">Moving Data</a></h2>
<p>When assigning large data types, sometimes it is desirable to <em>move</em> the data instead of cloning it.</p>
<p>Use the <code>take</code> function to <em>move</em> data.</p>
<h3 id="the-original-variable-is-left-with--1"><a class="header" href="#the-original-variable-is-left-with--1">The original variable is left with <code>()</code></a></h3>
<pre><code class="language-rust">x = take(y);            // value of 'y' is moved to 'x'

y == ();                // 'y' now holds '()'

x != y;                 // 'x' holds the original value of 'y'</code></pre>
<h3 id="return-large-data-types-from-functions-1"><a class="header" href="#return-large-data-types-from-functions-1">Return large data types from functions</a></h3>
<p><code>take</code> is convenient when returning large data types from a <a href="ref/functions.html">function</a>.</p>
<pre><code class="language-rust">fn get_large_value_naive() {
    let large_result = do_complex_calculation();

    large_result.done = true;

    // Return a cloned copy of the result, then the
    // local variable 'large_result' is thrown away!
    large_result
}

fn get_large_value_smart() {
    let large_result = do_complex_calculation();

    large_result.done = true;

    // Return the result without cloning!
    // Method style call is also OK.
    large_result.take()
}</code></pre>
<h3 id="assigning-large-data-types-to-object-map-properties-1"><a class="header" href="#assigning-large-data-types-to-object-map-properties-1">Assigning large data types to object map properties</a></h3>
<p><code>take</code> is useful when assigning large data types to <a href="ref/object-maps.html">object map</a> properties.</p>
<pre><code class="language-rust">let x = [];

// Build a large array
for n in 0..1000000 { x += n; }

// The following clones the large array from 'x'.
// Both 'my_object.my_property' and 'x' now hold exact copies
// of the same large array!
my_object.my_property = x;

// Move it to object map property via 'take' without cloning.
// 'x' now holds '()'.
my_object.my_property = x.take();

// Without 'take', the following must be done to avoid cloning:
my_object.my_property = [];

for n in 0..1000000 { my_object.my_property += n; }</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="compound-assignments-1"><a class="header" href="#compound-assignments-1">Compound Assignments</a></h1>
<p>Compound assignments are <a href="ref/assignments.html">assignments</a> with a <a href="ref/operators.html">binary operator</a> attached.</p>
<pre><code class="language-rust">number += 8;            // number = number + 8

number -= 7;            // number = number - 7

number *= 6;            // number = number * 6

number /= 5;            // number = number / 5

number %= 4;            // number = number % 4

number **= 3;           // number = number ** 3

number &lt;&lt;= 2;           // number = number &lt;&lt; 2

number &gt;&gt;= 1;           // number = number &gt;&gt; 1

number &amp;= 0x00ff;       // number = number &amp; 0x00ff;

number |= 0x00ff;       // number = number | 0x00ff;

number ^= 0x00ff;       // number = number ^ 0x00ff;</code></pre>
<h2 id="the-flexible--1"><a class="header" href="#the-flexible--1">The Flexible <code>+=</code></a></h2>
<p>The the <code>+</code> and <code>+=</code> operators are often <a href="ref/overload.html">overloaded</a> to perform build-up
operations for different data types.</p>
<h3 id="build-strings-1"><a class="header" href="#build-strings-1">Build strings</a></h3>
<pre><code class="language-rust">let my_str = "abc";

my_str += "ABC";
my_str += 12345;

my_str == "abcABC12345"</code></pre>
<h3 id="concatenate-arrays-1"><a class="header" href="#concatenate-arrays-1">Concatenate arrays</a></h3>
<pre><code class="language-rust">let my_array = [1, 2, 3];

my_array += [4, 5];

my_array == [1, 2, 3, 4, 5];</code></pre>
<h3 id="concatenate-blobs-1"><a class="header" href="#concatenate-blobs-1">Concatenate BLOB’s</a></h3>
<pre><code class="language-rust">let my_blob = blob(3, 0x42);

my_blob += blob(5, 0x89);

my_blob.to_string() == "[4242428989898989]";</code></pre>
<h3 id="mix-two-object-maps-together-1"><a class="header" href="#mix-two-object-maps-together-1">Mix two object maps together</a></h3>
<pre><code class="language-rust">let my_obj = #{ a:1, b:2 };

my_obj += #{ c:3, d:4, e:5 };

my_obj == #{ a:1, b:2, c:3, d:4, e:5 };</code></pre>
<h3 id="add-seconds-to-timestamps-1"><a class="header" href="#add-seconds-to-timestamps-1">Add seconds to timestamps</a></h3>
<pre><code class="language-rust">let now = timestamp();

now += 42.0;

(now - timestamp()).round() == 42.0;</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="comparison-operators-1"><a class="header" href="#comparison-operators-1">Comparison Operators</a></h1>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Operator</th><th>Description<br/>(<code>x</code> <em>operator</em> <code>y</code>)</th><th style="text-align: center"><code>x</code>, <code>y</code> same type or are numeric</th><th style="text-align: center"><code>x</code>, <code>y</code> different types</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>==</code></td><td><code>x</code> is equals to <code>y</code></td><td style="text-align: center">error if not defined</td><td style="text-align: center"><code>false</code> if not defined</td></tr>
<tr><td style="text-align: center"><code>!=</code></td><td><code>x</code> is not equals to <code>y</code></td><td style="text-align: center">error if not defined</td><td style="text-align: center"><code>true</code> if not defined</td></tr>
<tr><td style="text-align: center"><code>&gt;</code></td><td><code>x</code> is greater than <code>y</code></td><td style="text-align: center">error if not defined</td><td style="text-align: center"><code>false</code> if not defined</td></tr>
<tr><td style="text-align: center"><code>&gt;=</code></td><td><code>x</code> is greater than or equals to <code>y</code></td><td style="text-align: center">error if not defined</td><td style="text-align: center"><code>false</code> if not defined</td></tr>
<tr><td style="text-align: center"><code>&lt;</code></td><td><code>x</code> is less than <code>y</code></td><td style="text-align: center">error if not defined</td><td style="text-align: center"><code>false</code> if not defined</td></tr>
<tr><td style="text-align: center"><code>&lt;=</code></td><td><code>x</code> is less than or equals to <code>y</code></td><td style="text-align: center">error if not defined</td><td style="text-align: center"><code>false</code> if not defined</td></tr>
</tbody></table>
</div>
<p>Comparison operators between most values of the same type are built in for all <a href="ref/values-and-types.html">standard types</a>.</p>
<h3 id="floating-point-numbers-interoperate-with-integers-1"><a class="header" href="#floating-point-numbers-interoperate-with-integers-1">Floating-point numbers interoperate with integers</a></h3>
<p>Comparing a floating-point number with an integer is also supported.</p>
<pre><code class="language-rust">42 == 42.0;         // true

42.0 == 42;         // true

42.0 &gt; 42;          // false

42 &gt;= 42.0;         // true

42.0 &lt; 42;          // false</code></pre>
<h3 id="decimal-numbers-interoperate-with-integers-1"><a class="header" href="#decimal-numbers-interoperate-with-integers-1">Decimal numbers interoperate with integers</a></h3>
<p>Comparing a decimal number with an integer is also supported.</p>
<pre><code class="language-rust">let d = parse_decimal("42");

42 == d;            // true

d == 42;            // true

d &gt; 42;             // false

42 &gt;= d;            // true

d &lt; 42;             // false</code></pre>
<h3 id="strings-interoperate-with-characters-1"><a class="header" href="#strings-interoperate-with-characters-1">Strings interoperate with characters</a></h3>
<p>Comparing a <a href="ref/strings-chars.html">string</a> with a <a href="ref/strings-chars.html">character</a> is also supported, with
the character first turned into a <a href="ref/strings-chars.html">string</a> before performing the comparison.</p>
<pre><code class="language-rust">'x' == "x";         // true

"" &lt; 'a';           // true

'x' &gt; "hello";      // false</code></pre>
<h3 id="comparing-different-types-defaults-to-false-1"><a class="header" href="#comparing-different-types-defaults-to-false-1">Comparing different types defaults to <code>false</code></a></h3>
<p>Comparing two values of <em>different</em> data types defaults to <code>false</code> unless the appropriate operator
functions have been registered.</p>
<p>The exception is <code>!=</code> (not equals) which defaults to <code>true</code>. This is in line with intuition.</p>
<pre><code class="language-rust">42 &gt; "42";          // false: i64 cannot be compared with string

42 &lt;= "42";         // false: i64 cannot be compared with string

let ts = new_ts();  // custom type

ts == 42;           // false: different types cannot be compared

ts != 42;           // true: different types cannot be compared

ts == ts;           // error: '==' not defined for the custom type</code></pre>
<h3 id="safety-valve-comparing-different-numeric-types-has-no-default-1"><a class="header" href="#safety-valve-comparing-different-numeric-types-has-no-default-1">Safety valve: Comparing different <em>numeric</em> types has no default</a></h3>
<p>Beware that the above default does <em>NOT</em> apply to numeric values of different types
(e.g. comparison between <code>i64</code> and <code>u16</code>, <code>i32</code> and <code>f64</code>) – when multiple numeric types are
used it is too easy to mess up and for subtle errors to creep in.</p>
<pre><code class="language-rust">// Assume variable 'x' = 42_u16, 'y' = 42_u16 (both types of u16)

x == y;             // true: '==' operator for u16 is built-in

x == "hello";       // false: different non-numeric operand types default to false

x == 42;            // error: ==(u16, i64) not defined, no default for numeric types

42 == y;            // error: ==(i64, u16) not defined, no default for numeric types</code></pre>
<h1 id="boolean-operators-1"><a class="header" href="#boolean-operators-1">Boolean Operators</a></h1>
<div id="admonition-note" class="admonition admonish-note side" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="ref/operators.html#admonition-note"></a>
</div>
<div>
<p>All boolean operators are <a href="ref/../engine/builtin.html">built in</a> for the <code>bool</code> data type.</p>
</div>
</div>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Operator</th><th style="text-align: center">Description</th><th style="text-align: center">Arity</th><th style="text-align: center">Short-circuits?</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>!</code> <em>(prefix)</em></td><td style="text-align: center"><em>NOT</em></td><td style="text-align: center">unary</td><td style="text-align: center">no</td></tr>
<tr><td style="text-align: center"><code>&amp;&amp;</code></td><td style="text-align: center"><em>AND</em></td><td style="text-align: center">binary</td><td style="text-align: center"><strong>yes</strong></td></tr>
<tr><td style="text-align: center"><code>&amp;</code></td><td style="text-align: center"><em>AND</em></td><td style="text-align: center">binary</td><td style="text-align: center">no</td></tr>
<tr><td style="text-align: center"><code>||</code></td><td style="text-align: center"><em>OR</em></td><td style="text-align: center">binary</td><td style="text-align: center"><strong>yes</strong></td></tr>
<tr><td style="text-align: center"><code>|</code></td><td style="text-align: center"><em>OR</em></td><td style="text-align: center">binary</td><td style="text-align: center">no</td></tr>
</tbody></table>
</div>
<p>Double boolean operators <code>&amp;&amp;</code> and <code>||</code> <em>short-circuit</em> – meaning that the second operand will not be evaluated
if the first one already proves the condition wrong.</p>
<p>Single boolean operators <code>&amp;</code> and <code>|</code> always evaluate both operands.</p>
<pre><code class="language-rust">a() || b();         // b() is not evaluated if a() is true

a() &amp;&amp; b();         // b() is not evaluated if a() is false

a() | b();          // both a() and b() are evaluated

a() &amp; b();          // both a() and b() are evaluated</code></pre>
<h1 id="null-coalescing-operator-1"><a class="header" href="#null-coalescing-operator-1">Null-Coalescing Operator</a></h1>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Operator</th><th style="text-align: center">Description</th><th style="text-align: center">Arity</th><th style="text-align: center">Short-circuits?</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>??</code></td><td style="text-align: center">Null-coalesce</td><td style="text-align: center">binary</td><td style="text-align: center">yes</td></tr>
</tbody></table>
</div>
<p>The null-coalescing operator (<code>??</code>) returns the first operand if it is not <code>()</code>, or the second
operand if the first operand is <code>()</code>.</p>
<p>This operator <em>short-circuits</em>  – meaning that the second operand will not be evaluated if the
first operand is not <code>()</code>.</p>
<pre><code class="language-rust">a ?? b              // returns 'a' if it is not (), otherwise 'b'

a() ?? b();         // b() is only evaluated if a() is ()</code></pre>
<div id="admonition-tip-default-value-for-object-map-property" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-default-value-for-object-map-property-title">
<div class="admonition-title">
<div id="admonition-tip-default-value-for-object-map-property-title">
<p>Tip: Default value for object map property</p>
</div>
<a class="admonition-anchor-link" href="ref/operators.html#admonition-tip-default-value-for-object-map-property"></a>
</div>
<div>
<p>Use the null-coalescing operator to implement default values for non-existent
<a href="ref/object-maps.html">object map</a> properties.</p>
<pre><code class="language-rust">let map = #{ foo: 42 };

// Regular property access
let x = map.foo;            // x == 42

// Non-existent property
let x = map.bar;            // x == ()

// Default value for property
let x = map.bar ?? 42;      // x == 42</code></pre>
</div>
</div>
<h2 id="short-circuit-loops-and-early-returns-1"><a class="header" href="#short-circuit-loops-and-early-returns-1">Short-circuit loops and early returns</a></h2>
<p>The following statements are allowed to follow the null-coalescing operator:</p>
<ul>
<li><code>break</code></li>
<li><code>continue</code></li>
<li><a href="ref/return.html"><code>return</code></a></li>
<li><a href="ref/throw.html"><code>throw</code></a></li>
</ul>
<p>This means that you can use the null-coalescing operator to short-circuit loops and/or
early-return from functions when the value tested is <code>()</code>.</p>
<pre><code class="language-rust">let total = 0;

for value in list {
    // Whenever 'calculate' returns '()', the loop stops
    total += calculate(value) ?? break;
}</code></pre>
<h1 id="in-operator-1"><a class="header" href="#in-operator-1">In Operator</a></h1>
<div id="admonition-trivia" class="admonition admonish-question side" role="note" aria-labelledby="admonition-trivia-title">
<div class="admonition-title">
<div id="admonition-trivia-title">
<p>Trivia</p>
</div>
<a class="admonition-anchor-link" href="ref/operators.html#admonition-trivia"></a>
</div>
<div>
<p>The <code>in</code> operator is simply syntactic sugar for a call to the <code>contains</code> function.</p>
<p>Similarly, <code>!in</code> is a call to <code>!contains</code>.</p>
</div>
</div>
<p>The <code>in</code> operator is used to check for <em>containment</em> – i.e. whether a particular collection
data type <em>contains</em> a particular item.</p>
<p>Similarly, <code>!in</code> is used to check for non-existence – i.e. it is <code>true</code> if a particular
collection data type does <em>not</em> contain a particular item.</p>
<pre><code class="language-rust">42 in array;

array.contains(42);     // &lt;- the above is equivalent to this

123 !in array;

!array.contains(123);   // &lt;- the above is equivalent to this</code></pre>
<h3 id="built-in-support-for-standard-data-types-1"><a class="header" href="#built-in-support-for-standard-data-types-1">Built-in support for standard data types</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Data type</th><th style="text-align: center">Check for</th></tr></thead><tbody>
<tr><td style="text-align: center">Numeric <a href="ref/ranges.html">range</a></td><td style="text-align: center">integer number</td></tr>
<tr><td style="text-align: center"><a href="ref/arrays.html">Array</a></td><td style="text-align: center">contained item</td></tr>
<tr><td style="text-align: center"><a href="ref/object-maps.html">Object map</a></td><td style="text-align: center">property name</td></tr>
<tr><td style="text-align: center"><a href="ref/strings-chars.html">String</a></td><td style="text-align: center"><a href="ref/strings-chars.html">sub-string</a> or <a href="ref/strings-chars.html">character</a></td></tr>
</tbody></table>
</div>
<h3 id="examples-26"><a class="header" href="#examples-26">Examples</a></h3>
<pre><code class="language-rust">let array = [1, "abc", 42, ()];

42 in array == true;                // check array for item

let map = #{
    foo: 42,
    bar: true,
    baz: "hello"
};

"foo" in map == true;               // check object map for property name

'w' in "hello, world!" == true;     // check string for character

'w' !in "hello, world!" == false;

"wor" in "hello, world" == true;    // check string for sub-string

42 in -100..100 == true;            // check range for number</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="indexing-2"><a class="header" href="#indexing-2">Indexing</a></h1>
<div id="admonition-tip-non-integer-index" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-non-integer-index-title">
<div class="admonition-title">
<div id="admonition-tip-non-integer-index-title">
<p>Tip: Non-integer index</p>
</div>
<a class="admonition-anchor-link" href="ref/indexing.html#admonition-tip-non-integer-index"></a>
</div>
<div>
<p>Some data types take an index that is not an integer.
For example, <a href="ref/object-maps.html">object map</a> indices are <a href="ref/strings-chars.html">strings</a>.</p>
</div>
</div>
<p>Some data types, such as <a href="ref/arrays.html">arrays</a>, can be <em>indexed</em> via a Rust-like syntax:</p>
<blockquote>
<p><em>object</em> <code>[</code> <em>index</em> <code>]</code></p>
<p><em>object</em> <code>[</code> <em>index</em> <code>]</code> <code>=</code> <em>value</em> <code>;</code></p>
</blockquote>
<p>Usually, a runtime error is raised if the index value is out of bounds or does not exist for the
object’s data type.</p>
<h2 id="elvis-notation-2"><a class="header" href="#elvis-notation-2">Elvis Notation</a></h2>
<p>The <a href="https://en.wikipedia.org/wiki/Elvis_operator"><em>Elvis notation</em></a> is similar except that it
returns <code>()</code> if the object itself is <code>()</code>.</p>
<blockquote>
<p><code>// returns () if object is ()</code><br />
<em>object</em> <code>?[</code> <em>index</em> <code>]</code></p>
<p><code>// no action if object is ()</code><br />
<em>object</em> <code>?[</code> <em>index</em> <code>]</code> <code>=</code> <em>value</em> <code>;</code></p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="properties"><a class="header" href="#properties">Properties</a></h1>
<p>Data types typically expose properties, which can be accessed in a Rust-like syntax:</p>
<blockquote>
<p><em>object</em> <code>.</code> <em>property</em></p>
<p><em>object</em> <code>.</code> <em>property</em> <code>=</code> <em>value</em> <code>;</code></p>
</blockquote>
<p>A runtime error is raised if the property does not exist for the object’s data type.</p>
<h2 id="elvis-operator-1"><a class="header" href="#elvis-operator-1">Elvis Operator</a></h2>
<p>The <a href="https://en.wikipedia.org/wiki/Elvis_operator"><em>Elvis operator</em></a> can be used to short-circuit
processing if the object itself is <code>()</code>.</p>
<blockquote>
<p><code>// returns () if object is ()</code><br />
<em>object</em> <code>?.</code> <em>property</em></p>
<p><code>// no action if object is ()</code><br />
<em>object</em> <code>?.</code> <em>property</em> <code>=</code> <em>value</em> <code>;</code></p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="methods-1"><a class="header" href="#methods-1">Methods</a></h1>
<p>Data types may have <em>methods</em> that can be called:</p>
<blockquote>
<p><em>object</em> <code>.</code> <em>method</em> <code>(</code> <em>parameters</em> … <code>)</code></p>
</blockquote>
<p>A runtime error is raised if the appropriate method does not exist for the object’s data type.</p>
<h2 id="elvis-operator-2"><a class="header" href="#elvis-operator-2">Elvis Operator</a></h2>
<p>The <a href="https://en.wikipedia.org/wiki/Elvis_operator"><em>Elvis</em> operator</a> can be used to short-circuit
the method call when the object itself is <code>()</code>.</p>
<blockquote>
<p><code>// method is not called if object is ()</code><br />
<em>object</em> <code>?.</code> <em>method</em> <code>(</code> <em>parameters</em> … <code>)</code></p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="if-statement-1"><a class="header" href="#if-statement-1">If Statement</a></h1>
<p><code>if</code> statements follow C syntax.</p>
<pre><code class="language-rust">if foo(x) {
    print("It's true!");
} else if bar == baz {
    print("It's true again!");
} else if baz.is_foo() {
    print("Yet again true.");
} else if foo(bar - baz) {
    print("True again... this is getting boring.");
} else {
    print("It's finally false!");
}</code></pre>
<div id="admonition-braces-are-mandatory" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-braces-are-mandatory-title">
<div class="admonition-title">
<div id="admonition-braces-are-mandatory-title">
<p>Braces are mandatory</p>
</div>
<a class="admonition-anchor-link" href="ref/if.html#admonition-braces-are-mandatory"></a>
</div>
<div>
<p>Unlike C, the condition expression does <em>not</em> need to be enclosed in parentheses <code>(</code>…<code>)</code>, but all
branches of the <code>if</code> statement must be enclosed within braces <code>{</code>…<code>}</code>, even when there is only
one statement inside the branch.</p>
<p>There is no ambiguity regarding which <code>if</code> clause a branch belongs to.</p>
<pre><code class="language-rust">// Rhai is not C!
if (decision) print(42);
//            ^ syntax error, expecting '{'</code></pre>
</div>
</div>
<h1 id="if-expression-1"><a class="header" href="#if-expression-1">If Expression</a></h1>
<p><code>if</code> statements can also be used as <em>expressions</em>, replacing the <code>? :</code> conditional operators in
other C-like languages.</p>
<pre><code class="language-rust">// The following is equivalent to C: int x = 1 + (decision ? 42 : 123) / 2;
let x = 1 + if decision { 42 } else { 123 } / 2;
x == 22;

let x = if decision { 42 }; // no else branch defaults to '()'
x == ();</code></pre>
<div id="admonition-statement-before-expression" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-statement-before-expression-title">
<div class="admonition-title">
<div id="admonition-statement-before-expression-title">
<p>Statement before expression</p>
</div>
<a class="admonition-anchor-link" href="ref/if.html#admonition-statement-before-expression"></a>
</div>
<div>
<p>Beware that, like Rust, <code>if</code> is parsed primarily as a statement where it makes sense.
This is to avoid surprises.</p>
<pre><code class="language-rust">fn index_of(x) {
    // 'if' is parsed primarily as a statement
    if this.contains(x) {
        return this.find_index(x)
    }

    -1
}</code></pre>
<p>The above will not be parsed as a single expression:</p>
<pre><code class="language-rust">fn index_of(x) {
    if this.contains(x) { return this.find_index(x) } - 1
    //                          error due to '() - 1' ^
}
</code></pre>
<p>To force parsing as an expression, parentheses are required:</p>
<pre><code class="language-rust">fn calc_index(b, offset) {
    (if b { 1 } else { 0 }) + offset
//  ^---------------------^ parentheses
}</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="switch-statement-1"><a class="header" href="#switch-statement-1">Switch Statement</a></h1>
<p>The <code>switch</code> statement allows matching on <a href="ref/../appendix/literals.html">literal</a> values.</p>
<pre><code class="language-js">switch calc_secret_value(x) {
    1 =&gt; print("It's one!"),
    2 =&gt; {
        // A statements block instead of a one-line statement
        print("It's two!");
        print("Again!");
    }
    3 =&gt; print("Go!"),
    // A list of alternatives
    4 | 5 | 6 =&gt; print("Some small number!"),
    // _ is the default when no case matches. It must be the last case.
    _ =&gt; print(`Oops! Something's wrong: ${x}`)
}
</code></pre>
<h2 id="default-case-1"><a class="header" href="#default-case-1">Default Case</a></h2>
<p>A <em>default</em> case (i.e. when no other cases match) can be specified with <code>_</code>.</p>
<div id="admonition-must-be-last" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-must-be-last-title">
<div class="admonition-title">
<div id="admonition-must-be-last-title">
<p>Must be last</p>
</div>
<a class="admonition-anchor-link" href="ref/switch.html#admonition-must-be-last"></a>
</div>
<div>
<p>The default case must be the <em>last</em> case in the <code>switch</code> statement.</p>
</div>
</div>
<pre><code class="language-js">switch wrong_default {
    1 =&gt; 2,
    _ =&gt; 9,     // &lt;- syntax error: default case not the last
    2 =&gt; 3,
    3 =&gt; 4,     // &lt;- ending with extra comma is OK
}

switch wrong_default {
    1 =&gt; 2,
    2 =&gt; 3,
    3 =&gt; 4,
    _ =&gt; 8,     // &lt;- syntax error: default case not the last
    _ =&gt; 9
}
</code></pre>
<h2 id="array-and-object-map-literals-also-work-1"><a class="header" href="#array-and-object-map-literals-also-work-1">Array and Object Map Literals Also Work</a></h2>
<p>The <code>switch</code> expression can match against any <em><a href="ref/../appendix/literals.html">literal</a></em>, including
<a href="ref/arrays.html">array</a> and <a href="ref/object-maps.html">object map</a> <a href="ref/../appendix/literals.html">literals</a>.</p>
<pre><code class="language-js">// Match on arrays
switch [foo, bar, baz] {
    ["hello", 42, true] =&gt; ...,
    ["hello", 123, false] =&gt; ...,
    ["world", 1, true] =&gt; ...,
    _ =&gt; ...
}

// Match on object maps
switch map {
    #{ a: 1, b: 2, c: true } =&gt; ...,
    #{ a: 42, d: "hello" } =&gt; ...,
    _ =&gt; ...
}
</code></pre>
<h2 id="case-conditions-1"><a class="header" href="#case-conditions-1">Case Conditions</a></h2>
<p>Similar to Rust, each case (except the default case at the end) can provide an optional condition
that must evaluate to <code>true</code> in order for the case to match.</p>
<p>All cases are checked in order, so an earlier case that matches will override all later cases.</p>
<pre><code class="language-js">let result = switch calc_secret_value(x) {
    1 if some_external_condition(x, y, z) =&gt; 100,

    1 | 2 | 3 if x &lt; foo =&gt; 200,    // &lt;- all alternatives share the same condition
    
    2 if bar() =&gt; 999,

    2 =&gt; "two",                     // &lt;- fallback value for 2

    2 =&gt; "dead code",               // &lt;- this case is a duplicate and will never match
                                    //    because the previous case matches first

    5 if CONDITION =&gt; 123,          // &lt;- value for 5 matching condition

    5 =&gt; "five",                    // &lt;- fallback value for 5

    _ if CONDITION =&gt; 8888          // &lt;- syntax error: default case cannot have condition
};
</code></pre>
<div id="admonition-tip-use-with-type_of" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-use-with-type_of-title">
<div class="admonition-title">
<div id="admonition-tip-use-with-type_of-title">
<p>Tip: Use with <code>type_of()</code></p>
</div>
<a class="admonition-anchor-link" href="ref/switch.html#admonition-tip-use-with-type_of"></a>
</div>
<div>
<p>Case conditions, together with <a href="ref/type-of.html"><code>type_of()</code></a>, makes it extremely easy to work with
values which may be of several different types (like properties in a JSON object).</p>
<pre><code class="language-js">switch value.type_of() {
    // if 'value' is a string...
    "string" if value.len() &lt; 5 =&gt; ...,
    "string" =&gt; ...,

    // if 'value' is an array...
    "array" =&gt; ...,

    // if 'value' is an object map...
    "map" if value.prop == 42 =&gt; ...,
    "map" =&gt; ...,

    // if 'value' is a number...
    "i64" if value &gt; 0 =&gt; ...,
    "i64" =&gt; ...,

    // anything else: probably an error...
    _ =&gt; ...
}
</code></pre>
</div>
</div>
<h2 id="range-cases-1"><a class="header" href="#range-cases-1">Range Cases</a></h2>
<p>Because of their popularity, <a href="ref/../appendix/literals.html">literal</a> integer <a href="ref/ranges.html">ranges</a> can also
be used as <code>switch</code> cases.</p>
<p>Numeric <a href="ref/ranges.html">ranges</a> are only searched when the <code>switch</code> value is itself a number (including
floating-point and decimal). They never match any other data types.</p>
<div id="admonition-must-come-after-numeric-cases" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-must-come-after-numeric-cases-title">
<div class="admonition-title">
<div id="admonition-must-come-after-numeric-cases-title">
<p>Must come after numeric cases</p>
</div>
<a class="admonition-anchor-link" href="ref/switch.html#admonition-must-come-after-numeric-cases"></a>
</div>
<div>
<p>Range cases must come <em>after</em> all numeric cases.</p>
</div>
</div>
<pre><code class="language-js">let x = 42;

switch x {
    'x' =&gt; ...,             // no match: wrong data type

    1 =&gt; ...,               // &lt;- specific numeric cases are checked first
    2 =&gt; ...,               // &lt;- but these do not match

    0..50 if x &gt; 45 =&gt; ..., // no match: condition is 'false'

    -10..20 =&gt; ...,         // no match: not in range

    0..50 =&gt; ...,           // &lt;- MATCH!!! duplicated range cases are OK

    30..100 =&gt; ...,         // no match: even though it is within range,
                            // the previous case matches first

    42 =&gt; ...,              // &lt;- syntax error: numeric cases cannot follow range cases
}
</code></pre>
<div id="admonition-tip-ranges-can-overlap" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-ranges-can-overlap-title">
<div class="admonition-title">
<div id="admonition-tip-ranges-can-overlap-title">
<p>Tip: Ranges can overlap</p>
</div>
<a class="admonition-anchor-link" href="ref/switch.html#admonition-tip-ranges-can-overlap"></a>
</div>
<div>
<p>When more then one <a href="ref/ranges.html">range</a> contain the <code>switch</code> value, the <em>first</em> one with a fulfilled condition
(if any) is evaluated.</p>
<p>Numeric <a href="ref/ranges.html">range</a> cases are tried in the order that they appear in the original script.</p>
</div>
</div>
<h1 id="switch-expression-1"><a class="header" href="#switch-expression-1">Switch Expression</a></h1>
<p>Like <a href="ref/if.html"><code>if</code></a>, <code>switch</code> also works as an <em>expression</em>.</p>
<div id="admonition-tip" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="ref/switch.html#admonition-tip"></a>
</div>
<div>
<p>This means that a <code>switch</code> expression can appear anywhere a regular expression can,
e.g. as <a href="ref/functions.html">function</a> call arguments.</p>
</div>
</div>
<pre><code class="language-js">let x = switch foo { 1 =&gt; true, _ =&gt; false };

func(switch foo {
    "hello" =&gt; 42,
    "world" =&gt; 123,
    _ =&gt; 0
});

// The above is somewhat equivalent to:

let x = if foo == 1 { true } else { false };

if foo == "hello" {
    func(42);
} else if foo == "world" {
    func(123);
} else {
    func(0);
}
</code></pre>
<h2 id="difference-from-if-else-if-chain-1"><a class="header" href="#difference-from-if-else-if-chain-1">Difference From <code>if</code>-<code>else if</code> Chain</a></h2>
<p>Although a <code>switch</code> expression looks <em>almost</em> the same as an <a href="ref/if.html"><code>if</code>-<code>else if</code></a> chain, there
are subtle differences between the two.</p>
<h3 id="look-up-table-vs-x--y-1"><a class="header" href="#look-up-table-vs-x--y-1">Look-up Table vs <code>x == y</code></a></h3>
<p>A <code>switch</code> expression matches through <em>hashing</em> via a look-up table. Therefore, matching is very
fast.  Walking down an <a href="ref/if.html"><code>if</code>-<code>else if</code></a> chain is <em>much</em> slower.</p>
<p>On the other hand, operators can be <a href="ref/overload.html">overloaded</a> in Rhai, meaning that it is possible
to override the <code>==</code> operator for integers such that <code>x == y</code> returns a different result from the
built-in default.</p>
<p><code>switch</code> expressions do <em>not</em> use the <code>==</code> operator for comparison; instead, they <em>hash</em> the data
values and jump directly to the correct statements via a pre-compiled look-up table.  This makes
matching extremely efficient, but it also means that <a href="ref/overload.html">overloading</a> the <code>==</code> operator
will have no effect.</p>
<p>Therefore, in environments where it is desirable to <a href="ref/overload.html">overload</a> the <code>==</code> operator for
<a href="ref/values-and-types.html">standard types</a> – though it is difficult to think of valid scenarios
where you’d want <code>1 == 1</code> to return something other than <code>true</code> – avoid using the <code>switch</code>
expression.</p>
<h3 id="efficiency-1"><a class="header" href="#efficiency-1">Efficiency</a></h3>
<p>Because the <code>switch</code> expression works through a look-up table, it is very efficient even for <em>large</em>
number of cases; in fact, switching is an O(1) operation regardless of the size of the data and
number of cases to match.</p>
<p>A long <a href="ref/if.html"><code>if</code>-<code>else if</code></a> chain becomes increasingly slower with each additional case because
essentially an O(n) <em>linear scan</em> is performed.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="while-loop-1"><a class="header" href="#while-loop-1">While Loop</a></h1>
<p><code>while</code> loops follow C syntax.</p>
<p><code>continue</code> can be used to skip to the next iteration, by-passing all following statements;
<code>break</code> can be used to break out of the loop unconditionally.</p>
<pre><code class="language-rust">let x = 10;

while x &gt; 0 {
    x -= 1;
    if x &lt; 6 { continue; }  // skip to the next iteration
    print(x);
    if x == 5 { break; }    // break out of while loop
}</code></pre>
<h2 id="while-expression-1"><a class="header" href="#while-expression-1">While Expression</a></h2>
<p><code>while</code> statements can also be used as <em>expressions</em>.</p>
<p>The <code>break</code> statement takes an optional expression that provides the return value.</p>
<p>The default return value of a <code>while</code> expression is <code>()</code>.</p>
<pre><code class="language-js">let x = 0;

// 'while' can be used just like an expression
let result = while x &lt; 100 {
    if is_magic_number(x) {
        // if the 'while' loop breaks here, return a specific value
        break get_magic_result(x);
    }

    x += 1;

    // ... if the 'while' loop exits here, the return value is ()
};

if result == () {
    print("Magic number not found!");
} else {
    print(`Magic result = ${result}!`);
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="do-loop-1"><a class="header" href="#do-loop-1">Do Loop</a></h1>
<p><code>do</code> loops have two opposite variants: <code>do</code> … <code>while</code> and <code>do</code> … <code>until</code>.</p>
<p><code>continue</code> can be used to skip to the next iteration, by-passing all following statements;
<code>break</code> can be used to break out of the loop unconditionally.</p>
<pre><code class="language-rust">let x = 10;

do {
    x -= 1;
    if x &lt; 6 { continue; }  // skip to the next iteration
    print(x);
    if x == 5 { break; }    // break out of do loop
} while x &gt; 0;


do {
    x -= 1;
    if x &lt; 6 { continue; }  // skip to the next iteration
    print(x);
    if x == 5 { break; }    // break out of do loop
} until x == 0;</code></pre>
<h2 id="do-expression-1"><a class="header" href="#do-expression-1">Do Expression</a></h2>
<p><code>do</code> statements can also be used as <em>expressions</em>.</p>
<p>The <code>break</code> statement takes an optional expression that provides the return value.</p>
<p>The default return value of a <code>do</code> expression is <code>()</code>.</p>
<pre><code class="language-js">let x = 0;

// 'do' can be used just like an expression
let result = do {
    if is_magic_number(x) {
        // if the 'do' loop breaks here, return a specific value
        break get_magic_result(x);
    }

    x += 1;

    // ... if the 'do' loop exits here, the return value is ()
} until x &gt;= 100;

if result == () {
    print("Magic number not found!");
} else {
    print(`Magic result = ${result}!`);
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="infinite-loop-1"><a class="header" href="#infinite-loop-1">Infinite Loop</a></h1>
<p>Infinite loops follow Rust syntax.</p>
<p><code>continue</code> can be used to skip to the next iteration, by-passing all following statements;
<code>break</code> can be used to break out of the loop unconditionally.</p>
<pre><code class="language-rust">let x = 10;

loop {
    x -= 1;

    if x &gt; 5 { continue; }  // skip to the next iteration

    print(x);

    if x == 0 { break; }    // break out of loop
}</code></pre>
<div id="admonition-remember-the-break-statement" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-remember-the-break-statement-title">
<div class="admonition-title">
<div id="admonition-remember-the-break-statement-title">
<p>Remember the <code>break</code> statement</p>
</div>
<a class="admonition-anchor-link" href="ref/loop.html#admonition-remember-the-break-statement"></a>
</div>
<div>
<p>A <code>loop</code> statement without a <code>break</code> statement inside its loop block is infinite.
There is no way for the loop to stop iterating.</p>
</div>
</div>
<h2 id="loop-expression-1"><a class="header" href="#loop-expression-1">Loop Expression</a></h2>
<p><code>loop</code> statements can also be used as <em>expressions</em>.</p>
<p>The <code>break</code> statement takes an optional expression that provides the return value.</p>
<p>The default return value of a <code>loop</code> expression is <code>()</code>.</p>
<pre><code class="language-js">let x = 0;

// 'loop' can be used just like an expression
let result = loop {
    if is_magic_number(x) {
        // if the loop breaks here, return a specific value
        break get_magic_result(x);
    }

    x += 1;

    // ... if the loop exits here, the return value is ()
};

if result == () {
    print("Magic number not found!");
} else {
    print(`Magic result = ${result}!`);
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="for-loop-1"><a class="header" href="#for-loop-1">For Loop</a></h1>
<p>Iterating through a numeric <a href="ref/ranges.html">range</a> or an <a href="ref/arrays.html">array</a>, or any iterable type,
is provided by the <code>for</code> … <code>in</code> loop.</p>
<p>There are two alternative syntaxes, one including a counter variable:</p>
<blockquote>
<p><code>for</code> <em>variable</em> <code>in</code> <em>expression</em> <code>{</code> … <code>}</code></p>
<p><code>for (</code> <em>variable</em> <code>,</code> <em>counter</em> <code>)</code> <code>in</code> <em>expression</em> <code>{</code> … <code>}</code></p>
</blockquote>
<h2 id="break-or-continue-1"><a class="header" href="#break-or-continue-1">Break or Continue</a></h2>
<p><code>continue</code> can be used to skip to the next iteration, by-passing all following statements;
<code>break</code> can be used to break out of the loop unconditionally.</p>
<h2 id="for-expression-1"><a class="header" href="#for-expression-1">For Expression</a></h2>
<p><code>for</code> statements can also be used as <em>expressions</em>.</p>
<p>The <code>break</code> statement takes an optional expression that provides the return value.</p>
<p>The default return value of a <code>for</code> expression is <code>()</code>.</p>
<pre><code class="language-js">let a = [42, 123, 999, 0, true, "hello", "world!", 987.6543];

// 'for' can be used just like an expression
let index = for (item, count) in a {
    // if the 'for' loop breaks here, return a specific value
    switch item.type_of() {
        "i64" if item.is_even =&gt; break count,
        "f64" if item.to_int().is_even =&gt; break count,
    }

    // ... if the 'for' loop exits here, the return value is ()
};

if index == () {
    print("Magic number not found!");
} else {
    print(`Magic number found at index ${index}!`);
}
</code></pre>
<h2 id="counter-variable-1"><a class="header" href="#counter-variable-1">Counter Variable</a></h2>
<p>The counter variable, if specified, starts from zero, incrementing upwards.</p>
<pre><code class="language-js   no_run">let a = [42, 123, 999, 0, true, "hello", "world!", 987.6543];

// Loop through the array
for (item, count) in a {
    if x.type_of() == "string" {
        continue;                   // skip to the next iteration
    }

    // 'item' contains a copy of each element during each iteration
    // 'count' increments (starting from zero) for each iteration
    print(`Item #${count + 1} = ${item}`);

    if x == 42 { break; }           // break out of for loop
}
</code></pre>
<h2 id="iterate-through-arrays-1"><a class="header" href="#iterate-through-arrays-1">Iterate Through Arrays</a></h2>
<p>Iterating through an <a href="ref/arrays.html">array</a> yields cloned <em>copies</em> of each element.</p>
<pre><code class="language-rust">let a = [1, 3, 5, 7, 9, 42];

// Loop through the array
for x in a {
    if x &gt; 10 { continue; }         // skip to the next iteration

    print(x);

    if x == 42 { break; }           // break out of for loop
}</code></pre>
<h2 id="iterate-through-strings-1"><a class="header" href="#iterate-through-strings-1">Iterate Through Strings</a></h2>
<p>Iterating through a <a href="ref/strings-chars.html">string</a> yields individual <a href="ref/strings-chars.html">characters</a>.</p>
<p>The <code>chars</code> method also allow iterating through characters in a <a href="ref/strings-chars.html">string</a>,
optionally accepting the character position to start from (counting from the end if negative), as
well as the number of characters to iterate (defaults to all).</p>
<p><code>char</code> also accepts a <a href="ref/ranges.html">range</a> which can be created via the <code>..</code> (exclusive) and <code>..=</code>
(inclusive) operators.</p>
<pre><code class="language-rust">let s = "hello, world!";

// Iterate through all the characters.
for ch in s {
    print(ch);
}

// Iterate starting from the 3rd character and stopping at the 7th.
for ch in s.chars(2, 5) {
    if ch &gt; 'z' { continue; }       // skip to the next iteration

    print(ch);

    if x == '@' { break; }          // break out of for loop
}

// Iterate starting from the 3rd character and stopping at the end.
for ch in s.chars(2..s.len) {
    if ch &gt; 'z' { continue; }       // skip to the next iteration

    print(ch);

    if x == '@' { break; }          // break out of for loop
}</code></pre>
<h2 id="iterate-through-numeric-ranges-1"><a class="header" href="#iterate-through-numeric-ranges-1">Iterate Through Numeric Ranges</a></h2>
<p><a href="ref/ranges.html">Ranges</a> are created via the <code>..</code> (exclusive) and <code>..=</code> (inclusive) operators.</p>
<p>The <code>range</code> function similarly creates exclusive <a href="ref/ranges.html">ranges</a>, plus allowing optional step values.</p>
<pre><code class="language-rust">// Iterate starting from 0 and stopping at 49
// The step is assumed to be 1 when omitted for integers
for x in 0..50 {
    if x &gt; 10 { continue; }         // skip to the next iteration

    print(x);

    if x == 42 { break; }           // break out of for loop
}

// The 'range' function is just the same
for x in range(0, 50) {
    if x &gt; 10 { continue; }         // skip to the next iteration

    print(x);

    if x == 42 { break; }           // break out of for loop
}

// The 'range' function also takes a step
for x in range(0, 50, 3) {          // step by 3
    if x &gt; 10 { continue; }         // skip to the next iteration

    print(x);

    if x == 42 { break; }           // break out of for loop
}

// The 'range' function can also step backwards
for x in range(50..0, -3) {         // step down by -3
    if x &lt; 10 { continue; }         // skip to the next iteration

    print(x);

    if x == 42 { break; }           // break out of for loop
}

// It works also for floating-point numbers
for x in range(5.0, 0.0, -2.0) {    // step down by -2.0
    if x &lt; 10 { continue; }         // skip to the next iteration

    print(x);

    if x == 4.2 { break; }          // break out of for loop
}</code></pre>
<h2 id="iterate-through-bit-fields-1"><a class="header" href="#iterate-through-bit-fields-1">Iterate Through Bit-Fields</a></h2>
<p>The <code>bits</code> function allows iterating through an integer as a <a href="ref/bit-fields.html">bit-field</a>.</p>
<p><code>bits</code> optionally accepts the bit number to start from (counting from the most-significant-bit if
negative), as well as the number of bits to iterate (defaults all).</p>
<p><code>bits</code> also accepts a <a href="ref/ranges.html">range</a> which can be created via the <code>..</code> (exclusive) and <code>..=</code>
(inclusive) operators.</p>
<pre><code class="language-js   no_run">let x = 0b_1001110010_1101100010_1100010100;
let num_on = 0;

// Iterate through all the bits
for bit in x.bits() {
    if bit { num_on += 1; }
}

print(`There are ${num_on} bits turned on!`);

const START = 3;

// Iterate through all the bits from 3 through 12
for (bit, index) in x.bits(START, 10) {
    print(`Bit #${index} is ${if bit { "ON" } else { "OFF" }}!`);

    if index &gt;= 7 { break; }        // break out of for loop
}

// Iterate through all the bits from 3 through 12
for (bit, index) in x.bits(3..=12) {
    print(`Bit #${index} is ${if bit { "ON" } else { "OFF" }}!`);

    if index &gt;= 7 { break; }        // break out of for loop
}
</code></pre>
<h2 id="iterate-through-object-maps-1"><a class="header" href="#iterate-through-object-maps-1">Iterate Through Object Maps</a></h2>
<p>Two methods, <code>keys</code> and <code>values</code>, return <a href="ref/arrays.html">arrays</a> containing cloned <em>copies</em>
of all property names and values of an <a href="ref/object-maps.html">object map</a>, respectively.</p>
<p>These <a href="ref/arrays.html">arrays</a> can be iterated.</p>
<pre><code class="language-rust">let map = #{a:1, b:3, c:5, d:7, e:9};

// Property names are returned in unsorted, random order
for x in map.keys() {
    if x &gt; 10 { continue; }         // skip to the next iteration

    print(x);

    if x == 42 { break; }           // break out of for loop
}

// Property values are returned in unsorted, random order
for val in map.values() {
    print(val);
}</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="return-value-10"><a class="header" href="#return-value-10">Return Value</a></h1>
<h2 id="return-1"><a class="header" href="#return-1"><code>return</code></a></h2>
<p>The <code>return</code> statement is used to immediately stop evaluation and exist the current context
(typically a <a href="ref/functions.html">function</a> call) yielding a <em>return value</em>.</p>
<pre><code class="language-rust">return;             // equivalent to return ();

return 123 + 456;   // returns 579</code></pre>
<p>A <code>return</code> statement at <em>global</em> level exits the script with the return value as the result.</p>
<p>A <code>return</code> statement inside a <a href="ref/functions.html">function call</a> exits with a return value to the caller.</p>
<h2 id="exit-1"><a class="header" href="#exit-1"><code>exit</code></a></h2>
<p>Similar to the <code>return</code> statement, the <code>exit</code> <em>function</em> is used to immediately stop evaluation,
but it does so regardless of where it is called from, even deep inside nested function calls.</p>
<p>The result value of <code>exit</code>, when omitted, defaults to <code>()</code>.</p>
<pre><code class="language-rust">fn foo() {
    exit(42);       // exit with result value 42
}
fn bar() {
    foo();
}
fn baz() {
    bar();
}

let x = baz();      // exits with result value 42

print(x);           // &lt;- this is never run</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="throw-exception-on-error-1"><a class="header" href="#throw-exception-on-error-1">Throw Exception on Error</a></h1>
<p>To deliberately return an error, use the <code>throw</code> keyword.</p>
<pre><code class="language-js">if some_bad_condition_has_happened {
    throw error;    // 'throw' any value as the exception
}

throw;              // defaults to '()'
</code></pre>
<h2 id="catch-a-thrown-exception-1"><a class="header" href="#catch-a-thrown-exception-1">Catch a Thrown Exception</a></h2>
<p>It is possible to <em>catch</em> an exception, instead of having it abort the script run, via the
<a href="ref/try-catch.html"><code>try</code> … <code>catch</code></a> statement common to many C-like languages.</p>
<pre><code class="language-js">fn code_that_throws() {
    throw 42;
}

try
{
    code_that_throws();
}
catch (err)         // 'err' captures the thrown exception value
{
    print(err);     // prints 42
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="catch-exceptions-1"><a class="header" href="#catch-exceptions-1">Catch Exceptions</a></h1>
<p>When an <a href="ref/throw.html">exception</a> is thrown via a <a href="ref/throw.html"><code>throw</code></a> statement, the script halts with
the exception value.</p>
<p>It is possible, via the <code>try</code> … <code>catch</code> statement, to <em>catch</em> exceptions, optionally with an
<em>error variable</em>.</p>
<blockquote>
<p><code>try</code> <code>{</code> … <code>}</code> <code>catch</code> <code>{</code> … <code>}</code></p>
<p><code>try</code> <code>{</code> … <code>}</code> <code>catch</code> <code>(</code> <em>error variable</em> <code>)</code> <code>{</code> … <code>}</code></p>
</blockquote>
<pre><code class="language-js">// Catch an exception and capturing its value
try
{
    throw 42;
}
catch (err)         // 'err' captures the thrown exception value
{
    print(err);     // prints 42
}

// Catch an exception without capturing its value
try
{
    print(42/0);    // deliberate divide-by-zero exception
}
catch               // no error variable - exception value is discarded
{
    print("Ouch!");
}

// Exception in the 'catch' block
try
{
    print(42/0);    // throw divide-by-zero exception
}
catch
{
    print("You seem to be dividing by zero here...");

    throw "die";    // a 'throw' statement inside a 'catch' block
                    // throws a new exception
}
</code></pre>
<div id="admonition-tip-re-throw-exception" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-re-throw-exception-title">
<div class="admonition-title">
<div id="admonition-tip-re-throw-exception-title">
<p>Tip: Re-throw exception</p>
</div>
<a class="admonition-anchor-link" href="ref/try-catch.html#admonition-tip-re-throw-exception"></a>
</div>
<div>
<p>Like the <code>try</code> … <code>catch</code> syntax in most languages, it is possible to <em>re-throw</em> an exception
within the <code>catch</code> block simply by another <a href="ref/throw.html"><code>throw</code></a> statement without a value.</p>
<pre><code class="language-js">try
{
    // Call something that will throw an exception...
    do_something_bad_that_throws();
}
catch
{
    print("Oooh! You've done something real bad!");

    throw;          // 'throw' without a value within a 'catch' block
                    // re-throws the original exception
}

</code></pre>
</div>
</div>
<div id="admonition-catchable-exceptions" class="admonition admonish-success" role="note" aria-labelledby="admonition-catchable-exceptions-title">
<div class="admonition-title">
<div id="admonition-catchable-exceptions-title">
<p>Catchable exceptions</p>
</div>
<a class="admonition-anchor-link" href="ref/try-catch.html#admonition-catchable-exceptions"></a>
</div>
<div>
<p>Many script-oriented exceptions can be caught via <code>try</code> … <code>catch</code>.</p>
<div class="table-wrapper"><table><thead><tr><th>Error type</th><th style="text-align: center">Error value</th></tr></thead><tbody>
<tr><td>Runtime error thrown by a <a href="ref/throw.html"><code>throw</code></a> statement</td><td style="text-align: center">value in <a href="ref/throw.html"><code>throw</code></a> statement</td></tr>
<tr><td>Arithmetic error</td><td style="text-align: center"><a href="ref/object-maps.html">object map</a></td></tr>
<tr><td><a href="ref/variables.html">Variable</a> not found</td><td style="text-align: center"><a href="ref/object-maps.html">object map</a></td></tr>
<tr><td><a href="ref/functions.html">Function</a> not found</td><td style="text-align: center"><a href="ref/object-maps.html">object map</a></td></tr>
<tr><td><a href="ref/modules/index.html">Module</a> not found</td><td style="text-align: center"><a href="ref/object-maps.html">object map</a></td></tr>
<tr><td>Unbound <code>this</code></td><td style="text-align: center"><a href="ref/object-maps.html">object map</a></td></tr>
<tr><td>Data type mismatch</td><td style="text-align: center"><a href="ref/object-maps.html">object map</a></td></tr>
<tr><td>Assignment to a calculated/<a href="ref/constants.html">constant</a> value</td><td style="text-align: center"><a href="ref/object-maps.html">object map</a></td></tr>
<tr><td><a href="ref/arrays.html">Array</a>/<a href="ref/strings-chars.html">string</a>/<a href="ref/bit-fields.html">bit-field</a> indexing out-of-bounds</td><td style="text-align: center"><a href="ref/object-maps.html">object map</a></td></tr>
<tr><td>Indexing with an inappropriate data type</td><td style="text-align: center"><a href="ref/object-maps.html">object map</a></td></tr>
<tr><td>Error in property access</td><td style="text-align: center"><a href="ref/object-maps.html">object map</a></td></tr>
<tr><td><a href="ref/for.html"><code>for</code></a> statement on a type that is not iterable</td><td style="text-align: center"><a href="ref/object-maps.html">object map</a></td></tr>
<tr><td>Data race detected</td><td style="text-align: center"><a href="ref/object-maps.html">object map</a></td></tr>
<tr><td>Other runtime error</td><td style="text-align: center"><a href="ref/object-maps.html">object map</a></td></tr>
</tbody></table>
</div>
<p>The error value in the <code>catch</code> clause is an <a href="ref/object-maps.html">object map</a> containing information on
the particular error, including its type, line and character position (if any), and source etc.</p>
</div>
</div>
<div id="admonition-non-catchable-exceptions" class="admonition admonish-failure" role="note" aria-labelledby="admonition-non-catchable-exceptions-title">
<div class="admonition-title">
<div id="admonition-non-catchable-exceptions-title">
<p>Non-catchable exceptions</p>
</div>
<a class="admonition-anchor-link" href="ref/try-catch.html#admonition-non-catchable-exceptions"></a>
</div>
<div>
<p>Some system exceptions <em>cannot</em> be caught.</p>
<div class="table-wrapper"><table><thead><tr><th>Error type</th><th>Notes</th></tr></thead><tbody>
<tr><td>System error – e.g. script file not found</td><td>system errors are not recoverable</td></tr>
<tr><td>Syntax error during parsing</td><td>invalid script</td></tr>
<tr><td>[Custom syntax] mismatch error</td><td>incompatible [<code>Engine</code>] instance</td></tr>
<tr><td>Script evaluation metrics exceeding [limits][safety]</td><td>[safety] protection</td></tr>
<tr><td>Script evaluation manually <a href="ref//book/safety/progress.html">terminated</a></td><td>[safety] protection</td></tr>
</tbody></table>
</div></div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="functions-2"><a class="header" href="#functions-2">Functions</a></h1>
<p>Rhai supports defining functions in script via the <code>fn</code> keyword.</p>
<p>Valid function names are the same as valid <a href="ref/variables.html">variable</a> names.</p>
<pre><code class="language-rust">fn add(x, y) {
    x + y
}

fn sub(x, y,) {     // trailing comma in parameters list is OK
    x - y
}

add(2, 3) == 5;

sub(2, 3,) == -1;   // trailing comma in arguments list is OK</code></pre>
<div id="admonition-tip-is_def_fn" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-is_def_fn-title">
<div class="admonition-title">
<div id="admonition-tip-is_def_fn-title">
<p>Tip: <code>is_def_fn</code></p>
</div>
<a class="admonition-anchor-link" href="ref/functions.html#admonition-tip-is_def_fn"></a>
</div>
<div>
<p>Use <code>is_def_fn</code> to detect if a Rhai function is defined (and therefore callable)
based on its name and the number of parameters (<em>arity</em>).</p>
<pre><code class="language-rust">fn foo(x) { x + 1 }

is_def_fn("foo", 1) == true;

is_def_fn("foo", 0) == false;

is_def_fn("foo", 2) == false;

is_def_fn("bar", 1) == false;</code></pre>
</div>
</div>
<h2 id="implicit-return-1"><a class="header" href="#implicit-return-1">Implicit Return</a></h2>
<p>The last statement of a block is <em>always</em> the block’s return value regardless of whether it is
terminated with a semicolon <code>;</code>.</p>
<pre><code class="language-rust">fn add(x, y) {      // implicit return:
    x + y;          // value of the last statement (no need for ending semicolon)
                    // is used as the return value
}

fn add2(x) {
    return x + 2;   // explicit return
}

add(2, 3) == 5;

add2(42) == 44;</code></pre>
<h2 id="global-definitions-only-1"><a class="header" href="#global-definitions-only-1">Global Definitions Only</a></h2>
<p>Functions can only be defined at the global level, never inside a block or another function.</p>
<pre><code class="language-rust">// Global level is OK
fn add(x, y) {
    x + y
}

// The following will not compile
fn do_addition(x) {
    fn add_y(n) {   // &lt;- syntax error:  cannot define inside another function
        n + y
    }

    add_y(x)
}</code></pre>
<h2 id="no-access-to-external-scope-1"><a class="header" href="#no-access-to-external-scope-1">No Access to External Scope</a></h2>
<p>Functions are not <em>closures</em>. They do not capture the calling environment and can only access their
own parameters.</p>
<p>They cannot access <a href="ref/variables.html">variables</a> external to the function itself.</p>
<pre><code class="language-rust">let x = 42;

fn foo() {
    x               // &lt;- error: variable 'x' not found
}</code></pre>
<h2 id="but-can-call-other-functions-and-access-modules-1"><a class="header" href="#but-can-call-other-functions-and-access-modules-1">But Can Call Other Functions and Access Modules</a></h2>
<p>All functions can call each other.</p>
<pre><code class="language-rust">fn foo(x) {         // function defined in the global namespace
    x + 1
}

fn bar(x) {
    foo(x)          // ok! function 'foo' can be called
}</code></pre>
<p>In addition, <a href="ref/modules/index.html">modules</a> <a href="ref/modules/import.html">imported</a> at global level can be accessed.</p>
<pre><code class="language-js">import "hello" as hey;
import "world" as woo;

{
    import "x" as xyz;  // &lt;- this module is not at global level
}                       // &lt;- it goes away here

fn foo(x) {
    hey::process(x);    // ok! imported module 'hey' can be accessed

    print(woo::value);  // ok! imported module 'woo' can be accessed

    xyz::do_work();     // &lt;- error: module 'xyz' not found
}
</code></pre>
<h2 id="automatic-global-module-3"><a class="header" href="#automatic-global-module-3">Automatic Global Module</a></h2>
<p>When a <a href="ref/constants.html">constant</a> is declared at global scope, it is added to a special
<a href="ref/modules/index.html">module</a> called <a href="ref/global.html"><code>global</code></a>.</p>
<p>Functions can access those <a href="ref/constants.html">constants</a> via the special <a href="ref/global.html"><code>global</code></a>
<a href="ref/modules/index.html">module</a>.</p>
<pre><code class="language-rust">const CONSTANT = 42;        // this constant is automatically added to 'global'

let hello = 1;              // variables are not added to 'global'

{
    const INNER = 0;        // this constant is not at global level
}                           // &lt;- it goes away here

fn foo(x) {
    x * global::hello       // &lt;- error: variable 'hello' not found in 'global'

    x * global::CONSTANT    // ok! 'CONSTANT' exists in 'global'

    x * global::INNER       // &lt;- error: constant 'INNER' not found in 'global'
}</code></pre>
<h2 id="use-before-definition-allowed-1"><a class="header" href="#use-before-definition-allowed-1">Use Before Definition Allowed</a></h2>
<p>Unlike C/C++, functions in Rhai can be defined <em>anywhere</em> at global level.</p>
<p>A function does not need to be defined prior to being used in a script; a statement in the script
can freely call a function defined afterwards.</p>
<p>This is similar to Rust and many other modern languages, such as JavaScript’s <code>function</code> keyword.</p>
<pre><code class="language-rust">let x = foo(41);    // &lt;- I can do this!

fn foo(x) {         // &lt;- define 'foo' after use
    x + 1
}</code></pre>
<h2 id="arguments-are-passed-by-value-1"><a class="header" href="#arguments-are-passed-by-value-1">Arguments are Passed by Value</a></h2>
<p>Functions with the same name and same <em>number</em> of parameters are equivalent.</p>
<p>All arguments are passed by <em>value</em>, so all Rhai script-defined functions are <em>pure</em>
(i.e. they never modify their arguments).</p>
<p>Any update to an argument will <strong>not</strong> be reflected back to the caller.</p>
<pre><code class="language-rust">fn change(s) {      // 's' is passed by value
    s = 42;         // only a COPY of 's' is changed
}

let x = 500;

change(x);

x == 500;           // 'x' is NOT changed!</code></pre>
<div id="admonition-rhai-functions-are-pure" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-rhai-functions-are-pure-title">
<div class="admonition-title">
<div id="admonition-rhai-functions-are-pure-title">
<p>Rhai functions are pure</p>
</div>
<a class="admonition-anchor-link" href="ref/functions.html#admonition-rhai-functions-are-pure"></a>
</div>
<div>
<p>The only possibility for a Rhai script-defined function to modify an external variable is
via the <a href="ref/fn-method.html"><code>this</code></a> pointer.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="this--simulating-an-object-method-1"><a class="header" href="#this--simulating-an-object-method-1"><code>this</code> – Simulating an Object Method</a></h1>
<div id="admonition-functions-are-pure" class="admonition admonish-warning side" role="note" aria-labelledby="admonition-functions-are-pure-title">
<div class="admonition-title">
<div id="admonition-functions-are-pure-title">
<p>Functions are pure</p>
</div>
<a class="admonition-anchor-link" href="ref/fn-method.html#admonition-functions-are-pure"></a>
</div>
<div>
<p>The only way for a script-defined <a href="ref/functions.html">function</a> to change an external value is via <code>this</code>.</p>
</div>
</div>
<p>Arguments passed to script-defined <a href="ref/functions.html">functions</a> are always by <em>value</em> because
<a href="ref/functions.html">functions</a> are <em>pure</em>.</p>
<p>However, <a href="ref/functions.html">functions</a> can also be called in <em>method-call</em> style:</p>
<blockquote>
<p><em>object</em> <code>.</code> <em>method</em> <code>(</code> <em>parameters</em> … <code>)</code></p>
</blockquote>
<p>When a <a href="ref/functions.html">function</a> is called this way, the keyword <code>this</code> binds to the object in the
method call and can be changed.</p>
<pre><code class="language-rust">fn change() {       // note that the method does not need a parameter
    this = 42;      // 'this' binds to the object in method-call
}

let x = 500;

x.change();         // call 'change' in method-call style, 'this' binds to 'x'

x == 42;            // 'x' is changed!

change();           // &lt;- error: 'this' is unbound</code></pre>
<h2 id="elvis-operator-3"><a class="header" href="#elvis-operator-3">Elvis Operator</a></h2>
<p>The <a href="https://en.wikipedia.org/wiki/Elvis_operator"><em>Elvis</em> operator</a> can be used to short-circuit
the method call when the object itself is <code>()</code>.</p>
<blockquote>
<p><em>object</em> <code>?.</code> <em>method</em> <code>(</code> <em>parameters</em> … <code>)</code></p>
</blockquote>
<p>In the above, the <em>method</em> is never called if <em>object</em> is <code>()</code>.</p>
<h2 id="restrict-the-type-of-this-in-function-definitions-1"><a class="header" href="#restrict-the-type-of-this-in-function-definitions-1">Restrict the Type of <code>this</code> in Function Definitions</a></h2>
<div id="admonition-tip-automatically-global" class="admonition admonish-tip side wide" role="note" aria-labelledby="admonition-tip-automatically-global-title">
<div class="admonition-title">
<div id="admonition-tip-automatically-global-title">
<p>Tip: Automatically global</p>
</div>
<a class="admonition-anchor-link" href="ref/fn-method.html#admonition-tip-automatically-global"></a>
</div>
<div>
<p>Methods defined this way are automatically exposed to the global namespace.</p>
</div>
</div>
<p>In many cases it may be desirable to implement <em>methods</em> for different custom types using
script-defined <a href="ref/functions.html">functions</a>.</p>
<h3 id="the-problem-2"><a class="header" href="#the-problem-2">The Problem</a></h3>
<p>Doing so is brittle and requires a lot of type checking code because there can only be one
<a href="ref/functions.html">function</a> definition for the same name and arity:</p>
<pre><code class="language-js">// Really painful way to define a method called 'do_update' on various data types
fn do_update(x) {
    switch type_of(this) {
        "i64" =&gt; this *= x,
        "string" =&gt; this.len += x,
        "bool" if this =&gt; this *= x,
        "bool" =&gt; this *= 42,
        "MyType" =&gt; this.update(x),
        "Strange-Type#Name::with_!@#symbols" =&gt; this.update(x),
        _ =&gt; throw `I don't know how to handle ${type_of(this)}`!`
    }
}
</code></pre>
<h3 id="the-solution-2"><a class="header" href="#the-solution-2">The Solution</a></h3>
<p>With a special syntax, it is possible to restrict a <a href="ref/functions.html">function</a> to be callable only
when the object pointed to by <code>this</code> is of a certain type:</p>
<blockquote>
<p><code>fn</code>  <em>type name</em> <code>.</code> <em>method</em> <code>(</code> <em>parameters</em> … <code>)  {</code>  …  <code>}</code></p>
</blockquote>
<p>or in quotes if the type name is not a valid identifier itself:</p>
<blockquote>
<p><code>fn</code>  <code>"</code><em>type name string</em><code>"</code> <code>.</code> <em>method</em> <code>(</code> <em>parameters</em> … <code>)  {</code>  …  <code>}</code></p>
</blockquote>
<div id="admonition-type-name-must-be-the-same-as-type_of" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-type-name-must-be-the-same-as-type_of-title">
<div class="admonition-title">
<div id="admonition-type-name-must-be-the-same-as-type_of-title">
<p>Type name must be the same as <code>type_of</code></p>
</div>
<a class="admonition-anchor-link" href="ref/fn-method.html#admonition-type-name-must-be-the-same-as-type_of"></a>
</div>
<div>
<p>The <em>type name</em> specified in front of the <a href="ref/functions.html">function</a> name must match the output of
<a href="ref/type-of.html"><code>type_of</code></a> for the required type.</p>
</div>
</div>
<div id="admonition-tip-int-and-float" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-int-and-float-title">
<div class="admonition-title">
<div id="admonition-tip-int-and-float-title">
<p>Tip: <code>int</code> and <code>float</code></p>
</div>
<a class="admonition-anchor-link" href="ref/fn-method.html#admonition-tip-int-and-float"></a>
</div>
<div>
<p><code>int</code> can be used in place of the system integer type (usually <code>i64</code> or <code>i32</code>).</p>
<p><code>float</code> can be used in place of the system floating-point type (usually <code>f64</code> or <code>f32</code>).</p>
<p>Using these make scripts more portable.</p>
</div>
</div>
<h3 id="examples-27"><a class="header" href="#examples-27">Examples</a></h3>
<pre><code class="language-js">/// This 'do_update' can only be called on objects of type 'MyType' in method style
fn MyType.do_update(x, y) {
    this.update(x * y);
}

/// This 'do_update' can only be called on objects of type 'Strange-Type#Name::with_!@#symbols'
/// (which can be specified via 'Engine::register_type_with_name') in method style
fn "Strange-Type#Name::with_!@#symbols".do_update(x, y) {
    this.update(x * y);
}

/// Define a blanket version
fn do_update(x, y) {
    this = `${this}, ${x}, ${y}`;
}

/// This 'do_update' can only be called on integers in method style
fn int.do_update(x, y) {
    this += x * y
}

let obj = create_my_type();     // 'x' is 'MyType'

obj.type_of() == "MyType";

obj.do_update(42, 123);         // ok!

let x = 42;                     // 'x' is an integer

x.type_of() == "i64";

x.do_update(42, 123);           // ok!

let x = true;                   // 'x' is a boolean

x.type_of() == "bool";

x.do_update(42, 123);           // &lt;- this works because there is a blanket version

// Use 'is_def_fn' with three parameters to test for typed methods
is_def_fn("MyType", "do_update", 2) == true;

is_def_fn("int", "do_update", 2) == true;
</code></pre>
<h2 id="bind-to-this-for-module-functions-1"><a class="header" href="#bind-to-this-for-module-functions-1">Bind to <code>this</code> for Module Functions</a></h2>
<h3 id="the-problem-3"><a class="header" href="#the-problem-3">The Problem</a></h3>
<p>The <em>method-call</em> syntax is not possible for <a href="ref/functions.html">functions</a> <a href="ref/modules/import.html">imported</a>
from <a href="ref/modules/index.html">modules</a>.</p>
<pre><code class="language-js">import "my_module" as foo;

let x = 42;

x.foo::change_value(1);     // &lt;- syntax error
</code></pre>
<h3 id="the-solution-3"><a class="header" href="#the-solution-3">The Solution</a></h3>
<p>In order to call a <a href="ref/modules/index.html">module</a> <a href="ref/functions.html">function</a> as a method, it must be
defined with a restriction on the type of object pointed to by <code>this</code>:</p>
<pre><code class="language-js">┌────────────────┐
│ my_module.rhai │
└────────────────┘

// This is a typed method function requiring 'this' to be an integer.
// Typed methods are automatically marked global when importing this module.
fn int.change_value(offset) {
    // 'this' is guaranteed to be an integer
    this += offset;
}


┌───────────┐
│ main.rhai │
└───────────┘

import "my_module";

let x = 42;

x.change_value(1);          // ok!

x == 43;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="function-overloading-2"><a class="header" href="#function-overloading-2">Function Overloading</a></h1>
<p><a href="ref/functions.html">Functions</a> defined in script can be <em>overloaded</em> by <em>arity</em> (i.e. they are resolved
purely upon the function’s <em>name</em> and <em>number</em> of parameters, but not parameter <em>types</em> since all
parameters are dynamic).</p>
<p>New definitions <em>overwrite</em> previous definitions of the same name and number of parameters.</p>
<pre><code class="language-js">fn foo(x, y, z) {
    print(`Three!!! ${x}, ${y}, ${z}`);
}
fn foo(x) {
    print(`One! ${x}`);
}
fn foo(x, y) {
    print(`Two! ${x}, ${y}`);
}
fn foo() {
    print("None.");
}
fn foo(x) {     // &lt;- overwrites previous definition
    print(`HA! NEW ONE! ${x}`);
}

foo(1,2,3);     // prints "Three!!! 1,2,3"

foo(42);        // prints "HA! NEW ONE! 42"

foo(1,2);       // prints "Two!! 1,2"

foo();          // prints "None."
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="function-pointers-1"><a class="header" href="#function-pointers-1">Function Pointers</a></h1>
<p>It is possible to store a <em>function pointer</em> in a variable just like a normal value.</p>
<p>A function pointer is created via the <code>Fn</code> function, which takes a <a href="ref/strings-chars.html">string</a> parameter.</p>
<p>Call a function pointer via the <code>call</code> method.</p>
<h2 id="short-hand-notation-1"><a class="header" href="#short-hand-notation-1">Short-Hand Notation</a></h2>
<div id="admonition-not-for-native" class="admonition admonish-warning side" role="note" aria-labelledby="admonition-not-for-native-title">
<div class="admonition-title">
<div id="admonition-not-for-native-title">
<p>Not for native</p>
</div>
<a class="admonition-anchor-link" href="ref/fn-ptr.html#admonition-not-for-native"></a>
</div>
<div>
<p>Native Rust functions cannot use this short-hand notation.</p>
</div>
</div>
<p>Having to write <code>Fn("foo")</code> in order to create a function pointer to the <a href="ref/functions.html">function</a>
<code>foo</code> is a chore, so there is a short-hand available.</p>
<p>A function pointer to any <em>script-defined</em> <a href="ref/functions.html">function</a> <em>within the same script</em> can be
obtained simply by referring to the <a href="ref/functions.html">function’s</a> name.</p>
<pre><code class="language-rust">fn foo() { ... }        // function definition

let f = foo;            // function pointer to 'foo'

let f = Fn("foo");      // &lt;- the above is equivalent to this

let g = bar;            // error: variable 'bar' not found</code></pre>
<p>The short-hand notation is particularly useful when passing <a href="ref/functions.html">functions</a> as
<a href="ref/fn-closure.html">closure</a> arguments.</p>
<pre><code class="language-rust">fn is_even(n) { n % 2 == 0 }

let array = [1, 2, 3, 4, 5];

array.filter(is_even);

array.filter(Fn("is_even"));    // &lt;- the above is equivalent to this

array.filter(|n| n % 2 == 0);   // &lt;- ... or this</code></pre>
<h2 id="built-in-functions-12"><a class="header" href="#built-in-functions-12">Built-in Functions</a></h2>
<p>The following standard methods operate on function pointers.</p>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Parameter(s)</th><th>Description</th></tr></thead><tbody>
<tr><td><code>name</code> method and property</td><td><em>none</em></td><td>returns the name of the <a href="ref/functions.html">function</a> encapsulated by the function pointer</td></tr>
<tr><td><code>is_anonymous</code> method and property</td><td><em>none</em></td><td>does the function pointer refer to an <a href="ref/fn-anon.html">anonymous function</a>?</td></tr>
<tr><td><code>call</code></td><td><em>arguments</em></td><td>calls the <a href="ref/functions.html">function</a> matching the function pointer’s name with the <em>arguments</em></td></tr>
</tbody></table>
</div>
<h2 id="examples-28"><a class="header" href="#examples-28">Examples</a></h2>
<pre><code class="language-rust">fn foo(x) { 41 + x }

let func = Fn("foo");       // use the 'Fn' function to create a function pointer

let func = foo;             // &lt;- short-hand: equivalent to 'Fn("foo")'

print(func);                // prints 'Fn(foo)'

let func = fn_name.Fn();    // &lt;- error: 'Fn' cannot be called in method-call style

func.type_of() == "Fn";     // type_of() as function pointer is 'Fn'

func.name == "foo";

func.call(1) == 42;         // call a function pointer with the 'call' method

foo(1) == 42;               // &lt;- the above de-sugars to this

call(func, 1);              // normal function call style also works for 'call'

let len = Fn("len");        // 'Fn' also works with registered native Rust functions

len.call("hello") == 5;

let fn_name = "hello";      // the function name does not have to exist yet

let hello = Fn(fn_name + "_world");

hello.call(0);              // error: function not found - 'hello_world (i64)'</code></pre>
<div id="admonition-not-first-class-functions" class="admonition admonish-warning" role="note" aria-labelledby="admonition-not-first-class-functions-title">
<div class="admonition-title">
<div id="admonition-not-first-class-functions-title">
<p>Not First-Class Functions</p>
</div>
<a class="admonition-anchor-link" href="ref/fn-ptr.html#admonition-not-first-class-functions"></a>
</div>
<div>
<p>Beware that function pointers are <em>not</em> first-class functions.</p>
<p>They are <em>syntactic sugar</em> only, capturing only the <em>name</em> of a <a href="ref/functions.html">function</a> to call.
They do not hold the actual <a href="ref/functions.html">functions</a>.</p>
<p>The actual <a href="ref/functions.html">function</a> must be defined in the appropriate namespace for the call to
succeed.</p>
</div>
</div>
<div id="admonition-global-namespace-only" class="admonition admonish-warning" role="note" aria-labelledby="admonition-global-namespace-only-title">
<div class="admonition-title">
<div id="admonition-global-namespace-only-title">
<p>Global Namespace Only</p>
</div>
<a class="admonition-anchor-link" href="ref/fn-ptr.html#admonition-global-namespace-only"></a>
</div>
<div>
<p>Because of their dynamic nature, function pointers cannot refer to functions in
<a href="ref/modules/import.html"><code>import</code></a>-ed <a href="ref/modules/index.html">modules</a>.</p>
<p>They can only refer to <a href="ref/functions.html">functions</a> defined globally within the script
or a built-in function.</p>
<pre><code class="language-js">import "foo" as f;          // assume there is 'f::do_work()'

f::do_work();               // works!

let p = Fn("f::do_work");   // error: invalid function name

fn do_work_now() {          // call it from a local function
    f::do_work();
}

let p = Fn("do_work_now");

p.call();                   // works!
</code></pre>
</div>
</div>
<h2 id="dynamic-dispatch-1"><a class="header" href="#dynamic-dispatch-1">Dynamic Dispatch</a></h2>
<p>The purpose of function pointers is to enable rudimentary <em>dynamic dispatch</em>, meaning to determine,
at runtime, which function to call among a group.</p>
<p>Although it is possible to simulate dynamic dispatch via a number and a large
<a href="ref/if.html"><code>if-then-else-if</code></a> statement, using function pointers significantly simplifies the code.</p>
<pre><code class="language-rust">let x = some_calculation();

// These are the functions to call depending on the value of 'x'
fn method1(x) { ... }
fn method2(x) { ... }
fn method3(x) { ... }

// Traditional - using decision variable
let func = sign(x);

// Dispatch with if-statement
if func == -1 {
    method1(42);
} else if func == 0 {
    method2(42);
} else if func == 1 {
    method3(42);
}

// Using pure function pointer
let func = if x &lt; 0 {
    method1
} else if x == 0 {
    method2
} else if x &gt; 0 {
    method3
};

// Dynamic dispatch
func.call(42);

// Using functions map
let map = [ method1, method2, method3 ];

let func = sign(x) + 1;

// Dynamic dispatch
map[func].call(42);</code></pre>
<h2 id="bind-the-this-pointer-2"><a class="header" href="#bind-the-this-pointer-2">Bind the <code>this</code> Pointer</a></h2>
<p>When <code>call</code> is called as a <em>method</em> but not on a function pointer, it is possible to dynamically dispatch
to a function call while binding the object in the method call to the <code>this</code> pointer of the function.</p>
<p>To achieve this, pass the function pointer as the <em>first</em> argument to <code>call</code>:</p>
<pre><code class="language-rust">fn add(x) {                 // define function which uses 'this'
    this += x;
}

let func = add;             // function pointer to 'add'

func.call(1);               // error: 'this' pointer is not bound

let x = 41;

func.call(x, 1);            // error: function 'add (i64, i64)' not found

call(func, x, 1);           // error: function 'add (i64, i64)' not found

x.call(func, 1);            // 'this' is bound to 'x', dispatched to 'func'

x == 42;</code></pre>
<p>Beware that this only works for <a href="ref/fn-method.html"><em>method-call</em></a> style.
Normal function-call style cannot bind the <code>this</code> pointer (for syntactic reasons).</p>
<h2 id="currying"><a class="header" href="#currying">Currying</a></h2>
<p>It is possible to <em>curry</em> a function pointer by providing partial (or all) arguments.</p>
<p>Currying is done via the <code>curry</code> keyword and produces a new function pointer which carries the
curried arguments.</p>
<p>When the curried function pointer is called, the curried arguments are inserted starting from the <em>left</em>.</p>
<p>The actual call arguments should be reduced by the number of curried arguments.</p>
<pre><code class="language-rust">fn mul(x, y) {                  // function with two parameters
    x * y
}

let func = mul;                 // &lt;- de-sugars to 'Fn("mul")'

func.call(21, 2) == 42;         // two arguments are required for 'mul'

let curried = func.curry(21);   // currying produces a new function pointer which
                                // carries 21 as the first argument

let curried = curry(func, 21);  // function-call style also works

curried.call(2) == 42;          // &lt;- de-sugars to 'func.call(21, 2)'
                                //    only one argument is now required</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="closures-1"><a class="header" href="#closures-1">Closures</a></h1>
<p>Many functions in the standard API expect <a href="ref/fn-ptr.html">function pointer</a> as parameters.</p>
<p>For example:</p>
<pre><code class="language-rust">// Function 'double' defined here - used only once
fn double(x) { 2 * x }

// Function 'square' defined here - again used only once
fn square(x) { x * x }

let x = [1, 2, 3, 4, 5];

// Pass a function pointer to 'double'
let y = x.map(double);

// Pass a function pointer to 'square' using Fn(...) notation
let z = y.map(Fn("square"));</code></pre>
<p>Sometimes it gets tedious to define separate <a href="ref/functions.html">functions</a> only to dispatch them via
single <a href="ref/fn-ptr.html">function pointers</a> – essentially, those <a href="ref/functions.html">functions</a> are only
ever called in one place.</p>
<p>This scenario is especially common when simulating object-oriented programming ([OOP]).</p>
<pre><code class="language-rust">// Define functions one-by-one
fn obj_inc(x, y) { this.data += x * y; }
fn obj_dec(x) { this.data -= x; }
fn obj_print() { print(this.data); }

// Define object
let obj = #{
    data: 42,
    increment: obj_inc,     // use function pointers to
    decrement: obj_dec,     // refer to method functions
    print: obj_print
};</code></pre>
<h2 id="syntax-7"><a class="header" href="#syntax-7">Syntax</a></h2>
<p>Closures have a syntax similar to Rust’s <em>closures</em> (they are <em>not</em> the same).</p>
<blockquote>
<p><code>|</code><em>param 1</em><code>,</code> <em>param 2</em><code>,</code> … <code>,</code> <em>param n</em><code>|</code> <em>statement</em></p>
<p><code>|</code><em>param 1</em><code>,</code> <em>param 2</em><code>,</code> … <code>,</code> <em>param n</em><code>| {</code> <em>statements</em>… <code>}</code></p>
</blockquote>
<p>No parameters:</p>
<blockquote>
<p><code>||</code> <em>statement</em></p>
<p><code>|| {</code> <em>statements</em>… <code>}</code></p>
</blockquote>
<h2 id="rewrite-using-closures"><a class="header" href="#rewrite-using-closures">Rewrite Using Closures</a></h2>
<p>The above can be rewritten using closures.</p>
<pre><code class="language-rust">let x = [1, 2, 3, 4, 5];

let y = x.map(|x| 2 * x);

let z = y.map(|x| x * x);

let obj = #{
    data: 42,
    increment: |x, y| this.data += x * y,   // one statement
    decrement: |x| this.data -= x,          // one statement
    print_obj: || {
        print(this.data);                   // full function body
    }
};</code></pre>
<p>This de-sugars to:</p>
<pre><code class="language-rust">// Automatically generated...
fn anon_fn_0001(x) { 2 * x }
fn anon_fn_0002(x) { x * x }
fn anon_fn_0003(x, y) { this.data += x * y; }
fn anon_fn_0004(x) { this.data -= x; }
fn anon_fn_0005() { print(this.data); }

let x = [1, 2, 3, 4, 5];

let y = x.map(anon_fn_0001);

let z = y.map(anon_fn_0002);

let obj = #{
    data: 42,
    increment: anon_fn_0003,
    decrement: anon_fn_0004,
    print: anon_fn_0005
};</code></pre>
<h2 id="capture-external-variables"><a class="header" href="#capture-external-variables">Capture External Variables</a></h2>
<div id="admonition-tip-is_shared" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-is_shared-title">
<div class="admonition-title">
<div id="admonition-tip-is_shared-title">
<p>Tip: <code>is_shared</code></p>
</div>
<a class="admonition-anchor-link" href="ref/fn-closure.html#admonition-tip-is_shared"></a>
</div>
<div>
<p>Use <code>is_shared</code> to check whether a particular dynamic value is shared.</p>
</div>
</div>
<p>Closures differ from standard functions because they can <em>captures</em> <a href="ref/variables.html">variables</a> that
are not defined within the current scope, but are instead defined in an external scope – i.e.
where the it is created.</p>
<p>All <a href="ref/variables.html">variables</a> that are accessible during the time the closure is created are
automatically captured when they are used, as long as they are not shadowed by local
<a href="ref/variables.html">variables</a> defined within the function’s.</p>
<p>The captured <a href="ref/variables.html">variables</a> are automatically converted into <strong>reference-counted shared values</strong>.</p>
<p>Therefore, similar to closures in many languages, these captured shared values persist through
reference counting, and may be read or modified even after the <a href="ref/variables.html">variables</a> that hold
them go out of scope and no longer exist.</p>
<pre><code class="language-rust">let x = 1;                          // a normal variable

x.is_shared() == false;

let f = |y| x + y;                  // variable 'x' is auto-curried (captured) into 'f'

x.is_shared() == true;              // 'x' is now a shared value!

f.call(2) == 3;                     // 1 + 2 == 3

x = 40;                             // changing 'x'...

f.call(2) == 42;                    // the value of 'x' is 40 because 'x' is shared

// The above de-sugars into something like this:

fn anon_0001(x, y) { x + y }        // parameter 'x' is inserted

make_shared(x);                     // convert variable 'x' into a shared value

let f = anon_0001.curry(x);         // shared 'x' is curried</code></pre>
<div id="admonition-beware-captured-variables-are-truly-shared" class="admonition admonish-bug" role="note" aria-labelledby="admonition-beware-captured-variables-are-truly-shared-title">
<div class="admonition-title">
<div id="admonition-beware-captured-variables-are-truly-shared-title">
<p>Beware: Captured variables are truly shared</p>
</div>
<a class="admonition-anchor-link" href="ref/fn-closure.html#admonition-beware-captured-variables-are-truly-shared"></a>
</div>
<div>
<p>The example below is a typical tutorial sample for many languages to illustrate the traps
that may accompany capturing external <a href="ref/variables.html">variables</a> in closures.</p>
<p>It prints <code>9</code>, <code>9</code>, <code>9</code>, … <code>9</code>, <code>9</code>, not <code>0</code>, <code>1</code>, <code>2</code>, … <code>8</code>, <code>9</code>, because there is ever only
<em>one</em> captured <a href="ref/variables.html">variable</a>, and all ten closures capture the <em>same</em>
<a href="ref/variables.html">variable</a>.</p>
<pre><code class="language-rust">let list = [];

for i in 0..10 {
    list.push(|| print(i));     // the for loop variable 'i' is captured
}

list.len() == 10;               // 10 closures stored in the array

list[0].type_of() == "Fn";      // make sure these are closures

for f in list {
    f.call();                   // all references to 'i' point to the same variable!
}</code></pre>
</div>
</div>
<div id="admonition-prevent-data-races" class="admonition admonish-danger" role="note" aria-labelledby="admonition-prevent-data-races-title">
<div class="admonition-title">
<div id="admonition-prevent-data-races-title">
<p>Prevent data races</p>
</div>
<a class="admonition-anchor-link" href="ref/fn-closure.html#admonition-prevent-data-races"></a>
</div>
<div>
<p>Data races are possible in Rhai scripts.</p>
<p>Avoid performing a method call on a captured shared <a href="ref/variables.html">variable</a> (which essentially
takes a mutable reference to the shared object) while using that same <a href="ref/variables.html">variable</a> as a
parameter in the method call – this is a sure-fire way to generate a data race error.</p>
<p>If a shared value is used as the <code>this</code> pointer in a method call to a closure function,
then the same shared value <em>must not</em> be captured inside that function, or a data race
will occur and the script will terminate with an error.</p>
<pre><code class="language-rust">let x = 20;

x.is_shared() == false;         // 'x' not shared, so no data races

let f = |a| this += x + a;      // 'x' is captured in this closure

x.is_shared() == true;          // now 'x' is shared

x.call(f, 2);                   // &lt;- error: data race detected on 'x'</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="functions-metadata-1"><a class="header" href="#functions-metadata-1">Functions Metadata</a></h1>
<p>The <em>metadata</em> of a <a href="ref/functions.html">function</a> means all relevant information related to a
<a href="ref/functions.html">function’s</a> definition including:</p>
<ol>
<li>
<p>Its callable name</p>
</li>
<li>
<p>Its access mode (public or <a href="ref/modules/export.html">private</a>)</p>
</li>
<li>
<p>Its parameter names (if any)</p>
</li>
<li>
<p>Its purpose, in the form of <a href="ref/comments.html">doc-comments</a></p>
</li>
<li>
<p>Usage notes, warnings, examples etc., in the form of <a href="ref/comments.html">doc-comments</a></p>
</li>
</ol>
<p>A <a href="ref/functions.html">function’s</a> <em>signature</em> encapsulates the first three pieces of information in a
single concise line of definition:</p>
<blockquote>
<p><code>[private]</code> <em>name</em> <code>(</code><em>param 1</em><code>,</code> <em>param 2</em><code>,</code> … <code>,</code> <em>param n</em> <code>)</code></p>
</blockquote>
<h1 id="get-functions-metadata"><a class="header" href="#get-functions-metadata">Get Functions Metadata</a></h1>
<p>The built-in <a href="ref/functions.html">function</a> <code>get_fn_metadata_list</code> returns an <a href="ref/arrays">array</a> of <a href="ref/object-maps.html">object
maps</a>, each containing the metadata of one script-defined <a href="ref/functions.html">function</a>
in scope.</p>
<p><code>get_fn_metadata_list</code> has a few versions taking different parameters:</p>
<div class="table-wrapper"><table><thead><tr><th>Signature</th><th>Description</th></tr></thead><tbody>
<tr><td><code>get_fn_metadata_list()</code></td><td>returns an <a href="ref/arrays.html">array</a> for <em>all</em> script-defined <a href="ref/functions.html">functions</a></td></tr>
<tr><td><code>get_fn_metadata_list(name)</code></td><td>returns an <a href="ref/arrays.html">array</a> containing all script-defined <a href="ref/functions.html">functions</a> matching a specified name</td></tr>
<tr><td><code>get_fn_metadata_list(name, params)</code></td><td>returns an <a href="ref/arrays.html">array</a> containing all script-defined <a href="ref/functions.html">functions</a> matching a specified name and accepting the specified number of parameters</td></tr>
</tbody></table>
</div>
<p>The return value is an <a href="ref/arrays.html">array</a> of <a href="ref/object-maps.html">object maps</a> containing the following fields.</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th style="text-align: center">Type</th><th style="text-align: center">Optional?</th><th>Description</th></tr></thead><tbody>
<tr><td><code>namespace</code></td><td style="text-align: center"><a href="ref/strings-chars.html">string</a></td><td style="text-align: center"><strong>yes</strong></td><td>the module <em>namespace</em> if the <a href="ref/functions.html">function</a> is defined within a <a href="ref/modules/index.html">module</a></td></tr>
<tr><td><code>access</code></td><td style="text-align: center"><a href="ref/strings-chars.html">string</a></td><td style="text-align: center">no</td><td><code>"public"</code> if the function is public,<br/><code>"private"</code> if it is <a href="ref/modules/export.html">private</a></td></tr>
<tr><td><code>name</code></td><td style="text-align: center"><a href="ref/strings-chars.html">string</a></td><td style="text-align: center">no</td><td><a href="ref/functions.html">function</a> name</td></tr>
<tr><td><code>params</code></td><td style="text-align: center"><a href="ref/arrays.html">array</a> of <a href="ref/strings-chars.html">strings</a></td><td style="text-align: center">no</td><td>parameter names</td></tr>
<tr><td><code>this_type</code></td><td style="text-align: center"><a href="ref/strings-chars.html">string</a></td><td style="text-align: center"><strong>yes</strong></td><td>restrict the type of <code>this</code> if the <a href="ref/functions.html">function</a> is a <a href="ref/fn_methods.html">method</a></td></tr>
<tr><td><code>is_anonymous</code></td><td style="text-align: center"><code>bool</code></td><td style="text-align: center">no</td><td>is this <a href="ref/functions.html">function</a> an <a href="ref/fn-anon.html">anonymous function</a>?</td></tr>
<tr><td><code>comments</code></td><td style="text-align: center"><a href="ref/arrays.html">array</a> of <a href="ref/strings-chars.html">strings</a></td><td style="text-align: center"><strong>yes</strong></td><td><a href="ref/comments.html">doc-comments</a>, if any, one per line</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="print-and-debug-1"><a class="header" href="#print-and-debug-1"><code>print</code> and <code>debug</code></a></h1>
<p>The <code>print</code> and <code>debug</code> functions can be used to output values.</p>
<pre><code class="language-js">print("hello");         // prints "hello" to stdout

print(1 + 2 + 3);       // prints "6" to stdout

let x = 42;

print(`hello${x}`);     // prints "hello42" to stdout

debug("world!");        // prints "world!" to stdout using debug formatting
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="modules-2"><a class="header" href="#modules-2">Modules</a></h1>
<p>Rhai allows organizing code into <em>modules</em>.</p>
<p>A module holds a collection of <a href="ref/modules/../functions.html">functions</a>, <a href="ref/modules/../constants.html">constants</a> and sub-modules.</p>
<p>It may encapsulates a Rhai script together with the <a href="ref/modules/../functions.html">functions</a> and
<a href="ref/modules/../constants.html">constants</a> defined by that script.</p>
<p>Other scripts can then load this module and use the <a href="ref/modules/../functions.html">functions</a> and
<a href="ref/modules/../constants.html">constants</a> exported as if they were defined inside the same script.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="export-variables-functions-and-sub-modules-from-a-script-1"><a class="header" href="#export-variables-functions-and-sub-modules-from-a-script-1">Export Variables, Functions and Sub-Modules From a Script</a></h1>
<p>The easiest way to expose a collection of <a href="ref/modules/../functions.html">functions</a> as a self-contained <a href="ref/modules/index.html">module</a>
is to do it via a Rhai script itself.</p>
<p>The script text is evaluated.</p>
<p><a href="ref/modules/../variables.html">Variables</a> are then selectively exposed via the <code>export</code> statement.</p>
<p><a href="ref/modules/../functions.html">Functions</a> defined by the script are automatically exported, unless marked as <code>private</code>.</p>
<p>Modules loaded within this <a href="ref/modules/index.html">module</a> at the global level become <em>sub-modules</em> and are also
automatically exported.</p>
<h2 id="export-global-constants"><a class="header" href="#export-global-constants">Export Global Constants</a></h2>
<p>The <code>export</code> statement, which can only be at global level, exposes a selected
<a href="ref/modules/../variables.html">variable</a> as member of a <a href="ref/modules/index.html">module</a>.</p>
<p><a href="ref/modules/../variables.html">Variables</a> not exported are <em>private</em> and hidden. They are merely used to
initialize the <a href="ref/modules/index.html">module</a>, but cannot be accessed from outside.</p>
<p>Everything exported from a <a href="ref/modules/index.html">module</a> is <strong><a href="ref/modules/../constants.html">constant</a></strong> (i.e. read-only).</p>
<pre><code class="language-js">// This is a module script.

let hidden = 123;       // variable not exported - default hidden
let x = 42;             // this will be exported below

export x;               // the variable 'x' is exported under its own name

export const x = 42;    // convenient short-hand to declare a constant and export it
                        // under its own name

export let x = 123;     // variables can be exported as well, though it'll still be constant

export x as answer;     // the variable 'x' is exported under the alias 'answer'
                        // another script can load this module and access 'x' as 'module::answer'

{
    let inner = 0;      // local variable - it disappears when the statements block ends,
                        //                  therefore it is not 'global' and cannot be exported

    export inner;       // &lt;- syntax error: cannot export a local variable
}
</code></pre>
<div id="admonition-tip-multiple-exports" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-multiple-exports-title">
<div class="admonition-title">
<div id="admonition-tip-multiple-exports-title">
<p>Tip: Multiple exports</p>
</div>
<a class="admonition-anchor-link" href="ref/modules/export.html#admonition-tip-multiple-exports"></a>
</div>
<div>
<p>[Variables] can be exported under multiple names.
For example, the following exports three [variables]:</p>
<ul>
<li><code>x</code> as <code>x</code> and <code>hello</code></li>
<li><code>y</code> as <code>foo</code> and <code>bar</code></li>
<li><code>z</code> as <code>z</code></li>
</ul>
<pre><code class="language-js">export x;
export x as hello;
export y as foo;
export x as world;
export y as bar;
export z;
</code></pre>
</div>
</div>
<h2 id="export-functions-1"><a class="header" href="#export-functions-1">Export Functions</a></h2>
<div id="admonition-private-functions" class="admonition admonish-info side wide" role="note" aria-labelledby="admonition-private-functions-title">
<div class="admonition-title">
<div id="admonition-private-functions-title">
<p>Private functions</p>
</div>
<a class="admonition-anchor-link" href="ref/modules/export.html#admonition-private-functions"></a>
</div>
<div>
<p><code>private</code> <a href="ref/modules/../functions.html">functions</a> are commonly called within the <a href="ref/modules/index.html">module</a> only.
They cannot be accessed otherwise.</p>
</div>
</div>
<p>All <a href="ref/modules/../functions.html">functions</a> are automatically exported, <em>unless</em> it is explicitly opt-out with
the <code>private</code> prefix.</p>
<p><a href="ref/modules/../functions.html">Functions</a> declared <code>private</code> are hidden to the outside.</p>
<pre><code class="language-rust">// This is a module script.

fn inc(x) { x + 1 }     // script-defined function - default public

private fn foo() {}     // private function - hidden</code></pre>
<h2 id="sub-modules-1"><a class="header" href="#sub-modules-1">Sub-Modules</a></h2>
<p>All loaded <a href="ref/modules/index.html">modules</a> are automatically exported as sub-modules.</p>
<div id="admonition-tip-skip-exporting-a-module" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-skip-exporting-a-module-title">
<div class="admonition-title">
<div id="admonition-tip-skip-exporting-a-module-title">
<p>Tip: Skip exporting a module</p>
</div>
<a class="admonition-anchor-link" href="ref/modules/export.html#admonition-tip-skip-exporting-a-module"></a>
</div>
<div>
<p>To prevent a <a href="ref/modules/index.html">module</a> from being exported, load it inside a block statement
so that it goes away at the end of the block.</p>
<pre><code class="language-js">// This is a module script.

import "hello" as foo;      // &lt;- exported

{
    import "world" as bar;  // &lt;- not exported
}
</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="import-a-module-1"><a class="header" href="#import-a-module-1">Import a Module</a></h1>
<h2 id="import-statement-1"><a class="header" href="#import-statement-1"><code>import</code> Statement</a></h2>
<div id="admonition-tip" class="admonition admonish-tip side wide" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="ref/modules/import.html#admonition-tip"></a>
</div>
<div>
<p>A <a href="ref/modules/index.html">module</a> that is only <code>import</code>-ed but not given any name is simply run.</p>
<p>This is a very simple way to run another script file from within a script.</p>
</div>
</div>
<p>A <a href="ref/modules/index.html">module</a> can be <em>imported</em> via the <code>import</code> statement, and be given a name.</p>
<p>Its members can be accessed via <code>::</code> similar to C++.</p>
<pre><code class="language-js">import "crypto_banner";         // run the script file 'crypto_banner.rhai' without creating an imported module

import "crypto" as lock;        // run the script file 'crypto.rhai' and import it as a module named 'lock'

const SECRET_NUMBER = 42;

let mod_file = `crypto_${SECRET_NUMBER}`;

import mod_file as my_mod;      // load the script file "crypto_42.rhai" and import it as a module named 'my_mod'
                                // notice that module path names can be dynamically constructed!
                                // any expression that evaluates to a string is acceptable after the 'import' keyword

lock::encrypt(secret);          // use functions defined under the module via '::'

lock::hash::sha256(key);        // sub-modules are also supported

print(lock::status);            // module variables are constants

lock::status = "off";           // &lt;- runtime error: cannot modify a constant
</code></pre>
<div id="admonition-imports-are-_scoped_" class="admonition admonish-info" role="note" aria-labelledby="admonition-imports-are-_scoped_-title">
<div class="admonition-title">
<div id="admonition-imports-are-_scoped_-title">
<p>Imports are <em>scoped</em></p>
</div>
<a class="admonition-anchor-link" href="ref/modules/import.html#admonition-imports-are-_scoped_"></a>
</div>
<div>
<p><a href="ref/modules/index.html">Modules</a> imported via <code>import</code> statements are only accessible inside the relevant block scope.</p>
<pre><code class="language-js">import "hacker" as h;           // import module - visible globally

if secured {                    // &lt;- new block scope
    let mod = "crypt";

    import mod + "o" as c;      // import module (the path needs not be a constant string)

    let x = c::encrypt(key);    // use a function in the module

    h::hack(x);                 // global module 'h' is visible here
}                               // &lt;- module 'c' disappears at the end of the block scope

h::hack(something);             // this works as 'h' is visible

c::encrypt(something);          // &lt;- this causes a run-time error because
                                //    module 'c' is no longer available!

fn foo(something) {
    h::hack(something);         // &lt;- this also works as 'h' is visible
}

for x in 0..1000 {
    import "crypto" as c;       // &lt;- importing a module inside a loop is a Very Bad Idea™

    c.encrypt(something);
}
</code></pre>
</div>
</div>
<div id="admonition-place-import-statements-at-the-top" class="admonition admonish-note" role="note" aria-labelledby="admonition-place-import-statements-at-the-top-title">
<div class="admonition-title">
<div id="admonition-place-import-statements-at-the-top-title">
<p>Place <code>import</code> statements at the top</p>
</div>
<a class="admonition-anchor-link" href="ref/modules/import.html#admonition-place-import-statements-at-the-top"></a>
</div>
<div>
<p><code>import</code> statements can appear anywhere a normal statement can be, but in the vast majority of cases they are
usually grouped at the top (beginning) of a script for manageability and visibility.</p>
<p>It is not advised to deviate from this common practice unless there is a <em>Very Good Reason™</em>.</p>
<p>Especially, do not place an <code>import</code> statement within a loop; doing so will repeatedly re-load the
same <a href="ref/modules/index.html">module</a> during every iteration of the loop!</p>
</div>
</div>
<div id="admonition-recursive-imports" class="admonition admonish-danger" role="note" aria-labelledby="admonition-recursive-imports-title">
<div class="admonition-title">
<div id="admonition-recursive-imports-title">
<p>Recursive imports</p>
</div>
<a class="admonition-anchor-link" href="ref/modules/import.html#admonition-recursive-imports"></a>
</div>
<div>
<p>Beware of <em>import cycles</em> – i.e. recursively loading the same <a href="ref/modules/index.html">module</a>.
This is a sure-fire way to cause a stack overflow error.</p>
<p>For instance, importing itself always causes an infinite recursion:</p>
<pre><code class="language-js">┌────────────┐
│ hello.rhai │
└────────────┘

import "hello" as foo;          // import itself - infinite recursion!

foo::do_something();
</code></pre>
<p><a href="ref/modules/index.html">Modules</a> cross-referencing also cause infinite recursion:</p>
<pre><code class="language-js">┌────────────┐
│ hello.rhai │
└────────────┘

import "world" as foo;
foo::do_something();


┌────────────┐
│ world.rhai │
└────────────┘

import "hello" as bar;
bar::do_something_else();
</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="eval-function-1"><a class="header" href="#eval-function-1"><code>eval</code> Function</a></h1>
<h2 id="or-how-to-shoot-yourself-in-the-foot-even-easier-1"><a class="header" href="#or-how-to-shoot-yourself-in-the-foot-even-easier-1">Or “How to Shoot Yourself in the Foot even Easier”</a></h2>
<p>Saving the best for last, there is the ever-dreaded… <code>eval</code> <a href="ref/functions.html">function</a>!</p>
<pre><code class="language-rust">let x = 10;

fn foo(x) { x += 12; x }

let script =
"
    let y = x;
    y += foo(y);
    x + y
";

let result = eval(script);      // &lt;- look, JavaScript, we can also do this!

result == 42;

x == 10;                        // prints 10 - arguments are passed by value
y == 32;                        // prints 32 - variables defined in 'eval' persist!

eval("{ let z = y }");          // to keep a variable local, use a statements block

print(z);                       // &lt;- error: variable 'z' not found

"print(42)".eval();             // &lt;- nope... method-call style doesn't work with 'eval'</code></pre>
<div id="admonition-eval-executes-inside-the-current-scope" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-eval-executes-inside-the-current-scope-title">
<div class="admonition-title">
<div id="admonition-eval-executes-inside-the-current-scope-title">
<p><code>eval</code> executes inside the current scope!</p>
</div>
<a class="admonition-anchor-link" href="ref/eval.html#admonition-eval-executes-inside-the-current-scope"></a>
</div>
<div>
<p>Script segments passed to <code>eval</code> execute inside the <em>current</em> scope, so they can access and modify
<em>everything</em>, including all <a href="ref/variables.html">variables</a> that are visible at that position in code!</p>
<pre><code class="language-rust">let script = "x += 32";

let x = 10;
eval(script);       // variable 'x' is visible!
print(x);           // prints 42

// The above is equivalent to:
let script = "x += 32";
let x = 10;
x += 32;
print(x);</code></pre>
<p><code>eval</code> can also be used to define new <a href="ref/variables.html">variables</a> and do other things normally forbidden inside
a <a href="ref/functions.html">function</a> call.</p>
<pre><code class="language-rust">let script = "let x = 42";
eval(script);
print(x);           // prints 42</code></pre>
<p>Treat it as if the script segments are physically pasted in at the position of the <code>eval</code> call.</p>
</div>
</div>
<div id="admonition-cannot-define-new-functions" class="admonition admonish-warning small" role="note" aria-labelledby="admonition-cannot-define-new-functions-title">
<div class="admonition-title">
<div id="admonition-cannot-define-new-functions-title">
<p>Cannot define new functions</p>
</div>
<a class="admonition-anchor-link" href="ref/eval.html#admonition-cannot-define-new-functions"></a>
</div>
<div>
<p>New <a href="ref/functions.html">functions</a> cannot be defined within an <code>eval</code> call, since <a href="ref/functions.html">functions</a>
can only be defined at the <em>global</em> level!</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="external-tools"><a class="header" href="#external-tools">External Tools</a></h1>
<p>External tools available to work with Rhai.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Tool</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: center"><a href="tools/playground.html">Online Playground</a></td><td>edit and run Rhai scripts in a browser</td></tr>
<tr><td style="text-align: center"><a href="tools/lsp.html">LSP Server</a></td><td>Rhai Language Server</td></tr>
<tr><td style="text-align: center"><a href="tools/rhai-doc.html"><code>rhai-doc</code></a></td><td>generate documentation for Rhai <a href="tools//book/language/functions.html">functions</a></td></tr>
<tr><td style="text-align: center"><a href="tools//book/lib/rhai-dylib.html"><code>rhai-dylib</code></a></td><td>create dynamically loadable Rhai libraries</td></tr>
<tr><td style="text-align: center"><a href="tools//book/lib/rhai-autodocs.html"><code>rhai-autodocs</code></a></td><td>generate <a href="http://en.wikipedia.org/wiki/Markdown">MarkDown</a>/<a href="https://mdxjs.com/docs/what-is-mdx/">MDX</a> API documentation from an <a href="tools//book/engine/hello-world.html"><code>Engine</code></a> instance</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="online-playground-1"><a class="header" href="#online-playground-1">Online Playground</a></h1>
<p>The Online Playground runs off a <a href="tools//book/start/builds/wasm.html">WASM</a> build of Rhai and allows evaluating
Rhai scripts directly within a browser editor window.</p>
<p>Author : <a href="https://github.com/alvinhochun"><code>@alvinhochun</code></a></p>
<p>Repo : <a href="https://github.com/rhaiscript/playground">on GitHub</a></p>
<p>URL : <a href="https://rhai.rs/playground">link to Online Playground</a></p>
<p><a href="https://rhai.rs/playground"><img src="tools//book/images/playground.png" alt="Online Playground" /></a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rhai-language-server"><a class="header" href="#rhai-language-server">Rhai Language Server</a></h1>
<p>Rhai provides a <a href="https://en.wikipedia.org/wiki/Language_Server_Protocol">Language Server Protocol (LSP)</a>
server to work with IDE tools.</p>
<p>Author : <a href="https://github.com/tamasfe"><code>@tamasfe</code></a></p>
<p>Repo : <a href="https://github.com/rhaiscript/lsp">on GitHub</a></p>
<p>URL : <a href="https://github.com/rhaiscript/lsp">link to LSP Server</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rhai-script-documentation-tool"><a class="header" href="#rhai-script-documentation-tool">Rhai Script Documentation Tool</a></h1>
<p>The Rhai Script Documentation Tool, <code>rhai-doc</code>, takes a source directory and scans for
Rhai script files (recursively), building a web-based documentation site for all <a href="tools//book/language/functions.html">functions</a> defined.</p>
<p>Documentation is taken from <a href="http://en.wikipedia.org/wiki/Markdown">MarkDown</a>-formatted <a href="tools//book/language/doc-comments.html">doc-comments</a> on the <a href="tools//book/language/functions.html">functions</a>.</p>
<p>Author: <a href="https://github.com/semirix"><code>@semirix</code></a></p>
<p>Repo: <a href="https://github.com/rhaiscript/rhai-doc">on GitHub</a></p>
<p>Binary: <a href="https://crates.io/crates/rhai-doc">on <code>crates.io</code></a></p>
<p>Example: <a href="https://rhai.rs/rhai-doc">on <code>rhai.rs</code></a></p>
<h2 id="install"><a class="header" href="#install">Install</a></h2>
<pre><code class="language-sh">cargo install rhai-doc
</code></pre>
<h2 id="flags-and-options"><a class="header" href="#flags-and-options">Flags and Options</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Flag/Option</th><th style="text-align: center">Parameter</th><th style="text-align: center">Default</th><th>Description</th></tr></thead><tbody>
<tr><td><code>-h</code>, <code>--help</code></td><td style="text-align: center"></td><td style="text-align: center"></td><td>print help</td></tr>
<tr><td><code>-V</code>, <code>--version</code></td><td style="text-align: center"></td><td style="text-align: center"></td><td>print version</td></tr>
<tr><td><code>-a</code>, <code>--all</code></td><td style="text-align: center"></td><td style="text-align: center"></td><td>generate documentation for all functions, including <a href="tools//book/language/modules/export.html"><code>private</code></a> ones <em>(default false)</em></td></tr>
<tr><td><code>-v</code></td><td style="text-align: center"></td><td style="text-align: center"></td><td>use multiple to set verbosity: 1=silent, 2,3 <em>(default)</em>=full</td></tr>
<tr><td><code>-c</code>, <code>--config</code></td><td style="text-align: center"><em>&lt;file&gt;</em></td><td style="text-align: center"><code>rhai.toml</code></td><td>set configuration file</td></tr>
<tr><td><code>-D</code>, <code>--dest</code></td><td style="text-align: center"><em>&lt;directory&gt;</em></td><td style="text-align: center"><code>dist</code></td><td>set destination directory for documentation output</td></tr>
<tr><td><code>-d</code>, <code>--dir</code></td><td style="text-align: center"><em>&lt;directory&gt;</em></td><td style="text-align: center">current directory</td><td>set source directory for Rhai scripts</td></tr>
<tr><td><code>-p</code>, <code>--pages</code></td><td style="text-align: center"><em>&lt;directory&gt;</em></td><td style="text-align: center"><code>pages</code></td><td>set source directory for additional <a href="http://en.wikipedia.org/wiki/Markdown">MarkDown</a> page files to include</td></tr>
</tbody></table>
</div>
<h2 id="commands"><a class="header" href="#commands">Commands</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Command</th><th>Description</th><th>Example</th></tr></thead><tbody>
<tr><td><em>none</em></td><td>generate documentation</td><td><code>rhai-doc</code></td></tr>
<tr><td><code>new</code></td><td>create a skeleton <code>rhai.toml</code> in the source directory</td><td><code>rhai-doc new</code></td></tr>
</tbody></table>
</div>
<h2 id="configuration-file"><a class="header" href="#configuration-file">Configuration file</a></h2>
<p>A configuration file, which is usually named <code>rhai.toml</code>, contains configuration options for
<code>rhai-doc</code> and must be placed in the source directory.</p>
<p>A skeleton <code>rhai.toml</code> can be generated inside the source directory via the <code>new</code> command.</p>
<p>An alternate configuration file can be specified via the <code>--config</code> option.</p>
<h3 id="example-27"><a class="header" href="#example-27">Example</a></h3>
<pre><code class="language-toml">name = "My Rhai Project"                # project name
color = [246, 119, 2]                   # theme color
root = "/docs/"                         # root URL for generated site
index = "home.md"                       # this file becomes 'index.html'
icon = "logo.svg"                       # project icon
stylesheet = "my_stylesheet.css"        # custom stylesheet
code_theme = "atom-one-light"           # 'highlight.js' theme
code_lang = "ts"                        # default language for code blocks
extension = "rhai"                      # script extension
google_analytics = "G-ABCDEF1234"       # Google Analytics ID

[[links]]                               # external link for 'Blog'
name = "Blog"
link = "https://example.com/blog"

[[links]]                               # external link for 'Tools'
name = "Tools"
link = "https://example.com/tools"
</code></pre>
<h2 id="configuration-options"><a class="header" href="#configuration-options">Configuration Options</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Option</th><th>Value type</th><th style="text-align: center">Default</th><th>Description</th></tr></thead><tbody>
<tr><td><code>name</code></td><td>string</td><td style="text-align: center"><em>none</em></td><td>name of project – used as titles on documentation pages</td></tr>
<tr><td><code>color</code></td><td>RGB values (0-255) array</td><td style="text-align: center"><code>[246, 119, 2]</code></td><td>theme color for generated documentation</td></tr>
<tr><td><code>root</code></td><td>URL string</td><td style="text-align: center"><em>none</em></td><td>root URL generated as part of documentation</td></tr>
<tr><td><code>index</code></td><td>file path</td><td style="text-align: center"><em>none</em></td><td>main <a href="http://en.wikipedia.org/wiki/Markdown">MarkDown</a> file – becomes <code>index.html</code></td></tr>
<tr><td><code>icon</code></td><td>file path</td><td style="text-align: center">Rhai icon</td><td>project icon</td></tr>
<tr><td><code>stylesheet</code></td><td>file path</td><td style="text-align: center"><em>none</em></td><td>custom stylesheet</td></tr>
<tr><td><code>code_theme</code></td><td>theme string</td><td style="text-align: center"><code>default</code></td><td><a href="https://highlightjs.org/"><code>highlight.js</code></a> theme for syntax highlighting in code blocks</td></tr>
<tr><td><code>code_lang</code></td><td>language string</td><td style="text-align: center"><code>ts</code></td><td>default language for code blocks</td></tr>
<tr><td><code>extension</code></td><td>extension string</td><td style="text-align: center"><code>.rhai</code></td><td>script files extension (default <code>.rhai</code>)</td></tr>
<tr><td><code>google_analytics</code></td><td>ID string</td><td style="text-align: center"><em>none</em></td><td><a href="https://analytics.google.com">Google Analytics</a> ID</td></tr>
<tr><td><code>[[links]]</code></td><td>table</td><td style="text-align: center"><em>none</em></td><td>external links</td></tr>
<tr><td>• <code>name</code></td><td>string</td><td style="text-align: center"><em>none</em></td><td>• title of external link</td></tr>
<tr><td>• <code>link</code></td><td>URL string</td><td style="text-align: center"><em>none</em></td><td>• URL of external link</td></tr>
</tbody></table>
</div><div id="admonition-markdown-pages" class="admonition admonish-abstract small" role="note" aria-labelledby="admonition-markdown-pages-title">
<div class="admonition-title">
<div id="admonition-markdown-pages-title">
<p>MarkDown pages</p>
</div>
<a class="admonition-anchor-link" href="tools/rhai-doc.html#admonition-markdown-pages"></a>
</div>
<div>
<p>By default, <code>rhai-doc</code> will generate documentation pages from a <code>pages</code> sub-directory
under the scripts directory. The pages are assumed to be in <a href="http://en.wikipedia.org/wiki/Markdown">MarkDown</a>.</p>
<p>Alternatively, you can specify another location via the <code>--pages</code> option.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="create-dynamically-loadable-rhai-libraries"><a class="header" href="#create-dynamically-loadable-rhai-libraries">Create Dynamically Loadable Rhai Libraries</a></h1>
<div id="admonition-linux-or-windows-only" class="admonition admonish-danger small" role="note" aria-labelledby="admonition-linux-or-windows-only-title">
<div class="admonition-title">
<div id="admonition-linux-or-windows-only-title">
<p>Linux or Windows only</p>
</div>
<a class="admonition-anchor-link" href="lib/rhai-dylib.html#admonition-linux-or-windows-only"></a>
</div>
<div>
<p><code>rhai-dylib</code> currently supports only Linux and Windows.</p>
</div>
</div>
<p><code>rhai-dylib</code> is an independent crate that demonstrates an API to register Rhai functionalities via
<em>dynamic shared libraries</em> (i.e. <code>.so</code> in Linux or <code>.dll</code> in Windows).</p>
<p>In other words, functions and <a href="lib//book/rust/modules/index.html">modules</a> can be defined in external libraries that are loaded
dynamically at <em>runtime</em>, allowing for great flexibility at the cost of depending on the unstable
Rust ABI.</p>
<p>A <a href="lib//book/rust/modules/resolvers/index.html">module resolver</a> is also included.</p>
<blockquote>
<p>On <code>crates.io</code>: <a href="https://crates.io/crates/rhai-dylib"><code>rhai-dylib</code></a></p>
<p>On <code>GitHub</code>: <a href="https://github.com/rhaiscript/rhai-dylib"><code>rhaiscript/rhai-dylib</code></a></p>
<p>API trait name: <code>rhai_dylib::Plugin</code></p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rhai-autodocs-generate-api-documentation"><a class="header" href="#rhai-autodocs-generate-api-documentation"><code>rhai-autodocs</code>: Generate API Documentation</a></h1>
<p><code>rhai-autodocs</code> helps generate API documentation, in <a href="http://en.wikipedia.org/wiki/Markdown">MarkDown</a> or <a href="https://mdxjs.com/docs/what-is-mdx/">MDX</a> format, for functions
registered inside an <a href="lib//book/engine/hello-world.html"><code>Engine</code></a> instance.</p>
<p>It is typically imported as a build dependency into the build script.</p>
<p>The <a href="http://en.wikipedia.org/wiki/Markdown">MarkDown</a>/<a href="https://mdxjs.com/docs/what-is-mdx/">MDX</a> files can then be used to create a static documentation site using generators
such as <a href="https://crates.io/crates/mdbook"><code>mdbook</code></a> or <a href="https://docusaurus.io">Docusaurus</a>.</p>
<blockquote>
<p>On <code>crates.io</code>: <a href="https://crates.io/crates/rhai-autodocs"><code>rhai-autodocs</code></a></p>
<p>On <code>GitHub</code>: <a href="https://github.com/ltabis/rhai-autodocs"><code>rhaiscript/rhai-autodocs</code></a></p>
</blockquote>
<h2 id="usage-2"><a class="header" href="#usage-2">Usage</a></h2>
<p><code>Cargo.toml</code>:</p>
<pre><code class="language-toml">[dev-dependencies]
rhai = "1.22.0"
rhai-autodocs = "0.4"           # use rhai-autodocs crate
</code></pre>
<p><code>build.rs</code>:</p>
<pre><code class="language-rust">fn main() {
    // Specify an environment variable that points to the directory
    // where the documentation will be generated.
    if let Ok(docs_path) = std::env::var("DOCS_DIR") {
        let mut engine = rhai::Engine::new();

        // register custom functions and types...
        // or load packages...

        let docs = rhai_autodocs::options()
            .include_standard_packages(false)
            .generate(&amp;engine)
            .expect("failed to generate documentation");

        // Write the documentation to a file etc.
    }
}</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="keywords-list"><a class="header" href="#keywords-list">Keywords List</a></h1>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Keyword</th><th>Description</th><th style="text-align: center">Inactive under</th><th style="text-align: center">Is function?</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>true</code></td><td>boolean true literal</td><td style="text-align: center"></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>false</code></td><td>boolean false literal</td><td style="text-align: center"></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>let</code></td><td><a href="appendix//book/language/variables.html">variable</a> declaration</td><td style="text-align: center"></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>const</code></td><td><a href="appendix//book/language/constants.html">constant</a> declaration</td><td style="text-align: center"></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>if</code></td><td><a href="appendix//book/language/if.html"><code>if</code></a> statement</td><td style="text-align: center"></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>else</code></td><td><code>else</code> block of <a href="appendix//book/language/if.html"><code>if</code></a> statement</td><td style="text-align: center"></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>switch</code></td><td><a href="appendix//book/language/switch.html">matching</a></td><td style="text-align: center"></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>do</code></td><td><a href="appendix//book/language/do.html">looping</a></td><td style="text-align: center"></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>while</code></td><td><ol><li><a href="appendix//book/language/while.html"><code>while</code></a> loop</li><li>condition for <a href="appendix//book/language/do.html"><code>do</code></a> loop</li></ol></td><td style="text-align: center"></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>until</code></td><td><a href="appendix//book/language/do.html"><code>do</code></a> loop</td><td style="text-align: center"></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>loop</code></td><td>infinite <a href="appendix//book/language/loop.html"><code>loop</code></a></td><td style="text-align: center"></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>for</code></td><td><a href="appendix//book/language/for.html"><code>for</code></a> loop</td><td style="text-align: center"></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>in</code></td><td><ol><li><a href="appendix//book/language/in.html">containment</a> test</li><li>part of <a href="appendix//book/language/for.html"><code>for</code></a> loop</li></ol></td><td style="text-align: center"></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>!in</code></td><td>negated <a href="appendix//book/language/in.html">containment</a> test</td><td style="text-align: center"></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>continue</code></td><td>continue a loop at the next iteration</td><td style="text-align: center"></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>break</code></td><td>break out of loop iteration</td><td style="text-align: center"></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>return</code></td><td><a href="appendix//book/language/return.html">return</a> value</td><td style="text-align: center"></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>throw</code></td><td>throw <a href="appendix//book/language/throw.html">exception</a></td><td style="text-align: center"></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>try</code></td><td><a href="appendix//book/language/try-catch.html">trap</a> <a href="appendix//book/language/throw.html">exception</a></td><td style="text-align: center"></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>catch</code></td><td><a href="appendix//book/language/try-catch.html">catch</a> <a href="appendix//book/language/throw.html">exception</a></td><td style="text-align: center"></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>import</code></td><td><a href="appendix//book/language/modules/import.html">import</a> <a href="appendix//book/rust/modules/index.html">module</a></td><td style="text-align: center"><a href="appendix//book/start/features.html"><code>no_module</code></a></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>export</code></td><td><a href="appendix//book/language/modules/export.html">export</a> <a href="appendix//book/language/variables.html">variable</a></td><td style="text-align: center"><a href="appendix//book/start/features.html"><code>no_module</code></a></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>as</code></td><td>alias for <a href="appendix//book/language/variables.html">variable</a> <a href="appendix//book/language/modules/export.html">export</a></td><td style="text-align: center"><a href="appendix//book/start/features.html"><code>no_module</code></a></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>global</code></td><td>automatic <a href="appendix//book/language/global.html">global</a> <a href="appendix//book/rust/modules/index.html">module</a></td><td style="text-align: center"><a href="appendix//book/start/features.html"><code>no_module</code></a>, <a href="appendix//book/start/features.html"><code>no_function</code></a></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>private</code></td><td>mark <a href="appendix//book/language/functions.html">function</a> <a href="appendix//book/language/modules/export.html">private</a></td><td style="text-align: center"><a href="appendix//book/start/features.html"><code>no_function</code></a></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>fn</code> (lower-case <code>f</code>)</td><td><a href="appendix//book/language/functions.html">function</a> definition</td><td style="text-align: center"><a href="appendix//book/start/features.html"><code>no_function</code></a></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>Fn</code> (capital <code>F</code>)</td><td>create a <a href="appendix//book/language/fn-ptr.html">function pointer</a></td><td style="text-align: center"></td><td style="text-align: center">yes</td></tr>
<tr><td style="text-align: center"><code>call</code></td><td>call a <a href="appendix//book/language/fn-ptr.html">function pointer</a></td><td style="text-align: center"></td><td style="text-align: center">yes</td></tr>
<tr><td style="text-align: center"><code>curry</code></td><td>curry a <a href="appendix//book/language/fn-ptr.html">function pointer</a></td><td style="text-align: center"></td><td style="text-align: center">yes</td></tr>
<tr><td style="text-align: center"><code>is_shared</code></td><td>is a <a href="appendix//book/language/variables.html">variable</a> shared?</td><td style="text-align: center"><a href="appendix//book/start/features.html"><code>no_function</code></a>, <a href="appendix//book/start/features.html"><code>no_closure</code></a></td><td style="text-align: center">yes</td></tr>
<tr><td style="text-align: center"><code>is_def_fn</code></td><td>is <a href="appendix//book/language/functions.html">function</a> defined?</td><td style="text-align: center"><a href="appendix//book/start/features.html"><code>no_function</code></a></td><td style="text-align: center">yes</td></tr>
<tr><td style="text-align: center"><code>is_def_var</code></td><td>is <a href="appendix//book/language/variables.html">variable</a> defined?</td><td style="text-align: center"></td><td style="text-align: center">yes</td></tr>
<tr><td style="text-align: center"><code>this</code></td><td>reference to base object for method call</td><td style="text-align: center"><a href="appendix//book/start/features.html"><code>no_function</code></a></td><td style="text-align: center"><strong>no</strong></td></tr>
<tr><td style="text-align: center"><code>type_of</code></td><td>get type name of value</td><td style="text-align: center"></td><td style="text-align: center">yes</td></tr>
<tr><td style="text-align: center"><code>print</code></td><td>print value</td><td style="text-align: center"></td><td style="text-align: center">yes</td></tr>
<tr><td style="text-align: center"><code>debug</code></td><td>print value in debug format</td><td style="text-align: center"></td><td style="text-align: center">yes</td></tr>
<tr><td style="text-align: center"><code>eval</code></td><td>evaluate script</td><td style="text-align: center"></td><td style="text-align: center">yes</td></tr>
</tbody></table>
</div>
<h2 id="reserved-keywords"><a class="header" href="#reserved-keywords">Reserved Keywords</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Keyword</th><th>Potential usage</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>var</code></td><td>variable declaration</td></tr>
<tr><td style="text-align: center"><code>static</code></td><td>variable declaration</td></tr>
<tr><td style="text-align: center"><code>shared</code></td><td>share value</td></tr>
<tr><td style="text-align: center"><code>goto</code></td><td>control flow</td></tr>
<tr><td style="text-align: center"><code>match</code></td><td>matching</td></tr>
<tr><td style="text-align: center"><code>case</code></td><td>matching</td></tr>
<tr><td style="text-align: center"><code>public</code></td><td>function/field access</td></tr>
<tr><td style="text-align: center"><code>protected</code></td><td>function/field access</td></tr>
<tr><td style="text-align: center"><code>new</code></td><td>constructor</td></tr>
<tr><td style="text-align: center"><code>use</code></td><td>import namespace</td></tr>
<tr><td style="text-align: center"><code>with</code></td><td>scope</td></tr>
<tr><td style="text-align: center"><code>is</code></td><td>type check</td></tr>
<tr><td style="text-align: center"><code>module</code></td><td>module</td></tr>
<tr><td style="text-align: center"><code>package</code></td><td>package</td></tr>
<tr><td style="text-align: center"><code>super</code></td><td>base class/module</td></tr>
<tr><td style="text-align: center"><code>thread</code></td><td>threading</td></tr>
<tr><td style="text-align: center"><code>spawn</code></td><td>threading</td></tr>
<tr><td style="text-align: center"><code>go</code></td><td>threading</td></tr>
<tr><td style="text-align: center"><code>await</code></td><td>async</td></tr>
<tr><td style="text-align: center"><code>async</code></td><td>async</td></tr>
<tr><td style="text-align: center"><code>sync</code></td><td>async</td></tr>
<tr><td style="text-align: center"><code>yield</code></td><td>async</td></tr>
<tr><td style="text-align: center"><code>default</code></td><td>special value</td></tr>
<tr><td style="text-align: center"><code>void</code></td><td>special value</td></tr>
<tr><td style="text-align: center"><code>null</code></td><td>special value</td></tr>
<tr><td style="text-align: center"><code>nil</code></td><td>special value</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="operators-and-symbols"><a class="header" href="#operators-and-symbols">Operators and Symbols</a></h1>
<h2 id="operators"><a class="header" href="#operators">Operators</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Operator</th><th>Description</th><th style="text-align: center">Binary?</th><th style="text-align: center">Binding direction</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>+</code></td><td>add</td><td style="text-align: center">yes</td><td style="text-align: center">left</td></tr>
<tr><td style="text-align: center"><code>-</code></td><td>1) subtract<br/>2) negative (prefix)</td><td style="text-align: center">yes<br/>no</td><td style="text-align: center">left<br/>right</td></tr>
<tr><td style="text-align: center"><code>*</code></td><td>multiply</td><td style="text-align: center">yes</td><td style="text-align: center">left</td></tr>
<tr><td style="text-align: center"><code>/</code></td><td>divide</td><td style="text-align: center">yes</td><td style="text-align: center">left</td></tr>
<tr><td style="text-align: center"><code>%</code></td><td>modulo</td><td style="text-align: center">yes</td><td style="text-align: center">left</td></tr>
<tr><td style="text-align: center"><code>**</code></td><td>power/exponentiation</td><td style="text-align: center">yes</td><td style="text-align: center">right</td></tr>
<tr><td style="text-align: center"><code>&gt;&gt;</code></td><td>right bit-shift</td><td style="text-align: center">yes</td><td style="text-align: center">left</td></tr>
<tr><td style="text-align: center"><code>&lt;&lt;</code></td><td>left bit-shift</td><td style="text-align: center">yes</td><td style="text-align: center">left</td></tr>
<tr><td style="text-align: center"><code>&amp;</code></td><td>1) bit-wise <em>AND</em><br/>2) boolean <em>AND</em></td><td style="text-align: center">yes</td><td style="text-align: center">left</td></tr>
<tr><td style="text-align: center"><code>|</code></td><td>1) bit-wise <em>OR</em><br/>2) boolean <em>OR</em></td><td style="text-align: center">yes</td><td style="text-align: center">left</td></tr>
<tr><td style="text-align: center"><code>^</code></td><td>1) bit-wise <em>XOR</em><br/>2) boolean <em>XOR</em></td><td style="text-align: center">yes</td><td style="text-align: center">left</td></tr>
<tr><td style="text-align: center"><code>=</code>, <code>+=</code>, <code>-=</code>, <code>*=</code>, <code>/=</code>,<br/><code>**=</code>, <code>%=</code>, <code>&lt;&lt;=</code>, <code>&gt;&gt;=</code>, <code>&amp;=</code>,<br/><code>|=</code>, <code>^=</code></td><td>assignments</td><td style="text-align: center">yes</td><td style="text-align: center">n/a</td></tr>
<tr><td style="text-align: center"><code>==</code></td><td>equals to</td><td style="text-align: center">yes</td><td style="text-align: center">left</td></tr>
<tr><td style="text-align: center"><code>!=</code></td><td>not equals to</td><td style="text-align: center">yes</td><td style="text-align: center">left</td></tr>
<tr><td style="text-align: center"><code>&gt;</code></td><td>greater than</td><td style="text-align: center">yes</td><td style="text-align: center">left</td></tr>
<tr><td style="text-align: center"><code>&gt;=</code></td><td>greater than or equals to</td><td style="text-align: center">yes</td><td style="text-align: center">left</td></tr>
<tr><td style="text-align: center"><code>&lt;</code></td><td>less than</td><td style="text-align: center">yes</td><td style="text-align: center">left</td></tr>
<tr><td style="text-align: center"><code>&lt;=</code></td><td>less than or equals to</td><td style="text-align: center">yes</td><td style="text-align: center">left</td></tr>
<tr><td style="text-align: center"><code>&amp;&amp;</code></td><td>boolean <em>AND</em> (short-circuits)</td><td style="text-align: center">yes</td><td style="text-align: center">left</td></tr>
<tr><td style="text-align: center"><code>||</code></td><td>boolean <em>OR</em> (short-circuits)</td><td style="text-align: center">yes</td><td style="text-align: center">left</td></tr>
<tr><td style="text-align: center"><code>??</code></td><td>null-coalesce (short-circuits)</td><td style="text-align: center">yes</td><td style="text-align: center">left</td></tr>
<tr><td style="text-align: center"><code>!</code></td><td>boolean <em>NOT</em></td><td style="text-align: center"><strong>no</strong></td><td style="text-align: center">right</td></tr>
<tr><td style="text-align: center"><code>[</code> … <code>]</code>, <code>?[</code> … <code>]</code></td><td>indexing</td><td style="text-align: center">yes</td><td style="text-align: center">left</td></tr>
<tr><td style="text-align: center"><code>.</code>, <code>?.</code></td><td>1) property access<br/>2) method call</td><td style="text-align: center">yes</td><td style="text-align: center">left</td></tr>
<tr><td style="text-align: center"><code>..</code></td><td>exclusive range</td><td style="text-align: center">yes</td><td style="text-align: center">left</td></tr>
<tr><td style="text-align: center"><code>..=</code></td><td>inclusive range</td><td style="text-align: center">yes</td><td style="text-align: center">left</td></tr>
</tbody></table>
</div>
<h2 id="symbols-and-patterns"><a class="header" href="#symbols-and-patterns">Symbols and Patterns</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Symbol</th><th>Name</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>_</code></td><td>underscore</td><td>default <code>switch</code> case</td></tr>
<tr><td style="text-align: center"><code>;</code></td><td>semicolon</td><td>statement separator</td></tr>
<tr><td style="text-align: center"><code>,</code></td><td>comma</td><td>list separator</td></tr>
<tr><td style="text-align: center"><code>:</code></td><td>colon</td><td><a href="appendix//book/language/object-maps.html">object map</a> property value separator</td></tr>
<tr><td style="text-align: center"><code>::</code></td><td>path</td><td>module path separator</td></tr>
<tr><td style="text-align: center"><code>#{</code> … <code>}</code></td><td>hash map</td><td><a href="appendix//book/language/object-maps.html">object map</a> literal</td></tr>
<tr><td style="text-align: center"><code>"</code> … <code>"</code></td><td>double quote</td><td><a href="appendix//book/language/strings-chars.html">string</a></td></tr>
<tr><td style="text-align: center"><code>`</code> … <code>`</code></td><td>back-tick</td><td>multi-line literal <a href="appendix//book/language/strings-chars.html">string</a></td></tr>
<tr><td style="text-align: center"><code>'</code> … <code>'</code></td><td>single quote</td><td><a href="appendix//book/language/strings-chars.html">character</a></td></tr>
<tr><td style="text-align: center"><code>\</code></td><td>1) escape<br/>2) line continuation</td><td>escape character literal</td></tr>
<tr><td style="text-align: center"><code>()</code></td><td>unit</td><td>null value</td></tr>
<tr><td style="text-align: center"><code>(</code> … <code>)</code></td><td>parentheses</td><td>expression grouping</td></tr>
<tr><td style="text-align: center"><code>{</code> … <code>}</code></td><td>braces</td><td>block statement</td></tr>
<tr><td style="text-align: center"><code>|</code> … <code>|</code></td><td>pipes</td><td>closure</td></tr>
<tr><td style="text-align: center"><code>[</code> … <code>]</code></td><td>brackets</td><td><a href="appendix//book/language/arrays.html">array</a> literal</td></tr>
<tr><td style="text-align: center"><code>!</code></td><td>bang</td><td>function call in calling scope</td></tr>
<tr><td style="text-align: center"><code>=&gt;</code></td><td>double arrow</td><td><code>switch</code> expression case separator</td></tr>
<tr><td style="text-align: center"><code>//</code></td><td>comment</td><td>line comment</td></tr>
<tr><td style="text-align: center"><code>///</code></td><td>doc-comment</td><td>line [doc-comment]</td></tr>
<tr><td style="text-align: center"><code>//!</code></td><td>module doc</td><td><a href="appendix//book/language/comments.html">module documentation</a></td></tr>
<tr><td style="text-align: center"><code>/*</code> … <code>*/</code></td><td>comment</td><td>block comment</td></tr>
<tr><td style="text-align: center"><code>/**</code> … <code>*/</code></td><td>doc-comment</td><td>block [doc-comment]</td></tr>
<tr><td style="text-align: center"><code>(*</code> … <code>*)</code></td><td>comment</td><td><em>reserved</em></td></tr>
<tr><td style="text-align: center"><code>#!</code></td><td>shebang</td><td><em>reserved</em></td></tr>
<tr><td style="text-align: center"><code>++</code></td><td>increment</td><td><em>reserved</em></td></tr>
<tr><td style="text-align: center"><code>--</code></td><td>decrement</td><td><em>reserved</em></td></tr>
<tr><td style="text-align: center"><code>...</code></td><td>rest</td><td><em>reserved</em></td></tr>
<tr><td style="text-align: center"><code>~</code></td><td>tilde</td><td><em>reserved</em></td></tr>
<tr><td style="text-align: center"><code>!.</code></td><td></td><td><em>reserved</em></td></tr>
<tr><td style="text-align: center"><code>?</code></td><td>question</td><td><em>reserved</em></td></tr>
<tr><td style="text-align: center"><code>#</code></td><td>hash</td><td><em>reserved</em></td></tr>
<tr><td style="text-align: center"><code>@</code></td><td>at</td><td><em>reserved</em></td></tr>
<tr><td style="text-align: center"><code>$</code></td><td>dollar</td><td><em>reserved</em></td></tr>
<tr><td style="text-align: center"><code>-&gt;</code></td><td>arrow</td><td><em>reserved</em></td></tr>
<tr><td style="text-align: center"><code>&lt;-</code></td><td>left arrow</td><td><em>reserved</em></td></tr>
<tr><td style="text-align: center"><code>&lt;|</code></td><td>left triangle</td><td><em>reserved</em></td></tr>
<tr><td style="text-align: center"><code>|&gt;</code></td><td>right triangle</td><td><em>reserved</em></td></tr>
<tr><td style="text-align: center"><code>===</code></td><td>strict equals to</td><td><em>reserved</em></td></tr>
<tr><td style="text-align: center"><code>!==</code></td><td>strict not equals to</td><td><em>reserved</em></td></tr>
<tr><td style="text-align: center"><code>:=</code></td><td>assignment</td><td><em>reserved</em></td></tr>
<tr><td style="text-align: center"><code>:;</code></td><td>typo to <code>::</code></td><td><em>reserved</em></td></tr>
<tr><td style="text-align: center"><code>::&lt;</code> … <code>&gt;</code></td><td>turbofish</td><td><em>reserved</em></td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="literals-syntax"><a class="header" href="#literals-syntax">Literals Syntax</a></h1>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Type</th><th>Literal syntax</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>INT</code></td><td>decimal: <code>42</code>, <code>-123</code>, <code>0</code><br/>hex: <code>0x????..</code><br/>binary: <code>0b????..</code><br/>octal: <code>0o????..</code></td></tr>
<tr><td style="text-align: center"><code>FLOAT</code>,<br/><a href="https://crates.io/crates/rust_decimal"><code>Decimal</code></a> (requires <a href="appendix//book/start/features.html"><code>no_float</code></a>+<a href="appendix//book/start/features.html"><code>decimal</code></a>)</td><td><code>42.0</code>, <code>-123.456</code>, <code>123.</code>, <code>123.456e-10</code></td></tr>
<tr><td style="text-align: center"><a href="appendix//book/language/ranges.html">Ranges</a> in <a href="appendix//book/language/switch.html"><code>switch</code></a> cases</td><td><code>-10..10</code> (exclusive), <code>0..=50</code> (inclusive)</td></tr>
<tr><td style="text-align: center">Normal <a href="appendix//book/language/strings-chars.html">string</a></td><td><code>"... \x?? \u???? \U???????? ..."</code></td></tr>
<tr><td style="text-align: center"><a href="appendix//book/language/strings-chars.html">String</a> with continuation</td><td><code>"this is the first line\</code><br/><code>second line\</code><br/><code>the third line"</code></td></tr>
<tr><td style="text-align: center">Multi-line literal <a href="appendix//book/language/strings-chars.html">string</a></td><td><code> `this is the first line</code><br/><code>second line</code></br><code>the last line` </code></td></tr>
<tr><td style="text-align: center">Multi-line literal <a href="appendix//book/language/strings-chars.html">string</a> with interpolation</td><td><code> `this is the first field: ${obj.field1}</code><br/><code>second field: {obj.field2}</code></br><code>the last field: ${obj.field3}` </code></td></tr>
<tr><td style="text-align: center"><a href="appendix//book/language/strings-chars.html">Character</a></td><td>single: <code>'?'</code><br/>ASCII hex: <code>'\x??'</code><br/>Unicode: <code>'\u????'</code>, <code>'\U????????'</code></td></tr>
<tr><td style="text-align: center"><a href="appendix//book/language/arrays.html"><code>Array</code></a></td><td><code>[ ???, ???, ??? ]</code></td></tr>
<tr><td style="text-align: center"><a href="appendix//book/language/object-maps.html">Object map</a></td><td><code>#{ a: ???, b: ???, c: ???, "def": ??? }</code></td></tr>
<tr><td style="text-align: center">Boolean true</td><td><code>true</code></td></tr>
<tr><td style="text-align: center">Boolean false</td><td><code>false</code></td></tr>
<tr><td style="text-align: center"><code>Nothing</code>/<code>null</code>/<code>nil</code>/<code>void</code>/Unit</td><td><code>()</code></td></tr>
</tbody></table>
</div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
