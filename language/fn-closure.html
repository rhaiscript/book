<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Closures - Rhai - Embedded Scripting for Rust</title>


        <!-- Custom HTML head -->
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-12WKJTDTEE"></script>
        <script>
            var localAddrs = ["localhost", "127.0.0.1", ""];
        
            // Make sure we don't activate Google Analytics if the developer is inspecting the book locally...
            if (localAddrs.indexOf(document.location.hostname) === -1) {
                window.dataLayer = window.dataLayer || [];
                function gtag() { dataLayer.push(arguments); }
                gtag('js', new Date());
        
                gtag('config', 'G-12WKJTDTEE');
            }
        </script>
        <meta name="description" content="Tutorial and reference on the Rhai scripting engine and language.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/rhai.min.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <div class="sidebar-scrollbox"></div>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <script async src="../toc.js"></script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rhai - Embedded Scripting for Rust</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rhaiscript/rhai" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/rhaiscript/book/edit/master/src/language/fn-closure.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="closures"><a class="header" href="#closures">Closures</a></h1>
<div id="admonition-tip-is_shared" class="admonition admonish-tip side" role="note" aria-labelledby="admonition-tip-is_shared-title">
<div class="admonition-title">
<div id="admonition-tip-is_shared-title">
<p>Tip: <code>is_shared</code></p>
</div>
<a class="admonition-anchor-link" href="#admonition-tip-is_shared"></a>
</div>
<div>
<p>Use <code>Dynamic::is_shared</code> to check whether a particular <a href="/book/language/dynamic.html"><code>Dynamic</code></a> value is shared.</p>
</div>
</div>
<p>Although <a href="/book/language/fn-anon.html">anonymous functions</a> de-sugar to standard function definitions, they differ from standard
functions because they can <em>captures</em> <a href="/book/language/variables.html">variables</a> that are not defined within the current scope,
but are instead defined in an external scope â€“ i.e. where the <a href="/book/language/fn-anon.html">anonymous function</a> is created.</p>
<p>All <a href="/book/language/variables.html">variables</a> that are accessible during the time the <a href="/book/language/fn-anon.html">anonymous function</a> is created are
automatically captured when they are used, as long as they are not shadowed by local <a href="/book/language/variables.html">variables</a>
defined within the functionâ€™s.</p>
<p>The captured <a href="/book/language/variables.html">variables</a> are automatically converted into <strong>reference-counted shared values</strong>
(<code>Rc&lt;RefCell&lt;Dynamic&gt;&gt;</code>, or <code>Arc&lt;RwLock&lt;Dynamic&gt;&gt;</code> under <a href="/book/start/features.html"><code>sync</code></a>).</p>
<p>Therefore, similar to closures in many languages, these captured shared values persist through
reference counting, and may be read or modified even after the <a href="/book/language/variables.html">variables</a> that hold them go out of
scope and no longer exist.</p>
<div id="admonition-tip-disable-closures" class="admonition admonish-tip small" role="note" aria-labelledby="admonition-tip-disable-closures-title">
<div class="admonition-title">
<div id="admonition-tip-disable-closures-title">
<p>Tip: Disable closures</p>
</div>
<a class="admonition-anchor-link" href="#admonition-tip-disable-closures"></a>
</div>
<div>
<p>Capturing external <a href="/book/language/variables.html">variables</a> can be turned off via the <a href="/book/start/features.html"><code>no_closure</code></a> feature.</p>
</div>
</div>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<pre><code class="language-rust">let x = 1;                          // a normal variable

x.is_shared() == false;

let f = |y| x + y;                  // variable 'x' is auto-curried (captured) into 'f'

x.is_shared() == true;              // 'x' is now a shared value!

f.call(2) == 3;                     // 1 + 2 == 3

x = 40;                             // changing 'x'...

f.call(2) == 42;                    // the value of 'x' is 40 because 'x' is shared

// The above de-sugars into something like this:

fn anon_0001(x, y) { x + y }        // parameter 'x' is inserted

make_shared(x);                     // convert variable 'x' into a shared value

let f = anon_0001.curry(x);         // shared 'x' is curried</code></pre>
<div id="admonition-beware-captured-variables-are-truly-shared" class="admonition admonish-bug" role="note" aria-labelledby="admonition-beware-captured-variables-are-truly-shared-title">
<div class="admonition-title">
<div id="admonition-beware-captured-variables-are-truly-shared-title">
<p>Beware: Captured Variables are Truly Shared</p>
</div>
<a class="admonition-anchor-link" href="#admonition-beware-captured-variables-are-truly-shared"></a>
</div>
<div>
<p>The example below is a typical tutorial sample for many languages to illustrate the traps
that may accompany capturing external <a href="/book/language/variables.html">variables</a> in closures.</p>
<p>It prints <code>9</code>, <code>9</code>, <code>9</code>, â€¦ <code>9</code>, <code>9</code>, not <code>0</code>, <code>1</code>, <code>2</code>, â€¦ <code>8</code>, <code>9</code>, because there is
ever only <em>one</em> captured <a href="/book/language/variables.html">variable</a>, and all ten closures capture the <em>same</em> <a href="/book/language/variables.html">variable</a>.</p>
<pre><code class="language-rust">let list = [];

for i in 0..10 {
    list.push(|| print(i));         // the for loop variable 'i' is captured
}

list.len() == 10;                   // 10 closures stored in the array

list[0].type_of() == "Fn";          // make sure these are closures

for f in list {
    f.call();                       // all references to 'i' are the same variable!
}</code></pre>
</div>
</div>
<div id="admonition-be-careful-to-prevent-data-races" class="admonition admonish-danger" role="note" aria-labelledby="admonition-be-careful-to-prevent-data-races-title">
<div class="admonition-title">
<div id="admonition-be-careful-to-prevent-data-races-title">
<p>Be Careful to Prevent Data Races</p>
</div>
<a class="admonition-anchor-link" href="#admonition-be-careful-to-prevent-data-races"></a>
</div>
<div>
<p>Rust does not have data races, but that doesnâ€™t mean Rhai doesnâ€™t.</p>
<p>Avoid performing a method call on a captured shared <a href="/book/language/variables.html">variable</a> (which essentially takes a
mutable reference to the shared object) while using that same <a href="/book/language/variables.html">variable</a> as a parameter
in the method call â€“ this is a sure-fire way to generate a data race error.</p>
<p>If a shared value is used as the <code>this</code> pointer in a method call to a closure function,
then the same shared value <em>must not</em> be captured inside that function, or a data race
will occur and the script will terminate with an error.</p>
<pre><code class="language-rust">let x = 20;

x.is_shared() == false;             // 'x' is not shared, so no data race is possible

let f = |a| this += x + a;          // 'x' is captured in this closure

x.is_shared() == true;              // now 'x' is shared

x.call(f, 2);                       // &lt;- error: data race detected on 'x'</code></pre>
</div>
</div>
<div id="admonition-data-races-in-sync-builds-can-become-deadlocks" class="admonition admonish-danger" role="note" aria-labelledby="admonition-data-races-in-sync-builds-can-become-deadlocks-title">
<div class="admonition-title">
<div id="admonition-data-races-in-sync-builds-can-become-deadlocks-title">
<p>Data Races in <code>sync</code> Builds Can Become Deadlocks</p>
</div>
<a class="admonition-anchor-link" href="#admonition-data-races-in-sync-builds-can-become-deadlocks"></a>
</div>
<div>
<p>Under the <a href="/book/start/features.html"><code>sync</code></a> feature, shared values are guarded with a <code>RwLock</code>, meaning that data race
conditions no longer raise an error.</p>
<p>Instead, they wait endlessly for the <code>RwLock</code> to be freed, and thus can become deadlocks.</p>
<p>On the other hand, since the same thread (i.e. the <a href="/book/engine/hello-world.html"><code>Engine</code></a> thread) that is holding the lock
is attempting to read it again, this may also <a href="https://doc.rust-lang.org/std/sync/struct.RwLock.html#panics-1">panic</a>
depending on the O/S.</p>
<pre><code class="language-rust">let x = 20;

let f = |a| this += x + a;          // 'x' is captured in this closure

// Under `sync`, the following may wait forever, or may panic,
// because 'x' is locked as the `this` pointer but also accessed
// via a captured shared value.
x.call(f, 2);</code></pre>
</div>
</div>
<h2 id="tldr"><a class="header" href="#tldr">TL;DR</a></h2>
<div id="admonition-how-is-it-actually-implemented" class="admonition admonish-question" role="note" aria-labelledby="admonition-how-is-it-actually-implemented-title">
<div class="admonition-title">
<div id="admonition-how-is-it-actually-implemented-title">
<p>How is it actually implemented?</p>
</div>
<a class="admonition-anchor-link" href="#admonition-how-is-it-actually-implemented"></a>
</div>
<div>
<p>The actual implementation of closures de-sugars to:</p>
<ol>
<li>
<p>Keeping track of what <a href="/book/language/variables.html">variables</a> are accessed inside the <a href="/book/language/fn-anon.html">anonymous function</a>,</p>
</li>
<li>
<p>If a <a href="/book/language/variables.html">variable</a> is not defined within the <a href="/book/language/fn-anon.html">anonymous functionâ€™s</a> scope,
it is looked up <em>outside</em> the <a href="/book/language/functions.html">function</a> and in the current execution scope â€“
where the <a href="/book/language/fn-anon.html">anonymous function</a> is created.</p>
</li>
<li>
<p>The <a href="/book/language/variables.html">variable</a> is added to the parameters list of the <a href="/book/language/fn-anon.html">anonymous function</a>, at the front.</p>
</li>
<li>
<p>The <a href="/book/language/variables.html">variable</a> is then converted into a <strong>reference-counted shared value</strong>.</p>
<p>An <a href="/book/language/fn-anon.html">anonymous function</a> which captures an external <a href="/book/language/variables.html">variable</a> is the only way to create a
reference-counted shared value in Rhai.</p>
</li>
<li>
<p>The shared value is then <a href="/book/language/fn-curry.html">curried</a> into the <a href="/book/language/fn-ptr.html">function pointer</a> itself,
essentially carrying a reference to that shared value and inserting it into future calls of the <a href="/book/language/functions.html">function</a>.</p>
<p>This process is called <em>Automatic Currying</em>, and is the mechanism through which Rhai simulates closures.</p>
</li>
</ol>
</div>
</div>
<div id="admonition-why-automatic-currying" class="admonition admonish-question" role="note" aria-labelledby="admonition-why-automatic-currying-title">
<div class="admonition-title">
<div id="admonition-why-automatic-currying-title">
<p>Why automatic currying?</p>
</div>
<a class="admonition-anchor-link" href="#admonition-why-automatic-currying"></a>
</div>
<div>
<p>In concept, a closure <em>closes</em> over captured variables from the outer scope â€“ thatâ€™s why
they are called <em>closures</em>.  When this happen, a typical language implementation hoists
those variables that are captured away from the stack frame and into heap-allocated storage.
This is because those variables may be needed after the stack frame goes away.</p>
<p>These heap-allocated captured variables only go away when all the closures that need them
are finished with them.  A garbage collector makes this trivial to implement â€“ they are
automatically collected as soon as all closures needing them are destroyed.</p>
<p>In Rust, this can be done by reference counting instead, with the potential pitfall of creating
reference loops that will prevent those variables from being deallocated forever.
Rhai avoids this by clone-copying most data values, so reference loops are hard to create.</p>
<p>Rhai does the hoisting of captured variables into the heap by converting those values
into reference-counted locked values, also allocated on the heap.  The process is identical.</p>
<p>Closures are usually implemented as a data structure containing two items:</p>
<ol>
<li>A function pointer to the function body of the closure,</li>
<li>A data structure containing references to the captured shared variables on the heap.</li>
</ol>
<p>Usually a language implementation passes the structure containing references to captured
shared variables into the function pointer, the function body taking this data structure
as an additional parameter.</p>
<p>This is essentially what Rhai does, except that Rhai passes each variable individually
as separate parameters to the function, instead of creating a structure and passing that
structure as a single parameter.  This is the only difference.</p>
<p>Therefore, in most languages, essentially all closures are implemented as automatic currying of
shared variables hoisted into the heap, automatically passing those variables as parameters into
the function. Rhai just brings this directly up to the front.</p>
</div>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../language/fn-anon.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../engine/metadata/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../language/fn-anon.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../engine/metadata/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
